{"meta":{"version":1,"warehouse":"4.0.0"},"models":{"Asset":[{"_id":"themes/hexo-theme-aomori/source/dist/build.css","path":"dist/build.css","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/dist/build.js","path":"dist/build.js","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/dist/custom.css","path":"dist/custom.css","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/dist/custom.js","path":"dist/custom.js","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/javascripts/app.js","path":"javascripts/app.js","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/javascripts/class-module.js","path":"javascripts/class-module.js","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/javascripts/custom.js","path":"javascripts/custom.js","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/javascripts/disqusjs.js","path":"javascripts/disqusjs.js","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/javascripts/gitalk.js","path":"javascripts/gitalk.js","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/javascripts/valine.js","path":"javascripts/valine.js","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/modules/algoliasearch-lite.umd.js","path":"modules/algoliasearch-lite.umd.js","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/modules/highlight.min.js","path":"modules/highlight.min.js","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/modules/lazyload.min.js","path":"modules/lazyload.min.js","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/modules/md5.min.js","path":"modules/md5.min.js","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/modules/nprogress.js","path":"modules/nprogress.js","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/modules/perfect-scrollbar.min.js","path":"modules/perfect-scrollbar.min.js","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/modules/plyr.js","path":"modules/plyr.js","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/modules/swiper-bundle.min.js","path":"modules/swiper-bundle.min.js","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/modules/tocbot.min.js","path":"modules/tocbot.min.js","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/modules/typed.min.js","path":"modules/typed.min.js","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/stylesheets/base.scss","path":"stylesheets/base.scss","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/stylesheets/github.css","path":"stylesheets/github.css","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/stylesheets/media-fixed.scss","path":"stylesheets/media-fixed.scss","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/stylesheets/normalize.css","path":"stylesheets/normalize.css","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/stylesheets/nprogress.css","path":"stylesheets/nprogress.css","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/stylesheets/page.scss","path":"stylesheets/page.scss","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/stylesheets/perfect-scrollbar.css","path":"stylesheets/perfect-scrollbar.css","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/stylesheets/plyr.css","path":"stylesheets/plyr.css","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/stylesheets/post.css","path":"stylesheets/post.css","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/stylesheets/remark42.css","path":"stylesheets/remark42.css","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/stylesheets/spectre-exp.min.css","path":"stylesheets/spectre-exp.min.css","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/stylesheets/spectre-icons.min.css","path":"stylesheets/spectre-icons.min.css","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/stylesheets/spectre.min.css","path":"stylesheets/spectre.min.css","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/stylesheets/style.scss","path":"stylesheets/style.scss","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/stylesheets/swiper-bundle.min.css","path":"stylesheets/swiper-bundle.min.css","modified":0,"renderable":1},{"_id":"themes/hexo-theme-aomori/source/stylesheets/tocbot.css","path":"stylesheets/tocbot.css","modified":0,"renderable":1},{"_id":"source/images/git-logo.svg","path":"images/git-logo.svg","modified":0,"renderable":0},{"_id":"source/images/self-photo.jpeg","path":"images/self-photo.jpeg","modified":0,"renderable":0},{"_id":"source/temp/GANs/1609914460948-9656b2ad-bae1-4804-8cca-cd6e26bbdf49.png","path":"temp/GANs/1609914460948-9656b2ad-bae1-4804-8cca-cd6e26bbdf49.png","modified":0,"renderable":0},{"_id":"source/temp/GANs/1609914799643-975cc081-1fb5-4085-9a17-fae9d0e9b590.png","path":"temp/GANs/1609914799643-975cc081-1fb5-4085-9a17-fae9d0e9b590.png","modified":0,"renderable":0},{"_id":"source/temp/GANs/1609914908755-33c89db7-e274-44d8-bf78-d58802988970.png","path":"temp/GANs/1609914908755-33c89db7-e274-44d8-bf78-d58802988970.png","modified":0,"renderable":0},{"_id":"source/temp/GANs/1609983349967-7087eb25-37b6-4bd8-90eb-09dc4953bba8.png","path":"temp/GANs/1609983349967-7087eb25-37b6-4bd8-90eb-09dc4953bba8.png","modified":0,"renderable":0},{"_id":"source/temp/GANs/1609987534946-5568cebc-0d23-4bc7-a175-73a5872b732e.png","path":"temp/GANs/1609987534946-5568cebc-0d23-4bc7-a175-73a5872b732e.png","modified":0,"renderable":0},{"_id":"source/temp/GANs/1610005130361-d3374c7e-7456-4bba-b3a7-b7eb49fb6974-20210128162008057.png","path":"temp/GANs/1610005130361-d3374c7e-7456-4bba-b3a7-b7eb49fb6974-20210128162008057.png","modified":0,"renderable":0},{"_id":"source/temp/GANs/1610005130361-d3374c7e-7456-4bba-b3a7-b7eb49fb6974-20210128162026163.png","path":"temp/GANs/1610005130361-d3374c7e-7456-4bba-b3a7-b7eb49fb6974-20210128162026163.png","modified":0,"renderable":0},{"_id":"source/temp/GANs/1610005130361-d3374c7e-7456-4bba-b3a7-b7eb49fb6974.png","path":"temp/GANs/1610005130361-d3374c7e-7456-4bba-b3a7-b7eb49fb6974.png","modified":0,"renderable":0},{"_id":"source/images/favicon.png","path":"images/favicon.png","modified":1,"renderable":0}],"Cache":[{"_id":"source/.DS_Store","hash":"495dc0d217dbc3e7cb0c015a4aa9af3e7011d37f","modified":1650886976743},{"_id":"source/_data/photography.json","hash":"1d4a550a2490f213c37b1822de0bf8880125f351","modified":1650886976743},{"_id":"source/blog-photo/index.md","hash":"39077bb66be90ed54d3e0eb90bac62cdd0ce9ea3","modified":1611756811313},{"_id":"source/blog-photo/index.html","hash":"613398995c7f0dc0bf79f9b26122e7415b651239","modified":1611759087631},{"_id":"source/blog-photo/ins.css","hash":"c059b2746169bca00a989b5238396e9e6c3fe5ce","modified":1611757704000},{"_id":"source/images/git-logo.svg","hash":"c97a11a578e7a7b979d4a37389459553f671e04b","modified":1650886976743},{"_id":"source/images/icons8.png","hash":"b6579869cfe6d6abb4b6f0cad793580c22c9c13c","modified":1650887419076},{"_id":"source/blog-photo/ins.js","hash":"bb7f9e7a7bbd35add555c332f36e333de99abc51","modified":1611759133771},{"_id":"source/blog-photo/lazyload.min.js","hash":"9c699878cd19d64c7611fb7ccbe342532569c863","modified":1611757704000},{"_id":"source/blog-photo/videos.html","hash":"ae959664ca951a26674a90c100b62ef6fbe58141","modified":1611757704000},{"_id":"source/_posts/.DS_Store","hash":"e32260d52b0b6b34a485ecb84f8d830184d5301a","modified":1616079336149},{"_id":"source/_posts/Nacos如何调用其他微服务(中）.md","hash":"60ea76700b3817c3f58b1c98f0d91cbae978158e","modified":1616078812259},{"_id":"source/_posts/Nacos：如果注册服务（上）.md","hash":"d45a96bf67949b7e3bcebe42377fa8c1586fb977","modified":1615712187792},{"_id":"source/_posts/Kaptcha验证码.md","hash":"cf3b2afb3ec6961ce4d4db2771c5fa87bc71be16","modified":1615712025688},{"_id":"source/_posts/Java中ThreadLocal是如何保证线程安全的.md","hash":"7fcc42711053fb12ebff02cd491c4c69b4e6b11a","modified":1616404007029},{"_id":"source/_posts/Redis使用.md","hash":"90e3750668b3379fcc643ddfd51c33c3785a5b0d","modified":1614224278480},{"_id":"source/_posts/docker配置MYSQL集群(上).md","hash":"62a23051c6bed5c0c6dcbd92b9d7e88ba947ec6b","modified":1611986338785},{"_id":"source/_posts/docker配置Mysql集群(下)——Spring代码层读写分离.md","hash":"38a8a2ae2005c06f10144afd7fee8b0d60c58ab8","modified":1614045395398},{"_id":"source/_posts/zxing二维码的生成.md","hash":"24008a5f5c9f8ad6655c9e1980a1f3756f51f61d","modified":1614045035689},{"_id":"source/photography/index.md","hash":"176d2ee39ed1b83ce977a66c66e9814d79471756","modified":1650886976744},{"_id":"source/_posts/奥斯曼帝国的衰落原由.md","hash":"c71c040a1119b3dcc50fb77ceb0d8a51c3ed0159","modified":1616926449342},{"_id":"source/_posts/复杂mapper映射出现Expected one result (or null) to be returned by selectOne(), but found_ 6.md","hash":"28d8e9a1ece482360fe0690bf1216e64d6158604","modified":1612156721032},{"_id":"source/_posts/微服务基础概念.md","hash":"279ae3ceb21560b3aee9c4bd70e80aa1ace1ec42","modified":1616924926265},{"_id":"source/temp/.DS_Store","hash":"475f664f90449fcb1f178dc812ace2a180c183f7","modified":1611928718090},{"_id":"source/随笔/index.md","hash":"b140b2286c2cf4c9b553bd93ed5f25e0f96f15e0","modified":1611755402858},{"_id":"source/temp/GANs.md","hash":"2c723102617c9203d0aa7a5c53c92a8ebfc2ff42","modified":1611822839082},{"_id":"source/随笔/奥斯曼帝国的衰落原由.md","hash":"90a10a5e6b407bf33522f621c2f5b5d11d4e9d3f","modified":1611754924203},{"_id":"source/_posts/Nacos如何调用其他微服务(中）/1615645734755-1b3246df-3e91-474b-b901-bd58ac654797-20210318224006023.jpeg","hash":"20fc0111ac2b03de5917aefdcb8d275c66f1a3b5","modified":1616078406023},{"_id":"source/_posts/Java中ThreadLocal是如何保证线程安全的/threadlocal.png","hash":"b83098ee4a5c9ebae21fff409ba52b4adf638bec","modified":1611731151217},{"_id":"source/_posts/docker配置MYSQL集群(上)/截屏2021-01-20 12.07.01.png","hash":"4e5b54d4442c7aea92c5778ad46bbae7f42c8198","modified":1611719913728},{"_id":"source/_posts/docker配置MYSQL集群(上)/截屏2021-01-20 23.26.12.png","hash":"140f61d14e7fde53fca5c74a2b44e93672cd6616","modified":1611719927390},{"_id":"source/_posts/docker配置MYSQL集群(上)/截屏2021-01-20 23.33.11.png","hash":"c7e4967ef5809313977a6766cd71dfd988e04cba","modified":1611719933328},{"_id":"source/_posts/docker配置MYSQL集群(上)/截屏2021-01-20 23.58.28.png","hash":"a107728209ba0436a77ef997b4ae8d11a8b2781a","modified":1611719950791},{"_id":"source/temp/GANs/1609914799643-975cc081-1fb5-4085-9a17-fae9d0e9b590.png","hash":"718960676bcaa29ea758e639160044aa55a59550","modified":1611821800562},{"_id":"source/temp/GANs/1609914908755-33c89db7-e274-44d8-bf78-d58802988970.png","hash":"8ac0e57466d110af638a462b8bda2f4d061156f4","modified":1611821809947},{"_id":"source/temp/GANs/1609983349967-7087eb25-37b6-4bd8-90eb-09dc4953bba8.png","hash":"4c50ad6109346feb49e431bf511d9bf4543bcb7e","modified":1611821816432},{"_id":"source/images/self-photo.jpeg","hash":"30c9784e59598f3051aba275b24aa081b0a1186e","modified":1650886976744},{"_id":"source/_posts/Kaptcha验证码/image-20210129220709957.png","hash":"f38299c96d81cd108479163e5e385afd400b9df4","modified":1611929229958},{"_id":"source/_posts/Nacos：如果注册服务（上）/1615627330848-e62fcb72-d405-48f1-8e27-0053b1fcf750.png","hash":"1832958fe947103bc3c0193bb479ef7c4d742344","modified":1615711618929},{"_id":"source/_posts/docker配置MYSQL集群(上)/master配置信息.png","hash":"61cbf53955f6816a8aebb386aade6617bc1159e9","modified":1611719907740},{"_id":"source/_posts/docker配置MYSQL集群(上)/image.png","hash":"b730b4f05cc7faa0e2e876e75ff4929f4eba1bb4","modified":1611719955377},{"_id":"source/_posts/docker配置MYSQL集群(上)/镜像.png","hash":"5277a7e4d544015bc05bae339dee5472181ec522","modified":1611719896231},{"_id":"source/_posts/复杂mapper映射出现Expected one result (or null) to be returned by selectOne(), but found_ 6/1612109243469-4d89a31b-0d9d-487e-bfed-faf3497e774e.png","hash":"fa7bede0c075f2da133687a710d8fff7c012db6f","modified":1612152477141},{"_id":"source/_posts/复杂mapper映射出现Expected one result (or null) to be returned by selectOne(), but found_ 6/1612149739610-d371499a-4d5a-4ba7-9b0d-8f9b8bc133ec-20210201120526814.png","hash":"b5815ca1c115f77b9747a672b3904c0bd6e3cc4b","modified":1612152326815},{"_id":"source/_posts/复杂mapper映射出现Expected one result (or null) to be returned by selectOne(), but found_ 6/1612149739610-d371499a-4d5a-4ba7-9b0d-8f9b8bc133ec.png","hash":"b5815ca1c115f77b9747a672b3904c0bd6e3cc4b","modified":1612152307481},{"_id":"themes/hexo-theme-aomori/.babelrc","hash":"98714b5432f56c788e08a5194f2f33148da6ca63","modified":1650886976744},{"_id":"themes/hexo-theme-aomori/.eslintignore","hash":"0d8193103ddb9947903ebb5204cf1e188902f1f8","modified":1650886976745},{"_id":"themes/hexo-theme-aomori/.eslintrc.js","hash":"7d4dd8cabb411820feb1bfebb14992255fe2b714","modified":1650886976745},{"_id":"themes/hexo-theme-aomori/.gitignore","hash":"1efa2e188157e5d9115c92c791fd4610200406bb","modified":1650886976746},{"_id":"themes/hexo-theme-aomori/.prettierrc","hash":"8f8d09c16c9623c6e0a5d8f22b64292ee98a5a4c","modified":1650886976746},{"_id":"themes/hexo-theme-aomori/CHANGELOG.md","hash":"cf258de89a3a4e39d7f317814d862e4041234fc6","modified":1650886976747},{"_id":"themes/hexo-theme-aomori/LICENSE","hash":"df86e662005fc659cb72166664f8360223c10864","modified":1650886976747},{"_id":"themes/hexo-theme-aomori/README.md","hash":"9284588f3d73b808fef81ae9eb1544658ee036e0","modified":1650886976748},{"_id":"themes/hexo-theme-aomori/_config.yml","hash":"07eb0fd6afb10494c4816e453d74e6e29b64e9d1","modified":1650886976748},{"_id":"themes/hexo-theme-aomori/gulpfile.js","hash":"1af68888505563e7f2ce9f55b3d8fac8f5851a40","modified":1650886976750},{"_id":"themes/hexo-theme-aomori/package.json","hash":"836567428b364adc034562031872ff94f7f10222","modified":1650886976764},{"_id":"themes/hexo-theme-aomori/stylelint.config.js","hash":"35805e8a64447c3e9fec8cb7ca619783b4ffa4af","modified":1650886976784},{"_id":"themes/hexo-theme-aomori/.github/dependabot.yml","hash":"7e68a5fac86d2eb86706b9ec9e99bd0ce00c15b0","modified":1650886976745},{"_id":"themes/hexo-theme-aomori/languages/cn.yml","hash":"d0bbcf74dd4fe1edaa5d1b8bb462baf52ed8219a","modified":1650886976750},{"_id":"themes/hexo-theme-aomori/languages/it.yml","hash":"64a5acadfdcd365474ba1161041f8c5938f59683","modified":1650886976750},{"_id":"themes/hexo-theme-aomori/languages/ja.yml","hash":"377f95daca7054031d42c43cf4417adffbb9c8d0","modified":1650886976751},{"_id":"themes/hexo-theme-aomori/layout/archive.ejs","hash":"2703b07cc8ac64ae46d1d263f4653013c7e1666b","modified":1650886976761},{"_id":"themes/hexo-theme-aomori/layout/category.ejs","hash":"765426a9c8236828dc34759e604cc2c52292835a","modified":1650886976761},{"_id":"themes/hexo-theme-aomori/layout/index.ejs","hash":"ca9a6b1e5d2d952757671637156c5d72e6a0cb13","modified":1650886976762},{"_id":"themes/hexo-theme-aomori/layout/layout.ejs","hash":"c5dd66db0cea3796abda36146ab38f061c91f39e","modified":1650886976762},{"_id":"themes/hexo-theme-aomori/layout/page.ejs","hash":"5e77fecc752e7baa7ce5ac57162980202160811d","modified":1650886976763},{"_id":"themes/hexo-theme-aomori/layout/post.ejs","hash":"f80a3073ea72631a26292ba16906b6d692a6e67c","modified":1650886976763},{"_id":"themes/hexo-theme-aomori/layout/tag.ejs","hash":"eaa7b4ccb2ca7befb90142e4e68995fb1ea68b2e","modified":1650886976764},{"_id":"themes/hexo-theme-aomori/.github/workflows/action.yml","hash":"da59ad2d1d153ec97069cd74b920ea2e44d8ce3a","modified":1650886976746},{"_id":"themes/hexo-theme-aomori/layout/_partial/archive-post.ejs","hash":"74371ea0ece20630f686459a3df334b760c6bc55","modified":1650886976751},{"_id":"themes/hexo-theme-aomori/layout/_partial/archive.ejs","hash":"f15750967beb06d91491aade0b4b00cb76a37dc9","modified":1650886976751},{"_id":"themes/hexo-theme-aomori/layout/_partial/article-index.ejs","hash":"8137c8905844c74e67dc3ec1e52b211e0c470012","modified":1650886976752},{"_id":"themes/hexo-theme-aomori/layout/_partial/article-tweet.ejs","hash":"4b4e1b9d3cb302b837ed69e7a1cf64705050ff45","modified":1650886976752},{"_id":"themes/hexo-theme-aomori/layout/_partial/article.ejs","hash":"d3b071aafd0fbbe2551baed5a9687ca28c0433e3","modified":1650886976752},{"_id":"themes/hexo-theme-aomori/layout/_partial/footer.ejs","hash":"36fc43c78cb3e28425c1046a6b859063a0c6db10","modified":1650886976752},{"_id":"themes/hexo-theme-aomori/layout/_partial/head.ejs","hash":"f2339ff424d524051e2282cbdb2e7532efb0af8b","modified":1650886976753},{"_id":"themes/hexo-theme-aomori/layout/_partial/header.ejs","hash":"29618017302e56fcb0bcc3a6487bacf6cb668086","modified":1650886976753},{"_id":"themes/hexo-theme-aomori/layout/_partial/meta.ejs","hash":"c8c71be685e412afbd8e9b25262e22f483f5e729","modified":1650886976753},{"_id":"themes/hexo-theme-aomori/layout/_partial/search.ejs","hash":"3c0fe3c17d6469af32720653613af7b1ec1903cf","modified":1650886976759},{"_id":"themes/hexo-theme-aomori/layout/_partial/sidebar.ejs","hash":"0f049afead13cf54b5e2f3174379d7a79eac0efe","modified":1650886976759},{"_id":"themes/hexo-theme-aomori/layout/_partial/social.ejs","hash":"d3d003a7fb0a4e5a5bc26378351fd693fce982d3","modified":1650886976759},{"_id":"themes/hexo-theme-aomori/layout/_widget/archive.ejs","hash":"4d00993c9f80ddbce6d4b8317d4c29a4fb1fb139","modified":1650886976760},{"_id":"themes/hexo-theme-aomori/layout/_widget/category.ejs","hash":"70bba3e81f42135ffeb2d129834fd5df8aea4c10","modified":1650886976760},{"_id":"themes/hexo-theme-aomori/layout/_widget/recent_posts.ejs","hash":"d45e8c7b9c7fec1b8fdeabaa5026f27da0a04304","modified":1650886976760},{"_id":"themes/hexo-theme-aomori/layout/_widget/tag.ejs","hash":"e45f32b6c1b3a23c361d2c7dc70207d93c0f71b1","modified":1650886976760},{"_id":"themes/hexo-theme-aomori/layout/_widget/toc.ejs","hash":"05a8cea96817332d13bf3ede759e6f72ed0f7973","modified":1650886976760},{"_id":"themes/hexo-theme-aomori/source/dist/custom.css","hash":"309f9480fa4381d5e3892ef9c3fff79680b056df","modified":1650886976769},{"_id":"themes/hexo-theme-aomori/source/javascripts/app.js","hash":"d6a5de54f31f4e225f7d086f220aacc993accfd5","modified":1650886976771},{"_id":"themes/hexo-theme-aomori/source/javascripts/class-module.js","hash":"a771801e8e5528130a947958f605f9fc4c6d913d","modified":1650886976772},{"_id":"themes/hexo-theme-aomori/source/javascripts/custom.js","hash":"b186b1ae8921a3bf4d8746ac5f39acc10269ff96","modified":1650886976772},{"_id":"themes/hexo-theme-aomori/source/javascripts/disqusjs.js","hash":"1152117cee4e335306b79983573721aeb6418d39","modified":1650886976773},{"_id":"themes/hexo-theme-aomori/source/javascripts/gitalk.js","hash":"b2b847d6a4b8866f1a21896ab34b94adc607c6b4","modified":1650886976773},{"_id":"themes/hexo-theme-aomori/source/javascripts/valine.js","hash":"64a97abf6fb7291bccda74f108b5661a9694ebef","modified":1650886976773},{"_id":"themes/hexo-theme-aomori/source/modules/algoliasearch-lite.umd.js","hash":"bcd46b678c70779298df8ffad570ab14e434d292","modified":1650886976774},{"_id":"themes/hexo-theme-aomori/source/modules/lazyload.min.js","hash":"a9b706094ef95a2f4ce0ec6eef0181951c5a7208","modified":1650886976775},{"_id":"themes/hexo-theme-aomori/source/modules/md5.min.js","hash":"ab074f76aa161e2851e19733d802a66c9a242387","modified":1650886976776},{"_id":"themes/hexo-theme-aomori/source/modules/nprogress.js","hash":"14757ab1fcf209a4f17c9da3d6abb196fa65cba2","modified":1650886976776},{"_id":"themes/hexo-theme-aomori/source/modules/perfect-scrollbar.min.js","hash":"cd1784e029249ebf5d57de1f677a4a61019706ae","modified":1650886976776},{"_id":"themes/hexo-theme-aomori/source/modules/tocbot.min.js","hash":"76cd7f7ae727d3883d69a04a4402a46684e4d4d0","modified":1650886976779},{"_id":"themes/hexo-theme-aomori/source/modules/typed.min.js","hash":"ad8a75bd4743122b5dbf517221506607588ec50b","modified":1650886976779},{"_id":"themes/hexo-theme-aomori/source/stylesheets/base.scss","hash":"a26efbbdcf15e8d6e3c044e733294fc6e8bedc77","modified":1650886976780},{"_id":"themes/hexo-theme-aomori/source/stylesheets/github.css","hash":"ee593952684a791317ee8b77ad096e729dec649e","modified":1650886976780},{"_id":"themes/hexo-theme-aomori/source/stylesheets/media-fixed.scss","hash":"4b0ff31517a8a3106cf227d85ec305b346cfa69b","modified":1650886976780},{"_id":"themes/hexo-theme-aomori/source/stylesheets/normalize.css","hash":"ebe0759bf259b6caeadee6137973481046ac5636","modified":1650886976780},{"_id":"themes/hexo-theme-aomori/source/stylesheets/nprogress.css","hash":"af66636e02bccfe2fdf7c1ad7de1face9bf5ae2d","modified":1650886976780},{"_id":"themes/hexo-theme-aomori/source/stylesheets/page.scss","hash":"57c6874a0520cb31f2295e5d75c8dabde066b478","modified":1650886976781},{"_id":"themes/hexo-theme-aomori/source/stylesheets/perfect-scrollbar.css","hash":"a94e730430930b2e048352996ff44bf28647669d","modified":1650886976781},{"_id":"themes/hexo-theme-aomori/source/stylesheets/plyr.css","hash":"89c8e024bad75eec921898cae702785d77272dda","modified":1650886976781},{"_id":"themes/hexo-theme-aomori/source/stylesheets/post.css","hash":"3f06ce944c9f721cdb5ea26c96fa11f9c2f6ec2f","modified":1650886976781},{"_id":"themes/hexo-theme-aomori/source/stylesheets/remark42.css","hash":"b12749bacee85f203fcd10afd9212838ffef06f3","modified":1650886976782},{"_id":"themes/hexo-theme-aomori/source/stylesheets/spectre-exp.min.css","hash":"9ca686024f1e3c742a488156e8fcf4f7f5518425","modified":1650886976782},{"_id":"themes/hexo-theme-aomori/source/stylesheets/spectre-icons.min.css","hash":"0f624fe521e0eb6c1f775f13eb0fb93ab6cf802c","modified":1650886976782},{"_id":"themes/hexo-theme-aomori/source/stylesheets/spectre.min.css","hash":"419c87aed0f592239f2adcbb6396731c6a7711cc","modified":1650886976782},{"_id":"themes/hexo-theme-aomori/source/stylesheets/style.scss","hash":"c5649710386d149f7a29907d50d1cf09480be5a1","modified":1650886976783},{"_id":"themes/hexo-theme-aomori/source/stylesheets/swiper-bundle.min.css","hash":"a1fd2a708504af70216469cbd582cf698db8e461","modified":1650886976783},{"_id":"themes/hexo-theme-aomori/source/stylesheets/tocbot.css","hash":"635010b494dae3d91d3be1b079b72b26ab2cc5b8","modified":1650886976783},{"_id":"themes/hexo-theme-aomori/layout/_partial/page/default.ejs","hash":"23e0039aeba6413b99319fad4cea4e225aab38a1","modified":1650886976754},{"_id":"themes/hexo-theme-aomori/layout/_partial/page/friends.ejs","hash":"514e137c0e19e06dd3e930a98e5569cf83446b0a","modified":1650886976754},{"_id":"themes/hexo-theme-aomori/layout/_partial/page/photography.ejs","hash":"6a71806820a4d92082d307a0e4dc67976d4038c4","modified":1650886976755},{"_id":"themes/hexo-theme-aomori/layout/_partial/page/photography-item.ejs","hash":"e118a08496bb889d519995b0a35a659e8f39858f","modified":1650886976754},{"_id":"themes/hexo-theme-aomori/layout/_partial/post/category.ejs","hash":"c6bcd0e04271ffca81da25bcff5adf3d46f02fc0","modified":1650886976756},{"_id":"themes/hexo-theme-aomori/layout/_partial/post/ad.ejs","hash":"0a8130bcec7879f830976858b8d0dfe0ba036c01","modified":1650886976755},{"_id":"themes/hexo-theme-aomori/layout/_partial/post/comments.ejs","hash":"1502b23d5520b5db6c31c8036187f5373b4eb794","modified":1650886976756},{"_id":"themes/hexo-theme-aomori/layout/_partial/post/copyright.ejs","hash":"4f1f566351a2ddff3f44f854a58f65ba6b28072c","modified":1650886976756},{"_id":"themes/hexo-theme-aomori/layout/_partial/post/date.ejs","hash":"c610dc1283e5d6ae582b9544ee6836e9fcea1b7c","modified":1650886976756},{"_id":"themes/hexo-theme-aomori/layout/_partial/post/gallery.ejs","hash":"4502ca02780f3054cfaa517c9946d8c0479966cb","modified":1650886976757},{"_id":"themes/hexo-theme-aomori/layout/_partial/post/nav.ejs","hash":"d86028403ef9a098747712dc3103ed69c5089daa","modified":1650886976757},{"_id":"themes/hexo-theme-aomori/layout/_partial/post/refer.ejs","hash":"bb757d495f6928c6d41c11dace1c549c91fd95b7","modified":1650886976757},{"_id":"themes/hexo-theme-aomori/layout/_partial/post/tag.ejs","hash":"2fcb0bf9c8847a644167a27824c9bb19ac74dd14","modified":1650886976758},{"_id":"themes/hexo-theme-aomori/layout/_partial/post/reprint.ejs","hash":"75e9c766d19cb0907214e5628e00868b2adb6dcb","modified":1650886976758},{"_id":"themes/hexo-theme-aomori/layout/_partial/post/title.ejs","hash":"2f275739b6f1193c123646a5a31f37d48644c667","modified":1650886976759},{"_id":"source/_posts/zxing二维码的生成/1613878321918-810b6f23-69ad-4817-a58a-16739f945cec.png","hash":"6b2eb2a452c8aaa0f6fb8b71d4145a284db251ae","modified":1614041663929},{"_id":"themes/hexo-theme-aomori/source/modules/highlight.min.js","hash":"5c25af3caf3f02695741a4b989fedcca6cc1e88d","modified":1650886976775},{"_id":"themes/hexo-theme-aomori/source/modules/plyr.js","hash":"6bce9267aa6e64f77973f7079cea430d88befca1","modified":1650886976778},{"_id":"source/_posts/docker配置MYSQL集群(上)/navicat.png","hash":"2fc908c20d8f72f0692e2e1d2b34f03280d8d971","modified":1611719902571},{"_id":"source/_posts/docker配置MYSQL集群(上)/截屏2021-01-23 21.59.27.png","hash":"b96de233fb4c6bb12196f2f5342b48d3bbaf326e","modified":1611719945439},{"_id":"source/_posts/复杂mapper映射出现Expected one result (or null) to be returned by selectOne(), but found_ 6/1612150436476-e7e658e8-81a4-4292-9b5b-9c00ab6b823f.png","hash":"e5fb13b87864d2ab343e4c393fb4940d22758d0f","modified":1612152411834},{"_id":"source/temp/GANs/1610005130361-d3374c7e-7456-4bba-b3a7-b7eb49fb6974-20210128162026163.png","hash":"adf5c00ae3ad16b210e09c25e09af6425d764f50","modified":1611822026164},{"_id":"source/_posts/Nacos：如果注册服务（上）/1615627294785-e203d13a-6656-44b9-b5e2-69f5a32017d1.png","hash":"4c017ee78eb9014f5245a8a6900b6854be5d5f97","modified":1615711635159},{"_id":"source/_posts/Java中ThreadLocal是如何保证线程安全的/截屏2021-03-22 17.04.09.png","hash":"2f82d71113f576036c1352aaa14f029a605721c1","modified":1616403854396},{"_id":"themes/hexo-theme-aomori/docs/cover.png","hash":"f52354acc7e9e52efcafc2c33e41a4907c541055","modified":1650886976749},{"_id":"themes/hexo-theme-aomori/source/dist/build.css","hash":"b3be1f325c7f8e1eb2a8b470285d4fe9e1a9e95e","modified":1650886976765},{"_id":"themes/hexo-theme-aomori/source/dist/custom.js","hash":"7dd03842bb905d065a41366ce88bde7a1da5808d","modified":1650886976771},{"_id":"themes/hexo-theme-aomori/source/modules/swiper-bundle.min.js","hash":"72bd612182b6c475aa3d896231341a87da680ecb","modified":1650886976779},{"_id":"source/_posts/docker配置MYSQL集群(上)/截屏2021-01-20 14.30.05.png","hash":"f51d756c44fa5c64ba66879478d8b7bc955c39fa","modified":1611719922122},{"_id":"source/_posts/docker配置MYSQL集群(上)/截屏2021-01-20 23.46.48.png","hash":"1e848c9d9427e616488b9b920092a49d9be4fe21","modified":1611719939752},{"_id":"source/_posts/Nacos：如果注册服务（上）/1615625705374-a7db4ed1-7021-4e98-9eee-058ae34afd4d.png","hash":"faf7b931c10b43f3222e1e9eefce0eef7823c745","modified":1615711564421},{"_id":"source/temp/GANs/1609914460948-9656b2ad-bae1-4804-8cca-cd6e26bbdf49.png","hash":"20b6ee3e02248acaf995d904d7ef49a3c816516b","modified":1611821783839},{"_id":"source/temp/GANs/1610005130361-d3374c7e-7456-4bba-b3a7-b7eb49fb6974-20210128162008057.png","hash":"adf5c00ae3ad16b210e09c25e09af6425d764f50","modified":1611822008058},{"_id":"source/temp/GANs/1610005130361-d3374c7e-7456-4bba-b3a7-b7eb49fb6974.png","hash":"adf5c00ae3ad16b210e09c25e09af6425d764f50","modified":1611821739331},{"_id":"source/_posts/Redis使用/1612949134565-6f08df50-431b-40ba-ba8e-eac9104e8f9d-20210225113349251.png","hash":"cb580c51a045194276f54036fa03c68f6d50c86b","modified":1614224029252},{"_id":"themes/hexo-theme-aomori/source/dist/build.js","hash":"a36f7dc0df1c252b2f407ceed1bb2bd6f31ba2ce","modified":1650886976769},{"_id":"source/temp/GANs/1609987534946-5568cebc-0d23-4bc7-a175-73a5872b732e.png","hash":"811e801c35eca731ba9db6a82969e45b92b4d629","modified":1611821911770},{"_id":"source/_posts/复杂mapper映射出现Expected one result (or null) to be returned by selectOne(), but found_ 6/1612149616517-3d3f353b-1319-4315-a12a-3592c873810c.png","hash":"f54a251d067cbaab6b131dc59dff05bf02a8a210","modified":1612155090794},{"_id":"source/_posts/docker配置MYSQL集群(上)/集群原理.png","hash":"26b5974aacc7c19be6b36d4a621e04c7fcc421a6","modified":1611068107078},{"_id":"source/images/favicon.png","hash":"380b2175b6da9ddd54e843515dafa20b57e33761","modified":1650887597771}],"Category":[{"name":"线程安全","_id":"cl2enrqzd0004y2lo0w0yf26s"},{"name":"SpringCloud","_id":"cl2enrqzi000cy2lo3dj87qcd"},{"name":"Spring","_id":"cl2enrqzk000iy2lo6non0bn6"},{"name":"中东战争史","_id":"cl2enrqzu0017y2lo57dd205m"}],"Data":[{"_id":"photography","data":[{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","title":"玉渊潭","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","title":"花儿","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","title":"白塔寺","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"}]}],"Page":[{"layout":"post","slug":"photos","title":"相册","noDate":"true","comments":0,"_content":"<link rel=\"stylesheet\" href=\"./ins.css\">\n<div class=\"photos-btn-wrap\">\n  <a class=\"photos-btn active\" href=\"javascript:void(0)\">Ins</a>\n  <a class=\"photos-btn\" target=\"_blank\" href=\"http://litten.me/gallery/\">摄影</a>\n</div>\n<div class=\"instagram itemscope\">\n  <a href=\"https://yizhichangyuan.github.io/\" target=\"_blank\" class=\"open-ins\">图片来自instagram，正在加载中…</a>\n</div>\n<script>\n  (function() {\n    var loadScript = function(path) {\n      var $script = document.createElement('script')\n      document.getElementsByTagName('body')[0].appendChild($script)\n      $script.setAttribute('src', path)\n    }\n    setTimeout(function() {\n      loadScript('./ins.js')\n    }, 0)\n  })()\n</script>","source":"blog-photo/index.html","raw":"---\nlayout: post\nslug: \"photos\"\ntitle: \"相册\"\nnoDate: \"true\"\ncomments: \"false\"\n---\n<link rel=\"stylesheet\" href=\"./ins.css\">\n<div class=\"photos-btn-wrap\">\n  <a class=\"photos-btn active\" href=\"javascript:void(0)\">Ins</a>\n  <a class=\"photos-btn\" target=\"_blank\" href=\"http://litten.me/gallery/\">摄影</a>\n</div>\n<div class=\"instagram itemscope\">\n  <a href=\"https://yizhichangyuan.github.io/\" target=\"_blank\" class=\"open-ins\">图片来自instagram，正在加载中…</a>\n</div>\n<script>\n  (function() {\n    var loadScript = function(path) {\n      var $script = document.createElement('script')\n      document.getElementsByTagName('body')[0].appendChild($script)\n      $script.setAttribute('src', path)\n    }\n    setTimeout(function() {\n      loadScript('./ins.js')\n    }, 0)\n  })()\n</script>","date":"2021-03-28T10:52:14.223Z","updated":"2021-01-27T14:51:27.631Z","path":"blog-photo/index.html","_id":"cl2enrqz50000y2lo0tsras1u","content":"<link rel=\"stylesheet\" href=\"./ins.css\">\n<div class=\"photos-btn-wrap\">\n  <a class=\"photos-btn active\" href=\"javascript:void(0)\">Ins</a>\n  <a class=\"photos-btn\" target=\"_blank\" href=\"http://litten.me/gallery/\">摄影</a>\n</div>\n<div class=\"instagram itemscope\">\n  <a href=\"https://yizhichangyuan.github.io/\" target=\"_blank\" class=\"open-ins\">图片来自instagram，正在加载中…</a>\n</div>\n<script>\n  (function() {\n    var loadScript = function(path) {\n      var $script = document.createElement('script')\n      document.getElementsByTagName('body')[0].appendChild($script)\n      $script.setAttribute('src', path)\n    }\n    setTimeout(function() {\n      loadScript('./ins.js')\n    }, 0)\n  })()\n</script>","site":{"data":{"photography":[{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","title":"玉渊潭","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","title":"花儿","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","title":"白塔寺","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"}]}},"excerpt":"","more":"<link rel=\"stylesheet\" href=\"./ins.css\">\n<div class=\"photos-btn-wrap\">\n  <a class=\"photos-btn active\" href=\"javascript:void(0)\">Ins</a>\n  <a class=\"photos-btn\" target=\"_blank\" href=\"http://litten.me/gallery/\">摄影</a>\n</div>\n<div class=\"instagram itemscope\">\n  <a href=\"https://yizhichangyuan.github.io/\" target=\"_blank\" class=\"open-ins\">图片来自instagram，正在加载中…</a>\n</div>\n<script>\n  (function() {\n    var loadScript = function(path) {\n      var $script = document.createElement('script')\n      document.getElementsByTagName('body')[0].appendChild($script)\n      $script.setAttribute('src', path)\n    }\n    setTimeout(function() {\n      loadScript('./ins.js')\n    }, 0)\n  })()\n</script>"},{"title":"blog-photo","date":"2021-01-27T14:13:31.000Z","_content":"","source":"blog-photo/index.md","raw":"---\ntitle: blog-photo\ndate: 2021-01-27 22:13:31\n---\n","updated":"2021-01-27T14:13:31.313Z","path":"blog-photo/index.html","comments":1,"layout":"page","_id":"cl2enrqzb0002y2lo6u429935","content":"","site":{"data":{"photography":[{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","title":"玉渊潭","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","title":"花儿","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","title":"白塔寺","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"}]}},"excerpt":"","more":""},{"_content":"#post-instagram{\n\tpadding: 30px;\n}\n#post-instagram .article-entry{\n\tpadding-right: 0;\n}\n.instagram{\n\tposition: relative;\n\tmin-height: 500px;\n}\n.instagram img {\n\twidth: 100%;\n}\n.instagram .year {\n\tfont-size: 16px;\n}\n.instagram .open-ins{\n\tpadding: 10px 0;\n\tcolor: #cdcdcd;\n}\n.instagram .open-ins:hover{\n\tcolor: #657b83;\n}\n.instagram .year{\n\tdisplay: inline;\n}\n.instagram .thumb {\n\twidth: 25%;\n\theight: 0; \n\tpadding-bottom: 25%;\n\tposition: relative;\n\tdisplay: inline-block;\n\ttext-align: center;\n\tbackground: #ededed;\n\toutline: 1px solid #ddd;\n}\n.instagram .thumb a {\n\tposition: relative;\n}\n.instagram .album h1 em{\n\tfont-style: normal;\n\tfont-size: 14px;\n\tmargin-left: 10px;\n}\n.instagram .album ul{\n\tdisplay: flex;\n\tflex-wrap: wrap;\n\tclear: both;\n\twidth: 100%;\n\ttext-align: left;\n}\n.instagram .album li{\n\tlist-style: none;\n\tdisplay: inline-block;\n\tbox-sizing: border-box;\n\tpadding: 0 5px;\n\tmargin-bottom: -10px;\n\theight: 0;\n\twidth: 25%;\n\tposition: relative;\n\tpadding-bottom: 25%;\n}\n.instagram .album li:before{\n\tdisplay: none;\n}\n.instagram .album div.img-box{\n\tposition: absolute;\n\twidth: 90%;\n\theight: 90%;\n\t-webkit-box-shadow: 0 1px 0 rgba(255,255,255,0.4), 0 1px 0 1px rgba(255,255,255,0.1);\n\t-moz-box-shadow: 0 1px 0 rgba(255,255,255,0.4), 0 1px 0 1px rgba(255,255,255,0.1);\n\tbox-shadow: 0 1px 0 rgba(255,255,255,0.4), 0 1px 0 1px rgba(255,255,255,0.1);\n}\n.instagram .album div.img-box img{\n\twidth: 100%;\n\theight: 100%;\n    position: absolute;\n    z-index: 2;\n}\n.instagram .album div.img-box .img-bg{\n\tposition: absolute;\n\ttop: 0;\n\tleft: 0;\n\tbottom: 0px;\n\twidth: 100%;\n\tmargin: -5px;\n\tpadding: 5px;\n\t-webkit-box-shadow: 0 0 0 1px rgba(0,0,0,.04), 0 1px 5px rgba(0,0,0,0.1);\n\t-moz-box-shadow: 0 0 0 1px rgba(0,0,0,.04), 0 1px 5px rgba(0,0,0,0.1);\n\tbox-shadow: 0 0 0 1px rgba(0,0,0,.04), 0 1px 5px rgba(0,0,0,0.1);\n\t-webkit-transition: all 0.15s ease-out 0.1s;\n\t-moz-transition: all 0.15s ease-out 0.1s;\n\t-o-transition: all 0.15s ease-out 0.1s;\n\ttransition: all 0.15s ease-out 0.1s;\n\topacity: 0.2;\n\tcursor: pointer;\n\tdisplay: block;\n\tz-index: 3;\n}\n.instagram .album div.img-box .icon {\n    font-size: 14px;\n    position: absolute;\n    left: 50%;\n    top: 50%;\n    margin-left: -7px;\n    margin-top: -7px;\n    color: #999;\n    z-index: 1;\n}\n.instagram .album div.img-box .img-bg:hover{\n\topacity: 0;\n}\n.photos-btn-wrap {\n\tborder-bottom: 1px solid #e5e5e5;\n\tmargin-bottom: 20px;\n}\n.photos-btn {\n\tfont-size: 16px;\n\tcolor: #333;\n\tmargin-bottom: -4px;\n\tpadding: 5px 8px 3px;\n}\n.photos-btn.active {\n\tcolor: #08c;\n\tborder: 1px solid #e5e5e5;\n\tborder-bottom: 5px solid #fff;\n}\n\n@media screen and (max-width:600px) {\n\t.instagram .thumb {\n\t\twidth: 50%;\n\t\tpadding-bottom: 50%;\n\t}\n\t.instagram .album li {\n\t\twidth: 100%;\n\t\tposition: relative;\n\t\tpadding-bottom: 100%;\n\t\ttext-align: center;\n\t}\n\t.instagram .album div.img-box{\n\t\tmargin: 0;\n\t\twidth: 90%;\n\t\theight: 90%;\n\t}\n}\n\n/* ====== video ===== */\n.video-container {\n    z-index: 1;\n    position: relative;\n    padding-bottom: 56.25%;\n    margin: 0 auto;\n}\n.video-container iframe, .video-container object, .video-container embed {\n    z-index: 1;\n    position: absolute;\n    top: 0;\n    left: 7%;\n    width: 85%;\n    height: 85%;\n    box-shadow: 0px 0px 20px 2px #888888;\n} \t\n","source":"blog-photo/ins.css","raw":"#post-instagram{\n\tpadding: 30px;\n}\n#post-instagram .article-entry{\n\tpadding-right: 0;\n}\n.instagram{\n\tposition: relative;\n\tmin-height: 500px;\n}\n.instagram img {\n\twidth: 100%;\n}\n.instagram .year {\n\tfont-size: 16px;\n}\n.instagram .open-ins{\n\tpadding: 10px 0;\n\tcolor: #cdcdcd;\n}\n.instagram .open-ins:hover{\n\tcolor: #657b83;\n}\n.instagram .year{\n\tdisplay: inline;\n}\n.instagram .thumb {\n\twidth: 25%;\n\theight: 0; \n\tpadding-bottom: 25%;\n\tposition: relative;\n\tdisplay: inline-block;\n\ttext-align: center;\n\tbackground: #ededed;\n\toutline: 1px solid #ddd;\n}\n.instagram .thumb a {\n\tposition: relative;\n}\n.instagram .album h1 em{\n\tfont-style: normal;\n\tfont-size: 14px;\n\tmargin-left: 10px;\n}\n.instagram .album ul{\n\tdisplay: flex;\n\tflex-wrap: wrap;\n\tclear: both;\n\twidth: 100%;\n\ttext-align: left;\n}\n.instagram .album li{\n\tlist-style: none;\n\tdisplay: inline-block;\n\tbox-sizing: border-box;\n\tpadding: 0 5px;\n\tmargin-bottom: -10px;\n\theight: 0;\n\twidth: 25%;\n\tposition: relative;\n\tpadding-bottom: 25%;\n}\n.instagram .album li:before{\n\tdisplay: none;\n}\n.instagram .album div.img-box{\n\tposition: absolute;\n\twidth: 90%;\n\theight: 90%;\n\t-webkit-box-shadow: 0 1px 0 rgba(255,255,255,0.4), 0 1px 0 1px rgba(255,255,255,0.1);\n\t-moz-box-shadow: 0 1px 0 rgba(255,255,255,0.4), 0 1px 0 1px rgba(255,255,255,0.1);\n\tbox-shadow: 0 1px 0 rgba(255,255,255,0.4), 0 1px 0 1px rgba(255,255,255,0.1);\n}\n.instagram .album div.img-box img{\n\twidth: 100%;\n\theight: 100%;\n    position: absolute;\n    z-index: 2;\n}\n.instagram .album div.img-box .img-bg{\n\tposition: absolute;\n\ttop: 0;\n\tleft: 0;\n\tbottom: 0px;\n\twidth: 100%;\n\tmargin: -5px;\n\tpadding: 5px;\n\t-webkit-box-shadow: 0 0 0 1px rgba(0,0,0,.04), 0 1px 5px rgba(0,0,0,0.1);\n\t-moz-box-shadow: 0 0 0 1px rgba(0,0,0,.04), 0 1px 5px rgba(0,0,0,0.1);\n\tbox-shadow: 0 0 0 1px rgba(0,0,0,.04), 0 1px 5px rgba(0,0,0,0.1);\n\t-webkit-transition: all 0.15s ease-out 0.1s;\n\t-moz-transition: all 0.15s ease-out 0.1s;\n\t-o-transition: all 0.15s ease-out 0.1s;\n\ttransition: all 0.15s ease-out 0.1s;\n\topacity: 0.2;\n\tcursor: pointer;\n\tdisplay: block;\n\tz-index: 3;\n}\n.instagram .album div.img-box .icon {\n    font-size: 14px;\n    position: absolute;\n    left: 50%;\n    top: 50%;\n    margin-left: -7px;\n    margin-top: -7px;\n    color: #999;\n    z-index: 1;\n}\n.instagram .album div.img-box .img-bg:hover{\n\topacity: 0;\n}\n.photos-btn-wrap {\n\tborder-bottom: 1px solid #e5e5e5;\n\tmargin-bottom: 20px;\n}\n.photos-btn {\n\tfont-size: 16px;\n\tcolor: #333;\n\tmargin-bottom: -4px;\n\tpadding: 5px 8px 3px;\n}\n.photos-btn.active {\n\tcolor: #08c;\n\tborder: 1px solid #e5e5e5;\n\tborder-bottom: 5px solid #fff;\n}\n\n@media screen and (max-width:600px) {\n\t.instagram .thumb {\n\t\twidth: 50%;\n\t\tpadding-bottom: 50%;\n\t}\n\t.instagram .album li {\n\t\twidth: 100%;\n\t\tposition: relative;\n\t\tpadding-bottom: 100%;\n\t\ttext-align: center;\n\t}\n\t.instagram .album div.img-box{\n\t\tmargin: 0;\n\t\twidth: 90%;\n\t\theight: 90%;\n\t}\n}\n\n/* ====== video ===== */\n.video-container {\n    z-index: 1;\n    position: relative;\n    padding-bottom: 56.25%;\n    margin: 0 auto;\n}\n.video-container iframe, .video-container object, .video-container embed {\n    z-index: 1;\n    position: absolute;\n    top: 0;\n    left: 7%;\n    width: 85%;\n    height: 85%;\n    box-shadow: 0px 0px 20px 2px #888888;\n} \t\n","date":"2021-03-28T10:52:14.225Z","updated":"2021-01-27T14:28:24.000Z","path":"blog-photo/ins.css","layout":"false","title":"","comments":1,"_id":"cl2enrqze0006y2lo05te2mw0","content":"#post-instagram{\n\tpadding: 30px;\n}\n#post-instagram .article-entry{\n\tpadding-right: 0;\n}\n.instagram{\n\tposition: relative;\n\tmin-height: 500px;\n}\n.instagram img {\n\twidth: 100%;\n}\n.instagram .year {\n\tfont-size: 16px;\n}\n.instagram .open-ins{\n\tpadding: 10px 0;\n\tcolor: #cdcdcd;\n}\n.instagram .open-ins:hover{\n\tcolor: #657b83;\n}\n.instagram .year{\n\tdisplay: inline;\n}\n.instagram .thumb {\n\twidth: 25%;\n\theight: 0; \n\tpadding-bottom: 25%;\n\tposition: relative;\n\tdisplay: inline-block;\n\ttext-align: center;\n\tbackground: #ededed;\n\toutline: 1px solid #ddd;\n}\n.instagram .thumb a {\n\tposition: relative;\n}\n.instagram .album h1 em{\n\tfont-style: normal;\n\tfont-size: 14px;\n\tmargin-left: 10px;\n}\n.instagram .album ul{\n\tdisplay: flex;\n\tflex-wrap: wrap;\n\tclear: both;\n\twidth: 100%;\n\ttext-align: left;\n}\n.instagram .album li{\n\tlist-style: none;\n\tdisplay: inline-block;\n\tbox-sizing: border-box;\n\tpadding: 0 5px;\n\tmargin-bottom: -10px;\n\theight: 0;\n\twidth: 25%;\n\tposition: relative;\n\tpadding-bottom: 25%;\n}\n.instagram .album li:before{\n\tdisplay: none;\n}\n.instagram .album div.img-box{\n\tposition: absolute;\n\twidth: 90%;\n\theight: 90%;\n\t-webkit-box-shadow: 0 1px 0 rgba(255,255,255,0.4), 0 1px 0 1px rgba(255,255,255,0.1);\n\t-moz-box-shadow: 0 1px 0 rgba(255,255,255,0.4), 0 1px 0 1px rgba(255,255,255,0.1);\n\tbox-shadow: 0 1px 0 rgba(255,255,255,0.4), 0 1px 0 1px rgba(255,255,255,0.1);\n}\n.instagram .album div.img-box img{\n\twidth: 100%;\n\theight: 100%;\n    position: absolute;\n    z-index: 2;\n}\n.instagram .album div.img-box .img-bg{\n\tposition: absolute;\n\ttop: 0;\n\tleft: 0;\n\tbottom: 0px;\n\twidth: 100%;\n\tmargin: -5px;\n\tpadding: 5px;\n\t-webkit-box-shadow: 0 0 0 1px rgba(0,0,0,.04), 0 1px 5px rgba(0,0,0,0.1);\n\t-moz-box-shadow: 0 0 0 1px rgba(0,0,0,.04), 0 1px 5px rgba(0,0,0,0.1);\n\tbox-shadow: 0 0 0 1px rgba(0,0,0,.04), 0 1px 5px rgba(0,0,0,0.1);\n\t-webkit-transition: all 0.15s ease-out 0.1s;\n\t-moz-transition: all 0.15s ease-out 0.1s;\n\t-o-transition: all 0.15s ease-out 0.1s;\n\ttransition: all 0.15s ease-out 0.1s;\n\topacity: 0.2;\n\tcursor: pointer;\n\tdisplay: block;\n\tz-index: 3;\n}\n.instagram .album div.img-box .icon {\n    font-size: 14px;\n    position: absolute;\n    left: 50%;\n    top: 50%;\n    margin-left: -7px;\n    margin-top: -7px;\n    color: #999;\n    z-index: 1;\n}\n.instagram .album div.img-box .img-bg:hover{\n\topacity: 0;\n}\n.photos-btn-wrap {\n\tborder-bottom: 1px solid #e5e5e5;\n\tmargin-bottom: 20px;\n}\n.photos-btn {\n\tfont-size: 16px;\n\tcolor: #333;\n\tmargin-bottom: -4px;\n\tpadding: 5px 8px 3px;\n}\n.photos-btn.active {\n\tcolor: #08c;\n\tborder: 1px solid #e5e5e5;\n\tborder-bottom: 5px solid #fff;\n}\n\n@media screen and (max-width:600px) {\n\t.instagram .thumb {\n\t\twidth: 50%;\n\t\tpadding-bottom: 50%;\n\t}\n\t.instagram .album li {\n\t\twidth: 100%;\n\t\tposition: relative;\n\t\tpadding-bottom: 100%;\n\t\ttext-align: center;\n\t}\n\t.instagram .album div.img-box{\n\t\tmargin: 0;\n\t\twidth: 90%;\n\t\theight: 90%;\n\t}\n}\n\n/* ====== video ===== */\n.video-container {\n    z-index: 1;\n    position: relative;\n    padding-bottom: 56.25%;\n    margin: 0 auto;\n}\n.video-container iframe, .video-container object, .video-container embed {\n    z-index: 1;\n    position: absolute;\n    top: 0;\n    left: 7%;\n    width: 85%;\n    height: 85%;\n    box-shadow: 0px 0px 20px 2px #888888;\n} \t\n","site":{"data":{"photography":[{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","title":"玉渊潭","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","title":"花儿","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","title":"白塔寺","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"}]}},"excerpt":"","more":"#post-instagram{\n\tpadding: 30px;\n}\n#post-instagram .article-entry{\n\tpadding-right: 0;\n}\n.instagram{\n\tposition: relative;\n\tmin-height: 500px;\n}\n.instagram img {\n\twidth: 100%;\n}\n.instagram .year {\n\tfont-size: 16px;\n}\n.instagram .open-ins{\n\tpadding: 10px 0;\n\tcolor: #cdcdcd;\n}\n.instagram .open-ins:hover{\n\tcolor: #657b83;\n}\n.instagram .year{\n\tdisplay: inline;\n}\n.instagram .thumb {\n\twidth: 25%;\n\theight: 0; \n\tpadding-bottom: 25%;\n\tposition: relative;\n\tdisplay: inline-block;\n\ttext-align: center;\n\tbackground: #ededed;\n\toutline: 1px solid #ddd;\n}\n.instagram .thumb a {\n\tposition: relative;\n}\n.instagram .album h1 em{\n\tfont-style: normal;\n\tfont-size: 14px;\n\tmargin-left: 10px;\n}\n.instagram .album ul{\n\tdisplay: flex;\n\tflex-wrap: wrap;\n\tclear: both;\n\twidth: 100%;\n\ttext-align: left;\n}\n.instagram .album li{\n\tlist-style: none;\n\tdisplay: inline-block;\n\tbox-sizing: border-box;\n\tpadding: 0 5px;\n\tmargin-bottom: -10px;\n\theight: 0;\n\twidth: 25%;\n\tposition: relative;\n\tpadding-bottom: 25%;\n}\n.instagram .album li:before{\n\tdisplay: none;\n}\n.instagram .album div.img-box{\n\tposition: absolute;\n\twidth: 90%;\n\theight: 90%;\n\t-webkit-box-shadow: 0 1px 0 rgba(255,255,255,0.4), 0 1px 0 1px rgba(255,255,255,0.1);\n\t-moz-box-shadow: 0 1px 0 rgba(255,255,255,0.4), 0 1px 0 1px rgba(255,255,255,0.1);\n\tbox-shadow: 0 1px 0 rgba(255,255,255,0.4), 0 1px 0 1px rgba(255,255,255,0.1);\n}\n.instagram .album div.img-box img{\n\twidth: 100%;\n\theight: 100%;\n    position: absolute;\n    z-index: 2;\n}\n.instagram .album div.img-box .img-bg{\n\tposition: absolute;\n\ttop: 0;\n\tleft: 0;\n\tbottom: 0px;\n\twidth: 100%;\n\tmargin: -5px;\n\tpadding: 5px;\n\t-webkit-box-shadow: 0 0 0 1px rgba(0,0,0,.04), 0 1px 5px rgba(0,0,0,0.1);\n\t-moz-box-shadow: 0 0 0 1px rgba(0,0,0,.04), 0 1px 5px rgba(0,0,0,0.1);\n\tbox-shadow: 0 0 0 1px rgba(0,0,0,.04), 0 1px 5px rgba(0,0,0,0.1);\n\t-webkit-transition: all 0.15s ease-out 0.1s;\n\t-moz-transition: all 0.15s ease-out 0.1s;\n\t-o-transition: all 0.15s ease-out 0.1s;\n\ttransition: all 0.15s ease-out 0.1s;\n\topacity: 0.2;\n\tcursor: pointer;\n\tdisplay: block;\n\tz-index: 3;\n}\n.instagram .album div.img-box .icon {\n    font-size: 14px;\n    position: absolute;\n    left: 50%;\n    top: 50%;\n    margin-left: -7px;\n    margin-top: -7px;\n    color: #999;\n    z-index: 1;\n}\n.instagram .album div.img-box .img-bg:hover{\n\topacity: 0;\n}\n.photos-btn-wrap {\n\tborder-bottom: 1px solid #e5e5e5;\n\tmargin-bottom: 20px;\n}\n.photos-btn {\n\tfont-size: 16px;\n\tcolor: #333;\n\tmargin-bottom: -4px;\n\tpadding: 5px 8px 3px;\n}\n.photos-btn.active {\n\tcolor: #08c;\n\tborder: 1px solid #e5e5e5;\n\tborder-bottom: 5px solid #fff;\n}\n\n@media screen and (max-width:600px) {\n\t.instagram .thumb {\n\t\twidth: 50%;\n\t\tpadding-bottom: 50%;\n\t}\n\t.instagram .album li {\n\t\twidth: 100%;\n\t\tposition: relative;\n\t\tpadding-bottom: 100%;\n\t\ttext-align: center;\n\t}\n\t.instagram .album div.img-box{\n\t\tmargin: 0;\n\t\twidth: 90%;\n\t\theight: 90%;\n\t}\n}\n\n/* ====== video ===== */\n.video-container {\n    z-index: 1;\n    position: relative;\n    padding-bottom: 56.25%;\n    margin: 0 auto;\n}\n.video-container iframe, .video-container object, .video-container embed {\n    z-index: 1;\n    position: absolute;\n    top: 0;\n    left: 7%;\n    width: 85%;\n    height: 85%;\n    box-shadow: 0px 0px 20px 2px #888888;\n} \t\n"},{"_content":"/*!\n * An jQuery | zepto plugin for lazy loading images.\n * author -> jieyou\n * see https://github.com/jieyou/lazyload\n * use some tuupola's code https://github.com/tuupola/jquery_lazyload (BSD)\n * use component's throttle https://github.com/component/throttle (MIT)\n */\n!function(a){\"function\"==typeof define&&define.amd?define([\"jquery\"],a):a(window.jQuery||window.Zepto)}(function(a){function g(){}function h(a,b){var e;return e=b._$container==d?(\"innerHeight\"in c?c.innerHeight:d.height())+d.scrollTop():b._$container.offset().top+b._$container.height(),e<=a.offset().top-b.threshold}function i(b,e){var f;return f=e._$container==d?d.width()+(a.fn.scrollLeft?d.scrollLeft():c.pageXOffset):e._$container.offset().left+e._$container.width(),f<=b.offset().left-e.threshold}function j(a,b){var c;return c=b._$container==d?d.scrollTop():b._$container.offset().top,c>=a.offset().top+b.threshold+a.height()}function k(b,e){var f;return f=e._$container==d?a.fn.scrollLeft?d.scrollLeft():c.pageXOffset:e._$container.offset().left,f>=b.offset().left+e.threshold+b.width()}function l(a,b){var c=0;a.each(function(d){function g(){f.trigger(\"_lazyload_appear\"),c=0}var f=a.eq(d);if(!(f.width()<=0&&f.height()<=0||\"none\"===f.css(\"display\")))if(b.vertical_only)if(j(f,b));else if(h(f,b)){if(++c>b.failure_limit)return!1}else g();else if(j(f,b)||k(f,b));else if(h(f,b)||i(f,b)){if(++c>b.failure_limit)return!1}else g()})}function m(a){return a.filter(function(b){return!a.eq(b)._lazyload_loadStarted})}function n(a,b){function h(){f=0,g=+new Date,e=a.apply(c,d),c=null,d=null}var c,d,e,f,g=0;return function(){c=this,d=arguments;var a=new Date-g;return f||(a>=b?h():f=setTimeout(h,b-a)),e}}var f,c=window,d=a(c),e={threshold:0,failure_limit:0,event:\"scroll\",effect:\"show\",effect_params:null,container:c,data_attribute:\"original\",data_srcset_attribute:\"original-srcset\",skip_invisible:!0,appear:g,load:g,vertical_only:!1,check_appear_throttle_time:300,url_rewriter_fn:g,no_fake_img_loader:!1,placeholder_data_img:\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC\",placeholder_real_img:\"http://ditu.baidu.cn/yyfm/lazyload/0.0.1/img/placeholder.png\"};f=function(){var a=Object.prototype.toString;return function(b){return a.call(b).replace(\"[object \",\"\").replace(\"]\",\"\")}}(),a.fn.hasOwnProperty(\"lazyload\")||(a.fn.lazyload=function(b){var i,j,k,h=this;return a.isPlainObject(b)||(b={}),a.each(e,function(g,h){var i=f(b[g]);-1!=a.inArray(g,[\"threshold\",\"failure_limit\",\"check_appear_throttle_time\"])?\"String\"==i?b[g]=parseInt(b[g],10):\"Number\"!=i&&(b[g]=h):\"container\"==g?(b._$container=b.hasOwnProperty(g)?b[g]==c||b[g]==document?d:a(b[g]):d,delete b.container):!e.hasOwnProperty(g)||b.hasOwnProperty(g)&&i==f(e[g])||(b[g]=h)}),i=\"scroll\"==b.event,k=0==b.check_appear_throttle_time?l:n(l,b.check_appear_throttle_time),j=i||\"scrollstart\"==b.event||\"scrollstop\"==b.event,h.each(function(c){var e=this,f=h.eq(c),i=f.attr(\"src\"),k=f.attr(\"data-\"+b.data_attribute),l=b.url_rewriter_fn==g?k:b.url_rewriter_fn.call(e,f,k),n=f.attr(\"data-\"+b.data_srcset_attribute),o=f.is(\"img\");return 1==f._lazyload_loadStarted||i==l?(f._lazyload_loadStarted=!0,h=m(h),void 0):(f._lazyload_loadStarted=!1,o&&!i&&f.one(\"error\",function(){f.attr(\"src\",b.placeholder_real_img)}).attr(\"src\",b.placeholder_data_img),f.one(\"_lazyload_appear\",function(){function i(){d&&f.hide(),o?(n&&f.attr(\"srcset\",n),l&&f.attr(\"src\",l)):f.css(\"background-image\",'url(\"'+l+'\")'),d&&f[b.effect].apply(f,c?b.effect_params:[]),h=m(h)}var d,c=a.isArray(b.effect_params);f._lazyload_loadStarted||(d=\"show\"!=b.effect&&a.fn[b.effect]&&(!b.effect_params||c&&0==b.effect_params.length),b.appear!=g&&b.appear.call(e,f,h.length,b),f._lazyload_loadStarted=!0,b.no_fake_img_loader||n?(b.load!=g&&f.one(\"load\",function(){b.load.call(e,f,h.length,b)}),i()):a(\"<img />\").one(\"load\",function(){i(),b.load!=g&&b.load.call(e,f,h.length,b)}).attr(\"src\",l))}),j||f.on(b.event,function(){f._lazyload_loadStarted||f.trigger(\"_lazyload_appear\")}),void 0)}),j&&b._$container.on(b.event,function(){k(h,b)}),d.on(\"resize load\",function(){k(h,b)}),a(function(){k(h,b)}),this})});","source":"blog-photo/lazyload.min.js","raw":"/*!\n * An jQuery | zepto plugin for lazy loading images.\n * author -> jieyou\n * see https://github.com/jieyou/lazyload\n * use some tuupola's code https://github.com/tuupola/jquery_lazyload (BSD)\n * use component's throttle https://github.com/component/throttle (MIT)\n */\n!function(a){\"function\"==typeof define&&define.amd?define([\"jquery\"],a):a(window.jQuery||window.Zepto)}(function(a){function g(){}function h(a,b){var e;return e=b._$container==d?(\"innerHeight\"in c?c.innerHeight:d.height())+d.scrollTop():b._$container.offset().top+b._$container.height(),e<=a.offset().top-b.threshold}function i(b,e){var f;return f=e._$container==d?d.width()+(a.fn.scrollLeft?d.scrollLeft():c.pageXOffset):e._$container.offset().left+e._$container.width(),f<=b.offset().left-e.threshold}function j(a,b){var c;return c=b._$container==d?d.scrollTop():b._$container.offset().top,c>=a.offset().top+b.threshold+a.height()}function k(b,e){var f;return f=e._$container==d?a.fn.scrollLeft?d.scrollLeft():c.pageXOffset:e._$container.offset().left,f>=b.offset().left+e.threshold+b.width()}function l(a,b){var c=0;a.each(function(d){function g(){f.trigger(\"_lazyload_appear\"),c=0}var f=a.eq(d);if(!(f.width()<=0&&f.height()<=0||\"none\"===f.css(\"display\")))if(b.vertical_only)if(j(f,b));else if(h(f,b)){if(++c>b.failure_limit)return!1}else g();else if(j(f,b)||k(f,b));else if(h(f,b)||i(f,b)){if(++c>b.failure_limit)return!1}else g()})}function m(a){return a.filter(function(b){return!a.eq(b)._lazyload_loadStarted})}function n(a,b){function h(){f=0,g=+new Date,e=a.apply(c,d),c=null,d=null}var c,d,e,f,g=0;return function(){c=this,d=arguments;var a=new Date-g;return f||(a>=b?h():f=setTimeout(h,b-a)),e}}var f,c=window,d=a(c),e={threshold:0,failure_limit:0,event:\"scroll\",effect:\"show\",effect_params:null,container:c,data_attribute:\"original\",data_srcset_attribute:\"original-srcset\",skip_invisible:!0,appear:g,load:g,vertical_only:!1,check_appear_throttle_time:300,url_rewriter_fn:g,no_fake_img_loader:!1,placeholder_data_img:\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC\",placeholder_real_img:\"http://ditu.baidu.cn/yyfm/lazyload/0.0.1/img/placeholder.png\"};f=function(){var a=Object.prototype.toString;return function(b){return a.call(b).replace(\"[object \",\"\").replace(\"]\",\"\")}}(),a.fn.hasOwnProperty(\"lazyload\")||(a.fn.lazyload=function(b){var i,j,k,h=this;return a.isPlainObject(b)||(b={}),a.each(e,function(g,h){var i=f(b[g]);-1!=a.inArray(g,[\"threshold\",\"failure_limit\",\"check_appear_throttle_time\"])?\"String\"==i?b[g]=parseInt(b[g],10):\"Number\"!=i&&(b[g]=h):\"container\"==g?(b._$container=b.hasOwnProperty(g)?b[g]==c||b[g]==document?d:a(b[g]):d,delete b.container):!e.hasOwnProperty(g)||b.hasOwnProperty(g)&&i==f(e[g])||(b[g]=h)}),i=\"scroll\"==b.event,k=0==b.check_appear_throttle_time?l:n(l,b.check_appear_throttle_time),j=i||\"scrollstart\"==b.event||\"scrollstop\"==b.event,h.each(function(c){var e=this,f=h.eq(c),i=f.attr(\"src\"),k=f.attr(\"data-\"+b.data_attribute),l=b.url_rewriter_fn==g?k:b.url_rewriter_fn.call(e,f,k),n=f.attr(\"data-\"+b.data_srcset_attribute),o=f.is(\"img\");return 1==f._lazyload_loadStarted||i==l?(f._lazyload_loadStarted=!0,h=m(h),void 0):(f._lazyload_loadStarted=!1,o&&!i&&f.one(\"error\",function(){f.attr(\"src\",b.placeholder_real_img)}).attr(\"src\",b.placeholder_data_img),f.one(\"_lazyload_appear\",function(){function i(){d&&f.hide(),o?(n&&f.attr(\"srcset\",n),l&&f.attr(\"src\",l)):f.css(\"background-image\",'url(\"'+l+'\")'),d&&f[b.effect].apply(f,c?b.effect_params:[]),h=m(h)}var d,c=a.isArray(b.effect_params);f._lazyload_loadStarted||(d=\"show\"!=b.effect&&a.fn[b.effect]&&(!b.effect_params||c&&0==b.effect_params.length),b.appear!=g&&b.appear.call(e,f,h.length,b),f._lazyload_loadStarted=!0,b.no_fake_img_loader||n?(b.load!=g&&f.one(\"load\",function(){b.load.call(e,f,h.length,b)}),i()):a(\"<img />\").one(\"load\",function(){i(),b.load!=g&&b.load.call(e,f,h.length,b)}).attr(\"src\",l))}),j||f.on(b.event,function(){f._lazyload_loadStarted||f.trigger(\"_lazyload_appear\")}),void 0)}),j&&b._$container.on(b.event,function(){k(h,b)}),d.on(\"resize load\",function(){k(h,b)}),a(function(){k(h,b)}),this})});","date":"2021-03-28T10:52:14.223Z","updated":"2021-01-27T14:28:24.000Z","path":"blog-photo/lazyload.min.js","layout":"false","title":"","comments":1,"_id":"cl2enrqzg0008y2lo9kix362x","content":"/*!\n * An jQuery | zepto plugin for lazy loading images.\n * author -> jieyou\n * see https://github.com/jieyou/lazyload\n * use some tuupola's code https://github.com/tuupola/jquery_lazyload (BSD)\n * use component's throttle https://github.com/component/throttle (MIT)\n */\n!function(a){\"function\"==typeof define&&define.amd?define([\"jquery\"],a):a(window.jQuery||window.Zepto)}(function(a){function g(){}function h(a,b){var e;return e=b._$container==d?(\"innerHeight\"in c?c.innerHeight:d.height())+d.scrollTop():b._$container.offset().top+b._$container.height(),e<=a.offset().top-b.threshold}function i(b,e){var f;return f=\"e._$container==d?d.width()+(a.fn.scrollLeft?d.scrollLeft():c.pageXOffset):e._$container.offset().left+e._$container.width(),f<=b.offset().left-e.threshold}function\" j(a,b){var c;return c=\"b._$container==d?d.scrollTop():b._$container.offset().top,c\">=a.offset().top+b.threshold+a.height()}function k(b,e){var f;return f=e._$container==d?a.fn.scrollLeft?d.scrollLeft():c.pageXOffset:e._$container.offset().left,f>=b.offset().left+e.threshold+b.width()}function l(a,b){var c=0;a.each(function(d){function g(){f.trigger(\"_lazyload_appear\"),c=0}var f=a.eq(d);if(!(f.width()<=0&&f.height()<=0||\"none\"===f.css(\"display\")))if(b.vertical_only)if(j(f,b));else if(h(f,b)){if(++c>b.failure_limit)return!1}else g();else if(j(f,b)||k(f,b));else if(h(f,b)||i(f,b)){if(++c>b.failure_limit)return!1}else g()})}function m(a){return a.filter(function(b){return!a.eq(b)._lazyload_loadStarted})}function n(a,b){function h(){f=0,g=+new Date,e=a.apply(c,d),c=null,d=null}var c,d,e,f,g=0;return function(){c=this,d=arguments;var a=new Date-g;return f||(a>=b?h():f=setTimeout(h,b-a)),e}}var f,c=window,d=a(c),e={threshold:0,failure_limit:0,event:\"scroll\",effect:\"show\",effect_params:null,container:c,data_attribute:\"original\",data_srcset_attribute:\"original-srcset\",skip_invisible:!0,appear:g,load:g,vertical_only:!1,check_appear_throttle_time:300,url_rewriter_fn:g,no_fake_img_loader:!1,placeholder_data_img:\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC\",placeholder_real_img:\"http://ditu.baidu.cn/yyfm/lazyload/0.0.1/img/placeholder.png\"};f=function(){var a=Object.prototype.toString;return function(b){return a.call(b).replace(\"[object \",\"\").replace(\"]\",\"\")}}(),a.fn.hasOwnProperty(\"lazyload\")||(a.fn.lazyload=function(b){var i,j,k,h=this;return a.isPlainObject(b)||(b={}),a.each(e,function(g,h){var i=f(b[g]);-1!=a.inArray(g,[\"threshold\",\"failure_limit\",\"check_appear_throttle_time\"])?\"String\"==i?b[g]=parseInt(b[g],10):\"Number\"!=i&&(b[g]=h):\"container\"==g?(b._$container=b.hasOwnProperty(g)?b[g]==c||b[g]==document?d:a(b[g]):d,delete b.container):!e.hasOwnProperty(g)||b.hasOwnProperty(g)&&i==f(e[g])||(b[g]=h)}),i=\"scroll\"==b.event,k=0==b.check_appear_throttle_time?l:n(l,b.check_appear_throttle_time),j=i||\"scrollstart\"==b.event||\"scrollstop\"==b.event,h.each(function(c){var e=this,f=h.eq(c),i=f.attr(\"src\"),k=f.attr(\"data-\"+b.data_attribute),l=b.url_rewriter_fn==g?k:b.url_rewriter_fn.call(e,f,k),n=f.attr(\"data-\"+b.data_srcset_attribute),o=f.is(\"img\");return 1==f._lazyload_loadStarted||i==l?(f._lazyload_loadStarted=!0,h=m(h),void 0):(f._lazyload_loadStarted=!1,o&&!i&&f.one(\"error\",function(){f.attr(\"src\",b.placeholder_real_img)}).attr(\"src\",b.placeholder_data_img),f.one(\"_lazyload_appear\",function(){function i(){d&&f.hide(),o?(n&&f.attr(\"srcset\",n),l&&f.attr(\"src\",l)):f.css(\"background-image\",'url(\"'+l+'\")'),d&&f[b.effect].apply(f,c?b.effect_params:[]),h=m(h)}var d,c=a.isArray(b.effect_params);f._lazyload_loadStarted||(d=\"show\"!=b.effect&&a.fn[b.effect]&&(!b.effect_params||c&&0==b.effect_params.length),b.appear!=g&&b.appear.call(e,f,h.length,b),f._lazyload_loadStarted=!0,b.no_fake_img_loader||n?(b.load!=g&&f.one(\"load\",function(){b.load.call(e,f,h.length,b)}),i()):a(\"<img>\").one(\"load\",function(){i(),b.load!=g&&b.load.call(e,f,h.length,b)}).attr(\"src\",l))}),j||f.on(b.event,function(){f._lazyload_loadStarted||f.trigger(\"_lazyload_appear\")}),void 0)}),j&&b._$container.on(b.event,function(){k(h,b)}),d.on(\"resize load\",function(){k(h,b)}),a(function(){k(h,b)}),this})});</=0&&f.height()<=0||\"none\"===f.css(\"display\")))if(b.vertical_only)if(j(f,b));else></=a.offset().top-b.threshold}function>","site":{"data":{"photography":[{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","title":"玉渊潭","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","title":"花儿","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","title":"白塔寺","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"}]}},"excerpt":"","more":"/*!\n * An jQuery | zepto plugin for lazy loading images.\n * author -> jieyou\n * see https://github.com/jieyou/lazyload\n * use some tuupola's code https://github.com/tuupola/jquery_lazyload (BSD)\n * use component's throttle https://github.com/component/throttle (MIT)\n */\n!function(a){\"function\"==typeof define&&define.amd?define([\"jquery\"],a):a(window.jQuery||window.Zepto)}(function(a){function g(){}function h(a,b){var e;return e=b._$container==d?(\"innerHeight\"in c?c.innerHeight:d.height())+d.scrollTop():b._$container.offset().top+b._$container.height(),e<=a.offset().top-b.threshold}function i(b,e){var f;return f=\"e._$container==d?d.width()+(a.fn.scrollLeft?d.scrollLeft():c.pageXOffset):e._$container.offset().left+e._$container.width(),f<=b.offset().left-e.threshold}function\" j(a,b){var c;return c=\"b._$container==d?d.scrollTop():b._$container.offset().top,c\">=a.offset().top+b.threshold+a.height()}function k(b,e){var f;return f=e._$container==d?a.fn.scrollLeft?d.scrollLeft():c.pageXOffset:e._$container.offset().left,f>=b.offset().left+e.threshold+b.width()}function l(a,b){var c=0;a.each(function(d){function g(){f.trigger(\"_lazyload_appear\"),c=0}var f=a.eq(d);if(!(f.width()<=0&&f.height()<=0||\"none\"===f.css(\"display\")))if(b.vertical_only)if(j(f,b));else if(h(f,b)){if(++c>b.failure_limit)return!1}else g();else if(j(f,b)||k(f,b));else if(h(f,b)||i(f,b)){if(++c>b.failure_limit)return!1}else g()})}function m(a){return a.filter(function(b){return!a.eq(b)._lazyload_loadStarted})}function n(a,b){function h(){f=0,g=+new Date,e=a.apply(c,d),c=null,d=null}var c,d,e,f,g=0;return function(){c=this,d=arguments;var a=new Date-g;return f||(a>=b?h():f=setTimeout(h,b-a)),e}}var f,c=window,d=a(c),e={threshold:0,failure_limit:0,event:\"scroll\",effect:\"show\",effect_params:null,container:c,data_attribute:\"original\",data_srcset_attribute:\"original-srcset\",skip_invisible:!0,appear:g,load:g,vertical_only:!1,check_appear_throttle_time:300,url_rewriter_fn:g,no_fake_img_loader:!1,placeholder_data_img:\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC\",placeholder_real_img:\"http://ditu.baidu.cn/yyfm/lazyload/0.0.1/img/placeholder.png\"};f=function(){var a=Object.prototype.toString;return function(b){return a.call(b).replace(\"[object \",\"\").replace(\"]\",\"\")}}(),a.fn.hasOwnProperty(\"lazyload\")||(a.fn.lazyload=function(b){var i,j,k,h=this;return a.isPlainObject(b)||(b={}),a.each(e,function(g,h){var i=f(b[g]);-1!=a.inArray(g,[\"threshold\",\"failure_limit\",\"check_appear_throttle_time\"])?\"String\"==i?b[g]=parseInt(b[g],10):\"Number\"!=i&&(b[g]=h):\"container\"==g?(b._$container=b.hasOwnProperty(g)?b[g]==c||b[g]==document?d:a(b[g]):d,delete b.container):!e.hasOwnProperty(g)||b.hasOwnProperty(g)&&i==f(e[g])||(b[g]=h)}),i=\"scroll\"==b.event,k=0==b.check_appear_throttle_time?l:n(l,b.check_appear_throttle_time),j=i||\"scrollstart\"==b.event||\"scrollstop\"==b.event,h.each(function(c){var e=this,f=h.eq(c),i=f.attr(\"src\"),k=f.attr(\"data-\"+b.data_attribute),l=b.url_rewriter_fn==g?k:b.url_rewriter_fn.call(e,f,k),n=f.attr(\"data-\"+b.data_srcset_attribute),o=f.is(\"img\");return 1==f._lazyload_loadStarted||i==l?(f._lazyload_loadStarted=!0,h=m(h),void 0):(f._lazyload_loadStarted=!1,o&&!i&&f.one(\"error\",function(){f.attr(\"src\",b.placeholder_real_img)}).attr(\"src\",b.placeholder_data_img),f.one(\"_lazyload_appear\",function(){function i(){d&&f.hide(),o?(n&&f.attr(\"srcset\",n),l&&f.attr(\"src\",l)):f.css(\"background-image\",'url(\"'+l+'\")'),d&&f[b.effect].apply(f,c?b.effect_params:[]),h=m(h)}var d,c=a.isArray(b.effect_params);f._lazyload_loadStarted||(d=\"show\"!=b.effect&&a.fn[b.effect]&&(!b.effect_params||c&&0==b.effect_params.length),b.appear!=g&&b.appear.call(e,f,h.length,b),f._lazyload_loadStarted=!0,b.no_fake_img_loader||n?(b.load!=g&&f.one(\"load\",function(){b.load.call(e,f,h.length,b)}),i()):a(\"<img>\").one(\"load\",function(){i(),b.load!=g&&b.load.call(e,f,h.length,b)}).attr(\"src\",l))}),j||f.on(b.event,function(){f._lazyload_loadStarted||f.trigger(\"_lazyload_appear\")}),void 0)}),j&&b._$container.on(b.event,function(){k(h,b)}),d.on(\"resize load\",function(){k(h,b)}),a(function(){k(h,b)}),this})});</=0&&f.height()<=0||\"none\"===f.css(\"display\")))if(b.vertical_only)if(j(f,b));else></=a.offset().top-b.threshold}function>"},{"title":"我的摄影","layout":"photography","sidebar":false,"_content":"","source":"photography/index.md","raw":"---\ntitle: 我的摄影\nlayout: photography\nsidebar: false\n---\n","date":"2022-04-25T11:42:56.744Z","updated":"2022-04-25T11:42:56.744Z","path":"photography/index.html","comments":1,"_id":"cl2enrqzh000ay2loaz5gds8n","content":"","site":{"data":{"photography":[{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","title":"玉渊潭","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","title":"花儿","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","title":"白塔寺","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"}]}},"excerpt":"","more":""},{"title":"GANS介绍","date":"2020-12-27T16:00:00.000Z","tags":["机器学习"],"categories":["强化学习"],"_content":"\n### 1.结构\n\n<div align=center><img src=\"1610005130361-d3374c7e-7456-4bba-b3a7-b7eb49fb6974-20210128162026163.png\" width=\"60%\" height=\"50%\"></div>\n\n\n- **生成器**\n\n这里的生成器可以是任意可以输出图片的模型，比如最简单的全连接神经网络又或者是反卷积网络。\n生成器输入的变量可以是用随机生成的变量作为输入即可，随机输入最好满足一个常见的分布，比如高斯分布 **\n<!--more-->\n\n- **判别器2**\n\n任何的判别器类型，输入为图片，输出为图片的真伪标签**\n\n- **博弈**\n\n生成网络G的目标就是尽量生成真实的图片去欺骗判别网络D。而D的目标就是尽量把G生成的图片和真实的图片分别开来。\n\n\n### 2.优化目标\n判别器：让判别器分类真假样本的概率达到五五开，让概率-样本分布图达到一条1/2的直线\n生成器：让生成器尽可能地减少生成样本与真实样本之间的差距，体现在生成样本的分布接近于真实样本的分布，让生成样本的分布曲线接近于真实样本的分布曲线\n\n<div align=center><img src=\"1609914460948-9656b2ad-bae1-4804-8cca-cd6e26bbdf49.png\" width=\"60%\" height=\"50%\"></div>\n\n### 3.训练过程：\n\n- 初始化判别器D的参数 ![](https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442539-285ae8fd-ff52-4b81-9700-ef05cb6e80c3.svg#align=left&display=inline&height=20&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=17&size=0&status=done&style=none&width=17) 和生成器G的参数 ![](https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442536-5c3593f4-34c4-4d7b-8fd2-b2bce1f6e908.svg#align=left&display=inline&height=23&margin=%5Bobject%20Object%5D&originHeight=23&originWidth=17&size=0&status=done&style=none&width=17) 。\n- 从真实样本中采样 ![](https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442546-2805568b-9816-4767-8f7c-730c37c3c246.svg#align=left&display=inline&height=13&margin=%5Bobject%20Object%5D&originHeight=13&originWidth=16&size=0&status=done&style=none&width=16) 个样本 { ![](https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442617-e6fff283-b450-45be-8a93-fc8907d11b81.svg#align=left&display=inline&height=24&margin=%5Bobject%20Object%5D&originHeight=24&originWidth=104&size=0&status=done&style=none&width=104) } ，从先验分布噪声中采样 ![](https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442556-c55a146a-8e8b-4932-b9c8-ac9e61fad9f5.svg#align=left&display=inline&height=13&margin=%5Bobject%20Object%5D&originHeight=13&originWidth=16&size=0&status=done&style=none&width=16) 个噪声样本 { ![](https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442556-e8fd7383-c80f-4919-8078-b0d358b6e283.svg#align=left&display=inline&height=24&margin=%5Bobject%20Object%5D&originHeight=24&originWidth=106&size=0&status=done&style=none&width=106) } 并通过生成器获取 ![](https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442621-30bfec79-28d2-4afa-af1e-c275d87968ad.svg#align=left&display=inline&height=13&margin=%5Bobject%20Object%5D&originHeight=13&originWidth=16&size=0&status=done&style=none&width=16) 个生成样本 { ![](https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442561-7ef7f2bb-7710-4814-904c-1973513e864e.svg#align=left&display=inline&height=24&margin=%5Bobject%20Object%5D&originHeight=24&originWidth=112&size=0&status=done&style=none&width=112) } 。固定生成器G，训练判别器D尽可能好地准确判别真实样本和生成样本，尽可能大地区分正确样本和生成的样本。\n- **循环k次更新判别器之后，使用较小的学习率来更新一次生成器的参数**，训练生成器使其尽可能能够减小生成样本与真实样本之间的差距，也相当于尽量使得判别器判别错误。\n- 多次更新迭代之后，最终理想情况是使得判别器判别不出样本来自于生成器的输出还是真实的输出。亦即最终样本判别概率均为0.5。\n\n\n\n\n\n### 4.损失函数\n判别器使用交叉熵计算损失，其中pi表示真实分布，qi表示生成样本的分布\n\n<div align=center><img src=\"1609914799643-975cc081-1fb5-4085-9a17-fae9d0e9b590.png\" width=\"60%\" height=\"50%\"></div>\n\n因为这里是二元分类问题，判别样本真假\n\n<div align=center><img src=\"1609914908755-33c89db7-e274-44d8-bf78-d58802988970.png\" width=\"60%\" height=\"50%\"></div>\n\n其中，假定 ![](https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914940477-5d124bef-cb15-4dfe-9278-6c25429b8d04.svg#align=left&display=inline&height=16&margin=%5Bobject%20Object%5D&originHeight=16&originWidth=18&size=0&status=done&style=none&width=18) 为正确样本分布，那么对应的（ ![](https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914940457-c25d5d10-abf7-492a-8570-c5cdcb31ea2a.svg#align=left&display=inline&height=20&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=50&size=0&status=done&style=none&width=50) ）就是生成样本的分布。 ![](https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914940512-461170ea-7944-4535-86a2-f55444e71dd1.svg#align=left&display=inline&height=17&margin=%5Bobject%20Object%5D&originHeight=17&originWidth=15&size=0&status=done&style=none&width=15) 表示判别器，则 ![](https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914940459-549fd31b-9254-4dcd-b0c2-4a9ac75b6e50.svg#align=left&display=inline&height=23&margin=%5Bobject%20Object%5D&originHeight=23&originWidth=49&size=0&status=done&style=none&width=49) 表示判别样本为正确的概率， ![](https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914940600-fb5fafc4-0798-4d44-a981-81f2ca073bdd.svg#align=left&display=inline&height=27&margin=%5Bobject%20Object%5D&originHeight=27&originWidth=110&size=0&status=done&style=none&width=110) 则对应着判别为错误样本的概率，GAN对交叉熵的改进在于，为了让生成器以假乱真，判别器输出的概率稳定在0.5，0.5，故对上边的yi取1/2\n\n<div align=center><img src=\"1609983349967-7087eb25-37b6-4bd8-90eb-09dc4953bba8.png\" width=\"60%\" height=\"50%\"></div>\n\n### 5.损失函数意义\nD(y)表示判别器判别一个样本为真实的概率，其中x是真实样本，G(z)表示生成器经过随机噪声z产生的假样本被判别器判别为真的概率，所以前半部分就是判别器判别真实样本为真的概率期望，后半部分是判别器判别假样本为假的概率期望，为了让判别器判别更加准确，首先是max，尽可能让判别器判别准确，再为了让生成器可以以假乱真，D的能力越强，D(x)应该越大，D(G(x))应该越小。这时V(D,G)会变大。因此式子对于D来说是求最大(内层取max），而生成器G希望目的就是让判别器判别出现更多的失误，D(G(z))尽可能得大，这时V(D, G)会变小，也就是最外边的min\n\n\n\n### 6.算法\n\n<div align=center><img src=\"1609987534946-5568cebc-0d23-4bc7-a175-73a5872b732e.png\" width=\"60%\" height=\"50%\"></div>\n\n\n\n\n### 7.与强化学习的区别\n强化学习是一方为智能体，一方为环境（环境相对不变），让智能体不断的进化，智能体不断与环境交互，先根据模型输出action后，再根据环境给予的奖励来调整模型。\n而GAN是在强化学习上的演变。GAN则是相当于两个environment，判别器目的是让自己判别尽可能的准确（即让自己极可能识别出更多的假样本），体现在损失函数中是体现在max(D,G)是固定生成器G，使得判别真假样本概率极可能地准确，其在做出action（判断输入样本真假概率），才能根据真假样本标签给予的奖励来调整自己的模型（对于生成器：判断正确是正奖励，判断失误是负奖励）；生成器则是做出action后（生成样本），再根据判别器判断失误奖励（对于判别器：判断失误是正奖励，判断正确是负奖励）来提高自己；判别器D试图使得D(G(z))概率接近于0，生成器试图使得D(G(z))概率为1\n\n\n\n\n\n\n","source":"temp/GANs.md","raw":"---\ntitle: GANS介绍\ndate: 2020-12-28\ntags: \n\t- 机器学习\ncategories:\n\t- 强化学习\n---\n\n### 1.结构\n\n<div align=center><img src=\"1610005130361-d3374c7e-7456-4bba-b3a7-b7eb49fb6974-20210128162026163.png\" width=\"60%\" height=\"50%\"></div>\n\n\n- **生成器**\n\n这里的生成器可以是任意可以输出图片的模型，比如最简单的全连接神经网络又或者是反卷积网络。\n生成器输入的变量可以是用随机生成的变量作为输入即可，随机输入最好满足一个常见的分布，比如高斯分布 **\n<!--more-->\n\n- **判别器2**\n\n任何的判别器类型，输入为图片，输出为图片的真伪标签**\n\n- **博弈**\n\n生成网络G的目标就是尽量生成真实的图片去欺骗判别网络D。而D的目标就是尽量把G生成的图片和真实的图片分别开来。\n\n\n### 2.优化目标\n判别器：让判别器分类真假样本的概率达到五五开，让概率-样本分布图达到一条1/2的直线\n生成器：让生成器尽可能地减少生成样本与真实样本之间的差距，体现在生成样本的分布接近于真实样本的分布，让生成样本的分布曲线接近于真实样本的分布曲线\n\n<div align=center><img src=\"1609914460948-9656b2ad-bae1-4804-8cca-cd6e26bbdf49.png\" width=\"60%\" height=\"50%\"></div>\n\n### 3.训练过程：\n\n- 初始化判别器D的参数 ![](https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442539-285ae8fd-ff52-4b81-9700-ef05cb6e80c3.svg#align=left&display=inline&height=20&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=17&size=0&status=done&style=none&width=17) 和生成器G的参数 ![](https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442536-5c3593f4-34c4-4d7b-8fd2-b2bce1f6e908.svg#align=left&display=inline&height=23&margin=%5Bobject%20Object%5D&originHeight=23&originWidth=17&size=0&status=done&style=none&width=17) 。\n- 从真实样本中采样 ![](https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442546-2805568b-9816-4767-8f7c-730c37c3c246.svg#align=left&display=inline&height=13&margin=%5Bobject%20Object%5D&originHeight=13&originWidth=16&size=0&status=done&style=none&width=16) 个样本 { ![](https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442617-e6fff283-b450-45be-8a93-fc8907d11b81.svg#align=left&display=inline&height=24&margin=%5Bobject%20Object%5D&originHeight=24&originWidth=104&size=0&status=done&style=none&width=104) } ，从先验分布噪声中采样 ![](https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442556-c55a146a-8e8b-4932-b9c8-ac9e61fad9f5.svg#align=left&display=inline&height=13&margin=%5Bobject%20Object%5D&originHeight=13&originWidth=16&size=0&status=done&style=none&width=16) 个噪声样本 { ![](https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442556-e8fd7383-c80f-4919-8078-b0d358b6e283.svg#align=left&display=inline&height=24&margin=%5Bobject%20Object%5D&originHeight=24&originWidth=106&size=0&status=done&style=none&width=106) } 并通过生成器获取 ![](https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442621-30bfec79-28d2-4afa-af1e-c275d87968ad.svg#align=left&display=inline&height=13&margin=%5Bobject%20Object%5D&originHeight=13&originWidth=16&size=0&status=done&style=none&width=16) 个生成样本 { ![](https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442561-7ef7f2bb-7710-4814-904c-1973513e864e.svg#align=left&display=inline&height=24&margin=%5Bobject%20Object%5D&originHeight=24&originWidth=112&size=0&status=done&style=none&width=112) } 。固定生成器G，训练判别器D尽可能好地准确判别真实样本和生成样本，尽可能大地区分正确样本和生成的样本。\n- **循环k次更新判别器之后，使用较小的学习率来更新一次生成器的参数**，训练生成器使其尽可能能够减小生成样本与真实样本之间的差距，也相当于尽量使得判别器判别错误。\n- 多次更新迭代之后，最终理想情况是使得判别器判别不出样本来自于生成器的输出还是真实的输出。亦即最终样本判别概率均为0.5。\n\n\n\n\n\n### 4.损失函数\n判别器使用交叉熵计算损失，其中pi表示真实分布，qi表示生成样本的分布\n\n<div align=center><img src=\"1609914799643-975cc081-1fb5-4085-9a17-fae9d0e9b590.png\" width=\"60%\" height=\"50%\"></div>\n\n因为这里是二元分类问题，判别样本真假\n\n<div align=center><img src=\"1609914908755-33c89db7-e274-44d8-bf78-d58802988970.png\" width=\"60%\" height=\"50%\"></div>\n\n其中，假定 ![](https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914940477-5d124bef-cb15-4dfe-9278-6c25429b8d04.svg#align=left&display=inline&height=16&margin=%5Bobject%20Object%5D&originHeight=16&originWidth=18&size=0&status=done&style=none&width=18) 为正确样本分布，那么对应的（ ![](https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914940457-c25d5d10-abf7-492a-8570-c5cdcb31ea2a.svg#align=left&display=inline&height=20&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=50&size=0&status=done&style=none&width=50) ）就是生成样本的分布。 ![](https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914940512-461170ea-7944-4535-86a2-f55444e71dd1.svg#align=left&display=inline&height=17&margin=%5Bobject%20Object%5D&originHeight=17&originWidth=15&size=0&status=done&style=none&width=15) 表示判别器，则 ![](https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914940459-549fd31b-9254-4dcd-b0c2-4a9ac75b6e50.svg#align=left&display=inline&height=23&margin=%5Bobject%20Object%5D&originHeight=23&originWidth=49&size=0&status=done&style=none&width=49) 表示判别样本为正确的概率， ![](https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914940600-fb5fafc4-0798-4d44-a981-81f2ca073bdd.svg#align=left&display=inline&height=27&margin=%5Bobject%20Object%5D&originHeight=27&originWidth=110&size=0&status=done&style=none&width=110) 则对应着判别为错误样本的概率，GAN对交叉熵的改进在于，为了让生成器以假乱真，判别器输出的概率稳定在0.5，0.5，故对上边的yi取1/2\n\n<div align=center><img src=\"1609983349967-7087eb25-37b6-4bd8-90eb-09dc4953bba8.png\" width=\"60%\" height=\"50%\"></div>\n\n### 5.损失函数意义\nD(y)表示判别器判别一个样本为真实的概率，其中x是真实样本，G(z)表示生成器经过随机噪声z产生的假样本被判别器判别为真的概率，所以前半部分就是判别器判别真实样本为真的概率期望，后半部分是判别器判别假样本为假的概率期望，为了让判别器判别更加准确，首先是max，尽可能让判别器判别准确，再为了让生成器可以以假乱真，D的能力越强，D(x)应该越大，D(G(x))应该越小。这时V(D,G)会变大。因此式子对于D来说是求最大(内层取max），而生成器G希望目的就是让判别器判别出现更多的失误，D(G(z))尽可能得大，这时V(D, G)会变小，也就是最外边的min\n\n\n\n### 6.算法\n\n<div align=center><img src=\"1609987534946-5568cebc-0d23-4bc7-a175-73a5872b732e.png\" width=\"60%\" height=\"50%\"></div>\n\n\n\n\n### 7.与强化学习的区别\n强化学习是一方为智能体，一方为环境（环境相对不变），让智能体不断的进化，智能体不断与环境交互，先根据模型输出action后，再根据环境给予的奖励来调整模型。\n而GAN是在强化学习上的演变。GAN则是相当于两个environment，判别器目的是让自己判别尽可能的准确（即让自己极可能识别出更多的假样本），体现在损失函数中是体现在max(D,G)是固定生成器G，使得判别真假样本概率极可能地准确，其在做出action（判断输入样本真假概率），才能根据真假样本标签给予的奖励来调整自己的模型（对于生成器：判断正确是正奖励，判断失误是负奖励）；生成器则是做出action后（生成样本），再根据判别器判断失误奖励（对于判别器：判断失误是正奖励，判断正确是负奖励）来提高自己；判别器D试图使得D(G(z))概率接近于0，生成器试图使得D(G(z))概率为1\n\n\n\n\n\n\n","updated":"2021-01-28T08:33:59.082Z","path":"temp/GANs.html","comments":1,"layout":"page","_id":"cl2enrqzi000fy2lof6axamg3","content":"<h3 id=\"1-结构\"><a href=\"#1-结构\" class=\"headerlink\" title=\"1.结构\"></a>1.结构</h3><div align=\"center\"><img src=\"/temp/GANs.htm/1610005130361-d3374c7e-7456-4bba-b3a7-b7eb49fb6974-20210128162026163.png\" width=\"60%\" height=\"50%\"></div>\n\n\n<ul>\n<li><strong>生成器</strong></li>\n</ul>\n<p>这里的生成器可以是任意可以输出图片的模型，比如最简单的全连接神经网络又或者是反卷积网络。<br>生成器输入的变量可以是用随机生成的变量作为输入即可，随机输入最好满足一个常见的分布，比如高斯分布 **</p>\n<a id=\"more\"></a>\n\n<ul>\n<li><strong>判别器2</strong></li>\n</ul>\n<p>任何的判别器类型，输入为图片，输出为图片的真伪标签**</p>\n<ul>\n<li><strong>博弈</strong></li>\n</ul>\n<p>生成网络G的目标就是尽量生成真实的图片去欺骗判别网络D。而D的目标就是尽量把G生成的图片和真实的图片分别开来。</p>\n<h3 id=\"2-优化目标\"><a href=\"#2-优化目标\" class=\"headerlink\" title=\"2.优化目标\"></a>2.优化目标</h3><p>判别器：让判别器分类真假样本的概率达到五五开，让概率-样本分布图达到一条1/2的直线<br>生成器：让生成器尽可能地减少生成样本与真实样本之间的差距，体现在生成样本的分布接近于真实样本的分布，让生成样本的分布曲线接近于真实样本的分布曲线</p>\n<div align=\"center\"><img src=\"/temp/GANs.htm/1609914460948-9656b2ad-bae1-4804-8cca-cd6e26bbdf49.png\" width=\"60%\" height=\"50%\"></div>\n\n<h3 id=\"3-训练过程：\"><a href=\"#3-训练过程：\" class=\"headerlink\" title=\"3.训练过程：\"></a>3.训练过程：</h3><ul>\n<li>初始化判别器D的参数 <img src=\"https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442539-285ae8fd-ff52-4b81-9700-ef05cb6e80c3.svg#align=left&display=inline&height=20&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=17&size=0&status=done&style=none&width=17\"> 和生成器G的参数 <img src=\"https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442536-5c3593f4-34c4-4d7b-8fd2-b2bce1f6e908.svg#align=left&display=inline&height=23&margin=%5Bobject%20Object%5D&originHeight=23&originWidth=17&size=0&status=done&style=none&width=17\"> 。</li>\n<li>从真实样本中采样 <img src=\"https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442546-2805568b-9816-4767-8f7c-730c37c3c246.svg#align=left&display=inline&height=13&margin=%5Bobject%20Object%5D&originHeight=13&originWidth=16&size=0&status=done&style=none&width=16\"> 个样本 { <img src=\"https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442617-e6fff283-b450-45be-8a93-fc8907d11b81.svg#align=left&display=inline&height=24&margin=%5Bobject%20Object%5D&originHeight=24&originWidth=104&size=0&status=done&style=none&width=104\"> } ，从先验分布噪声中采样 <img src=\"https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442556-c55a146a-8e8b-4932-b9c8-ac9e61fad9f5.svg#align=left&display=inline&height=13&margin=%5Bobject%20Object%5D&originHeight=13&originWidth=16&size=0&status=done&style=none&width=16\"> 个噪声样本 { <img src=\"https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442556-e8fd7383-c80f-4919-8078-b0d358b6e283.svg#align=left&display=inline&height=24&margin=%5Bobject%20Object%5D&originHeight=24&originWidth=106&size=0&status=done&style=none&width=106\"> } 并通过生成器获取 <img src=\"https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442621-30bfec79-28d2-4afa-af1e-c275d87968ad.svg#align=left&display=inline&height=13&margin=%5Bobject%20Object%5D&originHeight=13&originWidth=16&size=0&status=done&style=none&width=16\"> 个生成样本 { <img src=\"https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442561-7ef7f2bb-7710-4814-904c-1973513e864e.svg#align=left&display=inline&height=24&margin=%5Bobject%20Object%5D&originHeight=24&originWidth=112&size=0&status=done&style=none&width=112\"> } 。固定生成器G，训练判别器D尽可能好地准确判别真实样本和生成样本，尽可能大地区分正确样本和生成的样本。</li>\n<li><strong>循环k次更新判别器之后，使用较小的学习率来更新一次生成器的参数</strong>，训练生成器使其尽可能能够减小生成样本与真实样本之间的差距，也相当于尽量使得判别器判别错误。</li>\n<li>多次更新迭代之后，最终理想情况是使得判别器判别不出样本来自于生成器的输出还是真实的输出。亦即最终样本判别概率均为0.5。</li>\n</ul>\n<h3 id=\"4-损失函数\"><a href=\"#4-损失函数\" class=\"headerlink\" title=\"4.损失函数\"></a>4.损失函数</h3><p>判别器使用交叉熵计算损失，其中pi表示真实分布，qi表示生成样本的分布</p>\n<div align=\"center\"><img src=\"/temp/GANs.htm/1609914799643-975cc081-1fb5-4085-9a17-fae9d0e9b590.png\" width=\"60%\" height=\"50%\"></div>\n\n<p>因为这里是二元分类问题，判别样本真假</p>\n<div align=\"center\"><img src=\"/temp/GANs.htm/1609914908755-33c89db7-e274-44d8-bf78-d58802988970.png\" width=\"60%\" height=\"50%\"></div>\n\n<p>其中，假定 <img src=\"https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914940477-5d124bef-cb15-4dfe-9278-6c25429b8d04.svg#align=left&display=inline&height=16&margin=%5Bobject%20Object%5D&originHeight=16&originWidth=18&size=0&status=done&style=none&width=18\"> 为正确样本分布，那么对应的（ <img src=\"https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914940457-c25d5d10-abf7-492a-8570-c5cdcb31ea2a.svg#align=left&display=inline&height=20&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=50&size=0&status=done&style=none&width=50\"> ）就是生成样本的分布。 <img src=\"https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914940512-461170ea-7944-4535-86a2-f55444e71dd1.svg#align=left&display=inline&height=17&margin=%5Bobject%20Object%5D&originHeight=17&originWidth=15&size=0&status=done&style=none&width=15\"> 表示判别器，则 <img src=\"https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914940459-549fd31b-9254-4dcd-b0c2-4a9ac75b6e50.svg#align=left&display=inline&height=23&margin=%5Bobject%20Object%5D&originHeight=23&originWidth=49&size=0&status=done&style=none&width=49\"> 表示判别样本为正确的概率， <img src=\"https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914940600-fb5fafc4-0798-4d44-a981-81f2ca073bdd.svg#align=left&display=inline&height=27&margin=%5Bobject%20Object%5D&originHeight=27&originWidth=110&size=0&status=done&style=none&width=110\"> 则对应着判别为错误样本的概率，GAN对交叉熵的改进在于，为了让生成器以假乱真，判别器输出的概率稳定在0.5，0.5，故对上边的yi取1/2</p>\n<div align=\"center\"><img src=\"/temp/GANs.htm/1609983349967-7087eb25-37b6-4bd8-90eb-09dc4953bba8.png\" width=\"60%\" height=\"50%\"></div>\n\n<h3 id=\"5-损失函数意义\"><a href=\"#5-损失函数意义\" class=\"headerlink\" title=\"5.损失函数意义\"></a>5.损失函数意义</h3><p>D(y)表示判别器判别一个样本为真实的概率，其中x是真实样本，G(z)表示生成器经过随机噪声z产生的假样本被判别器判别为真的概率，所以前半部分就是判别器判别真实样本为真的概率期望，后半部分是判别器判别假样本为假的概率期望，为了让判别器判别更加准确，首先是max，尽可能让判别器判别准确，再为了让生成器可以以假乱真，D的能力越强，D(x)应该越大，D(G(x))应该越小。这时V(D,G)会变大。因此式子对于D来说是求最大(内层取max），而生成器G希望目的就是让判别器判别出现更多的失误，D(G(z))尽可能得大，这时V(D, G)会变小，也就是最外边的min</p>\n<h3 id=\"6-算法\"><a href=\"#6-算法\" class=\"headerlink\" title=\"6.算法\"></a>6.算法</h3><div align=\"center\"><img src=\"/temp/GANs.htm/1609987534946-5568cebc-0d23-4bc7-a175-73a5872b732e.png\" width=\"60%\" height=\"50%\"></div>\n\n\n\n\n<h3 id=\"7-与强化学习的区别\"><a href=\"#7-与强化学习的区别\" class=\"headerlink\" title=\"7.与强化学习的区别\"></a>7.与强化学习的区别</h3><p>强化学习是一方为智能体，一方为环境（环境相对不变），让智能体不断的进化，智能体不断与环境交互，先根据模型输出action后，再根据环境给予的奖励来调整模型。<br>而GAN是在强化学习上的演变。GAN则是相当于两个environment，判别器目的是让自己判别尽可能的准确（即让自己极可能识别出更多的假样本），体现在损失函数中是体现在max(D,G)是固定生成器G，使得判别真假样本概率极可能地准确，其在做出action（判断输入样本真假概率），才能根据真假样本标签给予的奖励来调整自己的模型（对于生成器：判断正确是正奖励，判断失误是负奖励）；生成器则是做出action后（生成样本），再根据判别器判断失误奖励（对于判别器：判断失误是正奖励，判断正确是负奖励）来提高自己；判别器D试图使得D(G(z))概率接近于0，生成器试图使得D(G(z))概率为1</p>\n","site":{"data":{"photography":[{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","title":"玉渊潭","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","title":"花儿","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","title":"白塔寺","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"}]}},"excerpt":"<h3 id=\"1-结构\"><a href=\"#1-结构\" class=\"headerlink\" title=\"1.结构\"></a>1.结构</h3><div align=\"center\"><img src=\"/temp/GANs.htm/1610005130361-d3374c7e-7456-4bba-b3a7-b7eb49fb6974-20210128162026163.png\" width=\"60%\" height=\"50%\"></div>\n\n\n<ul>\n<li><strong>生成器</strong></li>\n</ul>\n<p>这里的生成器可以是任意可以输出图片的模型，比如最简单的全连接神经网络又或者是反卷积网络。<br>生成器输入的变量可以是用随机生成的变量作为输入即可，随机输入最好满足一个常见的分布，比如高斯分布 **</p>","more":"<ul>\n<li><strong>判别器2</strong></li>\n</ul>\n<p>任何的判别器类型，输入为图片，输出为图片的真伪标签**</p>\n<ul>\n<li><strong>博弈</strong></li>\n</ul>\n<p>生成网络G的目标就是尽量生成真实的图片去欺骗判别网络D。而D的目标就是尽量把G生成的图片和真实的图片分别开来。</p>\n<h3 id=\"2-优化目标\"><a href=\"#2-优化目标\" class=\"headerlink\" title=\"2.优化目标\"></a>2.优化目标</h3><p>判别器：让判别器分类真假样本的概率达到五五开，让概率-样本分布图达到一条1/2的直线<br>生成器：让生成器尽可能地减少生成样本与真实样本之间的差距，体现在生成样本的分布接近于真实样本的分布，让生成样本的分布曲线接近于真实样本的分布曲线</p>\n<div align=\"center\"><img src=\"/temp/GANs.htm/1609914460948-9656b2ad-bae1-4804-8cca-cd6e26bbdf49.png\" width=\"60%\" height=\"50%\"></div>\n\n<h3 id=\"3-训练过程：\"><a href=\"#3-训练过程：\" class=\"headerlink\" title=\"3.训练过程：\"></a>3.训练过程：</h3><ul>\n<li>初始化判别器D的参数 <img src=\"https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442539-285ae8fd-ff52-4b81-9700-ef05cb6e80c3.svg#align=left&display=inline&height=20&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=17&size=0&status=done&style=none&width=17\"> 和生成器G的参数 <img src=\"https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442536-5c3593f4-34c4-4d7b-8fd2-b2bce1f6e908.svg#align=left&display=inline&height=23&margin=%5Bobject%20Object%5D&originHeight=23&originWidth=17&size=0&status=done&style=none&width=17\"> 。</li>\n<li>从真实样本中采样 <img src=\"https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442546-2805568b-9816-4767-8f7c-730c37c3c246.svg#align=left&display=inline&height=13&margin=%5Bobject%20Object%5D&originHeight=13&originWidth=16&size=0&status=done&style=none&width=16\"> 个样本 { <img src=\"https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442617-e6fff283-b450-45be-8a93-fc8907d11b81.svg#align=left&display=inline&height=24&margin=%5Bobject%20Object%5D&originHeight=24&originWidth=104&size=0&status=done&style=none&width=104\"> } ，从先验分布噪声中采样 <img src=\"https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442556-c55a146a-8e8b-4932-b9c8-ac9e61fad9f5.svg#align=left&display=inline&height=13&margin=%5Bobject%20Object%5D&originHeight=13&originWidth=16&size=0&status=done&style=none&width=16\"> 个噪声样本 { <img src=\"https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442556-e8fd7383-c80f-4919-8078-b0d358b6e283.svg#align=left&display=inline&height=24&margin=%5Bobject%20Object%5D&originHeight=24&originWidth=106&size=0&status=done&style=none&width=106\"> } 并通过生成器获取 <img src=\"https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442621-30bfec79-28d2-4afa-af1e-c275d87968ad.svg#align=left&display=inline&height=13&margin=%5Bobject%20Object%5D&originHeight=13&originWidth=16&size=0&status=done&style=none&width=16\"> 个生成样本 { <img src=\"https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914442561-7ef7f2bb-7710-4814-904c-1973513e864e.svg#align=left&display=inline&height=24&margin=%5Bobject%20Object%5D&originHeight=24&originWidth=112&size=0&status=done&style=none&width=112\"> } 。固定生成器G，训练判别器D尽可能好地准确判别真实样本和生成样本，尽可能大地区分正确样本和生成的样本。</li>\n<li><strong>循环k次更新判别器之后，使用较小的学习率来更新一次生成器的参数</strong>，训练生成器使其尽可能能够减小生成样本与真实样本之间的差距，也相当于尽量使得判别器判别错误。</li>\n<li>多次更新迭代之后，最终理想情况是使得判别器判别不出样本来自于生成器的输出还是真实的输出。亦即最终样本判别概率均为0.5。</li>\n</ul>\n<h3 id=\"4-损失函数\"><a href=\"#4-损失函数\" class=\"headerlink\" title=\"4.损失函数\"></a>4.损失函数</h3><p>判别器使用交叉熵计算损失，其中pi表示真实分布，qi表示生成样本的分布</p>\n<div align=\"center\"><img src=\"/temp/GANs.htm/1609914799643-975cc081-1fb5-4085-9a17-fae9d0e9b590.png\" width=\"60%\" height=\"50%\"></div>\n\n<p>因为这里是二元分类问题，判别样本真假</p>\n<div align=\"center\"><img src=\"/temp/GANs.htm/1609914908755-33c89db7-e274-44d8-bf78-d58802988970.png\" width=\"60%\" height=\"50%\"></div>\n\n<p>其中，假定 <img src=\"https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914940477-5d124bef-cb15-4dfe-9278-6c25429b8d04.svg#align=left&display=inline&height=16&margin=%5Bobject%20Object%5D&originHeight=16&originWidth=18&size=0&status=done&style=none&width=18\"> 为正确样本分布，那么对应的（ <img src=\"https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914940457-c25d5d10-abf7-492a-8570-c5cdcb31ea2a.svg#align=left&display=inline&height=20&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=50&size=0&status=done&style=none&width=50\"> ）就是生成样本的分布。 <img src=\"https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914940512-461170ea-7944-4535-86a2-f55444e71dd1.svg#align=left&display=inline&height=17&margin=%5Bobject%20Object%5D&originHeight=17&originWidth=15&size=0&status=done&style=none&width=15\"> 表示判别器，则 <img src=\"https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914940459-549fd31b-9254-4dcd-b0c2-4a9ac75b6e50.svg#align=left&display=inline&height=23&margin=%5Bobject%20Object%5D&originHeight=23&originWidth=49&size=0&status=done&style=none&width=49\"> 表示判别样本为正确的概率， <img src=\"https://cdn.nlark.com/yuque/0/2021/svg/2648023/1609914940600-fb5fafc4-0798-4d44-a981-81f2ca073bdd.svg#align=left&display=inline&height=27&margin=%5Bobject%20Object%5D&originHeight=27&originWidth=110&size=0&status=done&style=none&width=110\"> 则对应着判别为错误样本的概率，GAN对交叉熵的改进在于，为了让生成器以假乱真，判别器输出的概率稳定在0.5，0.5，故对上边的yi取1/2</p>\n<div align=\"center\"><img src=\"/temp/GANs.htm/1609983349967-7087eb25-37b6-4bd8-90eb-09dc4953bba8.png\" width=\"60%\" height=\"50%\"></div>\n\n<h3 id=\"5-损失函数意义\"><a href=\"#5-损失函数意义\" class=\"headerlink\" title=\"5.损失函数意义\"></a>5.损失函数意义</h3><p>D(y)表示判别器判别一个样本为真实的概率，其中x是真实样本，G(z)表示生成器经过随机噪声z产生的假样本被判别器判别为真的概率，所以前半部分就是判别器判别真实样本为真的概率期望，后半部分是判别器判别假样本为假的概率期望，为了让判别器判别更加准确，首先是max，尽可能让判别器判别准确，再为了让生成器可以以假乱真，D的能力越强，D(x)应该越大，D(G(x))应该越小。这时V(D,G)会变大。因此式子对于D来说是求最大(内层取max），而生成器G希望目的就是让判别器判别出现更多的失误，D(G(z))尽可能得大，这时V(D, G)会变小，也就是最外边的min</p>\n<h3 id=\"6-算法\"><a href=\"#6-算法\" class=\"headerlink\" title=\"6.算法\"></a>6.算法</h3><div align=\"center\"><img src=\"/temp/GANs.htm/1609987534946-5568cebc-0d23-4bc7-a175-73a5872b732e.png\" width=\"60%\" height=\"50%\"></div>\n\n\n\n\n<h3 id=\"7-与强化学习的区别\"><a href=\"#7-与强化学习的区别\" class=\"headerlink\" title=\"7.与强化学习的区别\"></a>7.与强化学习的区别</h3><p>强化学习是一方为智能体，一方为环境（环境相对不变），让智能体不断的进化，智能体不断与环境交互，先根据模型输出action后，再根据环境给予的奖励来调整模型。<br>而GAN是在强化学习上的演变。GAN则是相当于两个environment，判别器目的是让自己判别尽可能的准确（即让自己极可能识别出更多的假样本），体现在损失函数中是体现在max(D,G)是固定生成器G，使得判别真假样本概率极可能地准确，其在做出action（判断输入样本真假概率），才能根据真假样本标签给予的奖励来调整自己的模型（对于生成器：判断正确是正奖励，判断失误是负奖励）；生成器则是做出action后（生成样本），再根据判别器判断失误奖励（对于判别器：判断失误是正奖励，判断正确是负奖励）来提高自己；判别器D试图使得D(G(z))概率接近于0，生成器试图使得D(G(z))概率为1</p>"},{"title":"奥斯曼帝国的衰落原由","date":"2021-01-27T12:30:00.000Z","tags":["历史"],"categories":["随笔"],"_content":"test","source":"随笔/index.md","raw":"---\ntitle: 奥斯曼帝国的衰落原由\ndate: 2021-01-27 20:30\ntags:\n  - 历史\ncategories:\n  - 随笔\n---\ntest","updated":"2021-01-27T13:50:02.858Z","path":"随笔/index.html","comments":1,"layout":"page","_id":"cl2enrqzj000gy2lo2n1328rp","content":"<p>test</p>\n","site":{"data":{"photography":[{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","title":"玉渊潭","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","title":"花儿","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","title":"白塔寺","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"}]}},"excerpt":"","more":"<p>test</p>\n"},{"title":"奥斯曼帝国的衰落原由","date":"2021-01-27T12:30:00.000Z","tags":["历史"],"categories":["随笔"],"_content":"\n最近闲暇之余在看中东战争史，记录一下\n\n1. 军权无法牢牢掌握在苏丹手中，往往出现改革一触及军阀保守势力的利益就被推翻的场面，改革在上层就无法推行下\n\n2.  政权更替完全是靠王室之间的屠杀优胜者当王，政治内斗严重，政法思想无法一脉相承\n\n   <!--more-->\n\n3. 西化改革未取精髓，帝国核心地带自然灾害仍然想效仿西方花费大量金钱建立类似法国同时期建立的凡尔赛宫、建造战舰，但国内已经名民不聊生，埃及税收因向西方借贷打克里米亚战争抵押给了英法，阿拉伯半岛更是穷的叮当响，只能从相对富裕的巴尔干半岛进行搜刮，巴尔干半岛都是斯拉夫人，与奥斯曼帝国主教伊斯兰教不对付，加上税收家重，可以说巴尔干半岛已经是暗流涌动，沙皇俄国也正虎视眈眈这块地区，内忧外患\n\n4. 军队体制涣散，战士没有战斗力一直想子传父业，想铁饭碗，贪腐无能，依靠地缘优势敲诈勒索所有外来经商，不利于生产力的推动和经商环境\n\n5. 民族之间割裂严重，没有一个统一的国家意识，宗教教义和法律相并行，法律需要教义解释才可执行，无法做到贯彻实施\n\n6. 西方开始工业革命，开辟航海路线达到亚非地区，奥斯曼帝国敲诈勒索途径商队的陆路贸易航线对追求极致利润的西方来说完全没有吸引力\n\n","source":"随笔/奥斯曼帝国的衰落原由.md","raw":"---\ntitle: 奥斯曼帝国的衰落原由\ndate: 2021-01-27 20:30\ntags:\n  - 历史\ncategories:\n  - 随笔\n---\n\n最近闲暇之余在看中东战争史，记录一下\n\n1. 军权无法牢牢掌握在苏丹手中，往往出现改革一触及军阀保守势力的利益就被推翻的场面，改革在上层就无法推行下\n\n2.  政权更替完全是靠王室之间的屠杀优胜者当王，政治内斗严重，政法思想无法一脉相承\n\n   <!--more-->\n\n3. 西化改革未取精髓，帝国核心地带自然灾害仍然想效仿西方花费大量金钱建立类似法国同时期建立的凡尔赛宫、建造战舰，但国内已经名民不聊生，埃及税收因向西方借贷打克里米亚战争抵押给了英法，阿拉伯半岛更是穷的叮当响，只能从相对富裕的巴尔干半岛进行搜刮，巴尔干半岛都是斯拉夫人，与奥斯曼帝国主教伊斯兰教不对付，加上税收家重，可以说巴尔干半岛已经是暗流涌动，沙皇俄国也正虎视眈眈这块地区，内忧外患\n\n4. 军队体制涣散，战士没有战斗力一直想子传父业，想铁饭碗，贪腐无能，依靠地缘优势敲诈勒索所有外来经商，不利于生产力的推动和经商环境\n\n5. 民族之间割裂严重，没有一个统一的国家意识，宗教教义和法律相并行，法律需要教义解释才可执行，无法做到贯彻实施\n\n6. 西方开始工业革命，开辟航海路线达到亚非地区，奥斯曼帝国敲诈勒索途径商队的陆路贸易航线对追求极致利润的西方来说完全没有吸引力\n\n","updated":"2021-01-27T13:42:04.203Z","path":"随笔/奥斯曼帝国的衰落原由.html","comments":1,"layout":"page","_id":"cl2enrqzk000ky2loaks84592","content":"<p>最近闲暇之余在看中东战争史，记录一下</p>\n<ol>\n<li><p>军权无法牢牢掌握在苏丹手中，往往出现改革一触及军阀保守势力的利益就被推翻的场面，改革在上层就无法推行下</p>\n</li>\n<li><p>政权更替完全是靠王室之间的屠杀优胜者当王，政治内斗严重，政法思想无法一脉相承</p>\n<a id=\"more\"></a>\n</li>\n<li><p>西化改革未取精髓，帝国核心地带自然灾害仍然想效仿西方花费大量金钱建立类似法国同时期建立的凡尔赛宫、建造战舰，但国内已经名民不聊生，埃及税收因向西方借贷打克里米亚战争抵押给了英法，阿拉伯半岛更是穷的叮当响，只能从相对富裕的巴尔干半岛进行搜刮，巴尔干半岛都是斯拉夫人，与奥斯曼帝国主教伊斯兰教不对付，加上税收家重，可以说巴尔干半岛已经是暗流涌动，沙皇俄国也正虎视眈眈这块地区，内忧外患</p>\n</li>\n<li><p>军队体制涣散，战士没有战斗力一直想子传父业，想铁饭碗，贪腐无能，依靠地缘优势敲诈勒索所有外来经商，不利于生产力的推动和经商环境</p>\n</li>\n<li><p>民族之间割裂严重，没有一个统一的国家意识，宗教教义和法律相并行，法律需要教义解释才可执行，无法做到贯彻实施</p>\n</li>\n<li><p>西方开始工业革命，开辟航海路线达到亚非地区，奥斯曼帝国敲诈勒索途径商队的陆路贸易航线对追求极致利润的西方来说完全没有吸引力</p>\n</li>\n</ol>\n","site":{"data":{"photography":[{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","title":"玉渊潭","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","title":"花儿","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","title":"白塔寺","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"}]}},"excerpt":"<p>最近闲暇之余在看中东战争史，记录一下</p>\n<ol>\n<li><p>军权无法牢牢掌握在苏丹手中，往往出现改革一触及军阀保守势力的利益就被推翻的场面，改革在上层就无法推行下</p>\n</li>\n<li><p>政权更替完全是靠王室之间的屠杀优胜者当王，政治内斗严重，政法思想无法一脉相承</p></li></ol>","more":"\n<li><p>西化改革未取精髓，帝国核心地带自然灾害仍然想效仿西方花费大量金钱建立类似法国同时期建立的凡尔赛宫、建造战舰，但国内已经名民不聊生，埃及税收因向西方借贷打克里米亚战争抵押给了英法，阿拉伯半岛更是穷的叮当响，只能从相对富裕的巴尔干半岛进行搜刮，巴尔干半岛都是斯拉夫人，与奥斯曼帝国主教伊斯兰教不对付，加上税收家重，可以说巴尔干半岛已经是暗流涌动，沙皇俄国也正虎视眈眈这块地区，内忧外患</p>\n</li>\n<li><p>军队体制涣散，战士没有战斗力一直想子传父业，想铁饭碗，贪腐无能，依靠地缘优势敲诈勒索所有外来经商，不利于生产力的推动和经商环境</p>\n</li>\n<li><p>民族之间割裂严重，没有一个统一的国家意识，宗教教义和法律相并行，法律需要教义解释才可执行，无法做到贯彻实施</p>\n</li>\n<li><p>西方开始工业革命，开辟航海路线达到亚非地区，奥斯曼帝国敲诈勒索途径商队的陆路贸易航线对追求极致利润的西方来说完全没有吸引力</p>\n</li>\n"},{"_content":"/******/\n(function(modules) { // webpackBootstrap\n  /******/ // The module cache\n  /******/\n  var installedModules = {};\n  /******/\n  /******/ // The require function\n  /******/\n  function __webpack_require__(moduleId) {\n    /******/\n    /******/ // Check if module is in cache\n    /******/\n    if (installedModules[moduleId])\n    /******/\n      return installedModules[moduleId].exports;\n    /******/\n    /******/ // Create a new module (and put it into the cache)\n    /******/\n    var module = installedModules[moduleId] = {\n      /******/\n      exports: {},\n      /******/\n      id: moduleId,\n      /******/\n      loaded: false\n        /******/\n    };\n    /******/\n    /******/ // Execute the module function\n    /******/\n    modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n    /******/\n    /******/ // Flag the module as loaded\n    /******/\n    module.loaded = true;\n    /******/\n    /******/ // Return the exports of the module\n    /******/\n    return module.exports;\n    /******/\n  }\n  /******/\n  /******/\n  /******/ // expose the modules object (__webpack_modules__)\n  /******/\n  __webpack_require__.m = modules;\n  /******/\n  /******/ // expose the module cache\n  /******/\n  __webpack_require__.c = installedModules;\n  /******/\n  /******/ // __webpack_public_path__\n  /******/\n  __webpack_require__.p = \"/dist/\";\n  /******/\n  /******/ // Load entry module and return exports\n  /******/\n  return __webpack_require__(0);\n  /******/\n})\n/************************************************************************/\n/******/\n([\n  /* 0 */\n  /***/\n  function(module, exports, __webpack_require__) {\n\n    'use strict';\n\n    __webpack_require__(1);\n\n    var _view = __webpack_require__(2);\n\n    var _view2 = _interopRequireDefault(_view);\n\n    function _interopRequireDefault(obj) {\n      return obj && obj.__esModule ? obj : {\n        default: obj\n      };\n    }\n\n    /**\n     * @name impush-client \n     * @description 这个项目让我发家致富…\n     * @date 2016-12-1\n     */\n\n    var _collection = [];\n    var _count = 0;\n    var searchData;\n\n    function addMask(elem) {\n      var rect = elem.getBoundingClientRect();\n      var style = getComputedStyle(elem, null);\n\n      var mask = document.createElement('i');\n      mask.className = 'icon-film';\n      mask.style.color = '#fff';\n      mask.style.fontSize = '26px';\n      mask.style.position = 'absolute';\n      mask.style.right = '10px';\n      mask.style.bottom = '10px';\n      mask.style.zIndex = 1;\n      elem.parentNode.appendChild(mask);\n    }\n\n    var createVideoIncon = function createVideoIncon() {\n      var $videoImg = document.querySelectorAll('.thumb a[data-type=\"video\"]');\n      for (var i = 0, len = $videoImg.length; i < len; i++) {\n        addMask($videoImg[i]);\n      }\n    };\n\n\t// 修改这里render()函数：修改图片的路径地址.minSrc 小图的路径. src 大图的路径.修改为自己的图片路径(github的路径)\n\t// https://raw.githubusercontent.com/ChemLez/blog-Picture/master/photos/\n\t// https://raw.githubusercontent.com/ChemLez/blog-Picture/master/min_photos/\n    var render = function render(res) {\n      var ulTmpl = \"\";\n      for (var j = 0, len2 = res.list.length; j < len2; j++) {\n        var data = res.list[j].arr;\n        var liTmpl = \"\";\n        for (var i = 0, len = data.link.length; i < len; i++) {\n          var minSrc = 'https://raw.githubusercontent.com/yizhichangyuan/blog-photo/master/min_photos/' + data.link[i];\n          var src = 'https://raw.githubusercontent.com/yizhichangyuan/blog-photo/master/photos/' + data.link[i];\n          var type = data.type[i];\n          var target = src + (type === 'video' ? '.mp4' : '.jpg');\n          src += '';\n\n          liTmpl += '<figure class=\"thumb\" itemprop=\"associatedMedia\" itemscope=\"\" itemtype=\"http://schema.org/ImageObject\">\\\n                <a href=\"' + src + '\" itemprop=\"contentUrl\" data-size=\"1080x1080\" data-type=\"' + type + '\" data-target=\"' + src + '\">\\\n                  <img class=\"reward-img\" data-type=\"' + type + '\" data-src=\"' + minSrc + '\" src=\"/assets/img/empty.png\" itemprop=\"thumbnail\" onload=\"lzld(this)\">\\\n                </a>\\\n                <figcaption style=\"display:none\" itemprop=\"caption description\">' + data.text[i] + '</figcaption>\\\n            </figure>';\n        }\n        ulTmpl = ulTmpl + '<section class=\"archives album\"><h1 class=\"year\">' + data.year + '年<em>' + data.month + '月</em></h1>\\\n        <ul class=\"img-box-ul\">' + liTmpl + '</ul>\\\n        </section>';\n      }\n      document.querySelector('.instagram').innerHTML = '<div class=\"photos\" itemscope=\"\" itemtype=\"http://schema.org/ImageGallery\">' + ulTmpl + '</div>';\n      createVideoIncon();\n      _view2.default.init();\n    };\n\n    var replacer = function replacer(str) {\n      var arr = str.split(\"/\");\n      return \"/assets/ins/\" + arr[arr.length - 1];\n    };\n\n    var ctrler = function ctrler(data) {\n      var imgObj = {};\n      for (var i = 0, len = data.length; i < len; i++) {\n        var y = data[i].y;\n        var m = data[i].m;\n        var src = replacer(data[i].src);\n        var text = data[i].text;\n        var key = y + \"\" + ((m + \"\").length == 1 ? \"0\" + m : m);\n        if (imgObj[key]) {\n          imgObj[key].srclist.push(src);\n          imgObj[key].text.push(text);\n        } else {\n          imgObj[key] = {\n            year: y,\n            month: m,\n            srclist: [src],\n            text: [text]\n          };\n        }\n      }\n      render(imgObj);\n    };\n\n    function loadData(success) {\n      if (!searchData) {\n        var xhr = new XMLHttpRequest();\n        xhr.open('GET', './data.json?t=' + +new Date(), true);\n\n        xhr.onload = function() {\n          if (this.status >= 200 && this.status < 300) {\n            var res = JSON.parse(this.response);\n            searchData = res;\n            success(searchData);\n          } else {\n            console.error(this.statusText);\n          }\n        };\n\n        xhr.onerror = function() {\n          console.error(this.statusText);\n        };\n\n        xhr.send();\n      } else {\n        success(searchData);\n      }\n    }\n\n    var Ins = {\n      init: function init() {\n        loadData(function(data) {\n          render(data);\n        });\n      }\n    };\n\n    Ins.init();\n\n    // export default impush;\n\n    /***/\n  },\n  /* 1 */\n  /***/\n  function(module, exports, __webpack_require__) {\n\n    /* WEBPACK VAR INJECTION */\n    (function(global) {\n      'use strict';\n\n      var inViewport = __webpack_require__(3);\n      var lazyAttrs = ['data-src'];\n\n      global.lzld = lazyload();\n\n      // Provide libs using getAttribute early to get the good src\n      // and not the fake data-src\n      replaceGetAttribute('Image');\n      replaceGetAttribute('IFrame');\n\n      function registerLazyAttr(attr) {\n        if (indexOf.call(lazyAttrs, attr) === -1) {\n          lazyAttrs.push(attr);\n        }\n      }\n\n      function lazyload(opts) {\n        opts = merge({\n          'offset': 333,\n          'src': 'data-src',\n          'container': false\n        }, opts || {});\n\n        if (typeof opts.src === 'string') {\n          registerLazyAttr(opts.src);\n        }\n\n        var elts = [];\n\n        function show(elt) {\n          var src = findRealSrc(elt);\n\n          if (src) {\n            elt.src = src;\n          }\n\n          elt.setAttribute('data-lzled', true);\n          elts[indexOf.call(elts, elt)] = null;\n        }\n\n        function findRealSrc(elt) {\n          if (typeof opts.src === 'function') {\n            return opts.src(elt);\n          }\n\n          return elt.getAttribute(opts.src);\n        }\n\n        function register(elt) {\n          elt.onload = null;\n          elt.removeAttribute('onload');\n          elt.onerror = null;\n          elt.removeAttribute('onerror');\n\n          if (indexOf.call(elts, elt) === -1) {\n            inViewport(elt, opts, show);\n          }\n        }\n\n        return register;\n      }\n\n      function replaceGetAttribute(elementName) {\n        var fullname = 'HTML' + elementName + 'Element';\n        if (fullname in global === false) {\n          return;\n        }\n\n        var original = global[fullname].prototype.getAttribute;\n        global[fullname].prototype.getAttribute = function(name) {\n          if (name === 'src') {\n            var realSrc;\n            for (var i = 0, max = lazyAttrs.length; i < max; i++) {\n              realSrc = original.call(this, lazyAttrs[i]);\n              if (realSrc) {\n                break;\n              }\n            }\n\n            return realSrc || original.call(this, name);\n          }\n\n          // our own lazyloader will go through theses lines\n          // because we use getAttribute(opts.src)\n          return original.call(this, name);\n        };\n      }\n\n      function merge(defaults, opts) {\n        for (var name in defaults) {\n          if (opts[name] === undefined) {\n            opts[name] = defaults[name];\n          }\n        }\n\n        return opts;\n      }\n\n      // http://webreflection.blogspot.fr/2011/06/partial-polyfills.html\n      function indexOf(value) {\n        for (var i = this.length; i-- && this[i] !== value;) {}\n        return i;\n      }\n\n      module.exports = lazyload;\n\n      // export default impush;\n      /* WEBPACK VAR INJECTION */\n    }.call(exports, (function() {\n      return this;\n    }())))\n\n    /***/\n  },\n  /* 2 */\n  /***/\n  function(module, exports) {\n\n    'use strict';\n\n    var initPhotoSwipeFromDOM = function initPhotoSwipeFromDOM(gallerySelector) {\n\n      // parse slide data (url, title, size ...) from DOM elements \n      // (children of gallerySelector)\n      var parseThumbnailElements = function parseThumbnailElements(el) {\n        el = el.parentNode.parentNode;\n        var thumbElements = el.getElementsByClassName('thumb'),\n          numNodes = thumbElements.length,\n          items = [],\n          figureEl,\n          linkEl,\n          size,\n          type,\n          // video or not\n          target,\n          item;\n\n        for (var i = 0; i < numNodes; i++) {\n\n          figureEl = thumbElements[i]; // \n\n          // include only element nodes \n          if (figureEl.nodeType !== 1) {\n            continue;\n          }\n\n          linkEl = figureEl.children[0]; // \n\n          size = linkEl.getAttribute('data-size').split('x');\n          type = linkEl.getAttribute('data-type');\n          target = linkEl.getAttribute('data-target');\n          // create slide object\n          item = {\n            src: linkEl.getAttribute('href'),\n            w: parseInt(size[0], 10),\n            h: parseInt(size[1], 10)\n          };\n\n          if (figureEl.children.length > 1) {\n            item.title = figureEl.children[1].innerHTML;\n          }\n\n          if (linkEl.children.length > 0) {\n            item.msrc = linkEl.children[0].getAttribute('src');\n            item.type = type;\n            item.target = target;\n            item.html = '<video src=\"' + target + '\" controls=\"controls\" autoplay=\"autoplay\"></video>';\n            if (type === 'video') {\n              //item.src = null;\n            }\n          }\n\n          item.el = figureEl; // save link to element for getThumbBoundsFn\n          items.push(item);\n        }\n\n        return items;\n      };\n\n      // find nearest parent element\n      var closest = function closest(el, fn) {\n        return el && (fn(el) ? el : closest(el.parentNode, fn));\n      };\n\n      // triggers when user clicks on thumbnail\n      var onThumbnailsClick = function onThumbnailsClick(e) {\n        e = e || window.event;\n        e.preventDefault ? e.preventDefault() : e.returnValue = false;\n\n        var eTarget = e.target || e.srcElement;\n\n        // find root element of slide\n        var clickedListItem = closest(eTarget, function(el) {\n          return el.tagName && el.tagName.toUpperCase() === 'FIGURE';\n        });\n\n        if (!clickedListItem) {\n          return;\n        }\n\n        // find index of clicked item by looping through all child nodes\n        // alternatively, you may define index via data- attribute\n        var clickedGallery = clickedListItem.parentNode,\n\n          // childNodes = clickedListItem.parentNode.childNodes,\n          // numChildNodes = childNodes.length,\n          childNodes = document.getElementsByClassName('thumb'),\n          numChildNodes = childNodes.length,\n          nodeIndex = 0,\n          index;\n\n        for (var i = 0; i < numChildNodes; i++) {\n          if (childNodes[i].nodeType !== 1) {\n            continue;\n          }\n\n          if (childNodes[i] === clickedListItem) {\n            index = nodeIndex;\n            break;\n          }\n          nodeIndex++;\n        }\n\n        if (index >= 0) {\n          // open PhotoSwipe if valid index found\n          openPhotoSwipe(index, clickedGallery);\n        }\n        return false;\n      };\n\n      // parse picture index and gallery index from URL (#&pid=1&gid=2)\n      var photoswipeParseHash = function photoswipeParseHash() {\n        var hash = window.location.hash.substring(1),\n          params = {};\n\n        if (hash.length < 5) {\n          return params;\n        }\n\n        var vars = hash.split('&');\n        for (var i = 0; i < vars.length; i++) {\n          if (!vars[i]) {\n            continue;\n          }\n          var pair = vars[i].split('=');\n          if (pair.length < 2) {\n            continue;\n          }\n          params[pair[0]] = pair[1];\n        }\n\n        if (params.gid) {\n          params.gid = parseInt(params.gid, 10);\n        }\n\n        return params;\n      };\n\n      var openPhotoSwipe = function openPhotoSwipe(index, galleryElement, disableAnimation, fromURL) {\n        var pswpElement = document.querySelectorAll('.pswp')[0],\n          gallery,\n          options,\n          items;\n\n        items = parseThumbnailElements(galleryElement);\n        // define options (if needed)\n        options = {\n\n          // define gallery index (for URL)\n          galleryUID: galleryElement.getAttribute('data-pswp-uid'),\n\n          getThumbBoundsFn: function getThumbBoundsFn(index) {\n            // See Options -> getThumbBoundsFn section of documentation for more info\n            var thumbnail = items[index].el.getElementsByTagName('img')[0],\n              // find thumbnail\n              pageYScroll = window.pageYOffset || document.documentElement.scrollTop,\n              rect = thumbnail.getBoundingClientRect();\n\n            return {\n              x: rect.left,\n              y: rect.top + pageYScroll,\n              w: rect.width\n            };\n          }\n\n        };\n\n        // PhotoSwipe opened from URL\n        if (fromURL) {\n          if (options.galleryPIDs) {\n            // parse real index when custom PIDs are used \n            // http://photoswipe.com/documentation/faq.html#custom-pid-in-url\n            for (var j = 0; j < items.length; j++) {\n              if (items[j].pid == index) {\n                options.index = j;\n                break;\n              }\n            }\n          } else {\n            // in URL indexes start from 1\n            options.index = parseInt(index, 10) - 1;\n          }\n        } else {\n          options.index = parseInt(index, 10);\n        }\n\n        // exit if index not found\n        if (isNaN(options.index)) {\n          return;\n        }\n\n        if (disableAnimation) {\n          options.showAnimationDuration = 0;\n        }\n\n        // Pass data to PhotoSwipe and initialize it\n        gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, options);\n        gallery.init();\n\n        var $tempVideo;\n        var stopVideoHandle = function stopVideoHandle() {\n          if ($tempVideo) {\n            $tempVideo.remove();\n            $tempVideo = null;\n          }\n        };\n        var changeHandle = function changeHandle() {\n          var item = gallery.currItem;\n          stopVideoHandle();\n          if (item.type === 'video') {\n            var $ctn = item.container;\n            var style = $ctn.getElementsByClassName('pswp__img')[0].style;\n            var $video = document.createElement('video');\n            $video.setAttribute('autoplay', 'autoplay');\n            $video.setAttribute('controls', 'controls');\n            $video.setAttribute('src', item.target);\n            $video.style.width = style.width;\n            $video.style.height = style.height;\n            $video.style.position = 'absolute';\n            $video.style.zIndex = 2;\n            $tempVideo = $video;\n            $ctn.appendChild($video);\n          }\n        };\n        gallery.listen('initialZoomIn', changeHandle);\n        gallery.listen('afterChange', changeHandle);\n        gallery.listen('initialZoomOut', stopVideoHandle);\n      };\n\n      // loop through all gallery elements and bind events\n      var galleryElements = document.querySelectorAll(gallerySelector);\n      for (var i = 0, l = galleryElements.length; i < l; i++) {\n        galleryElements[i].setAttribute('data-pswp-uid', i + 1);\n        galleryElements[i].onclick = onThumbnailsClick;\n      }\n\n      // Parse URL and open gallery if it contains #&pid=3&gid=1\n      var hashData = photoswipeParseHash();\n      if (hashData.pid && hashData.gid) {\n        openPhotoSwipe(hashData.pid, galleryElements[hashData.gid - 1], true, true);\n      }\n    };\n\n    var Viewer = function() {\n      function init() {\n        initPhotoSwipeFromDOM('.photos');\n      }\n      return {\n        init: init\n      };\n    }();\n\n    module.exports = Viewer;\n\n    /***/\n  },\n  /* 3 */\n  /***/\n  function(module, exports) {\n\n    /* WEBPACK VAR INJECTION */\n    (function(global) {\n      module.exports = inViewport;\n\n      var instances = [];\n      var supportsMutationObserver = typeof global.MutationObserver === 'function';\n\n      function inViewport(elt, params, cb) {\n        var opts = {\n          container: global.document.body,\n          offset: 0\n        };\n\n        if (params === undefined || typeof params === 'function') {\n          cb = params;\n          params = {};\n        }\n\n        var container = opts.container = params.container || opts.container;\n        var offset = opts.offset = params.offset || opts.offset;\n\n        for (var i = 0; i < instances.length; i++) {\n          if (instances[i].container === container) {\n            return instances[i].isInViewport(elt, offset, cb);\n          }\n        }\n\n        return instances[\n          instances.push(createInViewport(container)) - 1\n        ].isInViewport(elt, offset, cb);\n      }\n\n      function addEvent(el, type, fn) {\n        if (el.attachEvent) {\n          el.attachEvent('on' + type, fn);\n        } else {\n          el.addEventListener(type, fn, false);\n        }\n      }\n\n      function debounce(func, wait, immediate) {\n        var timeout;\n        return function() {\n          var context = this,\n            args = arguments;\n          var callNow = immediate && !timeout;\n          clearTimeout(timeout);\n          timeout = setTimeout(later, wait);\n          if (callNow) func.apply(context, args);\n\n          function later() {\n            timeout = null;\n            if (!immediate) func.apply(context, args);\n          }\n        };\n      }\n\n      // https://github.com/jquery/sizzle/blob/3136f48b90e3edc84cbaaa6f6f7734ef03775a07/sizzle.js#L708\n      var contains = function() {\n        if (!global.document) {\n          return true;\n        }\n        return global.document.documentElement.compareDocumentPosition ?\n          function(a, b) {\n            return !!(a.compareDocumentPosition(b) & 16);\n          } :\n          global.document.documentElement.contains ?\n          function(a, b) {\n            return a !== b && (a.contains ? a.contains(b) : false);\n          } :\n          function(a, b) {\n            while (b = b.parentNode) {\n              if (b === a) {\n                return true;\n              }\n            }\n            return false;\n          };\n      }\n\n      function createInViewport(container) {\n        var watches = createWatches();\n\n        var scrollContainer = container === global.document.body ? global : container;\n        var debouncedCheck = debounce(watches.checkAll(watchInViewport), 15);\n\n        addEvent(scrollContainer, 'scroll', debouncedCheck);\n\n        if (scrollContainer === global) {\n          addEvent(global, 'resize', debouncedCheck);\n        }\n\n        if (supportsMutationObserver) {\n          observeDOM(watches, container, debouncedCheck);\n        }\n\n        // failsafe check, every 200ms we check for visible images\n        // usecase: a hidden parent containing eleements\n        // when the parent becomes visible, we have no event that the children\n        // became visible\n        setInterval(debouncedCheck, 150);\n\n        function isInViewport(elt, offset, cb) {\n          if (!cb) {\n            return isVisible(elt, offset);\n          }\n\n          var remote = createRemote(elt, offset, cb);\n          remote.watch();\n          return remote;\n        }\n\n        function createRemote(elt, offset, cb) {\n          function watch() {\n            watches.add(elt, offset, cb);\n          }\n\n          function dispose() {\n            watches.remove(elt);\n          }\n\n          return {\n            watch: watch,\n            dispose: dispose\n          };\n        }\n\n        function watchInViewport(elt, offset, cb) {\n          if (isVisible(elt, offset)) {\n            watches.remove(elt);\n            cb(elt);\n          }\n        }\n\n        function isVisible(elt, offset) {\n          if (!contains(global.document.documentElement, elt) || !contains(global.document.documentElement, container)) {\n            return false;\n          }\n\n          // Check if the element is visible\n          // https://github.com/jquery/jquery/blob/740e190223d19a114d5373758127285d14d6b71e/src/css/hiddenVisibleSelectors.js\n          if (!elt.offsetWidth || !elt.offsetHeight) {\n            return false;\n          }\n\n          var eltRect = elt.getBoundingClientRect();\n          var viewport = {};\n\n          if (container === global.document.body) {\n            viewport = {\n              top: -offset,\n              left: -offset,\n              right: global.document.documentElement.clientWidth + offset,\n              bottom: global.document.documentElement.clientHeight + offset\n            };\n          } else {\n            var containerRect = container.getBoundingClientRect();\n            viewport = {\n              top: containerRect.top - offset,\n              left: containerRect.left - offset,\n              right: containerRect.right + offset,\n              bottom: containerRect.bottom + offset\n            };\n          }\n\n          // The element must overlap with the visible part of the viewport\n          var visible =\n            (\n              (eltRect.right > viewport.left) &&\n              (eltRect.left < viewport.right) &&\n              (eltRect.bottom > viewport.top) &&\n              (eltRect.top < viewport.bottom)\n            );\n\n          return visible;\n        }\n\n        return {\n          container: container,\n          isInViewport: isInViewport\n        };\n      }\n\n      function createWatches() {\n        var watches = [];\n\n        function add(elt, offset, cb) {\n          if (!isWatched(elt)) {\n            watches.push([elt, offset, cb]);\n          }\n        }\n\n        function remove(elt) {\n          var pos = indexOf(elt);\n          if (pos !== -1) {\n            watches.splice(pos, 1);\n          }\n        }\n\n        function indexOf(elt) {\n          for (var i = watches.length - 1; i >= 0; i--) {\n            if (watches[i][0] === elt) {\n              return i;\n            }\n          }\n          return -1;\n        }\n\n        function isWatched(elt) {\n          return indexOf(elt) !== -1;\n        }\n\n        function checkAll(cb) {\n          return function() {\n            for (var i = watches.length - 1; i >= 0; i--) {\n              cb.apply(this, watches[i]);\n            }\n          };\n        }\n\n        return {\n          add: add,\n          remove: remove,\n          isWatched: isWatched,\n          checkAll: checkAll\n        };\n      }\n\n      function observeDOM(watches, container, cb) {\n        var observer = new MutationObserver(watch);\n        var filter = Array.prototype.filter;\n        var concat = Array.prototype.concat;\n\n        observer.observe(container, {\n          childList: true,\n          subtree: true,\n          // changes like style/width/height/display will be catched\n          attributes: true\n        });\n\n        function watch(mutations) {\n          // some new DOM nodes where previously watched\n          // we should check their positions\n          if (mutations.some(knownNodes) === true) {\n            setTimeout(cb, 0);\n          }\n        }\n\n        function knownNodes(mutation) {\n          var nodes = concat.call([],\n            Array.prototype.slice.call(mutation.addedNodes),\n            mutation.target\n          );\n          return filter.call(nodes, watches.isWatched).length > 0;\n        }\n      }\n\n      /* WEBPACK VAR INJECTION */\n    }.call(exports, (function() {\n      return this;\n    }())))\n\n    /***/\n  }\n  /******/\n]);","source":"blog-photo/ins.js","raw":"/******/\n(function(modules) { // webpackBootstrap\n  /******/ // The module cache\n  /******/\n  var installedModules = {};\n  /******/\n  /******/ // The require function\n  /******/\n  function __webpack_require__(moduleId) {\n    /******/\n    /******/ // Check if module is in cache\n    /******/\n    if (installedModules[moduleId])\n    /******/\n      return installedModules[moduleId].exports;\n    /******/\n    /******/ // Create a new module (and put it into the cache)\n    /******/\n    var module = installedModules[moduleId] = {\n      /******/\n      exports: {},\n      /******/\n      id: moduleId,\n      /******/\n      loaded: false\n        /******/\n    };\n    /******/\n    /******/ // Execute the module function\n    /******/\n    modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n    /******/\n    /******/ // Flag the module as loaded\n    /******/\n    module.loaded = true;\n    /******/\n    /******/ // Return the exports of the module\n    /******/\n    return module.exports;\n    /******/\n  }\n  /******/\n  /******/\n  /******/ // expose the modules object (__webpack_modules__)\n  /******/\n  __webpack_require__.m = modules;\n  /******/\n  /******/ // expose the module cache\n  /******/\n  __webpack_require__.c = installedModules;\n  /******/\n  /******/ // __webpack_public_path__\n  /******/\n  __webpack_require__.p = \"/dist/\";\n  /******/\n  /******/ // Load entry module and return exports\n  /******/\n  return __webpack_require__(0);\n  /******/\n})\n/************************************************************************/\n/******/\n([\n  /* 0 */\n  /***/\n  function(module, exports, __webpack_require__) {\n\n    'use strict';\n\n    __webpack_require__(1);\n\n    var _view = __webpack_require__(2);\n\n    var _view2 = _interopRequireDefault(_view);\n\n    function _interopRequireDefault(obj) {\n      return obj && obj.__esModule ? obj : {\n        default: obj\n      };\n    }\n\n    /**\n     * @name impush-client \n     * @description 这个项目让我发家致富…\n     * @date 2016-12-1\n     */\n\n    var _collection = [];\n    var _count = 0;\n    var searchData;\n\n    function addMask(elem) {\n      var rect = elem.getBoundingClientRect();\n      var style = getComputedStyle(elem, null);\n\n      var mask = document.createElement('i');\n      mask.className = 'icon-film';\n      mask.style.color = '#fff';\n      mask.style.fontSize = '26px';\n      mask.style.position = 'absolute';\n      mask.style.right = '10px';\n      mask.style.bottom = '10px';\n      mask.style.zIndex = 1;\n      elem.parentNode.appendChild(mask);\n    }\n\n    var createVideoIncon = function createVideoIncon() {\n      var $videoImg = document.querySelectorAll('.thumb a[data-type=\"video\"]');\n      for (var i = 0, len = $videoImg.length; i < len; i++) {\n        addMask($videoImg[i]);\n      }\n    };\n\n\t// 修改这里render()函数：修改图片的路径地址.minSrc 小图的路径. src 大图的路径.修改为自己的图片路径(github的路径)\n\t// https://raw.githubusercontent.com/ChemLez/blog-Picture/master/photos/\n\t// https://raw.githubusercontent.com/ChemLez/blog-Picture/master/min_photos/\n    var render = function render(res) {\n      var ulTmpl = \"\";\n      for (var j = 0, len2 = res.list.length; j < len2; j++) {\n        var data = res.list[j].arr;\n        var liTmpl = \"\";\n        for (var i = 0, len = data.link.length; i < len; i++) {\n          var minSrc = 'https://raw.githubusercontent.com/yizhichangyuan/blog-photo/master/min_photos/' + data.link[i];\n          var src = 'https://raw.githubusercontent.com/yizhichangyuan/blog-photo/master/photos/' + data.link[i];\n          var type = data.type[i];\n          var target = src + (type === 'video' ? '.mp4' : '.jpg');\n          src += '';\n\n          liTmpl += '<figure class=\"thumb\" itemprop=\"associatedMedia\" itemscope=\"\" itemtype=\"http://schema.org/ImageObject\">\\\n                <a href=\"' + src + '\" itemprop=\"contentUrl\" data-size=\"1080x1080\" data-type=\"' + type + '\" data-target=\"' + src + '\">\\\n                  <img class=\"reward-img\" data-type=\"' + type + '\" data-src=\"' + minSrc + '\" src=\"/assets/img/empty.png\" itemprop=\"thumbnail\" onload=\"lzld(this)\">\\\n                </a>\\\n                <figcaption style=\"display:none\" itemprop=\"caption description\">' + data.text[i] + '</figcaption>\\\n            </figure>';\n        }\n        ulTmpl = ulTmpl + '<section class=\"archives album\"><h1 class=\"year\">' + data.year + '年<em>' + data.month + '月</em></h1>\\\n        <ul class=\"img-box-ul\">' + liTmpl + '</ul>\\\n        </section>';\n      }\n      document.querySelector('.instagram').innerHTML = '<div class=\"photos\" itemscope=\"\" itemtype=\"http://schema.org/ImageGallery\">' + ulTmpl + '</div>';\n      createVideoIncon();\n      _view2.default.init();\n    };\n\n    var replacer = function replacer(str) {\n      var arr = str.split(\"/\");\n      return \"/assets/ins/\" + arr[arr.length - 1];\n    };\n\n    var ctrler = function ctrler(data) {\n      var imgObj = {};\n      for (var i = 0, len = data.length; i < len; i++) {\n        var y = data[i].y;\n        var m = data[i].m;\n        var src = replacer(data[i].src);\n        var text = data[i].text;\n        var key = y + \"\" + ((m + \"\").length == 1 ? \"0\" + m : m);\n        if (imgObj[key]) {\n          imgObj[key].srclist.push(src);\n          imgObj[key].text.push(text);\n        } else {\n          imgObj[key] = {\n            year: y,\n            month: m,\n            srclist: [src],\n            text: [text]\n          };\n        }\n      }\n      render(imgObj);\n    };\n\n    function loadData(success) {\n      if (!searchData) {\n        var xhr = new XMLHttpRequest();\n        xhr.open('GET', './data.json?t=' + +new Date(), true);\n\n        xhr.onload = function() {\n          if (this.status >= 200 && this.status < 300) {\n            var res = JSON.parse(this.response);\n            searchData = res;\n            success(searchData);\n          } else {\n            console.error(this.statusText);\n          }\n        };\n\n        xhr.onerror = function() {\n          console.error(this.statusText);\n        };\n\n        xhr.send();\n      } else {\n        success(searchData);\n      }\n    }\n\n    var Ins = {\n      init: function init() {\n        loadData(function(data) {\n          render(data);\n        });\n      }\n    };\n\n    Ins.init();\n\n    // export default impush;\n\n    /***/\n  },\n  /* 1 */\n  /***/\n  function(module, exports, __webpack_require__) {\n\n    /* WEBPACK VAR INJECTION */\n    (function(global) {\n      'use strict';\n\n      var inViewport = __webpack_require__(3);\n      var lazyAttrs = ['data-src'];\n\n      global.lzld = lazyload();\n\n      // Provide libs using getAttribute early to get the good src\n      // and not the fake data-src\n      replaceGetAttribute('Image');\n      replaceGetAttribute('IFrame');\n\n      function registerLazyAttr(attr) {\n        if (indexOf.call(lazyAttrs, attr) === -1) {\n          lazyAttrs.push(attr);\n        }\n      }\n\n      function lazyload(opts) {\n        opts = merge({\n          'offset': 333,\n          'src': 'data-src',\n          'container': false\n        }, opts || {});\n\n        if (typeof opts.src === 'string') {\n          registerLazyAttr(opts.src);\n        }\n\n        var elts = [];\n\n        function show(elt) {\n          var src = findRealSrc(elt);\n\n          if (src) {\n            elt.src = src;\n          }\n\n          elt.setAttribute('data-lzled', true);\n          elts[indexOf.call(elts, elt)] = null;\n        }\n\n        function findRealSrc(elt) {\n          if (typeof opts.src === 'function') {\n            return opts.src(elt);\n          }\n\n          return elt.getAttribute(opts.src);\n        }\n\n        function register(elt) {\n          elt.onload = null;\n          elt.removeAttribute('onload');\n          elt.onerror = null;\n          elt.removeAttribute('onerror');\n\n          if (indexOf.call(elts, elt) === -1) {\n            inViewport(elt, opts, show);\n          }\n        }\n\n        return register;\n      }\n\n      function replaceGetAttribute(elementName) {\n        var fullname = 'HTML' + elementName + 'Element';\n        if (fullname in global === false) {\n          return;\n        }\n\n        var original = global[fullname].prototype.getAttribute;\n        global[fullname].prototype.getAttribute = function(name) {\n          if (name === 'src') {\n            var realSrc;\n            for (var i = 0, max = lazyAttrs.length; i < max; i++) {\n              realSrc = original.call(this, lazyAttrs[i]);\n              if (realSrc) {\n                break;\n              }\n            }\n\n            return realSrc || original.call(this, name);\n          }\n\n          // our own lazyloader will go through theses lines\n          // because we use getAttribute(opts.src)\n          return original.call(this, name);\n        };\n      }\n\n      function merge(defaults, opts) {\n        for (var name in defaults) {\n          if (opts[name] === undefined) {\n            opts[name] = defaults[name];\n          }\n        }\n\n        return opts;\n      }\n\n      // http://webreflection.blogspot.fr/2011/06/partial-polyfills.html\n      function indexOf(value) {\n        for (var i = this.length; i-- && this[i] !== value;) {}\n        return i;\n      }\n\n      module.exports = lazyload;\n\n      // export default impush;\n      /* WEBPACK VAR INJECTION */\n    }.call(exports, (function() {\n      return this;\n    }())))\n\n    /***/\n  },\n  /* 2 */\n  /***/\n  function(module, exports) {\n\n    'use strict';\n\n    var initPhotoSwipeFromDOM = function initPhotoSwipeFromDOM(gallerySelector) {\n\n      // parse slide data (url, title, size ...) from DOM elements \n      // (children of gallerySelector)\n      var parseThumbnailElements = function parseThumbnailElements(el) {\n        el = el.parentNode.parentNode;\n        var thumbElements = el.getElementsByClassName('thumb'),\n          numNodes = thumbElements.length,\n          items = [],\n          figureEl,\n          linkEl,\n          size,\n          type,\n          // video or not\n          target,\n          item;\n\n        for (var i = 0; i < numNodes; i++) {\n\n          figureEl = thumbElements[i]; // \n\n          // include only element nodes \n          if (figureEl.nodeType !== 1) {\n            continue;\n          }\n\n          linkEl = figureEl.children[0]; // \n\n          size = linkEl.getAttribute('data-size').split('x');\n          type = linkEl.getAttribute('data-type');\n          target = linkEl.getAttribute('data-target');\n          // create slide object\n          item = {\n            src: linkEl.getAttribute('href'),\n            w: parseInt(size[0], 10),\n            h: parseInt(size[1], 10)\n          };\n\n          if (figureEl.children.length > 1) {\n            item.title = figureEl.children[1].innerHTML;\n          }\n\n          if (linkEl.children.length > 0) {\n            item.msrc = linkEl.children[0].getAttribute('src');\n            item.type = type;\n            item.target = target;\n            item.html = '<video src=\"' + target + '\" controls=\"controls\" autoplay=\"autoplay\"></video>';\n            if (type === 'video') {\n              //item.src = null;\n            }\n          }\n\n          item.el = figureEl; // save link to element for getThumbBoundsFn\n          items.push(item);\n        }\n\n        return items;\n      };\n\n      // find nearest parent element\n      var closest = function closest(el, fn) {\n        return el && (fn(el) ? el : closest(el.parentNode, fn));\n      };\n\n      // triggers when user clicks on thumbnail\n      var onThumbnailsClick = function onThumbnailsClick(e) {\n        e = e || window.event;\n        e.preventDefault ? e.preventDefault() : e.returnValue = false;\n\n        var eTarget = e.target || e.srcElement;\n\n        // find root element of slide\n        var clickedListItem = closest(eTarget, function(el) {\n          return el.tagName && el.tagName.toUpperCase() === 'FIGURE';\n        });\n\n        if (!clickedListItem) {\n          return;\n        }\n\n        // find index of clicked item by looping through all child nodes\n        // alternatively, you may define index via data- attribute\n        var clickedGallery = clickedListItem.parentNode,\n\n          // childNodes = clickedListItem.parentNode.childNodes,\n          // numChildNodes = childNodes.length,\n          childNodes = document.getElementsByClassName('thumb'),\n          numChildNodes = childNodes.length,\n          nodeIndex = 0,\n          index;\n\n        for (var i = 0; i < numChildNodes; i++) {\n          if (childNodes[i].nodeType !== 1) {\n            continue;\n          }\n\n          if (childNodes[i] === clickedListItem) {\n            index = nodeIndex;\n            break;\n          }\n          nodeIndex++;\n        }\n\n        if (index >= 0) {\n          // open PhotoSwipe if valid index found\n          openPhotoSwipe(index, clickedGallery);\n        }\n        return false;\n      };\n\n      // parse picture index and gallery index from URL (#&pid=1&gid=2)\n      var photoswipeParseHash = function photoswipeParseHash() {\n        var hash = window.location.hash.substring(1),\n          params = {};\n\n        if (hash.length < 5) {\n          return params;\n        }\n\n        var vars = hash.split('&');\n        for (var i = 0; i < vars.length; i++) {\n          if (!vars[i]) {\n            continue;\n          }\n          var pair = vars[i].split('=');\n          if (pair.length < 2) {\n            continue;\n          }\n          params[pair[0]] = pair[1];\n        }\n\n        if (params.gid) {\n          params.gid = parseInt(params.gid, 10);\n        }\n\n        return params;\n      };\n\n      var openPhotoSwipe = function openPhotoSwipe(index, galleryElement, disableAnimation, fromURL) {\n        var pswpElement = document.querySelectorAll('.pswp')[0],\n          gallery,\n          options,\n          items;\n\n        items = parseThumbnailElements(galleryElement);\n        // define options (if needed)\n        options = {\n\n          // define gallery index (for URL)\n          galleryUID: galleryElement.getAttribute('data-pswp-uid'),\n\n          getThumbBoundsFn: function getThumbBoundsFn(index) {\n            // See Options -> getThumbBoundsFn section of documentation for more info\n            var thumbnail = items[index].el.getElementsByTagName('img')[0],\n              // find thumbnail\n              pageYScroll = window.pageYOffset || document.documentElement.scrollTop,\n              rect = thumbnail.getBoundingClientRect();\n\n            return {\n              x: rect.left,\n              y: rect.top + pageYScroll,\n              w: rect.width\n            };\n          }\n\n        };\n\n        // PhotoSwipe opened from URL\n        if (fromURL) {\n          if (options.galleryPIDs) {\n            // parse real index when custom PIDs are used \n            // http://photoswipe.com/documentation/faq.html#custom-pid-in-url\n            for (var j = 0; j < items.length; j++) {\n              if (items[j].pid == index) {\n                options.index = j;\n                break;\n              }\n            }\n          } else {\n            // in URL indexes start from 1\n            options.index = parseInt(index, 10) - 1;\n          }\n        } else {\n          options.index = parseInt(index, 10);\n        }\n\n        // exit if index not found\n        if (isNaN(options.index)) {\n          return;\n        }\n\n        if (disableAnimation) {\n          options.showAnimationDuration = 0;\n        }\n\n        // Pass data to PhotoSwipe and initialize it\n        gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, options);\n        gallery.init();\n\n        var $tempVideo;\n        var stopVideoHandle = function stopVideoHandle() {\n          if ($tempVideo) {\n            $tempVideo.remove();\n            $tempVideo = null;\n          }\n        };\n        var changeHandle = function changeHandle() {\n          var item = gallery.currItem;\n          stopVideoHandle();\n          if (item.type === 'video') {\n            var $ctn = item.container;\n            var style = $ctn.getElementsByClassName('pswp__img')[0].style;\n            var $video = document.createElement('video');\n            $video.setAttribute('autoplay', 'autoplay');\n            $video.setAttribute('controls', 'controls');\n            $video.setAttribute('src', item.target);\n            $video.style.width = style.width;\n            $video.style.height = style.height;\n            $video.style.position = 'absolute';\n            $video.style.zIndex = 2;\n            $tempVideo = $video;\n            $ctn.appendChild($video);\n          }\n        };\n        gallery.listen('initialZoomIn', changeHandle);\n        gallery.listen('afterChange', changeHandle);\n        gallery.listen('initialZoomOut', stopVideoHandle);\n      };\n\n      // loop through all gallery elements and bind events\n      var galleryElements = document.querySelectorAll(gallerySelector);\n      for (var i = 0, l = galleryElements.length; i < l; i++) {\n        galleryElements[i].setAttribute('data-pswp-uid', i + 1);\n        galleryElements[i].onclick = onThumbnailsClick;\n      }\n\n      // Parse URL and open gallery if it contains #&pid=3&gid=1\n      var hashData = photoswipeParseHash();\n      if (hashData.pid && hashData.gid) {\n        openPhotoSwipe(hashData.pid, galleryElements[hashData.gid - 1], true, true);\n      }\n    };\n\n    var Viewer = function() {\n      function init() {\n        initPhotoSwipeFromDOM('.photos');\n      }\n      return {\n        init: init\n      };\n    }();\n\n    module.exports = Viewer;\n\n    /***/\n  },\n  /* 3 */\n  /***/\n  function(module, exports) {\n\n    /* WEBPACK VAR INJECTION */\n    (function(global) {\n      module.exports = inViewport;\n\n      var instances = [];\n      var supportsMutationObserver = typeof global.MutationObserver === 'function';\n\n      function inViewport(elt, params, cb) {\n        var opts = {\n          container: global.document.body,\n          offset: 0\n        };\n\n        if (params === undefined || typeof params === 'function') {\n          cb = params;\n          params = {};\n        }\n\n        var container = opts.container = params.container || opts.container;\n        var offset = opts.offset = params.offset || opts.offset;\n\n        for (var i = 0; i < instances.length; i++) {\n          if (instances[i].container === container) {\n            return instances[i].isInViewport(elt, offset, cb);\n          }\n        }\n\n        return instances[\n          instances.push(createInViewport(container)) - 1\n        ].isInViewport(elt, offset, cb);\n      }\n\n      function addEvent(el, type, fn) {\n        if (el.attachEvent) {\n          el.attachEvent('on' + type, fn);\n        } else {\n          el.addEventListener(type, fn, false);\n        }\n      }\n\n      function debounce(func, wait, immediate) {\n        var timeout;\n        return function() {\n          var context = this,\n            args = arguments;\n          var callNow = immediate && !timeout;\n          clearTimeout(timeout);\n          timeout = setTimeout(later, wait);\n          if (callNow) func.apply(context, args);\n\n          function later() {\n            timeout = null;\n            if (!immediate) func.apply(context, args);\n          }\n        };\n      }\n\n      // https://github.com/jquery/sizzle/blob/3136f48b90e3edc84cbaaa6f6f7734ef03775a07/sizzle.js#L708\n      var contains = function() {\n        if (!global.document) {\n          return true;\n        }\n        return global.document.documentElement.compareDocumentPosition ?\n          function(a, b) {\n            return !!(a.compareDocumentPosition(b) & 16);\n          } :\n          global.document.documentElement.contains ?\n          function(a, b) {\n            return a !== b && (a.contains ? a.contains(b) : false);\n          } :\n          function(a, b) {\n            while (b = b.parentNode) {\n              if (b === a) {\n                return true;\n              }\n            }\n            return false;\n          };\n      }\n\n      function createInViewport(container) {\n        var watches = createWatches();\n\n        var scrollContainer = container === global.document.body ? global : container;\n        var debouncedCheck = debounce(watches.checkAll(watchInViewport), 15);\n\n        addEvent(scrollContainer, 'scroll', debouncedCheck);\n\n        if (scrollContainer === global) {\n          addEvent(global, 'resize', debouncedCheck);\n        }\n\n        if (supportsMutationObserver) {\n          observeDOM(watches, container, debouncedCheck);\n        }\n\n        // failsafe check, every 200ms we check for visible images\n        // usecase: a hidden parent containing eleements\n        // when the parent becomes visible, we have no event that the children\n        // became visible\n        setInterval(debouncedCheck, 150);\n\n        function isInViewport(elt, offset, cb) {\n          if (!cb) {\n            return isVisible(elt, offset);\n          }\n\n          var remote = createRemote(elt, offset, cb);\n          remote.watch();\n          return remote;\n        }\n\n        function createRemote(elt, offset, cb) {\n          function watch() {\n            watches.add(elt, offset, cb);\n          }\n\n          function dispose() {\n            watches.remove(elt);\n          }\n\n          return {\n            watch: watch,\n            dispose: dispose\n          };\n        }\n\n        function watchInViewport(elt, offset, cb) {\n          if (isVisible(elt, offset)) {\n            watches.remove(elt);\n            cb(elt);\n          }\n        }\n\n        function isVisible(elt, offset) {\n          if (!contains(global.document.documentElement, elt) || !contains(global.document.documentElement, container)) {\n            return false;\n          }\n\n          // Check if the element is visible\n          // https://github.com/jquery/jquery/blob/740e190223d19a114d5373758127285d14d6b71e/src/css/hiddenVisibleSelectors.js\n          if (!elt.offsetWidth || !elt.offsetHeight) {\n            return false;\n          }\n\n          var eltRect = elt.getBoundingClientRect();\n          var viewport = {};\n\n          if (container === global.document.body) {\n            viewport = {\n              top: -offset,\n              left: -offset,\n              right: global.document.documentElement.clientWidth + offset,\n              bottom: global.document.documentElement.clientHeight + offset\n            };\n          } else {\n            var containerRect = container.getBoundingClientRect();\n            viewport = {\n              top: containerRect.top - offset,\n              left: containerRect.left - offset,\n              right: containerRect.right + offset,\n              bottom: containerRect.bottom + offset\n            };\n          }\n\n          // The element must overlap with the visible part of the viewport\n          var visible =\n            (\n              (eltRect.right > viewport.left) &&\n              (eltRect.left < viewport.right) &&\n              (eltRect.bottom > viewport.top) &&\n              (eltRect.top < viewport.bottom)\n            );\n\n          return visible;\n        }\n\n        return {\n          container: container,\n          isInViewport: isInViewport\n        };\n      }\n\n      function createWatches() {\n        var watches = [];\n\n        function add(elt, offset, cb) {\n          if (!isWatched(elt)) {\n            watches.push([elt, offset, cb]);\n          }\n        }\n\n        function remove(elt) {\n          var pos = indexOf(elt);\n          if (pos !== -1) {\n            watches.splice(pos, 1);\n          }\n        }\n\n        function indexOf(elt) {\n          for (var i = watches.length - 1; i >= 0; i--) {\n            if (watches[i][0] === elt) {\n              return i;\n            }\n          }\n          return -1;\n        }\n\n        function isWatched(elt) {\n          return indexOf(elt) !== -1;\n        }\n\n        function checkAll(cb) {\n          return function() {\n            for (var i = watches.length - 1; i >= 0; i--) {\n              cb.apply(this, watches[i]);\n            }\n          };\n        }\n\n        return {\n          add: add,\n          remove: remove,\n          isWatched: isWatched,\n          checkAll: checkAll\n        };\n      }\n\n      function observeDOM(watches, container, cb) {\n        var observer = new MutationObserver(watch);\n        var filter = Array.prototype.filter;\n        var concat = Array.prototype.concat;\n\n        observer.observe(container, {\n          childList: true,\n          subtree: true,\n          // changes like style/width/height/display will be catched\n          attributes: true\n        });\n\n        function watch(mutations) {\n          // some new DOM nodes where previously watched\n          // we should check their positions\n          if (mutations.some(knownNodes) === true) {\n            setTimeout(cb, 0);\n          }\n        }\n\n        function knownNodes(mutation) {\n          var nodes = concat.call([],\n            Array.prototype.slice.call(mutation.addedNodes),\n            mutation.target\n          );\n          return filter.call(nodes, watches.isWatched).length > 0;\n        }\n      }\n\n      /* WEBPACK VAR INJECTION */\n    }.call(exports, (function() {\n      return this;\n    }())))\n\n    /***/\n  }\n  /******/\n]);","date":"2021-03-28T10:52:14.224Z","updated":"2021-01-27T14:52:13.771Z","path":"blog-photo/ins.js","layout":"false","title":"","comments":1,"_id":"cl2enrqzs0012y2lofo8uarld","content":"/******/\n(function(modules) { // webpackBootstrap\n  /******/ // The module cache\n  /******/\n  var installedModules = {};\n  /******/\n  /******/ // The require function\n  /******/\n  function __webpack_require__(moduleId) {\n    /******/\n    /******/ // Check if module is in cache\n    /******/\n    if (installedModules[moduleId])\n    /******/\n      return installedModules[moduleId].exports;\n    /******/\n    /******/ // Create a new module (and put it into the cache)\n    /******/\n    var module = installedModules[moduleId] = {\n      /******/\n      exports: {},\n      /******/\n      id: moduleId,\n      /******/\n      loaded: false\n        /******/\n    };\n    /******/\n    /******/ // Execute the module function\n    /******/\n    modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n    /******/\n    /******/ // Flag the module as loaded\n    /******/\n    module.loaded = true;\n    /******/\n    /******/ // Return the exports of the module\n    /******/\n    return module.exports;\n    /******/\n  }\n  /******/\n  /******/\n  /******/ // expose the modules object (__webpack_modules__)\n  /******/\n  __webpack_require__.m = modules;\n  /******/\n  /******/ // expose the module cache\n  /******/\n  __webpack_require__.c = installedModules;\n  /******/\n  /******/ // __webpack_public_path__\n  /******/\n  __webpack_require__.p = \"/dist/\";\n  /******/\n  /******/ // Load entry module and return exports\n  /******/\n  return __webpack_require__(0);\n  /******/\n})\n/************************************************************************/\n/******/\n([\n  /* 0 */\n  /***/\n  function(module, exports, __webpack_require__) {\n\n    'use strict';\n\n    __webpack_require__(1);\n\n    var _view = __webpack_require__(2);\n\n    var _view2 = _interopRequireDefault(_view);\n\n    function _interopRequireDefault(obj) {\n      return obj && obj.__esModule ? obj : {\n        default: obj\n      };\n    }\n\n    /**\n     * @name impush-client \n     * @description 这个项目让我发家致富…\n     * @date 2016-12-1\n     */\n\n    var _collection = [];\n    var _count = 0;\n    var searchData;\n\n    function addMask(elem) {\n      var rect = elem.getBoundingClientRect();\n      var style = getComputedStyle(elem, null);\n\n      var mask = document.createElement('i');\n      mask.className = 'icon-film';\n      mask.style.color = '#fff';\n      mask.style.fontSize = '26px';\n      mask.style.position = 'absolute';\n      mask.style.right = '10px';\n      mask.style.bottom = '10px';\n      mask.style.zIndex = 1;\n      elem.parentNode.appendChild(mask);\n    }\n\n    var createVideoIncon = function createVideoIncon() {\n      var $videoImg = document.querySelectorAll('.thumb a[data-type=\"video\"]');\n      for (var i = 0, len = $videoImg.length; i < len; i++) {\n        addMask($videoImg[i]);\n      }\n    };\n\n\t// 修改这里render()函数：修改图片的路径地址.minSrc 小图的路径. src 大图的路径.修改为自己的图片路径(github的路径)\n\t// https://raw.githubusercontent.com/ChemLez/blog-Picture/master/photos/\n\t// https://raw.githubusercontent.com/ChemLez/blog-Picture/master/min_photos/\n    var render = function render(res) {\n      var ulTmpl = \"\";\n      for (var j = 0, len2 = res.list.length; j < len2; j++) {\n        var data = res.list[j].arr;\n        var liTmpl = \"\";\n        for (var i = 0, len = data.link.length; i < len; i++) {\n          var minSrc = 'https://raw.githubusercontent.com/yizhichangyuan/blog-photo/master/min_photos/' + data.link[i];\n          var src = 'https://raw.githubusercontent.com/yizhichangyuan/blog-photo/master/photos/' + data.link[i];\n          var type = data.type[i];\n          var target = src + (type === 'video' ? '.mp4' : '.jpg');\n          src += '';\n\n          liTmpl += '<figure class=\"thumb\" itemprop=\"associatedMedia\" itemscope itemtype=\"http://schema.org/ImageObject\">\\\n                <a href=\"' + src + '\" itemprop=\"contentUrl\" data-size=\"1080x1080\" data-type=\"' + type + '\" data-target=\"' + src + '\">\\\n                  <img class=\"reward-img\" data-type=\"' + type + '\" data-src=\"' + minSrc + '\" src=\"/blog-photo/ins.j/img/empty.png\" itemprop=\"thumbnail\" onload=\"lzld(this)\">\\\n                </a>\\\n                <figcaption style=\"display:none\" itemprop=\"caption description\">' + data.text[i] + '</figcaption>\\\n            </figure>';\n        }\n        ulTmpl = ulTmpl + '<section class=\"archives album\"><h1 class=\"year\">' + data.year + '年<em>' + data.month + '月</em></h1>\\\n        <ul class=\"img-box-ul\">' + liTmpl + '</ul>\\\n        </section>';\n      }\n      document.querySelector('.instagram').innerHTML = '<div class=\"photos\" itemscope itemtype=\"http://schema.org/ImageGallery\">' + ulTmpl + '</div>';\n      createVideoIncon();\n      _view2.default.init();\n    };\n\n    var replacer = function replacer(str) {\n      var arr = str.split(\"/\");\n      return \"/assets/ins/\" + arr[arr.length - 1];\n    };\n\n    var ctrler = function ctrler(data) {\n      var imgObj = {};\n      for (var i = 0, len = data.length; i < len; i++) {\n        var y = data[i].y;\n        var m = data[i].m;\n        var src = replacer(data[i].src);\n        var text = data[i].text;\n        var key = y + \"\" + ((m + \"\").length == 1 ? \"0\" + m : m);\n        if (imgObj[key]) {\n          imgObj[key].srclist.push(src);\n          imgObj[key].text.push(text);\n        } else {\n          imgObj[key] = {\n            year: y,\n            month: m,\n            srclist: [src],\n            text: [text]\n          };\n        }\n      }\n      render(imgObj);\n    };\n\n    function loadData(success) {\n      if (!searchData) {\n        var xhr = new XMLHttpRequest();\n        xhr.open('GET', './data.json?t=' + +new Date(), true);\n\n        xhr.onload = function() {\n          if (this.status >= 200 && this.status < 300) {\n            var res = JSON.parse(this.response);\n            searchData = res;\n            success(searchData);\n          } else {\n            console.error(this.statusText);\n          }\n        };\n\n        xhr.onerror = function() {\n          console.error(this.statusText);\n        };\n\n        xhr.send();\n      } else {\n        success(searchData);\n      }\n    }\n\n    var Ins = {\n      init: function init() {\n        loadData(function(data) {\n          render(data);\n        });\n      }\n    };\n\n    Ins.init();\n\n    // export default impush;\n\n    /***/\n  },\n  /* 1 */\n  /***/\n  function(module, exports, __webpack_require__) {\n\n    /* WEBPACK VAR INJECTION */\n    (function(global) {\n      'use strict';\n\n      var inViewport = __webpack_require__(3);\n      var lazyAttrs = ['data-src'];\n\n      global.lzld = lazyload();\n\n      // Provide libs using getAttribute early to get the good src\n      // and not the fake data-src\n      replaceGetAttribute('Image');\n      replaceGetAttribute('IFrame');\n\n      function registerLazyAttr(attr) {\n        if (indexOf.call(lazyAttrs, attr) === -1) {\n          lazyAttrs.push(attr);\n        }\n      }\n\n      function lazyload(opts) {\n        opts = merge({\n          'offset': 333,\n          'src': 'data-src',\n          'container': false\n        }, opts || {});\n\n        if (typeof opts.src === 'string') {\n          registerLazyAttr(opts.src);\n        }\n\n        var elts = [];\n\n        function show(elt) {\n          var src = findRealSrc(elt);\n\n          if (src) {\n            elt.src = src;\n          }\n\n          elt.setAttribute('data-lzled', true);\n          elts[indexOf.call(elts, elt)] = null;\n        }\n\n        function findRealSrc(elt) {\n          if (typeof opts.src === 'function') {\n            return opts.src(elt);\n          }\n\n          return elt.getAttribute(opts.src);\n        }\n\n        function register(elt) {\n          elt.onload = null;\n          elt.removeAttribute('onload');\n          elt.onerror = null;\n          elt.removeAttribute('onerror');\n\n          if (indexOf.call(elts, elt) === -1) {\n            inViewport(elt, opts, show);\n          }\n        }\n\n        return register;\n      }\n\n      function replaceGetAttribute(elementName) {\n        var fullname = 'HTML' + elementName + 'Element';\n        if (fullname in global === false) {\n          return;\n        }\n\n        var original = global[fullname].prototype.getAttribute;\n        global[fullname].prototype.getAttribute = function(name) {\n          if (name === 'src') {\n            var realSrc;\n            for (var i = 0, max = lazyAttrs.length; i < max; i++) {\n              realSrc = original.call(this, lazyAttrs[i]);\n              if (realSrc) {\n                break;\n              }\n            }\n\n            return realSrc || original.call(this, name);\n          }\n\n          // our own lazyloader will go through theses lines\n          // because we use getAttribute(opts.src)\n          return original.call(this, name);\n        };\n      }\n\n      function merge(defaults, opts) {\n        for (var name in defaults) {\n          if (opts[name] === undefined) {\n            opts[name] = defaults[name];\n          }\n        }\n\n        return opts;\n      }\n\n      // http://webreflection.blogspot.fr/2011/06/partial-polyfills.html\n      function indexOf(value) {\n        for (var i = this.length; i-- && this[i] !== value;) {}\n        return i;\n      }\n\n      module.exports = lazyload;\n\n      // export default impush;\n      /* WEBPACK VAR INJECTION */\n    }.call(exports, (function() {\n      return this;\n    }())))\n\n    /***/\n  },\n  /* 2 */\n  /***/\n  function(module, exports) {\n\n    'use strict';\n\n    var initPhotoSwipeFromDOM = function initPhotoSwipeFromDOM(gallerySelector) {\n\n      // parse slide data (url, title, size ...) from DOM elements \n      // (children of gallerySelector)\n      var parseThumbnailElements = function parseThumbnailElements(el) {\n        el = el.parentNode.parentNode;\n        var thumbElements = el.getElementsByClassName('thumb'),\n          numNodes = thumbElements.length,\n          items = [],\n          figureEl,\n          linkEl,\n          size,\n          type,\n          // video or not\n          target,\n          item;\n\n        for (var i = 0; i < numNodes; i++) {\n\n          figureEl = thumbElements[i]; // \n\n          // include only element nodes \n          if (figureEl.nodeType !== 1) {\n            continue;\n          }\n\n          linkEl = figureEl.children[0]; // \n\n          size = linkEl.getAttribute('data-size').split('x');\n          type = linkEl.getAttribute('data-type');\n          target = linkEl.getAttribute('data-target');\n          // create slide object\n          item = {\n            src: linkEl.getAttribute('href'),\n            w: parseInt(size[0], 10),\n            h: parseInt(size[1], 10)\n          };\n\n          if (figureEl.children.length > 1) {\n            item.title = figureEl.children[1].innerHTML;\n          }\n\n          if (linkEl.children.length > 0) {\n            item.msrc = linkEl.children[0].getAttribute('src');\n            item.type = type;\n            item.target = target;\n            item.html = '<video src=\"' + target + '\" controls=\"controls\" autoplay=\"autoplay\"></video>';\n            if (type === 'video') {\n              //item.src = null;\n            }\n          }\n\n          item.el = figureEl; // save link to element for getThumbBoundsFn\n          items.push(item);\n        }\n\n        return items;\n      };\n\n      // find nearest parent element\n      var closest = function closest(el, fn) {\n        return el && (fn(el) ? el : closest(el.parentNode, fn));\n      };\n\n      // triggers when user clicks on thumbnail\n      var onThumbnailsClick = function onThumbnailsClick(e) {\n        e = e || window.event;\n        e.preventDefault ? e.preventDefault() : e.returnValue = false;\n\n        var eTarget = e.target || e.srcElement;\n\n        // find root element of slide\n        var clickedListItem = closest(eTarget, function(el) {\n          return el.tagName && el.tagName.toUpperCase() === 'FIGURE';\n        });\n\n        if (!clickedListItem) {\n          return;\n        }\n\n        // find index of clicked item by looping through all child nodes\n        // alternatively, you may define index via data- attribute\n        var clickedGallery = clickedListItem.parentNode,\n\n          // childNodes = clickedListItem.parentNode.childNodes,\n          // numChildNodes = childNodes.length,\n          childNodes = document.getElementsByClassName('thumb'),\n          numChildNodes = childNodes.length,\n          nodeIndex = 0,\n          index;\n\n        for (var i = 0; i < numChildNodes; i++) {\n          if (childNodes[i].nodeType !== 1) {\n            continue;\n          }\n\n          if (childNodes[i] === clickedListItem) {\n            index = nodeIndex;\n            break;\n          }\n          nodeIndex++;\n        }\n\n        if (index >= 0) {\n          // open PhotoSwipe if valid index found\n          openPhotoSwipe(index, clickedGallery);\n        }\n        return false;\n      };\n\n      // parse picture index and gallery index from URL (#&pid=1&gid=2)\n      var photoswipeParseHash = function photoswipeParseHash() {\n        var hash = window.location.hash.substring(1),\n          params = {};\n\n        if (hash.length < 5) {\n          return params;\n        }\n\n        var vars = hash.split('&');\n        for (var i = 0; i < vars.length; i++) {\n          if (!vars[i]) {\n            continue;\n          }\n          var pair = vars[i].split('=');\n          if (pair.length < 2) {\n            continue;\n          }\n          params[pair[0]] = pair[1];\n        }\n\n        if (params.gid) {\n          params.gid = parseInt(params.gid, 10);\n        }\n\n        return params;\n      };\n\n      var openPhotoSwipe = function openPhotoSwipe(index, galleryElement, disableAnimation, fromURL) {\n        var pswpElement = document.querySelectorAll('.pswp')[0],\n          gallery,\n          options,\n          items;\n\n        items = parseThumbnailElements(galleryElement);\n        // define options (if needed)\n        options = {\n\n          // define gallery index (for URL)\n          galleryUID: galleryElement.getAttribute('data-pswp-uid'),\n\n          getThumbBoundsFn: function getThumbBoundsFn(index) {\n            // See Options -> getThumbBoundsFn section of documentation for more info\n            var thumbnail = items[index].el.getElementsByTagName('img')[0],\n              // find thumbnail\n              pageYScroll = window.pageYOffset || document.documentElement.scrollTop,\n              rect = thumbnail.getBoundingClientRect();\n\n            return {\n              x: rect.left,\n              y: rect.top + pageYScroll,\n              w: rect.width\n            };\n          }\n\n        };\n\n        // PhotoSwipe opened from URL\n        if (fromURL) {\n          if (options.galleryPIDs) {\n            // parse real index when custom PIDs are used \n            // http://photoswipe.com/documentation/faq.html#custom-pid-in-url\n            for (var j = 0; j < items.length; j++) {\n              if (items[j].pid == index) {\n                options.index = j;\n                break;\n              }\n            }\n          } else {\n            // in URL indexes start from 1\n            options.index = parseInt(index, 10) - 1;\n          }\n        } else {\n          options.index = parseInt(index, 10);\n        }\n\n        // exit if index not found\n        if (isNaN(options.index)) {\n          return;\n        }\n\n        if (disableAnimation) {\n          options.showAnimationDuration = 0;\n        }\n\n        // Pass data to PhotoSwipe and initialize it\n        gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, options);\n        gallery.init();\n\n        var $tempVideo;\n        var stopVideoHandle = function stopVideoHandle() {\n          if ($tempVideo) {\n            $tempVideo.remove();\n            $tempVideo = null;\n          }\n        };\n        var changeHandle = function changeHandle() {\n          var item = gallery.currItem;\n          stopVideoHandle();\n          if (item.type === 'video') {\n            var $ctn = item.container;\n            var style = $ctn.getElementsByClassName('pswp__img')[0].style;\n            var $video = document.createElement('video');\n            $video.setAttribute('autoplay', 'autoplay');\n            $video.setAttribute('controls', 'controls');\n            $video.setAttribute('src', item.target);\n            $video.style.width = style.width;\n            $video.style.height = style.height;\n            $video.style.position = 'absolute';\n            $video.style.zIndex = 2;\n            $tempVideo = $video;\n            $ctn.appendChild($video);\n          }\n        };\n        gallery.listen('initialZoomIn', changeHandle);\n        gallery.listen('afterChange', changeHandle);\n        gallery.listen('initialZoomOut', stopVideoHandle);\n      };\n\n      // loop through all gallery elements and bind events\n      var galleryElements = document.querySelectorAll(gallerySelector);\n      for (var i = 0, l = galleryElements.length; i < l; i++) {\n        galleryElements[i].setAttribute('data-pswp-uid', i + 1);\n        galleryElements[i].onclick = onThumbnailsClick;\n      }\n\n      // Parse URL and open gallery if it contains #&pid=3&gid=1\n      var hashData = photoswipeParseHash();\n      if (hashData.pid && hashData.gid) {\n        openPhotoSwipe(hashData.pid, galleryElements[hashData.gid - 1], true, true);\n      }\n    };\n\n    var Viewer = function() {\n      function init() {\n        initPhotoSwipeFromDOM('.photos');\n      }\n      return {\n        init: init\n      };\n    }();\n\n    module.exports = Viewer;\n\n    /***/\n  },\n  /* 3 */\n  /***/\n  function(module, exports) {\n\n    /* WEBPACK VAR INJECTION */\n    (function(global) {\n      module.exports = inViewport;\n\n      var instances = [];\n      var supportsMutationObserver = typeof global.MutationObserver === 'function';\n\n      function inViewport(elt, params, cb) {\n        var opts = {\n          container: global.document.body,\n          offset: 0\n        };\n\n        if (params === undefined || typeof params === 'function') {\n          cb = params;\n          params = {};\n        }\n\n        var container = opts.container = params.container || opts.container;\n        var offset = opts.offset = params.offset || opts.offset;\n\n        for (var i = 0; i < instances.length; i++) {\n          if (instances[i].container === container) {\n            return instances[i].isInViewport(elt, offset, cb);\n          }\n        }\n\n        return instances[\n          instances.push(createInViewport(container)) - 1\n        ].isInViewport(elt, offset, cb);\n      }\n\n      function addEvent(el, type, fn) {\n        if (el.attachEvent) {\n          el.attachEvent('on' + type, fn);\n        } else {\n          el.addEventListener(type, fn, false);\n        }\n      }\n\n      function debounce(func, wait, immediate) {\n        var timeout;\n        return function() {\n          var context = this,\n            args = arguments;\n          var callNow = immediate && !timeout;\n          clearTimeout(timeout);\n          timeout = setTimeout(later, wait);\n          if (callNow) func.apply(context, args);\n\n          function later() {\n            timeout = null;\n            if (!immediate) func.apply(context, args);\n          }\n        };\n      }\n\n      // https://github.com/jquery/sizzle/blob/3136f48b90e3edc84cbaaa6f6f7734ef03775a07/sizzle.js#L708\n      var contains = function() {\n        if (!global.document) {\n          return true;\n        }\n        return global.document.documentElement.compareDocumentPosition ?\n          function(a, b) {\n            return !!(a.compareDocumentPosition(b) & 16);\n          } :\n          global.document.documentElement.contains ?\n          function(a, b) {\n            return a !== b && (a.contains ? a.contains(b) : false);\n          } :\n          function(a, b) {\n            while (b = b.parentNode) {\n              if (b === a) {\n                return true;\n              }\n            }\n            return false;\n          };\n      }\n\n      function createInViewport(container) {\n        var watches = createWatches();\n\n        var scrollContainer = container === global.document.body ? global : container;\n        var debouncedCheck = debounce(watches.checkAll(watchInViewport), 15);\n\n        addEvent(scrollContainer, 'scroll', debouncedCheck);\n\n        if (scrollContainer === global) {\n          addEvent(global, 'resize', debouncedCheck);\n        }\n\n        if (supportsMutationObserver) {\n          observeDOM(watches, container, debouncedCheck);\n        }\n\n        // failsafe check, every 200ms we check for visible images\n        // usecase: a hidden parent containing eleements\n        // when the parent becomes visible, we have no event that the children\n        // became visible\n        setInterval(debouncedCheck, 150);\n\n        function isInViewport(elt, offset, cb) {\n          if (!cb) {\n            return isVisible(elt, offset);\n          }\n\n          var remote = createRemote(elt, offset, cb);\n          remote.watch();\n          return remote;\n        }\n\n        function createRemote(elt, offset, cb) {\n          function watch() {\n            watches.add(elt, offset, cb);\n          }\n\n          function dispose() {\n            watches.remove(elt);\n          }\n\n          return {\n            watch: watch,\n            dispose: dispose\n          };\n        }\n\n        function watchInViewport(elt, offset, cb) {\n          if (isVisible(elt, offset)) {\n            watches.remove(elt);\n            cb(elt);\n          }\n        }\n\n        function isVisible(elt, offset) {\n          if (!contains(global.document.documentElement, elt) || !contains(global.document.documentElement, container)) {\n            return false;\n          }\n\n          // Check if the element is visible\n          // https://github.com/jquery/jquery/blob/740e190223d19a114d5373758127285d14d6b71e/src/css/hiddenVisibleSelectors.js\n          if (!elt.offsetWidth || !elt.offsetHeight) {\n            return false;\n          }\n\n          var eltRect = elt.getBoundingClientRect();\n          var viewport = {};\n\n          if (container === global.document.body) {\n            viewport = {\n              top: -offset,\n              left: -offset,\n              right: global.document.documentElement.clientWidth + offset,\n              bottom: global.document.documentElement.clientHeight + offset\n            };\n          } else {\n            var containerRect = container.getBoundingClientRect();\n            viewport = {\n              top: containerRect.top - offset,\n              left: containerRect.left - offset,\n              right: containerRect.right + offset,\n              bottom: containerRect.bottom + offset\n            };\n          }\n\n          // The element must overlap with the visible part of the viewport\n          var visible =\n            (\n              (eltRect.right > viewport.left) &&\n              (eltRect.left < viewport.right) &&\n              (eltRect.bottom > viewport.top) &&\n              (eltRect.top < viewport.bottom)\n            );\n\n          return visible;\n        }\n\n        return {\n          container: container,\n          isInViewport: isInViewport\n        };\n      }\n\n      function createWatches() {\n        var watches = [];\n\n        function add(elt, offset, cb) {\n          if (!isWatched(elt)) {\n            watches.push([elt, offset, cb]);\n          }\n        }\n\n        function remove(elt) {\n          var pos = indexOf(elt);\n          if (pos !== -1) {\n            watches.splice(pos, 1);\n          }\n        }\n\n        function indexOf(elt) {\n          for (var i = watches.length - 1; i >= 0; i--) {\n            if (watches[i][0] === elt) {\n              return i;\n            }\n          }\n          return -1;\n        }\n\n        function isWatched(elt) {\n          return indexOf(elt) !== -1;\n        }\n\n        function checkAll(cb) {\n          return function() {\n            for (var i = watches.length - 1; i >= 0; i--) {\n              cb.apply(this, watches[i]);\n            }\n          };\n        }\n\n        return {\n          add: add,\n          remove: remove,\n          isWatched: isWatched,\n          checkAll: checkAll\n        };\n      }\n\n      function observeDOM(watches, container, cb) {\n        var observer = new MutationObserver(watch);\n        var filter = Array.prototype.filter;\n        var concat = Array.prototype.concat;\n\n        observer.observe(container, {\n          childList: true,\n          subtree: true,\n          // changes like style/width/height/display will be catched\n          attributes: true\n        });\n\n        function watch(mutations) {\n          // some new DOM nodes where previously watched\n          // we should check their positions\n          if (mutations.some(knownNodes) === true) {\n            setTimeout(cb, 0);\n          }\n        }\n\n        function knownNodes(mutation) {\n          var nodes = concat.call([],\n            Array.prototype.slice.call(mutation.addedNodes),\n            mutation.target\n          );\n          return filter.call(nodes, watches.isWatched).length > 0;\n        }\n      }\n\n      /* WEBPACK VAR INJECTION */\n    }.call(exports, (function() {\n      return this;\n    }())))\n\n    /***/\n  }\n  /******/\n]);","site":{"data":{"photography":[{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","title":"玉渊潭","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","title":"花儿","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","title":"白塔寺","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"}]}},"excerpt":"","more":"/******/\n(function(modules) { // webpackBootstrap\n  /******/ // The module cache\n  /******/\n  var installedModules = {};\n  /******/\n  /******/ // The require function\n  /******/\n  function __webpack_require__(moduleId) {\n    /******/\n    /******/ // Check if module is in cache\n    /******/\n    if (installedModules[moduleId])\n    /******/\n      return installedModules[moduleId].exports;\n    /******/\n    /******/ // Create a new module (and put it into the cache)\n    /******/\n    var module = installedModules[moduleId] = {\n      /******/\n      exports: {},\n      /******/\n      id: moduleId,\n      /******/\n      loaded: false\n        /******/\n    };\n    /******/\n    /******/ // Execute the module function\n    /******/\n    modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n    /******/\n    /******/ // Flag the module as loaded\n    /******/\n    module.loaded = true;\n    /******/\n    /******/ // Return the exports of the module\n    /******/\n    return module.exports;\n    /******/\n  }\n  /******/\n  /******/\n  /******/ // expose the modules object (__webpack_modules__)\n  /******/\n  __webpack_require__.m = modules;\n  /******/\n  /******/ // expose the module cache\n  /******/\n  __webpack_require__.c = installedModules;\n  /******/\n  /******/ // __webpack_public_path__\n  /******/\n  __webpack_require__.p = \"/dist/\";\n  /******/\n  /******/ // Load entry module and return exports\n  /******/\n  return __webpack_require__(0);\n  /******/\n})\n/************************************************************************/\n/******/\n([\n  /* 0 */\n  /***/\n  function(module, exports, __webpack_require__) {\n\n    'use strict';\n\n    __webpack_require__(1);\n\n    var _view = __webpack_require__(2);\n\n    var _view2 = _interopRequireDefault(_view);\n\n    function _interopRequireDefault(obj) {\n      return obj && obj.__esModule ? obj : {\n        default: obj\n      };\n    }\n\n    /**\n     * @name impush-client \n     * @description 这个项目让我发家致富…\n     * @date 2016-12-1\n     */\n\n    var _collection = [];\n    var _count = 0;\n    var searchData;\n\n    function addMask(elem) {\n      var rect = elem.getBoundingClientRect();\n      var style = getComputedStyle(elem, null);\n\n      var mask = document.createElement('i');\n      mask.className = 'icon-film';\n      mask.style.color = '#fff';\n      mask.style.fontSize = '26px';\n      mask.style.position = 'absolute';\n      mask.style.right = '10px';\n      mask.style.bottom = '10px';\n      mask.style.zIndex = 1;\n      elem.parentNode.appendChild(mask);\n    }\n\n    var createVideoIncon = function createVideoIncon() {\n      var $videoImg = document.querySelectorAll('.thumb a[data-type=\"video\"]');\n      for (var i = 0, len = $videoImg.length; i < len; i++) {\n        addMask($videoImg[i]);\n      }\n    };\n\n\t// 修改这里render()函数：修改图片的路径地址.minSrc 小图的路径. src 大图的路径.修改为自己的图片路径(github的路径)\n\t// https://raw.githubusercontent.com/ChemLez/blog-Picture/master/photos/\n\t// https://raw.githubusercontent.com/ChemLez/blog-Picture/master/min_photos/\n    var render = function render(res) {\n      var ulTmpl = \"\";\n      for (var j = 0, len2 = res.list.length; j < len2; j++) {\n        var data = res.list[j].arr;\n        var liTmpl = \"\";\n        for (var i = 0, len = data.link.length; i < len; i++) {\n          var minSrc = 'https://raw.githubusercontent.com/yizhichangyuan/blog-photo/master/min_photos/' + data.link[i];\n          var src = 'https://raw.githubusercontent.com/yizhichangyuan/blog-photo/master/photos/' + data.link[i];\n          var type = data.type[i];\n          var target = src + (type === 'video' ? '.mp4' : '.jpg');\n          src += '';\n\n          liTmpl += '<figure class=\"thumb\" itemprop=\"associatedMedia\" itemscope itemtype=\"http://schema.org/ImageObject\">\\\n                <a href=\"' + src + '\" itemprop=\"contentUrl\" data-size=\"1080x1080\" data-type=\"' + type + '\" data-target=\"' + src + '\">\\\n                  <img class=\"reward-img\" data-type=\"' + type + '\" data-src=\"' + minSrc + '\" src=\"/blog-photo/ins.j/img/empty.png\" itemprop=\"thumbnail\" onload=\"lzld(this)\">\\\n                </a>\\\n                <figcaption style=\"display:none\" itemprop=\"caption description\">' + data.text[i] + '</figcaption>\\\n            </figure>';\n        }\n        ulTmpl = ulTmpl + '<section class=\"archives album\"><h1 class=\"year\">' + data.year + '年<em>' + data.month + '月</em></h1>\\\n        <ul class=\"img-box-ul\">' + liTmpl + '</ul>\\\n        </section>';\n      }\n      document.querySelector('.instagram').innerHTML = '<div class=\"photos\" itemscope itemtype=\"http://schema.org/ImageGallery\">' + ulTmpl + '</div>';\n      createVideoIncon();\n      _view2.default.init();\n    };\n\n    var replacer = function replacer(str) {\n      var arr = str.split(\"/\");\n      return \"/assets/ins/\" + arr[arr.length - 1];\n    };\n\n    var ctrler = function ctrler(data) {\n      var imgObj = {};\n      for (var i = 0, len = data.length; i < len; i++) {\n        var y = data[i].y;\n        var m = data[i].m;\n        var src = replacer(data[i].src);\n        var text = data[i].text;\n        var key = y + \"\" + ((m + \"\").length == 1 ? \"0\" + m : m);\n        if (imgObj[key]) {\n          imgObj[key].srclist.push(src);\n          imgObj[key].text.push(text);\n        } else {\n          imgObj[key] = {\n            year: y,\n            month: m,\n            srclist: [src],\n            text: [text]\n          };\n        }\n      }\n      render(imgObj);\n    };\n\n    function loadData(success) {\n      if (!searchData) {\n        var xhr = new XMLHttpRequest();\n        xhr.open('GET', './data.json?t=' + +new Date(), true);\n\n        xhr.onload = function() {\n          if (this.status >= 200 && this.status < 300) {\n            var res = JSON.parse(this.response);\n            searchData = res;\n            success(searchData);\n          } else {\n            console.error(this.statusText);\n          }\n        };\n\n        xhr.onerror = function() {\n          console.error(this.statusText);\n        };\n\n        xhr.send();\n      } else {\n        success(searchData);\n      }\n    }\n\n    var Ins = {\n      init: function init() {\n        loadData(function(data) {\n          render(data);\n        });\n      }\n    };\n\n    Ins.init();\n\n    // export default impush;\n\n    /***/\n  },\n  /* 1 */\n  /***/\n  function(module, exports, __webpack_require__) {\n\n    /* WEBPACK VAR INJECTION */\n    (function(global) {\n      'use strict';\n\n      var inViewport = __webpack_require__(3);\n      var lazyAttrs = ['data-src'];\n\n      global.lzld = lazyload();\n\n      // Provide libs using getAttribute early to get the good src\n      // and not the fake data-src\n      replaceGetAttribute('Image');\n      replaceGetAttribute('IFrame');\n\n      function registerLazyAttr(attr) {\n        if (indexOf.call(lazyAttrs, attr) === -1) {\n          lazyAttrs.push(attr);\n        }\n      }\n\n      function lazyload(opts) {\n        opts = merge({\n          'offset': 333,\n          'src': 'data-src',\n          'container': false\n        }, opts || {});\n\n        if (typeof opts.src === 'string') {\n          registerLazyAttr(opts.src);\n        }\n\n        var elts = [];\n\n        function show(elt) {\n          var src = findRealSrc(elt);\n\n          if (src) {\n            elt.src = src;\n          }\n\n          elt.setAttribute('data-lzled', true);\n          elts[indexOf.call(elts, elt)] = null;\n        }\n\n        function findRealSrc(elt) {\n          if (typeof opts.src === 'function') {\n            return opts.src(elt);\n          }\n\n          return elt.getAttribute(opts.src);\n        }\n\n        function register(elt) {\n          elt.onload = null;\n          elt.removeAttribute('onload');\n          elt.onerror = null;\n          elt.removeAttribute('onerror');\n\n          if (indexOf.call(elts, elt) === -1) {\n            inViewport(elt, opts, show);\n          }\n        }\n\n        return register;\n      }\n\n      function replaceGetAttribute(elementName) {\n        var fullname = 'HTML' + elementName + 'Element';\n        if (fullname in global === false) {\n          return;\n        }\n\n        var original = global[fullname].prototype.getAttribute;\n        global[fullname].prototype.getAttribute = function(name) {\n          if (name === 'src') {\n            var realSrc;\n            for (var i = 0, max = lazyAttrs.length; i < max; i++) {\n              realSrc = original.call(this, lazyAttrs[i]);\n              if (realSrc) {\n                break;\n              }\n            }\n\n            return realSrc || original.call(this, name);\n          }\n\n          // our own lazyloader will go through theses lines\n          // because we use getAttribute(opts.src)\n          return original.call(this, name);\n        };\n      }\n\n      function merge(defaults, opts) {\n        for (var name in defaults) {\n          if (opts[name] === undefined) {\n            opts[name] = defaults[name];\n          }\n        }\n\n        return opts;\n      }\n\n      // http://webreflection.blogspot.fr/2011/06/partial-polyfills.html\n      function indexOf(value) {\n        for (var i = this.length; i-- && this[i] !== value;) {}\n        return i;\n      }\n\n      module.exports = lazyload;\n\n      // export default impush;\n      /* WEBPACK VAR INJECTION */\n    }.call(exports, (function() {\n      return this;\n    }())))\n\n    /***/\n  },\n  /* 2 */\n  /***/\n  function(module, exports) {\n\n    'use strict';\n\n    var initPhotoSwipeFromDOM = function initPhotoSwipeFromDOM(gallerySelector) {\n\n      // parse slide data (url, title, size ...) from DOM elements \n      // (children of gallerySelector)\n      var parseThumbnailElements = function parseThumbnailElements(el) {\n        el = el.parentNode.parentNode;\n        var thumbElements = el.getElementsByClassName('thumb'),\n          numNodes = thumbElements.length,\n          items = [],\n          figureEl,\n          linkEl,\n          size,\n          type,\n          // video or not\n          target,\n          item;\n\n        for (var i = 0; i < numNodes; i++) {\n\n          figureEl = thumbElements[i]; // \n\n          // include only element nodes \n          if (figureEl.nodeType !== 1) {\n            continue;\n          }\n\n          linkEl = figureEl.children[0]; // \n\n          size = linkEl.getAttribute('data-size').split('x');\n          type = linkEl.getAttribute('data-type');\n          target = linkEl.getAttribute('data-target');\n          // create slide object\n          item = {\n            src: linkEl.getAttribute('href'),\n            w: parseInt(size[0], 10),\n            h: parseInt(size[1], 10)\n          };\n\n          if (figureEl.children.length > 1) {\n            item.title = figureEl.children[1].innerHTML;\n          }\n\n          if (linkEl.children.length > 0) {\n            item.msrc = linkEl.children[0].getAttribute('src');\n            item.type = type;\n            item.target = target;\n            item.html = '<video src=\"' + target + '\" controls=\"controls\" autoplay=\"autoplay\"></video>';\n            if (type === 'video') {\n              //item.src = null;\n            }\n          }\n\n          item.el = figureEl; // save link to element for getThumbBoundsFn\n          items.push(item);\n        }\n\n        return items;\n      };\n\n      // find nearest parent element\n      var closest = function closest(el, fn) {\n        return el && (fn(el) ? el : closest(el.parentNode, fn));\n      };\n\n      // triggers when user clicks on thumbnail\n      var onThumbnailsClick = function onThumbnailsClick(e) {\n        e = e || window.event;\n        e.preventDefault ? e.preventDefault() : e.returnValue = false;\n\n        var eTarget = e.target || e.srcElement;\n\n        // find root element of slide\n        var clickedListItem = closest(eTarget, function(el) {\n          return el.tagName && el.tagName.toUpperCase() === 'FIGURE';\n        });\n\n        if (!clickedListItem) {\n          return;\n        }\n\n        // find index of clicked item by looping through all child nodes\n        // alternatively, you may define index via data- attribute\n        var clickedGallery = clickedListItem.parentNode,\n\n          // childNodes = clickedListItem.parentNode.childNodes,\n          // numChildNodes = childNodes.length,\n          childNodes = document.getElementsByClassName('thumb'),\n          numChildNodes = childNodes.length,\n          nodeIndex = 0,\n          index;\n\n        for (var i = 0; i < numChildNodes; i++) {\n          if (childNodes[i].nodeType !== 1) {\n            continue;\n          }\n\n          if (childNodes[i] === clickedListItem) {\n            index = nodeIndex;\n            break;\n          }\n          nodeIndex++;\n        }\n\n        if (index >= 0) {\n          // open PhotoSwipe if valid index found\n          openPhotoSwipe(index, clickedGallery);\n        }\n        return false;\n      };\n\n      // parse picture index and gallery index from URL (#&pid=1&gid=2)\n      var photoswipeParseHash = function photoswipeParseHash() {\n        var hash = window.location.hash.substring(1),\n          params = {};\n\n        if (hash.length < 5) {\n          return params;\n        }\n\n        var vars = hash.split('&');\n        for (var i = 0; i < vars.length; i++) {\n          if (!vars[i]) {\n            continue;\n          }\n          var pair = vars[i].split('=');\n          if (pair.length < 2) {\n            continue;\n          }\n          params[pair[0]] = pair[1];\n        }\n\n        if (params.gid) {\n          params.gid = parseInt(params.gid, 10);\n        }\n\n        return params;\n      };\n\n      var openPhotoSwipe = function openPhotoSwipe(index, galleryElement, disableAnimation, fromURL) {\n        var pswpElement = document.querySelectorAll('.pswp')[0],\n          gallery,\n          options,\n          items;\n\n        items = parseThumbnailElements(galleryElement);\n        // define options (if needed)\n        options = {\n\n          // define gallery index (for URL)\n          galleryUID: galleryElement.getAttribute('data-pswp-uid'),\n\n          getThumbBoundsFn: function getThumbBoundsFn(index) {\n            // See Options -> getThumbBoundsFn section of documentation for more info\n            var thumbnail = items[index].el.getElementsByTagName('img')[0],\n              // find thumbnail\n              pageYScroll = window.pageYOffset || document.documentElement.scrollTop,\n              rect = thumbnail.getBoundingClientRect();\n\n            return {\n              x: rect.left,\n              y: rect.top + pageYScroll,\n              w: rect.width\n            };\n          }\n\n        };\n\n        // PhotoSwipe opened from URL\n        if (fromURL) {\n          if (options.galleryPIDs) {\n            // parse real index when custom PIDs are used \n            // http://photoswipe.com/documentation/faq.html#custom-pid-in-url\n            for (var j = 0; j < items.length; j++) {\n              if (items[j].pid == index) {\n                options.index = j;\n                break;\n              }\n            }\n          } else {\n            // in URL indexes start from 1\n            options.index = parseInt(index, 10) - 1;\n          }\n        } else {\n          options.index = parseInt(index, 10);\n        }\n\n        // exit if index not found\n        if (isNaN(options.index)) {\n          return;\n        }\n\n        if (disableAnimation) {\n          options.showAnimationDuration = 0;\n        }\n\n        // Pass data to PhotoSwipe and initialize it\n        gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, options);\n        gallery.init();\n\n        var $tempVideo;\n        var stopVideoHandle = function stopVideoHandle() {\n          if ($tempVideo) {\n            $tempVideo.remove();\n            $tempVideo = null;\n          }\n        };\n        var changeHandle = function changeHandle() {\n          var item = gallery.currItem;\n          stopVideoHandle();\n          if (item.type === 'video') {\n            var $ctn = item.container;\n            var style = $ctn.getElementsByClassName('pswp__img')[0].style;\n            var $video = document.createElement('video');\n            $video.setAttribute('autoplay', 'autoplay');\n            $video.setAttribute('controls', 'controls');\n            $video.setAttribute('src', item.target);\n            $video.style.width = style.width;\n            $video.style.height = style.height;\n            $video.style.position = 'absolute';\n            $video.style.zIndex = 2;\n            $tempVideo = $video;\n            $ctn.appendChild($video);\n          }\n        };\n        gallery.listen('initialZoomIn', changeHandle);\n        gallery.listen('afterChange', changeHandle);\n        gallery.listen('initialZoomOut', stopVideoHandle);\n      };\n\n      // loop through all gallery elements and bind events\n      var galleryElements = document.querySelectorAll(gallerySelector);\n      for (var i = 0, l = galleryElements.length; i < l; i++) {\n        galleryElements[i].setAttribute('data-pswp-uid', i + 1);\n        galleryElements[i].onclick = onThumbnailsClick;\n      }\n\n      // Parse URL and open gallery if it contains #&pid=3&gid=1\n      var hashData = photoswipeParseHash();\n      if (hashData.pid && hashData.gid) {\n        openPhotoSwipe(hashData.pid, galleryElements[hashData.gid - 1], true, true);\n      }\n    };\n\n    var Viewer = function() {\n      function init() {\n        initPhotoSwipeFromDOM('.photos');\n      }\n      return {\n        init: init\n      };\n    }();\n\n    module.exports = Viewer;\n\n    /***/\n  },\n  /* 3 */\n  /***/\n  function(module, exports) {\n\n    /* WEBPACK VAR INJECTION */\n    (function(global) {\n      module.exports = inViewport;\n\n      var instances = [];\n      var supportsMutationObserver = typeof global.MutationObserver === 'function';\n\n      function inViewport(elt, params, cb) {\n        var opts = {\n          container: global.document.body,\n          offset: 0\n        };\n\n        if (params === undefined || typeof params === 'function') {\n          cb = params;\n          params = {};\n        }\n\n        var container = opts.container = params.container || opts.container;\n        var offset = opts.offset = params.offset || opts.offset;\n\n        for (var i = 0; i < instances.length; i++) {\n          if (instances[i].container === container) {\n            return instances[i].isInViewport(elt, offset, cb);\n          }\n        }\n\n        return instances[\n          instances.push(createInViewport(container)) - 1\n        ].isInViewport(elt, offset, cb);\n      }\n\n      function addEvent(el, type, fn) {\n        if (el.attachEvent) {\n          el.attachEvent('on' + type, fn);\n        } else {\n          el.addEventListener(type, fn, false);\n        }\n      }\n\n      function debounce(func, wait, immediate) {\n        var timeout;\n        return function() {\n          var context = this,\n            args = arguments;\n          var callNow = immediate && !timeout;\n          clearTimeout(timeout);\n          timeout = setTimeout(later, wait);\n          if (callNow) func.apply(context, args);\n\n          function later() {\n            timeout = null;\n            if (!immediate) func.apply(context, args);\n          }\n        };\n      }\n\n      // https://github.com/jquery/sizzle/blob/3136f48b90e3edc84cbaaa6f6f7734ef03775a07/sizzle.js#L708\n      var contains = function() {\n        if (!global.document) {\n          return true;\n        }\n        return global.document.documentElement.compareDocumentPosition ?\n          function(a, b) {\n            return !!(a.compareDocumentPosition(b) & 16);\n          } :\n          global.document.documentElement.contains ?\n          function(a, b) {\n            return a !== b && (a.contains ? a.contains(b) : false);\n          } :\n          function(a, b) {\n            while (b = b.parentNode) {\n              if (b === a) {\n                return true;\n              }\n            }\n            return false;\n          };\n      }\n\n      function createInViewport(container) {\n        var watches = createWatches();\n\n        var scrollContainer = container === global.document.body ? global : container;\n        var debouncedCheck = debounce(watches.checkAll(watchInViewport), 15);\n\n        addEvent(scrollContainer, 'scroll', debouncedCheck);\n\n        if (scrollContainer === global) {\n          addEvent(global, 'resize', debouncedCheck);\n        }\n\n        if (supportsMutationObserver) {\n          observeDOM(watches, container, debouncedCheck);\n        }\n\n        // failsafe check, every 200ms we check for visible images\n        // usecase: a hidden parent containing eleements\n        // when the parent becomes visible, we have no event that the children\n        // became visible\n        setInterval(debouncedCheck, 150);\n\n        function isInViewport(elt, offset, cb) {\n          if (!cb) {\n            return isVisible(elt, offset);\n          }\n\n          var remote = createRemote(elt, offset, cb);\n          remote.watch();\n          return remote;\n        }\n\n        function createRemote(elt, offset, cb) {\n          function watch() {\n            watches.add(elt, offset, cb);\n          }\n\n          function dispose() {\n            watches.remove(elt);\n          }\n\n          return {\n            watch: watch,\n            dispose: dispose\n          };\n        }\n\n        function watchInViewport(elt, offset, cb) {\n          if (isVisible(elt, offset)) {\n            watches.remove(elt);\n            cb(elt);\n          }\n        }\n\n        function isVisible(elt, offset) {\n          if (!contains(global.document.documentElement, elt) || !contains(global.document.documentElement, container)) {\n            return false;\n          }\n\n          // Check if the element is visible\n          // https://github.com/jquery/jquery/blob/740e190223d19a114d5373758127285d14d6b71e/src/css/hiddenVisibleSelectors.js\n          if (!elt.offsetWidth || !elt.offsetHeight) {\n            return false;\n          }\n\n          var eltRect = elt.getBoundingClientRect();\n          var viewport = {};\n\n          if (container === global.document.body) {\n            viewport = {\n              top: -offset,\n              left: -offset,\n              right: global.document.documentElement.clientWidth + offset,\n              bottom: global.document.documentElement.clientHeight + offset\n            };\n          } else {\n            var containerRect = container.getBoundingClientRect();\n            viewport = {\n              top: containerRect.top - offset,\n              left: containerRect.left - offset,\n              right: containerRect.right + offset,\n              bottom: containerRect.bottom + offset\n            };\n          }\n\n          // The element must overlap with the visible part of the viewport\n          var visible =\n            (\n              (eltRect.right > viewport.left) &&\n              (eltRect.left < viewport.right) &&\n              (eltRect.bottom > viewport.top) &&\n              (eltRect.top < viewport.bottom)\n            );\n\n          return visible;\n        }\n\n        return {\n          container: container,\n          isInViewport: isInViewport\n        };\n      }\n\n      function createWatches() {\n        var watches = [];\n\n        function add(elt, offset, cb) {\n          if (!isWatched(elt)) {\n            watches.push([elt, offset, cb]);\n          }\n        }\n\n        function remove(elt) {\n          var pos = indexOf(elt);\n          if (pos !== -1) {\n            watches.splice(pos, 1);\n          }\n        }\n\n        function indexOf(elt) {\n          for (var i = watches.length - 1; i >= 0; i--) {\n            if (watches[i][0] === elt) {\n              return i;\n            }\n          }\n          return -1;\n        }\n\n        function isWatched(elt) {\n          return indexOf(elt) !== -1;\n        }\n\n        function checkAll(cb) {\n          return function() {\n            for (var i = watches.length - 1; i >= 0; i--) {\n              cb.apply(this, watches[i]);\n            }\n          };\n        }\n\n        return {\n          add: add,\n          remove: remove,\n          isWatched: isWatched,\n          checkAll: checkAll\n        };\n      }\n\n      function observeDOM(watches, container, cb) {\n        var observer = new MutationObserver(watch);\n        var filter = Array.prototype.filter;\n        var concat = Array.prototype.concat;\n\n        observer.observe(container, {\n          childList: true,\n          subtree: true,\n          // changes like style/width/height/display will be catched\n          attributes: true\n        });\n\n        function watch(mutations) {\n          // some new DOM nodes where previously watched\n          // we should check their positions\n          if (mutations.some(knownNodes) === true) {\n            setTimeout(cb, 0);\n          }\n        }\n\n        function knownNodes(mutation) {\n          var nodes = concat.call([],\n            Array.prototype.slice.call(mutation.addedNodes),\n            mutation.target\n          );\n          return filter.call(nodes, watches.isWatched).length > 0;\n        }\n      }\n\n      /* WEBPACK VAR INJECTION */\n    }.call(exports, (function() {\n      return this;\n    }())))\n\n    /***/\n  }\n  /******/\n]);"},{"_content":"<!DOCTYPE html>\n<html>\n<head hexo-theme='https://volantis.js.org/#'>\n  <meta charset=\"utf-8\">\n  <!-- SEO相关 -->\n  \n    \n  \n  <!-- 渲染优化 -->\n  <meta name=\"renderer\" content=\"webkit\">\n  <meta name=\"force-rendering\" content=\"webkit\">\n  <meta http-equiv=\"X-UA-Compatible\" content=\"IE=Edge,chrome=1\">\n  <meta name=\"HandheldFriendly\" content=\"True\" >\n  <meta name=\"apple-mobile-web-app-capable\" content=\"yes\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1, maximum-scale=1\">\n\n  <!-- 页面元数据 -->\n  \n    <title>相册 - Liz&#39;blog</title>\n  \n  \n\n  <!-- feed -->\n  \n\n  <!-- import meta -->\n  \n\n  <!-- link -->\n  <link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css\">\n  \n    \n<link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css\">\n\n  \n  \n    \n<link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css\">\n\n  \n\n  \n  <link rel=\"shortcut icon\" type='image/x-icon' href=\"https://s1.ax1x.com/2020/03/15/81ZR5F.jpg\">\n  \n\n  \n\n  <!-- import link -->\n  \n\n  \n    \n<link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.1.5.2/css/style.css\">\n\n  \n\n  <script>\n    function setLoadingBarProgress(num) {\n      document.getElementById('loading-bar').style.width=num+\"%\";\n    }\n  </script>\n\n  \n  \n</head>\n\n<body>\n  \n  <div id=\"loading-bar-wrapper\">\n  <div id=\"loading-bar\"></div>\n</div>\n<header class=\"l_header shadow blur\">\n\n  <div class='wrapper'>\n    <div class='nav-sub container--flex'>\n      <a class=\"logo flat-box\"></a>\n      <ul class='switcher h-list'>\n        <li><a class=\"s-comment flat-btn fas fa-comments fa-fw\" target=\"_self\" href='javascript:void(0)'></a></li>\n        \n          <li><a class=\"s-toc flat-btn fas fa-list fa-fw\" target=\"_self\" href='javascript:void(0)'></a></li>\n        \n      </ul>\n    </div>\n\t\t<div class=\"nav-main container container--flex\">\n      \n        \n        <a class=\"logo flat-box\" target=\"_self\" href='/'>\n          \n          \n          \n          \n            CHEMLEZ <b><sup style='color:#3AA757'></sup></b>\n          \n        </a>\n      \n\n\t\t\t<div class='menu navigation'>\n\t\t\t\t<ul class='h-list'>\n          \n          \n          \n            \n            \n              <li>\n                <a class=\"flat-box\" href=/\n                  \n                  \n                  \n                    id=\"home\"\n                  >\n                  \n                    <i class='fas fa-home fa-fw'></i>\n                  \n                  主页\n                </a>\n                \n              </li>\n            \n          \n          \n            \n            \n              <li>\n                <a class=\"flat-box\" \n                  \n                  \n                  >\n                  \n                    <i class='fas fa-list-alt fa-fw fa-fw'></i>\n                  \n                  索引\n                </a>\n                \n                  <ul class=\"submenu\">\n                    \n                      \n            \n              <li>\n                <a class=\"flat-box\" href=/tags/\n                  \n                  \n                  \n                    id=\"tags\"\n                  >\n                  \n                    <i class='fas fa-tags fa-fw'></i>\n                  \n                  标签\n                </a>\n                \n              </li>\n            \n          \n                    \n                      \n            \n              <li>\n                <a class=\"flat-box\" href=/categories/\n                  \n                  \n                  \n                    id=\"categories\"\n                  >\n                  \n                    <i class='fas fa-folder-open fa-fw'></i>\n                  \n                  类别\n                </a>\n                \n              </li>\n            \n          \n                    \n                      \n            \n              <li>\n                <a class=\"flat-box\" href=/archives/\n                  \n                  \n                  \n                    id=\"archives\"\n                  >\n                  \n                    <i class='fas fa-archive fa-fw'></i>\n                  \n                  归档\n                </a>\n                \n              </li>\n            \n          \n                    \n                  </ul>\n                \n              </li>\n            \n          \n          \n            \n            \n              <li>\n                <a class=\"flat-box\" href=/friends/\n                  \n                  \n                  \n                    id=\"friends\"\n                  >\n                  \n                    <i class='fas fa-link fa-fw'></i>\n                  \n                  友链\n                </a>\n                \n              </li>\n            \n          \n          \n            \n            \n              <li>\n                <a class=\"flat-box\" href=/about/\n                  \n                  \n                  \n                    id=\"about\"\n                  >\n                  \n                    <i class='fas fa-info-circle fa-fw'></i>\n                  \n                  关于\n                </a>\n                \n              </li>\n            \n          \n          \n\t\t\t\t</ul>\n\t\t\t</div>\n\n      \n        <div class=\"m_search\">\n          <form name=\"searchform\" class=\"form u-search-form\">\n            <i class=\"icon fas fa-search fa-fw\"></i>\n            <input type=\"text\" class=\"input u-search-input\" placeholder=\"搜索\" />\n          </form>\n        </div>\n      \n\n\t\t\t<ul class='switcher h-list'>\n\t\t\t\t\n\t\t\t\t\t<li><a class=\"s-search flat-btn fas fa-search fa-fw\" target=\"_self\" href='javascript:void(0)'></a></li>\n\t\t\t\t\n\t\t\t\t<li><a class=\"s-menu flat-btn fas fa-bars fa-fw\" target=\"_self\" href='javascript:void(0)'></a></li>\n\t\t\t</ul>\n\t\t</div>\n\t</div>\n</header>\n<ul class=\"menu-phone navigation white-box\">\n  \n  \n    <li>\n      <a class=\"flat-box\" href=/\n        \n        \n        \n          id=\"home\"\n        >\n        \n          <i class='fas fa-clock fa-fw fa-fw'></i>\n        \n        近期文章\n      </a>\n    </li>\n  \n    <li>\n      <a class=\"flat-box\" href=/archives/\n        \n        \n        \n          id=\"archives\"\n        >\n        \n          <i class='fas fa-list-alt fa-fw fa-fw'></i>\n        \n        文章归档\n      </a>\n    </li>\n  \n    <li>\n      <a class=\"flat-box\" href=/categories/\n        \n        \n        \n          id=\"categories\"\n        >\n        \n          <i class='fas fa-folder-open fa-fw'></i>\n        \n        文章类别\n      </a>\n    </li>\n  \n    <li>\n      <a class=\"flat-box\" href=/tags/\n        \n        \n        \n          id=\"tags\"\n        >\n        \n          <i class='fas fa-tags fa-fw'></i>\n        \n        文章标签\n      </a>\n    </li>\n  \n    <li>\n      <a class=\"flat-box\" href=/friends/\n        \n        \n        \n          id=\"friends\"\n        >\n        \n          <i class='fas fa-link fa-fw'></i>\n        \n        我的友链\n      </a>\n    </li>\n  \n    <li>\n      <a class=\"flat-box\" href=/about/\n        \n        \n        \n          id=\"about\"\n        >\n        \n          <i class='fas fa-info-circle fa-fw'></i>\n        \n        关于小站\n      </a>\n    </li>\n  \n</ul>\n<script>setLoadingBarProgress(40);</script>\n\n\n\n  <div class=\"l_body nocover\">\n    <div class='body-wrapper'>\n      \n\n<div class='l_main'>\n  \n\n  \n    <article id=\"post\" class=\"post white-box shadow floatable article-type-post\" itemscope itemprop=\"blogPost\">\n      \n\n\n  <section class='meta'>\n    \n    \n    <div class=\"meta\" id=\"header-meta\">\n      \n        \n  \n    <h1 class=\"title\">\n      <a href=\"/photos/videos.html\">\n        相册\n      </a>\n    </h1>\n  \n\n\n      \n      <div class='new-meta-box'>\n        \n          \n        \n          \n            \n<div class='new-meta-item author'>\n  <a href=\"https://liizhi.cn\" target=\"_blank\" rel=\"nofollow noopener\">\n    <img src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/placeholder/d570170f4f12e1ee829ca0e85a7dffeb77343a.svg\" data-original=\"https://s1.ax1x.com/2020/03/13/8mvbCj.jpg\">\n    <p>Chemlez</p>\n  </a>\n</div>\n\n          \n        \n          \n            \n\n          \n        \n          \n            <div class=\"new-meta-item date\">\n  <a class='notlink'>\n    <i class=\"fas fa-edit\" aria-hidden=\"true\"></i>\n    <p>发布于：Mar 14, 2020</p>\n  </a>\n</div>\n\n          \n        \n          \n            \n\n          \n        \n      </div>\n      \n        <hr>\n      \n    </div>\n  </section>\n\n\n      <section class=\"article typo\">\n        <div class=\"article-entry\" itemprop=\"articleBody\">\n          \n          <link rel=\"stylesheet\" href=\"./ins.css\">\n<div class=\"photos-btn-wrap\">\t<a class=\"photos-btn\" href=\"/photos\">Photos</a>\n\t<a class=\"photos-btn active\" href=\"/photos/videos.html\">Videos</a>\n\n</div>\n<center>\n    <h1>指弹_女儿情</h1>\n</center>\n<hr/>\n<center>\n    <div class=\"video-container\">\n        <iframe height=\"80%\" width=\"80%\" src=\"https://player.youku.com/embed/XMjUzMzY4OTM3Ng==\" frameborder=0 allowfullscreen></iframe>\n    </div>\n</center>\n<hr/>\n<center>\n    <h1>指弹_友谊地久天长</h1>\n</center>\n<hr/>\n<center>\n    <div class=\"video-container\">\n        <iframe height=\"80%\" width=\"80%\" src=\"https://player.youku.com/embed/XMjQ5MDExOTY2MA==\" frameborder=0 allowfullscreen></iframe>\n    </div>\n</center>\n<hr/>\n<center>\n    <h1>指弹_Always with me</h1>\n</center>\n<hr/>\n<center>\n    <div class=\"video-container\">\n        <iframe height=\"80%\" width=\"80%\" src=\"https://player.youku.com/embed/XMjQ4MDQyNTQ0MA==\" frameborder=0 allowfullscreen></iframe>\n    </div>\n</center>\n          \n            <br>\n            \n  \n    \n    \n\n<section class=\"widget copyright  desktop mobile\">\n  <div class='content'>\n    \n      <blockquote>\n        \n          \n            <p>博客内容遵循 署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</p>\n\n          \n        \n          \n            <p>本文永久链接是：<a href=https://www.chemlez.cn/photos/videos.html>https://www.chemlez.cn/photos/videos.html</a></p>\n          \n        \n      </blockquote>\n    \n  </div>\n</section>\n\n  \n\n  \n    \n    \n  \n\n  <section class=\"widget related_posts  desktop mobile\">\n    \n  <header>\n    \n      <i class=\"fas fa-bookmark fa-fw\" aria-hidden=\"true\"></i><span class='name'>相关文章</span>\n    \n  </header>\n\n\n    <div class=\"content\">\n      <ul class=\"popular-posts\"><li class=\"popular-posts-item\"><div class=\"popular-posts-title\"><h3><a href=\"/2020/09/03/Java基础之Filter/\" title=\"Java基础之Filter\" rel=\"bookmark\">Java基础之Filter</a></h3></div></li></ul>\n    </div>\n  </section>\n\n\n  \n\n\n          \n        </div>\n        \n          \n\n\n  <section class='meta' id=\"footer-meta\">\n    <div class='new-meta-box'>\n      \n        \n          <div class=\"new-meta-item date\" itemprop=\"dateUpdated\" datetime=\"2019-08-24T15:36:10+08:00\">\n  <a class='notlink'>\n    <i class=\"fas fa-save\" aria-hidden=\"true\"></i>\n    <p>更新于：Aug 24, 2019</p>\n  </a>\n</div>\n\n        \n      \n        \n          \n\n        \n      \n        \n          \n  <div class=\"new-meta-item share -mob-share-list\">\n  <div class=\"-mob-share-list share-body\">\n    \n      \n        <a class=\"-mob-share-qq\" title=\"\" rel=\"external nofollow noopener noreferrer\"\n          \n          href=\"http://connect.qq.com/widget/shareqq/index.html?url=https://www.chemlez.cn/photos/videos.html&title=相册 - Liz'blog&summary=\"\n          \n          >\n          \n            <img src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/placeholder/d570170f4f12e1ee829ca0e85a7dffeb77343a.svg\" data-original=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qq.png\">\n          \n        </a>\n      \n    \n      \n        <a class=\"-mob-share-qzone\" title=\"\" rel=\"external nofollow noopener noreferrer\"\n          \n          href=\"https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://www.chemlez.cn/photos/videos.html&title=相册 - Liz'blog&summary=\"\n          \n          >\n          \n            <img src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/placeholder/d570170f4f12e1ee829ca0e85a7dffeb77343a.svg\" data-original=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qzone.png\">\n          \n        </a>\n      \n    \n      \n        <a class=\"-mob-share-weibo\" title=\"\" rel=\"external nofollow noopener noreferrer\"\n          \n          href=\"http://service.weibo.com/share/share.php?url=https://www.chemlez.cn/photos/videos.html&title=相册 - Liz'blog&summary=\"\n          \n          >\n          \n            <img src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/placeholder/d570170f4f12e1ee829ca0e85a7dffeb77343a.svg\" data-original=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/weibo.png\">\n          \n        </a>\n      \n    \n      \n        \n        <div class='hoverbox'>\n          <a><img src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/placeholder/d570170f4f12e1ee829ca0e85a7dffeb77343a.svg\" data-original=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/wechat.png\"></a>\n          <div class='target'>\n            <img src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPgAAAD4CAAAAADkunTXAAACT0lEQVR42u3aSXLDMAwEQP//08kLVOQA8CKqeZNTltHMZQrA6++h5wUODg4ODn4Q/FU8ly8e/l76/tV7wMHBwcHBT4RvB4BFQavn6sVM1QsODg4ODn4yfBkAFs/dQq/qGKsXHBwcHBwcfDuYVANMGpTAwcHBwcHB+wGmC7ltcgMHBwcHB/8BeNygH1oESC/265MUcHBwcHDwH4KXF+a+9FyuFxwcHBwc/CB496wCS7o4sBuAyvWCg4ODg4MfBO8O8HcbC90L6tYHDg4ODg5+Mny38LSQ7kCiDU07MODg4ODg4DeEVxv6qwCSBppuwGk3IsDBwcHBwW8I7waEtLBq46K6oAAODg4ODv4EeLWwNPhUC+/+A8DBwcHBwU+C7/7QNKx6kekFXQ4UwMHBwcHBD4CnjYhqoJkCVBcYwMHBwcHBnwSfGgykgO6CQnuSAg4ODg4OfiP41OD+XQOF9GLigQI4ODg4OPiN4WlgSYPNbqBJBw3VBQNwcHBwcPAnwrsFVBsf1QsbCzDg4ODg4OA3gqeD/jTIpJ+nCwbxJAUcHBwcHPwgeLURMLVgMBWcLv8ODg4ODg5+EHxqcPCuxsRuo2K7DnBwcHBw8IPgnwomUwt+aWBZNiLAwcHBwcEPgFcbBt2BRHVgUK4fHBwcHBz8YHg1aKTfTy/m7ZMUcHBwcHBw8PHF+jRIgYODg4ODg8/Dq8Gkez7eiAAHBwcHB/8iPA0O6QAgDTDdhQFwcHBwcPAnwKvBYOoidgNIdTABDg4ODg5+IvxpBxwcHBwc/IDzDxDyBwHZ5cyhAAAAAElFTkSuQmCC\">\n          </div>\n        </div>\n      \n    \n  </div>\n</div>\n\n\n\n        \n      \n    </div>\n  </section>\n\n\n        \n        \n      </section>\n    </article>\n  \n\n  \n    <!-- 显示推荐文章和评论 -->\n\n\n\n  <article class=\"post white-box comments shadow floatable\">\n    <section class=\"article typo\">\n      <p ct><i class='fas fa-comments'></i> Comment</p>\n      \n      \n      \n      \n      \n        <section id=\"comments\">\n          <div id=\"valine_container\" class=\"valine_thread\">\n            <i class=\"fas fa-spinner fa-spin fa-fw\"></i>\n          </div>\n        </section>\n      \n    </section>\n  </article>\n\n\n  \n\n\n\n\n<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->\n\n\n\n  <script>\n    window.subData = {\n      title: '相册',\n      tools: true\n    }\n  </script>\n\n\n</div>\n<aside class='l_side'>\n  \n  \n    \n    \n\n<section class=\"widget blogger shadow floatable desktop\">\n  <div class='content'>\n    \n      <div class='avatar'>\n        <img class='avatar' src='https://s1.ax1x.com/2020/03/13/8mvbCj.jpg'/>\n      </div>\n    \n    \n      <div class='text'>\n        \n        \n        \n          <p><span id=\"jinrishici-sentence\">Liz'blog</span></p>\n          <script src=\"https://sdk.jinrishici.com/v2/browser/jinrishici.js\" charset=\"utf-8\"></script>\n        \n      </div>\n    \n    \n      <div class=\"social-wrapper\">\n        \n          \n            <a href=\"https://github.com/Chemlez\"\n              class=\"social fab fa-github flat-btn\"\n              target=\"_blank\"\n              rel=\"external nofollow noopener noreferrer\">\n            </a>\n          \n        \n          \n            <a href=\"https://weibo.com/u/5653780011?nick=Sane_z&is_all=1\"\n              class=\"social fab fa-weibo flat-btn\"\n              target=\"_blank\"\n              rel=\"external nofollow noopener noreferrer\">\n            </a>\n          \n        \n          \n            <a href=\"mailto:liz_1106@163.com\"\n              class=\"social fas fa-envelope flat-btn\"\n              target=\"_blank\"\n              rel=\"external nofollow noopener noreferrer\">\n            </a>\n          \n        \n      </div>\n    \n  </div>\n</section>\n\n  \n\n  \n    \n    \n  \n\n  <section class=\"widget category shadow floatable desktop\">\n    \n  <header>\n    \n      <a href='/categories/'><i class=\"fas fa-folder-open fa-fw\" aria-hidden=\"true\"></i><span class='name'>文章分类</span></a>\n    \n  </header>\n\n\n    <div class='content'>\n      <ul class=\"entry navigation\">\n        \n          <li><a class=\"flat-box\"\n            title=\"/categories/Java/\" href=\"/categories/Java/\"\n            id=\"categoriesJava\"\n            ><div class='name'>Java</div><div class='badge'>(16)</div></a></li>\n        \n          <li><a class=\"flat-box child\"\n            title=\"/categories/Java/%E6%A1%86%E6%9E%B6/\" href=\"/categories/Java/%E6%A1%86%E6%9E%B6/\"\n            id=\"categoriesJavaE6A186E69EB6\"\n            ><div class='name'>框架</div><div class='badge'>(1)</div></a></li>\n        \n          <li><a class=\"flat-box\"\n            title=\"/categories/Linux/\" href=\"/categories/Linux/\"\n            id=\"categoriesLinux\"\n            ><div class='name'>Linux</div><div class='badge'>(2)</div></a></li>\n        \n          <li><a class=\"flat-box\"\n            title=\"/categories/Machine-Learning/\" href=\"/categories/Machine-Learning/\"\n            id=\"categoriesMachine-Learning\"\n            ><div class='name'>Machine Learning</div><div class='badge'>(2)</div></a></li>\n        \n          <li><a class=\"flat-box child\"\n            title=\"/categories/Machine-Learning/sklearn/\" href=\"/categories/Machine-Learning/sklearn/\"\n            id=\"categoriesMachine-Learningsklearn\"\n            ><div class='name'>sklearn</div><div class='badge'>(2)</div></a></li>\n        \n          <li><a class=\"flat-box\"\n            title=\"/categories/Mongodb/\" href=\"/categories/Mongodb/\"\n            id=\"categoriesMongodb\"\n            ><div class='name'>Mongodb</div><div class='badge'>(1)</div></a></li>\n        \n          <li><a class=\"flat-box\"\n            title=\"/categories/Python/\" href=\"/categories/Python/\"\n            id=\"categoriesPython\"\n            ><div class='name'>Python</div><div class='badge'>(3)</div></a></li>\n        \n          <li><a class=\"flat-box child\"\n            title=\"/categories/Python/%E7%88%AC%E8%99%AB/\" href=\"/categories/Python/%E7%88%AC%E8%99%AB/\"\n            id=\"categoriesPythonE788ACE899AB\"\n            ><div class='name'>爬虫</div><div class='badge'>(2)</div></a></li>\n        \n          <li><a class=\"flat-box\"\n            title=\"/categories/git/\" href=\"/categories/git/\"\n            id=\"categoriesgit\"\n            ><div class='name'>git</div><div class='badge'>(1)</div></a></li>\n        \n          <li><a class=\"flat-box\"\n            title=\"/categories/%E5%89%8D%E7%AB%AF/\" href=\"/categories/%E5%89%8D%E7%AB%AF/\"\n            id=\"categoriesE5898DE7ABAF\"\n            ><div class='name'>前端</div><div class='badge'>(1)</div></a></li>\n        \n      </ul>\n    </div>\n  </section>\n\n\n  \n\n  \n    \n    \n  \n\n  <section class=\"widget tagcloud shadow floatable desktop\">\n    \n  <header>\n    \n      <a href='/tags/'><i class=\"fas fa-tags fa-fw\" aria-hidden=\"true\"></i><span class='name'>热门标签</span></a>\n    \n  </header>\n\n\n    <div class='content'>\n      <a href=\"/tags/Beautifulsoup/\" style=\"font-size: 19px; color: #777\">Beautifulsoup</a> <a href=\"/tags/Data-Preprocessing/\" style=\"font-size: 14px; color: #999\">Data Preprocessing</a> <a href=\"/tags/DecisionTree/\" style=\"font-size: 14px; color: #999\">DecisionTree</a> <a href=\"/tags/Feature-Engineering/\" style=\"font-size: 14px; color: #999\">Feature Engineering</a> <a href=\"/tags/Filter/\" style=\"font-size: 14px; color: #999\">Filter</a> <a href=\"/tags/IO%E6%B5%81/\" style=\"font-size: 14px; color: #999\">IO流</a> <a href=\"/tags/JDBC/\" style=\"font-size: 19px; color: #777\">JDBC</a> <a href=\"/tags/JQuery/\" style=\"font-size: 14px; color: #999\">JQuery</a> <a href=\"/tags/Java/\" style=\"font-size: 24px; color: #555\">Java</a> <a href=\"/tags/JavaScript/\" style=\"font-size: 14px; color: #999\">JavaScript</a> <a href=\"/tags/JavaWeb/\" style=\"font-size: 19px; color: #777\">JavaWeb</a> <a href=\"/tags/Kaggle/\" style=\"font-size: 14px; color: #999\">Kaggle</a> <a href=\"/tags/Linux/\" style=\"font-size: 19px; color: #777\">Linux</a> <a href=\"/tags/MBG/\" style=\"font-size: 14px; color: #999\">MBG</a> <a href=\"/tags/MVC/\" style=\"font-size: 14px; color: #999\">MVC</a> <a href=\"/tags/Mapper/\" style=\"font-size: 14px; color: #999\">Mapper</a> <a href=\"/tags/Mongodb/\" style=\"font-size: 14px; color: #999\">Mongodb</a> <a href=\"/tags/MySQL/\" style=\"font-size: 24px; color: #555\">MySQL</a> <a href=\"/tags/Mybatis/\" style=\"font-size: 24px; color: #555\">Mybatis</a> <a href=\"/tags/Python/\" style=\"font-size: 14px; color: #999\">Python</a> <a href=\"/tags/Request/\" style=\"font-size: 19px; color: #777\">Request</a> <a href=\"/tags/Servlet/\" style=\"font-size: 24px; color: #555\">Servlet</a> <a href=\"/tags/Spring/\" style=\"font-size: 19px; color: #777\">Spring</a> <a href=\"/tags/SpringMVC/\" style=\"font-size: 19px; color: #777\">SpringMVC</a> <a href=\"/tags/Springboot-starter/\" style=\"font-size: 14px; color: #999\">Springboot-starter</a> <a href=\"/tags/VMware/\" style=\"font-size: 14px; color: #999\">VMware</a> <a href=\"/tags/conda/\" style=\"font-size: 14px; color: #999\">conda</a> <a href=\"/tags/git/\" style=\"font-size: 14px; color: #999\">git</a> <a href=\"/tags/hexo/\" style=\"font-size: 14px; color: #999\">hexo</a> <a href=\"/tags/redis/\" style=\"font-size: 14px; color: #999\">redis</a> <a href=\"/tags/servlet/\" style=\"font-size: 14px; color: #999\">servlet</a> <a href=\"/tags/sklearn/\" style=\"font-size: 19px; color: #777\">sklearn</a> <a href=\"/tags/ssm/\" style=\"font-size: 14px; color: #999\">ssm</a> <a href=\"/tags/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/\" style=\"font-size: 14px; color: #999\">动态代理</a> <a href=\"/tags/%E5%8F%8D%E5%B0%84/\" style=\"font-size: 19px; color: #777\">反射</a> <a href=\"/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/\" style=\"font-size: 19px; color: #777\">正则表达式</a> <a href=\"/tags/%E6%BA%90%E7%A0%81/\" style=\"font-size: 19px; color: #777\">源码</a> <a href=\"/tags/%E7%88%AC%E8%99%AB/\" style=\"font-size: 19px; color: #777\">爬虫</a> <a href=\"/tags/%E8%A1%A8%E5%8D%95%E9%AA%8C%E8%AF%81/\" style=\"font-size: 14px; color: #999\">表单验证</a>\n    </div>\n  </section>\n\n\n  \n\n  \n    \n    \n\n\n  <section class=\"widget toc-wrapper shadow floatable desktop mobile\">\n    \n  <header>\n    \n      <i class=\"fas fa-list fa-fw\" aria-hidden=\"true\"></i><span class='name'>本文目录</span>\n    \n  </header>\n\n\n    <div class='content'>\n      \n    </div>\n  </section>\n\n\n  \n\n\n</aside>\n\n\n  \n  <footer class=\"clearfix\">\n    <br><br>\n    \n      \n        <div class=\"aplayer-container\">\n          \n\n\n        </div>\n      \n    \n      \n        <br>\n        <div class=\"social-wrapper\">\n          \n            \n              <a href=\"https://github.com/Chemlez\"\n                class=\"social fab fa-github flat-btn\"\n                target=\"_blank\"\n                rel=\"external nofollow noopener noreferrer\">\n              </a>\n            \n          \n            \n              <a href=\"https://weibo.com/u/5653780011?nick=Sane_z&amp;is_all=1\"\n                class=\"social fab fa-weibo flat-btn\"\n                target=\"_blank\"\n                rel=\"external nofollow noopener noreferrer\">\n              </a>\n            \n          \n            \n              <a href=\"mailto:liz_1106@163.com\"\n                class=\"social fas fa-envelope flat-btn\"\n                target=\"_blank\"\n                rel=\"external nofollow noopener noreferrer\">\n              </a>\n            \n          \n        </div>\n      \n    \n      \n        <div class='copyright'>\n        <p><a href=\"https://liizhi.cn\" target=\"_blank\" rel=\"noopener\">Copyright © 2019-2020 Chemlez</a></p>\n\n        </div>\n      \n    \n  </footer>\n\n<script>setLoadingBarProgress(80);</script>\n\n\n      <script>setLoadingBarProgress(60);</script>\n    </div>\n    <a class=\"s-top fas fa-arrow-up fa-fw\" href='javascript:void(0)'></a>\n  </div>\n  \n<script src=\"https://cdn.jsdelivr.net/npm/jquery@3.4/dist/jquery.min.js\"></script>\n\n\n  <script>\n    \n    var SEARCH_SERVICE = \"hexo\" || \"hexo\";\n    var ROOT = \"/\" || \"/\";\n    if (!ROOT.endsWith('/')) ROOT += '/';\n  </script>\n\n\n  <script async src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/instant_page.js\" type=\"module\" defer integrity=\"sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1\"></script>\n\n\n\n  \n<script src=\"https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js\"></script>\n\n  <script type=\"text/javascript\">\n    $(function() {\n      Waves.attach('.flat-btn', ['waves-button']);\n      Waves.attach('.float-btn', ['waves-button', 'waves-float']);\n      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);\n      Waves.attach('.flat-box', ['waves-block']);\n      Waves.attach('.float-box', ['waves-block', 'waves-float']);\n      Waves.attach('.waves-image');\n      Waves.init();\n    });\n  </script>\n\n\n  <script async src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js\"></script>\n\n\n\n  \n  \n  \n    \n<script src=\"https://cdn.jsdelivr.net/npm/jquery-backstretch@2.1.18/jquery.backstretch.min.js\"></script>\n\n    <script type=\"text/javascript\">\n      $(function(){\n        var imgs=[\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-wallpaper/abstract/41F215B9-261F-48B4-80B5-4E86E165259E.jpeg\"];\n        if ('true' == 'true') {\n          function shuffle(arr){\n            /*From countercurrent-time*/\n            var n = arr.length;\n            while(n--) {\n              var index = Math.floor(Math.random() * n);\n              var temp = arr[index];\n              arr[index] = arr[n];\n              arr[n] = temp;\n            }\n          }\n          shuffle(imgs);\n        }\n        if ('.cover') {\n          $('.cover').backstretch(\n            imgs,\n          {\n            duration: \"20000\",\n            fade: \"1500\"\n          });\n        } else {\n          $.backstretch(\n            imgs,\n          {\n            duration: \"20000\",\n            fade: \"1500\"\n          });\n        }\n      });\n    </script>\n  \n\n\n\n\n\n\n\n\n\n\n  \n    \n<script src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.0/js/valine.js\"></script>\n\n  \n  <script>\n  var GUEST_INFO = ['nick','mail','link'];\n  var guest_info = 'nick,mail,link'.split(',').filter(function(item){\n    return GUEST_INFO.indexOf(item) > -1\n  });\n  var notify = 'true' == true;\n  var verify = 'true' == true;\n  var valine = new Valine();\n  valine.init({\n    el: '#valine_container',\n    notify: notify,\n    verify: verify,\n    guest_info: guest_info,\n    \n    appId: \"YSitK1ig1lRcy3jvrtTzT6fb-MdYXbMMI\",\n    appKey: \"e7hFf2zqvyWgNmDsClWcM7W3\",\n    placeholder: \"快来评论吧~\",\n    pageSize:'10',\n    avatar:'wavatar',\n    lang:'zh-cn',\n    visitor: 'false',\n    highlight:'true'\n  })\n  </script>\n\n\n\n  \n<script src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.1.5/js/app.js\"></script>\n\n\n\n  \n<script src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.1/js/search.js\"></script>\n\n\n\n  \n<script src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/comment_typing.js\"></script>\n\n\n\n<!-- 复制 -->\n\n  <script src=\"https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js\"></script>\n<script>\n  !function (e, t, a) {\n    var initCopyCode = function(){\n      var copyHtml = '';\n      copyHtml += '<button class=\"btn-copy\" data-clipboard-snippet=\"\">';\n      copyHtml += '<i class=\"fas fa-copy\"></i><span>COPY</span>';\n      copyHtml += '</button>';\n      $(\".highlight .code pre\").before(copyHtml);\n      var clipboard = new ClipboardJS('.btn-copy', {\n        target: function(trigger) {\n          return trigger.nextElementSibling;\n        }\n      });\n      clipboard.on('success', function(e) {\n        let $btn = $(e.trigger);\n        $btn.addClass('copyed');\n        let $icon = $($btn.find('i'));\n        $icon.removeClass('fa-copy');\n        $icon.addClass('fa-clipboard-check');\n        let $span = $($btn.find('span'));\n        $span[0].innerText = 'COPYED';\n      });\n      clipboard.on('error', function(e) {\n        e.clearSelection();\n        let $btn = $(e.trigger);\n        $btn.addClass('copy-failed');\n        let $icon = $($btn.find('i'));\n        $icon.removeClass('fa-copy');\n        $icon.addClass('fa-exclamation-triangle');\n        let $span = $($btn.find('span'));\n        $span[0].innerText = 'COPY FAILED';\n      });\n    }\n    initCopyCode();\n  }(window, document);\n</script>\n\n\n\n\n<!-- fancybox -->\n\n  <script src=\"https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js\"></script>\n<script>\n  let LAZY_LOAD_IMAGE = \"[object Object]\";\n  $(\".article-entry\").find(\"fancybox\").find(\"img\").each(function () {\n      var element = document.createElement(\"a\");\n      $(element).attr(\"data-fancybox\", \"gallery\");\n      $(element).attr(\"href\", $(this).attr(\"src\"));\n      /* 图片采用懒加载处理时,\n       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,\n       * 那么此处将原本的属性名src替换为对应属性名data-original,\n       * 修改如下\n       */\n       if (LAZY_LOAD_IMAGE) {\n         $(element).attr(\"href\", $(this).attr(\"data-original\"));\n       }\n      $(this).wrap(element);\n  });\n</script>\n\n\n\n\n\n\n  <script>setLoadingBarProgress(100);</script>\n<script>!function(e){var c=Array.prototype.slice.call(document.querySelectorAll(\"img[data-original]\"));function i(){for(var r=0;r<c.length;r++)t=c[r],0<=(n=t.getBoundingClientRect()).bottom&&0<=n.left&&n.top<=(e.innerHeight||document.documentElement.clientHeight)&&function(){var t,n,e,i,o=c[r];t=o,n=function(){c=c.filter(function(t){return o!==t})},e=new Image,i=t.getAttribute(\"data-original\"),e.onload=function(){t.src=i,n&&n()},e.src=i}();var t,n}i(),e.addEventListener(\"scroll\",function(){var t,n;t=i,n=e,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)})}(this);</script><script>window.addEventListener(\"load\",function(){var t=/\\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll(\"img[data-original]\")).forEach(function(a){var e=a.parentNode;\"A\"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script></body>\n</html>\n","source":"blog-photo/videos.html","raw":"<!DOCTYPE html>\n<html>\n<head hexo-theme='https://volantis.js.org/#'>\n  <meta charset=\"utf-8\">\n  <!-- SEO相关 -->\n  \n    \n  \n  <!-- 渲染优化 -->\n  <meta name=\"renderer\" content=\"webkit\">\n  <meta name=\"force-rendering\" content=\"webkit\">\n  <meta http-equiv=\"X-UA-Compatible\" content=\"IE=Edge,chrome=1\">\n  <meta name=\"HandheldFriendly\" content=\"True\" >\n  <meta name=\"apple-mobile-web-app-capable\" content=\"yes\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1, maximum-scale=1\">\n\n  <!-- 页面元数据 -->\n  \n    <title>相册 - Liz&#39;blog</title>\n  \n  \n\n  <!-- feed -->\n  \n\n  <!-- import meta -->\n  \n\n  <!-- link -->\n  <link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css\">\n  \n    \n<link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css\">\n\n  \n  \n    \n<link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css\">\n\n  \n\n  \n  <link rel=\"shortcut icon\" type='image/x-icon' href=\"https://s1.ax1x.com/2020/03/15/81ZR5F.jpg\">\n  \n\n  \n\n  <!-- import link -->\n  \n\n  \n    \n<link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.1.5.2/css/style.css\">\n\n  \n\n  <script>\n    function setLoadingBarProgress(num) {\n      document.getElementById('loading-bar').style.width=num+\"%\";\n    }\n  </script>\n\n  \n  \n</head>\n\n<body>\n  \n  <div id=\"loading-bar-wrapper\">\n  <div id=\"loading-bar\"></div>\n</div>\n<header class=\"l_header shadow blur\">\n\n  <div class='wrapper'>\n    <div class='nav-sub container--flex'>\n      <a class=\"logo flat-box\"></a>\n      <ul class='switcher h-list'>\n        <li><a class=\"s-comment flat-btn fas fa-comments fa-fw\" target=\"_self\" href='javascript:void(0)'></a></li>\n        \n          <li><a class=\"s-toc flat-btn fas fa-list fa-fw\" target=\"_self\" href='javascript:void(0)'></a></li>\n        \n      </ul>\n    </div>\n\t\t<div class=\"nav-main container container--flex\">\n      \n        \n        <a class=\"logo flat-box\" target=\"_self\" href='/'>\n          \n          \n          \n          \n            CHEMLEZ <b><sup style='color:#3AA757'></sup></b>\n          \n        </a>\n      \n\n\t\t\t<div class='menu navigation'>\n\t\t\t\t<ul class='h-list'>\n          \n          \n          \n            \n            \n              <li>\n                <a class=\"flat-box\" href=/\n                  \n                  \n                  \n                    id=\"home\"\n                  >\n                  \n                    <i class='fas fa-home fa-fw'></i>\n                  \n                  主页\n                </a>\n                \n              </li>\n            \n          \n          \n            \n            \n              <li>\n                <a class=\"flat-box\" \n                  \n                  \n                  >\n                  \n                    <i class='fas fa-list-alt fa-fw fa-fw'></i>\n                  \n                  索引\n                </a>\n                \n                  <ul class=\"submenu\">\n                    \n                      \n            \n              <li>\n                <a class=\"flat-box\" href=/tags/\n                  \n                  \n                  \n                    id=\"tags\"\n                  >\n                  \n                    <i class='fas fa-tags fa-fw'></i>\n                  \n                  标签\n                </a>\n                \n              </li>\n            \n          \n                    \n                      \n            \n              <li>\n                <a class=\"flat-box\" href=/categories/\n                  \n                  \n                  \n                    id=\"categories\"\n                  >\n                  \n                    <i class='fas fa-folder-open fa-fw'></i>\n                  \n                  类别\n                </a>\n                \n              </li>\n            \n          \n                    \n                      \n            \n              <li>\n                <a class=\"flat-box\" href=/archives/\n                  \n                  \n                  \n                    id=\"archives\"\n                  >\n                  \n                    <i class='fas fa-archive fa-fw'></i>\n                  \n                  归档\n                </a>\n                \n              </li>\n            \n          \n                    \n                  </ul>\n                \n              </li>\n            \n          \n          \n            \n            \n              <li>\n                <a class=\"flat-box\" href=/friends/\n                  \n                  \n                  \n                    id=\"friends\"\n                  >\n                  \n                    <i class='fas fa-link fa-fw'></i>\n                  \n                  友链\n                </a>\n                \n              </li>\n            \n          \n          \n            \n            \n              <li>\n                <a class=\"flat-box\" href=/about/\n                  \n                  \n                  \n                    id=\"about\"\n                  >\n                  \n                    <i class='fas fa-info-circle fa-fw'></i>\n                  \n                  关于\n                </a>\n                \n              </li>\n            \n          \n          \n\t\t\t\t</ul>\n\t\t\t</div>\n\n      \n        <div class=\"m_search\">\n          <form name=\"searchform\" class=\"form u-search-form\">\n            <i class=\"icon fas fa-search fa-fw\"></i>\n            <input type=\"text\" class=\"input u-search-input\" placeholder=\"搜索\" />\n          </form>\n        </div>\n      \n\n\t\t\t<ul class='switcher h-list'>\n\t\t\t\t\n\t\t\t\t\t<li><a class=\"s-search flat-btn fas fa-search fa-fw\" target=\"_self\" href='javascript:void(0)'></a></li>\n\t\t\t\t\n\t\t\t\t<li><a class=\"s-menu flat-btn fas fa-bars fa-fw\" target=\"_self\" href='javascript:void(0)'></a></li>\n\t\t\t</ul>\n\t\t</div>\n\t</div>\n</header>\n<ul class=\"menu-phone navigation white-box\">\n  \n  \n    <li>\n      <a class=\"flat-box\" href=/\n        \n        \n        \n          id=\"home\"\n        >\n        \n          <i class='fas fa-clock fa-fw fa-fw'></i>\n        \n        近期文章\n      </a>\n    </li>\n  \n    <li>\n      <a class=\"flat-box\" href=/archives/\n        \n        \n        \n          id=\"archives\"\n        >\n        \n          <i class='fas fa-list-alt fa-fw fa-fw'></i>\n        \n        文章归档\n      </a>\n    </li>\n  \n    <li>\n      <a class=\"flat-box\" href=/categories/\n        \n        \n        \n          id=\"categories\"\n        >\n        \n          <i class='fas fa-folder-open fa-fw'></i>\n        \n        文章类别\n      </a>\n    </li>\n  \n    <li>\n      <a class=\"flat-box\" href=/tags/\n        \n        \n        \n          id=\"tags\"\n        >\n        \n          <i class='fas fa-tags fa-fw'></i>\n        \n        文章标签\n      </a>\n    </li>\n  \n    <li>\n      <a class=\"flat-box\" href=/friends/\n        \n        \n        \n          id=\"friends\"\n        >\n        \n          <i class='fas fa-link fa-fw'></i>\n        \n        我的友链\n      </a>\n    </li>\n  \n    <li>\n      <a class=\"flat-box\" href=/about/\n        \n        \n        \n          id=\"about\"\n        >\n        \n          <i class='fas fa-info-circle fa-fw'></i>\n        \n        关于小站\n      </a>\n    </li>\n  \n</ul>\n<script>setLoadingBarProgress(40);</script>\n\n\n\n  <div class=\"l_body nocover\">\n    <div class='body-wrapper'>\n      \n\n<div class='l_main'>\n  \n\n  \n    <article id=\"post\" class=\"post white-box shadow floatable article-type-post\" itemscope itemprop=\"blogPost\">\n      \n\n\n  <section class='meta'>\n    \n    \n    <div class=\"meta\" id=\"header-meta\">\n      \n        \n  \n    <h1 class=\"title\">\n      <a href=\"/photos/videos.html\">\n        相册\n      </a>\n    </h1>\n  \n\n\n      \n      <div class='new-meta-box'>\n        \n          \n        \n          \n            \n<div class='new-meta-item author'>\n  <a href=\"https://liizhi.cn\" target=\"_blank\" rel=\"nofollow noopener\">\n    <img src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/placeholder/d570170f4f12e1ee829ca0e85a7dffeb77343a.svg\" data-original=\"https://s1.ax1x.com/2020/03/13/8mvbCj.jpg\">\n    <p>Chemlez</p>\n  </a>\n</div>\n\n          \n        \n          \n            \n\n          \n        \n          \n            <div class=\"new-meta-item date\">\n  <a class='notlink'>\n    <i class=\"fas fa-edit\" aria-hidden=\"true\"></i>\n    <p>发布于：Mar 14, 2020</p>\n  </a>\n</div>\n\n          \n        \n          \n            \n\n          \n        \n      </div>\n      \n        <hr>\n      \n    </div>\n  </section>\n\n\n      <section class=\"article typo\">\n        <div class=\"article-entry\" itemprop=\"articleBody\">\n          \n          <link rel=\"stylesheet\" href=\"./ins.css\">\n<div class=\"photos-btn-wrap\">\t<a class=\"photos-btn\" href=\"/photos\">Photos</a>\n\t<a class=\"photos-btn active\" href=\"/photos/videos.html\">Videos</a>\n\n</div>\n<center>\n    <h1>指弹_女儿情</h1>\n</center>\n<hr/>\n<center>\n    <div class=\"video-container\">\n        <iframe height=\"80%\" width=\"80%\" src=\"https://player.youku.com/embed/XMjUzMzY4OTM3Ng==\" frameborder=0 allowfullscreen></iframe>\n    </div>\n</center>\n<hr/>\n<center>\n    <h1>指弹_友谊地久天长</h1>\n</center>\n<hr/>\n<center>\n    <div class=\"video-container\">\n        <iframe height=\"80%\" width=\"80%\" src=\"https://player.youku.com/embed/XMjQ5MDExOTY2MA==\" frameborder=0 allowfullscreen></iframe>\n    </div>\n</center>\n<hr/>\n<center>\n    <h1>指弹_Always with me</h1>\n</center>\n<hr/>\n<center>\n    <div class=\"video-container\">\n        <iframe height=\"80%\" width=\"80%\" src=\"https://player.youku.com/embed/XMjQ4MDQyNTQ0MA==\" frameborder=0 allowfullscreen></iframe>\n    </div>\n</center>\n          \n            <br>\n            \n  \n    \n    \n\n<section class=\"widget copyright  desktop mobile\">\n  <div class='content'>\n    \n      <blockquote>\n        \n          \n            <p>博客内容遵循 署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</p>\n\n          \n        \n          \n            <p>本文永久链接是：<a href=https://www.chemlez.cn/photos/videos.html>https://www.chemlez.cn/photos/videos.html</a></p>\n          \n        \n      </blockquote>\n    \n  </div>\n</section>\n\n  \n\n  \n    \n    \n  \n\n  <section class=\"widget related_posts  desktop mobile\">\n    \n  <header>\n    \n      <i class=\"fas fa-bookmark fa-fw\" aria-hidden=\"true\"></i><span class='name'>相关文章</span>\n    \n  </header>\n\n\n    <div class=\"content\">\n      <ul class=\"popular-posts\"><li class=\"popular-posts-item\"><div class=\"popular-posts-title\"><h3><a href=\"/2020/09/03/Java基础之Filter/\" title=\"Java基础之Filter\" rel=\"bookmark\">Java基础之Filter</a></h3></div></li></ul>\n    </div>\n  </section>\n\n\n  \n\n\n          \n        </div>\n        \n          \n\n\n  <section class='meta' id=\"footer-meta\">\n    <div class='new-meta-box'>\n      \n        \n          <div class=\"new-meta-item date\" itemprop=\"dateUpdated\" datetime=\"2019-08-24T15:36:10+08:00\">\n  <a class='notlink'>\n    <i class=\"fas fa-save\" aria-hidden=\"true\"></i>\n    <p>更新于：Aug 24, 2019</p>\n  </a>\n</div>\n\n        \n      \n        \n          \n\n        \n      \n        \n          \n  <div class=\"new-meta-item share -mob-share-list\">\n  <div class=\"-mob-share-list share-body\">\n    \n      \n        <a class=\"-mob-share-qq\" title=\"\" rel=\"external nofollow noopener noreferrer\"\n          \n          href=\"http://connect.qq.com/widget/shareqq/index.html?url=https://www.chemlez.cn/photos/videos.html&title=相册 - Liz'blog&summary=\"\n          \n          >\n          \n            <img src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/placeholder/d570170f4f12e1ee829ca0e85a7dffeb77343a.svg\" data-original=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qq.png\">\n          \n        </a>\n      \n    \n      \n        <a class=\"-mob-share-qzone\" title=\"\" rel=\"external nofollow noopener noreferrer\"\n          \n          href=\"https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://www.chemlez.cn/photos/videos.html&title=相册 - Liz'blog&summary=\"\n          \n          >\n          \n            <img src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/placeholder/d570170f4f12e1ee829ca0e85a7dffeb77343a.svg\" data-original=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qzone.png\">\n          \n        </a>\n      \n    \n      \n        <a class=\"-mob-share-weibo\" title=\"\" rel=\"external nofollow noopener noreferrer\"\n          \n          href=\"http://service.weibo.com/share/share.php?url=https://www.chemlez.cn/photos/videos.html&title=相册 - Liz'blog&summary=\"\n          \n          >\n          \n            <img src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/placeholder/d570170f4f12e1ee829ca0e85a7dffeb77343a.svg\" data-original=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/weibo.png\">\n          \n        </a>\n      \n    \n      \n        \n        <div class='hoverbox'>\n          <a><img src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/placeholder/d570170f4f12e1ee829ca0e85a7dffeb77343a.svg\" data-original=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/wechat.png\"></a>\n          <div class='target'>\n            <img src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPgAAAD4CAAAAADkunTXAAACT0lEQVR42u3aSXLDMAwEQP//08kLVOQA8CKqeZNTltHMZQrA6++h5wUODg4ODn4Q/FU8ly8e/l76/tV7wMHBwcHBT4RvB4BFQavn6sVM1QsODg4ODn4yfBkAFs/dQq/qGKsXHBwcHBwcfDuYVANMGpTAwcHBwcHB+wGmC7ltcgMHBwcHB/8BeNygH1oESC/265MUcHBwcHDwH4KXF+a+9FyuFxwcHBwc/CB496wCS7o4sBuAyvWCg4ODg4MfBO8O8HcbC90L6tYHDg4ODg5+Mny38LSQ7kCiDU07MODg4ODg4DeEVxv6qwCSBppuwGk3IsDBwcHBwW8I7waEtLBq46K6oAAODg4ODv4EeLWwNPhUC+/+A8DBwcHBwU+C7/7QNKx6kekFXQ4UwMHBwcHBD4CnjYhqoJkCVBcYwMHBwcHBnwSfGgykgO6CQnuSAg4ODg4OfiP41OD+XQOF9GLigQI4ODg4OPiN4WlgSYPNbqBJBw3VBQNwcHBwcPAnwrsFVBsf1QsbCzDg4ODg4OA3gqeD/jTIpJ+nCwbxJAUcHBwcHPwgeLURMLVgMBWcLv8ODg4ODg5+EHxqcPCuxsRuo2K7DnBwcHBw8IPgnwomUwt+aWBZNiLAwcHBwcEPgFcbBt2BRHVgUK4fHBwcHBz8YHg1aKTfTy/m7ZMUcHBwcHBw8PHF+jRIgYODg4ODg8/Dq8Gkez7eiAAHBwcHB/8iPA0O6QAgDTDdhQFwcHBwcPAnwKvBYOoidgNIdTABDg4ODg5+IvxpBxwcHBwc/IDzDxDyBwHZ5cyhAAAAAElFTkSuQmCC\">\n          </div>\n        </div>\n      \n    \n  </div>\n</div>\n\n\n\n        \n      \n    </div>\n  </section>\n\n\n        \n        \n      </section>\n    </article>\n  \n\n  \n    <!-- 显示推荐文章和评论 -->\n\n\n\n  <article class=\"post white-box comments shadow floatable\">\n    <section class=\"article typo\">\n      <p ct><i class='fas fa-comments'></i> Comment</p>\n      \n      \n      \n      \n      \n        <section id=\"comments\">\n          <div id=\"valine_container\" class=\"valine_thread\">\n            <i class=\"fas fa-spinner fa-spin fa-fw\"></i>\n          </div>\n        </section>\n      \n    </section>\n  </article>\n\n\n  \n\n\n\n\n<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->\n\n\n\n  <script>\n    window.subData = {\n      title: '相册',\n      tools: true\n    }\n  </script>\n\n\n</div>\n<aside class='l_side'>\n  \n  \n    \n    \n\n<section class=\"widget blogger shadow floatable desktop\">\n  <div class='content'>\n    \n      <div class='avatar'>\n        <img class='avatar' src='https://s1.ax1x.com/2020/03/13/8mvbCj.jpg'/>\n      </div>\n    \n    \n      <div class='text'>\n        \n        \n        \n          <p><span id=\"jinrishici-sentence\">Liz'blog</span></p>\n          <script src=\"https://sdk.jinrishici.com/v2/browser/jinrishici.js\" charset=\"utf-8\"></script>\n        \n      </div>\n    \n    \n      <div class=\"social-wrapper\">\n        \n          \n            <a href=\"https://github.com/Chemlez\"\n              class=\"social fab fa-github flat-btn\"\n              target=\"_blank\"\n              rel=\"external nofollow noopener noreferrer\">\n            </a>\n          \n        \n          \n            <a href=\"https://weibo.com/u/5653780011?nick=Sane_z&is_all=1\"\n              class=\"social fab fa-weibo flat-btn\"\n              target=\"_blank\"\n              rel=\"external nofollow noopener noreferrer\">\n            </a>\n          \n        \n          \n            <a href=\"mailto:liz_1106@163.com\"\n              class=\"social fas fa-envelope flat-btn\"\n              target=\"_blank\"\n              rel=\"external nofollow noopener noreferrer\">\n            </a>\n          \n        \n      </div>\n    \n  </div>\n</section>\n\n  \n\n  \n    \n    \n  \n\n  <section class=\"widget category shadow floatable desktop\">\n    \n  <header>\n    \n      <a href='/categories/'><i class=\"fas fa-folder-open fa-fw\" aria-hidden=\"true\"></i><span class='name'>文章分类</span></a>\n    \n  </header>\n\n\n    <div class='content'>\n      <ul class=\"entry navigation\">\n        \n          <li><a class=\"flat-box\"\n            title=\"/categories/Java/\" href=\"/categories/Java/\"\n            id=\"categoriesJava\"\n            ><div class='name'>Java</div><div class='badge'>(16)</div></a></li>\n        \n          <li><a class=\"flat-box child\"\n            title=\"/categories/Java/%E6%A1%86%E6%9E%B6/\" href=\"/categories/Java/%E6%A1%86%E6%9E%B6/\"\n            id=\"categoriesJavaE6A186E69EB6\"\n            ><div class='name'>框架</div><div class='badge'>(1)</div></a></li>\n        \n          <li><a class=\"flat-box\"\n            title=\"/categories/Linux/\" href=\"/categories/Linux/\"\n            id=\"categoriesLinux\"\n            ><div class='name'>Linux</div><div class='badge'>(2)</div></a></li>\n        \n          <li><a class=\"flat-box\"\n            title=\"/categories/Machine-Learning/\" href=\"/categories/Machine-Learning/\"\n            id=\"categoriesMachine-Learning\"\n            ><div class='name'>Machine Learning</div><div class='badge'>(2)</div></a></li>\n        \n          <li><a class=\"flat-box child\"\n            title=\"/categories/Machine-Learning/sklearn/\" href=\"/categories/Machine-Learning/sklearn/\"\n            id=\"categoriesMachine-Learningsklearn\"\n            ><div class='name'>sklearn</div><div class='badge'>(2)</div></a></li>\n        \n          <li><a class=\"flat-box\"\n            title=\"/categories/Mongodb/\" href=\"/categories/Mongodb/\"\n            id=\"categoriesMongodb\"\n            ><div class='name'>Mongodb</div><div class='badge'>(1)</div></a></li>\n        \n          <li><a class=\"flat-box\"\n            title=\"/categories/Python/\" href=\"/categories/Python/\"\n            id=\"categoriesPython\"\n            ><div class='name'>Python</div><div class='badge'>(3)</div></a></li>\n        \n          <li><a class=\"flat-box child\"\n            title=\"/categories/Python/%E7%88%AC%E8%99%AB/\" href=\"/categories/Python/%E7%88%AC%E8%99%AB/\"\n            id=\"categoriesPythonE788ACE899AB\"\n            ><div class='name'>爬虫</div><div class='badge'>(2)</div></a></li>\n        \n          <li><a class=\"flat-box\"\n            title=\"/categories/git/\" href=\"/categories/git/\"\n            id=\"categoriesgit\"\n            ><div class='name'>git</div><div class='badge'>(1)</div></a></li>\n        \n          <li><a class=\"flat-box\"\n            title=\"/categories/%E5%89%8D%E7%AB%AF/\" href=\"/categories/%E5%89%8D%E7%AB%AF/\"\n            id=\"categoriesE5898DE7ABAF\"\n            ><div class='name'>前端</div><div class='badge'>(1)</div></a></li>\n        \n      </ul>\n    </div>\n  </section>\n\n\n  \n\n  \n    \n    \n  \n\n  <section class=\"widget tagcloud shadow floatable desktop\">\n    \n  <header>\n    \n      <a href='/tags/'><i class=\"fas fa-tags fa-fw\" aria-hidden=\"true\"></i><span class='name'>热门标签</span></a>\n    \n  </header>\n\n\n    <div class='content'>\n      <a href=\"/tags/Beautifulsoup/\" style=\"font-size: 19px; color: #777\">Beautifulsoup</a> <a href=\"/tags/Data-Preprocessing/\" style=\"font-size: 14px; color: #999\">Data Preprocessing</a> <a href=\"/tags/DecisionTree/\" style=\"font-size: 14px; color: #999\">DecisionTree</a> <a href=\"/tags/Feature-Engineering/\" style=\"font-size: 14px; color: #999\">Feature Engineering</a> <a href=\"/tags/Filter/\" style=\"font-size: 14px; color: #999\">Filter</a> <a href=\"/tags/IO%E6%B5%81/\" style=\"font-size: 14px; color: #999\">IO流</a> <a href=\"/tags/JDBC/\" style=\"font-size: 19px; color: #777\">JDBC</a> <a href=\"/tags/JQuery/\" style=\"font-size: 14px; color: #999\">JQuery</a> <a href=\"/tags/Java/\" style=\"font-size: 24px; color: #555\">Java</a> <a href=\"/tags/JavaScript/\" style=\"font-size: 14px; color: #999\">JavaScript</a> <a href=\"/tags/JavaWeb/\" style=\"font-size: 19px; color: #777\">JavaWeb</a> <a href=\"/tags/Kaggle/\" style=\"font-size: 14px; color: #999\">Kaggle</a> <a href=\"/tags/Linux/\" style=\"font-size: 19px; color: #777\">Linux</a> <a href=\"/tags/MBG/\" style=\"font-size: 14px; color: #999\">MBG</a> <a href=\"/tags/MVC/\" style=\"font-size: 14px; color: #999\">MVC</a> <a href=\"/tags/Mapper/\" style=\"font-size: 14px; color: #999\">Mapper</a> <a href=\"/tags/Mongodb/\" style=\"font-size: 14px; color: #999\">Mongodb</a> <a href=\"/tags/MySQL/\" style=\"font-size: 24px; color: #555\">MySQL</a> <a href=\"/tags/Mybatis/\" style=\"font-size: 24px; color: #555\">Mybatis</a> <a href=\"/tags/Python/\" style=\"font-size: 14px; color: #999\">Python</a> <a href=\"/tags/Request/\" style=\"font-size: 19px; color: #777\">Request</a> <a href=\"/tags/Servlet/\" style=\"font-size: 24px; color: #555\">Servlet</a> <a href=\"/tags/Spring/\" style=\"font-size: 19px; color: #777\">Spring</a> <a href=\"/tags/SpringMVC/\" style=\"font-size: 19px; color: #777\">SpringMVC</a> <a href=\"/tags/Springboot-starter/\" style=\"font-size: 14px; color: #999\">Springboot-starter</a> <a href=\"/tags/VMware/\" style=\"font-size: 14px; color: #999\">VMware</a> <a href=\"/tags/conda/\" style=\"font-size: 14px; color: #999\">conda</a> <a href=\"/tags/git/\" style=\"font-size: 14px; color: #999\">git</a> <a href=\"/tags/hexo/\" style=\"font-size: 14px; color: #999\">hexo</a> <a href=\"/tags/redis/\" style=\"font-size: 14px; color: #999\">redis</a> <a href=\"/tags/servlet/\" style=\"font-size: 14px; color: #999\">servlet</a> <a href=\"/tags/sklearn/\" style=\"font-size: 19px; color: #777\">sklearn</a> <a href=\"/tags/ssm/\" style=\"font-size: 14px; color: #999\">ssm</a> <a href=\"/tags/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/\" style=\"font-size: 14px; color: #999\">动态代理</a> <a href=\"/tags/%E5%8F%8D%E5%B0%84/\" style=\"font-size: 19px; color: #777\">反射</a> <a href=\"/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/\" style=\"font-size: 19px; color: #777\">正则表达式</a> <a href=\"/tags/%E6%BA%90%E7%A0%81/\" style=\"font-size: 19px; color: #777\">源码</a> <a href=\"/tags/%E7%88%AC%E8%99%AB/\" style=\"font-size: 19px; color: #777\">爬虫</a> <a href=\"/tags/%E8%A1%A8%E5%8D%95%E9%AA%8C%E8%AF%81/\" style=\"font-size: 14px; color: #999\">表单验证</a>\n    </div>\n  </section>\n\n\n  \n\n  \n    \n    \n\n\n  <section class=\"widget toc-wrapper shadow floatable desktop mobile\">\n    \n  <header>\n    \n      <i class=\"fas fa-list fa-fw\" aria-hidden=\"true\"></i><span class='name'>本文目录</span>\n    \n  </header>\n\n\n    <div class='content'>\n      \n    </div>\n  </section>\n\n\n  \n\n\n</aside>\n\n\n  \n  <footer class=\"clearfix\">\n    <br><br>\n    \n      \n        <div class=\"aplayer-container\">\n          \n\n\n        </div>\n      \n    \n      \n        <br>\n        <div class=\"social-wrapper\">\n          \n            \n              <a href=\"https://github.com/Chemlez\"\n                class=\"social fab fa-github flat-btn\"\n                target=\"_blank\"\n                rel=\"external nofollow noopener noreferrer\">\n              </a>\n            \n          \n            \n              <a href=\"https://weibo.com/u/5653780011?nick=Sane_z&amp;is_all=1\"\n                class=\"social fab fa-weibo flat-btn\"\n                target=\"_blank\"\n                rel=\"external nofollow noopener noreferrer\">\n              </a>\n            \n          \n            \n              <a href=\"mailto:liz_1106@163.com\"\n                class=\"social fas fa-envelope flat-btn\"\n                target=\"_blank\"\n                rel=\"external nofollow noopener noreferrer\">\n              </a>\n            \n          \n        </div>\n      \n    \n      \n        <div class='copyright'>\n        <p><a href=\"https://liizhi.cn\" target=\"_blank\" rel=\"noopener\">Copyright © 2019-2020 Chemlez</a></p>\n\n        </div>\n      \n    \n  </footer>\n\n<script>setLoadingBarProgress(80);</script>\n\n\n      <script>setLoadingBarProgress(60);</script>\n    </div>\n    <a class=\"s-top fas fa-arrow-up fa-fw\" href='javascript:void(0)'></a>\n  </div>\n  \n<script src=\"https://cdn.jsdelivr.net/npm/jquery@3.4/dist/jquery.min.js\"></script>\n\n\n  <script>\n    \n    var SEARCH_SERVICE = \"hexo\" || \"hexo\";\n    var ROOT = \"/\" || \"/\";\n    if (!ROOT.endsWith('/')) ROOT += '/';\n  </script>\n\n\n  <script async src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/instant_page.js\" type=\"module\" defer integrity=\"sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1\"></script>\n\n\n\n  \n<script src=\"https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js\"></script>\n\n  <script type=\"text/javascript\">\n    $(function() {\n      Waves.attach('.flat-btn', ['waves-button']);\n      Waves.attach('.float-btn', ['waves-button', 'waves-float']);\n      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);\n      Waves.attach('.flat-box', ['waves-block']);\n      Waves.attach('.float-box', ['waves-block', 'waves-float']);\n      Waves.attach('.waves-image');\n      Waves.init();\n    });\n  </script>\n\n\n  <script async src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js\"></script>\n\n\n\n  \n  \n  \n    \n<script src=\"https://cdn.jsdelivr.net/npm/jquery-backstretch@2.1.18/jquery.backstretch.min.js\"></script>\n\n    <script type=\"text/javascript\">\n      $(function(){\n        var imgs=[\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-wallpaper/abstract/41F215B9-261F-48B4-80B5-4E86E165259E.jpeg\"];\n        if ('true' == 'true') {\n          function shuffle(arr){\n            /*From countercurrent-time*/\n            var n = arr.length;\n            while(n--) {\n              var index = Math.floor(Math.random() * n);\n              var temp = arr[index];\n              arr[index] = arr[n];\n              arr[n] = temp;\n            }\n          }\n          shuffle(imgs);\n        }\n        if ('.cover') {\n          $('.cover').backstretch(\n            imgs,\n          {\n            duration: \"20000\",\n            fade: \"1500\"\n          });\n        } else {\n          $.backstretch(\n            imgs,\n          {\n            duration: \"20000\",\n            fade: \"1500\"\n          });\n        }\n      });\n    </script>\n  \n\n\n\n\n\n\n\n\n\n\n  \n    \n<script src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.0/js/valine.js\"></script>\n\n  \n  <script>\n  var GUEST_INFO = ['nick','mail','link'];\n  var guest_info = 'nick,mail,link'.split(',').filter(function(item){\n    return GUEST_INFO.indexOf(item) > -1\n  });\n  var notify = 'true' == true;\n  var verify = 'true' == true;\n  var valine = new Valine();\n  valine.init({\n    el: '#valine_container',\n    notify: notify,\n    verify: verify,\n    guest_info: guest_info,\n    \n    appId: \"YSitK1ig1lRcy3jvrtTzT6fb-MdYXbMMI\",\n    appKey: \"e7hFf2zqvyWgNmDsClWcM7W3\",\n    placeholder: \"快来评论吧~\",\n    pageSize:'10',\n    avatar:'wavatar',\n    lang:'zh-cn',\n    visitor: 'false',\n    highlight:'true'\n  })\n  </script>\n\n\n\n  \n<script src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.1.5/js/app.js\"></script>\n\n\n\n  \n<script src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.1/js/search.js\"></script>\n\n\n\n  \n<script src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/comment_typing.js\"></script>\n\n\n\n<!-- 复制 -->\n\n  <script src=\"https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js\"></script>\n<script>\n  !function (e, t, a) {\n    var initCopyCode = function(){\n      var copyHtml = '';\n      copyHtml += '<button class=\"btn-copy\" data-clipboard-snippet=\"\">';\n      copyHtml += '<i class=\"fas fa-copy\"></i><span>COPY</span>';\n      copyHtml += '</button>';\n      $(\".highlight .code pre\").before(copyHtml);\n      var clipboard = new ClipboardJS('.btn-copy', {\n        target: function(trigger) {\n          return trigger.nextElementSibling;\n        }\n      });\n      clipboard.on('success', function(e) {\n        let $btn = $(e.trigger);\n        $btn.addClass('copyed');\n        let $icon = $($btn.find('i'));\n        $icon.removeClass('fa-copy');\n        $icon.addClass('fa-clipboard-check');\n        let $span = $($btn.find('span'));\n        $span[0].innerText = 'COPYED';\n      });\n      clipboard.on('error', function(e) {\n        e.clearSelection();\n        let $btn = $(e.trigger);\n        $btn.addClass('copy-failed');\n        let $icon = $($btn.find('i'));\n        $icon.removeClass('fa-copy');\n        $icon.addClass('fa-exclamation-triangle');\n        let $span = $($btn.find('span'));\n        $span[0].innerText = 'COPY FAILED';\n      });\n    }\n    initCopyCode();\n  }(window, document);\n</script>\n\n\n\n\n<!-- fancybox -->\n\n  <script src=\"https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js\"></script>\n<script>\n  let LAZY_LOAD_IMAGE = \"[object Object]\";\n  $(\".article-entry\").find(\"fancybox\").find(\"img\").each(function () {\n      var element = document.createElement(\"a\");\n      $(element).attr(\"data-fancybox\", \"gallery\");\n      $(element).attr(\"href\", $(this).attr(\"src\"));\n      /* 图片采用懒加载处理时,\n       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,\n       * 那么此处将原本的属性名src替换为对应属性名data-original,\n       * 修改如下\n       */\n       if (LAZY_LOAD_IMAGE) {\n         $(element).attr(\"href\", $(this).attr(\"data-original\"));\n       }\n      $(this).wrap(element);\n  });\n</script>\n\n\n\n\n\n\n  <script>setLoadingBarProgress(100);</script>\n<script>!function(e){var c=Array.prototype.slice.call(document.querySelectorAll(\"img[data-original]\"));function i(){for(var r=0;r<c.length;r++)t=c[r],0<=(n=t.getBoundingClientRect()).bottom&&0<=n.left&&n.top<=(e.innerHeight||document.documentElement.clientHeight)&&function(){var t,n,e,i,o=c[r];t=o,n=function(){c=c.filter(function(t){return o!==t})},e=new Image,i=t.getAttribute(\"data-original\"),e.onload=function(){t.src=i,n&&n()},e.src=i}();var t,n}i(),e.addEventListener(\"scroll\",function(){var t,n;t=i,n=e,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)})}(this);</script><script>window.addEventListener(\"load\",function(){var t=/\\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll(\"img[data-original]\")).forEach(function(a){var e=a.parentNode;\"A\"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script></body>\n</html>\n","date":"2021-03-28T10:52:14.223Z","updated":"2021-01-27T14:28:24.000Z","path":"blog-photo/videos.html","title":"","comments":1,"layout":"page","_id":"cl2enrqzs0014y2lo0gu6aj4z","content":"<!DOCTYPE html>\n<html>\n<head hexo-theme=\"https://volantis.js.org/#\">\n  <meta charset=\"utf-8\">\n  <!-- SEO相关 -->\n  \n    \n  \n  <!-- 渲染优化 -->\n  <meta name=\"renderer\" content=\"webkit\">\n  <meta name=\"force-rendering\" content=\"webkit\">\n  <meta http-equiv=\"X-UA-Compatible\" content=\"IE=Edge,chrome=1\">\n  <meta name=\"HandheldFriendly\" content=\"True\">\n  <meta name=\"apple-mobile-web-app-capable\" content=\"yes\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1, maximum-scale=1\">\n\n  <!-- 页面元数据 -->\n  \n    <title>相册 - Liz&#39;blog</title>\n  \n  \n\n  <!-- feed -->\n  \n\n  <!-- import meta -->\n  \n\n  <!-- link -->\n  <link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css\">\n  \n    \n<link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css\">\n\n  \n  \n    \n<link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css\">\n\n  \n\n  \n  <link rel=\"shortcut icon\" type=\"image/x-icon\" href=\"https://s1.ax1x.com/2020/03/15/81ZR5F.jpg\">\n  \n\n  \n\n  <!-- import link -->\n  \n\n  \n    \n<link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.1.5.2/css/style.css\">\n\n  \n\n  <script>\n    function setLoadingBarProgress(num) {\n      document.getElementById('loading-bar').style.width=num+\"%\";\n    }\n  </script>\n\n  \n  \n</head>\n\n<body>\n  \n  <div id=\"loading-bar-wrapper\">\n  <div id=\"loading-bar\"></div>\n</div>\n<header class=\"l_header shadow blur\">\n\n  <div class=\"wrapper\">\n    <div class=\"nav-sub container--flex\">\n      <a class=\"logo flat-box\"></a>\n      <ul class=\"switcher h-list\">\n        <li><a class=\"s-comment flat-btn fas fa-comments fa-fw\" target=\"_self\" href=\"javascript:void(0)\"></a></li>\n        \n          <li><a class=\"s-toc flat-btn fas fa-list fa-fw\" target=\"_self\" href=\"javascript:void(0)\"></a></li>\n        \n      </ul>\n    </div>\n\t\t<div class=\"nav-main container container--flex\">\n      \n        \n        <a class=\"logo flat-box\" target=\"_self\" href=\"/\">\n          \n          \n          \n          \n            CHEMLEZ <b><sup style=\"color:#3AA757\"></sup></b>\n          \n        </a>\n      \n\n\t\t\t<div class=\"menu navigation\">\n\t\t\t\t<ul class=\"h-list\">\n          \n          \n          \n            \n            \n              <li>\n                <a class=\"flat-box\" href=\"/\" id=\"home\">\n                  \n                    <i class=\"fas fa-home fa-fw\"></i>\n                  \n                  主页\n                </a>\n                \n              </li>\n            \n          \n          \n            \n            \n              <li>\n                <a class=\"flat-box\">\n                  \n                    <i class=\"fas fa-list-alt fa-fw fa-fw\"></i>\n                  \n                  索引\n                </a>\n                \n                  <ul class=\"submenu\">\n                    \n                      \n            \n              <li>\n                <a class=\"flat-box\" href=\"/tags/\" id=\"tags\">\n                  \n                    <i class=\"fas fa-tags fa-fw\"></i>\n                  \n                  标签\n                </a>\n                \n              </li>\n            \n          \n                    \n                      \n            \n              <li>\n                <a class=\"flat-box\" href=\"/categories/\" id=\"categories\">\n                  \n                    <i class=\"fas fa-folder-open fa-fw\"></i>\n                  \n                  类别\n                </a>\n                \n              </li>\n            \n          \n                    \n                      \n            \n              <li>\n                <a class=\"flat-box\" href=\"/archives/\" id=\"archives\">\n                  \n                    <i class=\"fas fa-archive fa-fw\"></i>\n                  \n                  归档\n                </a>\n                \n              </li>\n            \n          \n                    \n                  </ul>\n                \n              </li>\n            \n          \n          \n            \n            \n              <li>\n                <a class=\"flat-box\" href=\"/friends/\" id=\"friends\">\n                  \n                    <i class=\"fas fa-link fa-fw\"></i>\n                  \n                  友链\n                </a>\n                \n              </li>\n            \n          \n          \n            \n            \n              <li>\n                <a class=\"flat-box\" href=\"/about/\" id=\"about\">\n                  \n                    <i class=\"fas fa-info-circle fa-fw\"></i>\n                  \n                  关于\n                </a>\n                \n              </li>\n            \n          \n          \n\t\t\t\t</ul>\n\t\t\t</div>\n\n      \n        <div class=\"m_search\">\n          <form name=\"searchform\" class=\"form u-search-form\">\n            <i class=\"icon fas fa-search fa-fw\"></i>\n            <input type=\"text\" class=\"input u-search-input\" placeholder=\"搜索\">\n          </form>\n        </div>\n      \n\n\t\t\t<ul class=\"switcher h-list\">\n\t\t\t\t\n\t\t\t\t\t<li><a class=\"s-search flat-btn fas fa-search fa-fw\" target=\"_self\" href=\"javascript:void(0)\"></a></li>\n\t\t\t\t\n\t\t\t\t<li><a class=\"s-menu flat-btn fas fa-bars fa-fw\" target=\"_self\" href=\"javascript:void(0)\"></a></li>\n\t\t\t</ul>\n\t\t</div>\n\t</div>\n</header>\n<ul class=\"menu-phone navigation white-box\">\n  \n  \n    <li>\n      <a class=\"flat-box\" href=\"/\" id=\"home\">\n        \n          <i class=\"fas fa-clock fa-fw fa-fw\"></i>\n        \n        近期文章\n      </a>\n    </li>\n  \n    <li>\n      <a class=\"flat-box\" href=\"/archives/\" id=\"archives\">\n        \n          <i class=\"fas fa-list-alt fa-fw fa-fw\"></i>\n        \n        文章归档\n      </a>\n    </li>\n  \n    <li>\n      <a class=\"flat-box\" href=\"/categories/\" id=\"categories\">\n        \n          <i class=\"fas fa-folder-open fa-fw\"></i>\n        \n        文章类别\n      </a>\n    </li>\n  \n    <li>\n      <a class=\"flat-box\" href=\"/tags/\" id=\"tags\">\n        \n          <i class=\"fas fa-tags fa-fw\"></i>\n        \n        文章标签\n      </a>\n    </li>\n  \n    <li>\n      <a class=\"flat-box\" href=\"/friends/\" id=\"friends\">\n        \n          <i class=\"fas fa-link fa-fw\"></i>\n        \n        我的友链\n      </a>\n    </li>\n  \n    <li>\n      <a class=\"flat-box\" href=\"/about/\" id=\"about\">\n        \n          <i class=\"fas fa-info-circle fa-fw\"></i>\n        \n        关于小站\n      </a>\n    </li>\n  \n</ul>\n<script>setLoadingBarProgress(40);</script>\n\n\n\n  <div class=\"l_body nocover\">\n    <div class=\"body-wrapper\">\n      \n\n<div class=\"l_main\">\n  \n\n  \n    <article id=\"post\" class=\"post white-box shadow floatable article-type-post\" itemscope itemprop=\"blogPost\">\n      \n\n\n  <section class=\"meta\">\n    \n    \n    <div class=\"meta\" id=\"header-meta\">\n      \n        \n  \n    <h1 class=\"title\">\n      <a href=\"/photos/videos.html\">\n        相册\n      </a>\n    </h1>\n  \n\n\n      \n      <div class=\"new-meta-box\">\n        \n          \n        \n          \n            \n<div class=\"new-meta-item author\">\n  <a href=\"https://liizhi.cn\" target=\"_blank\" rel=\"nofollow noopener\">\n    <img src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/placeholder/d570170f4f12e1ee829ca0e85a7dffeb77343a.svg\" data-original=\"https://s1.ax1x.com/2020/03/13/8mvbCj.jpg\">\n    <p>Chemlez</p>\n  </a>\n</div>\n\n          \n        \n          \n            \n\n          \n        \n          \n            <div class=\"new-meta-item date\">\n  <a class=\"notlink\">\n    <i class=\"fas fa-edit\" aria-hidden=\"true\"></i>\n    <p>发布于：Mar 14, 2020</p>\n  </a>\n</div>\n\n          \n        \n          \n            \n\n          \n        \n      </div>\n      \n        <hr>\n      \n    </div>\n  </section>\n\n\n      <section class=\"article typo\">\n        <div class=\"article-entry\" itemprop=\"articleBody\">\n          \n          <link rel=\"stylesheet\" href=\"./ins.css\">\n<div class=\"photos-btn-wrap\">\t<a class=\"photos-btn\" href=\"/photos\">Photos</a>\n\t<a class=\"photos-btn active\" href=\"/photos/videos.html\">Videos</a>\n\n</div>\n<center>\n    <h1>指弹_女儿情</h1>\n</center>\n<hr>\n<center>\n    <div class=\"video-container\">\n        <iframe height=\"80%\" width=\"80%\" src=\"https://player.youku.com/embed/XMjUzMzY4OTM3Ng==\" frameborder=\"0\" allowfullscreen></iframe>\n    </div>\n</center>\n<hr>\n<center>\n    <h1>指弹_友谊地久天长</h1>\n</center>\n<hr>\n<center>\n    <div class=\"video-container\">\n        <iframe height=\"80%\" width=\"80%\" src=\"https://player.youku.com/embed/XMjQ5MDExOTY2MA==\" frameborder=\"0\" allowfullscreen></iframe>\n    </div>\n</center>\n<hr>\n<center>\n    <h1>指弹_Always with me</h1>\n</center>\n<hr>\n<center>\n    <div class=\"video-container\">\n        <iframe height=\"80%\" width=\"80%\" src=\"https://player.youku.com/embed/XMjQ4MDQyNTQ0MA==\" frameborder=\"0\" allowfullscreen></iframe>\n    </div>\n</center>\n          \n            <br>\n            \n  \n    \n    \n\n<section class=\"widget copyright  desktop mobile\">\n  <div class=\"content\">\n    \n      <blockquote>\n        \n          \n            <p>博客内容遵循 署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</p>\n\n          \n        \n          \n            <p>本文永久链接是：<a href=\"https://www.chemlez.cn/photos/videos.html\">https://www.chemlez.cn/photos/videos.html</a></p>\n          \n        \n      </blockquote>\n    \n  </div>\n</section>\n\n  \n\n  \n    \n    \n  \n\n  <section class=\"widget related_posts  desktop mobile\">\n    \n  <header>\n    \n      <i class=\"fas fa-bookmark fa-fw\" aria-hidden=\"true\"></i><span class=\"name\">相关文章</span>\n    \n  </header>\n\n\n    <div class=\"content\">\n      <ul class=\"popular-posts\"><li class=\"popular-posts-item\"><div class=\"popular-posts-title\"><h3><a href=\"/2020/09/03/Java基础之Filter/\" title=\"Java基础之Filter\" rel=\"bookmark\">Java基础之Filter</a></h3></div></li></ul>\n    </div>\n  </section>\n\n\n  \n\n\n          \n        </div>\n        \n          \n\n\n  <section class=\"meta\" id=\"footer-meta\">\n    <div class=\"new-meta-box\">\n      \n        \n          <div class=\"new-meta-item date\" itemprop=\"dateUpdated\" datetime=\"2019-08-24T15:36:10+08:00\">\n  <a class=\"notlink\">\n    <i class=\"fas fa-save\" aria-hidden=\"true\"></i>\n    <p>更新于：Aug 24, 2019</p>\n  </a>\n</div>\n\n        \n      \n        \n          \n\n        \n      \n        \n          \n  <div class=\"new-meta-item share -mob-share-list\">\n  <div class=\"-mob-share-list share-body\">\n    \n      \n        <a class=\"-mob-share-qq\" title rel=\"external nofollow noopener noreferrer\" href=\"http://connect.qq.com/widget/shareqq/index.html?url=https://www.chemlez.cn/photos/videos.html&title=相册 - Liz'blog&summary=\">\n          \n            <img src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/placeholder/d570170f4f12e1ee829ca0e85a7dffeb77343a.svg\" data-original=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qq.png\">\n          \n        </a>\n      \n    \n      \n        <a class=\"-mob-share-qzone\" title rel=\"external nofollow noopener noreferrer\" href=\"https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://www.chemlez.cn/photos/videos.html&title=相册 - Liz'blog&summary=\">\n          \n            <img src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/placeholder/d570170f4f12e1ee829ca0e85a7dffeb77343a.svg\" data-original=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qzone.png\">\n          \n        </a>\n      \n    \n      \n        <a class=\"-mob-share-weibo\" title rel=\"external nofollow noopener noreferrer\" href=\"http://service.weibo.com/share/share.php?url=https://www.chemlez.cn/photos/videos.html&title=相册 - Liz'blog&summary=\">\n          \n            <img src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/placeholder/d570170f4f12e1ee829ca0e85a7dffeb77343a.svg\" data-original=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/weibo.png\">\n          \n        </a>\n      \n    \n      \n        \n        <div class=\"hoverbox\">\n          <a><img src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/placeholder/d570170f4f12e1ee829ca0e85a7dffeb77343a.svg\" data-original=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/wechat.png\"></a>\n          <div class=\"target\">\n            <img src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPgAAAD4CAAAAADkunTXAAACT0lEQVR42u3aSXLDMAwEQP//08kLVOQA8CKqeZNTltHMZQrA6++h5wUODg4ODn4Q/FU8ly8e/l76/tV7wMHBwcHBT4RvB4BFQavn6sVM1QsODg4ODn4yfBkAFs/dQq/qGKsXHBwcHBwcfDuYVANMGpTAwcHBwcHB+wGmC7ltcgMHBwcHB/8BeNygH1oESC/265MUcHBwcHDwH4KXF+a+9FyuFxwcHBwc/CB496wCS7o4sBuAyvWCg4ODg4MfBO8O8HcbC90L6tYHDg4ODg5+Mny38LSQ7kCiDU07MODg4ODg4DeEVxv6qwCSBppuwGk3IsDBwcHBwW8I7waEtLBq46K6oAAODg4ODv4EeLWwNPhUC+/+A8DBwcHBwU+C7/7QNKx6kekFXQ4UwMHBwcHBD4CnjYhqoJkCVBcYwMHBwcHBnwSfGgykgO6CQnuSAg4ODg4OfiP41OD+XQOF9GLigQI4ODg4OPiN4WlgSYPNbqBJBw3VBQNwcHBwcPAnwrsFVBsf1QsbCzDg4ODg4OA3gqeD/jTIpJ+nCwbxJAUcHBwcHPwgeLURMLVgMBWcLv8ODg4ODg5+EHxqcPCuxsRuo2K7DnBwcHBw8IPgnwomUwt+aWBZNiLAwcHBwcEPgFcbBt2BRHVgUK4fHBwcHBz8YHg1aKTfTy/m7ZMUcHBwcHBw8PHF+jRIgYODg4ODg8/Dq8Gkez7eiAAHBwcHB/8iPA0O6QAgDTDdhQFwcHBwcPAnwKvBYOoidgNIdTABDg4ODg5+IvxpBxwcHBwc/IDzDxDyBwHZ5cyhAAAAAElFTkSuQmCC\">\n          </div>\n        </div>\n      \n    \n  </div>\n</div>\n\n\n\n        \n      \n    </div>\n  </section>\n\n\n        \n        \n      </section>\n    </article>\n  \n\n  \n    <!-- 显示推荐文章和评论 -->\n\n\n\n  <article class=\"post white-box comments shadow floatable\">\n    <section class=\"article typo\">\n      <p ct><i class=\"fas fa-comments\"></i> Comment</p>\n      \n      \n      \n      \n      \n        <section id=\"comments\">\n          <div id=\"valine_container\" class=\"valine_thread\">\n            <i class=\"fas fa-spinner fa-spin fa-fw\"></i>\n          </div>\n        </section>\n      \n    </section>\n  </article>\n\n\n  \n\n\n\n\n<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->\n\n\n\n  <script>\n    window.subData = {\n      title: '相册',\n      tools: true\n    }\n  </script>\n\n\n</div>\n<aside class=\"l_side\">\n  \n  \n    \n    \n\n<section class=\"widget blogger shadow floatable desktop\">\n  <div class=\"content\">\n    \n      <div class=\"avatar\">\n        <img class=\"avatar\" src=\"https://s1.ax1x.com/2020/03/13/8mvbCj.jpg\">\n      </div>\n    \n    \n      <div class=\"text\">\n        \n        \n        \n          <p><span id=\"jinrishici-sentence\">Liz'blog</span></p>\n          <script src=\"https://sdk.jinrishici.com/v2/browser/jinrishici.js\" charset=\"utf-8\"></script>\n        \n      </div>\n    \n    \n      <div class=\"social-wrapper\">\n        \n          \n            <a href=\"https://github.com/Chemlez\" class=\"social fab fa-github flat-btn\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">\n            </a>\n          \n        \n          \n            <a href=\"https://weibo.com/u/5653780011?nick=Sane_z&is_all=1\" class=\"social fab fa-weibo flat-btn\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">\n            </a>\n          \n        \n          \n            <a href=\"mailto:liz_1106@163.com\" class=\"social fas fa-envelope flat-btn\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">\n            </a>\n          \n        \n      </div>\n    \n  </div>\n</section>\n\n  \n\n  \n    \n    \n  \n\n  <section class=\"widget category shadow floatable desktop\">\n    \n  <header>\n    \n      <a href=\"/categories/\"><i class=\"fas fa-folder-open fa-fw\" aria-hidden=\"true\"></i><span class=\"name\">文章分类</span></a>\n    \n  </header>\n\n\n    <div class=\"content\">\n      <ul class=\"entry navigation\">\n        \n          <li><a class=\"flat-box\" title=\"/categories/Java/\" href=\"/categories/Java/\" id=\"categoriesJava\"><div class=\"name\">Java</div><div class=\"badge\">(16)</div></a></li>\n        \n          <li><a class=\"flat-box child\" title=\"/categories/Java/%E6%A1%86%E6%9E%B6/\" href=\"/categories/Java/%E6%A1%86%E6%9E%B6/\" id=\"categoriesJavaE6A186E69EB6\"><div class=\"name\">框架</div><div class=\"badge\">(1)</div></a></li>\n        \n          <li><a class=\"flat-box\" title=\"/categories/Linux/\" href=\"/categories/Linux/\" id=\"categoriesLinux\"><div class=\"name\">Linux</div><div class=\"badge\">(2)</div></a></li>\n        \n          <li><a class=\"flat-box\" title=\"/categories/Machine-Learning/\" href=\"/categories/Machine-Learning/\" id=\"categoriesMachine-Learning\"><div class=\"name\">Machine Learning</div><div class=\"badge\">(2)</div></a></li>\n        \n          <li><a class=\"flat-box child\" title=\"/categories/Machine-Learning/sklearn/\" href=\"/categories/Machine-Learning/sklearn/\" id=\"categoriesMachine-Learningsklearn\"><div class=\"name\">sklearn</div><div class=\"badge\">(2)</div></a></li>\n        \n          <li><a class=\"flat-box\" title=\"/categories/Mongodb/\" href=\"/categories/Mongodb/\" id=\"categoriesMongodb\"><div class=\"name\">Mongodb</div><div class=\"badge\">(1)</div></a></li>\n        \n          <li><a class=\"flat-box\" title=\"/categories/Python/\" href=\"/categories/Python/\" id=\"categoriesPython\"><div class=\"name\">Python</div><div class=\"badge\">(3)</div></a></li>\n        \n          <li><a class=\"flat-box child\" title=\"/categories/Python/%E7%88%AC%E8%99%AB/\" href=\"/categories/Python/%E7%88%AC%E8%99%AB/\" id=\"categoriesPythonE788ACE899AB\"><div class=\"name\">爬虫</div><div class=\"badge\">(2)</div></a></li>\n        \n          <li><a class=\"flat-box\" title=\"/categories/git/\" href=\"/categories/git/\" id=\"categoriesgit\"><div class=\"name\">git</div><div class=\"badge\">(1)</div></a></li>\n        \n          <li><a class=\"flat-box\" title=\"/categories/%E5%89%8D%E7%AB%AF/\" href=\"/categories/%E5%89%8D%E7%AB%AF/\" id=\"categoriesE5898DE7ABAF\"><div class=\"name\">前端</div><div class=\"badge\">(1)</div></a></li>\n        \n      </ul>\n    </div>\n  </section>\n\n\n  \n\n  \n    \n    \n  \n\n  <section class=\"widget tagcloud shadow floatable desktop\">\n    \n  <header>\n    \n      <a href=\"/tags/\"><i class=\"fas fa-tags fa-fw\" aria-hidden=\"true\"></i><span class=\"name\">热门标签</span></a>\n    \n  </header>\n\n\n    <div class=\"content\">\n      <a href=\"/tags/Beautifulsoup/\" style=\"font-size: 19px; color: #777\">Beautifulsoup</a> <a href=\"/tags/Data-Preprocessing/\" style=\"font-size: 14px; color: #999\">Data Preprocessing</a> <a href=\"/tags/DecisionTree/\" style=\"font-size: 14px; color: #999\">DecisionTree</a> <a href=\"/tags/Feature-Engineering/\" style=\"font-size: 14px; color: #999\">Feature Engineering</a> <a href=\"/tags/Filter/\" style=\"font-size: 14px; color: #999\">Filter</a> <a href=\"/tags/IO%E6%B5%81/\" style=\"font-size: 14px; color: #999\">IO流</a> <a href=\"/tags/JDBC/\" style=\"font-size: 19px; color: #777\">JDBC</a> <a href=\"/tags/JQuery/\" style=\"font-size: 14px; color: #999\">JQuery</a> <a href=\"/tags/Java/\" style=\"font-size: 24px; color: #555\">Java</a> <a href=\"/tags/JavaScript/\" style=\"font-size: 14px; color: #999\">JavaScript</a> <a href=\"/tags/JavaWeb/\" style=\"font-size: 19px; color: #777\">JavaWeb</a> <a href=\"/tags/Kaggle/\" style=\"font-size: 14px; color: #999\">Kaggle</a> <a href=\"/tags/Linux/\" style=\"font-size: 19px; color: #777\">Linux</a> <a href=\"/tags/MBG/\" style=\"font-size: 14px; color: #999\">MBG</a> <a href=\"/tags/MVC/\" style=\"font-size: 14px; color: #999\">MVC</a> <a href=\"/tags/Mapper/\" style=\"font-size: 14px; color: #999\">Mapper</a> <a href=\"/tags/Mongodb/\" style=\"font-size: 14px; color: #999\">Mongodb</a> <a href=\"/tags/MySQL/\" style=\"font-size: 24px; color: #555\">MySQL</a> <a href=\"/tags/Mybatis/\" style=\"font-size: 24px; color: #555\">Mybatis</a> <a href=\"/tags/Python/\" style=\"font-size: 14px; color: #999\">Python</a> <a href=\"/tags/Request/\" style=\"font-size: 19px; color: #777\">Request</a> <a href=\"/tags/Servlet/\" style=\"font-size: 24px; color: #555\">Servlet</a> <a href=\"/tags/Spring/\" style=\"font-size: 19px; color: #777\">Spring</a> <a href=\"/tags/SpringMVC/\" style=\"font-size: 19px; color: #777\">SpringMVC</a> <a href=\"/tags/Springboot-starter/\" style=\"font-size: 14px; color: #999\">Springboot-starter</a> <a href=\"/tags/VMware/\" style=\"font-size: 14px; color: #999\">VMware</a> <a href=\"/tags/conda/\" style=\"font-size: 14px; color: #999\">conda</a> <a href=\"/tags/git/\" style=\"font-size: 14px; color: #999\">git</a> <a href=\"/tags/hexo/\" style=\"font-size: 14px; color: #999\">hexo</a> <a href=\"/tags/redis/\" style=\"font-size: 14px; color: #999\">redis</a> <a href=\"/tags/servlet/\" style=\"font-size: 14px; color: #999\">servlet</a> <a href=\"/tags/sklearn/\" style=\"font-size: 19px; color: #777\">sklearn</a> <a href=\"/tags/ssm/\" style=\"font-size: 14px; color: #999\">ssm</a> <a href=\"/tags/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/\" style=\"font-size: 14px; color: #999\">动态代理</a> <a href=\"/tags/%E5%8F%8D%E5%B0%84/\" style=\"font-size: 19px; color: #777\">反射</a> <a href=\"/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/\" style=\"font-size: 19px; color: #777\">正则表达式</a> <a href=\"/tags/%E6%BA%90%E7%A0%81/\" style=\"font-size: 19px; color: #777\">源码</a> <a href=\"/tags/%E7%88%AC%E8%99%AB/\" style=\"font-size: 19px; color: #777\">爬虫</a> <a href=\"/tags/%E8%A1%A8%E5%8D%95%E9%AA%8C%E8%AF%81/\" style=\"font-size: 14px; color: #999\">表单验证</a>\n    </div>\n  </section>\n\n\n  \n\n  \n    \n    \n\n\n  <section class=\"widget toc-wrapper shadow floatable desktop mobile\">\n    \n  <header>\n    \n      <i class=\"fas fa-list fa-fw\" aria-hidden=\"true\"></i><span class=\"name\">本文目录</span>\n    \n  </header>\n\n\n    <div class=\"content\">\n      \n    </div>\n  </section>\n\n\n  \n\n\n</aside>\n\n\n  \n  <footer class=\"clearfix\">\n    <br><br>\n    \n      \n        <div class=\"aplayer-container\">\n          \n\n\n        </div>\n      \n    \n      \n        <br>\n        <div class=\"social-wrapper\">\n          \n            \n              <a href=\"https://github.com/Chemlez\" class=\"social fab fa-github flat-btn\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">\n              </a>\n            \n          \n            \n              <a href=\"https://weibo.com/u/5653780011?nick=Sane_z&amp;is_all=1\" class=\"social fab fa-weibo flat-btn\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">\n              </a>\n            \n          \n            \n              <a href=\"mailto:liz_1106@163.com\" class=\"social fas fa-envelope flat-btn\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">\n              </a>\n            \n          \n        </div>\n      \n    \n      \n        <div class=\"copyright\">\n        <p><a href=\"https://liizhi.cn\" target=\"_blank\" rel=\"noopener\">Copyright © 2019-2020 Chemlez</a></p>\n\n        </div>\n      \n    \n  </footer>\n\n<script>setLoadingBarProgress(80);</script>\n\n\n      <script>setLoadingBarProgress(60);</script>\n    </div>\n    <a class=\"s-top fas fa-arrow-up fa-fw\" href=\"javascript:void(0)\"></a>\n  </div>\n  \n<script src=\"https://cdn.jsdelivr.net/npm/jquery@3.4/dist/jquery.min.js\"></script>\n\n\n  <script>\n    \n    var SEARCH_SERVICE = \"hexo\" || \"hexo\";\n    var ROOT = \"/\" || \"/\";\n    if (!ROOT.endsWith('/')) ROOT += '/';\n  </script>\n\n\n  <script async src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/instant_page.js\" type=\"module\" defer integrity=\"sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1\"></script>\n\n\n\n  \n<script src=\"https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js\"></script>\n\n  <script type=\"text/javascript\">\n    $(function() {\n      Waves.attach('.flat-btn', ['waves-button']);\n      Waves.attach('.float-btn', ['waves-button', 'waves-float']);\n      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);\n      Waves.attach('.flat-box', ['waves-block']);\n      Waves.attach('.float-box', ['waves-block', 'waves-float']);\n      Waves.attach('.waves-image');\n      Waves.init();\n    });\n  </script>\n\n\n  <script async src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js\"></script>\n\n\n\n  \n  \n  \n    \n<script src=\"https://cdn.jsdelivr.net/npm/jquery-backstretch@2.1.18/jquery.backstretch.min.js\"></script>\n\n    <script type=\"text/javascript\">\n      $(function(){\n        var imgs=[\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-wallpaper/abstract/41F215B9-261F-48B4-80B5-4E86E165259E.jpeg\"];\n        if ('true' == 'true') {\n          function shuffle(arr){\n            /*From countercurrent-time*/\n            var n = arr.length;\n            while(n--) {\n              var index = Math.floor(Math.random() * n);\n              var temp = arr[index];\n              arr[index] = arr[n];\n              arr[n] = temp;\n            }\n          }\n          shuffle(imgs);\n        }\n        if ('.cover') {\n          $('.cover').backstretch(\n            imgs,\n          {\n            duration: \"20000\",\n            fade: \"1500\"\n          });\n        } else {\n          $.backstretch(\n            imgs,\n          {\n            duration: \"20000\",\n            fade: \"1500\"\n          });\n        }\n      });\n    </script>\n  \n\n\n\n\n\n\n\n\n\n\n  \n    \n<script src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.0/js/valine.js\"></script>\n\n  \n  <script>\n  var GUEST_INFO = ['nick','mail','link'];\n  var guest_info = 'nick,mail,link'.split(',').filter(function(item){\n    return GUEST_INFO.indexOf(item) > -1\n  });\n  var notify = 'true' == true;\n  var verify = 'true' == true;\n  var valine = new Valine();\n  valine.init({\n    el: '#valine_container',\n    notify: notify,\n    verify: verify,\n    guest_info: guest_info,\n    \n    appId: \"YSitK1ig1lRcy3jvrtTzT6fb-MdYXbMMI\",\n    appKey: \"e7hFf2zqvyWgNmDsClWcM7W3\",\n    placeholder: \"快来评论吧~\",\n    pageSize:'10',\n    avatar:'wavatar',\n    lang:'zh-cn',\n    visitor: 'false',\n    highlight:'true'\n  })\n  </script>\n\n\n\n  \n<script src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.1.5/js/app.js\"></script>\n\n\n\n  \n<script src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.1/js/search.js\"></script>\n\n\n\n  \n<script src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/comment_typing.js\"></script>\n\n\n\n<!-- 复制 -->\n\n  <script src=\"https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js\"></script>\n<script>\n  !function (e, t, a) {\n    var initCopyCode = function(){\n      var copyHtml = '';\n      copyHtml += '<button class=\"btn-copy\" data-clipboard-snippet=\"\">';\n      copyHtml += '<i class=\"fas fa-copy\"></i><span>COPY</span>';\n      copyHtml += '</button>';\n      $(\".highlight .code pre\").before(copyHtml);\n      var clipboard = new ClipboardJS('.btn-copy', {\n        target: function(trigger) {\n          return trigger.nextElementSibling;\n        }\n      });\n      clipboard.on('success', function(e) {\n        let $btn = $(e.trigger);\n        $btn.addClass('copyed');\n        let $icon = $($btn.find('i'));\n        $icon.removeClass('fa-copy');\n        $icon.addClass('fa-clipboard-check');\n        let $span = $($btn.find('span'));\n        $span[0].innerText = 'COPYED';\n      });\n      clipboard.on('error', function(e) {\n        e.clearSelection();\n        let $btn = $(e.trigger);\n        $btn.addClass('copy-failed');\n        let $icon = $($btn.find('i'));\n        $icon.removeClass('fa-copy');\n        $icon.addClass('fa-exclamation-triangle');\n        let $span = $($btn.find('span'));\n        $span[0].innerText = 'COPY FAILED';\n      });\n    }\n    initCopyCode();\n  }(window, document);\n</script>\n\n\n\n\n<!-- fancybox -->\n\n  <script src=\"https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js\"></script>\n<script>\n  let LAZY_LOAD_IMAGE = \"[object Object]\";\n  $(\".article-entry\").find(\"fancybox\").find(\"img\").each(function () {\n      var element = document.createElement(\"a\");\n      $(element).attr(\"data-fancybox\", \"gallery\");\n      $(element).attr(\"href\", $(this).attr(\"src\"));\n      /* 图片采用懒加载处理时,\n       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,\n       * 那么此处将原本的属性名src替换为对应属性名data-original,\n       * 修改如下\n       */\n       if (LAZY_LOAD_IMAGE) {\n         $(element).attr(\"href\", $(this).attr(\"data-original\"));\n       }\n      $(this).wrap(element);\n  });\n</script>\n\n\n\n\n\n\n  <script>setLoadingBarProgress(100);</script>\n<script>!function(e){var c=Array.prototype.slice.call(document.querySelectorAll(\"img[data-original]\"));function i(){for(var r=0;r<c.length;r++)t=c[r],0<=(n=t.getBoundingClientRect()).bottom&&0<=n.left&&n.top<=(e.innerHeight||document.documentElement.clientHeight)&&function(){var t,n,e,i,o=c[r];t=o,n=function(){c=c.filter(function(t){return o!==t})},e=new Image,i=t.getAttribute(\"data-original\"),e.onload=function(){t.src=i,n&&n()},e.src=i}();var t,n}i(),e.addEventListener(\"scroll\",function(){var t,n;t=i,n=e,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)})}(this);</script><script>window.addEventListener(\"load\",function(){var t=/\\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll(\"img[data-original]\")).forEach(function(a){var e=a.parentNode;\"A\"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script></body>\n</html>\n","site":{"data":{"photography":[{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","title":"玉渊潭","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","title":"花儿","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","title":"白塔寺","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"}]}},"excerpt":"","more":"<!DOCTYPE html>\n<html>\n<head hexo-theme=\"https://volantis.js.org/#\">\n  <meta charset=\"utf-8\">\n  <!-- SEO相关 -->\n  \n    \n  \n  <!-- 渲染优化 -->\n  <meta name=\"renderer\" content=\"webkit\">\n  <meta name=\"force-rendering\" content=\"webkit\">\n  <meta http-equiv=\"X-UA-Compatible\" content=\"IE=Edge,chrome=1\">\n  <meta name=\"HandheldFriendly\" content=\"True\">\n  <meta name=\"apple-mobile-web-app-capable\" content=\"yes\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1, maximum-scale=1\">\n\n  <!-- 页面元数据 -->\n  \n    <title>相册 - Liz&#39;blog</title>\n  \n  \n\n  <!-- feed -->\n  \n\n  <!-- import meta -->\n  \n\n  <!-- link -->\n  <link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css\">\n  \n    \n<link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css\">\n\n  \n  \n    \n<link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css\">\n\n  \n\n  \n  <link rel=\"shortcut icon\" type=\"image/x-icon\" href=\"https://s1.ax1x.com/2020/03/15/81ZR5F.jpg\">\n  \n\n  \n\n  <!-- import link -->\n  \n\n  \n    \n<link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.1.5.2/css/style.css\">\n\n  \n\n  <script>\n    function setLoadingBarProgress(num) {\n      document.getElementById('loading-bar').style.width=num+\"%\";\n    }\n  </script>\n\n  \n  \n</head>\n\n<body>\n  \n  <div id=\"loading-bar-wrapper\">\n  <div id=\"loading-bar\"></div>\n</div>\n<header class=\"l_header shadow blur\">\n\n  <div class=\"wrapper\">\n    <div class=\"nav-sub container--flex\">\n      <a class=\"logo flat-box\"></a>\n      <ul class=\"switcher h-list\">\n        <li><a class=\"s-comment flat-btn fas fa-comments fa-fw\" target=\"_self\" href=\"javascript:void(0)\"></a></li>\n        \n          <li><a class=\"s-toc flat-btn fas fa-list fa-fw\" target=\"_self\" href=\"javascript:void(0)\"></a></li>\n        \n      </ul>\n    </div>\n\t\t<div class=\"nav-main container container--flex\">\n      \n        \n        <a class=\"logo flat-box\" target=\"_self\" href=\"/\">\n          \n          \n          \n          \n            CHEMLEZ <b><sup style=\"color:#3AA757\"></sup></b>\n          \n        </a>\n      \n\n\t\t\t<div class=\"menu navigation\">\n\t\t\t\t<ul class=\"h-list\">\n          \n          \n          \n            \n            \n              <li>\n                <a class=\"flat-box\" href=\"/\" id=\"home\">\n                  \n                    <i class=\"fas fa-home fa-fw\"></i>\n                  \n                  主页\n                </a>\n                \n              </li>\n            \n          \n          \n            \n            \n              <li>\n                <a class=\"flat-box\">\n                  \n                    <i class=\"fas fa-list-alt fa-fw fa-fw\"></i>\n                  \n                  索引\n                </a>\n                \n                  <ul class=\"submenu\">\n                    \n                      \n            \n              <li>\n                <a class=\"flat-box\" href=\"/tags/\" id=\"tags\">\n                  \n                    <i class=\"fas fa-tags fa-fw\"></i>\n                  \n                  标签\n                </a>\n                \n              </li>\n            \n          \n                    \n                      \n            \n              <li>\n                <a class=\"flat-box\" href=\"/categories/\" id=\"categories\">\n                  \n                    <i class=\"fas fa-folder-open fa-fw\"></i>\n                  \n                  类别\n                </a>\n                \n              </li>\n            \n          \n                    \n                      \n            \n              <li>\n                <a class=\"flat-box\" href=\"/archives/\" id=\"archives\">\n                  \n                    <i class=\"fas fa-archive fa-fw\"></i>\n                  \n                  归档\n                </a>\n                \n              </li>\n            \n          \n                    \n                  </ul>\n                \n              </li>\n            \n          \n          \n            \n            \n              <li>\n                <a class=\"flat-box\" href=\"/friends/\" id=\"friends\">\n                  \n                    <i class=\"fas fa-link fa-fw\"></i>\n                  \n                  友链\n                </a>\n                \n              </li>\n            \n          \n          \n            \n            \n              <li>\n                <a class=\"flat-box\" href=\"/about/\" id=\"about\">\n                  \n                    <i class=\"fas fa-info-circle fa-fw\"></i>\n                  \n                  关于\n                </a>\n                \n              </li>\n            \n          \n          \n\t\t\t\t</ul>\n\t\t\t</div>\n\n      \n        <div class=\"m_search\">\n          <form name=\"searchform\" class=\"form u-search-form\">\n            <i class=\"icon fas fa-search fa-fw\"></i>\n            <input type=\"text\" class=\"input u-search-input\" placeholder=\"搜索\">\n          </form>\n        </div>\n      \n\n\t\t\t<ul class=\"switcher h-list\">\n\t\t\t\t\n\t\t\t\t\t<li><a class=\"s-search flat-btn fas fa-search fa-fw\" target=\"_self\" href=\"javascript:void(0)\"></a></li>\n\t\t\t\t\n\t\t\t\t<li><a class=\"s-menu flat-btn fas fa-bars fa-fw\" target=\"_self\" href=\"javascript:void(0)\"></a></li>\n\t\t\t</ul>\n\t\t</div>\n\t</div>\n</header>\n<ul class=\"menu-phone navigation white-box\">\n  \n  \n    <li>\n      <a class=\"flat-box\" href=\"/\" id=\"home\">\n        \n          <i class=\"fas fa-clock fa-fw fa-fw\"></i>\n        \n        近期文章\n      </a>\n    </li>\n  \n    <li>\n      <a class=\"flat-box\" href=\"/archives/\" id=\"archives\">\n        \n          <i class=\"fas fa-list-alt fa-fw fa-fw\"></i>\n        \n        文章归档\n      </a>\n    </li>\n  \n    <li>\n      <a class=\"flat-box\" href=\"/categories/\" id=\"categories\">\n        \n          <i class=\"fas fa-folder-open fa-fw\"></i>\n        \n        文章类别\n      </a>\n    </li>\n  \n    <li>\n      <a class=\"flat-box\" href=\"/tags/\" id=\"tags\">\n        \n          <i class=\"fas fa-tags fa-fw\"></i>\n        \n        文章标签\n      </a>\n    </li>\n  \n    <li>\n      <a class=\"flat-box\" href=\"/friends/\" id=\"friends\">\n        \n          <i class=\"fas fa-link fa-fw\"></i>\n        \n        我的友链\n      </a>\n    </li>\n  \n    <li>\n      <a class=\"flat-box\" href=\"/about/\" id=\"about\">\n        \n          <i class=\"fas fa-info-circle fa-fw\"></i>\n        \n        关于小站\n      </a>\n    </li>\n  \n</ul>\n<script>setLoadingBarProgress(40);</script>\n\n\n\n  <div class=\"l_body nocover\">\n    <div class=\"body-wrapper\">\n      \n\n<div class=\"l_main\">\n  \n\n  \n    <article id=\"post\" class=\"post white-box shadow floatable article-type-post\" itemscope itemprop=\"blogPost\">\n      \n\n\n  <section class=\"meta\">\n    \n    \n    <div class=\"meta\" id=\"header-meta\">\n      \n        \n  \n    <h1 class=\"title\">\n      <a href=\"/photos/videos.html\">\n        相册\n      </a>\n    </h1>\n  \n\n\n      \n      <div class=\"new-meta-box\">\n        \n          \n        \n          \n            \n<div class=\"new-meta-item author\">\n  <a href=\"https://liizhi.cn\" target=\"_blank\" rel=\"nofollow noopener\">\n    <img src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/placeholder/d570170f4f12e1ee829ca0e85a7dffeb77343a.svg\" data-original=\"https://s1.ax1x.com/2020/03/13/8mvbCj.jpg\">\n    <p>Chemlez</p>\n  </a>\n</div>\n\n          \n        \n          \n            \n\n          \n        \n          \n            <div class=\"new-meta-item date\">\n  <a class=\"notlink\">\n    <i class=\"fas fa-edit\" aria-hidden=\"true\"></i>\n    <p>发布于：Mar 14, 2020</p>\n  </a>\n</div>\n\n          \n        \n          \n            \n\n          \n        \n      </div>\n      \n        <hr>\n      \n    </div>\n  </section>\n\n\n      <section class=\"article typo\">\n        <div class=\"article-entry\" itemprop=\"articleBody\">\n          \n          <link rel=\"stylesheet\" href=\"./ins.css\">\n<div class=\"photos-btn-wrap\">\t<a class=\"photos-btn\" href=\"/photos\">Photos</a>\n\t<a class=\"photos-btn active\" href=\"/photos/videos.html\">Videos</a>\n\n</div>\n<center>\n    <h1>指弹_女儿情</h1>\n</center>\n<hr>\n<center>\n    <div class=\"video-container\">\n        <iframe height=\"80%\" width=\"80%\" src=\"https://player.youku.com/embed/XMjUzMzY4OTM3Ng==\" frameborder=\"0\" allowfullscreen></iframe>\n    </div>\n</center>\n<hr>\n<center>\n    <h1>指弹_友谊地久天长</h1>\n</center>\n<hr>\n<center>\n    <div class=\"video-container\">\n        <iframe height=\"80%\" width=\"80%\" src=\"https://player.youku.com/embed/XMjQ5MDExOTY2MA==\" frameborder=\"0\" allowfullscreen></iframe>\n    </div>\n</center>\n<hr>\n<center>\n    <h1>指弹_Always with me</h1>\n</center>\n<hr>\n<center>\n    <div class=\"video-container\">\n        <iframe height=\"80%\" width=\"80%\" src=\"https://player.youku.com/embed/XMjQ4MDQyNTQ0MA==\" frameborder=\"0\" allowfullscreen></iframe>\n    </div>\n</center>\n          \n            <br>\n            \n  \n    \n    \n\n<section class=\"widget copyright  desktop mobile\">\n  <div class=\"content\">\n    \n      <blockquote>\n        \n          \n            <p>博客内容遵循 署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</p>\n\n          \n        \n          \n            <p>本文永久链接是：<a href=\"https://www.chemlez.cn/photos/videos.html\">https://www.chemlez.cn/photos/videos.html</a></p>\n          \n        \n      </blockquote>\n    \n  </div>\n</section>\n\n  \n\n  \n    \n    \n  \n\n  <section class=\"widget related_posts  desktop mobile\">\n    \n  <header>\n    \n      <i class=\"fas fa-bookmark fa-fw\" aria-hidden=\"true\"></i><span class=\"name\">相关文章</span>\n    \n  </header>\n\n\n    <div class=\"content\">\n      <ul class=\"popular-posts\"><li class=\"popular-posts-item\"><div class=\"popular-posts-title\"><h3><a href=\"/2020/09/03/Java基础之Filter/\" title=\"Java基础之Filter\" rel=\"bookmark\">Java基础之Filter</a></h3></div></li></ul>\n    </div>\n  </section>\n\n\n  \n\n\n          \n        </div>\n        \n          \n\n\n  <section class=\"meta\" id=\"footer-meta\">\n    <div class=\"new-meta-box\">\n      \n        \n          <div class=\"new-meta-item date\" itemprop=\"dateUpdated\" datetime=\"2019-08-24T15:36:10+08:00\">\n  <a class=\"notlink\">\n    <i class=\"fas fa-save\" aria-hidden=\"true\"></i>\n    <p>更新于：Aug 24, 2019</p>\n  </a>\n</div>\n\n        \n      \n        \n          \n\n        \n      \n        \n          \n  <div class=\"new-meta-item share -mob-share-list\">\n  <div class=\"-mob-share-list share-body\">\n    \n      \n        <a class=\"-mob-share-qq\" title rel=\"external nofollow noopener noreferrer\" href=\"http://connect.qq.com/widget/shareqq/index.html?url=https://www.chemlez.cn/photos/videos.html&title=相册 - Liz'blog&summary=\">\n          \n            <img src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/placeholder/d570170f4f12e1ee829ca0e85a7dffeb77343a.svg\" data-original=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qq.png\">\n          \n        </a>\n      \n    \n      \n        <a class=\"-mob-share-qzone\" title rel=\"external nofollow noopener noreferrer\" href=\"https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://www.chemlez.cn/photos/videos.html&title=相册 - Liz'blog&summary=\">\n          \n            <img src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/placeholder/d570170f4f12e1ee829ca0e85a7dffeb77343a.svg\" data-original=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qzone.png\">\n          \n        </a>\n      \n    \n      \n        <a class=\"-mob-share-weibo\" title rel=\"external nofollow noopener noreferrer\" href=\"http://service.weibo.com/share/share.php?url=https://www.chemlez.cn/photos/videos.html&title=相册 - Liz'blog&summary=\">\n          \n            <img src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/placeholder/d570170f4f12e1ee829ca0e85a7dffeb77343a.svg\" data-original=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/weibo.png\">\n          \n        </a>\n      \n    \n      \n        \n        <div class=\"hoverbox\">\n          <a><img src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/placeholder/d570170f4f12e1ee829ca0e85a7dffeb77343a.svg\" data-original=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/wechat.png\"></a>\n          <div class=\"target\">\n            <img src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPgAAAD4CAAAAADkunTXAAACT0lEQVR42u3aSXLDMAwEQP//08kLVOQA8CKqeZNTltHMZQrA6++h5wUODg4ODn4Q/FU8ly8e/l76/tV7wMHBwcHBT4RvB4BFQavn6sVM1QsODg4ODn4yfBkAFs/dQq/qGKsXHBwcHBwcfDuYVANMGpTAwcHBwcHB+wGmC7ltcgMHBwcHB/8BeNygH1oESC/265MUcHBwcHDwH4KXF+a+9FyuFxwcHBwc/CB496wCS7o4sBuAyvWCg4ODg4MfBO8O8HcbC90L6tYHDg4ODg5+Mny38LSQ7kCiDU07MODg4ODg4DeEVxv6qwCSBppuwGk3IsDBwcHBwW8I7waEtLBq46K6oAAODg4ODv4EeLWwNPhUC+/+A8DBwcHBwU+C7/7QNKx6kekFXQ4UwMHBwcHBD4CnjYhqoJkCVBcYwMHBwcHBnwSfGgykgO6CQnuSAg4ODg4OfiP41OD+XQOF9GLigQI4ODg4OPiN4WlgSYPNbqBJBw3VBQNwcHBwcPAnwrsFVBsf1QsbCzDg4ODg4OA3gqeD/jTIpJ+nCwbxJAUcHBwcHPwgeLURMLVgMBWcLv8ODg4ODg5+EHxqcPCuxsRuo2K7DnBwcHBw8IPgnwomUwt+aWBZNiLAwcHBwcEPgFcbBt2BRHVgUK4fHBwcHBz8YHg1aKTfTy/m7ZMUcHBwcHBw8PHF+jRIgYODg4ODg8/Dq8Gkez7eiAAHBwcHB/8iPA0O6QAgDTDdhQFwcHBwcPAnwKvBYOoidgNIdTABDg4ODg5+IvxpBxwcHBwc/IDzDxDyBwHZ5cyhAAAAAElFTkSuQmCC\">\n          </div>\n        </div>\n      \n    \n  </div>\n</div>\n\n\n\n        \n      \n    </div>\n  </section>\n\n\n        \n        \n      </section>\n    </article>\n  \n\n  \n    <!-- 显示推荐文章和评论 -->\n\n\n\n  <article class=\"post white-box comments shadow floatable\">\n    <section class=\"article typo\">\n      <p ct><i class=\"fas fa-comments\"></i> Comment</p>\n      \n      \n      \n      \n      \n        <section id=\"comments\">\n          <div id=\"valine_container\" class=\"valine_thread\">\n            <i class=\"fas fa-spinner fa-spin fa-fw\"></i>\n          </div>\n        </section>\n      \n    </section>\n  </article>\n\n\n  \n\n\n\n\n<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->\n\n\n\n  <script>\n    window.subData = {\n      title: '相册',\n      tools: true\n    }\n  </script>\n\n\n</div>\n<aside class=\"l_side\">\n  \n  \n    \n    \n\n<section class=\"widget blogger shadow floatable desktop\">\n  <div class=\"content\">\n    \n      <div class=\"avatar\">\n        <img class=\"avatar\" src=\"https://s1.ax1x.com/2020/03/13/8mvbCj.jpg\">\n      </div>\n    \n    \n      <div class=\"text\">\n        \n        \n        \n          <p><span id=\"jinrishici-sentence\">Liz'blog</span></p>\n          <script src=\"https://sdk.jinrishici.com/v2/browser/jinrishici.js\" charset=\"utf-8\"></script>\n        \n      </div>\n    \n    \n      <div class=\"social-wrapper\">\n        \n          \n            <a href=\"https://github.com/Chemlez\" class=\"social fab fa-github flat-btn\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">\n            </a>\n          \n        \n          \n            <a href=\"https://weibo.com/u/5653780011?nick=Sane_z&is_all=1\" class=\"social fab fa-weibo flat-btn\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">\n            </a>\n          \n        \n          \n            <a href=\"mailto:liz_1106@163.com\" class=\"social fas fa-envelope flat-btn\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">\n            </a>\n          \n        \n      </div>\n    \n  </div>\n</section>\n\n  \n\n  \n    \n    \n  \n\n  <section class=\"widget category shadow floatable desktop\">\n    \n  <header>\n    \n      <a href=\"/categories/\"><i class=\"fas fa-folder-open fa-fw\" aria-hidden=\"true\"></i><span class=\"name\">文章分类</span></a>\n    \n  </header>\n\n\n    <div class=\"content\">\n      <ul class=\"entry navigation\">\n        \n          <li><a class=\"flat-box\" title=\"/categories/Java/\" href=\"/categories/Java/\" id=\"categoriesJava\"><div class=\"name\">Java</div><div class=\"badge\">(16)</div></a></li>\n        \n          <li><a class=\"flat-box child\" title=\"/categories/Java/%E6%A1%86%E6%9E%B6/\" href=\"/categories/Java/%E6%A1%86%E6%9E%B6/\" id=\"categoriesJavaE6A186E69EB6\"><div class=\"name\">框架</div><div class=\"badge\">(1)</div></a></li>\n        \n          <li><a class=\"flat-box\" title=\"/categories/Linux/\" href=\"/categories/Linux/\" id=\"categoriesLinux\"><div class=\"name\">Linux</div><div class=\"badge\">(2)</div></a></li>\n        \n          <li><a class=\"flat-box\" title=\"/categories/Machine-Learning/\" href=\"/categories/Machine-Learning/\" id=\"categoriesMachine-Learning\"><div class=\"name\">Machine Learning</div><div class=\"badge\">(2)</div></a></li>\n        \n          <li><a class=\"flat-box child\" title=\"/categories/Machine-Learning/sklearn/\" href=\"/categories/Machine-Learning/sklearn/\" id=\"categoriesMachine-Learningsklearn\"><div class=\"name\">sklearn</div><div class=\"badge\">(2)</div></a></li>\n        \n          <li><a class=\"flat-box\" title=\"/categories/Mongodb/\" href=\"/categories/Mongodb/\" id=\"categoriesMongodb\"><div class=\"name\">Mongodb</div><div class=\"badge\">(1)</div></a></li>\n        \n          <li><a class=\"flat-box\" title=\"/categories/Python/\" href=\"/categories/Python/\" id=\"categoriesPython\"><div class=\"name\">Python</div><div class=\"badge\">(3)</div></a></li>\n        \n          <li><a class=\"flat-box child\" title=\"/categories/Python/%E7%88%AC%E8%99%AB/\" href=\"/categories/Python/%E7%88%AC%E8%99%AB/\" id=\"categoriesPythonE788ACE899AB\"><div class=\"name\">爬虫</div><div class=\"badge\">(2)</div></a></li>\n        \n          <li><a class=\"flat-box\" title=\"/categories/git/\" href=\"/categories/git/\" id=\"categoriesgit\"><div class=\"name\">git</div><div class=\"badge\">(1)</div></a></li>\n        \n          <li><a class=\"flat-box\" title=\"/categories/%E5%89%8D%E7%AB%AF/\" href=\"/categories/%E5%89%8D%E7%AB%AF/\" id=\"categoriesE5898DE7ABAF\"><div class=\"name\">前端</div><div class=\"badge\">(1)</div></a></li>\n        \n      </ul>\n    </div>\n  </section>\n\n\n  \n\n  \n    \n    \n  \n\n  <section class=\"widget tagcloud shadow floatable desktop\">\n    \n  <header>\n    \n      <a href=\"/tags/\"><i class=\"fas fa-tags fa-fw\" aria-hidden=\"true\"></i><span class=\"name\">热门标签</span></a>\n    \n  </header>\n\n\n    <div class=\"content\">\n      <a href=\"/tags/Beautifulsoup/\" style=\"font-size: 19px; color: #777\">Beautifulsoup</a> <a href=\"/tags/Data-Preprocessing/\" style=\"font-size: 14px; color: #999\">Data Preprocessing</a> <a href=\"/tags/DecisionTree/\" style=\"font-size: 14px; color: #999\">DecisionTree</a> <a href=\"/tags/Feature-Engineering/\" style=\"font-size: 14px; color: #999\">Feature Engineering</a> <a href=\"/tags/Filter/\" style=\"font-size: 14px; color: #999\">Filter</a> <a href=\"/tags/IO%E6%B5%81/\" style=\"font-size: 14px; color: #999\">IO流</a> <a href=\"/tags/JDBC/\" style=\"font-size: 19px; color: #777\">JDBC</a> <a href=\"/tags/JQuery/\" style=\"font-size: 14px; color: #999\">JQuery</a> <a href=\"/tags/Java/\" style=\"font-size: 24px; color: #555\">Java</a> <a href=\"/tags/JavaScript/\" style=\"font-size: 14px; color: #999\">JavaScript</a> <a href=\"/tags/JavaWeb/\" style=\"font-size: 19px; color: #777\">JavaWeb</a> <a href=\"/tags/Kaggle/\" style=\"font-size: 14px; color: #999\">Kaggle</a> <a href=\"/tags/Linux/\" style=\"font-size: 19px; color: #777\">Linux</a> <a href=\"/tags/MBG/\" style=\"font-size: 14px; color: #999\">MBG</a> <a href=\"/tags/MVC/\" style=\"font-size: 14px; color: #999\">MVC</a> <a href=\"/tags/Mapper/\" style=\"font-size: 14px; color: #999\">Mapper</a> <a href=\"/tags/Mongodb/\" style=\"font-size: 14px; color: #999\">Mongodb</a> <a href=\"/tags/MySQL/\" style=\"font-size: 24px; color: #555\">MySQL</a> <a href=\"/tags/Mybatis/\" style=\"font-size: 24px; color: #555\">Mybatis</a> <a href=\"/tags/Python/\" style=\"font-size: 14px; color: #999\">Python</a> <a href=\"/tags/Request/\" style=\"font-size: 19px; color: #777\">Request</a> <a href=\"/tags/Servlet/\" style=\"font-size: 24px; color: #555\">Servlet</a> <a href=\"/tags/Spring/\" style=\"font-size: 19px; color: #777\">Spring</a> <a href=\"/tags/SpringMVC/\" style=\"font-size: 19px; color: #777\">SpringMVC</a> <a href=\"/tags/Springboot-starter/\" style=\"font-size: 14px; color: #999\">Springboot-starter</a> <a href=\"/tags/VMware/\" style=\"font-size: 14px; color: #999\">VMware</a> <a href=\"/tags/conda/\" style=\"font-size: 14px; color: #999\">conda</a> <a href=\"/tags/git/\" style=\"font-size: 14px; color: #999\">git</a> <a href=\"/tags/hexo/\" style=\"font-size: 14px; color: #999\">hexo</a> <a href=\"/tags/redis/\" style=\"font-size: 14px; color: #999\">redis</a> <a href=\"/tags/servlet/\" style=\"font-size: 14px; color: #999\">servlet</a> <a href=\"/tags/sklearn/\" style=\"font-size: 19px; color: #777\">sklearn</a> <a href=\"/tags/ssm/\" style=\"font-size: 14px; color: #999\">ssm</a> <a href=\"/tags/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/\" style=\"font-size: 14px; color: #999\">动态代理</a> <a href=\"/tags/%E5%8F%8D%E5%B0%84/\" style=\"font-size: 19px; color: #777\">反射</a> <a href=\"/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/\" style=\"font-size: 19px; color: #777\">正则表达式</a> <a href=\"/tags/%E6%BA%90%E7%A0%81/\" style=\"font-size: 19px; color: #777\">源码</a> <a href=\"/tags/%E7%88%AC%E8%99%AB/\" style=\"font-size: 19px; color: #777\">爬虫</a> <a href=\"/tags/%E8%A1%A8%E5%8D%95%E9%AA%8C%E8%AF%81/\" style=\"font-size: 14px; color: #999\">表单验证</a>\n    </div>\n  </section>\n\n\n  \n\n  \n    \n    \n\n\n  <section class=\"widget toc-wrapper shadow floatable desktop mobile\">\n    \n  <header>\n    \n      <i class=\"fas fa-list fa-fw\" aria-hidden=\"true\"></i><span class=\"name\">本文目录</span>\n    \n  </header>\n\n\n    <div class=\"content\">\n      \n    </div>\n  </section>\n\n\n  \n\n\n</aside>\n\n\n  \n  <footer class=\"clearfix\">\n    <br><br>\n    \n      \n        <div class=\"aplayer-container\">\n          \n\n\n        </div>\n      \n    \n      \n        <br>\n        <div class=\"social-wrapper\">\n          \n            \n              <a href=\"https://github.com/Chemlez\" class=\"social fab fa-github flat-btn\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">\n              </a>\n            \n          \n            \n              <a href=\"https://weibo.com/u/5653780011?nick=Sane_z&amp;is_all=1\" class=\"social fab fa-weibo flat-btn\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">\n              </a>\n            \n          \n            \n              <a href=\"mailto:liz_1106@163.com\" class=\"social fas fa-envelope flat-btn\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">\n              </a>\n            \n          \n        </div>\n      \n    \n      \n        <div class=\"copyright\">\n        <p><a href=\"https://liizhi.cn\" target=\"_blank\" rel=\"noopener\">Copyright © 2019-2020 Chemlez</a></p>\n\n        </div>\n      \n    \n  </footer>\n\n<script>setLoadingBarProgress(80);</script>\n\n\n      <script>setLoadingBarProgress(60);</script>\n    </div>\n    <a class=\"s-top fas fa-arrow-up fa-fw\" href=\"javascript:void(0)\"></a>\n  </div>\n  \n<script src=\"https://cdn.jsdelivr.net/npm/jquery@3.4/dist/jquery.min.js\"></script>\n\n\n  <script>\n    \n    var SEARCH_SERVICE = \"hexo\" || \"hexo\";\n    var ROOT = \"/\" || \"/\";\n    if (!ROOT.endsWith('/')) ROOT += '/';\n  </script>\n\n\n  <script async src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/instant_page.js\" type=\"module\" defer integrity=\"sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1\"></script>\n\n\n\n  \n<script src=\"https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js\"></script>\n\n  <script type=\"text/javascript\">\n    $(function() {\n      Waves.attach('.flat-btn', ['waves-button']);\n      Waves.attach('.float-btn', ['waves-button', 'waves-float']);\n      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);\n      Waves.attach('.flat-box', ['waves-block']);\n      Waves.attach('.float-box', ['waves-block', 'waves-float']);\n      Waves.attach('.waves-image');\n      Waves.init();\n    });\n  </script>\n\n\n  <script async src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js\"></script>\n\n\n\n  \n  \n  \n    \n<script src=\"https://cdn.jsdelivr.net/npm/jquery-backstretch@2.1.18/jquery.backstretch.min.js\"></script>\n\n    <script type=\"text/javascript\">\n      $(function(){\n        var imgs=[\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-wallpaper/abstract/41F215B9-261F-48B4-80B5-4E86E165259E.jpeg\"];\n        if ('true' == 'true') {\n          function shuffle(arr){\n            /*From countercurrent-time*/\n            var n = arr.length;\n            while(n--) {\n              var index = Math.floor(Math.random() * n);\n              var temp = arr[index];\n              arr[index] = arr[n];\n              arr[n] = temp;\n            }\n          }\n          shuffle(imgs);\n        }\n        if ('.cover') {\n          $('.cover').backstretch(\n            imgs,\n          {\n            duration: \"20000\",\n            fade: \"1500\"\n          });\n        } else {\n          $.backstretch(\n            imgs,\n          {\n            duration: \"20000\",\n            fade: \"1500\"\n          });\n        }\n      });\n    </script>\n  \n\n\n\n\n\n\n\n\n\n\n  \n    \n<script src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.0/js/valine.js\"></script>\n\n  \n  <script>\n  var GUEST_INFO = ['nick','mail','link'];\n  var guest_info = 'nick,mail,link'.split(',').filter(function(item){\n    return GUEST_INFO.indexOf(item) > -1\n  });\n  var notify = 'true' == true;\n  var verify = 'true' == true;\n  var valine = new Valine();\n  valine.init({\n    el: '#valine_container',\n    notify: notify,\n    verify: verify,\n    guest_info: guest_info,\n    \n    appId: \"YSitK1ig1lRcy3jvrtTzT6fb-MdYXbMMI\",\n    appKey: \"e7hFf2zqvyWgNmDsClWcM7W3\",\n    placeholder: \"快来评论吧~\",\n    pageSize:'10',\n    avatar:'wavatar',\n    lang:'zh-cn',\n    visitor: 'false',\n    highlight:'true'\n  })\n  </script>\n\n\n\n  \n<script src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.1.5/js/app.js\"></script>\n\n\n\n  \n<script src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.1/js/search.js\"></script>\n\n\n\n  \n<script src=\"https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/comment_typing.js\"></script>\n\n\n\n<!-- 复制 -->\n\n  <script src=\"https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js\"></script>\n<script>\n  !function (e, t, a) {\n    var initCopyCode = function(){\n      var copyHtml = '';\n      copyHtml += '<button class=\"btn-copy\" data-clipboard-snippet=\"\">';\n      copyHtml += '<i class=\"fas fa-copy\"></i><span>COPY</span>';\n      copyHtml += '</button>';\n      $(\".highlight .code pre\").before(copyHtml);\n      var clipboard = new ClipboardJS('.btn-copy', {\n        target: function(trigger) {\n          return trigger.nextElementSibling;\n        }\n      });\n      clipboard.on('success', function(e) {\n        let $btn = $(e.trigger);\n        $btn.addClass('copyed');\n        let $icon = $($btn.find('i'));\n        $icon.removeClass('fa-copy');\n        $icon.addClass('fa-clipboard-check');\n        let $span = $($btn.find('span'));\n        $span[0].innerText = 'COPYED';\n      });\n      clipboard.on('error', function(e) {\n        e.clearSelection();\n        let $btn = $(e.trigger);\n        $btn.addClass('copy-failed');\n        let $icon = $($btn.find('i'));\n        $icon.removeClass('fa-copy');\n        $icon.addClass('fa-exclamation-triangle');\n        let $span = $($btn.find('span'));\n        $span[0].innerText = 'COPY FAILED';\n      });\n    }\n    initCopyCode();\n  }(window, document);\n</script>\n\n\n\n\n<!-- fancybox -->\n\n  <script src=\"https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js\"></script>\n<script>\n  let LAZY_LOAD_IMAGE = \"[object Object]\";\n  $(\".article-entry\").find(\"fancybox\").find(\"img\").each(function () {\n      var element = document.createElement(\"a\");\n      $(element).attr(\"data-fancybox\", \"gallery\");\n      $(element).attr(\"href\", $(this).attr(\"src\"));\n      /* 图片采用懒加载处理时,\n       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,\n       * 那么此处将原本的属性名src替换为对应属性名data-original,\n       * 修改如下\n       */\n       if (LAZY_LOAD_IMAGE) {\n         $(element).attr(\"href\", $(this).attr(\"data-original\"));\n       }\n      $(this).wrap(element);\n  });\n</script>\n\n\n\n\n\n\n  <script>setLoadingBarProgress(100);</script>\n<script>!function(e){var c=Array.prototype.slice.call(document.querySelectorAll(\"img[data-original]\"));function i(){for(var r=0;r<c.length;r++)t=c[r],0<=(n=t.getBoundingClientRect()).bottom&&0<=n.left&&n.top<=(e.innerHeight||document.documentElement.clientHeight)&&function(){var t,n,e,i,o=c[r];t=o,n=function(){c=c.filter(function(t){return o!==t})},e=new Image,i=t.getAttribute(\"data-original\"),e.onload=function(){t.src=i,n&&n()},e.src=i}();var t,n}i(),e.addEventListener(\"scroll\",function(){var t,n;t=i,n=e,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)})}(this);</script><script>window.addEventListener(\"load\",function(){var t=/\\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll(\"img[data-original]\")).forEach(function(a){var e=a.parentNode;\"A\"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script></body>\n</html>\n"}],"Post":[{"title":"JAVA中ThreadLocal是如何保证线程安全的","date":"2021-01-27T06:59:58.000Z","toc":true,"_content":"### <span style=\"color:orange;\">1.线程安全</span>\n当多个线程试图同时对一个共享变量进行访问修改的时候，容易引发数据不安全的操作。\n例如一个线程1正准备对变量进行修改+1时，另一个线程2也进行了修改+1，那么这个线程1进行修改的操作就可能是不成功的。\n\n\n### <span style=\"color:orange;\">2.可以采取的措施</span>\n\n1. 加锁，保证线程在写入时是加锁的，其他线程的修改只能等待\n2. ThreadLocal采用的方法，每个线程访问的都是共享变量的拷贝变量\n<!--more-->\n<div align=center><img src=\"threadlocal.png\" width=\"50%\" height=\"50%\"/></div>\n\n### <span style=\"color:orange;\">3.ThreadLocal使用</span>\n```java\nThreadLocal<String> mStringThreadLocal = new ThreadLocal<>();\n```\nThreadLocal是除了加锁之外另外一种保证多线程访问共享变量的线程安全方法，即每个线程对共享变量的访问都是基于线程自己的变量的，也就是说共享变量也还是只有一个，但是每个线程都有一个共享变量的独立拷贝，每个线程只访问修改自己独立拷贝的变量\n##### set方法\n\n```java\nmStringThreadLocal.set(\"string\")\n```\n##### get方法\n\n```java\nmStringThreadLocal.get()\n```\n##### ThreadLocal初始值\n\n可以通过覆写initialValue来设置初始值\n```java\nThreadLocal<String> mThreadLocal = new ThreadLocal<String>(){ \n    @Override\n    protected T initialValue() {\n            return \"init\";\n        }\n};\n```\n\n\n### <span style=\"color:orange;\">4.ThreadLocal原理</span>\nThreadLocal的set方法，含义：\n\n- 首先获取当前线程\n- 获取当前线程的threadLocals，这是一个ThreadLocalMap对象\n- 然后判断threadLocals是否为空，如果为空，则把创建一个并赋值，如果不为空，就设置值\n##### ThreadLocal.set方法源码\n\n```java\n    /**\n     * Sets the current thread's copy of this thread-local variable\n     * to the specified value.  Most subclasses will have no need to\n     * override this method, relying solely on the {@link #initialValue}\n     * method to set the values of thread-locals.\n     *\n     * @param value the value to be stored in the current thread's copy of\n     *        this thread-local.\n     */\n    public void set(T value) {\n        Thread t = Thread.currentThread();\n        ThreadLocalMap map = getMap(t);\n        if (map != null)\n            map.set(this, value);\n        else\n            createMap(t, value);\n    }\n\n    ThreadLocalMap getMap(Thread t) {\n        return t.threadLocals;\n    }\n\n    void createMap(Thread t, T firstValue) {\n        t.threadLocals = new ThreadLocalMap(this, firstValue);\n    }\n```\n##### ThreadLocal.get方法源码\n\n- 获取当前线程\n- 获取该线程的ThreadLocalMap\n- 然后以this->ThreadLocal为key，在该线程ThreadLocalMap找到相应的值\n```java\npublic T get() {\n        Thread t = Thread.currentThread();\n        ThreadLocalMap map = getMap(t);\n        if (map != null) {\n            ThreadLocalMap.Entry e = map.getEntry(this);\n            if (e != null) {\n                @SuppressWarnings(\"unchecked\")\n                T result = (T)e.value;\n                return result;\n            }\n        }\n        return setInitialValue();\n   }\n```\n上述中的ThreadLocalMap实际上是Thread对象的threadLocals变量，每个线程都有一个自己的ThreadLocalMap变量\n```java\nclass Thread implements Runnable {\n    /* ThreadLocal values pertaining to this thread. This map is maintained\n     * by the ThreadLocal class. */\n\n    ThreadLocal.ThreadLocalMap threadLocals = null;\n}\n```\n##### 对应ThreadLocalMap源码\n\n- 可以看到初始化方法，其中的table是自己独有的那一份，key是ThreadLocal对象\n```java\n static class ThreadLocalMap {\n     private Entry[] table;\n\n     ThreadLocalMap(ThreadLocal<?> firstKey, Object firstValue) {\n         table = new Entry[INITIAL_CAPACITY];\n         int i = firstKey.threadLocalHashCode & (INITIAL_CAPACITY - 1);\n         table[i] = new Entry(firstKey, firstValue);\n         size = 1;\n         setThreshold(INITIAL_CAPACITY);\n     }\n     \n     private Entry getEntry(ThreadLocal<?> key) {\n            int i = key.threadLocalHashCode & (table.length - 1);\n            Entry e = table[i];\n            if (e != null && e.get() == key)\n                return e;\n            else\n                return getEntryAfterMiss(key, i, e);\n     }\n }\n```\n\n总结：可以看到源码中，每个线程调用ThreadLocal.set()方法时，实际上是找自己线程的ThreadLocalMap对象，然后往自己ThreadLocalMap根据key为ThreadLocal，计算hash值，往table里放入东西；每个线程调用ThreadLocal.get()方法，也是先找自己线程的ThreadLocalMap，然后根据ThreadLocal为key计算hash值，找到table数组对应索引位置的value。\n\n### <span style=\"color:orange;\">5. 会导致内存泄露么</span>\n\n有网上讨论说ThreadLocal会导致内存泄露，原因如下：\n\n- 首先ThreadLocal实例作被线程的ThreadLocalMap实例持有，作为key计算hash值使用，也可以看成被线程持有。\n- 如果应用使用了线程池，那么之前的线程实例处理完之后出于复用的目的依然存活\n- 所以，ThreadLocal设定的值被持有，导致内存泄露。\n\n```java\nstatic class Entry extends WeakReference<ThreadLocal<?>> {\n    /** The value associated with this ThreadLocal. */\n    Object value;\n  Entry(ThreadLocal<?> k, Object v) {\n      super(k);\n      value = v;\n\t}\n}\n```\n详细描述：ThreadLocal变量被垃圾回收时，每个线程自己的ThreadLocalMap放入的东西，也就是往ThreadLocal的静态内部类ThreadLocalMap中放入的Entry，ThreadLocalMap中存放的Entry是这样一个结构，key为声明ThreadLocal变量的实例对象，而Value为该线程放入的值，由于这里的key是threadLocal变量的弱引用，当ThreadLocal变量被垃圾回收时其堆被回收，但是静态内部类是属于类对象的，由于key是ThreadLocal变量的弱引用，那么就会出现ThreadLocalMap就会出现key为null，value存在的现象，那么这个value就会出现内存泄漏，无法被GC回收。\n\n其实不用担心查看ThreadLocal中的静态内部类ThreadLocalMap中可以发现其每次调用set、get方法时，会调用cleanSomeSlots方法将本次run中所有key为null的entry清理掉\n\n```java\n/**\n * Heuristically scan some cells looking for stale entries.\n * This is invoked when either a new element is added, or\n * another stale one has been expunged. It performs a\n * logarithmic number of scans, as a balance between no\n * scanning (fast but retains garbage) and a number of scans\n * proportional to number of elements, that would find all\n * garbage but would cause some insertions to take O(n) time.\n *\n * @param i a position known NOT to hold a stale entry. The\n * scan starts at the element after i.\n *\n * @param n scan control: {@code log2(n)} cells are scanned,\n * unless a stale entry is found, in which case\n * {@code log2(table.length)-1} additional cells are scanned.\n * When called from insertions, this parameter is the number\n * of elements, but when from replaceStaleEntry, it is the\n * table length. (Note: all this could be changed to be either\n * more or less aggressive by weighting n instead of just\n * using straight log n. But this version is simple, fast, and\n * seems to work well.)\n *\n * @return true if any stale entries have been removed.\n */\nprivate boolean cleanSomeSlots(int i, int n) {\n    boolean removed = false;\n    Entry[] tab = table;\n    int len = tab.length;\n    do {\n        i = nextIndex(i, len);\n        Entry e = tab[i];\n        if (e != null && e.get() == null) {\n            n = len;\n            removed = true;\n            i = expungeStaleEntry(i);\n        }\n    } while ( (n >>>= 1) != 0);\n    return removed;\n}\n```\n\n","source":"_posts/Java中ThreadLocal是如何保证线程安全的.md","raw":"---\ntitle: JAVA中ThreadLocal是如何保证线程安全的\ndate: 2021-01-27 14:59:58\ntag:\n    - 线程\ncategories:\n    - 线程安全\ntoc: true\n---\n### <span style=\"color:orange;\">1.线程安全</span>\n当多个线程试图同时对一个共享变量进行访问修改的时候，容易引发数据不安全的操作。\n例如一个线程1正准备对变量进行修改+1时，另一个线程2也进行了修改+1，那么这个线程1进行修改的操作就可能是不成功的。\n\n\n### <span style=\"color:orange;\">2.可以采取的措施</span>\n\n1. 加锁，保证线程在写入时是加锁的，其他线程的修改只能等待\n2. ThreadLocal采用的方法，每个线程访问的都是共享变量的拷贝变量\n<!--more-->\n<div align=center><img src=\"threadlocal.png\" width=\"50%\" height=\"50%\"/></div>\n\n### <span style=\"color:orange;\">3.ThreadLocal使用</span>\n```java\nThreadLocal<String> mStringThreadLocal = new ThreadLocal<>();\n```\nThreadLocal是除了加锁之外另外一种保证多线程访问共享变量的线程安全方法，即每个线程对共享变量的访问都是基于线程自己的变量的，也就是说共享变量也还是只有一个，但是每个线程都有一个共享变量的独立拷贝，每个线程只访问修改自己独立拷贝的变量\n##### set方法\n\n```java\nmStringThreadLocal.set(\"string\")\n```\n##### get方法\n\n```java\nmStringThreadLocal.get()\n```\n##### ThreadLocal初始值\n\n可以通过覆写initialValue来设置初始值\n```java\nThreadLocal<String> mThreadLocal = new ThreadLocal<String>(){ \n    @Override\n    protected T initialValue() {\n            return \"init\";\n        }\n};\n```\n\n\n### <span style=\"color:orange;\">4.ThreadLocal原理</span>\nThreadLocal的set方法，含义：\n\n- 首先获取当前线程\n- 获取当前线程的threadLocals，这是一个ThreadLocalMap对象\n- 然后判断threadLocals是否为空，如果为空，则把创建一个并赋值，如果不为空，就设置值\n##### ThreadLocal.set方法源码\n\n```java\n    /**\n     * Sets the current thread's copy of this thread-local variable\n     * to the specified value.  Most subclasses will have no need to\n     * override this method, relying solely on the {@link #initialValue}\n     * method to set the values of thread-locals.\n     *\n     * @param value the value to be stored in the current thread's copy of\n     *        this thread-local.\n     */\n    public void set(T value) {\n        Thread t = Thread.currentThread();\n        ThreadLocalMap map = getMap(t);\n        if (map != null)\n            map.set(this, value);\n        else\n            createMap(t, value);\n    }\n\n    ThreadLocalMap getMap(Thread t) {\n        return t.threadLocals;\n    }\n\n    void createMap(Thread t, T firstValue) {\n        t.threadLocals = new ThreadLocalMap(this, firstValue);\n    }\n```\n##### ThreadLocal.get方法源码\n\n- 获取当前线程\n- 获取该线程的ThreadLocalMap\n- 然后以this->ThreadLocal为key，在该线程ThreadLocalMap找到相应的值\n```java\npublic T get() {\n        Thread t = Thread.currentThread();\n        ThreadLocalMap map = getMap(t);\n        if (map != null) {\n            ThreadLocalMap.Entry e = map.getEntry(this);\n            if (e != null) {\n                @SuppressWarnings(\"unchecked\")\n                T result = (T)e.value;\n                return result;\n            }\n        }\n        return setInitialValue();\n   }\n```\n上述中的ThreadLocalMap实际上是Thread对象的threadLocals变量，每个线程都有一个自己的ThreadLocalMap变量\n```java\nclass Thread implements Runnable {\n    /* ThreadLocal values pertaining to this thread. This map is maintained\n     * by the ThreadLocal class. */\n\n    ThreadLocal.ThreadLocalMap threadLocals = null;\n}\n```\n##### 对应ThreadLocalMap源码\n\n- 可以看到初始化方法，其中的table是自己独有的那一份，key是ThreadLocal对象\n```java\n static class ThreadLocalMap {\n     private Entry[] table;\n\n     ThreadLocalMap(ThreadLocal<?> firstKey, Object firstValue) {\n         table = new Entry[INITIAL_CAPACITY];\n         int i = firstKey.threadLocalHashCode & (INITIAL_CAPACITY - 1);\n         table[i] = new Entry(firstKey, firstValue);\n         size = 1;\n         setThreshold(INITIAL_CAPACITY);\n     }\n     \n     private Entry getEntry(ThreadLocal<?> key) {\n            int i = key.threadLocalHashCode & (table.length - 1);\n            Entry e = table[i];\n            if (e != null && e.get() == key)\n                return e;\n            else\n                return getEntryAfterMiss(key, i, e);\n     }\n }\n```\n\n总结：可以看到源码中，每个线程调用ThreadLocal.set()方法时，实际上是找自己线程的ThreadLocalMap对象，然后往自己ThreadLocalMap根据key为ThreadLocal，计算hash值，往table里放入东西；每个线程调用ThreadLocal.get()方法，也是先找自己线程的ThreadLocalMap，然后根据ThreadLocal为key计算hash值，找到table数组对应索引位置的value。\n\n### <span style=\"color:orange;\">5. 会导致内存泄露么</span>\n\n有网上讨论说ThreadLocal会导致内存泄露，原因如下：\n\n- 首先ThreadLocal实例作被线程的ThreadLocalMap实例持有，作为key计算hash值使用，也可以看成被线程持有。\n- 如果应用使用了线程池，那么之前的线程实例处理完之后出于复用的目的依然存活\n- 所以，ThreadLocal设定的值被持有，导致内存泄露。\n\n```java\nstatic class Entry extends WeakReference<ThreadLocal<?>> {\n    /** The value associated with this ThreadLocal. */\n    Object value;\n  Entry(ThreadLocal<?> k, Object v) {\n      super(k);\n      value = v;\n\t}\n}\n```\n详细描述：ThreadLocal变量被垃圾回收时，每个线程自己的ThreadLocalMap放入的东西，也就是往ThreadLocal的静态内部类ThreadLocalMap中放入的Entry，ThreadLocalMap中存放的Entry是这样一个结构，key为声明ThreadLocal变量的实例对象，而Value为该线程放入的值，由于这里的key是threadLocal变量的弱引用，当ThreadLocal变量被垃圾回收时其堆被回收，但是静态内部类是属于类对象的，由于key是ThreadLocal变量的弱引用，那么就会出现ThreadLocalMap就会出现key为null，value存在的现象，那么这个value就会出现内存泄漏，无法被GC回收。\n\n其实不用担心查看ThreadLocal中的静态内部类ThreadLocalMap中可以发现其每次调用set、get方法时，会调用cleanSomeSlots方法将本次run中所有key为null的entry清理掉\n\n```java\n/**\n * Heuristically scan some cells looking for stale entries.\n * This is invoked when either a new element is added, or\n * another stale one has been expunged. It performs a\n * logarithmic number of scans, as a balance between no\n * scanning (fast but retains garbage) and a number of scans\n * proportional to number of elements, that would find all\n * garbage but would cause some insertions to take O(n) time.\n *\n * @param i a position known NOT to hold a stale entry. The\n * scan starts at the element after i.\n *\n * @param n scan control: {@code log2(n)} cells are scanned,\n * unless a stale entry is found, in which case\n * {@code log2(table.length)-1} additional cells are scanned.\n * When called from insertions, this parameter is the number\n * of elements, but when from replaceStaleEntry, it is the\n * table length. (Note: all this could be changed to be either\n * more or less aggressive by weighting n instead of just\n * using straight log n. But this version is simple, fast, and\n * seems to work well.)\n *\n * @return true if any stale entries have been removed.\n */\nprivate boolean cleanSomeSlots(int i, int n) {\n    boolean removed = false;\n    Entry[] tab = table;\n    int len = tab.length;\n    do {\n        i = nextIndex(i, len);\n        Entry e = tab[i];\n        if (e != null && e.get() == null) {\n            n = len;\n            removed = true;\n            i = expungeStaleEntry(i);\n        }\n    } while ( (n >>>= 1) != 0);\n    return removed;\n}\n```\n\n","slug":"Java中ThreadLocal是如何保证线程安全的","published":1,"updated":"2021-03-22T09:06:47.029Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl2enrqz80001y2lo9gc68jjg","content":"<h3 id=\"1-线程安全\"><a href=\"#1-线程安全\" class=\"headerlink\" title=\"1.线程安全\"></a><span style=\"color:orange;\">1.线程安全</span></h3><p>当多个线程试图同时对一个共享变量进行访问修改的时候，容易引发数据不安全的操作。<br>例如一个线程1正准备对变量进行修改+1时，另一个线程2也进行了修改+1，那么这个线程1进行修改的操作就可能是不成功的。</p>\n<h3 id=\"2-可以采取的措施\"><a href=\"#2-可以采取的措施\" class=\"headerlink\" title=\"2.可以采取的措施\"></a><span style=\"color:orange;\">2.可以采取的措施</span></h3><ol>\n<li>加锁，保证线程在写入时是加锁的，其他线程的修改只能等待</li>\n<li>ThreadLocal采用的方法，每个线程访问的都是共享变量的拷贝变量<a id=\"more\"></a>\n<div align=\"center\"><img src=\"/2021/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/Java%E4%B8%ADThreadLocal%E6%98%AF%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E7%9A%84/threadlocal.png\" width=\"50%\" height=\"50%\"></div>\n\n</li>\n</ol>\n<h3 id=\"3-ThreadLocal使用\"><a href=\"#3-ThreadLocal使用\" class=\"headerlink\" title=\"3.ThreadLocal使用\"></a><span style=\"color:orange;\">3.ThreadLocal使用</span></h3><pre><code class=\"java\">ThreadLocal&lt;String&gt; mStringThreadLocal = new ThreadLocal&lt;&gt;();\n</code></pre>\n<p>ThreadLocal是除了加锁之外另外一种保证多线程访问共享变量的线程安全方法，即每个线程对共享变量的访问都是基于线程自己的变量的，也就是说共享变量也还是只有一个，但是每个线程都有一个共享变量的独立拷贝，每个线程只访问修改自己独立拷贝的变量</p>\n<h5 id=\"set方法\"><a href=\"#set方法\" class=\"headerlink\" title=\"set方法\"></a>set方法</h5><pre><code class=\"java\">mStringThreadLocal.set(&quot;string&quot;)\n</code></pre>\n<h5 id=\"get方法\"><a href=\"#get方法\" class=\"headerlink\" title=\"get方法\"></a>get方法</h5><pre><code class=\"java\">mStringThreadLocal.get()\n</code></pre>\n<h5 id=\"ThreadLocal初始值\"><a href=\"#ThreadLocal初始值\" class=\"headerlink\" title=\"ThreadLocal初始值\"></a>ThreadLocal初始值</h5><p>可以通过覆写initialValue来设置初始值</p>\n<pre><code class=\"java\">ThreadLocal&lt;String&gt; mThreadLocal = new ThreadLocal&lt;String&gt;()&#123; \n    @Override\n    protected T initialValue() &#123;\n            return &quot;init&quot;;\n        &#125;\n&#125;;\n</code></pre>\n<h3 id=\"4-ThreadLocal原理\"><a href=\"#4-ThreadLocal原理\" class=\"headerlink\" title=\"4.ThreadLocal原理\"></a><span style=\"color:orange;\">4.ThreadLocal原理</span></h3><p>ThreadLocal的set方法，含义：</p>\n<ul>\n<li>首先获取当前线程</li>\n<li>获取当前线程的threadLocals，这是一个ThreadLocalMap对象</li>\n<li>然后判断threadLocals是否为空，如果为空，则把创建一个并赋值，如果不为空，就设置值<h5 id=\"ThreadLocal-set方法源码\"><a href=\"#ThreadLocal-set方法源码\" class=\"headerlink\" title=\"ThreadLocal.set方法源码\"></a>ThreadLocal.set方法源码</h5></li>\n</ul>\n<pre><code class=\"java\">    /**\n     * Sets the current thread&#39;s copy of this thread-local variable\n     * to the specified value.  Most subclasses will have no need to\n     * override this method, relying solely on the &#123;@link #initialValue&#125;\n     * method to set the values of thread-locals.\n     *\n     * @param value the value to be stored in the current thread&#39;s copy of\n     *        this thread-local.\n     */\n    public void set(T value) &#123;\n        Thread t = Thread.currentThread();\n        ThreadLocalMap map = getMap(t);\n        if (map != null)\n            map.set(this, value);\n        else\n            createMap(t, value);\n    &#125;\n\n    ThreadLocalMap getMap(Thread t) &#123;\n        return t.threadLocals;\n    &#125;\n\n    void createMap(Thread t, T firstValue) &#123;\n        t.threadLocals = new ThreadLocalMap(this, firstValue);\n    &#125;\n</code></pre>\n<h5 id=\"ThreadLocal-get方法源码\"><a href=\"#ThreadLocal-get方法源码\" class=\"headerlink\" title=\"ThreadLocal.get方法源码\"></a>ThreadLocal.get方法源码</h5><ul>\n<li><p>获取当前线程</p>\n</li>\n<li><p>获取该线程的ThreadLocalMap</p>\n</li>\n<li><p>然后以this-&gt;ThreadLocal为key，在该线程ThreadLocalMap找到相应的值</p>\n<pre><code class=\"java\">public T get() &#123;\n      Thread t = Thread.currentThread();\n      ThreadLocalMap map = getMap(t);\n      if (map != null) &#123;\n          ThreadLocalMap.Entry e = map.getEntry(this);\n          if (e != null) &#123;\n              @SuppressWarnings(&quot;unchecked&quot;)\n              T result = (T)e.value;\n              return result;\n          &#125;\n      &#125;\n      return setInitialValue();\n &#125;\n</code></pre>\n<p>上述中的ThreadLocalMap实际上是Thread对象的threadLocals变量，每个线程都有一个自己的ThreadLocalMap变量</p>\n<pre><code class=\"java\">class Thread implements Runnable &#123;\n  /* ThreadLocal values pertaining to this thread. This map is maintained\n   * by the ThreadLocal class. */\n\n  ThreadLocal.ThreadLocalMap threadLocals = null;\n&#125;\n</code></pre>\n<h5 id=\"对应ThreadLocalMap源码\"><a href=\"#对应ThreadLocalMap源码\" class=\"headerlink\" title=\"对应ThreadLocalMap源码\"></a>对应ThreadLocalMap源码</h5></li>\n<li><p>可以看到初始化方法，其中的table是自己独有的那一份，key是ThreadLocal对象</p>\n<pre><code class=\"java\">static class ThreadLocalMap &#123;\n   private Entry[] table;\n\n   ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) &#123;\n       table = new Entry[INITIAL_CAPACITY];\n       int i = firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - 1);\n       table[i] = new Entry(firstKey, firstValue);\n       size = 1;\n       setThreshold(INITIAL_CAPACITY);\n   &#125;\n   \n   private Entry getEntry(ThreadLocal&lt;?&gt; key) &#123;\n          int i = key.threadLocalHashCode &amp; (table.length - 1);\n          Entry e = table[i];\n          if (e != null &amp;&amp; e.get() == key)\n              return e;\n          else\n              return getEntryAfterMiss(key, i, e);\n   &#125;\n&#125;\n</code></pre>\n</li>\n</ul>\n<p>总结：可以看到源码中，每个线程调用ThreadLocal.set()方法时，实际上是找自己线程的ThreadLocalMap对象，然后往自己ThreadLocalMap根据key为ThreadLocal，计算hash值，往table里放入东西；每个线程调用ThreadLocal.get()方法，也是先找自己线程的ThreadLocalMap，然后根据ThreadLocal为key计算hash值，找到table数组对应索引位置的value。</p>\n<h3 id=\"5-会导致内存泄露么\"><a href=\"#5-会导致内存泄露么\" class=\"headerlink\" title=\"5. 会导致内存泄露么\"></a><span style=\"color:orange;\">5. 会导致内存泄露么</span></h3><p>有网上讨论说ThreadLocal会导致内存泄露，原因如下：</p>\n<ul>\n<li>首先ThreadLocal实例作被线程的ThreadLocalMap实例持有，作为key计算hash值使用，也可以看成被线程持有。</li>\n<li>如果应用使用了线程池，那么之前的线程实例处理完之后出于复用的目的依然存活</li>\n<li>所以，ThreadLocal设定的值被持有，导致内存泄露。</li>\n</ul>\n<pre><code class=\"java\">static class Entry extends WeakReference&lt;ThreadLocal&lt;?&gt;&gt; &#123;\n    /** The value associated with this ThreadLocal. */\n    Object value;\n  Entry(ThreadLocal&lt;?&gt; k, Object v) &#123;\n      super(k);\n      value = v;\n    &#125;\n&#125;\n</code></pre>\n<p>详细描述：ThreadLocal变量被垃圾回收时，每个线程自己的ThreadLocalMap放入的东西，也就是往ThreadLocal的静态内部类ThreadLocalMap中放入的Entry，ThreadLocalMap中存放的Entry是这样一个结构，key为声明ThreadLocal变量的实例对象，而Value为该线程放入的值，由于这里的key是threadLocal变量的弱引用，当ThreadLocal变量被垃圾回收时其堆被回收，但是静态内部类是属于类对象的，由于key是ThreadLocal变量的弱引用，那么就会出现ThreadLocalMap就会出现key为null，value存在的现象，那么这个value就会出现内存泄漏，无法被GC回收。</p>\n<p>其实不用担心查看ThreadLocal中的静态内部类ThreadLocalMap中可以发现其每次调用set、get方法时，会调用cleanSomeSlots方法将本次run中所有key为null的entry清理掉</p>\n<pre><code class=\"java\">/**\n * Heuristically scan some cells looking for stale entries.\n * This is invoked when either a new element is added, or\n * another stale one has been expunged. It performs a\n * logarithmic number of scans, as a balance between no\n * scanning (fast but retains garbage) and a number of scans\n * proportional to number of elements, that would find all\n * garbage but would cause some insertions to take O(n) time.\n *\n * @param i a position known NOT to hold a stale entry. The\n * scan starts at the element after i.\n *\n * @param n scan control: &#123;@code log2(n)&#125; cells are scanned,\n * unless a stale entry is found, in which case\n * &#123;@code log2(table.length)-1&#125; additional cells are scanned.\n * When called from insertions, this parameter is the number\n * of elements, but when from replaceStaleEntry, it is the\n * table length. (Note: all this could be changed to be either\n * more or less aggressive by weighting n instead of just\n * using straight log n. But this version is simple, fast, and\n * seems to work well.)\n *\n * @return true if any stale entries have been removed.\n */\nprivate boolean cleanSomeSlots(int i, int n) &#123;\n    boolean removed = false;\n    Entry[] tab = table;\n    int len = tab.length;\n    do &#123;\n        i = nextIndex(i, len);\n        Entry e = tab[i];\n        if (e != null &amp;&amp; e.get() == null) &#123;\n            n = len;\n            removed = true;\n            i = expungeStaleEntry(i);\n        &#125;\n    &#125; while ( (n &gt;&gt;&gt;= 1) != 0);\n    return removed;\n&#125;\n</code></pre>\n","site":{"data":{"photography":[{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","title":"玉渊潭","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","title":"花儿","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","title":"白塔寺","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"}]}},"excerpt":"<h3 id=\"1-线程安全\"><a href=\"#1-线程安全\" class=\"headerlink\" title=\"1.线程安全\"></a><span style=\"color:orange;\">1.线程安全</span></h3><p>当多个线程试图同时对一个共享变量进行访问修改的时候，容易引发数据不安全的操作。<br>例如一个线程1正准备对变量进行修改+1时，另一个线程2也进行了修改+1，那么这个线程1进行修改的操作就可能是不成功的。</p>\n<h3 id=\"2-可以采取的措施\"><a href=\"#2-可以采取的措施\" class=\"headerlink\" title=\"2.可以采取的措施\"></a><span style=\"color:orange;\">2.可以采取的措施</span></h3><ol>\n<li>加锁，保证线程在写入时是加锁的，其他线程的修改只能等待</li>\n<li>ThreadLocal采用的方法，每个线程访问的都是共享变量的拷贝变量</li></ol>","more":"<div align=\"center\"><img src=\"/2021/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/Java%E4%B8%ADThreadLocal%E6%98%AF%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E7%9A%84/threadlocal.png\" width=\"50%\" height=\"50%\"></div>\n\n\n\n<h3 id=\"3-ThreadLocal使用\"><a href=\"#3-ThreadLocal使用\" class=\"headerlink\" title=\"3.ThreadLocal使用\"></a><span style=\"color:orange;\">3.ThreadLocal使用</span></h3><pre><code class=\"java\">ThreadLocal&lt;String&gt; mStringThreadLocal = new ThreadLocal&lt;&gt;();\n</code></pre>\n<p>ThreadLocal是除了加锁之外另外一种保证多线程访问共享变量的线程安全方法，即每个线程对共享变量的访问都是基于线程自己的变量的，也就是说共享变量也还是只有一个，但是每个线程都有一个共享变量的独立拷贝，每个线程只访问修改自己独立拷贝的变量</p>\n<h5 id=\"set方法\"><a href=\"#set方法\" class=\"headerlink\" title=\"set方法\"></a>set方法</h5><pre><code class=\"java\">mStringThreadLocal.set(&quot;string&quot;)\n</code></pre>\n<h5 id=\"get方法\"><a href=\"#get方法\" class=\"headerlink\" title=\"get方法\"></a>get方法</h5><pre><code class=\"java\">mStringThreadLocal.get()\n</code></pre>\n<h5 id=\"ThreadLocal初始值\"><a href=\"#ThreadLocal初始值\" class=\"headerlink\" title=\"ThreadLocal初始值\"></a>ThreadLocal初始值</h5><p>可以通过覆写initialValue来设置初始值</p>\n<pre><code class=\"java\">ThreadLocal&lt;String&gt; mThreadLocal = new ThreadLocal&lt;String&gt;()&#123; \n    @Override\n    protected T initialValue() &#123;\n            return &quot;init&quot;;\n        &#125;\n&#125;;\n</code></pre>\n<h3 id=\"4-ThreadLocal原理\"><a href=\"#4-ThreadLocal原理\" class=\"headerlink\" title=\"4.ThreadLocal原理\"></a><span style=\"color:orange;\">4.ThreadLocal原理</span></h3><p>ThreadLocal的set方法，含义：</p>\n<ul>\n<li>首先获取当前线程</li>\n<li>获取当前线程的threadLocals，这是一个ThreadLocalMap对象</li>\n<li>然后判断threadLocals是否为空，如果为空，则把创建一个并赋值，如果不为空，就设置值<h5 id=\"ThreadLocal-set方法源码\"><a href=\"#ThreadLocal-set方法源码\" class=\"headerlink\" title=\"ThreadLocal.set方法源码\"></a>ThreadLocal.set方法源码</h5></li>\n</ul>\n<pre><code class=\"java\">    /**\n     * Sets the current thread&#39;s copy of this thread-local variable\n     * to the specified value.  Most subclasses will have no need to\n     * override this method, relying solely on the &#123;@link #initialValue&#125;\n     * method to set the values of thread-locals.\n     *\n     * @param value the value to be stored in the current thread&#39;s copy of\n     *        this thread-local.\n     */\n    public void set(T value) &#123;\n        Thread t = Thread.currentThread();\n        ThreadLocalMap map = getMap(t);\n        if (map != null)\n            map.set(this, value);\n        else\n            createMap(t, value);\n    &#125;\n\n    ThreadLocalMap getMap(Thread t) &#123;\n        return t.threadLocals;\n    &#125;\n\n    void createMap(Thread t, T firstValue) &#123;\n        t.threadLocals = new ThreadLocalMap(this, firstValue);\n    &#125;\n</code></pre>\n<h5 id=\"ThreadLocal-get方法源码\"><a href=\"#ThreadLocal-get方法源码\" class=\"headerlink\" title=\"ThreadLocal.get方法源码\"></a>ThreadLocal.get方法源码</h5><ul>\n<li><p>获取当前线程</p>\n</li>\n<li><p>获取该线程的ThreadLocalMap</p>\n</li>\n<li><p>然后以this-&gt;ThreadLocal为key，在该线程ThreadLocalMap找到相应的值</p>\n<pre><code class=\"java\">public T get() &#123;\n      Thread t = Thread.currentThread();\n      ThreadLocalMap map = getMap(t);\n      if (map != null) &#123;\n          ThreadLocalMap.Entry e = map.getEntry(this);\n          if (e != null) &#123;\n              @SuppressWarnings(&quot;unchecked&quot;)\n              T result = (T)e.value;\n              return result;\n          &#125;\n      &#125;\n      return setInitialValue();\n &#125;\n</code></pre>\n<p>上述中的ThreadLocalMap实际上是Thread对象的threadLocals变量，每个线程都有一个自己的ThreadLocalMap变量</p>\n<pre><code class=\"java\">class Thread implements Runnable &#123;\n  /* ThreadLocal values pertaining to this thread. This map is maintained\n   * by the ThreadLocal class. */\n\n  ThreadLocal.ThreadLocalMap threadLocals = null;\n&#125;\n</code></pre>\n<h5 id=\"对应ThreadLocalMap源码\"><a href=\"#对应ThreadLocalMap源码\" class=\"headerlink\" title=\"对应ThreadLocalMap源码\"></a>对应ThreadLocalMap源码</h5></li>\n<li><p>可以看到初始化方法，其中的table是自己独有的那一份，key是ThreadLocal对象</p>\n<pre><code class=\"java\">static class ThreadLocalMap &#123;\n   private Entry[] table;\n\n   ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) &#123;\n       table = new Entry[INITIAL_CAPACITY];\n       int i = firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - 1);\n       table[i] = new Entry(firstKey, firstValue);\n       size = 1;\n       setThreshold(INITIAL_CAPACITY);\n   &#125;\n   \n   private Entry getEntry(ThreadLocal&lt;?&gt; key) &#123;\n          int i = key.threadLocalHashCode &amp; (table.length - 1);\n          Entry e = table[i];\n          if (e != null &amp;&amp; e.get() == key)\n              return e;\n          else\n              return getEntryAfterMiss(key, i, e);\n   &#125;\n&#125;\n</code></pre>\n</li>\n</ul>\n<p>总结：可以看到源码中，每个线程调用ThreadLocal.set()方法时，实际上是找自己线程的ThreadLocalMap对象，然后往自己ThreadLocalMap根据key为ThreadLocal，计算hash值，往table里放入东西；每个线程调用ThreadLocal.get()方法，也是先找自己线程的ThreadLocalMap，然后根据ThreadLocal为key计算hash值，找到table数组对应索引位置的value。</p>\n<h3 id=\"5-会导致内存泄露么\"><a href=\"#5-会导致内存泄露么\" class=\"headerlink\" title=\"5. 会导致内存泄露么\"></a><span style=\"color:orange;\">5. 会导致内存泄露么</span></h3><p>有网上讨论说ThreadLocal会导致内存泄露，原因如下：</p>\n<ul>\n<li>首先ThreadLocal实例作被线程的ThreadLocalMap实例持有，作为key计算hash值使用，也可以看成被线程持有。</li>\n<li>如果应用使用了线程池，那么之前的线程实例处理完之后出于复用的目的依然存活</li>\n<li>所以，ThreadLocal设定的值被持有，导致内存泄露。</li>\n</ul>\n<pre><code class=\"java\">static class Entry extends WeakReference&lt;ThreadLocal&lt;?&gt;&gt; &#123;\n    /** The value associated with this ThreadLocal. */\n    Object value;\n  Entry(ThreadLocal&lt;?&gt; k, Object v) &#123;\n      super(k);\n      value = v;\n    &#125;\n&#125;\n</code></pre>\n<p>详细描述：ThreadLocal变量被垃圾回收时，每个线程自己的ThreadLocalMap放入的东西，也就是往ThreadLocal的静态内部类ThreadLocalMap中放入的Entry，ThreadLocalMap中存放的Entry是这样一个结构，key为声明ThreadLocal变量的实例对象，而Value为该线程放入的值，由于这里的key是threadLocal变量的弱引用，当ThreadLocal变量被垃圾回收时其堆被回收，但是静态内部类是属于类对象的，由于key是ThreadLocal变量的弱引用，那么就会出现ThreadLocalMap就会出现key为null，value存在的现象，那么这个value就会出现内存泄漏，无法被GC回收。</p>\n<p>其实不用担心查看ThreadLocal中的静态内部类ThreadLocalMap中可以发现其每次调用set、get方法时，会调用cleanSomeSlots方法将本次run中所有key为null的entry清理掉</p>\n<pre><code class=\"java\">/**\n * Heuristically scan some cells looking for stale entries.\n * This is invoked when either a new element is added, or\n * another stale one has been expunged. It performs a\n * logarithmic number of scans, as a balance between no\n * scanning (fast but retains garbage) and a number of scans\n * proportional to number of elements, that would find all\n * garbage but would cause some insertions to take O(n) time.\n *\n * @param i a position known NOT to hold a stale entry. The\n * scan starts at the element after i.\n *\n * @param n scan control: &#123;@code log2(n)&#125; cells are scanned,\n * unless a stale entry is found, in which case\n * &#123;@code log2(table.length)-1&#125; additional cells are scanned.\n * When called from insertions, this parameter is the number\n * of elements, but when from replaceStaleEntry, it is the\n * table length. (Note: all this could be changed to be either\n * more or less aggressive by weighting n instead of just\n * using straight log n. But this version is simple, fast, and\n * seems to work well.)\n *\n * @return true if any stale entries have been removed.\n */\nprivate boolean cleanSomeSlots(int i, int n) &#123;\n    boolean removed = false;\n    Entry[] tab = table;\n    int len = tab.length;\n    do &#123;\n        i = nextIndex(i, len);\n        Entry e = tab[i];\n        if (e != null &amp;&amp; e.get() == null) &#123;\n            n = len;\n            removed = true;\n            i = expungeStaleEntry(i);\n        &#125;\n    &#125; while ( (n &gt;&gt;&gt;= 1) != 0);\n    return removed;\n&#125;\n</code></pre>"},{"title":"Nacos：如何调用其他微服务（中）","date":"2021-03-17T16:00:00.000Z","toc":true,"_content":"\n上节我们将微服务模块注册到了注册中心Nacos中，接下来就是如何实现微服务模块之间接口的调用。\n\n这里我们使用SpringCloud-Alibaba提供的OpenFeign进行微服务模块之间调用，如果微服务A需要调用微服务模块B的接口1，那么我们如何实现呢？\n\n**原理**\n\n​\t微服务A、微服务B相互调用，前提是两个微服务都已经注册到注册中心Nacos中。然后微服务模块A1需要调用微服务B时，就去注册中心查看健康可用微服务模块B的地址，<!--more-->然后通过Nacos返回一个健康可用的微服务模块B1的地址给微服务模块A1，然后微服务模块通过利用OpenFeign向从Nacos中获得的地址发送**HTTP请求**给微服务模块B1的接口1，然后微服务A1调用微服务B1的接口1完成了。\n\n<div align=center><img src=\"1615645734755-1b3246df-3e91-474b-b901-bd58ac654797-20210318224006023.jpeg\" width=\"50%\" height=\"50%\" align=center/></div>\n\n上面介绍了后面的一些原理后，现在我们实现微服务A调用微服务B的功能，这里以用户服务调用优惠券服务查看该用户的优惠券为例。\n\n1.首先两个模块都要注册到注册中心中，上节已经实现\n\n2.优惠券服务模块编写被调用接口\n\n```java\n@RestController\n@RequestMapping(\"coupon/coupon\")\npublic class CouponController {\n    @Autowired\n    private CouponService couponService;\n\n    @RequestMapping(value=\"/member/list\")\n    public R membercoupons(){\n        CouponEntity couponEntity = new CouponEntity();\n        couponEntity.setCouponName(\"满100减10\");\n        return R.ok().put(\"coupons\", Arrays.asList(couponEntity));\n    }\n}\n```\n\n3.用户服务模块引入OpenFeign依赖\n\n```xml\n        <dependency>\n            <groupId>org.springframework.cloud</groupId>\n            <artifactId>spring-cloud-starter-openfeign</artifactId>\n        </dependency>\n```\n\n4.用户模块编写一个对应优惠券服务的声明式远程调用接口，指明需要调用微服务的名称以及调用该服务的哪个接口\n\n​     OpenFeign通过声明式远程调用接口来实现调用服务，这样微服务A通过该接口就可以实现无感调用\n\n```java\npackage com.lookstarry.doermail.member.feign;\n\nimport com.lookstarry.common.utils.R;\nimport org.springframework.cloud.openfeign.FeignClient;\nimport org.springframework.web.bind.annotation.RequestMapping;\n\n/**\n * @PackageName:com.lookstarry.doermail.member.feign\n * @NAME:CouponFeignService\n * @Description:\n * @author: yizhichangyuan\n * @date:2021/3/13 21:46\n */\n\n/**\n * 这是一个声明式的远程调用，指明调用注册中心的那个服务的那个接口方法\n */\n@FeignClient(\"doermail-coupon\") //调用的微服务名称\npublic interface CouponFeignService {\n    @RequestMapping(\"/coupon/coupon/member/list\") //对应调用哪个接口\n    public R membercoupons();\n}\n```\n\n5.用户服务模块需要加上EnableFeignClients开启远程调用功能，指明自己哪个包是远程调用模块\n\n```java\npackage com.lookstarry.doermail.member;\n\nimport org.springframework.boot.SpringApplication;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\nimport org.springframework.cloud.client.discovery.EnableDiscoveryClient;\nimport org.springframework.cloud.openfeign.EnableFeignClients;\n\n/**\n * 1、调用远程调用别人的服务\n * 1）、引入open-feign\n * 2)、编写一个接口，告诉springCloud这个接口需要调用远程服务\n *  1、声明接口的每一个方法都是调用哪个远程服务的哪个请求\n * 3）、开启远程调用功能\n *\n */\n@EnableFeignClients(basePackages = \"com.lookstarry.doermail.member.feign\")\n@SpringBootApplication\n@EnableDiscoveryClient\npublic class DoermailMemberApplication {\n\n    public static void main(String[] args) {\n        SpringApplication.run(DoermailMemberApplication.class, args);\n    }\n}\n```","source":"_posts/Nacos如何调用其他微服务(中）.md","raw":"---\ntitle: Nacos：如何调用其他微服务（中）\ndate: 2021-3-18\ntags:\n\t- Nacos\n\t- 微服务\ncategories:\n\t- SpringCloud\ntoc: true\n---\n\n上节我们将微服务模块注册到了注册中心Nacos中，接下来就是如何实现微服务模块之间接口的调用。\n\n这里我们使用SpringCloud-Alibaba提供的OpenFeign进行微服务模块之间调用，如果微服务A需要调用微服务模块B的接口1，那么我们如何实现呢？\n\n**原理**\n\n​\t微服务A、微服务B相互调用，前提是两个微服务都已经注册到注册中心Nacos中。然后微服务模块A1需要调用微服务B时，就去注册中心查看健康可用微服务模块B的地址，<!--more-->然后通过Nacos返回一个健康可用的微服务模块B1的地址给微服务模块A1，然后微服务模块通过利用OpenFeign向从Nacos中获得的地址发送**HTTP请求**给微服务模块B1的接口1，然后微服务A1调用微服务B1的接口1完成了。\n\n<div align=center><img src=\"1615645734755-1b3246df-3e91-474b-b901-bd58ac654797-20210318224006023.jpeg\" width=\"50%\" height=\"50%\" align=center/></div>\n\n上面介绍了后面的一些原理后，现在我们实现微服务A调用微服务B的功能，这里以用户服务调用优惠券服务查看该用户的优惠券为例。\n\n1.首先两个模块都要注册到注册中心中，上节已经实现\n\n2.优惠券服务模块编写被调用接口\n\n```java\n@RestController\n@RequestMapping(\"coupon/coupon\")\npublic class CouponController {\n    @Autowired\n    private CouponService couponService;\n\n    @RequestMapping(value=\"/member/list\")\n    public R membercoupons(){\n        CouponEntity couponEntity = new CouponEntity();\n        couponEntity.setCouponName(\"满100减10\");\n        return R.ok().put(\"coupons\", Arrays.asList(couponEntity));\n    }\n}\n```\n\n3.用户服务模块引入OpenFeign依赖\n\n```xml\n        <dependency>\n            <groupId>org.springframework.cloud</groupId>\n            <artifactId>spring-cloud-starter-openfeign</artifactId>\n        </dependency>\n```\n\n4.用户模块编写一个对应优惠券服务的声明式远程调用接口，指明需要调用微服务的名称以及调用该服务的哪个接口\n\n​     OpenFeign通过声明式远程调用接口来实现调用服务，这样微服务A通过该接口就可以实现无感调用\n\n```java\npackage com.lookstarry.doermail.member.feign;\n\nimport com.lookstarry.common.utils.R;\nimport org.springframework.cloud.openfeign.FeignClient;\nimport org.springframework.web.bind.annotation.RequestMapping;\n\n/**\n * @PackageName:com.lookstarry.doermail.member.feign\n * @NAME:CouponFeignService\n * @Description:\n * @author: yizhichangyuan\n * @date:2021/3/13 21:46\n */\n\n/**\n * 这是一个声明式的远程调用，指明调用注册中心的那个服务的那个接口方法\n */\n@FeignClient(\"doermail-coupon\") //调用的微服务名称\npublic interface CouponFeignService {\n    @RequestMapping(\"/coupon/coupon/member/list\") //对应调用哪个接口\n    public R membercoupons();\n}\n```\n\n5.用户服务模块需要加上EnableFeignClients开启远程调用功能，指明自己哪个包是远程调用模块\n\n```java\npackage com.lookstarry.doermail.member;\n\nimport org.springframework.boot.SpringApplication;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\nimport org.springframework.cloud.client.discovery.EnableDiscoveryClient;\nimport org.springframework.cloud.openfeign.EnableFeignClients;\n\n/**\n * 1、调用远程调用别人的服务\n * 1）、引入open-feign\n * 2)、编写一个接口，告诉springCloud这个接口需要调用远程服务\n *  1、声明接口的每一个方法都是调用哪个远程服务的哪个请求\n * 3）、开启远程调用功能\n *\n */\n@EnableFeignClients(basePackages = \"com.lookstarry.doermail.member.feign\")\n@SpringBootApplication\n@EnableDiscoveryClient\npublic class DoermailMemberApplication {\n\n    public static void main(String[] args) {\n        SpringApplication.run(DoermailMemberApplication.class, args);\n    }\n}\n```","slug":"Nacos如何调用其他微服务(中）","published":1,"updated":"2021-03-18T14:46:52.259Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl2enrqzb0003y2loeovbe9hg","content":"<p>上节我们将微服务模块注册到了注册中心Nacos中，接下来就是如何实现微服务模块之间接口的调用。</p>\n<p>这里我们使用SpringCloud-Alibaba提供的OpenFeign进行微服务模块之间调用，如果微服务A需要调用微服务模块B的接口1，那么我们如何实现呢？</p>\n<p><strong>原理</strong></p>\n<p>​    微服务A、微服务B相互调用，前提是两个微服务都已经注册到注册中心Nacos中。然后微服务模块A1需要调用微服务B时，就去注册中心查看健康可用微服务模块B的地址，<a id=\"more\"></a>然后通过Nacos返回一个健康可用的微服务模块B1的地址给微服务模块A1，然后微服务模块通过利用OpenFeign向从Nacos中获得的地址发送<strong>HTTP请求</strong>给微服务模块B1的接口1，然后微服务A1调用微服务B1的接口1完成了。</p>\n<div align=\"center\"><img src=\"/2021/SpringCloud/Nacos%E5%A6%82%E4%BD%95%E8%B0%83%E7%94%A8%E5%85%B6%E4%BB%96%E5%BE%AE%E6%9C%8D%E5%8A%A1(%E4%B8%AD%EF%BC%89/1615645734755-1b3246df-3e91-474b-b901-bd58ac654797-20210318224006023.jpeg\" width=\"50%\" height=\"50%\" align=\"center/\"></div>\n\n<p>上面介绍了后面的一些原理后，现在我们实现微服务A调用微服务B的功能，这里以用户服务调用优惠券服务查看该用户的优惠券为例。</p>\n<p>1.首先两个模块都要注册到注册中心中，上节已经实现</p>\n<p>2.优惠券服务模块编写被调用接口</p>\n<pre><code class=\"java\">@RestController\n@RequestMapping(&quot;coupon/coupon&quot;)\npublic class CouponController &#123;\n    @Autowired\n    private CouponService couponService;\n\n    @RequestMapping(value=&quot;/member/list&quot;)\n    public R membercoupons()&#123;\n        CouponEntity couponEntity = new CouponEntity();\n        couponEntity.setCouponName(&quot;满100减10&quot;);\n        return R.ok().put(&quot;coupons&quot;, Arrays.asList(couponEntity));\n    &#125;\n&#125;\n</code></pre>\n<p>3.用户服务模块引入OpenFeign依赖</p>\n<pre><code class=\"xml\">        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n</code></pre>\n<p>4.用户模块编写一个对应优惠券服务的声明式远程调用接口，指明需要调用微服务的名称以及调用该服务的哪个接口</p>\n<p>​     OpenFeign通过声明式远程调用接口来实现调用服务，这样微服务A通过该接口就可以实现无感调用</p>\n<pre><code class=\"java\">package com.lookstarry.doermail.member.feign;\n\nimport com.lookstarry.common.utils.R;\nimport org.springframework.cloud.openfeign.FeignClient;\nimport org.springframework.web.bind.annotation.RequestMapping;\n\n/**\n * @PackageName:com.lookstarry.doermail.member.feign\n * @NAME:CouponFeignService\n * @Description:\n * @author: yizhichangyuan\n * @date:2021/3/13 21:46\n */\n\n/**\n * 这是一个声明式的远程调用，指明调用注册中心的那个服务的那个接口方法\n */\n@FeignClient(&quot;doermail-coupon&quot;) //调用的微服务名称\npublic interface CouponFeignService &#123;\n    @RequestMapping(&quot;/coupon/coupon/member/list&quot;) //对应调用哪个接口\n    public R membercoupons();\n&#125;\n</code></pre>\n<p>5.用户服务模块需要加上EnableFeignClients开启远程调用功能，指明自己哪个包是远程调用模块</p>\n<pre><code class=\"java\">package com.lookstarry.doermail.member;\n\nimport org.springframework.boot.SpringApplication;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\nimport org.springframework.cloud.client.discovery.EnableDiscoveryClient;\nimport org.springframework.cloud.openfeign.EnableFeignClients;\n\n/**\n * 1、调用远程调用别人的服务\n * 1）、引入open-feign\n * 2)、编写一个接口，告诉springCloud这个接口需要调用远程服务\n *  1、声明接口的每一个方法都是调用哪个远程服务的哪个请求\n * 3）、开启远程调用功能\n *\n */\n@EnableFeignClients(basePackages = &quot;com.lookstarry.doermail.member.feign&quot;)\n@SpringBootApplication\n@EnableDiscoveryClient\npublic class DoermailMemberApplication &#123;\n\n    public static void main(String[] args) &#123;\n        SpringApplication.run(DoermailMemberApplication.class, args);\n    &#125;\n&#125;\n</code></pre>\n","site":{"data":{"photography":[{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","title":"玉渊潭","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","title":"花儿","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","title":"白塔寺","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"}]}},"excerpt":"<p>上节我们将微服务模块注册到了注册中心Nacos中，接下来就是如何实现微服务模块之间接口的调用。</p>\n<p>这里我们使用SpringCloud-Alibaba提供的OpenFeign进行微服务模块之间调用，如果微服务A需要调用微服务模块B的接口1，那么我们如何实现呢？</p>\n<p><strong>原理</strong></p>\n<p>​    微服务A、微服务B相互调用，前提是两个微服务都已经注册到注册中心Nacos中。然后微服务模块A1需要调用微服务B时，就去注册中心查看健康可用微服务模块B的地址，</p>","more":"然后通过Nacos返回一个健康可用的微服务模块B1的地址给微服务模块A1，然后微服务模块通过利用OpenFeign向从Nacos中获得的地址发送<strong>HTTP请求</strong>给微服务模块B1的接口1，然后微服务A1调用微服务B1的接口1完成了。<p></p>\n<div align=\"center\"><img src=\"/2021/SpringCloud/Nacos%E5%A6%82%E4%BD%95%E8%B0%83%E7%94%A8%E5%85%B6%E4%BB%96%E5%BE%AE%E6%9C%8D%E5%8A%A1(%E4%B8%AD%EF%BC%89/1615645734755-1b3246df-3e91-474b-b901-bd58ac654797-20210318224006023.jpeg\" width=\"50%\" height=\"50%\" align=\"center/\"></div>\n\n<p>上面介绍了后面的一些原理后，现在我们实现微服务A调用微服务B的功能，这里以用户服务调用优惠券服务查看该用户的优惠券为例。</p>\n<p>1.首先两个模块都要注册到注册中心中，上节已经实现</p>\n<p>2.优惠券服务模块编写被调用接口</p>\n<pre><code class=\"java\">@RestController\n@RequestMapping(&quot;coupon/coupon&quot;)\npublic class CouponController &#123;\n    @Autowired\n    private CouponService couponService;\n\n    @RequestMapping(value=&quot;/member/list&quot;)\n    public R membercoupons()&#123;\n        CouponEntity couponEntity = new CouponEntity();\n        couponEntity.setCouponName(&quot;满100减10&quot;);\n        return R.ok().put(&quot;coupons&quot;, Arrays.asList(couponEntity));\n    &#125;\n&#125;\n</code></pre>\n<p>3.用户服务模块引入OpenFeign依赖</p>\n<pre><code class=\"xml\">        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n</code></pre>\n<p>4.用户模块编写一个对应优惠券服务的声明式远程调用接口，指明需要调用微服务的名称以及调用该服务的哪个接口</p>\n<p>​     OpenFeign通过声明式远程调用接口来实现调用服务，这样微服务A通过该接口就可以实现无感调用</p>\n<pre><code class=\"java\">package com.lookstarry.doermail.member.feign;\n\nimport com.lookstarry.common.utils.R;\nimport org.springframework.cloud.openfeign.FeignClient;\nimport org.springframework.web.bind.annotation.RequestMapping;\n\n/**\n * @PackageName:com.lookstarry.doermail.member.feign\n * @NAME:CouponFeignService\n * @Description:\n * @author: yizhichangyuan\n * @date:2021/3/13 21:46\n */\n\n/**\n * 这是一个声明式的远程调用，指明调用注册中心的那个服务的那个接口方法\n */\n@FeignClient(&quot;doermail-coupon&quot;) //调用的微服务名称\npublic interface CouponFeignService &#123;\n    @RequestMapping(&quot;/coupon/coupon/member/list&quot;) //对应调用哪个接口\n    public R membercoupons();\n&#125;\n</code></pre>\n<p>5.用户服务模块需要加上EnableFeignClients开启远程调用功能，指明自己哪个包是远程调用模块</p>\n<pre><code class=\"java\">package com.lookstarry.doermail.member;\n\nimport org.springframework.boot.SpringApplication;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\nimport org.springframework.cloud.client.discovery.EnableDiscoveryClient;\nimport org.springframework.cloud.openfeign.EnableFeignClients;\n\n/**\n * 1、调用远程调用别人的服务\n * 1）、引入open-feign\n * 2)、编写一个接口，告诉springCloud这个接口需要调用远程服务\n *  1、声明接口的每一个方法都是调用哪个远程服务的哪个请求\n * 3）、开启远程调用功能\n *\n */\n@EnableFeignClients(basePackages = &quot;com.lookstarry.doermail.member.feign&quot;)\n@SpringBootApplication\n@EnableDiscoveryClient\npublic class DoermailMemberApplication &#123;\n\n    public static void main(String[] args) &#123;\n        SpringApplication.run(DoermailMemberApplication.class, args);\n    &#125;\n&#125;\n</code></pre>"},{"title":"Kaptcha验证码","date":"2021-01-15T16:00:00.000Z","toc":true,"_content":"Kaptcha是java中一个验证码图片校对的组件，其核心是通过配置一个Servlet为前端提供验证码图片，并将对应图片正确验证码放入到session中，便于校对用户提交的验证码。\n\n###  <font size=4 color='orange'>1. 具体步骤</font>\n\n1. 首先引入pom\n2. web.xml配置Kaptcha的Servlet，其中主要指定验证码图片的宽度、高度、几个字符、字体、字体颜色、干扰线的颜色以及相应请求验证码图片的url-pattern\n  <!--more-->\n3. 前端img的src属性填充的url就为url-pattern，img会向Kaptcha的Servlet请求验证码图片\n4. 前端表单提交的时候，同时需要把用户输入的验证码也放入到表单中，以便发给后端以便进行比对\n5. 后端在接收前端表单数据，第一步应该是检查验证码是否正确，如何检查？Kaptcha在向前端发送验证码图片的同时，就已经把验证码图片对应的正确的验证码放入的session中，所以后端只需要比对request中传来表单中验证码数据和Session中获取的数据是否一致即可，不一致就直接返回错误信息（其中Session的参数key是`com.google.code.kaptcha.Constants.KAPTCHA_SESSION_KEY`\n\n\n\n\n\n#### <font size=4 color='orange'>2. 实践</font>\n\n1.首先在pom.xml中引入依赖\n\n```xml\n    <!--验证码校验-->\n    <!-- https://mvnrepository.com/artifact/com.github.penggle/kaptcha -->\n    <dependency>\n      <groupId>com.github.penggle</groupId>\n      <artifactId>kaptcha</artifactId>\n      <version>2.3.2</version>\n    </dependency>\n```\n2.web.xml配置Kaptcha的Servlet，其中主要指定验证码图片的宽度、高度、几个字符、字体、字体颜色、干扰线的颜色以及相应请求验证码图片的url-pattern\n\n```xml\n    <!--Kaptcha验证码servlet-->\n    <servlet>\n        <servlet-name>Kaptcha</servlet-name>\n        <servlet-class>com.google.code.kaptcha.servlet.KaptchaServlet</servlet-class>\n        <!--是否有边框-->\n        <init-param>\n            <param-name>kaptcha.border</param-name>\n            <param-value>no</param-value>\n        </init-param>\n        <!--字体颜色-->\n        <init-param>\n            <param-name>kaptcha.textproducer.font.color</param-name>\n            <param-value>red</param-value>\n        </init-param>\n        <!--图片宽度-->\n        <init-param>\n            <param-name>kaptcha.image.width</param-name>\n            <param-value>135</param-value>\n        </init-param>\n        <!--使用哪些字符来生成验证码-->\n        <init-param>\n            <param-name>kaptcha.textproducer.char.string</param-name>\n            <param-value>ACDEFHKPRSTWX345679</param-value>\n        </init-param>\n        <!--图片高度-->\n        <init-param>\n            <param-name>kaptcha.image.height</param-name>\n            <param-value>50</param-value>\n        </init-param>\n        <!--字体大小-->\n        <init-param>\n            <param-name>kaptcha.textproducer.font.size</param-name>\n            <param-value>43</param-value>\n        </init-param>\n        <!--干扰线的颜色-->\n        <init-param>\n            <param-name>kaptcha.noise.color</param-name>\n            <param-value>black</param-value>\n        </init-param>\n        <!--字符个数-->\n        <init-param>\n            <param-name>kaptcha.textproducer.char.length</param-name>\n            <param-value>4</param-value>\n        </init-param>\n        <!--字体-->\n        <init-param>\n            <param-name>kaptcha.textproducer.font.names</param-name>\n            <param-value>Arial</param-value>\n        </init-param>\n    </servlet>\n    <servlet-mapping>\n        <servlet-name>Kaptcha</servlet-name>\n        <url-pattern>/Kaptcha</url-pattern>\n    </servlet-mapping>\n```\n3.前端img的src属性填充的url就为url-pattern，img会向Kaptcha的Servlet请求验证码图片\n```html\n<div class=\"item-title label\">验证码</div>\n<div class=\"item-input\">\n<input type=\"text\" id=\"j_kaptcha\" placeholder=\"请输入验证码\"/>\n// src的地址和servlet的地址一致，这里的o2o是项目的根目录\n<img id=\"kaptcha-img\" src=\"/o2o/Kaptcha\" title=\"点击更换图片\" alt=\"点击更换图片\" onclick=\"changeVerifyCode(this)\">\n```\n```javascript\n// 点击切换图片就是再次发送同一个请求，加上一个两位的数字，就会重新更换前端的验证码图片\nfunction changeVerifyCode(img){\n    img.src = \"/o2o/Kaptcha?\" + Math.floor(Math.random() * 100);\n}\n```\n<div align='center'><img src=\"image-20210129220709957.png\" alt=\"image-20210129220709957\" style=\"zoom:50%;\" /></div>\n\n4.前端表单提交的时候，同时需要把用户输入的验证码也放入到表单中，以便发给后端以便进行比对\n\n```javascript\n// 获取用户输入的验证码\nvar fromData = new FormData();\nvar verifyCode = $(\"#j_kaptcha\").val();\nif (!verifyCode) {\n  $.toast(\"验证码为空\");\n  return;\n}\nformData.append(\"verifyCodeActual\", verifyCode);\n$.ajax({\n  url: registerShopURL,\n  type: 'POST',\n  data: formData,\n  contentType: false, // 因为有文字和图片，所以为false\n  processData: false,\n  cache: false,\n  success: function (data) {\n    if (data.success) {\n      $.toast(\"提交成功！\");\n    } else {\n      $.toast(\"提交失败！\" + data.errMsg);\n    }\n    // 不管提交是否成功，都要改变一下验证码，因为点击事件连接着一个切换图片的事件\n    $('#kaptcha-img').click();\n  }\n});\n```\n5.后端在接收前端表单数据，第一步应该是检查验证码是否正确，如何检查？Kaptcha在向前端发送验证码图片的同时，就已经把验证码图片对应的正确的验证码放入的session中，所以后端只需要比对request中传来表单中验证码数据和Session中获取的数据是否一致即可，不一致就直接返回错误信息（其中Session的参数key是`com.google.code.kaptcha.Constants.KAPTCHA_SESSION_KEY`）\n\n```java\npackage com.imooc.o2o.util;\n\nimport com.google.code.kaptcha.Constants;\nimport javax.servlet.http.HttpServletRequest;\n\npublic class CodeUtil {\n    public static Boolean checkVerifyCode(HttpServletRequest request){\n        // 在shopOperation.html中img的src发送请求给/o2o/Kaptcha给Kaptcha Servlet的时候，\n        // 同时图片真实的验证码就会种植在session中，便于校验用户输入与真实是否相同\n        String verifyCodeExpected = (String)request.getSession().getAttribute(Constants.KAPTCHA_SESSION_KEY);\n        System.out.println(\"verifyCodeExpected:\" + verifyCodeExpected);\n        String verifyCode = HttpServletRequestUtil.getString(request, \"verifyCodeActual\");\n        System.out.println(\"verifyCodeActual:\" + verifyCode);\n        if(verifyCode == null || !verifyCode.equals(verifyCodeExpected)){\n            return false;\n        }\n        return true;\n    }\n}\n```\n","source":"_posts/Kaptcha验证码.md","raw":"---\ntitle: Kaptcha验证码\ndate: 2021-1-16\ntags:\n\t- Kaptcha\ncategories:\n\t- Spring\ntoc: true\n---\nKaptcha是java中一个验证码图片校对的组件，其核心是通过配置一个Servlet为前端提供验证码图片，并将对应图片正确验证码放入到session中，便于校对用户提交的验证码。\n\n###  <font size=4 color='orange'>1. 具体步骤</font>\n\n1. 首先引入pom\n2. web.xml配置Kaptcha的Servlet，其中主要指定验证码图片的宽度、高度、几个字符、字体、字体颜色、干扰线的颜色以及相应请求验证码图片的url-pattern\n  <!--more-->\n3. 前端img的src属性填充的url就为url-pattern，img会向Kaptcha的Servlet请求验证码图片\n4. 前端表单提交的时候，同时需要把用户输入的验证码也放入到表单中，以便发给后端以便进行比对\n5. 后端在接收前端表单数据，第一步应该是检查验证码是否正确，如何检查？Kaptcha在向前端发送验证码图片的同时，就已经把验证码图片对应的正确的验证码放入的session中，所以后端只需要比对request中传来表单中验证码数据和Session中获取的数据是否一致即可，不一致就直接返回错误信息（其中Session的参数key是`com.google.code.kaptcha.Constants.KAPTCHA_SESSION_KEY`\n\n\n\n\n\n#### <font size=4 color='orange'>2. 实践</font>\n\n1.首先在pom.xml中引入依赖\n\n```xml\n    <!--验证码校验-->\n    <!-- https://mvnrepository.com/artifact/com.github.penggle/kaptcha -->\n    <dependency>\n      <groupId>com.github.penggle</groupId>\n      <artifactId>kaptcha</artifactId>\n      <version>2.3.2</version>\n    </dependency>\n```\n2.web.xml配置Kaptcha的Servlet，其中主要指定验证码图片的宽度、高度、几个字符、字体、字体颜色、干扰线的颜色以及相应请求验证码图片的url-pattern\n\n```xml\n    <!--Kaptcha验证码servlet-->\n    <servlet>\n        <servlet-name>Kaptcha</servlet-name>\n        <servlet-class>com.google.code.kaptcha.servlet.KaptchaServlet</servlet-class>\n        <!--是否有边框-->\n        <init-param>\n            <param-name>kaptcha.border</param-name>\n            <param-value>no</param-value>\n        </init-param>\n        <!--字体颜色-->\n        <init-param>\n            <param-name>kaptcha.textproducer.font.color</param-name>\n            <param-value>red</param-value>\n        </init-param>\n        <!--图片宽度-->\n        <init-param>\n            <param-name>kaptcha.image.width</param-name>\n            <param-value>135</param-value>\n        </init-param>\n        <!--使用哪些字符来生成验证码-->\n        <init-param>\n            <param-name>kaptcha.textproducer.char.string</param-name>\n            <param-value>ACDEFHKPRSTWX345679</param-value>\n        </init-param>\n        <!--图片高度-->\n        <init-param>\n            <param-name>kaptcha.image.height</param-name>\n            <param-value>50</param-value>\n        </init-param>\n        <!--字体大小-->\n        <init-param>\n            <param-name>kaptcha.textproducer.font.size</param-name>\n            <param-value>43</param-value>\n        </init-param>\n        <!--干扰线的颜色-->\n        <init-param>\n            <param-name>kaptcha.noise.color</param-name>\n            <param-value>black</param-value>\n        </init-param>\n        <!--字符个数-->\n        <init-param>\n            <param-name>kaptcha.textproducer.char.length</param-name>\n            <param-value>4</param-value>\n        </init-param>\n        <!--字体-->\n        <init-param>\n            <param-name>kaptcha.textproducer.font.names</param-name>\n            <param-value>Arial</param-value>\n        </init-param>\n    </servlet>\n    <servlet-mapping>\n        <servlet-name>Kaptcha</servlet-name>\n        <url-pattern>/Kaptcha</url-pattern>\n    </servlet-mapping>\n```\n3.前端img的src属性填充的url就为url-pattern，img会向Kaptcha的Servlet请求验证码图片\n```html\n<div class=\"item-title label\">验证码</div>\n<div class=\"item-input\">\n<input type=\"text\" id=\"j_kaptcha\" placeholder=\"请输入验证码\"/>\n// src的地址和servlet的地址一致，这里的o2o是项目的根目录\n<img id=\"kaptcha-img\" src=\"/o2o/Kaptcha\" title=\"点击更换图片\" alt=\"点击更换图片\" onclick=\"changeVerifyCode(this)\">\n```\n```javascript\n// 点击切换图片就是再次发送同一个请求，加上一个两位的数字，就会重新更换前端的验证码图片\nfunction changeVerifyCode(img){\n    img.src = \"/o2o/Kaptcha?\" + Math.floor(Math.random() * 100);\n}\n```\n<div align='center'><img src=\"image-20210129220709957.png\" alt=\"image-20210129220709957\" style=\"zoom:50%;\" /></div>\n\n4.前端表单提交的时候，同时需要把用户输入的验证码也放入到表单中，以便发给后端以便进行比对\n\n```javascript\n// 获取用户输入的验证码\nvar fromData = new FormData();\nvar verifyCode = $(\"#j_kaptcha\").val();\nif (!verifyCode) {\n  $.toast(\"验证码为空\");\n  return;\n}\nformData.append(\"verifyCodeActual\", verifyCode);\n$.ajax({\n  url: registerShopURL,\n  type: 'POST',\n  data: formData,\n  contentType: false, // 因为有文字和图片，所以为false\n  processData: false,\n  cache: false,\n  success: function (data) {\n    if (data.success) {\n      $.toast(\"提交成功！\");\n    } else {\n      $.toast(\"提交失败！\" + data.errMsg);\n    }\n    // 不管提交是否成功，都要改变一下验证码，因为点击事件连接着一个切换图片的事件\n    $('#kaptcha-img').click();\n  }\n});\n```\n5.后端在接收前端表单数据，第一步应该是检查验证码是否正确，如何检查？Kaptcha在向前端发送验证码图片的同时，就已经把验证码图片对应的正确的验证码放入的session中，所以后端只需要比对request中传来表单中验证码数据和Session中获取的数据是否一致即可，不一致就直接返回错误信息（其中Session的参数key是`com.google.code.kaptcha.Constants.KAPTCHA_SESSION_KEY`）\n\n```java\npackage com.imooc.o2o.util;\n\nimport com.google.code.kaptcha.Constants;\nimport javax.servlet.http.HttpServletRequest;\n\npublic class CodeUtil {\n    public static Boolean checkVerifyCode(HttpServletRequest request){\n        // 在shopOperation.html中img的src发送请求给/o2o/Kaptcha给Kaptcha Servlet的时候，\n        // 同时图片真实的验证码就会种植在session中，便于校验用户输入与真实是否相同\n        String verifyCodeExpected = (String)request.getSession().getAttribute(Constants.KAPTCHA_SESSION_KEY);\n        System.out.println(\"verifyCodeExpected:\" + verifyCodeExpected);\n        String verifyCode = HttpServletRequestUtil.getString(request, \"verifyCodeActual\");\n        System.out.println(\"verifyCodeActual:\" + verifyCode);\n        if(verifyCode == null || !verifyCode.equals(verifyCodeExpected)){\n            return false;\n        }\n        return true;\n    }\n}\n```\n","slug":"Kaptcha验证码","published":1,"updated":"2021-03-14T08:53:45.688Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl2enrqzf0007y2loaghzd8ga","content":"<p>Kaptcha是java中一个验证码图片校对的组件，其核心是通过配置一个Servlet为前端提供验证码图片，并将对应图片正确验证码放入到session中，便于校对用户提交的验证码。</p>\n<h3 id=\"1-具体步骤\"><a href=\"#1-具体步骤\" class=\"headerlink\" title=\"1. 具体步骤\"></a><font size=\"4\" color=\"orange\">1. 具体步骤</font></h3><ol>\n<li>首先引入pom</li>\n<li>web.xml配置Kaptcha的Servlet，其中主要指定验证码图片的宽度、高度、几个字符、字体、字体颜色、干扰线的颜色以及相应请求验证码图片的url-pattern<a id=\"more\"></a></li>\n<li>前端img的src属性填充的url就为url-pattern，img会向Kaptcha的Servlet请求验证码图片</li>\n<li>前端表单提交的时候，同时需要把用户输入的验证码也放入到表单中，以便发给后端以便进行比对</li>\n<li>后端在接收前端表单数据，第一步应该是检查验证码是否正确，如何检查？Kaptcha在向前端发送验证码图片的同时，就已经把验证码图片对应的正确的验证码放入的session中，所以后端只需要比对request中传来表单中验证码数据和Session中获取的数据是否一致即可，不一致就直接返回错误信息（其中Session的参数key是<code>com.google.code.kaptcha.Constants.KAPTCHA_SESSION_KEY</code></li>\n</ol>\n<h4 id=\"2-实践\"><a href=\"#2-实践\" class=\"headerlink\" title=\"2. 实践\"></a><font size=\"4\" color=\"orange\">2. 实践</font></h4><p>1.首先在pom.xml中引入依赖</p>\n<pre><code class=\"xml\">    &lt;!--验证码校验--&gt;\n    &lt;!-- https://mvnrepository.com/artifact/com.github.penggle/kaptcha --&gt;\n    &lt;dependency&gt;\n      &lt;groupId&gt;com.github.penggle&lt;/groupId&gt;\n      &lt;artifactId&gt;kaptcha&lt;/artifactId&gt;\n      &lt;version&gt;2.3.2&lt;/version&gt;\n    &lt;/dependency&gt;\n</code></pre>\n<p>2.web.xml配置Kaptcha的Servlet，其中主要指定验证码图片的宽度、高度、几个字符、字体、字体颜色、干扰线的颜色以及相应请求验证码图片的url-pattern</p>\n<pre><code class=\"xml\">    &lt;!--Kaptcha验证码servlet--&gt;\n    &lt;servlet&gt;\n        &lt;servlet-name&gt;Kaptcha&lt;/servlet-name&gt;\n        &lt;servlet-class&gt;com.google.code.kaptcha.servlet.KaptchaServlet&lt;/servlet-class&gt;\n        &lt;!--是否有边框--&gt;\n        &lt;init-param&gt;\n            &lt;param-name&gt;kaptcha.border&lt;/param-name&gt;\n            &lt;param-value&gt;no&lt;/param-value&gt;\n        &lt;/init-param&gt;\n        &lt;!--字体颜色--&gt;\n        &lt;init-param&gt;\n            &lt;param-name&gt;kaptcha.textproducer.font.color&lt;/param-name&gt;\n            &lt;param-value&gt;red&lt;/param-value&gt;\n        &lt;/init-param&gt;\n        &lt;!--图片宽度--&gt;\n        &lt;init-param&gt;\n            &lt;param-name&gt;kaptcha.image.width&lt;/param-name&gt;\n            &lt;param-value&gt;135&lt;/param-value&gt;\n        &lt;/init-param&gt;\n        &lt;!--使用哪些字符来生成验证码--&gt;\n        &lt;init-param&gt;\n            &lt;param-name&gt;kaptcha.textproducer.char.string&lt;/param-name&gt;\n            &lt;param-value&gt;ACDEFHKPRSTWX345679&lt;/param-value&gt;\n        &lt;/init-param&gt;\n        &lt;!--图片高度--&gt;\n        &lt;init-param&gt;\n            &lt;param-name&gt;kaptcha.image.height&lt;/param-name&gt;\n            &lt;param-value&gt;50&lt;/param-value&gt;\n        &lt;/init-param&gt;\n        &lt;!--字体大小--&gt;\n        &lt;init-param&gt;\n            &lt;param-name&gt;kaptcha.textproducer.font.size&lt;/param-name&gt;\n            &lt;param-value&gt;43&lt;/param-value&gt;\n        &lt;/init-param&gt;\n        &lt;!--干扰线的颜色--&gt;\n        &lt;init-param&gt;\n            &lt;param-name&gt;kaptcha.noise.color&lt;/param-name&gt;\n            &lt;param-value&gt;black&lt;/param-value&gt;\n        &lt;/init-param&gt;\n        &lt;!--字符个数--&gt;\n        &lt;init-param&gt;\n            &lt;param-name&gt;kaptcha.textproducer.char.length&lt;/param-name&gt;\n            &lt;param-value&gt;4&lt;/param-value&gt;\n        &lt;/init-param&gt;\n        &lt;!--字体--&gt;\n        &lt;init-param&gt;\n            &lt;param-name&gt;kaptcha.textproducer.font.names&lt;/param-name&gt;\n            &lt;param-value&gt;Arial&lt;/param-value&gt;\n        &lt;/init-param&gt;\n    &lt;/servlet&gt;\n    &lt;servlet-mapping&gt;\n        &lt;servlet-name&gt;Kaptcha&lt;/servlet-name&gt;\n        &lt;url-pattern&gt;/Kaptcha&lt;/url-pattern&gt;\n    &lt;/servlet-mapping&gt;\n</code></pre>\n<p>3.前端img的src属性填充的url就为url-pattern，img会向Kaptcha的Servlet请求验证码图片</p>\n<pre><code class=\"html\">&lt;div class=&quot;item-title label&quot;&gt;验证码&lt;/div&gt;\n&lt;div class=&quot;item-input&quot;&gt;\n&lt;input type=&quot;text&quot; id=&quot;j_kaptcha&quot; placeholder=&quot;请输入验证码&quot;/&gt;\n// src的地址和servlet的地址一致，这里的o2o是项目的根目录\n&lt;img id=&quot;kaptcha-img&quot; src=&quot;/o2o/Kaptcha&quot; title=&quot;点击更换图片&quot; alt=&quot;点击更换图片&quot; onclick=&quot;changeVerifyCode(this)&quot;&gt;\n</code></pre>\n<pre><code class=\"javascript\">// 点击切换图片就是再次发送同一个请求，加上一个两位的数字，就会重新更换前端的验证码图片\nfunction changeVerifyCode(img)&#123;\n    img.src = &quot;/o2o/Kaptcha?&quot; + Math.floor(Math.random() * 100);\n&#125;\n</code></pre>\n<div align=\"center\"><img src=\"/2021/Spring/Kaptcha%E9%AA%8C%E8%AF%81%E7%A0%81/image-20210129220709957.png\" alt=\"image-20210129220709957\" style=\"zoom:50%;\"></div>\n\n<p>4.前端表单提交的时候，同时需要把用户输入的验证码也放入到表单中，以便发给后端以便进行比对</p>\n<pre><code class=\"javascript\">// 获取用户输入的验证码\nvar fromData = new FormData();\nvar verifyCode = $(&quot;#j_kaptcha&quot;).val();\nif (!verifyCode) &#123;\n  $.toast(&quot;验证码为空&quot;);\n  return;\n&#125;\nformData.append(&quot;verifyCodeActual&quot;, verifyCode);\n$.ajax(&#123;\n  url: registerShopURL,\n  type: &#39;POST&#39;,\n  data: formData,\n  contentType: false, // 因为有文字和图片，所以为false\n  processData: false,\n  cache: false,\n  success: function (data) &#123;\n    if (data.success) &#123;\n      $.toast(&quot;提交成功！&quot;);\n    &#125; else &#123;\n      $.toast(&quot;提交失败！&quot; + data.errMsg);\n    &#125;\n    // 不管提交是否成功，都要改变一下验证码，因为点击事件连接着一个切换图片的事件\n    $(&#39;#kaptcha-img&#39;).click();\n  &#125;\n&#125;);\n</code></pre>\n<p>5.后端在接收前端表单数据，第一步应该是检查验证码是否正确，如何检查？Kaptcha在向前端发送验证码图片的同时，就已经把验证码图片对应的正确的验证码放入的session中，所以后端只需要比对request中传来表单中验证码数据和Session中获取的数据是否一致即可，不一致就直接返回错误信息（其中Session的参数key是<code>com.google.code.kaptcha.Constants.KAPTCHA_SESSION_KEY</code>）</p>\n<pre><code class=\"java\">package com.imooc.o2o.util;\n\nimport com.google.code.kaptcha.Constants;\nimport javax.servlet.http.HttpServletRequest;\n\npublic class CodeUtil &#123;\n    public static Boolean checkVerifyCode(HttpServletRequest request)&#123;\n        // 在shopOperation.html中img的src发送请求给/o2o/Kaptcha给Kaptcha Servlet的时候，\n        // 同时图片真实的验证码就会种植在session中，便于校验用户输入与真实是否相同\n        String verifyCodeExpected = (String)request.getSession().getAttribute(Constants.KAPTCHA_SESSION_KEY);\n        System.out.println(&quot;verifyCodeExpected:&quot; + verifyCodeExpected);\n        String verifyCode = HttpServletRequestUtil.getString(request, &quot;verifyCodeActual&quot;);\n        System.out.println(&quot;verifyCodeActual:&quot; + verifyCode);\n        if(verifyCode == null || !verifyCode.equals(verifyCodeExpected))&#123;\n            return false;\n        &#125;\n        return true;\n    &#125;\n&#125;\n</code></pre>\n","site":{"data":{"photography":[{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","title":"玉渊潭","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","title":"花儿","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","title":"白塔寺","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"}]}},"excerpt":"<p>Kaptcha是java中一个验证码图片校对的组件，其核心是通过配置一个Servlet为前端提供验证码图片，并将对应图片正确验证码放入到session中，便于校对用户提交的验证码。</p>\n<h3 id=\"1-具体步骤\"><a href=\"#1-具体步骤\" class=\"headerlink\" title=\"1. 具体步骤\"></a><font size=\"4\" color=\"orange\">1. 具体步骤</font></h3><ol>\n<li>首先引入pom</li>\n<li>web.xml配置Kaptcha的Servlet，其中主要指定验证码图片的宽度、高度、几个字符、字体、字体颜色、干扰线的颜色以及相应请求验证码图片的url-pattern</li></ol>","more":"\n<li>前端img的src属性填充的url就为url-pattern，img会向Kaptcha的Servlet请求验证码图片</li>\n<li>前端表单提交的时候，同时需要把用户输入的验证码也放入到表单中，以便发给后端以便进行比对</li>\n<li>后端在接收前端表单数据，第一步应该是检查验证码是否正确，如何检查？Kaptcha在向前端发送验证码图片的同时，就已经把验证码图片对应的正确的验证码放入的session中，所以后端只需要比对request中传来表单中验证码数据和Session中获取的数据是否一致即可，不一致就直接返回错误信息（其中Session的参数key是<code>com.google.code.kaptcha.Constants.KAPTCHA_SESSION_KEY</code></li>\n\n<h4 id=\"2-实践\"><a href=\"#2-实践\" class=\"headerlink\" title=\"2. 实践\"></a><font size=\"4\" color=\"orange\">2. 实践</font></h4><p>1.首先在pom.xml中引入依赖</p>\n<pre><code class=\"xml\">    &lt;!--验证码校验--&gt;\n    &lt;!-- https://mvnrepository.com/artifact/com.github.penggle/kaptcha --&gt;\n    &lt;dependency&gt;\n      &lt;groupId&gt;com.github.penggle&lt;/groupId&gt;\n      &lt;artifactId&gt;kaptcha&lt;/artifactId&gt;\n      &lt;version&gt;2.3.2&lt;/version&gt;\n    &lt;/dependency&gt;\n</code></pre>\n<p>2.web.xml配置Kaptcha的Servlet，其中主要指定验证码图片的宽度、高度、几个字符、字体、字体颜色、干扰线的颜色以及相应请求验证码图片的url-pattern</p>\n<pre><code class=\"xml\">    &lt;!--Kaptcha验证码servlet--&gt;\n    &lt;servlet&gt;\n        &lt;servlet-name&gt;Kaptcha&lt;/servlet-name&gt;\n        &lt;servlet-class&gt;com.google.code.kaptcha.servlet.KaptchaServlet&lt;/servlet-class&gt;\n        &lt;!--是否有边框--&gt;\n        &lt;init-param&gt;\n            &lt;param-name&gt;kaptcha.border&lt;/param-name&gt;\n            &lt;param-value&gt;no&lt;/param-value&gt;\n        &lt;/init-param&gt;\n        &lt;!--字体颜色--&gt;\n        &lt;init-param&gt;\n            &lt;param-name&gt;kaptcha.textproducer.font.color&lt;/param-name&gt;\n            &lt;param-value&gt;red&lt;/param-value&gt;\n        &lt;/init-param&gt;\n        &lt;!--图片宽度--&gt;\n        &lt;init-param&gt;\n            &lt;param-name&gt;kaptcha.image.width&lt;/param-name&gt;\n            &lt;param-value&gt;135&lt;/param-value&gt;\n        &lt;/init-param&gt;\n        &lt;!--使用哪些字符来生成验证码--&gt;\n        &lt;init-param&gt;\n            &lt;param-name&gt;kaptcha.textproducer.char.string&lt;/param-name&gt;\n            &lt;param-value&gt;ACDEFHKPRSTWX345679&lt;/param-value&gt;\n        &lt;/init-param&gt;\n        &lt;!--图片高度--&gt;\n        &lt;init-param&gt;\n            &lt;param-name&gt;kaptcha.image.height&lt;/param-name&gt;\n            &lt;param-value&gt;50&lt;/param-value&gt;\n        &lt;/init-param&gt;\n        &lt;!--字体大小--&gt;\n        &lt;init-param&gt;\n            &lt;param-name&gt;kaptcha.textproducer.font.size&lt;/param-name&gt;\n            &lt;param-value&gt;43&lt;/param-value&gt;\n        &lt;/init-param&gt;\n        &lt;!--干扰线的颜色--&gt;\n        &lt;init-param&gt;\n            &lt;param-name&gt;kaptcha.noise.color&lt;/param-name&gt;\n            &lt;param-value&gt;black&lt;/param-value&gt;\n        &lt;/init-param&gt;\n        &lt;!--字符个数--&gt;\n        &lt;init-param&gt;\n            &lt;param-name&gt;kaptcha.textproducer.char.length&lt;/param-name&gt;\n            &lt;param-value&gt;4&lt;/param-value&gt;\n        &lt;/init-param&gt;\n        &lt;!--字体--&gt;\n        &lt;init-param&gt;\n            &lt;param-name&gt;kaptcha.textproducer.font.names&lt;/param-name&gt;\n            &lt;param-value&gt;Arial&lt;/param-value&gt;\n        &lt;/init-param&gt;\n    &lt;/servlet&gt;\n    &lt;servlet-mapping&gt;\n        &lt;servlet-name&gt;Kaptcha&lt;/servlet-name&gt;\n        &lt;url-pattern&gt;/Kaptcha&lt;/url-pattern&gt;\n    &lt;/servlet-mapping&gt;\n</code></pre>\n<p>3.前端img的src属性填充的url就为url-pattern，img会向Kaptcha的Servlet请求验证码图片</p>\n<pre><code class=\"html\">&lt;div class=&quot;item-title label&quot;&gt;验证码&lt;/div&gt;\n&lt;div class=&quot;item-input&quot;&gt;\n&lt;input type=&quot;text&quot; id=&quot;j_kaptcha&quot; placeholder=&quot;请输入验证码&quot;/&gt;\n// src的地址和servlet的地址一致，这里的o2o是项目的根目录\n&lt;img id=&quot;kaptcha-img&quot; src=&quot;/o2o/Kaptcha&quot; title=&quot;点击更换图片&quot; alt=&quot;点击更换图片&quot; onclick=&quot;changeVerifyCode(this)&quot;&gt;\n</code></pre>\n<pre><code class=\"javascript\">// 点击切换图片就是再次发送同一个请求，加上一个两位的数字，就会重新更换前端的验证码图片\nfunction changeVerifyCode(img)&#123;\n    img.src = &quot;/o2o/Kaptcha?&quot; + Math.floor(Math.random() * 100);\n&#125;\n</code></pre>\n<div align=\"center\"><img src=\"/2021/Spring/Kaptcha%E9%AA%8C%E8%AF%81%E7%A0%81/image-20210129220709957.png\" alt=\"image-20210129220709957\" style=\"zoom:50%;\"></div>\n\n<p>4.前端表单提交的时候，同时需要把用户输入的验证码也放入到表单中，以便发给后端以便进行比对</p>\n<pre><code class=\"javascript\">// 获取用户输入的验证码\nvar fromData = new FormData();\nvar verifyCode = $(&quot;#j_kaptcha&quot;).val();\nif (!verifyCode) &#123;\n  $.toast(&quot;验证码为空&quot;);\n  return;\n&#125;\nformData.append(&quot;verifyCodeActual&quot;, verifyCode);\n$.ajax(&#123;\n  url: registerShopURL,\n  type: &#39;POST&#39;,\n  data: formData,\n  contentType: false, // 因为有文字和图片，所以为false\n  processData: false,\n  cache: false,\n  success: function (data) &#123;\n    if (data.success) &#123;\n      $.toast(&quot;提交成功！&quot;);\n    &#125; else &#123;\n      $.toast(&quot;提交失败！&quot; + data.errMsg);\n    &#125;\n    // 不管提交是否成功，都要改变一下验证码，因为点击事件连接着一个切换图片的事件\n    $(&#39;#kaptcha-img&#39;).click();\n  &#125;\n&#125;);\n</code></pre>\n<p>5.后端在接收前端表单数据，第一步应该是检查验证码是否正确，如何检查？Kaptcha在向前端发送验证码图片的同时，就已经把验证码图片对应的正确的验证码放入的session中，所以后端只需要比对request中传来表单中验证码数据和Session中获取的数据是否一致即可，不一致就直接返回错误信息（其中Session的参数key是<code>com.google.code.kaptcha.Constants.KAPTCHA_SESSION_KEY</code>）</p>\n<pre><code class=\"java\">package com.imooc.o2o.util;\n\nimport com.google.code.kaptcha.Constants;\nimport javax.servlet.http.HttpServletRequest;\n\npublic class CodeUtil &#123;\n    public static Boolean checkVerifyCode(HttpServletRequest request)&#123;\n        // 在shopOperation.html中img的src发送请求给/o2o/Kaptcha给Kaptcha Servlet的时候，\n        // 同时图片真实的验证码就会种植在session中，便于校验用户输入与真实是否相同\n        String verifyCodeExpected = (String)request.getSession().getAttribute(Constants.KAPTCHA_SESSION_KEY);\n        System.out.println(&quot;verifyCodeExpected:&quot; + verifyCodeExpected);\n        String verifyCode = HttpServletRequestUtil.getString(request, &quot;verifyCodeActual&quot;);\n        System.out.println(&quot;verifyCodeActual:&quot; + verifyCode);\n        if(verifyCode == null || !verifyCode.equals(verifyCodeExpected))&#123;\n            return false;\n        &#125;\n        return true;\n    &#125;\n&#125;\n</code></pre>"},{"title":"Nacos：如何注册服务（上）","date":"2021-03-13T16:00:00.000Z","toc":true,"_content":"\nSpringCloud-Alibaba-Nacos是阿里出品的一个服务发现与注册的组件，微服务需要调用其他微服务模块的服务或者微服务模块需要被其他模块调用，都需要到Nacos注册中心中注册该微服务模块\n\n**如何微服务模块注册到注册中心，主要是以下几个步骤**\n\n1.在微服务模块引入Nacos的依赖\n\n2.启动Nacos服务器\n\n3.微服务模块设置好注册中心的接口以及该微服务模块需要注册到服务中心的名称\n\n4.在启动类加入 @EnableDiscoveryClient 注解表示该服务注册到Nacos中\n\n<!--more-->\n\n### 一、引入Nacos依赖\n\n首先需要引入SpringCloud-Alibaba组件包，其中就有Nacos，由于我们每个微服务都需要将自身注册到注册中心以及发现要调用的服务地址，因此我们首先将SpringCloud-Alibaba组件包放置在Common通用模块下，然后Common模块引入Nacos依赖，然后下个每个微模块通过引用common模块来实现引入Common模块的Nacos依赖以及公共工具类、Bean等\n\nCommon模块--对应的Module为Maven\n\n```xml\n <?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n        <parent>\n        <artifactId>doermail</artifactId>\n        <groupId>com.lookstarry.doermail</groupId>\n        <version>0.0.1-SNAPSHOT</version>\n    </parent>\n    <modelVersion>4.0.0</modelVersion>\n\n    <artifactId>doermail-common</artifactId> \n\n  <!--所有微服务共同的依赖，注意这里的dependency不能有scope标签，这样其他微服务模块好像无法引入该依赖，要去掉</scope>标签-->\n  <dependencies>\n    <!--Nacos微服务发现与注册-->\n        <dependency>\n            <groupId>com.alibaba.cloud</groupId>\n            <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>\n        </dependency> \n    </dependencies>\n\n    <!--dependencyManagement含义表示依赖管理，\n    以后再dependencies中引入spring-cloud-alibaba依赖不需要指定版本号-->\n    <dependencyManagement>\n        <dependencies>\n            <dependency>\n                <groupId>com.alibaba.cloud</groupId>\n                <artifactId>spring-cloud-alibaba-dependencies</artifactId>\n                <version>2.1.0.RELEASE</version>\n                <type>pom</type>\n                <scope>import</scope>\n            </dependency>\n        </dependencies>\n    </dependencyManagement>\n```\n\n其他微服务模块如何引用Common模块下的依赖以及工具类呢？\n\n通过在其他模块的pom.xml中dependencies中引入Common模块的信息\n\n```xml\n       <dependency>\n            <groupId>com.lookstarry.doermail</groupId>\n            <artifactId>doermail-common</artifactId>\n            <version>0.0.1-SNAPSHOT</version>\n        </dependency>\n```\n\n这样其他微服务模块都能引入Common模块下nacos\n\n\n\n### 二、下载并启动 Nacos Server\n\n1.首先需要获取 Nacos Server，支持直接下载和源码构建两种方式。\n\n​\t直接下载：[Nacos Server 下载页](https://github.com/alibaba/nacos/releases)\n\n​    源码构建：进入 Nacos [Github 项目页面](https://github.com/alibaba/nacos)，将代码 git clone 到本地自行编译打包，[参考此文档](https://nacos.io/zh-cn/docs/quick-start.html)。**推荐使用源码构建方式以获取最新版本**\n\n2.启动 Server，进入解压后文件夹或编译打包好的文件夹，找到如下相对文件夹 nacos/bin，并对照操作系统实际情况之下如下命令。\n\n* Linux/Unix/Mac 操作系统，执行命令 `sh startup.sh -m standalone`\n\n* Windows 操作系统，执行命令 `cmd startup.cmd`\n\n<div align='center'><img src=\"1615625705374-a7db4ed1-7021-4e98-9eee-058ae34afd4d.png\" alt=\"image.png\" style=\"zoom:50%;\" /></div>\n\n### 三、微服务模块引入Nacos依赖\n\n​\t在Common模块修改 pom.xml 文件，引入 Nacos Discovery Starter，在第一步在Common模块已经引入，所以微服务模块不需要重复引入\n\n```\n<dependency>\n     <groupId>com.alibaba.cloud</groupId>\n     <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>\n </dependency>\n```\n\n\n\n### 四、微服务模块配置注册中心Nacos地址以及该微服务注册到注册中心的地址\n\n1.在微服务应用的 /src/main/resources/application.properties 配置文件中配置 Nacos Server 地址，\n\n此外还需要配置注册服务的名称，否则无法注册服务\n\n```properties\nspring.cloud.nacos.discovery.server-addr=127.0.0.1:8848\nspring.application.name=doermail-coupon\n```\n\n2.使用 @EnableDiscoveryClient 注解在微服务的启动类上开启服务注册与发现功能\n\n```java\n @SpringBootApplication\n @EnableDiscoveryClient //本微服务开启服务注册与发现\n public class ProviderApplication {\n    public static void main(String[] args) {\n        SpringApplication.run(ProviderApplication.class, args);\n    }\n }\n```\n\n3.启动该微服务，控制台就会出现如下，表示该微服务注册到了nacos中\n\n<div align='center'><img src=\"1615627294785-e203d13a-6656-44b9-b5e2-69f5a32017d1.png\" style=\"zoom:50%;\" /></div>\n\n4.浏览器访问nacos提供的可视化页面http://127.0.0.1:8848/nacos/,用户名和密码均为nacos\n\n就可以看到刚刚注册的微服务doermail-coupon，名称为我们指定的application-name\n\n<div align='center'><img src=\"1615627330848-e62fcb72-d405-48f1-8e27-0053b1fcf750.png\" alt=\"截屏2021-03-13 17.22.05.png\" style=\"zoom:50%;\" /></div>","source":"_posts/Nacos：如果注册服务（上）.md","raw":"---\ntitle: Nacos：如何注册服务（上）\ndate: 2021-3-14\ntags:\n\t- Nacos\ncategories:\n\t- SpringCloud\ntoc: true\n---\n\nSpringCloud-Alibaba-Nacos是阿里出品的一个服务发现与注册的组件，微服务需要调用其他微服务模块的服务或者微服务模块需要被其他模块调用，都需要到Nacos注册中心中注册该微服务模块\n\n**如何微服务模块注册到注册中心，主要是以下几个步骤**\n\n1.在微服务模块引入Nacos的依赖\n\n2.启动Nacos服务器\n\n3.微服务模块设置好注册中心的接口以及该微服务模块需要注册到服务中心的名称\n\n4.在启动类加入 @EnableDiscoveryClient 注解表示该服务注册到Nacos中\n\n<!--more-->\n\n### 一、引入Nacos依赖\n\n首先需要引入SpringCloud-Alibaba组件包，其中就有Nacos，由于我们每个微服务都需要将自身注册到注册中心以及发现要调用的服务地址，因此我们首先将SpringCloud-Alibaba组件包放置在Common通用模块下，然后Common模块引入Nacos依赖，然后下个每个微模块通过引用common模块来实现引入Common模块的Nacos依赖以及公共工具类、Bean等\n\nCommon模块--对应的Module为Maven\n\n```xml\n <?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n        <parent>\n        <artifactId>doermail</artifactId>\n        <groupId>com.lookstarry.doermail</groupId>\n        <version>0.0.1-SNAPSHOT</version>\n    </parent>\n    <modelVersion>4.0.0</modelVersion>\n\n    <artifactId>doermail-common</artifactId> \n\n  <!--所有微服务共同的依赖，注意这里的dependency不能有scope标签，这样其他微服务模块好像无法引入该依赖，要去掉</scope>标签-->\n  <dependencies>\n    <!--Nacos微服务发现与注册-->\n        <dependency>\n            <groupId>com.alibaba.cloud</groupId>\n            <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>\n        </dependency> \n    </dependencies>\n\n    <!--dependencyManagement含义表示依赖管理，\n    以后再dependencies中引入spring-cloud-alibaba依赖不需要指定版本号-->\n    <dependencyManagement>\n        <dependencies>\n            <dependency>\n                <groupId>com.alibaba.cloud</groupId>\n                <artifactId>spring-cloud-alibaba-dependencies</artifactId>\n                <version>2.1.0.RELEASE</version>\n                <type>pom</type>\n                <scope>import</scope>\n            </dependency>\n        </dependencies>\n    </dependencyManagement>\n```\n\n其他微服务模块如何引用Common模块下的依赖以及工具类呢？\n\n通过在其他模块的pom.xml中dependencies中引入Common模块的信息\n\n```xml\n       <dependency>\n            <groupId>com.lookstarry.doermail</groupId>\n            <artifactId>doermail-common</artifactId>\n            <version>0.0.1-SNAPSHOT</version>\n        </dependency>\n```\n\n这样其他微服务模块都能引入Common模块下nacos\n\n\n\n### 二、下载并启动 Nacos Server\n\n1.首先需要获取 Nacos Server，支持直接下载和源码构建两种方式。\n\n​\t直接下载：[Nacos Server 下载页](https://github.com/alibaba/nacos/releases)\n\n​    源码构建：进入 Nacos [Github 项目页面](https://github.com/alibaba/nacos)，将代码 git clone 到本地自行编译打包，[参考此文档](https://nacos.io/zh-cn/docs/quick-start.html)。**推荐使用源码构建方式以获取最新版本**\n\n2.启动 Server，进入解压后文件夹或编译打包好的文件夹，找到如下相对文件夹 nacos/bin，并对照操作系统实际情况之下如下命令。\n\n* Linux/Unix/Mac 操作系统，执行命令 `sh startup.sh -m standalone`\n\n* Windows 操作系统，执行命令 `cmd startup.cmd`\n\n<div align='center'><img src=\"1615625705374-a7db4ed1-7021-4e98-9eee-058ae34afd4d.png\" alt=\"image.png\" style=\"zoom:50%;\" /></div>\n\n### 三、微服务模块引入Nacos依赖\n\n​\t在Common模块修改 pom.xml 文件，引入 Nacos Discovery Starter，在第一步在Common模块已经引入，所以微服务模块不需要重复引入\n\n```\n<dependency>\n     <groupId>com.alibaba.cloud</groupId>\n     <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>\n </dependency>\n```\n\n\n\n### 四、微服务模块配置注册中心Nacos地址以及该微服务注册到注册中心的地址\n\n1.在微服务应用的 /src/main/resources/application.properties 配置文件中配置 Nacos Server 地址，\n\n此外还需要配置注册服务的名称，否则无法注册服务\n\n```properties\nspring.cloud.nacos.discovery.server-addr=127.0.0.1:8848\nspring.application.name=doermail-coupon\n```\n\n2.使用 @EnableDiscoveryClient 注解在微服务的启动类上开启服务注册与发现功能\n\n```java\n @SpringBootApplication\n @EnableDiscoveryClient //本微服务开启服务注册与发现\n public class ProviderApplication {\n    public static void main(String[] args) {\n        SpringApplication.run(ProviderApplication.class, args);\n    }\n }\n```\n\n3.启动该微服务，控制台就会出现如下，表示该微服务注册到了nacos中\n\n<div align='center'><img src=\"1615627294785-e203d13a-6656-44b9-b5e2-69f5a32017d1.png\" style=\"zoom:50%;\" /></div>\n\n4.浏览器访问nacos提供的可视化页面http://127.0.0.1:8848/nacos/,用户名和密码均为nacos\n\n就可以看到刚刚注册的微服务doermail-coupon，名称为我们指定的application-name\n\n<div align='center'><img src=\"1615627330848-e62fcb72-d405-48f1-8e27-0053b1fcf750.png\" alt=\"截屏2021-03-13 17.22.05.png\" style=\"zoom:50%;\" /></div>","slug":"Nacos：如果注册服务（上）","published":1,"updated":"2021-03-14T08:56:27.792Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl2enrqzg0009y2lo9umv6jcz","content":"<p>SpringCloud-Alibaba-Nacos是阿里出品的一个服务发现与注册的组件，微服务需要调用其他微服务模块的服务或者微服务模块需要被其他模块调用，都需要到Nacos注册中心中注册该微服务模块</p>\n<p><strong>如何微服务模块注册到注册中心，主要是以下几个步骤</strong></p>\n<p>1.在微服务模块引入Nacos的依赖</p>\n<p>2.启动Nacos服务器</p>\n<p>3.微服务模块设置好注册中心的接口以及该微服务模块需要注册到服务中心的名称</p>\n<p>4.在启动类加入 @EnableDiscoveryClient 注解表示该服务注册到Nacos中</p>\n<a id=\"more\"></a>\n\n<h3 id=\"一、引入Nacos依赖\"><a href=\"#一、引入Nacos依赖\" class=\"headerlink\" title=\"一、引入Nacos依赖\"></a>一、引入Nacos依赖</h3><p>首先需要引入SpringCloud-Alibaba组件包，其中就有Nacos，由于我们每个微服务都需要将自身注册到注册中心以及发现要调用的服务地址，因此我们首先将SpringCloud-Alibaba组件包放置在Common通用模块下，然后Common模块引入Nacos依赖，然后下个每个微模块通过引用common模块来实现引入Common模块的Nacos依赖以及公共工具类、Bean等</p>\n<p>Common模块–对应的Module为Maven</p>\n<pre><code class=\"xml\"> &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;\n         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;\n         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;\n        &lt;parent&gt;\n        &lt;artifactId&gt;doermail&lt;/artifactId&gt;\n        &lt;groupId&gt;com.lookstarry.doermail&lt;/groupId&gt;\n        &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;\n    &lt;/parent&gt;\n    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;\n\n    &lt;artifactId&gt;doermail-common&lt;/artifactId&gt; \n\n  &lt;!--所有微服务共同的依赖，注意这里的dependency不能有scope标签，这样其他微服务模块好像无法引入该依赖，要去掉&lt;/scope&gt;标签--&gt;\n  &lt;dependencies&gt;\n    &lt;!--Nacos微服务发现与注册--&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;\n        &lt;/dependency&gt; \n    &lt;/dependencies&gt;\n\n    &lt;!--dependencyManagement含义表示依赖管理，\n    以后再dependencies中引入spring-cloud-alibaba依赖不需要指定版本号--&gt;\n    &lt;dependencyManagement&gt;\n        &lt;dependencies&gt;\n            &lt;dependency&gt;\n                &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;\n                &lt;artifactId&gt;spring-cloud-alibaba-dependencies&lt;/artifactId&gt;\n                &lt;version&gt;2.1.0.RELEASE&lt;/version&gt;\n                &lt;type&gt;pom&lt;/type&gt;\n                &lt;scope&gt;import&lt;/scope&gt;\n            &lt;/dependency&gt;\n        &lt;/dependencies&gt;\n    &lt;/dependencyManagement&gt;\n</code></pre>\n<p>其他微服务模块如何引用Common模块下的依赖以及工具类呢？</p>\n<p>通过在其他模块的pom.xml中dependencies中引入Common模块的信息</p>\n<pre><code class=\"xml\">       &lt;dependency&gt;\n            &lt;groupId&gt;com.lookstarry.doermail&lt;/groupId&gt;\n            &lt;artifactId&gt;doermail-common&lt;/artifactId&gt;\n            &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;\n        &lt;/dependency&gt;\n</code></pre>\n<p>这样其他微服务模块都能引入Common模块下nacos</p>\n<h3 id=\"二、下载并启动-Nacos-Server\"><a href=\"#二、下载并启动-Nacos-Server\" class=\"headerlink\" title=\"二、下载并启动 Nacos Server\"></a>二、下载并启动 Nacos Server</h3><p>1.首先需要获取 Nacos Server，支持直接下载和源码构建两种方式。</p>\n<p>​    直接下载：<a href=\"https://github.com/alibaba/nacos/releases\">Nacos Server 下载页</a></p>\n<p>​    源码构建：进入 Nacos <a href=\"https://github.com/alibaba/nacos\">Github 项目页面</a>，将代码 git clone 到本地自行编译打包，<a href=\"https://nacos.io/zh-cn/docs/quick-start.html\">参考此文档</a>。<strong>推荐使用源码构建方式以获取最新版本</strong></p>\n<p>2.启动 Server，进入解压后文件夹或编译打包好的文件夹，找到如下相对文件夹 nacos/bin，并对照操作系统实际情况之下如下命令。</p>\n<ul>\n<li><p>Linux/Unix/Mac 操作系统，执行命令 <code>sh startup.sh -m standalone</code></p>\n</li>\n<li><p>Windows 操作系统，执行命令 <code>cmd startup.cmd</code></p>\n</li>\n</ul>\n<div align=\"center\"><img src=\"/2021/SpringCloud/Nacos%EF%BC%9A%E5%A6%82%E6%9E%9C%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1%EF%BC%88%E4%B8%8A%EF%BC%89/1615625705374-a7db4ed1-7021-4e98-9eee-058ae34afd4d.png\" alt=\"image.png\" style=\"zoom:50%;\"></div>\n\n<h3 id=\"三、微服务模块引入Nacos依赖\"><a href=\"#三、微服务模块引入Nacos依赖\" class=\"headerlink\" title=\"三、微服务模块引入Nacos依赖\"></a>三、微服务模块引入Nacos依赖</h3><p>​    在Common模块修改 pom.xml 文件，引入 Nacos Discovery Starter，在第一步在Common模块已经引入，所以微服务模块不需要重复引入</p>\n<pre><code>&lt;dependency&gt;\n     &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;\n     &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;\n &lt;/dependency&gt;\n</code></pre>\n<h3 id=\"四、微服务模块配置注册中心Nacos地址以及该微服务注册到注册中心的地址\"><a href=\"#四、微服务模块配置注册中心Nacos地址以及该微服务注册到注册中心的地址\" class=\"headerlink\" title=\"四、微服务模块配置注册中心Nacos地址以及该微服务注册到注册中心的地址\"></a>四、微服务模块配置注册中心Nacos地址以及该微服务注册到注册中心的地址</h3><p>1.在微服务应用的 /src/main/resources/application.properties 配置文件中配置 Nacos Server 地址，</p>\n<p>此外还需要配置注册服务的名称，否则无法注册服务</p>\n<pre><code class=\"properties\">spring.cloud.nacos.discovery.server-addr=127.0.0.1:8848\nspring.application.name=doermail-coupon\n</code></pre>\n<p>2.使用 @EnableDiscoveryClient 注解在微服务的启动类上开启服务注册与发现功能</p>\n<pre><code class=\"java\"> @SpringBootApplication\n @EnableDiscoveryClient //本微服务开启服务注册与发现\n public class ProviderApplication &#123;\n    public static void main(String[] args) &#123;\n        SpringApplication.run(ProviderApplication.class, args);\n    &#125;\n &#125;\n</code></pre>\n<p>3.启动该微服务，控制台就会出现如下，表示该微服务注册到了nacos中</p>\n<div align=\"center\"><img src=\"/2021/SpringCloud/Nacos%EF%BC%9A%E5%A6%82%E6%9E%9C%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1%EF%BC%88%E4%B8%8A%EF%BC%89/1615627294785-e203d13a-6656-44b9-b5e2-69f5a32017d1.png\" style=\"zoom:50%;\"></div>\n\n<p>4.浏览器访问nacos提供的可视化页面<a href=\"http://127.0.0.1:8848/nacos/,%E7%94%A8%E6%88%B7%E5%90%8D%E5%92%8C%E5%AF%86%E7%A0%81%E5%9D%87%E4%B8%BAnacos\">http://127.0.0.1:8848/nacos/,用户名和密码均为nacos</a></p>\n<p>就可以看到刚刚注册的微服务doermail-coupon，名称为我们指定的application-name</p>\n<div align=\"center\"><img src=\"/2021/SpringCloud/Nacos%EF%BC%9A%E5%A6%82%E6%9E%9C%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1%EF%BC%88%E4%B8%8A%EF%BC%89/1615627330848-e62fcb72-d405-48f1-8e27-0053b1fcf750.png\" alt=\"截屏2021-03-13 17.22.05.png\" style=\"zoom:50%;\"></div>","site":{"data":{"photography":[{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","title":"玉渊潭","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","title":"花儿","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","title":"白塔寺","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"}]}},"excerpt":"<p>SpringCloud-Alibaba-Nacos是阿里出品的一个服务发现与注册的组件，微服务需要调用其他微服务模块的服务或者微服务模块需要被其他模块调用，都需要到Nacos注册中心中注册该微服务模块</p>\n<p><strong>如何微服务模块注册到注册中心，主要是以下几个步骤</strong></p>\n<p>1.在微服务模块引入Nacos的依赖</p>\n<p>2.启动Nacos服务器</p>\n<p>3.微服务模块设置好注册中心的接口以及该微服务模块需要注册到服务中心的名称</p>\n<p>4.在启动类加入 @EnableDiscoveryClient 注解表示该服务注册到Nacos中</p>","more":"<h3 id=\"一、引入Nacos依赖\"><a href=\"#一、引入Nacos依赖\" class=\"headerlink\" title=\"一、引入Nacos依赖\"></a>一、引入Nacos依赖</h3><p>首先需要引入SpringCloud-Alibaba组件包，其中就有Nacos，由于我们每个微服务都需要将自身注册到注册中心以及发现要调用的服务地址，因此我们首先将SpringCloud-Alibaba组件包放置在Common通用模块下，然后Common模块引入Nacos依赖，然后下个每个微模块通过引用common模块来实现引入Common模块的Nacos依赖以及公共工具类、Bean等</p>\n<p>Common模块–对应的Module为Maven</p>\n<pre><code class=\"xml\"> &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;\n         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;\n         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;\n        &lt;parent&gt;\n        &lt;artifactId&gt;doermail&lt;/artifactId&gt;\n        &lt;groupId&gt;com.lookstarry.doermail&lt;/groupId&gt;\n        &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;\n    &lt;/parent&gt;\n    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;\n\n    &lt;artifactId&gt;doermail-common&lt;/artifactId&gt; \n\n  &lt;!--所有微服务共同的依赖，注意这里的dependency不能有scope标签，这样其他微服务模块好像无法引入该依赖，要去掉&lt;/scope&gt;标签--&gt;\n  &lt;dependencies&gt;\n    &lt;!--Nacos微服务发现与注册--&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;\n        &lt;/dependency&gt; \n    &lt;/dependencies&gt;\n\n    &lt;!--dependencyManagement含义表示依赖管理，\n    以后再dependencies中引入spring-cloud-alibaba依赖不需要指定版本号--&gt;\n    &lt;dependencyManagement&gt;\n        &lt;dependencies&gt;\n            &lt;dependency&gt;\n                &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;\n                &lt;artifactId&gt;spring-cloud-alibaba-dependencies&lt;/artifactId&gt;\n                &lt;version&gt;2.1.0.RELEASE&lt;/version&gt;\n                &lt;type&gt;pom&lt;/type&gt;\n                &lt;scope&gt;import&lt;/scope&gt;\n            &lt;/dependency&gt;\n        &lt;/dependencies&gt;\n    &lt;/dependencyManagement&gt;\n</code></pre>\n<p>其他微服务模块如何引用Common模块下的依赖以及工具类呢？</p>\n<p>通过在其他模块的pom.xml中dependencies中引入Common模块的信息</p>\n<pre><code class=\"xml\">       &lt;dependency&gt;\n            &lt;groupId&gt;com.lookstarry.doermail&lt;/groupId&gt;\n            &lt;artifactId&gt;doermail-common&lt;/artifactId&gt;\n            &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;\n        &lt;/dependency&gt;\n</code></pre>\n<p>这样其他微服务模块都能引入Common模块下nacos</p>\n<h3 id=\"二、下载并启动-Nacos-Server\"><a href=\"#二、下载并启动-Nacos-Server\" class=\"headerlink\" title=\"二、下载并启动 Nacos Server\"></a>二、下载并启动 Nacos Server</h3><p>1.首先需要获取 Nacos Server，支持直接下载和源码构建两种方式。</p>\n<p>​    直接下载：<a href=\"https://github.com/alibaba/nacos/releases\">Nacos Server 下载页</a></p>\n<p>​    源码构建：进入 Nacos <a href=\"https://github.com/alibaba/nacos\">Github 项目页面</a>，将代码 git clone 到本地自行编译打包，<a href=\"https://nacos.io/zh-cn/docs/quick-start.html\">参考此文档</a>。<strong>推荐使用源码构建方式以获取最新版本</strong></p>\n<p>2.启动 Server，进入解压后文件夹或编译打包好的文件夹，找到如下相对文件夹 nacos/bin，并对照操作系统实际情况之下如下命令。</p>\n<ul>\n<li><p>Linux/Unix/Mac 操作系统，执行命令 <code>sh startup.sh -m standalone</code></p>\n</li>\n<li><p>Windows 操作系统，执行命令 <code>cmd startup.cmd</code></p>\n</li>\n</ul>\n<div align=\"center\"><img src=\"/2021/SpringCloud/Nacos%EF%BC%9A%E5%A6%82%E6%9E%9C%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1%EF%BC%88%E4%B8%8A%EF%BC%89/1615625705374-a7db4ed1-7021-4e98-9eee-058ae34afd4d.png\" alt=\"image.png\" style=\"zoom:50%;\"></div>\n\n<h3 id=\"三、微服务模块引入Nacos依赖\"><a href=\"#三、微服务模块引入Nacos依赖\" class=\"headerlink\" title=\"三、微服务模块引入Nacos依赖\"></a>三、微服务模块引入Nacos依赖</h3><p>​    在Common模块修改 pom.xml 文件，引入 Nacos Discovery Starter，在第一步在Common模块已经引入，所以微服务模块不需要重复引入</p>\n<pre><code>&lt;dependency&gt;\n     &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;\n     &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;\n &lt;/dependency&gt;\n</code></pre>\n<h3 id=\"四、微服务模块配置注册中心Nacos地址以及该微服务注册到注册中心的地址\"><a href=\"#四、微服务模块配置注册中心Nacos地址以及该微服务注册到注册中心的地址\" class=\"headerlink\" title=\"四、微服务模块配置注册中心Nacos地址以及该微服务注册到注册中心的地址\"></a>四、微服务模块配置注册中心Nacos地址以及该微服务注册到注册中心的地址</h3><p>1.在微服务应用的 /src/main/resources/application.properties 配置文件中配置 Nacos Server 地址，</p>\n<p>此外还需要配置注册服务的名称，否则无法注册服务</p>\n<pre><code class=\"properties\">spring.cloud.nacos.discovery.server-addr=127.0.0.1:8848\nspring.application.name=doermail-coupon\n</code></pre>\n<p>2.使用 @EnableDiscoveryClient 注解在微服务的启动类上开启服务注册与发现功能</p>\n<pre><code class=\"java\"> @SpringBootApplication\n @EnableDiscoveryClient //本微服务开启服务注册与发现\n public class ProviderApplication &#123;\n    public static void main(String[] args) &#123;\n        SpringApplication.run(ProviderApplication.class, args);\n    &#125;\n &#125;\n</code></pre>\n<p>3.启动该微服务，控制台就会出现如下，表示该微服务注册到了nacos中</p>\n<div align=\"center\"><img src=\"/2021/SpringCloud/Nacos%EF%BC%9A%E5%A6%82%E6%9E%9C%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1%EF%BC%88%E4%B8%8A%EF%BC%89/1615627294785-e203d13a-6656-44b9-b5e2-69f5a32017d1.png\" style=\"zoom:50%;\"></div>\n\n<p>4.浏览器访问nacos提供的可视化页面<a href=\"http://127.0.0.1:8848/nacos/,%E7%94%A8%E6%88%B7%E5%90%8D%E5%92%8C%E5%AF%86%E7%A0%81%E5%9D%87%E4%B8%BAnacos\">http://127.0.0.1:8848/nacos/,用户名和密码均为nacos</a></p>\n<p>就可以看到刚刚注册的微服务doermail-coupon，名称为我们指定的application-name</p>\n<div align=\"center\"><img src=\"/2021/SpringCloud/Nacos%EF%BC%9A%E5%A6%82%E6%9E%9C%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1%EF%BC%88%E4%B8%8A%EF%BC%89/1615627330848-e62fcb72-d405-48f1-8e27-0053b1fcf750.png\" alt=\"截屏2021-03-13 17.22.05.png\" style=\"zoom:50%;\"></div>"},{"title":"Docker配置MYSQL集群(上)","date":"2021-01-27T02:41:35.000Z","toc":true,"_content":"利用Docker部署MYSQL集群，可以缓解服务器的压力，接下来一起来学习使用Docker部署MYSQL集群吧！\n### <span style=\"color:orange;\">1.MYSQL集群读写分离的原理知识</span>\n> MYSQL集群是为了减轻服务器负担，防止网站面对业务过多，达到数据库操作瓶颈，防止用户的数据没有及时的记录或修改造成损失，其中MYSQL集群的主要目的就是设立一个master节点，主要负责写，还有若干个salve节点，负责读，其中涉及到master、slave数据一致性的问题。\n\n<!--more-->\n\n#### <div align=center><img src=\"集群原理.png\" width=\"50%\" height=\"50%\" align=center/></div>\n\n#### 操作步骤\n\n1. 首先master在接收到上层的一个写请求，会将操作记录到一个二进制日志当中。在每个事务更新数据之前完成之前，master会将操作事务串行地写到二进制日志当中，操作事务写入到二进制日志完成之后，master会通知存储引擎提交事务，然后通知slave，这是master上的数据才会进行改动。（这里称对数据的一次操作称之为**一次二进制日志事件**，也就是binary log events)\n1. slave会将binary log events拷贝到它的中继日志当中。具体而言，slave会开启一个IO线程，在master上打开一个普通的连接，然后将binary log的变化拷贝到IO线程中，如果binary log没有变化，则会睡眠，并等待master产生一个新的时间，如果有变化，则会把变化部分从内存中拷贝到自己的日志中Replay log中\n1. slave重做中继日志事件，将Replay Log中的变化重新在slave做一遍，这里的SQL thread就是从Replay log中读取事件，并重放其中的事件，更新slave的数据，使其与master的数据保持一致\n\n**简单而言：就是master接收到写请求后，会将事务操作日志放入到二进制文件中，然后slave的IO thread会来读取Binary Log，将读取的内容写入到Replay Log，然后SQL Thread再重放事件，更新slave上的数据。**\n\n\n问：为什么IO thread读取到变化后不经过Replay Log直接重放更新到数据库中？\n> 因为计算机角度是需要队列进行的，由于网络原因，IO Thread不可能一次将变化部分全部读取到内存中，此外Slave自身可能还有自己读的业务正在进行，所以Replay Log相当于缓存好master的变化操作，然后进行重放。\n\n\n### <span style=\"color:orange;\">2. 配置MYSQL集群</span>\n\n经过上面介绍，核心就是Binary Log和Replay Log以及IO thread的配置，首先打开master上的Binary Log位置，然后slave打开自己的Replay Log，然后IO thread连接到master上的Binary Log\n\n#### 1.下载Docker，创建容器\n下载好后在终端中输入命令\n```bash\ndocker pull mysql  ###下载mysql\ndocker images   ###查看下载好的镜像，这里面的tag标签就是下面一行命令中mysql:后面所要填入的版本号\n###创建名字为master装载mysql镜像的容器，-d表示后台运行，-p表示端口，10001是宿主端口，3306是所创建容器slave-1的内部端口，其中涉及到内部端口到外部端口的映射，\n###其中外部端口号可以用来用Navicat连接master数据库，但是后面配置slave连接master仍然用的是3306容器内部的端口号\ndocker run --name master -p 10001:3306 -e MYSQL_ROOT_PASSWORD=make1234 -d mysql:latest  \ndocker run --name slave -p 10002:3306 -e MYSQL_ROOT_PASSWORD=make1234 -d mysql:latest  \ndocker container ps -a  ###列出所有容器\n```\n#### <div align=center><img src=\"镜像.png\" width=\"50%\" height=\"50%\" align=center/></div>\n<div align=center><img src=\"navicat.png\" width=\"50%\" height=\"50%\" align=center/></div>\n\n\n#### 2. 首先配置master，开启log-bin日志\n\n```bash\nsudo chmod 755 /etc/my.cnf ###给master的配置文件赋予超级管理员权限，否则会出现修改后无法保存已经文件的错误\nsudo vim /etc/my.cnf       ###超级管理员权限编辑my.cnf\n        添加上 log-bin=master-bin   ###打开master的binary log日志\n                    log-bin-index=master-bin.index\n          server-id=1\n        键入:wq保存退出\n sudo /usr/loca/mysql/support-files/mysql.server restart   ###重启mysql，让配置文件生效\n```\n修改完成后，进入mysql中，如果显示以下，则表明已经生效\n#### <div align=center><img src=\"master配置信息.png\" width=\"50%\" height=\"50%\" align=center/></div>\n<div align=center><img src=\"截屏2021-01-20 12.07.01.png\" width=\"50%\" height=\"50%\" align=center/></div>\n\n\n#### 3. 进入Docker中创建好的slave容器，开启relay-log日志\n\n```bash\ndocker exec -it slave bash\napt-get update  ###配置国内镜像源\napt-get install -y vim   ###在容器中安装vim\nfind / -name my.cnf ###查看容器下的my.cnf位置\nvim /etc/mysql/my.cnf\n        添加上server-id=3  ###这里的id千万不能与master的id重复，如果有其他slave也不能与之重复\n    replay-log=slave1-replay-bin\n    replay-log-index=slave1-replay-bin.index\n    etc + :wq保存退出\nexit; ###退出容器\ndocker restart slave ###重启slave容器，让修改配置生效\ndocker exec -it slave bash ###进入容器\n\n### 如果这时执行docker exec -it slave-1 bash 会显示container is not running，因为docker此时容器已经退出，无法再继续进行\n###迂回方法：如果无法启动主线程，可以使用commit方法将该镜像放入到一个新的容器中，然后执行\n###方法在下面第三张图片中\n# yizhichangyuan @ yizhichangyuandeMacBook-Pro in ~ [14:32:34]\n$ docker exec -it slave bash\nError response from daemon: Container 895994c73c773b9e58ec3b87e6d4e04dad66ae5376f88b1ee134079bd064dcba is not running\n# yizhichangyuan @ yizhichangyuandeMacBook-Pro in ~ [14:32:45] C:1\n$ docker commit 895994c73c77\nsha256:f5baa2c4fff010c9ea90c324e5ae2a174fd6a62b0e2a50e0126be439c4d82293\n# yizhichangyuan @ yizhichangyuandeMacBook-Pro in ~ [14:32:57]\n$ docker run -it f5baa2c4fff010c9ea90 bash\n```\n<div align=center><img src=\"截屏2021-01-20 14.30.05.png\" width=\"50%\" height=\"50%\" align=center/></div>\n<div align=center><img src=\"截屏2021-01-20 23.26.12.png\" width=\"50%\" height=\"50%\" align=center/></div>\n\n\n\n#### 4. master上创建slave节点来进行访问的通道\n\n```bash\ndocker inspect master --format '{{.NetworkSettings.IPAddress}}' #查看master的ip，这里为172.17.0.2\ndocker inspect slave --format '{{.NetworkSettings.IPAddress}}' #查看slave的ip，这里为172.17.0.3\ndocker exec -it master bash  # 进入master容器\nmysql -uroot -pmake1234   #进入master的mysql \n# 在master上创建一个名为repl的用户，ip地址为slave的ip{172.17.0.3}，密码验证方式为mysql_native_password，密码为mysql\n# 这里相当于在master上开了一个给slave访问的通道，然后slave通过repl这个用户可以访问到master的日志\ncreate user repl@'172.17.0.3' identified with ‘mysql_native_password’ by 'mysql';\n# 给ip为172.17.0.3名为repl的用户进行授权，授权访问的范围为*.*，前面一个*表示所有数据库，后面的*表示所有的表，访问权限为salve备份的权限\n# 这里的slave有特定含义，表示从节点的含义，不是指的容器slave的名字\n# 如果指定只能访问某个数据库{database}，可以改为{database}.*\ngrant replication slave on *.* to repl@'172.17.0.3';\nflush privileges; # 刷新写入权限\nshow master staus;\n```\n<div align=center><img src=\"截屏2021-01-20 23.33.11.png\" width=\"50%\" height=\"50%\" align=center/></div>\n\n\n#### 5.slave节点连接到master所给的通道上\n```bash\ndocker exec -it slave bash  #进入slave容器\nmysql -uroot -pmake1234  #进入slave-mysql\nstop slave;\n# 这里的端口master_port一定得是容器内部的端口，而不是宿主的端口10001，否则会报错，其中master_log_pos从0开始，\n#表示将数据库鬼过去所有的改变都扒到数据库slave上，这指定为0在slave宕机恢复很有作用，如果为其他，表示从那个时间点之后的变化恢复到salve上\nchange master to master_host='172.17.0.2',master_port=3306,master_user='repl',\nmaster_password='mysql',master_log_file='master-bin.000001’, master_log_pos=0;\nstart salve;\nshow slave status\\G;\n```\n> 命令说明：\n> master_host：Master 的地址，指的是容器的独立 ip, 可以通过 docker inspect \n> --format='{{NetworkSettings.IPAddress}}' 容器名称 | 容器 id 查询容器的 ip\n> master_port：Master 的端口号，指的是容器的端口号\n> master_user：用于数据同步的用户\n> master_password：用于同步的用户的密码\n> master_log_file：指定 Slave 从哪个日志文件开始复制数据，即上文中提到的 File 字段的值\n> master_log_pos：从哪个 Position 开始读，即上文中提到的 Position 字段的值\n> 转自链接：[https://learnku.com/articles/30439](https://learnku.com/articles/30439)\n<div align=center><img src=\"截屏2021-01-20 23.46.48.png\" width=\"50%\" height=\"50%\" align=center/></div>\n\n\n### <span style=\"color:orange;\">3.向Docker容器导入Sql文件</span>\n```bash\ndocker cp path1 container:path2\n```\n其中path1是要导入容器的Sql文件路径，path2是存放到容器中的位置，container为容器名称，导入到哪个容器中\n<div align=center><img src=\"截屏2021-01-23 21.59.27.png\" width=\"50%\" height=\"50%\" align=center/></div>\n\n\n### <span style=\"color:orange;\">4.报错处理</span>\n\n- 如果show slave status\\G中显示为access denied，则\n   - 可能是change master指定的master_port是映射宿主的端口造成的（这里为10001），改为端口号为容器内部端口号3306\n   - 还要一种原因是，你使用的master是使用的本地的mysql，而不是docker中部署的mysql，因为本地localhost是没有公网ip的，所以本地mysql默认只能通过本地localhost或127.0.0.1链接，不能用IP链接，**也就不能允许其他机器链接本机的mysql**\n\n- show slave status\\G中显示的为caching_sha2_password的错误，则为密码验证方式的问题\n   1. 首先在master中改变验证方式\n```bash\nALTER USER 'repl'@'172.17.0.3' IDENTIFIED WITH mysql_native_password  BY 'mysql';\nflush privileges;\nshow master status; #重新查看master的状态，因为其中的File和Position已经改变\n```\n<div align=center><img src=\"截屏2021-01-20 23.58.28.png\" width=\"50%\" height=\"50%\" align=center/></div>\n\n   1. 在slave中重新change master，注意其中的master_log_file和master_log_pos已经改变了\n   1. 如果上述还不行，则在salve的my.cnf添加如下一句话，同时重新change master（注意其中master_log_file和master_log_pos已经改变）\n```bash\ndefault_authentication_plugin=mysql_native_password\n```\n<div align=center><img src=\"image.png\" width=\"50%\" height=\"50%\" align=center/></div>\n","source":"_posts/docker配置MYSQL集群(上).md","raw":"---\ntitle: Docker配置MYSQL集群(上)\ndate: 2021-01-27 10:41:35\ntags:\n    - Docker\n    - MYSQL集群\ncategories:\n    - Spring\ntoc: true\n---\n利用Docker部署MYSQL集群，可以缓解服务器的压力，接下来一起来学习使用Docker部署MYSQL集群吧！\n### <span style=\"color:orange;\">1.MYSQL集群读写分离的原理知识</span>\n> MYSQL集群是为了减轻服务器负担，防止网站面对业务过多，达到数据库操作瓶颈，防止用户的数据没有及时的记录或修改造成损失，其中MYSQL集群的主要目的就是设立一个master节点，主要负责写，还有若干个salve节点，负责读，其中涉及到master、slave数据一致性的问题。\n\n<!--more-->\n\n#### <div align=center><img src=\"集群原理.png\" width=\"50%\" height=\"50%\" align=center/></div>\n\n#### 操作步骤\n\n1. 首先master在接收到上层的一个写请求，会将操作记录到一个二进制日志当中。在每个事务更新数据之前完成之前，master会将操作事务串行地写到二进制日志当中，操作事务写入到二进制日志完成之后，master会通知存储引擎提交事务，然后通知slave，这是master上的数据才会进行改动。（这里称对数据的一次操作称之为**一次二进制日志事件**，也就是binary log events)\n1. slave会将binary log events拷贝到它的中继日志当中。具体而言，slave会开启一个IO线程，在master上打开一个普通的连接，然后将binary log的变化拷贝到IO线程中，如果binary log没有变化，则会睡眠，并等待master产生一个新的时间，如果有变化，则会把变化部分从内存中拷贝到自己的日志中Replay log中\n1. slave重做中继日志事件，将Replay Log中的变化重新在slave做一遍，这里的SQL thread就是从Replay log中读取事件，并重放其中的事件，更新slave的数据，使其与master的数据保持一致\n\n**简单而言：就是master接收到写请求后，会将事务操作日志放入到二进制文件中，然后slave的IO thread会来读取Binary Log，将读取的内容写入到Replay Log，然后SQL Thread再重放事件，更新slave上的数据。**\n\n\n问：为什么IO thread读取到变化后不经过Replay Log直接重放更新到数据库中？\n> 因为计算机角度是需要队列进行的，由于网络原因，IO Thread不可能一次将变化部分全部读取到内存中，此外Slave自身可能还有自己读的业务正在进行，所以Replay Log相当于缓存好master的变化操作，然后进行重放。\n\n\n### <span style=\"color:orange;\">2. 配置MYSQL集群</span>\n\n经过上面介绍，核心就是Binary Log和Replay Log以及IO thread的配置，首先打开master上的Binary Log位置，然后slave打开自己的Replay Log，然后IO thread连接到master上的Binary Log\n\n#### 1.下载Docker，创建容器\n下载好后在终端中输入命令\n```bash\ndocker pull mysql  ###下载mysql\ndocker images   ###查看下载好的镜像，这里面的tag标签就是下面一行命令中mysql:后面所要填入的版本号\n###创建名字为master装载mysql镜像的容器，-d表示后台运行，-p表示端口，10001是宿主端口，3306是所创建容器slave-1的内部端口，其中涉及到内部端口到外部端口的映射，\n###其中外部端口号可以用来用Navicat连接master数据库，但是后面配置slave连接master仍然用的是3306容器内部的端口号\ndocker run --name master -p 10001:3306 -e MYSQL_ROOT_PASSWORD=make1234 -d mysql:latest  \ndocker run --name slave -p 10002:3306 -e MYSQL_ROOT_PASSWORD=make1234 -d mysql:latest  \ndocker container ps -a  ###列出所有容器\n```\n#### <div align=center><img src=\"镜像.png\" width=\"50%\" height=\"50%\" align=center/></div>\n<div align=center><img src=\"navicat.png\" width=\"50%\" height=\"50%\" align=center/></div>\n\n\n#### 2. 首先配置master，开启log-bin日志\n\n```bash\nsudo chmod 755 /etc/my.cnf ###给master的配置文件赋予超级管理员权限，否则会出现修改后无法保存已经文件的错误\nsudo vim /etc/my.cnf       ###超级管理员权限编辑my.cnf\n        添加上 log-bin=master-bin   ###打开master的binary log日志\n                    log-bin-index=master-bin.index\n          server-id=1\n        键入:wq保存退出\n sudo /usr/loca/mysql/support-files/mysql.server restart   ###重启mysql，让配置文件生效\n```\n修改完成后，进入mysql中，如果显示以下，则表明已经生效\n#### <div align=center><img src=\"master配置信息.png\" width=\"50%\" height=\"50%\" align=center/></div>\n<div align=center><img src=\"截屏2021-01-20 12.07.01.png\" width=\"50%\" height=\"50%\" align=center/></div>\n\n\n#### 3. 进入Docker中创建好的slave容器，开启relay-log日志\n\n```bash\ndocker exec -it slave bash\napt-get update  ###配置国内镜像源\napt-get install -y vim   ###在容器中安装vim\nfind / -name my.cnf ###查看容器下的my.cnf位置\nvim /etc/mysql/my.cnf\n        添加上server-id=3  ###这里的id千万不能与master的id重复，如果有其他slave也不能与之重复\n    replay-log=slave1-replay-bin\n    replay-log-index=slave1-replay-bin.index\n    etc + :wq保存退出\nexit; ###退出容器\ndocker restart slave ###重启slave容器，让修改配置生效\ndocker exec -it slave bash ###进入容器\n\n### 如果这时执行docker exec -it slave-1 bash 会显示container is not running，因为docker此时容器已经退出，无法再继续进行\n###迂回方法：如果无法启动主线程，可以使用commit方法将该镜像放入到一个新的容器中，然后执行\n###方法在下面第三张图片中\n# yizhichangyuan @ yizhichangyuandeMacBook-Pro in ~ [14:32:34]\n$ docker exec -it slave bash\nError response from daemon: Container 895994c73c773b9e58ec3b87e6d4e04dad66ae5376f88b1ee134079bd064dcba is not running\n# yizhichangyuan @ yizhichangyuandeMacBook-Pro in ~ [14:32:45] C:1\n$ docker commit 895994c73c77\nsha256:f5baa2c4fff010c9ea90c324e5ae2a174fd6a62b0e2a50e0126be439c4d82293\n# yizhichangyuan @ yizhichangyuandeMacBook-Pro in ~ [14:32:57]\n$ docker run -it f5baa2c4fff010c9ea90 bash\n```\n<div align=center><img src=\"截屏2021-01-20 14.30.05.png\" width=\"50%\" height=\"50%\" align=center/></div>\n<div align=center><img src=\"截屏2021-01-20 23.26.12.png\" width=\"50%\" height=\"50%\" align=center/></div>\n\n\n\n#### 4. master上创建slave节点来进行访问的通道\n\n```bash\ndocker inspect master --format '{{.NetworkSettings.IPAddress}}' #查看master的ip，这里为172.17.0.2\ndocker inspect slave --format '{{.NetworkSettings.IPAddress}}' #查看slave的ip，这里为172.17.0.3\ndocker exec -it master bash  # 进入master容器\nmysql -uroot -pmake1234   #进入master的mysql \n# 在master上创建一个名为repl的用户，ip地址为slave的ip{172.17.0.3}，密码验证方式为mysql_native_password，密码为mysql\n# 这里相当于在master上开了一个给slave访问的通道，然后slave通过repl这个用户可以访问到master的日志\ncreate user repl@'172.17.0.3' identified with ‘mysql_native_password’ by 'mysql';\n# 给ip为172.17.0.3名为repl的用户进行授权，授权访问的范围为*.*，前面一个*表示所有数据库，后面的*表示所有的表，访问权限为salve备份的权限\n# 这里的slave有特定含义，表示从节点的含义，不是指的容器slave的名字\n# 如果指定只能访问某个数据库{database}，可以改为{database}.*\ngrant replication slave on *.* to repl@'172.17.0.3';\nflush privileges; # 刷新写入权限\nshow master staus;\n```\n<div align=center><img src=\"截屏2021-01-20 23.33.11.png\" width=\"50%\" height=\"50%\" align=center/></div>\n\n\n#### 5.slave节点连接到master所给的通道上\n```bash\ndocker exec -it slave bash  #进入slave容器\nmysql -uroot -pmake1234  #进入slave-mysql\nstop slave;\n# 这里的端口master_port一定得是容器内部的端口，而不是宿主的端口10001，否则会报错，其中master_log_pos从0开始，\n#表示将数据库鬼过去所有的改变都扒到数据库slave上，这指定为0在slave宕机恢复很有作用，如果为其他，表示从那个时间点之后的变化恢复到salve上\nchange master to master_host='172.17.0.2',master_port=3306,master_user='repl',\nmaster_password='mysql',master_log_file='master-bin.000001’, master_log_pos=0;\nstart salve;\nshow slave status\\G;\n```\n> 命令说明：\n> master_host：Master 的地址，指的是容器的独立 ip, 可以通过 docker inspect \n> --format='{{NetworkSettings.IPAddress}}' 容器名称 | 容器 id 查询容器的 ip\n> master_port：Master 的端口号，指的是容器的端口号\n> master_user：用于数据同步的用户\n> master_password：用于同步的用户的密码\n> master_log_file：指定 Slave 从哪个日志文件开始复制数据，即上文中提到的 File 字段的值\n> master_log_pos：从哪个 Position 开始读，即上文中提到的 Position 字段的值\n> 转自链接：[https://learnku.com/articles/30439](https://learnku.com/articles/30439)\n<div align=center><img src=\"截屏2021-01-20 23.46.48.png\" width=\"50%\" height=\"50%\" align=center/></div>\n\n\n### <span style=\"color:orange;\">3.向Docker容器导入Sql文件</span>\n```bash\ndocker cp path1 container:path2\n```\n其中path1是要导入容器的Sql文件路径，path2是存放到容器中的位置，container为容器名称，导入到哪个容器中\n<div align=center><img src=\"截屏2021-01-23 21.59.27.png\" width=\"50%\" height=\"50%\" align=center/></div>\n\n\n### <span style=\"color:orange;\">4.报错处理</span>\n\n- 如果show slave status\\G中显示为access denied，则\n   - 可能是change master指定的master_port是映射宿主的端口造成的（这里为10001），改为端口号为容器内部端口号3306\n   - 还要一种原因是，你使用的master是使用的本地的mysql，而不是docker中部署的mysql，因为本地localhost是没有公网ip的，所以本地mysql默认只能通过本地localhost或127.0.0.1链接，不能用IP链接，**也就不能允许其他机器链接本机的mysql**\n\n- show slave status\\G中显示的为caching_sha2_password的错误，则为密码验证方式的问题\n   1. 首先在master中改变验证方式\n```bash\nALTER USER 'repl'@'172.17.0.3' IDENTIFIED WITH mysql_native_password  BY 'mysql';\nflush privileges;\nshow master status; #重新查看master的状态，因为其中的File和Position已经改变\n```\n<div align=center><img src=\"截屏2021-01-20 23.58.28.png\" width=\"50%\" height=\"50%\" align=center/></div>\n\n   1. 在slave中重新change master，注意其中的master_log_file和master_log_pos已经改变了\n   1. 如果上述还不行，则在salve的my.cnf添加如下一句话，同时重新change master（注意其中master_log_file和master_log_pos已经改变）\n```bash\ndefault_authentication_plugin=mysql_native_password\n```\n<div align=center><img src=\"image.png\" width=\"50%\" height=\"50%\" align=center/></div>\n","slug":"docker配置MYSQL集群(上)","published":1,"updated":"2021-01-30T05:58:58.785Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl2enrqzh000by2loaogoaeaz","content":"<p>利用Docker部署MYSQL集群，可以缓解服务器的压力，接下来一起来学习使用Docker部署MYSQL集群吧！</p>\n<h3 id=\"1-MYSQL集群读写分离的原理知识\"><a href=\"#1-MYSQL集群读写分离的原理知识\" class=\"headerlink\" title=\"1.MYSQL集群读写分离的原理知识\"></a><span style=\"color:orange;\">1.MYSQL集群读写分离的原理知识</span></h3><blockquote>\n<p>MYSQL集群是为了减轻服务器负担，防止网站面对业务过多，达到数据库操作瓶颈，防止用户的数据没有及时的记录或修改造成损失，其中MYSQL集群的主要目的就是设立一个master节点，主要负责写，还有若干个salve节点，负责读，其中涉及到master、slave数据一致性的问题。</p>\n</blockquote>\n<a id=\"more\"></a>\n\n<h4 id><a href=\"#\" class=\"headerlink\" title></a><div align=\"center\"><img src=\"/2021/Spring/docker%E9%85%8D%E7%BD%AEMYSQL%E9%9B%86%E7%BE%A4(%E4%B8%8A)/集群原理.png\" width=\"50%\" height=\"50%\" align=\"center/\"></div></h4><h4 id=\"操作步骤\"><a href=\"#操作步骤\" class=\"headerlink\" title=\"操作步骤\"></a>操作步骤</h4><ol>\n<li>首先master在接收到上层的一个写请求，会将操作记录到一个二进制日志当中。在每个事务更新数据之前完成之前，master会将操作事务串行地写到二进制日志当中，操作事务写入到二进制日志完成之后，master会通知存储引擎提交事务，然后通知slave，这是master上的数据才会进行改动。（这里称对数据的一次操作称之为<strong>一次二进制日志事件</strong>，也就是binary log events)</li>\n<li>slave会将binary log events拷贝到它的中继日志当中。具体而言，slave会开启一个IO线程，在master上打开一个普通的连接，然后将binary log的变化拷贝到IO线程中，如果binary log没有变化，则会睡眠，并等待master产生一个新的时间，如果有变化，则会把变化部分从内存中拷贝到自己的日志中Replay log中</li>\n<li>slave重做中继日志事件，将Replay Log中的变化重新在slave做一遍，这里的SQL thread就是从Replay log中读取事件，并重放其中的事件，更新slave的数据，使其与master的数据保持一致</li>\n</ol>\n<p><strong>简单而言：就是master接收到写请求后，会将事务操作日志放入到二进制文件中，然后slave的IO thread会来读取Binary Log，将读取的内容写入到Replay Log，然后SQL Thread再重放事件，更新slave上的数据。</strong></p>\n<p>问：为什么IO thread读取到变化后不经过Replay Log直接重放更新到数据库中？</p>\n<blockquote>\n<p>因为计算机角度是需要队列进行的，由于网络原因，IO Thread不可能一次将变化部分全部读取到内存中，此外Slave自身可能还有自己读的业务正在进行，所以Replay Log相当于缓存好master的变化操作，然后进行重放。</p>\n</blockquote>\n<h3 id=\"2-配置MYSQL集群\"><a href=\"#2-配置MYSQL集群\" class=\"headerlink\" title=\"2. 配置MYSQL集群\"></a><span style=\"color:orange;\">2. 配置MYSQL集群</span></h3><p>经过上面介绍，核心就是Binary Log和Replay Log以及IO thread的配置，首先打开master上的Binary Log位置，然后slave打开自己的Replay Log，然后IO thread连接到master上的Binary Log</p>\n<h4 id=\"1-下载Docker，创建容器\"><a href=\"#1-下载Docker，创建容器\" class=\"headerlink\" title=\"1.下载Docker，创建容器\"></a>1.下载Docker，创建容器</h4><p>下载好后在终端中输入命令</p>\n<pre><code class=\"bash\">docker pull mysql  ###下载mysql\ndocker images   ###查看下载好的镜像，这里面的tag标签就是下面一行命令中mysql:后面所要填入的版本号\n###创建名字为master装载mysql镜像的容器，-d表示后台运行，-p表示端口，10001是宿主端口，3306是所创建容器slave-1的内部端口，其中涉及到内部端口到外部端口的映射，\n###其中外部端口号可以用来用Navicat连接master数据库，但是后面配置slave连接master仍然用的是3306容器内部的端口号\ndocker run --name master -p 10001:3306 -e MYSQL_ROOT_PASSWORD=make1234 -d mysql:latest  \ndocker run --name slave -p 10002:3306 -e MYSQL_ROOT_PASSWORD=make1234 -d mysql:latest  \ndocker container ps -a  ###列出所有容器\n</code></pre>\n<h4 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title></a><div align=\"center\"><img src=\"/2021/Spring/docker%E9%85%8D%E7%BD%AEMYSQL%E9%9B%86%E7%BE%A4(%E4%B8%8A)/镜像.png\" width=\"50%\" height=\"50%\" align=\"center/\"></div></h4><div align=\"center\"><img src=\"/2021/Spring/docker%E9%85%8D%E7%BD%AEMYSQL%E9%9B%86%E7%BE%A4(%E4%B8%8A)/navicat.png\" width=\"50%\" height=\"50%\" align=\"center/\"></div>\n\n\n<h4 id=\"2-首先配置master，开启log-bin日志\"><a href=\"#2-首先配置master，开启log-bin日志\" class=\"headerlink\" title=\"2. 首先配置master，开启log-bin日志\"></a>2. 首先配置master，开启log-bin日志</h4><pre><code class=\"bash\">sudo chmod 755 /etc/my.cnf ###给master的配置文件赋予超级管理员权限，否则会出现修改后无法保存已经文件的错误\nsudo vim /etc/my.cnf       ###超级管理员权限编辑my.cnf\n        添加上 log-bin=master-bin   ###打开master的binary log日志\n                    log-bin-index=master-bin.index\n          server-id=1\n        键入:wq保存退出\n sudo /usr/loca/mysql/support-files/mysql.server restart   ###重启mysql，让配置文件生效\n</code></pre>\n<p>修改完成后，进入mysql中，如果显示以下，则表明已经生效</p>\n<h4 id=\"-2\"><a href=\"#-2\" class=\"headerlink\" title></a><div align=\"center\"><img src=\"/2021/Spring/docker%E9%85%8D%E7%BD%AEMYSQL%E9%9B%86%E7%BE%A4(%E4%B8%8A)/master配置信息.png\" width=\"50%\" height=\"50%\" align=\"center/\"></div></h4><div align=\"center\"><img src=\"/2021/Spring/docker%E9%85%8D%E7%BD%AEMYSQL%E9%9B%86%E7%BE%A4(%E4%B8%8A)/截屏2021-01-20 12.07.01.png\" width=\"50%\" height=\"50%\" align=\"center/\"></div>\n\n\n<h4 id=\"3-进入Docker中创建好的slave容器，开启relay-log日志\"><a href=\"#3-进入Docker中创建好的slave容器，开启relay-log日志\" class=\"headerlink\" title=\"3. 进入Docker中创建好的slave容器，开启relay-log日志\"></a>3. 进入Docker中创建好的slave容器，开启relay-log日志</h4><pre><code class=\"bash\">docker exec -it slave bash\napt-get update  ###配置国内镜像源\napt-get install -y vim   ###在容器中安装vim\nfind / -name my.cnf ###查看容器下的my.cnf位置\nvim /etc/mysql/my.cnf\n        添加上server-id=3  ###这里的id千万不能与master的id重复，如果有其他slave也不能与之重复\n    replay-log=slave1-replay-bin\n    replay-log-index=slave1-replay-bin.index\n    etc + :wq保存退出\nexit; ###退出容器\ndocker restart slave ###重启slave容器，让修改配置生效\ndocker exec -it slave bash ###进入容器\n\n### 如果这时执行docker exec -it slave-1 bash 会显示container is not running，因为docker此时容器已经退出，无法再继续进行\n###迂回方法：如果无法启动主线程，可以使用commit方法将该镜像放入到一个新的容器中，然后执行\n###方法在下面第三张图片中\n# yizhichangyuan @ yizhichangyuandeMacBook-Pro in ~ [14:32:34]\n$ docker exec -it slave bash\nError response from daemon: Container 895994c73c773b9e58ec3b87e6d4e04dad66ae5376f88b1ee134079bd064dcba is not running\n# yizhichangyuan @ yizhichangyuandeMacBook-Pro in ~ [14:32:45] C:1\n$ docker commit 895994c73c77\nsha256:f5baa2c4fff010c9ea90c324e5ae2a174fd6a62b0e2a50e0126be439c4d82293\n# yizhichangyuan @ yizhichangyuandeMacBook-Pro in ~ [14:32:57]\n$ docker run -it f5baa2c4fff010c9ea90 bash\n</code></pre>\n<div align=\"center\"><img src=\"/2021/Spring/docker%E9%85%8D%E7%BD%AEMYSQL%E9%9B%86%E7%BE%A4(%E4%B8%8A)/截屏2021-01-20 14.30.05.png\" width=\"50%\" height=\"50%\" align=\"center/\"></div>\n<div align=\"center\"><img src=\"/2021/Spring/docker%E9%85%8D%E7%BD%AEMYSQL%E9%9B%86%E7%BE%A4(%E4%B8%8A)/截屏2021-01-20 23.26.12.png\" width=\"50%\" height=\"50%\" align=\"center/\"></div>\n\n\n\n<h4 id=\"4-master上创建slave节点来进行访问的通道\"><a href=\"#4-master上创建slave节点来进行访问的通道\" class=\"headerlink\" title=\"4. master上创建slave节点来进行访问的通道\"></a>4. master上创建slave节点来进行访问的通道</h4><pre><code class=\"bash\">docker inspect master --format &#39;&#123;&#123;.NetworkSettings.IPAddress&#125;&#125;&#39; #查看master的ip，这里为172.17.0.2\ndocker inspect slave --format &#39;&#123;&#123;.NetworkSettings.IPAddress&#125;&#125;&#39; #查看slave的ip，这里为172.17.0.3\ndocker exec -it master bash  # 进入master容器\nmysql -uroot -pmake1234   #进入master的mysql \n# 在master上创建一个名为repl的用户，ip地址为slave的ip&#123;172.17.0.3&#125;，密码验证方式为mysql_native_password，密码为mysql\n# 这里相当于在master上开了一个给slave访问的通道，然后slave通过repl这个用户可以访问到master的日志\ncreate user repl@&#39;172.17.0.3&#39; identified with ‘mysql_native_password’ by &#39;mysql&#39;;\n# 给ip为172.17.0.3名为repl的用户进行授权，授权访问的范围为*.*，前面一个*表示所有数据库，后面的*表示所有的表，访问权限为salve备份的权限\n# 这里的slave有特定含义，表示从节点的含义，不是指的容器slave的名字\n# 如果指定只能访问某个数据库&#123;database&#125;，可以改为&#123;database&#125;.*\ngrant replication slave on *.* to repl@&#39;172.17.0.3&#39;;\nflush privileges; # 刷新写入权限\nshow master staus;\n</code></pre>\n<div align=\"center\"><img src=\"/2021/Spring/docker%E9%85%8D%E7%BD%AEMYSQL%E9%9B%86%E7%BE%A4(%E4%B8%8A)/截屏2021-01-20 23.33.11.png\" width=\"50%\" height=\"50%\" align=\"center/\"></div>\n\n\n<h4 id=\"5-slave节点连接到master所给的通道上\"><a href=\"#5-slave节点连接到master所给的通道上\" class=\"headerlink\" title=\"5.slave节点连接到master所给的通道上\"></a>5.slave节点连接到master所给的通道上</h4><pre><code class=\"bash\">docker exec -it slave bash  #进入slave容器\nmysql -uroot -pmake1234  #进入slave-mysql\nstop slave;\n# 这里的端口master_port一定得是容器内部的端口，而不是宿主的端口10001，否则会报错，其中master_log_pos从0开始，\n#表示将数据库鬼过去所有的改变都扒到数据库slave上，这指定为0在slave宕机恢复很有作用，如果为其他，表示从那个时间点之后的变化恢复到salve上\nchange master to master_host=&#39;172.17.0.2&#39;,master_port=3306,master_user=&#39;repl&#39;,\nmaster_password=&#39;mysql&#39;,master_log_file=&#39;master-bin.000001’, master_log_pos=0;\nstart salve;\nshow slave status\\G;\n</code></pre>\n<blockquote>\n<p>命令说明：<br>master_host：Master 的地址，指的是容器的独立 ip, 可以通过 docker inspect<br>–format=’‘ 容器名称 | 容器 id 查询容器的 ip<br>master_port：Master 的端口号，指的是容器的端口号<br>master_user：用于数据同步的用户<br>master_password：用于同步的用户的密码<br>master_log_file：指定 Slave 从哪个日志文件开始复制数据，即上文中提到的 File 字段的值<br>master_log_pos：从哪个 Position 开始读，即上文中提到的 Position 字段的值<br>转自链接：<a href=\"https://learnku.com/articles/30439\">https://learnku.com/articles/30439</a></p>\n</blockquote>\n<div align=\"center\"><img src=\"/2021/Spring/docker%E9%85%8D%E7%BD%AEMYSQL%E9%9B%86%E7%BE%A4(%E4%B8%8A)/截屏2021-01-20 23.46.48.png\" width=\"50%\" height=\"50%\" align=\"center/\"></div>\n\n\n<h3 id=\"3-向Docker容器导入Sql文件\"><a href=\"#3-向Docker容器导入Sql文件\" class=\"headerlink\" title=\"3.向Docker容器导入Sql文件\"></a><span style=\"color:orange;\">3.向Docker容器导入Sql文件</span></h3><pre><code class=\"bash\">docker cp path1 container:path2\n</code></pre>\n<p>其中path1是要导入容器的Sql文件路径，path2是存放到容器中的位置，container为容器名称，导入到哪个容器中</p>\n<div align=\"center\"><img src=\"/2021/Spring/docker%E9%85%8D%E7%BD%AEMYSQL%E9%9B%86%E7%BE%A4(%E4%B8%8A)/截屏2021-01-23 21.59.27.png\" width=\"50%\" height=\"50%\" align=\"center/\"></div>\n\n\n<h3 id=\"4-报错处理\"><a href=\"#4-报错处理\" class=\"headerlink\" title=\"4.报错处理\"></a><span style=\"color:orange;\">4.报错处理</span></h3><ul>\n<li><p>如果show slave status\\G中显示为access denied，则</p>\n<ul>\n<li>可能是change master指定的master_port是映射宿主的端口造成的（这里为10001），改为端口号为容器内部端口号3306</li>\n<li>还要一种原因是，你使用的master是使用的本地的mysql，而不是docker中部署的mysql，因为本地localhost是没有公网ip的，所以本地mysql默认只能通过本地localhost或127.0.0.1链接，不能用IP链接，<strong>也就不能允许其他机器链接本机的mysql</strong></li>\n</ul>\n</li>\n<li><p>show slave status\\G中显示的为caching_sha2_password的错误，则为密码验证方式的问题</p>\n<ol>\n<li><p>首先在master中改变验证方式</p>\n<pre><code class=\"bash\">ALTER USER &#39;repl&#39;@&#39;172.17.0.3&#39; IDENTIFIED WITH mysql_native_password  BY &#39;mysql&#39;;\nflush privileges;\nshow master status; #重新查看master的状态，因为其中的File和Position已经改变\n</code></pre>\n<div align=\"center\"><img src=\"/2021/Spring/docker%E9%85%8D%E7%BD%AEMYSQL%E9%9B%86%E7%BE%A4(%E4%B8%8A)/截屏2021-01-20 23.58.28.png\" width=\"50%\" height=\"50%\" align=\"center/\"></div>\n</li>\n<li><p>在slave中重新change master，注意其中的master_log_file和master_log_pos已经改变了</p>\n</li>\n<li><p>如果上述还不行，则在salve的my.cnf添加如下一句话，同时重新change master（注意其中master_log_file和master_log_pos已经改变）</p>\n<pre><code class=\"bash\">default_authentication_plugin=mysql_native_password\n</code></pre>\n<div align=\"center\"><img src=\"/2021/Spring/docker%E9%85%8D%E7%BD%AEMYSQL%E9%9B%86%E7%BE%A4(%E4%B8%8A)/image.png\" width=\"50%\" height=\"50%\" align=\"center/\"></div>\n</li>\n</ol>\n</li>\n</ul>\n","site":{"data":{"photography":[{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","title":"玉渊潭","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","title":"花儿","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","title":"白塔寺","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"}]}},"excerpt":"<p>利用Docker部署MYSQL集群，可以缓解服务器的压力，接下来一起来学习使用Docker部署MYSQL集群吧！</p>\n<h3 id=\"1-MYSQL集群读写分离的原理知识\"><a href=\"#1-MYSQL集群读写分离的原理知识\" class=\"headerlink\" title=\"1.MYSQL集群读写分离的原理知识\"></a><span style=\"color:orange;\">1.MYSQL集群读写分离的原理知识</span></h3><blockquote>\n<p>MYSQL集群是为了减轻服务器负担，防止网站面对业务过多，达到数据库操作瓶颈，防止用户的数据没有及时的记录或修改造成损失，其中MYSQL集群的主要目的就是设立一个master节点，主要负责写，还有若干个salve节点，负责读，其中涉及到master、slave数据一致性的问题。</p>\n</blockquote>","more":"<h4 id><a href=\"#\" class=\"headerlink\" title></a><div align=\"center\"><img src=\"/2021/Spring/docker%E9%85%8D%E7%BD%AEMYSQL%E9%9B%86%E7%BE%A4(%E4%B8%8A)/集群原理.png\" width=\"50%\" height=\"50%\" align=\"center/\"></div></h4><h4 id=\"操作步骤\"><a href=\"#操作步骤\" class=\"headerlink\" title=\"操作步骤\"></a>操作步骤</h4><ol>\n<li>首先master在接收到上层的一个写请求，会将操作记录到一个二进制日志当中。在每个事务更新数据之前完成之前，master会将操作事务串行地写到二进制日志当中，操作事务写入到二进制日志完成之后，master会通知存储引擎提交事务，然后通知slave，这是master上的数据才会进行改动。（这里称对数据的一次操作称之为<strong>一次二进制日志事件</strong>，也就是binary log events)</li>\n<li>slave会将binary log events拷贝到它的中继日志当中。具体而言，slave会开启一个IO线程，在master上打开一个普通的连接，然后将binary log的变化拷贝到IO线程中，如果binary log没有变化，则会睡眠，并等待master产生一个新的时间，如果有变化，则会把变化部分从内存中拷贝到自己的日志中Replay log中</li>\n<li>slave重做中继日志事件，将Replay Log中的变化重新在slave做一遍，这里的SQL thread就是从Replay log中读取事件，并重放其中的事件，更新slave的数据，使其与master的数据保持一致</li>\n</ol>\n<p><strong>简单而言：就是master接收到写请求后，会将事务操作日志放入到二进制文件中，然后slave的IO thread会来读取Binary Log，将读取的内容写入到Replay Log，然后SQL Thread再重放事件，更新slave上的数据。</strong></p>\n<p>问：为什么IO thread读取到变化后不经过Replay Log直接重放更新到数据库中？</p>\n<blockquote>\n<p>因为计算机角度是需要队列进行的，由于网络原因，IO Thread不可能一次将变化部分全部读取到内存中，此外Slave自身可能还有自己读的业务正在进行，所以Replay Log相当于缓存好master的变化操作，然后进行重放。</p>\n</blockquote>\n<h3 id=\"2-配置MYSQL集群\"><a href=\"#2-配置MYSQL集群\" class=\"headerlink\" title=\"2. 配置MYSQL集群\"></a><span style=\"color:orange;\">2. 配置MYSQL集群</span></h3><p>经过上面介绍，核心就是Binary Log和Replay Log以及IO thread的配置，首先打开master上的Binary Log位置，然后slave打开自己的Replay Log，然后IO thread连接到master上的Binary Log</p>\n<h4 id=\"1-下载Docker，创建容器\"><a href=\"#1-下载Docker，创建容器\" class=\"headerlink\" title=\"1.下载Docker，创建容器\"></a>1.下载Docker，创建容器</h4><p>下载好后在终端中输入命令</p>\n<pre><code class=\"bash\">docker pull mysql  ###下载mysql\ndocker images   ###查看下载好的镜像，这里面的tag标签就是下面一行命令中mysql:后面所要填入的版本号\n###创建名字为master装载mysql镜像的容器，-d表示后台运行，-p表示端口，10001是宿主端口，3306是所创建容器slave-1的内部端口，其中涉及到内部端口到外部端口的映射，\n###其中外部端口号可以用来用Navicat连接master数据库，但是后面配置slave连接master仍然用的是3306容器内部的端口号\ndocker run --name master -p 10001:3306 -e MYSQL_ROOT_PASSWORD=make1234 -d mysql:latest  \ndocker run --name slave -p 10002:3306 -e MYSQL_ROOT_PASSWORD=make1234 -d mysql:latest  \ndocker container ps -a  ###列出所有容器\n</code></pre>\n<h4 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title></a><div align=\"center\"><img src=\"/2021/Spring/docker%E9%85%8D%E7%BD%AEMYSQL%E9%9B%86%E7%BE%A4(%E4%B8%8A)/镜像.png\" width=\"50%\" height=\"50%\" align=\"center/\"></div></h4><div align=\"center\"><img src=\"/2021/Spring/docker%E9%85%8D%E7%BD%AEMYSQL%E9%9B%86%E7%BE%A4(%E4%B8%8A)/navicat.png\" width=\"50%\" height=\"50%\" align=\"center/\"></div>\n\n\n<h4 id=\"2-首先配置master，开启log-bin日志\"><a href=\"#2-首先配置master，开启log-bin日志\" class=\"headerlink\" title=\"2. 首先配置master，开启log-bin日志\"></a>2. 首先配置master，开启log-bin日志</h4><pre><code class=\"bash\">sudo chmod 755 /etc/my.cnf ###给master的配置文件赋予超级管理员权限，否则会出现修改后无法保存已经文件的错误\nsudo vim /etc/my.cnf       ###超级管理员权限编辑my.cnf\n        添加上 log-bin=master-bin   ###打开master的binary log日志\n                    log-bin-index=master-bin.index\n          server-id=1\n        键入:wq保存退出\n sudo /usr/loca/mysql/support-files/mysql.server restart   ###重启mysql，让配置文件生效\n</code></pre>\n<p>修改完成后，进入mysql中，如果显示以下，则表明已经生效</p>\n<h4 id=\"-2\"><a href=\"#-2\" class=\"headerlink\" title></a><div align=\"center\"><img src=\"/2021/Spring/docker%E9%85%8D%E7%BD%AEMYSQL%E9%9B%86%E7%BE%A4(%E4%B8%8A)/master配置信息.png\" width=\"50%\" height=\"50%\" align=\"center/\"></div></h4><div align=\"center\"><img src=\"/2021/Spring/docker%E9%85%8D%E7%BD%AEMYSQL%E9%9B%86%E7%BE%A4(%E4%B8%8A)/截屏2021-01-20 12.07.01.png\" width=\"50%\" height=\"50%\" align=\"center/\"></div>\n\n\n<h4 id=\"3-进入Docker中创建好的slave容器，开启relay-log日志\"><a href=\"#3-进入Docker中创建好的slave容器，开启relay-log日志\" class=\"headerlink\" title=\"3. 进入Docker中创建好的slave容器，开启relay-log日志\"></a>3. 进入Docker中创建好的slave容器，开启relay-log日志</h4><pre><code class=\"bash\">docker exec -it slave bash\napt-get update  ###配置国内镜像源\napt-get install -y vim   ###在容器中安装vim\nfind / -name my.cnf ###查看容器下的my.cnf位置\nvim /etc/mysql/my.cnf\n        添加上server-id=3  ###这里的id千万不能与master的id重复，如果有其他slave也不能与之重复\n    replay-log=slave1-replay-bin\n    replay-log-index=slave1-replay-bin.index\n    etc + :wq保存退出\nexit; ###退出容器\ndocker restart slave ###重启slave容器，让修改配置生效\ndocker exec -it slave bash ###进入容器\n\n### 如果这时执行docker exec -it slave-1 bash 会显示container is not running，因为docker此时容器已经退出，无法再继续进行\n###迂回方法：如果无法启动主线程，可以使用commit方法将该镜像放入到一个新的容器中，然后执行\n###方法在下面第三张图片中\n# yizhichangyuan @ yizhichangyuandeMacBook-Pro in ~ [14:32:34]\n$ docker exec -it slave bash\nError response from daemon: Container 895994c73c773b9e58ec3b87e6d4e04dad66ae5376f88b1ee134079bd064dcba is not running\n# yizhichangyuan @ yizhichangyuandeMacBook-Pro in ~ [14:32:45] C:1\n$ docker commit 895994c73c77\nsha256:f5baa2c4fff010c9ea90c324e5ae2a174fd6a62b0e2a50e0126be439c4d82293\n# yizhichangyuan @ yizhichangyuandeMacBook-Pro in ~ [14:32:57]\n$ docker run -it f5baa2c4fff010c9ea90 bash\n</code></pre>\n<div align=\"center\"><img src=\"/2021/Spring/docker%E9%85%8D%E7%BD%AEMYSQL%E9%9B%86%E7%BE%A4(%E4%B8%8A)/截屏2021-01-20 14.30.05.png\" width=\"50%\" height=\"50%\" align=\"center/\"></div>\n<div align=\"center\"><img src=\"/2021/Spring/docker%E9%85%8D%E7%BD%AEMYSQL%E9%9B%86%E7%BE%A4(%E4%B8%8A)/截屏2021-01-20 23.26.12.png\" width=\"50%\" height=\"50%\" align=\"center/\"></div>\n\n\n\n<h4 id=\"4-master上创建slave节点来进行访问的通道\"><a href=\"#4-master上创建slave节点来进行访问的通道\" class=\"headerlink\" title=\"4. master上创建slave节点来进行访问的通道\"></a>4. master上创建slave节点来进行访问的通道</h4><pre><code class=\"bash\">docker inspect master --format &#39;&#123;&#123;.NetworkSettings.IPAddress&#125;&#125;&#39; #查看master的ip，这里为172.17.0.2\ndocker inspect slave --format &#39;&#123;&#123;.NetworkSettings.IPAddress&#125;&#125;&#39; #查看slave的ip，这里为172.17.0.3\ndocker exec -it master bash  # 进入master容器\nmysql -uroot -pmake1234   #进入master的mysql \n# 在master上创建一个名为repl的用户，ip地址为slave的ip&#123;172.17.0.3&#125;，密码验证方式为mysql_native_password，密码为mysql\n# 这里相当于在master上开了一个给slave访问的通道，然后slave通过repl这个用户可以访问到master的日志\ncreate user repl@&#39;172.17.0.3&#39; identified with ‘mysql_native_password’ by &#39;mysql&#39;;\n# 给ip为172.17.0.3名为repl的用户进行授权，授权访问的范围为*.*，前面一个*表示所有数据库，后面的*表示所有的表，访问权限为salve备份的权限\n# 这里的slave有特定含义，表示从节点的含义，不是指的容器slave的名字\n# 如果指定只能访问某个数据库&#123;database&#125;，可以改为&#123;database&#125;.*\ngrant replication slave on *.* to repl@&#39;172.17.0.3&#39;;\nflush privileges; # 刷新写入权限\nshow master staus;\n</code></pre>\n<div align=\"center\"><img src=\"/2021/Spring/docker%E9%85%8D%E7%BD%AEMYSQL%E9%9B%86%E7%BE%A4(%E4%B8%8A)/截屏2021-01-20 23.33.11.png\" width=\"50%\" height=\"50%\" align=\"center/\"></div>\n\n\n<h4 id=\"5-slave节点连接到master所给的通道上\"><a href=\"#5-slave节点连接到master所给的通道上\" class=\"headerlink\" title=\"5.slave节点连接到master所给的通道上\"></a>5.slave节点连接到master所给的通道上</h4><pre><code class=\"bash\">docker exec -it slave bash  #进入slave容器\nmysql -uroot -pmake1234  #进入slave-mysql\nstop slave;\n# 这里的端口master_port一定得是容器内部的端口，而不是宿主的端口10001，否则会报错，其中master_log_pos从0开始，\n#表示将数据库鬼过去所有的改变都扒到数据库slave上，这指定为0在slave宕机恢复很有作用，如果为其他，表示从那个时间点之后的变化恢复到salve上\nchange master to master_host=&#39;172.17.0.2&#39;,master_port=3306,master_user=&#39;repl&#39;,\nmaster_password=&#39;mysql&#39;,master_log_file=&#39;master-bin.000001’, master_log_pos=0;\nstart salve;\nshow slave status\\G;\n</code></pre>\n<blockquote>\n<p>命令说明：<br>master_host：Master 的地址，指的是容器的独立 ip, 可以通过 docker inspect<br>–format=’‘ 容器名称 | 容器 id 查询容器的 ip<br>master_port：Master 的端口号，指的是容器的端口号<br>master_user：用于数据同步的用户<br>master_password：用于同步的用户的密码<br>master_log_file：指定 Slave 从哪个日志文件开始复制数据，即上文中提到的 File 字段的值<br>master_log_pos：从哪个 Position 开始读，即上文中提到的 Position 字段的值<br>转自链接：<a href=\"https://learnku.com/articles/30439\">https://learnku.com/articles/30439</a></p>\n</blockquote>\n<div align=\"center\"><img src=\"/2021/Spring/docker%E9%85%8D%E7%BD%AEMYSQL%E9%9B%86%E7%BE%A4(%E4%B8%8A)/截屏2021-01-20 23.46.48.png\" width=\"50%\" height=\"50%\" align=\"center/\"></div>\n\n\n<h3 id=\"3-向Docker容器导入Sql文件\"><a href=\"#3-向Docker容器导入Sql文件\" class=\"headerlink\" title=\"3.向Docker容器导入Sql文件\"></a><span style=\"color:orange;\">3.向Docker容器导入Sql文件</span></h3><pre><code class=\"bash\">docker cp path1 container:path2\n</code></pre>\n<p>其中path1是要导入容器的Sql文件路径，path2是存放到容器中的位置，container为容器名称，导入到哪个容器中</p>\n<div align=\"center\"><img src=\"/2021/Spring/docker%E9%85%8D%E7%BD%AEMYSQL%E9%9B%86%E7%BE%A4(%E4%B8%8A)/截屏2021-01-23 21.59.27.png\" width=\"50%\" height=\"50%\" align=\"center/\"></div>\n\n\n<h3 id=\"4-报错处理\"><a href=\"#4-报错处理\" class=\"headerlink\" title=\"4.报错处理\"></a><span style=\"color:orange;\">4.报错处理</span></h3><ul>\n<li><p>如果show slave status\\G中显示为access denied，则</p>\n<ul>\n<li>可能是change master指定的master_port是映射宿主的端口造成的（这里为10001），改为端口号为容器内部端口号3306</li>\n<li>还要一种原因是，你使用的master是使用的本地的mysql，而不是docker中部署的mysql，因为本地localhost是没有公网ip的，所以本地mysql默认只能通过本地localhost或127.0.0.1链接，不能用IP链接，<strong>也就不能允许其他机器链接本机的mysql</strong></li>\n</ul>\n</li>\n<li><p>show slave status\\G中显示的为caching_sha2_password的错误，则为密码验证方式的问题</p>\n<ol>\n<li><p>首先在master中改变验证方式</p>\n<pre><code class=\"bash\">ALTER USER &#39;repl&#39;@&#39;172.17.0.3&#39; IDENTIFIED WITH mysql_native_password  BY &#39;mysql&#39;;\nflush privileges;\nshow master status; #重新查看master的状态，因为其中的File和Position已经改变\n</code></pre>\n<div align=\"center\"><img src=\"/2021/Spring/docker%E9%85%8D%E7%BD%AEMYSQL%E9%9B%86%E7%BE%A4(%E4%B8%8A)/截屏2021-01-20 23.58.28.png\" width=\"50%\" height=\"50%\" align=\"center/\"></div>\n</li>\n<li><p>在slave中重新change master，注意其中的master_log_file和master_log_pos已经改变了</p>\n</li>\n<li><p>如果上述还不行，则在salve的my.cnf添加如下一句话，同时重新change master（注意其中master_log_file和master_log_pos已经改变）</p>\n<pre><code class=\"bash\">default_authentication_plugin=mysql_native_password\n</code></pre>\n<div align=\"center\"><img src=\"/2021/Spring/docker%E9%85%8D%E7%BD%AEMYSQL%E9%9B%86%E7%BE%A4(%E4%B8%8A)/image.png\" width=\"50%\" height=\"50%\" align=\"center/\"></div>\n</li>\n</ol>\n</li>\n</ul>"},{"title":"Mybatis复杂mapper映射出现Expected one result (or null) to be returned by selectOne(), but found:6","date":"2021-01-31T16:00:00.000Z","_content":"\n> 今天在项目使用mybatis写映射文件时，做测试发现报错`Expected one result (or null) to be returned by selectOne(), but found: 6`，下面记录一下解决的过程：\n\n![image.png](1612149739610-d371499a-4d5a-4ba7-9b0d-8f9b8bc133ec.png)\n### <font color=\"orange\">1. 问题介绍：</font>\n<!--more-->\n<font size=3>**对应的表关联关系如下：**</font>\n\n#### <img src=\"1612149616517-3d3f353b-1319-4315-a12a-3592c873810c.png\" alt=\"image.png\" style=\"zoom:50%;\" />\n\n其中tb_product与tb_product_img是一对多的关系，外键关联为product_id字段，其他表之间是一一对应关系，关联外键如表中灰色字段所示。\n\n<font size=3>**dao层接口：**</font>\n\n通过给定的productId查询出该product的信息，包括商品的所在分类，商品所属店铺信息，以及商品的详情图（一对多）\n```java\nProduct getProductById(long productId);\n```\n<font size=3>**实体类对象：**</font>\n\n```java\npublic class Product {\n    private Long productId;\n    private String productName;\n    private String productDesc;\n    private String imgAddr; //简略图\n    private String normalPrice; //日常价格\n    private String promotionPrice; //促销价格\n    private List<ProductImg> productImgList; //商品详情图列表\n    private ProductCategory productCategory;\n    private Shop shop;\n    // 管理信息\n    private Integer priority;\n    private Date createTime;\n    private Date lastEditTime;\n    private Integer enableStatus; //商品状态，0表示下架不可用，1表示上架\n}\npublic class ProductImg {\n    private Long productImgId;\n    private String imgAddr;\n    private String imgDesc;\n    private Integer priority;\n    private Date createTime;\n    private Long productId;\n}\npublic class ProductCategory {\n    private Long productCategoryId;\n    private Long shopId; // 查询商品类别时，不太需要Shop实体类对，所以这里使用ShopId\n    private String productCategoryName;\n    private Integer priority;\n    private Date createTime;\n}\npublic class Shop {\n    private Long shopId;\n    // 店铺基本信息\n    private String shopName;\n    private String shopDesc;\n    private String shopAddr;\n    private String phone;\n    private String shopImg;\n    // 管理信息\n    private Integer priority;\n    private Date createTime;\n    private Date lastEditTime;\n    private Integer enableStatus; //-1：不可用，0：审核中 1：可用\n    private String advice; //超级管理员给店家的提醒\n    // 外键信息\n    private Area area; //外键区域id\n    private ShopCategory shopCategory; //外键类别id\n    private PersonInfo owner; //店家\n}\npublic class PersonInfo {\n    private Long userId; //用户id，用Long表示\n    private String name;\n    private String profileImg;\n    private String email;\n    private String gender;\n    private Integer enableStatus; //用户状态，标识是否黑名单\n    private Integer userType; //1顾客 2店家 3超级管理员\n    private Date createTime;\n    private Date lastEditTime;\n}\n```\n<font size=3>**对应的mapper映射文件文件：**</font>\n\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE mapper\n        PUBLIC \"-//mybatis.org/DTD Mapper 3.0//EN\"\n        \"http://mybatis.org/dtd/mybatis-3-mapper.dtd\">\n<mapper namespace=\"com.imooc.o2o.dao.ProductDao\">\n  \t<!--对于冲突名称使用SQL中指定的别名，对于owner_id指定为owner.userId，意思为shop中名为owner的属性，对owner中的userId进行设置字段owner_id的值-->\n    <resultMap id=\"productMap\" type=\"com.imooc.o2o.entity.Product\">\n        <id property=\"productId\" column=\"product_id\"/>\n        <result property=\"productName\" column=\"product_name\"/>\n        <result property=\"productDesc\" column=\"product_desc\"/>\n        <result property=\"imgAddr\" column=\"img_addr\"/>\n        <result property=\"normalPrice\" column=\"normal_price\"/>\n        <result property=\"promotionPrice\" column=\"promotion_price\"/>\n        <result property=\"priority\" column=\"product_priority\"/>\n        <result property=\"createTime\" column=\"product_create_time\"/>\n        <result property=\"lastEditTime\" column=\"product_last_edit_time\"/>\n        <result property=\"enableStatus\" column=\"product_enable_status\"/>\n        <association property=\"productCategory\" javaType=\"com.imooc.o2o.entity.ProductCategory\">\n            <id property=\"productCategoryId\" column=\"product_category_id\"/>\n            <result property=\"productCategoryName\" column=\"product_category_name\"/>\n            <result property=\"priority\" column=\"product_category_priority\"/>\n            <result property=\"createTime\" column=\"product_category_create_time\"/>\n            <result property=\"shopId\" column=\"product_category_shop_id\"/>\n        </association>\n        <association property=\"shop\" javaType=\"com.imooc.o2o.entity.Shop\">\n            <id property=\"shopId\" column=\"shop_id\"/>\n            <result property=\"owner.userId\" column=\"owner_id\"/>\n            <result column=\"shop_name\" property=\"shopName\" />\n            <result column=\"shop_desc\" property=\"shopDesc\" />\n            <result column=\"shop_addr\" property=\"shopAddr\" />\n            <result column=\"phone\" property=\"phone\" />\n            <result column=\"shop_img\" property=\"shopImg\" />\n            <result column=\"shop_priority\" property=\"priority\" />\n            <result column=\"shop_create_time\" property=\"createTime\" />\n            <result column=\"last_edit_time\" property=\"lastEditTime\" />\n            <result column=\"shop_enable_status\" property=\"enableStatus\" />\n            <result column=\"advice\" property=\"advice\" />\n        </association>\n        <collection property=\"productImgList\" ofType=\"com.imooc.o2o.entity.ProductImg\">\n            <id property=\"product_img_id\" column=\"productImgId\"/>\n            <result property=\"imgAddr\" column=\"img_addr\"/>\n            <result property=\"priority\" column=\"priority\"/>\n            <result property=\"createTime\" column=\"product_img_create_time\"/>\n        </collection>\n    </resultMap>\n\n  \t<!--SQL中使用as对冲突名进行重命名-->\n    <select id=\"getProductById\" resultMap=\"productMap\">\n        select p.product_name,p.product_desc,p.img_addr,p.normal_price,p.priority,p.create_time as product_create_time,\n               p.last_edit_time as product_last_edit_time,p.enable_status as product_enable_status,\n               pc.product_category_id,pc.product_category_name,pc.priority as product_category_id,pc.create_time as product_category_create_time,\n               pc.shop_id as product_category_shop_id,\n               s.shop_id,s.shop_name,s.shop_desc,s.phone,s.create_time as shop_create_time,s.owner_Id,pi.product_img_id,pi.priority,pi.img_addr,pi.img_desc,pi.create_time as product_img_create_time\n               from tb_product p,tb_product_category as pc,tb_shop as s,tb_product_img as pi where\n               p.product_category_id = pc.product_category_id and p.shop_id = s.shop_id and p.product_id = pi.product_img_id\n               and p.product_id = #{productId};\n    </select>\n</mapper>\n```\n\n<font size=3>**对应SQL在数据库中查询结果**：</font>\n\n![image.png](1612150436476-e7e658e8-81a4-4292-9b5b-9c00ab6b823f.png)\n\n上述可以看见product中包含了三个实体类对象：ProductCategory，Shop，List\\<ProductImg\\>，而Shop中又有owner实体对象，如果根据一个product_id找到相应的product，要求有实体类对象ProductCategory，Shop，List\\<ProductImg\\>，同时Shop属性中还需要有Owner实体类，应该怎么做？\n\n\n\n### <font color=\"orange\">2. 错误分析：</font>\n\n**1. 首先查询的SQL语句有很多重名字段，例如priority在好几个类里面都有，lastEditTime也同样如此，如何区分字段并把查询出来的字段这些分配到正确的属性中去呢？**\n\n解决办法：在SQL语句中使用AS关键词来给有冲突的列名进行重新命名，同时在ResultMap中写入的Column就是重新命名过的名字，不这样做会造成mybatis遇到重名不知道怎么放，可能会造成查询的lastEditTime是一致的\n\n**2. 查询Shop表中有owner_id字段，查询的时候如何给复杂属性导航，给product的成员变量shop对象中的Owner成员变量设置userId呢？**\n\n通过查阅官方文档的方法：映射到复杂对象的嵌套属性时，可以使用点式分隔方法进行复杂属性的导航，这里就可以使用owner.userId来进行复杂导航\n![image.png](1612109243469-4d89a31b-0d9d-487e-bfed-faf3497e774e.png)\n\n**3. <font color=\"red\"><u>查询Product对象中有productImgList属性，是一个list，如何把SQL查出来多条结果的属于同一个ProductId的ProductImg放入到List中呢？</u></font>**\n\n- 如果`collection`中没有指定`column`字段，那么会默认通过resultMap的`id`标签来判断（这里的id就是product_id）查询的多条结果，如果查询多条结果的product_id是相同的，那么应该放入到List\\<ProductImg\\>中，Product不会增加；如果查询的product_id是不同的，那么就会返回多条结果，这里应该就返回List\\<Product\\>\n- 如果`collection`标签通过指定`column`为product_id或者shop_id（只要是数据库多条结果中有一个字段是相同可以归类为相同就行），mybatis会知道根据column给定的product_id检索SQL查询出来的多条结果，如果多条结果的product_id是一样的，那么查询出来的多条结果中应该放入到List\\<ProductImg\\>中，Product不会增加），如果不指定column字段并且查询结果中也没有指定的id标签字段（这里为product_id），那么查询出来的多条结果中不会放入到List\\<ProductImg\\>中，而是返回多条语句的查询结果List\\<Product\\>，而dao层接口接收的返回对象只有Product，这就是出现了`Expected one result (or null) to be returned by selectOne(), but found: 6`的原因。\n\n> 根据作者本人的解释, MyBatis为了降低内存开销,采用ResultHandler逐行读取的JDBC ResultSet结果集的,这就会造成MyBatis在结果行返回的时候无法判断以后的是否还会有这个id的行返回,所以它采用了一个方法来判断当前id的结果行是否已经读取完成,从而将其加入结果集List,这个方法是:\n>\n> 1.读取当前行记录A,将A加入自定义Cache类,同时读取下一行记录B\n>\n> 2.使用下一行记录B的id列和值为key(这个key由resultMap的\\<id\\>标签列定义)去Cache类里获取记录\n>\n> 3.假如使用B的key不能够获取到记录,则说明B的id与A不同,那么B将被加入到List（所以这里应该会返回List\\<Product>\\，出现报错）\n>\n> 4.假如使用B的key可以获取到记录,说明A与B的id相同,则会将A与B合并(相当于将两个productImg合并到一个List中,而product本身并不会增加)\n>\n> 5.将B定为当前行,同时读取下一行C,重复1-5,直到没有下一行记录\n>\n> 6.当没有下一行记录的时候,将最后一个合并的resultMap对应的java对象加入到List(最后一个被合并goodsImg的Goods)\n> 所以\n>   a. 当结果行是乱序的,例如BBAB这样的顺序,在记录行A遇到一个id不同的曾经出现过的记录行B时, A将不会被加入到List里(因为Cache里已经存在B的id为key的cahce了)\n>   b. 当结果是顺序时,则结果集不会有任何问题,因为 记录行 A 不可能 遇到一个曾经出现过的 记录行B, 所以记录行A不会被忽略,每次遇到新行B时,都不可能使用B的key去Cache里取到值,所以A必然可以被加入到List\n\n在Mybatis中代码如下：\n\n```java\n@Override\n  protected void handleRowValues(ResultSet rs, ResultMap resultMap, ResultHandler resultHandler, RowBounds rowBounds, ResultColumnCache resultColumnCache) throws SQLException {\n    final DefaultResultContext resultContext = new DefaultResultContext();\n    skipRows(rs, rowBounds);\n    Object rowValue = null;\n    while (shouldProcessMoreRows(rs, resultContext, rowBounds)) {\n      final ResultMap discriminatedResultMap = resolveDiscriminatedResultMap(rs, resultMap, null);\n      // 下一记录行的id构成的cache key\n      final CacheKey rowKey = createRowKey(discriminatedResultMap, rs, null, resultColumnCache);\n      Object partialObject = objectCache.get(rowKey);\n      // 判断下一记录行是否被记录与cache中,如果不在cache中则将该记录行的对象插入List\n      if (partialObject == null && rowValue != null) { // issue #542 delay calling ResultHandler until object \n        if (mappedStatement.isResultOrdered()) objectCache.clear(); // issue #577 clear memory if ordered\n        callResultHandler(resultHandler, resultContext, rowValue);\n      } \n      // 当前记录行的值\n      rowValue = getRowValue(rs, discriminatedResultMap, rowKey, rowKey, null, resultColumnCache, partialObject);\n    }\n    // 插入最后一记录行的对象到List\n    if (rowValue != null) callResultHandler(resultHandler, resultContext, rowValue);\n  }\n```\n\n### <font color=\"orange\">3. 解决</font>\n\n通过上述分析，知道了问题所在，select标签中SQL语句既没有查询对应的product的id标签字段product_id也没有在collection中通过显式地指定column字段表明应该根据什么字段将多条查询结果应该归为到一个List\\<ProductImg\\>中，而不是List\\<Product\\>中\n\n提供一下两种解决办法（二者选其一）：\n\na. 在select标签中加入id标签的字段product_id\n\n```SQl\nselect p.product_id,p.product_name,p.product_desc,.......\n```\n\nb. 在collection中指定column字段（采用可以表示为多条结果相同归类即可，这里可以采用shop_id或者product_id，不能采用produt_img_id）\n\n```java\n <collection property=\"productImgList\" column='product_id'ofType=\"com.imooc.o2o.entity.ProductImg\">\n```\n\n\n\n### <font color=\"orange\">4.总结</font>\n\n利用collection进行一对多关系查询时，要么SQL中select出resultMap中指定id字段（这时不用指定collection的column字段，mybatis会more按照id字段判断查询结果是否归类到一个list中）；要么显式地在colleciton标签指定column字段，mybatis会根据指定的column字段，查询的多条结果如果指定的column字段相同，那么mybatis会把它们都放入到collection指定的property中，如果不指定或者指定的字段在查询的多条结果中不是相同的或者SQL中没有查出该字段，那么mybatis会认为是多条结果，分别封装成一个对象，那么查询结果就不是1个，而是多个，就会出现报错Expected one result (or null) to be returned by selectOne(), but found: 6\n\n\n\n\n\n\n\n\n\n\n","source":"_posts/复杂mapper映射出现Expected one result (or null) to be returned by selectOne(), but found_ 6.md","raw":"---\ntitle: Mybatis复杂mapper映射出现Expected one result (or null) to be returned by selectOne(), but found:6\ndate: 2021-2-1\ntags:\n\t- Mybatis\ncategories:\n\t- Spring\n---\n\n> 今天在项目使用mybatis写映射文件时，做测试发现报错`Expected one result (or null) to be returned by selectOne(), but found: 6`，下面记录一下解决的过程：\n\n![image.png](1612149739610-d371499a-4d5a-4ba7-9b0d-8f9b8bc133ec.png)\n### <font color=\"orange\">1. 问题介绍：</font>\n<!--more-->\n<font size=3>**对应的表关联关系如下：**</font>\n\n#### <img src=\"1612149616517-3d3f353b-1319-4315-a12a-3592c873810c.png\" alt=\"image.png\" style=\"zoom:50%;\" />\n\n其中tb_product与tb_product_img是一对多的关系，外键关联为product_id字段，其他表之间是一一对应关系，关联外键如表中灰色字段所示。\n\n<font size=3>**dao层接口：**</font>\n\n通过给定的productId查询出该product的信息，包括商品的所在分类，商品所属店铺信息，以及商品的详情图（一对多）\n```java\nProduct getProductById(long productId);\n```\n<font size=3>**实体类对象：**</font>\n\n```java\npublic class Product {\n    private Long productId;\n    private String productName;\n    private String productDesc;\n    private String imgAddr; //简略图\n    private String normalPrice; //日常价格\n    private String promotionPrice; //促销价格\n    private List<ProductImg> productImgList; //商品详情图列表\n    private ProductCategory productCategory;\n    private Shop shop;\n    // 管理信息\n    private Integer priority;\n    private Date createTime;\n    private Date lastEditTime;\n    private Integer enableStatus; //商品状态，0表示下架不可用，1表示上架\n}\npublic class ProductImg {\n    private Long productImgId;\n    private String imgAddr;\n    private String imgDesc;\n    private Integer priority;\n    private Date createTime;\n    private Long productId;\n}\npublic class ProductCategory {\n    private Long productCategoryId;\n    private Long shopId; // 查询商品类别时，不太需要Shop实体类对，所以这里使用ShopId\n    private String productCategoryName;\n    private Integer priority;\n    private Date createTime;\n}\npublic class Shop {\n    private Long shopId;\n    // 店铺基本信息\n    private String shopName;\n    private String shopDesc;\n    private String shopAddr;\n    private String phone;\n    private String shopImg;\n    // 管理信息\n    private Integer priority;\n    private Date createTime;\n    private Date lastEditTime;\n    private Integer enableStatus; //-1：不可用，0：审核中 1：可用\n    private String advice; //超级管理员给店家的提醒\n    // 外键信息\n    private Area area; //外键区域id\n    private ShopCategory shopCategory; //外键类别id\n    private PersonInfo owner; //店家\n}\npublic class PersonInfo {\n    private Long userId; //用户id，用Long表示\n    private String name;\n    private String profileImg;\n    private String email;\n    private String gender;\n    private Integer enableStatus; //用户状态，标识是否黑名单\n    private Integer userType; //1顾客 2店家 3超级管理员\n    private Date createTime;\n    private Date lastEditTime;\n}\n```\n<font size=3>**对应的mapper映射文件文件：**</font>\n\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE mapper\n        PUBLIC \"-//mybatis.org/DTD Mapper 3.0//EN\"\n        \"http://mybatis.org/dtd/mybatis-3-mapper.dtd\">\n<mapper namespace=\"com.imooc.o2o.dao.ProductDao\">\n  \t<!--对于冲突名称使用SQL中指定的别名，对于owner_id指定为owner.userId，意思为shop中名为owner的属性，对owner中的userId进行设置字段owner_id的值-->\n    <resultMap id=\"productMap\" type=\"com.imooc.o2o.entity.Product\">\n        <id property=\"productId\" column=\"product_id\"/>\n        <result property=\"productName\" column=\"product_name\"/>\n        <result property=\"productDesc\" column=\"product_desc\"/>\n        <result property=\"imgAddr\" column=\"img_addr\"/>\n        <result property=\"normalPrice\" column=\"normal_price\"/>\n        <result property=\"promotionPrice\" column=\"promotion_price\"/>\n        <result property=\"priority\" column=\"product_priority\"/>\n        <result property=\"createTime\" column=\"product_create_time\"/>\n        <result property=\"lastEditTime\" column=\"product_last_edit_time\"/>\n        <result property=\"enableStatus\" column=\"product_enable_status\"/>\n        <association property=\"productCategory\" javaType=\"com.imooc.o2o.entity.ProductCategory\">\n            <id property=\"productCategoryId\" column=\"product_category_id\"/>\n            <result property=\"productCategoryName\" column=\"product_category_name\"/>\n            <result property=\"priority\" column=\"product_category_priority\"/>\n            <result property=\"createTime\" column=\"product_category_create_time\"/>\n            <result property=\"shopId\" column=\"product_category_shop_id\"/>\n        </association>\n        <association property=\"shop\" javaType=\"com.imooc.o2o.entity.Shop\">\n            <id property=\"shopId\" column=\"shop_id\"/>\n            <result property=\"owner.userId\" column=\"owner_id\"/>\n            <result column=\"shop_name\" property=\"shopName\" />\n            <result column=\"shop_desc\" property=\"shopDesc\" />\n            <result column=\"shop_addr\" property=\"shopAddr\" />\n            <result column=\"phone\" property=\"phone\" />\n            <result column=\"shop_img\" property=\"shopImg\" />\n            <result column=\"shop_priority\" property=\"priority\" />\n            <result column=\"shop_create_time\" property=\"createTime\" />\n            <result column=\"last_edit_time\" property=\"lastEditTime\" />\n            <result column=\"shop_enable_status\" property=\"enableStatus\" />\n            <result column=\"advice\" property=\"advice\" />\n        </association>\n        <collection property=\"productImgList\" ofType=\"com.imooc.o2o.entity.ProductImg\">\n            <id property=\"product_img_id\" column=\"productImgId\"/>\n            <result property=\"imgAddr\" column=\"img_addr\"/>\n            <result property=\"priority\" column=\"priority\"/>\n            <result property=\"createTime\" column=\"product_img_create_time\"/>\n        </collection>\n    </resultMap>\n\n  \t<!--SQL中使用as对冲突名进行重命名-->\n    <select id=\"getProductById\" resultMap=\"productMap\">\n        select p.product_name,p.product_desc,p.img_addr,p.normal_price,p.priority,p.create_time as product_create_time,\n               p.last_edit_time as product_last_edit_time,p.enable_status as product_enable_status,\n               pc.product_category_id,pc.product_category_name,pc.priority as product_category_id,pc.create_time as product_category_create_time,\n               pc.shop_id as product_category_shop_id,\n               s.shop_id,s.shop_name,s.shop_desc,s.phone,s.create_time as shop_create_time,s.owner_Id,pi.product_img_id,pi.priority,pi.img_addr,pi.img_desc,pi.create_time as product_img_create_time\n               from tb_product p,tb_product_category as pc,tb_shop as s,tb_product_img as pi where\n               p.product_category_id = pc.product_category_id and p.shop_id = s.shop_id and p.product_id = pi.product_img_id\n               and p.product_id = #{productId};\n    </select>\n</mapper>\n```\n\n<font size=3>**对应SQL在数据库中查询结果**：</font>\n\n![image.png](1612150436476-e7e658e8-81a4-4292-9b5b-9c00ab6b823f.png)\n\n上述可以看见product中包含了三个实体类对象：ProductCategory，Shop，List\\<ProductImg\\>，而Shop中又有owner实体对象，如果根据一个product_id找到相应的product，要求有实体类对象ProductCategory，Shop，List\\<ProductImg\\>，同时Shop属性中还需要有Owner实体类，应该怎么做？\n\n\n\n### <font color=\"orange\">2. 错误分析：</font>\n\n**1. 首先查询的SQL语句有很多重名字段，例如priority在好几个类里面都有，lastEditTime也同样如此，如何区分字段并把查询出来的字段这些分配到正确的属性中去呢？**\n\n解决办法：在SQL语句中使用AS关键词来给有冲突的列名进行重新命名，同时在ResultMap中写入的Column就是重新命名过的名字，不这样做会造成mybatis遇到重名不知道怎么放，可能会造成查询的lastEditTime是一致的\n\n**2. 查询Shop表中有owner_id字段，查询的时候如何给复杂属性导航，给product的成员变量shop对象中的Owner成员变量设置userId呢？**\n\n通过查阅官方文档的方法：映射到复杂对象的嵌套属性时，可以使用点式分隔方法进行复杂属性的导航，这里就可以使用owner.userId来进行复杂导航\n![image.png](1612109243469-4d89a31b-0d9d-487e-bfed-faf3497e774e.png)\n\n**3. <font color=\"red\"><u>查询Product对象中有productImgList属性，是一个list，如何把SQL查出来多条结果的属于同一个ProductId的ProductImg放入到List中呢？</u></font>**\n\n- 如果`collection`中没有指定`column`字段，那么会默认通过resultMap的`id`标签来判断（这里的id就是product_id）查询的多条结果，如果查询多条结果的product_id是相同的，那么应该放入到List\\<ProductImg\\>中，Product不会增加；如果查询的product_id是不同的，那么就会返回多条结果，这里应该就返回List\\<Product\\>\n- 如果`collection`标签通过指定`column`为product_id或者shop_id（只要是数据库多条结果中有一个字段是相同可以归类为相同就行），mybatis会知道根据column给定的product_id检索SQL查询出来的多条结果，如果多条结果的product_id是一样的，那么查询出来的多条结果中应该放入到List\\<ProductImg\\>中，Product不会增加），如果不指定column字段并且查询结果中也没有指定的id标签字段（这里为product_id），那么查询出来的多条结果中不会放入到List\\<ProductImg\\>中，而是返回多条语句的查询结果List\\<Product\\>，而dao层接口接收的返回对象只有Product，这就是出现了`Expected one result (or null) to be returned by selectOne(), but found: 6`的原因。\n\n> 根据作者本人的解释, MyBatis为了降低内存开销,采用ResultHandler逐行读取的JDBC ResultSet结果集的,这就会造成MyBatis在结果行返回的时候无法判断以后的是否还会有这个id的行返回,所以它采用了一个方法来判断当前id的结果行是否已经读取完成,从而将其加入结果集List,这个方法是:\n>\n> 1.读取当前行记录A,将A加入自定义Cache类,同时读取下一行记录B\n>\n> 2.使用下一行记录B的id列和值为key(这个key由resultMap的\\<id\\>标签列定义)去Cache类里获取记录\n>\n> 3.假如使用B的key不能够获取到记录,则说明B的id与A不同,那么B将被加入到List（所以这里应该会返回List\\<Product>\\，出现报错）\n>\n> 4.假如使用B的key可以获取到记录,说明A与B的id相同,则会将A与B合并(相当于将两个productImg合并到一个List中,而product本身并不会增加)\n>\n> 5.将B定为当前行,同时读取下一行C,重复1-5,直到没有下一行记录\n>\n> 6.当没有下一行记录的时候,将最后一个合并的resultMap对应的java对象加入到List(最后一个被合并goodsImg的Goods)\n> 所以\n>   a. 当结果行是乱序的,例如BBAB这样的顺序,在记录行A遇到一个id不同的曾经出现过的记录行B时, A将不会被加入到List里(因为Cache里已经存在B的id为key的cahce了)\n>   b. 当结果是顺序时,则结果集不会有任何问题,因为 记录行 A 不可能 遇到一个曾经出现过的 记录行B, 所以记录行A不会被忽略,每次遇到新行B时,都不可能使用B的key去Cache里取到值,所以A必然可以被加入到List\n\n在Mybatis中代码如下：\n\n```java\n@Override\n  protected void handleRowValues(ResultSet rs, ResultMap resultMap, ResultHandler resultHandler, RowBounds rowBounds, ResultColumnCache resultColumnCache) throws SQLException {\n    final DefaultResultContext resultContext = new DefaultResultContext();\n    skipRows(rs, rowBounds);\n    Object rowValue = null;\n    while (shouldProcessMoreRows(rs, resultContext, rowBounds)) {\n      final ResultMap discriminatedResultMap = resolveDiscriminatedResultMap(rs, resultMap, null);\n      // 下一记录行的id构成的cache key\n      final CacheKey rowKey = createRowKey(discriminatedResultMap, rs, null, resultColumnCache);\n      Object partialObject = objectCache.get(rowKey);\n      // 判断下一记录行是否被记录与cache中,如果不在cache中则将该记录行的对象插入List\n      if (partialObject == null && rowValue != null) { // issue #542 delay calling ResultHandler until object \n        if (mappedStatement.isResultOrdered()) objectCache.clear(); // issue #577 clear memory if ordered\n        callResultHandler(resultHandler, resultContext, rowValue);\n      } \n      // 当前记录行的值\n      rowValue = getRowValue(rs, discriminatedResultMap, rowKey, rowKey, null, resultColumnCache, partialObject);\n    }\n    // 插入最后一记录行的对象到List\n    if (rowValue != null) callResultHandler(resultHandler, resultContext, rowValue);\n  }\n```\n\n### <font color=\"orange\">3. 解决</font>\n\n通过上述分析，知道了问题所在，select标签中SQL语句既没有查询对应的product的id标签字段product_id也没有在collection中通过显式地指定column字段表明应该根据什么字段将多条查询结果应该归为到一个List\\<ProductImg\\>中，而不是List\\<Product\\>中\n\n提供一下两种解决办法（二者选其一）：\n\na. 在select标签中加入id标签的字段product_id\n\n```SQl\nselect p.product_id,p.product_name,p.product_desc,.......\n```\n\nb. 在collection中指定column字段（采用可以表示为多条结果相同归类即可，这里可以采用shop_id或者product_id，不能采用produt_img_id）\n\n```java\n <collection property=\"productImgList\" column='product_id'ofType=\"com.imooc.o2o.entity.ProductImg\">\n```\n\n\n\n### <font color=\"orange\">4.总结</font>\n\n利用collection进行一对多关系查询时，要么SQL中select出resultMap中指定id字段（这时不用指定collection的column字段，mybatis会more按照id字段判断查询结果是否归类到一个list中）；要么显式地在colleciton标签指定column字段，mybatis会根据指定的column字段，查询的多条结果如果指定的column字段相同，那么mybatis会把它们都放入到collection指定的property中，如果不指定或者指定的字段在查询的多条结果中不是相同的或者SQL中没有查出该字段，那么mybatis会认为是多条结果，分别封装成一个对象，那么查询结果就不是1个，而是多个，就会出现报错Expected one result (or null) to be returned by selectOne(), but found: 6\n\n\n\n\n\n\n\n\n\n\n","slug":"复杂mapper映射出现Expected one result (or null) to be returned by selectOne(), but found_ 6","published":1,"updated":"2021-02-01T05:18:41.032Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl2enrqzr0011y2lod9sidqmm","content":"<blockquote>\n<p>今天在项目使用mybatis写映射文件时，做测试发现报错<code>Expected one result (or null) to be returned by selectOne(), but found: 6</code>，下面记录一下解决的过程：</p>\n</blockquote>\n<p><img src=\"/2021/Spring/%E5%A4%8D%E6%9D%82mapper%E6%98%A0%E5%B0%84%E5%87%BA%E7%8E%B0Expected%20one%20result%20(or%20null)%20to%20be%20returned%20by%20selectOne(),%20but%20found_%206/1612149739610-d371499a-4d5a-4ba7-9b0d-8f9b8bc133ec.png\" alt=\"image.png\"></p>\n<h3 id=\"1-问题介绍：\"><a href=\"#1-问题介绍：\" class=\"headerlink\" title=\"1. 问题介绍：\"></a><font color=\"orange\">1. 问题介绍：</font></h3><a id=\"more\"></a>\n<p><font size=\"3\"><strong>对应的表关联关系如下：</strong></font></p>\n<h4 id><a href=\"#\" class=\"headerlink\" title></a><img src=\"/2021/Spring/%E5%A4%8D%E6%9D%82mapper%E6%98%A0%E5%B0%84%E5%87%BA%E7%8E%B0Expected%20one%20result%20(or%20null)%20to%20be%20returned%20by%20selectOne(),%20but%20found_%206/1612149616517-3d3f353b-1319-4315-a12a-3592c873810c.png\" alt=\"image.png\" style=\"zoom:50%;\"></h4><p>其中tb_product与tb_product_img是一对多的关系，外键关联为product_id字段，其他表之间是一一对应关系，关联外键如表中灰色字段所示。</p>\n<p><font size=\"3\"><strong>dao层接口：</strong></font></p>\n<p>通过给定的productId查询出该product的信息，包括商品的所在分类，商品所属店铺信息，以及商品的详情图（一对多）</p>\n<pre><code class=\"java\">Product getProductById(long productId);\n</code></pre>\n<p><font size=\"3\"><strong>实体类对象：</strong></font></p>\n<pre><code class=\"java\">public class Product &#123;\n    private Long productId;\n    private String productName;\n    private String productDesc;\n    private String imgAddr; //简略图\n    private String normalPrice; //日常价格\n    private String promotionPrice; //促销价格\n    private List&lt;ProductImg&gt; productImgList; //商品详情图列表\n    private ProductCategory productCategory;\n    private Shop shop;\n    // 管理信息\n    private Integer priority;\n    private Date createTime;\n    private Date lastEditTime;\n    private Integer enableStatus; //商品状态，0表示下架不可用，1表示上架\n&#125;\npublic class ProductImg &#123;\n    private Long productImgId;\n    private String imgAddr;\n    private String imgDesc;\n    private Integer priority;\n    private Date createTime;\n    private Long productId;\n&#125;\npublic class ProductCategory &#123;\n    private Long productCategoryId;\n    private Long shopId; // 查询商品类别时，不太需要Shop实体类对，所以这里使用ShopId\n    private String productCategoryName;\n    private Integer priority;\n    private Date createTime;\n&#125;\npublic class Shop &#123;\n    private Long shopId;\n    // 店铺基本信息\n    private String shopName;\n    private String shopDesc;\n    private String shopAddr;\n    private String phone;\n    private String shopImg;\n    // 管理信息\n    private Integer priority;\n    private Date createTime;\n    private Date lastEditTime;\n    private Integer enableStatus; //-1：不可用，0：审核中 1：可用\n    private String advice; //超级管理员给店家的提醒\n    // 外键信息\n    private Area area; //外键区域id\n    private ShopCategory shopCategory; //外键类别id\n    private PersonInfo owner; //店家\n&#125;\npublic class PersonInfo &#123;\n    private Long userId; //用户id，用Long表示\n    private String name;\n    private String profileImg;\n    private String email;\n    private String gender;\n    private Integer enableStatus; //用户状态，标识是否黑名单\n    private Integer userType; //1顾客 2店家 3超级管理员\n    private Date createTime;\n    private Date lastEditTime;\n&#125;\n</code></pre>\n<p><font size=\"3\"><strong>对应的mapper映射文件文件：</strong></font></p>\n<pre><code class=\"xml\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n&lt;!DOCTYPE mapper\n        PUBLIC &quot;-//mybatis.org/DTD Mapper 3.0//EN&quot;\n        &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;\n&lt;mapper namespace=&quot;com.imooc.o2o.dao.ProductDao&quot;&gt;\n      &lt;!--对于冲突名称使用SQL中指定的别名，对于owner_id指定为owner.userId，意思为shop中名为owner的属性，对owner中的userId进行设置字段owner_id的值--&gt;\n    &lt;resultMap id=&quot;productMap&quot; type=&quot;com.imooc.o2o.entity.Product&quot;&gt;\n        &lt;id property=&quot;productId&quot; column=&quot;product_id&quot;/&gt;\n        &lt;result property=&quot;productName&quot; column=&quot;product_name&quot;/&gt;\n        &lt;result property=&quot;productDesc&quot; column=&quot;product_desc&quot;/&gt;\n        &lt;result property=&quot;imgAddr&quot; column=&quot;img_addr&quot;/&gt;\n        &lt;result property=&quot;normalPrice&quot; column=&quot;normal_price&quot;/&gt;\n        &lt;result property=&quot;promotionPrice&quot; column=&quot;promotion_price&quot;/&gt;\n        &lt;result property=&quot;priority&quot; column=&quot;product_priority&quot;/&gt;\n        &lt;result property=&quot;createTime&quot; column=&quot;product_create_time&quot;/&gt;\n        &lt;result property=&quot;lastEditTime&quot; column=&quot;product_last_edit_time&quot;/&gt;\n        &lt;result property=&quot;enableStatus&quot; column=&quot;product_enable_status&quot;/&gt;\n        &lt;association property=&quot;productCategory&quot; javaType=&quot;com.imooc.o2o.entity.ProductCategory&quot;&gt;\n            &lt;id property=&quot;productCategoryId&quot; column=&quot;product_category_id&quot;/&gt;\n            &lt;result property=&quot;productCategoryName&quot; column=&quot;product_category_name&quot;/&gt;\n            &lt;result property=&quot;priority&quot; column=&quot;product_category_priority&quot;/&gt;\n            &lt;result property=&quot;createTime&quot; column=&quot;product_category_create_time&quot;/&gt;\n            &lt;result property=&quot;shopId&quot; column=&quot;product_category_shop_id&quot;/&gt;\n        &lt;/association&gt;\n        &lt;association property=&quot;shop&quot; javaType=&quot;com.imooc.o2o.entity.Shop&quot;&gt;\n            &lt;id property=&quot;shopId&quot; column=&quot;shop_id&quot;/&gt;\n            &lt;result property=&quot;owner.userId&quot; column=&quot;owner_id&quot;/&gt;\n            &lt;result column=&quot;shop_name&quot; property=&quot;shopName&quot; /&gt;\n            &lt;result column=&quot;shop_desc&quot; property=&quot;shopDesc&quot; /&gt;\n            &lt;result column=&quot;shop_addr&quot; property=&quot;shopAddr&quot; /&gt;\n            &lt;result column=&quot;phone&quot; property=&quot;phone&quot; /&gt;\n            &lt;result column=&quot;shop_img&quot; property=&quot;shopImg&quot; /&gt;\n            &lt;result column=&quot;shop_priority&quot; property=&quot;priority&quot; /&gt;\n            &lt;result column=&quot;shop_create_time&quot; property=&quot;createTime&quot; /&gt;\n            &lt;result column=&quot;last_edit_time&quot; property=&quot;lastEditTime&quot; /&gt;\n            &lt;result column=&quot;shop_enable_status&quot; property=&quot;enableStatus&quot; /&gt;\n            &lt;result column=&quot;advice&quot; property=&quot;advice&quot; /&gt;\n        &lt;/association&gt;\n        &lt;collection property=&quot;productImgList&quot; ofType=&quot;com.imooc.o2o.entity.ProductImg&quot;&gt;\n            &lt;id property=&quot;product_img_id&quot; column=&quot;productImgId&quot;/&gt;\n            &lt;result property=&quot;imgAddr&quot; column=&quot;img_addr&quot;/&gt;\n            &lt;result property=&quot;priority&quot; column=&quot;priority&quot;/&gt;\n            &lt;result property=&quot;createTime&quot; column=&quot;product_img_create_time&quot;/&gt;\n        &lt;/collection&gt;\n    &lt;/resultMap&gt;\n\n      &lt;!--SQL中使用as对冲突名进行重命名--&gt;\n    &lt;select id=&quot;getProductById&quot; resultMap=&quot;productMap&quot;&gt;\n        select p.product_name,p.product_desc,p.img_addr,p.normal_price,p.priority,p.create_time as product_create_time,\n               p.last_edit_time as product_last_edit_time,p.enable_status as product_enable_status,\n               pc.product_category_id,pc.product_category_name,pc.priority as product_category_id,pc.create_time as product_category_create_time,\n               pc.shop_id as product_category_shop_id,\n               s.shop_id,s.shop_name,s.shop_desc,s.phone,s.create_time as shop_create_time,s.owner_Id,pi.product_img_id,pi.priority,pi.img_addr,pi.img_desc,pi.create_time as product_img_create_time\n               from tb_product p,tb_product_category as pc,tb_shop as s,tb_product_img as pi where\n               p.product_category_id = pc.product_category_id and p.shop_id = s.shop_id and p.product_id = pi.product_img_id\n               and p.product_id = #&#123;productId&#125;;\n    &lt;/select&gt;\n&lt;/mapper&gt;\n</code></pre>\n<p><font size=\"3\"><strong>对应SQL在数据库中查询结果</strong>：</font></p>\n<p><img src=\"/2021/Spring/%E5%A4%8D%E6%9D%82mapper%E6%98%A0%E5%B0%84%E5%87%BA%E7%8E%B0Expected%20one%20result%20(or%20null)%20to%20be%20returned%20by%20selectOne(),%20but%20found_%206/1612150436476-e7e658e8-81a4-4292-9b5b-9c00ab6b823f.png\" alt=\"image.png\"></p>\n<p>上述可以看见product中包含了三个实体类对象：ProductCategory，Shop，List&lt;ProductImg&gt;，而Shop中又有owner实体对象，如果根据一个product_id找到相应的product，要求有实体类对象ProductCategory，Shop，List&lt;ProductImg&gt;，同时Shop属性中还需要有Owner实体类，应该怎么做？</p>\n<h3 id=\"2-错误分析：\"><a href=\"#2-错误分析：\" class=\"headerlink\" title=\"2. 错误分析：\"></a><font color=\"orange\">2. 错误分析：</font></h3><p><strong>1. 首先查询的SQL语句有很多重名字段，例如priority在好几个类里面都有，lastEditTime也同样如此，如何区分字段并把查询出来的字段这些分配到正确的属性中去呢？</strong></p>\n<p>解决办法：在SQL语句中使用AS关键词来给有冲突的列名进行重新命名，同时在ResultMap中写入的Column就是重新命名过的名字，不这样做会造成mybatis遇到重名不知道怎么放，可能会造成查询的lastEditTime是一致的</p>\n<p><strong>2. 查询Shop表中有owner_id字段，查询的时候如何给复杂属性导航，给product的成员变量shop对象中的Owner成员变量设置userId呢？</strong></p>\n<p>通过查阅官方文档的方法：映射到复杂对象的嵌套属性时，可以使用点式分隔方法进行复杂属性的导航，这里就可以使用owner.userId来进行复杂导航<br><img src=\"/2021/Spring/%E5%A4%8D%E6%9D%82mapper%E6%98%A0%E5%B0%84%E5%87%BA%E7%8E%B0Expected%20one%20result%20(or%20null)%20to%20be%20returned%20by%20selectOne(),%20but%20found_%206/1612109243469-4d89a31b-0d9d-487e-bfed-faf3497e774e.png\" alt=\"image.png\"></p>\n<p><strong>3. <font color=\"red\"><u>查询Product对象中有productImgList属性，是一个list，如何把SQL查出来多条结果的属于同一个ProductId的ProductImg放入到List中呢？</u></font></strong></p>\n<ul>\n<li>如果<code>collection</code>中没有指定<code>column</code>字段，那么会默认通过resultMap的<code>id</code>标签来判断（这里的id就是product_id）查询的多条结果，如果查询多条结果的product_id是相同的，那么应该放入到List&lt;ProductImg&gt;中，Product不会增加；如果查询的product_id是不同的，那么就会返回多条结果，这里应该就返回List&lt;Product&gt;</li>\n<li>如果<code>collection</code>标签通过指定<code>column</code>为product_id或者shop_id（只要是数据库多条结果中有一个字段是相同可以归类为相同就行），mybatis会知道根据column给定的product_id检索SQL查询出来的多条结果，如果多条结果的product_id是一样的，那么查询出来的多条结果中应该放入到List&lt;ProductImg&gt;中，Product不会增加），如果不指定column字段并且查询结果中也没有指定的id标签字段（这里为product_id），那么查询出来的多条结果中不会放入到List&lt;ProductImg&gt;中，而是返回多条语句的查询结果List&lt;Product&gt;，而dao层接口接收的返回对象只有Product，这就是出现了<code>Expected one result (or null) to be returned by selectOne(), but found: 6</code>的原因。</li>\n</ul>\n<blockquote>\n<p>根据作者本人的解释, MyBatis为了降低内存开销,采用ResultHandler逐行读取的JDBC ResultSet结果集的,这就会造成MyBatis在结果行返回的时候无法判断以后的是否还会有这个id的行返回,所以它采用了一个方法来判断当前id的结果行是否已经读取完成,从而将其加入结果集List,这个方法是:</p>\n<p>1.读取当前行记录A,将A加入自定义Cache类,同时读取下一行记录B</p>\n<p>2.使用下一行记录B的id列和值为key(这个key由resultMap的&lt;id&gt;标签列定义)去Cache类里获取记录</p>\n<p>3.假如使用B的key不能够获取到记录,则说明B的id与A不同,那么B将被加入到List（所以这里应该会返回List&lt;Product&gt;\\，出现报错）</p>\n<p>4.假如使用B的key可以获取到记录,说明A与B的id相同,则会将A与B合并(相当于将两个productImg合并到一个List中,而product本身并不会增加)</p>\n<p>5.将B定为当前行,同时读取下一行C,重复1-5,直到没有下一行记录</p>\n<p>6.当没有下一行记录的时候,将最后一个合并的resultMap对应的java对象加入到List(最后一个被合并goodsImg的Goods)<br>所以<br>  a. 当结果行是乱序的,例如BBAB这样的顺序,在记录行A遇到一个id不同的曾经出现过的记录行B时, A将不会被加入到List里(因为Cache里已经存在B的id为key的cahce了)<br>  b. 当结果是顺序时,则结果集不会有任何问题,因为 记录行 A 不可能 遇到一个曾经出现过的 记录行B, 所以记录行A不会被忽略,每次遇到新行B时,都不可能使用B的key去Cache里取到值,所以A必然可以被加入到List</p>\n</blockquote>\n<p>在Mybatis中代码如下：</p>\n<pre><code class=\"java\">@Override\n  protected void handleRowValues(ResultSet rs, ResultMap resultMap, ResultHandler resultHandler, RowBounds rowBounds, ResultColumnCache resultColumnCache) throws SQLException &#123;\n    final DefaultResultContext resultContext = new DefaultResultContext();\n    skipRows(rs, rowBounds);\n    Object rowValue = null;\n    while (shouldProcessMoreRows(rs, resultContext, rowBounds)) &#123;\n      final ResultMap discriminatedResultMap = resolveDiscriminatedResultMap(rs, resultMap, null);\n      // 下一记录行的id构成的cache key\n      final CacheKey rowKey = createRowKey(discriminatedResultMap, rs, null, resultColumnCache);\n      Object partialObject = objectCache.get(rowKey);\n      // 判断下一记录行是否被记录与cache中,如果不在cache中则将该记录行的对象插入List\n      if (partialObject == null &amp;&amp; rowValue != null) &#123; // issue #542 delay calling ResultHandler until object \n        if (mappedStatement.isResultOrdered()) objectCache.clear(); // issue #577 clear memory if ordered\n        callResultHandler(resultHandler, resultContext, rowValue);\n      &#125; \n      // 当前记录行的值\n      rowValue = getRowValue(rs, discriminatedResultMap, rowKey, rowKey, null, resultColumnCache, partialObject);\n    &#125;\n    // 插入最后一记录行的对象到List\n    if (rowValue != null) callResultHandler(resultHandler, resultContext, rowValue);\n  &#125;\n</code></pre>\n<h3 id=\"3-解决\"><a href=\"#3-解决\" class=\"headerlink\" title=\"3. 解决\"></a><font color=\"orange\">3. 解决</font></h3><p>通过上述分析，知道了问题所在，select标签中SQL语句既没有查询对应的product的id标签字段product_id也没有在collection中通过显式地指定column字段表明应该根据什么字段将多条查询结果应该归为到一个List&lt;ProductImg&gt;中，而不是List&lt;Product&gt;中</p>\n<p>提供一下两种解决办法（二者选其一）：</p>\n<p>a. 在select标签中加入id标签的字段product_id</p>\n<pre><code class=\"SQl\">select p.product_id,p.product_name,p.product_desc,.......\n</code></pre>\n<p>b. 在collection中指定column字段（采用可以表示为多条结果相同归类即可，这里可以采用shop_id或者product_id，不能采用produt_img_id）</p>\n<pre><code class=\"java\"> &lt;collection property=&quot;productImgList&quot; column=&#39;product_id&#39;ofType=&quot;com.imooc.o2o.entity.ProductImg&quot;&gt;\n</code></pre>\n<h3 id=\"4-总结\"><a href=\"#4-总结\" class=\"headerlink\" title=\"4.总结\"></a><font color=\"orange\">4.总结</font></h3><p>利用collection进行一对多关系查询时，要么SQL中select出resultMap中指定id字段（这时不用指定collection的column字段，mybatis会more按照id字段判断查询结果是否归类到一个list中）；要么显式地在colleciton标签指定column字段，mybatis会根据指定的column字段，查询的多条结果如果指定的column字段相同，那么mybatis会把它们都放入到collection指定的property中，如果不指定或者指定的字段在查询的多条结果中不是相同的或者SQL中没有查出该字段，那么mybatis会认为是多条结果，分别封装成一个对象，那么查询结果就不是1个，而是多个，就会出现报错Expected one result (or null) to be returned by selectOne(), but found: 6</p>\n","site":{"data":{"photography":[{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","title":"玉渊潭","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","title":"花儿","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","title":"白塔寺","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"}]}},"excerpt":"<blockquote>\n<p>今天在项目使用mybatis写映射文件时，做测试发现报错<code>Expected one result (or null) to be returned by selectOne(), but found: 6</code>，下面记录一下解决的过程：</p>\n</blockquote>\n<p><img src=\"/2021/Spring/%E5%A4%8D%E6%9D%82mapper%E6%98%A0%E5%B0%84%E5%87%BA%E7%8E%B0Expected%20one%20result%20(or%20null)%20to%20be%20returned%20by%20selectOne(),%20but%20found_%206/1612149739610-d371499a-4d5a-4ba7-9b0d-8f9b8bc133ec.png\" alt=\"image.png\"></p>\n<h3 id=\"1-问题介绍：\"><a href=\"#1-问题介绍：\" class=\"headerlink\" title=\"1. 问题介绍：\"></a><font color=\"orange\">1. 问题介绍：</font></h3>","more":"<p><font size=\"3\"><strong>对应的表关联关系如下：</strong></font></p>\n<h4 id><a href=\"#\" class=\"headerlink\" title></a><img src=\"/2021/Spring/%E5%A4%8D%E6%9D%82mapper%E6%98%A0%E5%B0%84%E5%87%BA%E7%8E%B0Expected%20one%20result%20(or%20null)%20to%20be%20returned%20by%20selectOne(),%20but%20found_%206/1612149616517-3d3f353b-1319-4315-a12a-3592c873810c.png\" alt=\"image.png\" style=\"zoom:50%;\"></h4><p>其中tb_product与tb_product_img是一对多的关系，外键关联为product_id字段，其他表之间是一一对应关系，关联外键如表中灰色字段所示。</p>\n<p><font size=\"3\"><strong>dao层接口：</strong></font></p>\n<p>通过给定的productId查询出该product的信息，包括商品的所在分类，商品所属店铺信息，以及商品的详情图（一对多）</p>\n<pre><code class=\"java\">Product getProductById(long productId);\n</code></pre>\n<p><font size=\"3\"><strong>实体类对象：</strong></font></p>\n<pre><code class=\"java\">public class Product &#123;\n    private Long productId;\n    private String productName;\n    private String productDesc;\n    private String imgAddr; //简略图\n    private String normalPrice; //日常价格\n    private String promotionPrice; //促销价格\n    private List&lt;ProductImg&gt; productImgList; //商品详情图列表\n    private ProductCategory productCategory;\n    private Shop shop;\n    // 管理信息\n    private Integer priority;\n    private Date createTime;\n    private Date lastEditTime;\n    private Integer enableStatus; //商品状态，0表示下架不可用，1表示上架\n&#125;\npublic class ProductImg &#123;\n    private Long productImgId;\n    private String imgAddr;\n    private String imgDesc;\n    private Integer priority;\n    private Date createTime;\n    private Long productId;\n&#125;\npublic class ProductCategory &#123;\n    private Long productCategoryId;\n    private Long shopId; // 查询商品类别时，不太需要Shop实体类对，所以这里使用ShopId\n    private String productCategoryName;\n    private Integer priority;\n    private Date createTime;\n&#125;\npublic class Shop &#123;\n    private Long shopId;\n    // 店铺基本信息\n    private String shopName;\n    private String shopDesc;\n    private String shopAddr;\n    private String phone;\n    private String shopImg;\n    // 管理信息\n    private Integer priority;\n    private Date createTime;\n    private Date lastEditTime;\n    private Integer enableStatus; //-1：不可用，0：审核中 1：可用\n    private String advice; //超级管理员给店家的提醒\n    // 外键信息\n    private Area area; //外键区域id\n    private ShopCategory shopCategory; //外键类别id\n    private PersonInfo owner; //店家\n&#125;\npublic class PersonInfo &#123;\n    private Long userId; //用户id，用Long表示\n    private String name;\n    private String profileImg;\n    private String email;\n    private String gender;\n    private Integer enableStatus; //用户状态，标识是否黑名单\n    private Integer userType; //1顾客 2店家 3超级管理员\n    private Date createTime;\n    private Date lastEditTime;\n&#125;\n</code></pre>\n<p><font size=\"3\"><strong>对应的mapper映射文件文件：</strong></font></p>\n<pre><code class=\"xml\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n&lt;!DOCTYPE mapper\n        PUBLIC &quot;-//mybatis.org/DTD Mapper 3.0//EN&quot;\n        &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;\n&lt;mapper namespace=&quot;com.imooc.o2o.dao.ProductDao&quot;&gt;\n      &lt;!--对于冲突名称使用SQL中指定的别名，对于owner_id指定为owner.userId，意思为shop中名为owner的属性，对owner中的userId进行设置字段owner_id的值--&gt;\n    &lt;resultMap id=&quot;productMap&quot; type=&quot;com.imooc.o2o.entity.Product&quot;&gt;\n        &lt;id property=&quot;productId&quot; column=&quot;product_id&quot;/&gt;\n        &lt;result property=&quot;productName&quot; column=&quot;product_name&quot;/&gt;\n        &lt;result property=&quot;productDesc&quot; column=&quot;product_desc&quot;/&gt;\n        &lt;result property=&quot;imgAddr&quot; column=&quot;img_addr&quot;/&gt;\n        &lt;result property=&quot;normalPrice&quot; column=&quot;normal_price&quot;/&gt;\n        &lt;result property=&quot;promotionPrice&quot; column=&quot;promotion_price&quot;/&gt;\n        &lt;result property=&quot;priority&quot; column=&quot;product_priority&quot;/&gt;\n        &lt;result property=&quot;createTime&quot; column=&quot;product_create_time&quot;/&gt;\n        &lt;result property=&quot;lastEditTime&quot; column=&quot;product_last_edit_time&quot;/&gt;\n        &lt;result property=&quot;enableStatus&quot; column=&quot;product_enable_status&quot;/&gt;\n        &lt;association property=&quot;productCategory&quot; javaType=&quot;com.imooc.o2o.entity.ProductCategory&quot;&gt;\n            &lt;id property=&quot;productCategoryId&quot; column=&quot;product_category_id&quot;/&gt;\n            &lt;result property=&quot;productCategoryName&quot; column=&quot;product_category_name&quot;/&gt;\n            &lt;result property=&quot;priority&quot; column=&quot;product_category_priority&quot;/&gt;\n            &lt;result property=&quot;createTime&quot; column=&quot;product_category_create_time&quot;/&gt;\n            &lt;result property=&quot;shopId&quot; column=&quot;product_category_shop_id&quot;/&gt;\n        &lt;/association&gt;\n        &lt;association property=&quot;shop&quot; javaType=&quot;com.imooc.o2o.entity.Shop&quot;&gt;\n            &lt;id property=&quot;shopId&quot; column=&quot;shop_id&quot;/&gt;\n            &lt;result property=&quot;owner.userId&quot; column=&quot;owner_id&quot;/&gt;\n            &lt;result column=&quot;shop_name&quot; property=&quot;shopName&quot; /&gt;\n            &lt;result column=&quot;shop_desc&quot; property=&quot;shopDesc&quot; /&gt;\n            &lt;result column=&quot;shop_addr&quot; property=&quot;shopAddr&quot; /&gt;\n            &lt;result column=&quot;phone&quot; property=&quot;phone&quot; /&gt;\n            &lt;result column=&quot;shop_img&quot; property=&quot;shopImg&quot; /&gt;\n            &lt;result column=&quot;shop_priority&quot; property=&quot;priority&quot; /&gt;\n            &lt;result column=&quot;shop_create_time&quot; property=&quot;createTime&quot; /&gt;\n            &lt;result column=&quot;last_edit_time&quot; property=&quot;lastEditTime&quot; /&gt;\n            &lt;result column=&quot;shop_enable_status&quot; property=&quot;enableStatus&quot; /&gt;\n            &lt;result column=&quot;advice&quot; property=&quot;advice&quot; /&gt;\n        &lt;/association&gt;\n        &lt;collection property=&quot;productImgList&quot; ofType=&quot;com.imooc.o2o.entity.ProductImg&quot;&gt;\n            &lt;id property=&quot;product_img_id&quot; column=&quot;productImgId&quot;/&gt;\n            &lt;result property=&quot;imgAddr&quot; column=&quot;img_addr&quot;/&gt;\n            &lt;result property=&quot;priority&quot; column=&quot;priority&quot;/&gt;\n            &lt;result property=&quot;createTime&quot; column=&quot;product_img_create_time&quot;/&gt;\n        &lt;/collection&gt;\n    &lt;/resultMap&gt;\n\n      &lt;!--SQL中使用as对冲突名进行重命名--&gt;\n    &lt;select id=&quot;getProductById&quot; resultMap=&quot;productMap&quot;&gt;\n        select p.product_name,p.product_desc,p.img_addr,p.normal_price,p.priority,p.create_time as product_create_time,\n               p.last_edit_time as product_last_edit_time,p.enable_status as product_enable_status,\n               pc.product_category_id,pc.product_category_name,pc.priority as product_category_id,pc.create_time as product_category_create_time,\n               pc.shop_id as product_category_shop_id,\n               s.shop_id,s.shop_name,s.shop_desc,s.phone,s.create_time as shop_create_time,s.owner_Id,pi.product_img_id,pi.priority,pi.img_addr,pi.img_desc,pi.create_time as product_img_create_time\n               from tb_product p,tb_product_category as pc,tb_shop as s,tb_product_img as pi where\n               p.product_category_id = pc.product_category_id and p.shop_id = s.shop_id and p.product_id = pi.product_img_id\n               and p.product_id = #&#123;productId&#125;;\n    &lt;/select&gt;\n&lt;/mapper&gt;\n</code></pre>\n<p><font size=\"3\"><strong>对应SQL在数据库中查询结果</strong>：</font></p>\n<p><img src=\"/2021/Spring/%E5%A4%8D%E6%9D%82mapper%E6%98%A0%E5%B0%84%E5%87%BA%E7%8E%B0Expected%20one%20result%20(or%20null)%20to%20be%20returned%20by%20selectOne(),%20but%20found_%206/1612150436476-e7e658e8-81a4-4292-9b5b-9c00ab6b823f.png\" alt=\"image.png\"></p>\n<p>上述可以看见product中包含了三个实体类对象：ProductCategory，Shop，List&lt;ProductImg&gt;，而Shop中又有owner实体对象，如果根据一个product_id找到相应的product，要求有实体类对象ProductCategory，Shop，List&lt;ProductImg&gt;，同时Shop属性中还需要有Owner实体类，应该怎么做？</p>\n<h3 id=\"2-错误分析：\"><a href=\"#2-错误分析：\" class=\"headerlink\" title=\"2. 错误分析：\"></a><font color=\"orange\">2. 错误分析：</font></h3><p><strong>1. 首先查询的SQL语句有很多重名字段，例如priority在好几个类里面都有，lastEditTime也同样如此，如何区分字段并把查询出来的字段这些分配到正确的属性中去呢？</strong></p>\n<p>解决办法：在SQL语句中使用AS关键词来给有冲突的列名进行重新命名，同时在ResultMap中写入的Column就是重新命名过的名字，不这样做会造成mybatis遇到重名不知道怎么放，可能会造成查询的lastEditTime是一致的</p>\n<p><strong>2. 查询Shop表中有owner_id字段，查询的时候如何给复杂属性导航，给product的成员变量shop对象中的Owner成员变量设置userId呢？</strong></p>\n<p>通过查阅官方文档的方法：映射到复杂对象的嵌套属性时，可以使用点式分隔方法进行复杂属性的导航，这里就可以使用owner.userId来进行复杂导航<br><img src=\"/2021/Spring/%E5%A4%8D%E6%9D%82mapper%E6%98%A0%E5%B0%84%E5%87%BA%E7%8E%B0Expected%20one%20result%20(or%20null)%20to%20be%20returned%20by%20selectOne(),%20but%20found_%206/1612109243469-4d89a31b-0d9d-487e-bfed-faf3497e774e.png\" alt=\"image.png\"></p>\n<p><strong>3. <font color=\"red\"><u>查询Product对象中有productImgList属性，是一个list，如何把SQL查出来多条结果的属于同一个ProductId的ProductImg放入到List中呢？</u></font></strong></p>\n<ul>\n<li>如果<code>collection</code>中没有指定<code>column</code>字段，那么会默认通过resultMap的<code>id</code>标签来判断（这里的id就是product_id）查询的多条结果，如果查询多条结果的product_id是相同的，那么应该放入到List&lt;ProductImg&gt;中，Product不会增加；如果查询的product_id是不同的，那么就会返回多条结果，这里应该就返回List&lt;Product&gt;</li>\n<li>如果<code>collection</code>标签通过指定<code>column</code>为product_id或者shop_id（只要是数据库多条结果中有一个字段是相同可以归类为相同就行），mybatis会知道根据column给定的product_id检索SQL查询出来的多条结果，如果多条结果的product_id是一样的，那么查询出来的多条结果中应该放入到List&lt;ProductImg&gt;中，Product不会增加），如果不指定column字段并且查询结果中也没有指定的id标签字段（这里为product_id），那么查询出来的多条结果中不会放入到List&lt;ProductImg&gt;中，而是返回多条语句的查询结果List&lt;Product&gt;，而dao层接口接收的返回对象只有Product，这就是出现了<code>Expected one result (or null) to be returned by selectOne(), but found: 6</code>的原因。</li>\n</ul>\n<blockquote>\n<p>根据作者本人的解释, MyBatis为了降低内存开销,采用ResultHandler逐行读取的JDBC ResultSet结果集的,这就会造成MyBatis在结果行返回的时候无法判断以后的是否还会有这个id的行返回,所以它采用了一个方法来判断当前id的结果行是否已经读取完成,从而将其加入结果集List,这个方法是:</p>\n<p>1.读取当前行记录A,将A加入自定义Cache类,同时读取下一行记录B</p>\n<p>2.使用下一行记录B的id列和值为key(这个key由resultMap的&lt;id&gt;标签列定义)去Cache类里获取记录</p>\n<p>3.假如使用B的key不能够获取到记录,则说明B的id与A不同,那么B将被加入到List（所以这里应该会返回List&lt;Product&gt;\\，出现报错）</p>\n<p>4.假如使用B的key可以获取到记录,说明A与B的id相同,则会将A与B合并(相当于将两个productImg合并到一个List中,而product本身并不会增加)</p>\n<p>5.将B定为当前行,同时读取下一行C,重复1-5,直到没有下一行记录</p>\n<p>6.当没有下一行记录的时候,将最后一个合并的resultMap对应的java对象加入到List(最后一个被合并goodsImg的Goods)<br>所以<br>  a. 当结果行是乱序的,例如BBAB这样的顺序,在记录行A遇到一个id不同的曾经出现过的记录行B时, A将不会被加入到List里(因为Cache里已经存在B的id为key的cahce了)<br>  b. 当结果是顺序时,则结果集不会有任何问题,因为 记录行 A 不可能 遇到一个曾经出现过的 记录行B, 所以记录行A不会被忽略,每次遇到新行B时,都不可能使用B的key去Cache里取到值,所以A必然可以被加入到List</p>\n</blockquote>\n<p>在Mybatis中代码如下：</p>\n<pre><code class=\"java\">@Override\n  protected void handleRowValues(ResultSet rs, ResultMap resultMap, ResultHandler resultHandler, RowBounds rowBounds, ResultColumnCache resultColumnCache) throws SQLException &#123;\n    final DefaultResultContext resultContext = new DefaultResultContext();\n    skipRows(rs, rowBounds);\n    Object rowValue = null;\n    while (shouldProcessMoreRows(rs, resultContext, rowBounds)) &#123;\n      final ResultMap discriminatedResultMap = resolveDiscriminatedResultMap(rs, resultMap, null);\n      // 下一记录行的id构成的cache key\n      final CacheKey rowKey = createRowKey(discriminatedResultMap, rs, null, resultColumnCache);\n      Object partialObject = objectCache.get(rowKey);\n      // 判断下一记录行是否被记录与cache中,如果不在cache中则将该记录行的对象插入List\n      if (partialObject == null &amp;&amp; rowValue != null) &#123; // issue #542 delay calling ResultHandler until object \n        if (mappedStatement.isResultOrdered()) objectCache.clear(); // issue #577 clear memory if ordered\n        callResultHandler(resultHandler, resultContext, rowValue);\n      &#125; \n      // 当前记录行的值\n      rowValue = getRowValue(rs, discriminatedResultMap, rowKey, rowKey, null, resultColumnCache, partialObject);\n    &#125;\n    // 插入最后一记录行的对象到List\n    if (rowValue != null) callResultHandler(resultHandler, resultContext, rowValue);\n  &#125;\n</code></pre>\n<h3 id=\"3-解决\"><a href=\"#3-解决\" class=\"headerlink\" title=\"3. 解决\"></a><font color=\"orange\">3. 解决</font></h3><p>通过上述分析，知道了问题所在，select标签中SQL语句既没有查询对应的product的id标签字段product_id也没有在collection中通过显式地指定column字段表明应该根据什么字段将多条查询结果应该归为到一个List&lt;ProductImg&gt;中，而不是List&lt;Product&gt;中</p>\n<p>提供一下两种解决办法（二者选其一）：</p>\n<p>a. 在select标签中加入id标签的字段product_id</p>\n<pre><code class=\"SQl\">select p.product_id,p.product_name,p.product_desc,.......\n</code></pre>\n<p>b. 在collection中指定column字段（采用可以表示为多条结果相同归类即可，这里可以采用shop_id或者product_id，不能采用produt_img_id）</p>\n<pre><code class=\"java\"> &lt;collection property=&quot;productImgList&quot; column=&#39;product_id&#39;ofType=&quot;com.imooc.o2o.entity.ProductImg&quot;&gt;\n</code></pre>\n<h3 id=\"4-总结\"><a href=\"#4-总结\" class=\"headerlink\" title=\"4.总结\"></a><font color=\"orange\">4.总结</font></h3><p>利用collection进行一对多关系查询时，要么SQL中select出resultMap中指定id字段（这时不用指定collection的column字段，mybatis会more按照id字段判断查询结果是否归类到一个list中）；要么显式地在colleciton标签指定column字段，mybatis会根据指定的column字段，查询的多条结果如果指定的column字段相同，那么mybatis会把它们都放入到collection指定的property中，如果不指定或者指定的字段在查询的多条结果中不是相同的或者SQL中没有查出该字段，那么mybatis会认为是多条结果，分别封装成一个对象，那么查询结果就不是1个，而是多个，就会出现报错Expected one result (or null) to be returned by selectOne(), but found: 6</p>"},{"title":"奥斯曼帝国的衰落原由","date":"2021-01-27T12:30:00.000Z","_content":"\n最近闲暇之余看中东战争史，记录一下\n\n1. 军权无法牢牢掌握在苏丹手中，往往出现改革一触及军阀保守势力的利益就被推翻的场面，改革在上层就无法推行\n2. 政权更替完全是靠王室之间的屠杀优胜者当王，政治内斗严重，政法思想无法一脉相承\n<!--more-->\n3. 西化改革未取精髓，帝国核心地带自然灾害仍然想效仿西方花费大量金钱建立类似法国同时期建立的凡尔赛宫、建造战舰，但国内已经名民不聊生，埃及税收因向西方借贷打克里米亚战争抵押给了英法，阿拉伯半岛更是穷的叮当响，只能从相对富裕的巴尔干半岛进行搜刮，巴尔干半岛都是斯拉夫人，与奥斯曼帝国主教伊斯兰教不对付，加上税收家重，可以说巴尔干半岛已经是暗流涌动，沙皇俄国也正虎视眈眈这块地区，内忧外患\n4. 军队体制涣散，战士没有战斗力一直想子传父业，想铁饭碗，贪腐无能，依靠地缘优势敲诈勒索所有外来经商，不利于生产力的推动和经商环境\n5. 民族之间割裂严重，没有一个统一的国家意识，宗教教义和法律相并行，法律需要教义解释才可执行，无法做到贯彻实施\n6. 西方开始工业革命，开辟航海路线达到亚非地区，奥斯曼帝国敲诈勒索途径商队的陆路贸易航线对追求极致利润的西方来说完全没有吸引力\n\n","source":"_posts/奥斯曼帝国的衰落原由.md","raw":"---\ntitle: 奥斯曼帝国的衰落原由\ndate: 2021-01-27 20:30\ntags:\n  - 随笔\n  - 历史\ncategories:\n  - 中东战争史\n---\n\n最近闲暇之余看中东战争史，记录一下\n\n1. 军权无法牢牢掌握在苏丹手中，往往出现改革一触及军阀保守势力的利益就被推翻的场面，改革在上层就无法推行\n2. 政权更替完全是靠王室之间的屠杀优胜者当王，政治内斗严重，政法思想无法一脉相承\n<!--more-->\n3. 西化改革未取精髓，帝国核心地带自然灾害仍然想效仿西方花费大量金钱建立类似法国同时期建立的凡尔赛宫、建造战舰，但国内已经名民不聊生，埃及税收因向西方借贷打克里米亚战争抵押给了英法，阿拉伯半岛更是穷的叮当响，只能从相对富裕的巴尔干半岛进行搜刮，巴尔干半岛都是斯拉夫人，与奥斯曼帝国主教伊斯兰教不对付，加上税收家重，可以说巴尔干半岛已经是暗流涌动，沙皇俄国也正虎视眈眈这块地区，内忧外患\n4. 军队体制涣散，战士没有战斗力一直想子传父业，想铁饭碗，贪腐无能，依靠地缘优势敲诈勒索所有外来经商，不利于生产力的推动和经商环境\n5. 民族之间割裂严重，没有一个统一的国家意识，宗教教义和法律相并行，法律需要教义解释才可执行，无法做到贯彻实施\n6. 西方开始工业革命，开辟航海路线达到亚非地区，奥斯曼帝国敲诈勒索途径商队的陆路贸易航线对追求极致利润的西方来说完全没有吸引力\n\n","slug":"奥斯曼帝国的衰落原由","published":1,"updated":"2021-03-28T10:14:09.342Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl2enrqzs0013y2lohof61ugx","content":"<p>最近闲暇之余看中东战争史，记录一下</p>\n<ol>\n<li>军权无法牢牢掌握在苏丹手中，往往出现改革一触及军阀保守势力的利益就被推翻的场面，改革在上层就无法推行</li>\n<li>政权更替完全是靠王室之间的屠杀优胜者当王，政治内斗严重，政法思想无法一脉相承<a id=\"more\"></a></li>\n<li>西化改革未取精髓，帝国核心地带自然灾害仍然想效仿西方花费大量金钱建立类似法国同时期建立的凡尔赛宫、建造战舰，但国内已经名民不聊生，埃及税收因向西方借贷打克里米亚战争抵押给了英法，阿拉伯半岛更是穷的叮当响，只能从相对富裕的巴尔干半岛进行搜刮，巴尔干半岛都是斯拉夫人，与奥斯曼帝国主教伊斯兰教不对付，加上税收家重，可以说巴尔干半岛已经是暗流涌动，沙皇俄国也正虎视眈眈这块地区，内忧外患</li>\n<li>军队体制涣散，战士没有战斗力一直想子传父业，想铁饭碗，贪腐无能，依靠地缘优势敲诈勒索所有外来经商，不利于生产力的推动和经商环境</li>\n<li>民族之间割裂严重，没有一个统一的国家意识，宗教教义和法律相并行，法律需要教义解释才可执行，无法做到贯彻实施</li>\n<li>西方开始工业革命，开辟航海路线达到亚非地区，奥斯曼帝国敲诈勒索途径商队的陆路贸易航线对追求极致利润的西方来说完全没有吸引力</li>\n</ol>\n","site":{"data":{"photography":[{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","title":"玉渊潭","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","title":"花儿","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","title":"白塔寺","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"}]}},"excerpt":"<p>最近闲暇之余看中东战争史，记录一下</p>\n<ol>\n<li>军权无法牢牢掌握在苏丹手中，往往出现改革一触及军阀保守势力的利益就被推翻的场面，改革在上层就无法推行</li>\n<li>政权更替完全是靠王室之间的屠杀优胜者当王，政治内斗严重，政法思想无法一脉相承</li></ol>","more":"\n<li>西化改革未取精髓，帝国核心地带自然灾害仍然想效仿西方花费大量金钱建立类似法国同时期建立的凡尔赛宫、建造战舰，但国内已经名民不聊生，埃及税收因向西方借贷打克里米亚战争抵押给了英法，阿拉伯半岛更是穷的叮当响，只能从相对富裕的巴尔干半岛进行搜刮，巴尔干半岛都是斯拉夫人，与奥斯曼帝国主教伊斯兰教不对付，加上税收家重，可以说巴尔干半岛已经是暗流涌动，沙皇俄国也正虎视眈眈这块地区，内忧外患</li>\n<li>军队体制涣散，战士没有战斗力一直想子传父业，想铁饭碗，贪腐无能，依靠地缘优势敲诈勒索所有外来经商，不利于生产力的推动和经商环境</li>\n<li>民族之间割裂严重，没有一个统一的国家意识，宗教教义和法律相并行，法律需要教义解释才可执行，无法做到贯彻实施</li>\n<li>西方开始工业革命，开辟航海路线达到亚非地区，奥斯曼帝国敲诈勒索途径商队的陆路贸易航线对追求极致利润的西方来说完全没有吸引力</li>\n"},{"title":"微服务基础概念","date":"2021-03-17T16:00:00.000Z","toc":true,"_content":"\n**1.微服务**\n\n拒绝大型单体引用，基于业务边界进行服务微化拆分，各个服务独立部署运行，,每个服务之间相互调用\n\n例如：订单服务 -》商品服务 -》仓库服务\n\n\n\n**2.集群**\n\n例如：京东就是一个分布式系统，众多业务运行在不同的机器上，所有业务构成了一个大型的业务集群。\n\n集群是一个物理形态，分布式是一个工作方式\n\n分布式的每一个结点，都可以做集群，而集群并不一定就是分布式的\n\n结点：集群中一个服务器\n\n<!--more-->\n\n**3.远程调用**\n\n在分布式系统中，各个服务会处于不同主机，但是服务之间不可避免的会产生相互调用，我们称之为远程调用。SpringCloud中使用HTTP + JSON的方式完成调用\n\n\n\n**4.负载均衡**\n\n订单服务需要查询商品服务，如果商品服务有很多的结点，为了不让商品服务每个服务器太忙或者太闲，通过负载均衡的调用每一个服务器，提高网站的健壮性。\n\n常见负载均衡算法：\n\n轮询：为第一个请求选择健康池中的第一个服务器，然后按照顺序依次往后进行选择\n\n最小连接：选择连接最少的后端服务器，在会话比较长的时候可以采取考虑此种方式\n\n散列：通过请求源的IP地址的hash来选择对应的服务器\n\n\n\n**5.服务注册/发现**\n\nA服务有三台机器，A服务被B服务调用，A服务三台机器需要去注册中心进行注册，B服务调用并不知道A服务有哪几台可用，这时就去注册中心询问A服务有几台可用。\n\n注册中心：维护哪些服务在哪些机器\n\n\n\n**6.配置中心**\n\n每个服务都有很多的配置，例如A服务有服务配置，A服务运行在三台机器上，如果服务配置发生修改，此时就需要对这三台服务同时进行下线然后逐个修改，如果服务器数量过多，这样肯定是不行的。这时候就引入了配置中心，A服务配置发生修改，我们只需要修改配置中心A服务的配置，A服务的三台机器都会自动获得修改的值，实现改一处配置即可更新所有机器的配置\n\n\n\n**7.服务熔断&服务降级**\n\n在服务相互调用过程中，例如商品服务查询仓库服务是否有库存时，如果网络不可靠或者仓库服务宕机了，商品服务源源不断接收到上层的请求，商品服务就会阻塞等待，就会导致**请求积压**，过多请求阻塞会导致商品**服务内存耗尽**，商品服务不可用了，上层的订单服务也会导致请求积压也会发生连锁反应，这就是雪崩现象，由于一个服务的不可用导致整个上游服务调用链均不可用\n\n解决办法\n\n- 服务熔断：设置服务的超时，如果被调用的服务达到一个阈值，就开启短路保护机制，后来的请求就不会调用下游的服务，直接本地返回默认的数据或者NULL\n- 服务降级：系统处于高峰期是，系统资源紧张，这是可以让非核心业务降级运行，让某些服务不处理请求或者处理简单【抛异常、返回NULL、调用Mock数据、调用Faaback处理逻辑】\n\n\n\n**8.API网关**\n\n前端发送的请求都是HTTP的形式，这个HTTP请求不会直接流向后端的服务集群，而是先通过API网关，比如对所有请求进行验证哪些合法哪些非法，非法的请求就拦截不放行到后端的业务集群，API网关抽象了微服务中都需要的公共功能，同时提供了客户端负载均衡、服务自动熔断、灰度发布、限流流控、日志统计等功能。通过API网关的请求后端服务群才进行处理，当大量请求时，网关还有以一定恒定的速率对请求进行放行，防止后端服务集群收到瞬时过大的请求将后端服务集群压垮，可以帮助我们解决很多API管理难题。","source":"_posts/微服务基础概念.md","raw":"---\ntitle: 微服务基础概念\ndate: 2021-3-18\ntags:\n\t- 微服务\ncategories:\n\t- SpringCloud\ntoc: true\n---\n\n**1.微服务**\n\n拒绝大型单体引用，基于业务边界进行服务微化拆分，各个服务独立部署运行，,每个服务之间相互调用\n\n例如：订单服务 -》商品服务 -》仓库服务\n\n\n\n**2.集群**\n\n例如：京东就是一个分布式系统，众多业务运行在不同的机器上，所有业务构成了一个大型的业务集群。\n\n集群是一个物理形态，分布式是一个工作方式\n\n分布式的每一个结点，都可以做集群，而集群并不一定就是分布式的\n\n结点：集群中一个服务器\n\n<!--more-->\n\n**3.远程调用**\n\n在分布式系统中，各个服务会处于不同主机，但是服务之间不可避免的会产生相互调用，我们称之为远程调用。SpringCloud中使用HTTP + JSON的方式完成调用\n\n\n\n**4.负载均衡**\n\n订单服务需要查询商品服务，如果商品服务有很多的结点，为了不让商品服务每个服务器太忙或者太闲，通过负载均衡的调用每一个服务器，提高网站的健壮性。\n\n常见负载均衡算法：\n\n轮询：为第一个请求选择健康池中的第一个服务器，然后按照顺序依次往后进行选择\n\n最小连接：选择连接最少的后端服务器，在会话比较长的时候可以采取考虑此种方式\n\n散列：通过请求源的IP地址的hash来选择对应的服务器\n\n\n\n**5.服务注册/发现**\n\nA服务有三台机器，A服务被B服务调用，A服务三台机器需要去注册中心进行注册，B服务调用并不知道A服务有哪几台可用，这时就去注册中心询问A服务有几台可用。\n\n注册中心：维护哪些服务在哪些机器\n\n\n\n**6.配置中心**\n\n每个服务都有很多的配置，例如A服务有服务配置，A服务运行在三台机器上，如果服务配置发生修改，此时就需要对这三台服务同时进行下线然后逐个修改，如果服务器数量过多，这样肯定是不行的。这时候就引入了配置中心，A服务配置发生修改，我们只需要修改配置中心A服务的配置，A服务的三台机器都会自动获得修改的值，实现改一处配置即可更新所有机器的配置\n\n\n\n**7.服务熔断&服务降级**\n\n在服务相互调用过程中，例如商品服务查询仓库服务是否有库存时，如果网络不可靠或者仓库服务宕机了，商品服务源源不断接收到上层的请求，商品服务就会阻塞等待，就会导致**请求积压**，过多请求阻塞会导致商品**服务内存耗尽**，商品服务不可用了，上层的订单服务也会导致请求积压也会发生连锁反应，这就是雪崩现象，由于一个服务的不可用导致整个上游服务调用链均不可用\n\n解决办法\n\n- 服务熔断：设置服务的超时，如果被调用的服务达到一个阈值，就开启短路保护机制，后来的请求就不会调用下游的服务，直接本地返回默认的数据或者NULL\n- 服务降级：系统处于高峰期是，系统资源紧张，这是可以让非核心业务降级运行，让某些服务不处理请求或者处理简单【抛异常、返回NULL、调用Mock数据、调用Faaback处理逻辑】\n\n\n\n**8.API网关**\n\n前端发送的请求都是HTTP的形式，这个HTTP请求不会直接流向后端的服务集群，而是先通过API网关，比如对所有请求进行验证哪些合法哪些非法，非法的请求就拦截不放行到后端的业务集群，API网关抽象了微服务中都需要的公共功能，同时提供了客户端负载均衡、服务自动熔断、灰度发布、限流流控、日志统计等功能。通过API网关的请求后端服务群才进行处理，当大量请求时，网关还有以一定恒定的速率对请求进行放行，防止后端服务集群收到瞬时过大的请求将后端服务集群压垮，可以帮助我们解决很多API管理难题。","slug":"微服务基础概念","published":1,"updated":"2021-03-28T09:48:46.265Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl2enrqzt0016y2lo5tek78y4","content":"<p><strong>1.微服务</strong></p>\n<p>拒绝大型单体引用，基于业务边界进行服务微化拆分，各个服务独立部署运行，,每个服务之间相互调用</p>\n<p>例如：订单服务 -》商品服务 -》仓库服务</p>\n<p><strong>2.集群</strong></p>\n<p>例如：京东就是一个分布式系统，众多业务运行在不同的机器上，所有业务构成了一个大型的业务集群。</p>\n<p>集群是一个物理形态，分布式是一个工作方式</p>\n<p>分布式的每一个结点，都可以做集群，而集群并不一定就是分布式的</p>\n<p>结点：集群中一个服务器</p>\n<a id=\"more\"></a>\n\n<p><strong>3.远程调用</strong></p>\n<p>在分布式系统中，各个服务会处于不同主机，但是服务之间不可避免的会产生相互调用，我们称之为远程调用。SpringCloud中使用HTTP + JSON的方式完成调用</p>\n<p><strong>4.负载均衡</strong></p>\n<p>订单服务需要查询商品服务，如果商品服务有很多的结点，为了不让商品服务每个服务器太忙或者太闲，通过负载均衡的调用每一个服务器，提高网站的健壮性。</p>\n<p>常见负载均衡算法：</p>\n<p>轮询：为第一个请求选择健康池中的第一个服务器，然后按照顺序依次往后进行选择</p>\n<p>最小连接：选择连接最少的后端服务器，在会话比较长的时候可以采取考虑此种方式</p>\n<p>散列：通过请求源的IP地址的hash来选择对应的服务器</p>\n<p><strong>5.服务注册/发现</strong></p>\n<p>A服务有三台机器，A服务被B服务调用，A服务三台机器需要去注册中心进行注册，B服务调用并不知道A服务有哪几台可用，这时就去注册中心询问A服务有几台可用。</p>\n<p>注册中心：维护哪些服务在哪些机器</p>\n<p><strong>6.配置中心</strong></p>\n<p>每个服务都有很多的配置，例如A服务有服务配置，A服务运行在三台机器上，如果服务配置发生修改，此时就需要对这三台服务同时进行下线然后逐个修改，如果服务器数量过多，这样肯定是不行的。这时候就引入了配置中心，A服务配置发生修改，我们只需要修改配置中心A服务的配置，A服务的三台机器都会自动获得修改的值，实现改一处配置即可更新所有机器的配置</p>\n<p><strong>7.服务熔断&amp;服务降级</strong></p>\n<p>在服务相互调用过程中，例如商品服务查询仓库服务是否有库存时，如果网络不可靠或者仓库服务宕机了，商品服务源源不断接收到上层的请求，商品服务就会阻塞等待，就会导致<strong>请求积压</strong>，过多请求阻塞会导致商品<strong>服务内存耗尽</strong>，商品服务不可用了，上层的订单服务也会导致请求积压也会发生连锁反应，这就是雪崩现象，由于一个服务的不可用导致整个上游服务调用链均不可用</p>\n<p>解决办法</p>\n<ul>\n<li>服务熔断：设置服务的超时，如果被调用的服务达到一个阈值，就开启短路保护机制，后来的请求就不会调用下游的服务，直接本地返回默认的数据或者NULL</li>\n<li>服务降级：系统处于高峰期是，系统资源紧张，这是可以让非核心业务降级运行，让某些服务不处理请求或者处理简单【抛异常、返回NULL、调用Mock数据、调用Faaback处理逻辑】</li>\n</ul>\n<p><strong>8.API网关</strong></p>\n<p>前端发送的请求都是HTTP的形式，这个HTTP请求不会直接流向后端的服务集群，而是先通过API网关，比如对所有请求进行验证哪些合法哪些非法，非法的请求就拦截不放行到后端的业务集群，API网关抽象了微服务中都需要的公共功能，同时提供了客户端负载均衡、服务自动熔断、灰度发布、限流流控、日志统计等功能。通过API网关的请求后端服务群才进行处理，当大量请求时，网关还有以一定恒定的速率对请求进行放行，防止后端服务集群收到瞬时过大的请求将后端服务集群压垮，可以帮助我们解决很多API管理难题。</p>\n","site":{"data":{"photography":[{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","title":"玉渊潭","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","title":"花儿","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","title":"白塔寺","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"}]}},"excerpt":"<p><strong>1.微服务</strong></p>\n<p>拒绝大型单体引用，基于业务边界进行服务微化拆分，各个服务独立部署运行，,每个服务之间相互调用</p>\n<p>例如：订单服务 -》商品服务 -》仓库服务</p>\n<p><strong>2.集群</strong></p>\n<p>例如：京东就是一个分布式系统，众多业务运行在不同的机器上，所有业务构成了一个大型的业务集群。</p>\n<p>集群是一个物理形态，分布式是一个工作方式</p>\n<p>分布式的每一个结点，都可以做集群，而集群并不一定就是分布式的</p>\n<p>结点：集群中一个服务器</p>","more":"<p><strong>3.远程调用</strong></p>\n<p>在分布式系统中，各个服务会处于不同主机，但是服务之间不可避免的会产生相互调用，我们称之为远程调用。SpringCloud中使用HTTP + JSON的方式完成调用</p>\n<p><strong>4.负载均衡</strong></p>\n<p>订单服务需要查询商品服务，如果商品服务有很多的结点，为了不让商品服务每个服务器太忙或者太闲，通过负载均衡的调用每一个服务器，提高网站的健壮性。</p>\n<p>常见负载均衡算法：</p>\n<p>轮询：为第一个请求选择健康池中的第一个服务器，然后按照顺序依次往后进行选择</p>\n<p>最小连接：选择连接最少的后端服务器，在会话比较长的时候可以采取考虑此种方式</p>\n<p>散列：通过请求源的IP地址的hash来选择对应的服务器</p>\n<p><strong>5.服务注册/发现</strong></p>\n<p>A服务有三台机器，A服务被B服务调用，A服务三台机器需要去注册中心进行注册，B服务调用并不知道A服务有哪几台可用，这时就去注册中心询问A服务有几台可用。</p>\n<p>注册中心：维护哪些服务在哪些机器</p>\n<p><strong>6.配置中心</strong></p>\n<p>每个服务都有很多的配置，例如A服务有服务配置，A服务运行在三台机器上，如果服务配置发生修改，此时就需要对这三台服务同时进行下线然后逐个修改，如果服务器数量过多，这样肯定是不行的。这时候就引入了配置中心，A服务配置发生修改，我们只需要修改配置中心A服务的配置，A服务的三台机器都会自动获得修改的值，实现改一处配置即可更新所有机器的配置</p>\n<p><strong>7.服务熔断&amp;服务降级</strong></p>\n<p>在服务相互调用过程中，例如商品服务查询仓库服务是否有库存时，如果网络不可靠或者仓库服务宕机了，商品服务源源不断接收到上层的请求，商品服务就会阻塞等待，就会导致<strong>请求积压</strong>，过多请求阻塞会导致商品<strong>服务内存耗尽</strong>，商品服务不可用了，上层的订单服务也会导致请求积压也会发生连锁反应，这就是雪崩现象，由于一个服务的不可用导致整个上游服务调用链均不可用</p>\n<p>解决办法</p>\n<ul>\n<li>服务熔断：设置服务的超时，如果被调用的服务达到一个阈值，就开启短路保护机制，后来的请求就不会调用下游的服务，直接本地返回默认的数据或者NULL</li>\n<li>服务降级：系统处于高峰期是，系统资源紧张，这是可以让非核心业务降级运行，让某些服务不处理请求或者处理简单【抛异常、返回NULL、调用Mock数据、调用Faaback处理逻辑】</li>\n</ul>\n<p><strong>8.API网关</strong></p>\n<p>前端发送的请求都是HTTP的形式，这个HTTP请求不会直接流向后端的服务集群，而是先通过API网关，比如对所有请求进行验证哪些合法哪些非法，非法的请求就拦截不放行到后端的业务集群，API网关抽象了微服务中都需要的公共功能，同时提供了客户端负载均衡、服务自动熔断、灰度发布、限流流控、日志统计等功能。通过API网关的请求后端服务群才进行处理，当大量请求时，网关还有以一定恒定的速率对请求进行放行，防止后端服务集群收到瞬时过大的请求将后端服务集群压垮，可以帮助我们解决很多API管理难题。</p>"},{"title":"docker配置Mysql集群(下)——Spring代码层读写分离","date":"2021-01-28T16:00:00.000Z","toc":true,"_content":"上节介绍了利用Docker部署MYSQL集群，下面介绍如何利用部署好的master和slave实现Spring代码层的读写分离，保证发生读操作时访问slave结点，发生写操作时访问master结点。\n\n### <span style=\"color:orange;\">1. 实现基础</span>\n\n**a.spring有关数据源路由的源码**\n\n<!--more-->\n\n```java\npackage org.springframework.jdbc.datasource.lookup;\n\nimport java.sql.Connection;\nimport java.sql.SQLException;\nimport java.util.HashMap;\nimport java.util.Iterator;\nimport java.util.Map;\nimport java.util.Map.Entry;\nimport javax.sql.DataSource;\nimport org.springframework.beans.factory.InitializingBean;\nimport org.springframework.jdbc.datasource.AbstractDataSource;\nimport org.springframework.util.Assert;\n\npublic abstract class AbstractRoutingDataSource extends AbstractDataSource implements InitializingBean {\n    private Map<Object, Object> targetDataSources;\n    private Object defaultTargetDataSource;\n    private boolean lenientFallback = true;\n    private DataSourceLookup dataSourceLookup = new JndiDataSourceLookup();\n    private Map<Object, DataSource> resolvedDataSources;\n    private DataSource resolvedDefaultDataSource;\n    \n    protected DataSource determineTargetDataSource() {\n        Assert.notNull(this.resolvedDataSources, \"DataSource router not initialized\");\n        Object lookupKey = this.determineCurrentLookupKey();\n        DataSource dataSource = (DataSource)this.resolvedDataSources.get(lookupKey);\n        if (dataSource == null && (this.lenientFallback || lookupKey == null)) {\n            dataSource = this.resolvedDefaultDataSource;\n        }\n\n        if (dataSource == null) {\n            throw new IllegalStateException(\"Cannot determine target DataSource for lookup key [\" + lookupKey + \"]\");\n        } else {\n            return dataSource;\n        }\n    }\n\n    protected abstract Object determineCurrentLookupKey();\n    \n    ...\n}\n```\n首先看一下在`springframework.jdbc`包下的源码，类名`AbstractRoutingDataSource`（抽象路由数据源），这个虚拟类就是spring提供的提供路由导向的数据库类\n\n- 通过变量Map存储不同方法的数据源\n- `determineTargetDataSource`方法通过调用`determineCurrentLookupKey`来指明使用何种数据库，然后在Map中寻找相应的datasource\n\n我们可以通过实现上面`determineCurrentLookupKey`抽象方法，通过建立一个Map存储master和slave的数据源，通过SQL对应是update还是insert操作，来决定使用何种key，进而调用哪个数据源\n\n\n\n**b.Mybatis提供Interceptor**\n\n```java\npackage org.apache.ibatis.plugin;\n\nimport java.util.Properties;\n\npublic interface Interceptor {\n    Object intercept(Invocation var1) throws Throwable;\n\n    Object plugin(Object var1);\n\n    void setProperties(Properties var1);\n}\n```\n`Interceptor`是mybatis提供一个接口，是拦截类，可以拦截mybatis中的操作\n\n- `plugin`方法：定义拦截何种类型的类，以决定是否织入代理\n- `intercept`方法：定义对拦截下来的类织入的逻辑\n\n通过自定义实现接口中的两个方法，我们可以使用plugin方法仅拦截属于Mybatis底层SQL执行器的类，`interceptor`方法可以编写对应拦截到执行器的执行SQL方法\n\n\n\n\n\n**c.如何将`Interceptor`方法和`determineCurrentLookupKey`方法以及具体不同数据库操作的线程统筹**\n\n这里用到了一个中间人——**ThreadLocal**，通过ThreadLocal来隔绝不同数据库线程的要选择的key。\n具体而言为：Interceptor通过拦截执行器对应的数据库操作，查看是属于读还是写操作，来向ThreadLocal中放入对应线程选择数据源的名字（master or slave），然后通过实现AbstractRoutingDataSource中的determineCurrentLookupKey方法去从ThreadLocal中取对应线程放入的key，然后根据对应的key在Map型变量targetDataSources选择相应的数据源\n\n### <span style=\"color:orange;\">2.实现方式</span>\n**a.DynamicDataSourceHolder类**\n\n主要定义中间人池子ThreadLocal来隔离不同线程放入的key，其中可选择的key定义为静态变量\"master\"和\"slave\"\n```java\npackage com.imooc.o2o.dao.split;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\n/**\n * 池子，放入决定数据源key的池子，其中池子利用ThreadLocal设置为线程安全\n */\npublic class DynamicDataSourceHolder {\n    private static Logger logger = LoggerFactory.getLogger(DynamicDataSourceHolder.class);\n    // 池子，利用ThreadLocal保证线程安全，线程安全是访问同一个变量时容器出现问题，特别多个线程对一个变量进行写入的时候\n    // ThreadLocal是除了加锁之外的另外一种保证多线程访问变量的线程安全方法，即每个线程对变量的访问都是基于线程自己的变量\n    // 也就是说中央变量只有一个，但是每个线程都有一个中央变量的独立拷贝，每个线程只访问修改自己独立拷贝的变量\n    private static ThreadLocal<String> contextHolder = new ThreadLocal<String>();\n    public static String DB_MASTER = \"master\";\n    public static String DB_SLAVE = \"slave\";\n\n    public static String getDbType(){\n        String db = contextHolder.get();\n        if(db == null){\n            db = DB_MASTER;\n        }\n        return db;\n    }\n\n    /**\n     * 设置线程的dbType\n     * @param str\n     */\n    public static void setDbType(String str){\n        logger.debug(\"所使用的数据源为：\" + str);\n        contextHolder.set(str);\n    }\n\n    /**\n     * 清理连接类型\n     */\n    public static void clearDbType(){\n        contextHolder.remove();\n    }\n}\n```\n\n\n\n\n\n**b.DynamicDataSourceInterceptor类**\n\n通过实现Mybatis提供的Interceptor接口来拦截Mybatis执行器Executor，intercept方法定义织入的规则，通过invocation.getArgs()来获取对应线程执行的数据库操作是读操作还是写操作，然后向DynamicDataSourceHolder中的ThreadLocal放入对应线程选择的key，是选择master还是slave\n\n\n\n**读写分离逻辑**\n\n这里首先先判断是否为事务操作\n\n+ 如果是事务操作，会包含一系列增删改查的操作，所以使用master数据库\n\n- 如果不是事务操作，然后再看对应增删改查是读取还是写入操作，从而实现读写分离的逻辑\n```java\npackage com.imooc.o2o.dao.split;\n\nimport org.apache.ibatis.executor.Executor;\nimport org.apache.ibatis.executor.keygen.SelectKeyGenerator;\nimport org.apache.ibatis.mapping.BoundSql;\nimport org.apache.ibatis.mapping.MappedStatement;\nimport org.apache.ibatis.mapping.SqlCommandType;\nimport org.apache.ibatis.plugin.*;\nimport org.apache.ibatis.session.ResultHandler;\nimport org.apache.ibatis.session.RowBounds;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.transaction.support.TransactionSynchronizationManager;\n\nimport java.util.Locale;\nimport java.util.Properties;\n\n/**\n * 拦截器拦截mybatis传递进来的SQL信息，根据SQL信息来使用相应的读写分离的数据源\n */\n// mybatis会把增删改的方法封装在update这个method中\n@Intercepts({@Signature(type=Executor.class, method=\"update\", args={MappedStatement.class, Object.class}),\n@Signature(type=Executor.class, method=\"query\", args={MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class})})\npublic class DynamicDataSourceInterceptor implements Interceptor {\n    private static Logger logger = LoggerFactory.getLogger(DynamicDataSourceInterceptor.class);\n    private static final String REGEX = \".*insert\\\\u0020.*|.*update\\\\u0020.*|.*delete\\\\u0020.*\";\n\n    /**\n     * 织入的规则\n     * @param invocation\n     * @return\n     * @throws Throwable\n     */\n    @Override\n    public Object intercept(Invocation invocation) throws Throwable {\n        // 利用spring提供的，判断当前是不是事务已表明是不是数据库操作\n        boolean synchronizationActive = TransactionSynchronizationManager.isActualTransactionActive();\n        Object[] objects = invocation.getArgs();\n        MappedStatement ms = (MappedStatement)objects[0]; // 参数第一个是解释什么数据库操作\n        String lookupKey = DynamicDataSourceHolder.DB_MASTER;\n        if(synchronizationActive != true){\n            // 读方法，\n            if(ms.getSqlCommandType().equals(SqlCommandType.SELECT)){\n                // selectKey 为自增id查询主键（SELECT LAST_INSERT_ID())方法，使用主库，通常使用自增主键插入数据库操作\n                if(ms.getId().contains(SelectKeyGenerator.SELECT_KEY_SUFFIX)){\n                    lookupKey = DynamicDataSourceHolder.DB_MASTER;\n                }else{\n                    BoundSql boundSql = ms.getSqlSource().getBoundSql(objects[1]);\n                    String sql = boundSql.getSql().toLowerCase(Locale.CHINA).replaceAll(\"[\\\\t\\\\n\\\\r]\", \"\");\n                    if(sql.matches(REGEX)){\n                        lookupKey = DynamicDataSourceHolder.DB_MASTER;\n                    }else{\n                        lookupKey = DynamicDataSourceHolder.DB_SLAVE;\n                    }\n                }\n            }\n        }else{\n            // 因为一般事务操作可能包含增删改查混合操作，所以用master\n            lookupKey = DynamicDataSourceHolder.DB_MASTER;\n        }\n        logger.debug(\"设置方法[{}] use[{}] Strategy,SqlCommandType[{}]...\", ms.getId(), lookupKey, ms.getSqlCommandType().name());\n        DynamicDataSourceHolder.setDbType(lookupKey);\n        return invocation.proceed();\n    }\n\n    /**\n     * 返回封装好的代理对象，决定返回的是本体还是编织好的代理\n     * @param target\n     * @return\n     */\n    @Override\n    public Object plugin(Object target) {\n        // 这里的Executor是mybatis支持一系列增删改查操作的执行器\n        if(target instanceof Executor){\n            // 如果是mybatis的Executor类型，那么就把编入逻辑织入，不是返回本体\n            return Plugin.wrap(target, this);\n        }\n        return target;\n    }\n\n    /**\n     * 非必要\n     * @param properties\n     */\n    @Override\n    public void setProperties(Properties properties) {\n\n    }\n}\n```\n\n\n\n\n**c.DynamicDataSource类**\n\n继承AbstractRoutingDataSource，实现determineCurrentLookupKey方法，从池子中获取对应线程应该选择的数据源名称key，然后在targetDataSource中获取对应的数据源连接给线程（targetDataSource是个Map变量，在spring-dao.xml配置文件中配置）\n```java\npackage com.imooc.o2o.dao.split;\n\nimport org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;\n\n/**\n * 从池子中取key，然后从HashMap<String,DataSource>中用key找到对应的DataSource\n */\npublic class DynamicDataSource extends AbstractRoutingDataSource {\n    @Override\n    protected Object determineCurrentLookupKey() {\n        return DynamicDataSourceHolder.getDbType();\n    }\n}\n\n```\n\n\n### <span style=\"color:orange;\">3.装配</span>\n\n1. mybatis-config中装配拦截器\n\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n<!DOCTYPE configuration\n        PUBLIC \"-//mybatis.org//DTD Config 3.0//EN\"\n        \"http://mybatis.org/dtd/mybatis-3-config.dtd\">\n<configuration>\n    <!-- 配置全局属性 -->\n    <settings>\n        <!-- 使用jdbc的getGeneratedKeys获取数据库自增主键值 -->\n        <setting name=\"useGeneratedKeys\" value=\"true\"/>\n\n        <!-- 使用列标签（数据库列名）替换列名（查询语句名字） 默认:true -->\n        <setting name=\"useColumnLabel\" value=\"true\"/>\n\n        <!-- 开启驼峰命名转换:Table{create_time} -> Entity{createTime} -->\n        <setting name=\"mapUnderscoreToCamelCase\" value=\"true\"/>\n    </settings>\n\n    <!--自定义读写分离拦截器-->\n    <plugins>\n        <plugin interceptor=\"com.imooc.o2o.dao.split.DynamicDataSourceInterceptor\"/>\n    </plugins>\n</configuration>\n```\n\n2. spring-dao.xml配置路由数据源\n\n* 设置abstract为true的连接池，定义为abstract是为了后边继承通用的连接池属性\n\n- 定义好master和slave的数据源连接配置，指明parent为上面abstract的连接池\n- 将继承实现AbstractRoutingDataSourc    e的类，配置好Map变量targetDataSource\n- 定义为懒加载，因为只在SQL语句正式执行的时候才指定出来dataSource\n\njdbc.properties文件：\n\n\tjdbc.master.driver=com.mysql.cj.jdbc.Driver\n\tjdbc.master.url=jdbc:mysql://localhost:10001/o2o?useUnicode=true&characterEncoding=utf8\n\tjdbc.master.username=root\n\tjdbc.master.password=make1234\n\tjdbc.slave.driver=com.mysql.cj.jdbc.Driver\n\tjdbc.slave.url=jdbc:mysql://localhost:10002/o2o?useUnicode=true&characterEncoding=utf8\n\tjdbc.slave.username=root\n\tjdbc.slave.password=make1234\nspring-dao.xml文件：\n\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<beans xmlns=\"http://www.springframework.org/schema/beans\"\n       xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n       xmlns:context=\"http://www.springframework.org/schema/context\"\n       xmlns:p=\"http://www.springframework.org/schema/p\" xmlns:bean=\"http://www.springframework.org/schema/context\"\n       xsi:schemaLocation=\"http://www.springframework.org/schema/beans\n       http://www.springframework.org/schema/beans/spring-beans.xsd\n       http://www.springframework.org/schema/context\n       http://www.springframework.org/schema/context/spring-context.xsd\">\n\n    <context:component-scan base-package=\"com.imooc.o2o.dao\"/>\n\n    <!--配置数据库properties的数据-->\n    <context:property-placeholder location=\"classpath:jdbc.properties\"/>\n\n    <!--1.数据库连接池，设置为abstract，便于后面继承属性配置主从库-->\n    <bean id=\"abstractDataSource\" class=\"com.mchange.v2.c3p0.ComboPooledDataSource\"\n        abstract=\"true\" destroy-method=\"close\">\n        <!--c3p0连接池的私有属性-->\n        <property name=\"maxPoolSize\" value=\"30\"/>\n        <property name=\"minPoolSize\" value=\"10\"/>\n        <!--关闭连接后不自动commit-->\n        <property name=\"autoCommitOnClose\" value=\"false\"/>\n        <!--获取连接的超时时间-->\n        <property name=\"checkoutTimeout\" value=\"10000\"/>\n        <!--当获取连接失败重试次数-->\n        <property name=\"acquireRetryAttempts\" value=\"10\"/>\n    </bean>\n\n    <!--2.主库配置-->\n    <bean id=\"master\" parent=\"abstractDataSource\">\n        <!--配置连接池属性-->\n        <property name=\"driverClass\" value=\"${jdbc.master.driver}\"/>\n        <property name=\"jdbcUrl\" value=\"${jdbc.master.url}\"/>\n        <property name=\"user\" value=\"${jdbc.master.username}\"/>\n        <property name=\"password\" value=\"${jdbc.master.password}\"/>\n    </bean>\n\n    <!--3.从库配置-->\n    <bean id=\"slave\" parent=\"abstractDataSource\">\n        <!--配置连接池属性-->\n        <property name=\"driverClass\" value=\"${jdbc.slave.driver}\"/>\n        <property name=\"jdbcUrl\" value=\"${jdbc.slave.url}\"/>\n        <property name=\"user\" value=\"${jdbc.slave.username}\"/>\n        <property name=\"password\" value=\"${jdbc.slave.password}\"/>\n    </bean>\n\n    <!--4.配置动态数据源，这儿的targetDataSource就是路由数据源所对应的名称-->\n    <bean id=\"dynamicDataSource\" class=\"com.imooc.o2o.dao.split.DynamicDataSource\">\n        <!--将数据源放入到map中，这里的key要与com.imooc.o2o.dao.split.DynamicDataSourceHolder中的key相同-->\n        <property name=\"targetDataSources\">\n            <map>\n                <entry value-ref=\"master\" key=\"master\"></entry>\n                <entry value-ref=\"slave\" key=\"slave\"></entry>\n            </map>\n        </property>\n    </bean>\n\n    <!--5.懒加载，需要在SQL语句正式执行的时候才指定出来dataSource-->\n    <bean id=\"dataSource\" class=\"org.springframework.jdbc.datasource.LazyConnectionDataSourceProxy\">\n        <property name=\"targetDataSource\">\n            <ref bean=\"dynamicDataSource\"></ref>\n        </property>\n    </bean>\n\n    <!--配置SqlSessionFactory对象-->\n    <!--MyBatis全局配置文件-->\n    <!--扫描entity包，将取出结果包装成entity对象-->\n    <!--扫描Sql配置文件-->\n    <bean id=\"sqlSessionFactory\" class=\"org.mybatis.spring.SqlSessionFactoryBean\"\n          p:dataSource-ref=\"dataSource\"\n          p:configLocation=\"classpath:mybatis-config.xml\"\n          p:typeAliasesPackage=\"com.imooc.o2o.entity\"\n          p:mapperLocations=\"classpath:mapper/*.xml\"/>\n\n    <!--配置扫描Dao接口包，动态实现Dao接口，注入到Spring容器中-->\n    <bean class=\"org.mybatis.spring.mapper.MapperScannerConfigurer\">\n        <!--注入SqlSessionFactory-->\n        <property name=\"sqlSessionFactoryBeanName\" value=\"sqlSessionFactory\"/>\n        <!--给出需要扫描Dao接口包-->\n        <property name=\"basePackage\" value=\"com.imooc.o2o.dao\"/>\n    </bean>\n</beans>\n```\n\n","source":"_posts/docker配置Mysql集群(下)——Spring代码层读写分离.md","raw":"---\ntitle: docker配置Mysql集群(下)——Spring代码层读写分离\ndate: 2021-1-29\ntags:\n\t- Docker\n\t- MYSQL集群\ncategories:\n\t- Spring\ntoc:\n    true\n---\n上节介绍了利用Docker部署MYSQL集群，下面介绍如何利用部署好的master和slave实现Spring代码层的读写分离，保证发生读操作时访问slave结点，发生写操作时访问master结点。\n\n### <span style=\"color:orange;\">1. 实现基础</span>\n\n**a.spring有关数据源路由的源码**\n\n<!--more-->\n\n```java\npackage org.springframework.jdbc.datasource.lookup;\n\nimport java.sql.Connection;\nimport java.sql.SQLException;\nimport java.util.HashMap;\nimport java.util.Iterator;\nimport java.util.Map;\nimport java.util.Map.Entry;\nimport javax.sql.DataSource;\nimport org.springframework.beans.factory.InitializingBean;\nimport org.springframework.jdbc.datasource.AbstractDataSource;\nimport org.springframework.util.Assert;\n\npublic abstract class AbstractRoutingDataSource extends AbstractDataSource implements InitializingBean {\n    private Map<Object, Object> targetDataSources;\n    private Object defaultTargetDataSource;\n    private boolean lenientFallback = true;\n    private DataSourceLookup dataSourceLookup = new JndiDataSourceLookup();\n    private Map<Object, DataSource> resolvedDataSources;\n    private DataSource resolvedDefaultDataSource;\n    \n    protected DataSource determineTargetDataSource() {\n        Assert.notNull(this.resolvedDataSources, \"DataSource router not initialized\");\n        Object lookupKey = this.determineCurrentLookupKey();\n        DataSource dataSource = (DataSource)this.resolvedDataSources.get(lookupKey);\n        if (dataSource == null && (this.lenientFallback || lookupKey == null)) {\n            dataSource = this.resolvedDefaultDataSource;\n        }\n\n        if (dataSource == null) {\n            throw new IllegalStateException(\"Cannot determine target DataSource for lookup key [\" + lookupKey + \"]\");\n        } else {\n            return dataSource;\n        }\n    }\n\n    protected abstract Object determineCurrentLookupKey();\n    \n    ...\n}\n```\n首先看一下在`springframework.jdbc`包下的源码，类名`AbstractRoutingDataSource`（抽象路由数据源），这个虚拟类就是spring提供的提供路由导向的数据库类\n\n- 通过变量Map存储不同方法的数据源\n- `determineTargetDataSource`方法通过调用`determineCurrentLookupKey`来指明使用何种数据库，然后在Map中寻找相应的datasource\n\n我们可以通过实现上面`determineCurrentLookupKey`抽象方法，通过建立一个Map存储master和slave的数据源，通过SQL对应是update还是insert操作，来决定使用何种key，进而调用哪个数据源\n\n\n\n**b.Mybatis提供Interceptor**\n\n```java\npackage org.apache.ibatis.plugin;\n\nimport java.util.Properties;\n\npublic interface Interceptor {\n    Object intercept(Invocation var1) throws Throwable;\n\n    Object plugin(Object var1);\n\n    void setProperties(Properties var1);\n}\n```\n`Interceptor`是mybatis提供一个接口，是拦截类，可以拦截mybatis中的操作\n\n- `plugin`方法：定义拦截何种类型的类，以决定是否织入代理\n- `intercept`方法：定义对拦截下来的类织入的逻辑\n\n通过自定义实现接口中的两个方法，我们可以使用plugin方法仅拦截属于Mybatis底层SQL执行器的类，`interceptor`方法可以编写对应拦截到执行器的执行SQL方法\n\n\n\n\n\n**c.如何将`Interceptor`方法和`determineCurrentLookupKey`方法以及具体不同数据库操作的线程统筹**\n\n这里用到了一个中间人——**ThreadLocal**，通过ThreadLocal来隔绝不同数据库线程的要选择的key。\n具体而言为：Interceptor通过拦截执行器对应的数据库操作，查看是属于读还是写操作，来向ThreadLocal中放入对应线程选择数据源的名字（master or slave），然后通过实现AbstractRoutingDataSource中的determineCurrentLookupKey方法去从ThreadLocal中取对应线程放入的key，然后根据对应的key在Map型变量targetDataSources选择相应的数据源\n\n### <span style=\"color:orange;\">2.实现方式</span>\n**a.DynamicDataSourceHolder类**\n\n主要定义中间人池子ThreadLocal来隔离不同线程放入的key，其中可选择的key定义为静态变量\"master\"和\"slave\"\n```java\npackage com.imooc.o2o.dao.split;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\n/**\n * 池子，放入决定数据源key的池子，其中池子利用ThreadLocal设置为线程安全\n */\npublic class DynamicDataSourceHolder {\n    private static Logger logger = LoggerFactory.getLogger(DynamicDataSourceHolder.class);\n    // 池子，利用ThreadLocal保证线程安全，线程安全是访问同一个变量时容器出现问题，特别多个线程对一个变量进行写入的时候\n    // ThreadLocal是除了加锁之外的另外一种保证多线程访问变量的线程安全方法，即每个线程对变量的访问都是基于线程自己的变量\n    // 也就是说中央变量只有一个，但是每个线程都有一个中央变量的独立拷贝，每个线程只访问修改自己独立拷贝的变量\n    private static ThreadLocal<String> contextHolder = new ThreadLocal<String>();\n    public static String DB_MASTER = \"master\";\n    public static String DB_SLAVE = \"slave\";\n\n    public static String getDbType(){\n        String db = contextHolder.get();\n        if(db == null){\n            db = DB_MASTER;\n        }\n        return db;\n    }\n\n    /**\n     * 设置线程的dbType\n     * @param str\n     */\n    public static void setDbType(String str){\n        logger.debug(\"所使用的数据源为：\" + str);\n        contextHolder.set(str);\n    }\n\n    /**\n     * 清理连接类型\n     */\n    public static void clearDbType(){\n        contextHolder.remove();\n    }\n}\n```\n\n\n\n\n\n**b.DynamicDataSourceInterceptor类**\n\n通过实现Mybatis提供的Interceptor接口来拦截Mybatis执行器Executor，intercept方法定义织入的规则，通过invocation.getArgs()来获取对应线程执行的数据库操作是读操作还是写操作，然后向DynamicDataSourceHolder中的ThreadLocal放入对应线程选择的key，是选择master还是slave\n\n\n\n**读写分离逻辑**\n\n这里首先先判断是否为事务操作\n\n+ 如果是事务操作，会包含一系列增删改查的操作，所以使用master数据库\n\n- 如果不是事务操作，然后再看对应增删改查是读取还是写入操作，从而实现读写分离的逻辑\n```java\npackage com.imooc.o2o.dao.split;\n\nimport org.apache.ibatis.executor.Executor;\nimport org.apache.ibatis.executor.keygen.SelectKeyGenerator;\nimport org.apache.ibatis.mapping.BoundSql;\nimport org.apache.ibatis.mapping.MappedStatement;\nimport org.apache.ibatis.mapping.SqlCommandType;\nimport org.apache.ibatis.plugin.*;\nimport org.apache.ibatis.session.ResultHandler;\nimport org.apache.ibatis.session.RowBounds;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.transaction.support.TransactionSynchronizationManager;\n\nimport java.util.Locale;\nimport java.util.Properties;\n\n/**\n * 拦截器拦截mybatis传递进来的SQL信息，根据SQL信息来使用相应的读写分离的数据源\n */\n// mybatis会把增删改的方法封装在update这个method中\n@Intercepts({@Signature(type=Executor.class, method=\"update\", args={MappedStatement.class, Object.class}),\n@Signature(type=Executor.class, method=\"query\", args={MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class})})\npublic class DynamicDataSourceInterceptor implements Interceptor {\n    private static Logger logger = LoggerFactory.getLogger(DynamicDataSourceInterceptor.class);\n    private static final String REGEX = \".*insert\\\\u0020.*|.*update\\\\u0020.*|.*delete\\\\u0020.*\";\n\n    /**\n     * 织入的规则\n     * @param invocation\n     * @return\n     * @throws Throwable\n     */\n    @Override\n    public Object intercept(Invocation invocation) throws Throwable {\n        // 利用spring提供的，判断当前是不是事务已表明是不是数据库操作\n        boolean synchronizationActive = TransactionSynchronizationManager.isActualTransactionActive();\n        Object[] objects = invocation.getArgs();\n        MappedStatement ms = (MappedStatement)objects[0]; // 参数第一个是解释什么数据库操作\n        String lookupKey = DynamicDataSourceHolder.DB_MASTER;\n        if(synchronizationActive != true){\n            // 读方法，\n            if(ms.getSqlCommandType().equals(SqlCommandType.SELECT)){\n                // selectKey 为自增id查询主键（SELECT LAST_INSERT_ID())方法，使用主库，通常使用自增主键插入数据库操作\n                if(ms.getId().contains(SelectKeyGenerator.SELECT_KEY_SUFFIX)){\n                    lookupKey = DynamicDataSourceHolder.DB_MASTER;\n                }else{\n                    BoundSql boundSql = ms.getSqlSource().getBoundSql(objects[1]);\n                    String sql = boundSql.getSql().toLowerCase(Locale.CHINA).replaceAll(\"[\\\\t\\\\n\\\\r]\", \"\");\n                    if(sql.matches(REGEX)){\n                        lookupKey = DynamicDataSourceHolder.DB_MASTER;\n                    }else{\n                        lookupKey = DynamicDataSourceHolder.DB_SLAVE;\n                    }\n                }\n            }\n        }else{\n            // 因为一般事务操作可能包含增删改查混合操作，所以用master\n            lookupKey = DynamicDataSourceHolder.DB_MASTER;\n        }\n        logger.debug(\"设置方法[{}] use[{}] Strategy,SqlCommandType[{}]...\", ms.getId(), lookupKey, ms.getSqlCommandType().name());\n        DynamicDataSourceHolder.setDbType(lookupKey);\n        return invocation.proceed();\n    }\n\n    /**\n     * 返回封装好的代理对象，决定返回的是本体还是编织好的代理\n     * @param target\n     * @return\n     */\n    @Override\n    public Object plugin(Object target) {\n        // 这里的Executor是mybatis支持一系列增删改查操作的执行器\n        if(target instanceof Executor){\n            // 如果是mybatis的Executor类型，那么就把编入逻辑织入，不是返回本体\n            return Plugin.wrap(target, this);\n        }\n        return target;\n    }\n\n    /**\n     * 非必要\n     * @param properties\n     */\n    @Override\n    public void setProperties(Properties properties) {\n\n    }\n}\n```\n\n\n\n\n**c.DynamicDataSource类**\n\n继承AbstractRoutingDataSource，实现determineCurrentLookupKey方法，从池子中获取对应线程应该选择的数据源名称key，然后在targetDataSource中获取对应的数据源连接给线程（targetDataSource是个Map变量，在spring-dao.xml配置文件中配置）\n```java\npackage com.imooc.o2o.dao.split;\n\nimport org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;\n\n/**\n * 从池子中取key，然后从HashMap<String,DataSource>中用key找到对应的DataSource\n */\npublic class DynamicDataSource extends AbstractRoutingDataSource {\n    @Override\n    protected Object determineCurrentLookupKey() {\n        return DynamicDataSourceHolder.getDbType();\n    }\n}\n\n```\n\n\n### <span style=\"color:orange;\">3.装配</span>\n\n1. mybatis-config中装配拦截器\n\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n<!DOCTYPE configuration\n        PUBLIC \"-//mybatis.org//DTD Config 3.0//EN\"\n        \"http://mybatis.org/dtd/mybatis-3-config.dtd\">\n<configuration>\n    <!-- 配置全局属性 -->\n    <settings>\n        <!-- 使用jdbc的getGeneratedKeys获取数据库自增主键值 -->\n        <setting name=\"useGeneratedKeys\" value=\"true\"/>\n\n        <!-- 使用列标签（数据库列名）替换列名（查询语句名字） 默认:true -->\n        <setting name=\"useColumnLabel\" value=\"true\"/>\n\n        <!-- 开启驼峰命名转换:Table{create_time} -> Entity{createTime} -->\n        <setting name=\"mapUnderscoreToCamelCase\" value=\"true\"/>\n    </settings>\n\n    <!--自定义读写分离拦截器-->\n    <plugins>\n        <plugin interceptor=\"com.imooc.o2o.dao.split.DynamicDataSourceInterceptor\"/>\n    </plugins>\n</configuration>\n```\n\n2. spring-dao.xml配置路由数据源\n\n* 设置abstract为true的连接池，定义为abstract是为了后边继承通用的连接池属性\n\n- 定义好master和slave的数据源连接配置，指明parent为上面abstract的连接池\n- 将继承实现AbstractRoutingDataSourc    e的类，配置好Map变量targetDataSource\n- 定义为懒加载，因为只在SQL语句正式执行的时候才指定出来dataSource\n\njdbc.properties文件：\n\n\tjdbc.master.driver=com.mysql.cj.jdbc.Driver\n\tjdbc.master.url=jdbc:mysql://localhost:10001/o2o?useUnicode=true&characterEncoding=utf8\n\tjdbc.master.username=root\n\tjdbc.master.password=make1234\n\tjdbc.slave.driver=com.mysql.cj.jdbc.Driver\n\tjdbc.slave.url=jdbc:mysql://localhost:10002/o2o?useUnicode=true&characterEncoding=utf8\n\tjdbc.slave.username=root\n\tjdbc.slave.password=make1234\nspring-dao.xml文件：\n\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<beans xmlns=\"http://www.springframework.org/schema/beans\"\n       xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n       xmlns:context=\"http://www.springframework.org/schema/context\"\n       xmlns:p=\"http://www.springframework.org/schema/p\" xmlns:bean=\"http://www.springframework.org/schema/context\"\n       xsi:schemaLocation=\"http://www.springframework.org/schema/beans\n       http://www.springframework.org/schema/beans/spring-beans.xsd\n       http://www.springframework.org/schema/context\n       http://www.springframework.org/schema/context/spring-context.xsd\">\n\n    <context:component-scan base-package=\"com.imooc.o2o.dao\"/>\n\n    <!--配置数据库properties的数据-->\n    <context:property-placeholder location=\"classpath:jdbc.properties\"/>\n\n    <!--1.数据库连接池，设置为abstract，便于后面继承属性配置主从库-->\n    <bean id=\"abstractDataSource\" class=\"com.mchange.v2.c3p0.ComboPooledDataSource\"\n        abstract=\"true\" destroy-method=\"close\">\n        <!--c3p0连接池的私有属性-->\n        <property name=\"maxPoolSize\" value=\"30\"/>\n        <property name=\"minPoolSize\" value=\"10\"/>\n        <!--关闭连接后不自动commit-->\n        <property name=\"autoCommitOnClose\" value=\"false\"/>\n        <!--获取连接的超时时间-->\n        <property name=\"checkoutTimeout\" value=\"10000\"/>\n        <!--当获取连接失败重试次数-->\n        <property name=\"acquireRetryAttempts\" value=\"10\"/>\n    </bean>\n\n    <!--2.主库配置-->\n    <bean id=\"master\" parent=\"abstractDataSource\">\n        <!--配置连接池属性-->\n        <property name=\"driverClass\" value=\"${jdbc.master.driver}\"/>\n        <property name=\"jdbcUrl\" value=\"${jdbc.master.url}\"/>\n        <property name=\"user\" value=\"${jdbc.master.username}\"/>\n        <property name=\"password\" value=\"${jdbc.master.password}\"/>\n    </bean>\n\n    <!--3.从库配置-->\n    <bean id=\"slave\" parent=\"abstractDataSource\">\n        <!--配置连接池属性-->\n        <property name=\"driverClass\" value=\"${jdbc.slave.driver}\"/>\n        <property name=\"jdbcUrl\" value=\"${jdbc.slave.url}\"/>\n        <property name=\"user\" value=\"${jdbc.slave.username}\"/>\n        <property name=\"password\" value=\"${jdbc.slave.password}\"/>\n    </bean>\n\n    <!--4.配置动态数据源，这儿的targetDataSource就是路由数据源所对应的名称-->\n    <bean id=\"dynamicDataSource\" class=\"com.imooc.o2o.dao.split.DynamicDataSource\">\n        <!--将数据源放入到map中，这里的key要与com.imooc.o2o.dao.split.DynamicDataSourceHolder中的key相同-->\n        <property name=\"targetDataSources\">\n            <map>\n                <entry value-ref=\"master\" key=\"master\"></entry>\n                <entry value-ref=\"slave\" key=\"slave\"></entry>\n            </map>\n        </property>\n    </bean>\n\n    <!--5.懒加载，需要在SQL语句正式执行的时候才指定出来dataSource-->\n    <bean id=\"dataSource\" class=\"org.springframework.jdbc.datasource.LazyConnectionDataSourceProxy\">\n        <property name=\"targetDataSource\">\n            <ref bean=\"dynamicDataSource\"></ref>\n        </property>\n    </bean>\n\n    <!--配置SqlSessionFactory对象-->\n    <!--MyBatis全局配置文件-->\n    <!--扫描entity包，将取出结果包装成entity对象-->\n    <!--扫描Sql配置文件-->\n    <bean id=\"sqlSessionFactory\" class=\"org.mybatis.spring.SqlSessionFactoryBean\"\n          p:dataSource-ref=\"dataSource\"\n          p:configLocation=\"classpath:mybatis-config.xml\"\n          p:typeAliasesPackage=\"com.imooc.o2o.entity\"\n          p:mapperLocations=\"classpath:mapper/*.xml\"/>\n\n    <!--配置扫描Dao接口包，动态实现Dao接口，注入到Spring容器中-->\n    <bean class=\"org.mybatis.spring.mapper.MapperScannerConfigurer\">\n        <!--注入SqlSessionFactory-->\n        <property name=\"sqlSessionFactoryBeanName\" value=\"sqlSessionFactory\"/>\n        <!--给出需要扫描Dao接口包-->\n        <property name=\"basePackage\" value=\"com.imooc.o2o.dao\"/>\n    </bean>\n</beans>\n```\n\n","slug":"docker配置Mysql集群(下)——Spring代码层读写分离","published":1,"updated":"2021-02-23T01:56:35.398Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl2enrqzu0018y2loe4jx2aju","content":"<p>上节介绍了利用Docker部署MYSQL集群，下面介绍如何利用部署好的master和slave实现Spring代码层的读写分离，保证发生读操作时访问slave结点，发生写操作时访问master结点。</p>\n<h3 id=\"1-实现基础\"><a href=\"#1-实现基础\" class=\"headerlink\" title=\"1. 实现基础\"></a><span style=\"color:orange;\">1. 实现基础</span></h3><p><strong>a.spring有关数据源路由的源码</strong></p>\n<a id=\"more\"></a>\n\n<pre><code class=\"java\">package org.springframework.jdbc.datasource.lookup;\n\nimport java.sql.Connection;\nimport java.sql.SQLException;\nimport java.util.HashMap;\nimport java.util.Iterator;\nimport java.util.Map;\nimport java.util.Map.Entry;\nimport javax.sql.DataSource;\nimport org.springframework.beans.factory.InitializingBean;\nimport org.springframework.jdbc.datasource.AbstractDataSource;\nimport org.springframework.util.Assert;\n\npublic abstract class AbstractRoutingDataSource extends AbstractDataSource implements InitializingBean &#123;\n    private Map&lt;Object, Object&gt; targetDataSources;\n    private Object defaultTargetDataSource;\n    private boolean lenientFallback = true;\n    private DataSourceLookup dataSourceLookup = new JndiDataSourceLookup();\n    private Map&lt;Object, DataSource&gt; resolvedDataSources;\n    private DataSource resolvedDefaultDataSource;\n    \n    protected DataSource determineTargetDataSource() &#123;\n        Assert.notNull(this.resolvedDataSources, &quot;DataSource router not initialized&quot;);\n        Object lookupKey = this.determineCurrentLookupKey();\n        DataSource dataSource = (DataSource)this.resolvedDataSources.get(lookupKey);\n        if (dataSource == null &amp;&amp; (this.lenientFallback || lookupKey == null)) &#123;\n            dataSource = this.resolvedDefaultDataSource;\n        &#125;\n\n        if (dataSource == null) &#123;\n            throw new IllegalStateException(&quot;Cannot determine target DataSource for lookup key [&quot; + lookupKey + &quot;]&quot;);\n        &#125; else &#123;\n            return dataSource;\n        &#125;\n    &#125;\n\n    protected abstract Object determineCurrentLookupKey();\n    \n    ...\n&#125;\n</code></pre>\n<p>首先看一下在<code>springframework.jdbc</code>包下的源码，类名<code>AbstractRoutingDataSource</code>（抽象路由数据源），这个虚拟类就是spring提供的提供路由导向的数据库类</p>\n<ul>\n<li>通过变量Map存储不同方法的数据源</li>\n<li><code>determineTargetDataSource</code>方法通过调用<code>determineCurrentLookupKey</code>来指明使用何种数据库，然后在Map中寻找相应的datasource</li>\n</ul>\n<p>我们可以通过实现上面<code>determineCurrentLookupKey</code>抽象方法，通过建立一个Map存储master和slave的数据源，通过SQL对应是update还是insert操作，来决定使用何种key，进而调用哪个数据源</p>\n<p><strong>b.Mybatis提供Interceptor</strong></p>\n<pre><code class=\"java\">package org.apache.ibatis.plugin;\n\nimport java.util.Properties;\n\npublic interface Interceptor &#123;\n    Object intercept(Invocation var1) throws Throwable;\n\n    Object plugin(Object var1);\n\n    void setProperties(Properties var1);\n&#125;\n</code></pre>\n<p><code>Interceptor</code>是mybatis提供一个接口，是拦截类，可以拦截mybatis中的操作</p>\n<ul>\n<li><code>plugin</code>方法：定义拦截何种类型的类，以决定是否织入代理</li>\n<li><code>intercept</code>方法：定义对拦截下来的类织入的逻辑</li>\n</ul>\n<p>通过自定义实现接口中的两个方法，我们可以使用plugin方法仅拦截属于Mybatis底层SQL执行器的类，<code>interceptor</code>方法可以编写对应拦截到执行器的执行SQL方法</p>\n<p><strong>c.如何将<code>Interceptor</code>方法和<code>determineCurrentLookupKey</code>方法以及具体不同数据库操作的线程统筹</strong></p>\n<p>这里用到了一个中间人——<strong>ThreadLocal</strong>，通过ThreadLocal来隔绝不同数据库线程的要选择的key。<br>具体而言为：Interceptor通过拦截执行器对应的数据库操作，查看是属于读还是写操作，来向ThreadLocal中放入对应线程选择数据源的名字（master or slave），然后通过实现AbstractRoutingDataSource中的determineCurrentLookupKey方法去从ThreadLocal中取对应线程放入的key，然后根据对应的key在Map型变量targetDataSources选择相应的数据源</p>\n<h3 id=\"2-实现方式\"><a href=\"#2-实现方式\" class=\"headerlink\" title=\"2.实现方式\"></a><span style=\"color:orange;\">2.实现方式</span></h3><p><strong>a.DynamicDataSourceHolder类</strong></p>\n<p>主要定义中间人池子ThreadLocal来隔离不同线程放入的key，其中可选择的key定义为静态变量”master”和”slave”</p>\n<pre><code class=\"java\">package com.imooc.o2o.dao.split;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\n/**\n * 池子，放入决定数据源key的池子，其中池子利用ThreadLocal设置为线程安全\n */\npublic class DynamicDataSourceHolder &#123;\n    private static Logger logger = LoggerFactory.getLogger(DynamicDataSourceHolder.class);\n    // 池子，利用ThreadLocal保证线程安全，线程安全是访问同一个变量时容器出现问题，特别多个线程对一个变量进行写入的时候\n    // ThreadLocal是除了加锁之外的另外一种保证多线程访问变量的线程安全方法，即每个线程对变量的访问都是基于线程自己的变量\n    // 也就是说中央变量只有一个，但是每个线程都有一个中央变量的独立拷贝，每个线程只访问修改自己独立拷贝的变量\n    private static ThreadLocal&lt;String&gt; contextHolder = new ThreadLocal&lt;String&gt;();\n    public static String DB_MASTER = &quot;master&quot;;\n    public static String DB_SLAVE = &quot;slave&quot;;\n\n    public static String getDbType()&#123;\n        String db = contextHolder.get();\n        if(db == null)&#123;\n            db = DB_MASTER;\n        &#125;\n        return db;\n    &#125;\n\n    /**\n     * 设置线程的dbType\n     * @param str\n     */\n    public static void setDbType(String str)&#123;\n        logger.debug(&quot;所使用的数据源为：&quot; + str);\n        contextHolder.set(str);\n    &#125;\n\n    /**\n     * 清理连接类型\n     */\n    public static void clearDbType()&#123;\n        contextHolder.remove();\n    &#125;\n&#125;\n</code></pre>\n<p><strong>b.DynamicDataSourceInterceptor类</strong></p>\n<p>通过实现Mybatis提供的Interceptor接口来拦截Mybatis执行器Executor，intercept方法定义织入的规则，通过invocation.getArgs()来获取对应线程执行的数据库操作是读操作还是写操作，然后向DynamicDataSourceHolder中的ThreadLocal放入对应线程选择的key，是选择master还是slave</p>\n<p><strong>读写分离逻辑</strong></p>\n<p>这里首先先判断是否为事务操作</p>\n<ul>\n<li>如果是事务操作，会包含一系列增删改查的操作，所以使用master数据库</li>\n</ul>\n<ul>\n<li>如果不是事务操作，然后再看对应增删改查是读取还是写入操作，从而实现读写分离的逻辑<pre><code class=\"java\">package com.imooc.o2o.dao.split;\n</code></pre>\n</li>\n</ul>\n<p>import org.apache.ibatis.executor.Executor;<br>import org.apache.ibatis.executor.keygen.SelectKeyGenerator;<br>import org.apache.ibatis.mapping.BoundSql;<br>import org.apache.ibatis.mapping.MappedStatement;<br>import org.apache.ibatis.mapping.SqlCommandType;<br>import org.apache.ibatis.plugin.*;<br>import org.apache.ibatis.session.ResultHandler;<br>import org.apache.ibatis.session.RowBounds;<br>import org.slf4j.Logger;<br>import org.slf4j.LoggerFactory;<br>import org.springframework.transaction.support.TransactionSynchronizationManager;</p>\n<p>import java.util.Locale;<br>import java.util.Properties;</p>\n<p>/**</p>\n<ul>\n<li><p>拦截器拦截mybatis传递进来的SQL信息，根据SQL信息来使用相应的读写分离的数据源</p>\n</li>\n<li><p>/<br>// mybatis会把增删改的方法封装在update这个method中<br>@Intercepts({@Signature(type=Executor.class, method=”update”, args={MappedStatement.class, Object.class}),<br>@Signature(type=Executor.class, method=”query”, args={MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class})})<br>public class DynamicDataSourceInterceptor implements Interceptor {<br>  private static Logger logger = LoggerFactory.getLogger(DynamicDataSourceInterceptor.class);<br>  private static final String REGEX = “.<em>insert\\u0020.</em>|.<em>update\\u0020.</em>|.<em>delete\\u0020.</em>“;</p>\n<p>  /**</p>\n<ul>\n<li><p>织入的规则</p>\n</li>\n<li><p>@param invocation</p>\n</li>\n<li><p>@return</p>\n</li>\n<li><p>@throws Throwable</p>\n</li>\n<li><p>/<br>@Override<br>public Object intercept(Invocation invocation) throws Throwable {<br>  // 利用spring提供的，判断当前是不是事务已表明是不是数据库操作<br>  boolean synchronizationActive = TransactionSynchronizationManager.isActualTransactionActive();<br>  Object[] objects = invocation.getArgs();<br>  MappedStatement ms = (MappedStatement)objects[0]; // 参数第一个是解释什么数据库操作<br>  String lookupKey = DynamicDataSourceHolder.DB_MASTER;<br>  if(synchronizationActive != true){</p>\n<pre><code>  // 读方法，\n  if(ms.getSqlCommandType().equals(SqlCommandType.SELECT))&#123;\n      // selectKey 为自增id查询主键（SELECT LAST_INSERT_ID())方法，使用主库，通常使用自增主键插入数据库操作\n      if(ms.getId().contains(SelectKeyGenerator.SELECT_KEY_SUFFIX))&#123;\n          lookupKey = DynamicDataSourceHolder.DB_MASTER;\n      &#125;else&#123;\n          BoundSql boundSql = ms.getSqlSource().getBoundSql(objects[1]);\n          String sql = boundSql.getSql().toLowerCase(Locale.CHINA).replaceAll(&quot;[\\\\t\\\\n\\\\r]&quot;, &quot;&quot;);\n          if(sql.matches(REGEX))&#123;\n              lookupKey = DynamicDataSourceHolder.DB_MASTER;\n          &#125;else&#123;\n              lookupKey = DynamicDataSourceHolder.DB_SLAVE;\n          &#125;\n      &#125;\n  &#125;\n</code></pre>\n<p>  }else{</p>\n<pre><code>  // 因为一般事务操作可能包含增删改查混合操作，所以用master\n  lookupKey = DynamicDataSourceHolder.DB_MASTER;\n</code></pre>\n<p>  }<br>  logger.debug(“设置方法[{}] use[{}] Strategy,SqlCommandType[{}]…”, ms.getId(), lookupKey, ms.getSqlCommandType().name());<br>  DynamicDataSourceHolder.setDbType(lookupKey);<br>  return invocation.proceed();<br>}</p>\n<p>/**</p>\n</li>\n<li><p>返回封装好的代理对象，决定返回的是本体还是编织好的代理</p>\n</li>\n<li><p>@param target</p>\n</li>\n<li><p>@return</p>\n</li>\n<li><p>/<br>@Override<br>public Object plugin(Object target) {<br>  // 这里的Executor是mybatis支持一系列增删改查操作的执行器<br>  if(target instanceof Executor){</p>\n<pre><code>  // 如果是mybatis的Executor类型，那么就把编入逻辑织入，不是返回本体\n  return Plugin.wrap(target, this);\n</code></pre>\n<p>  }<br>  return target;<br>}</p>\n<p>/**</p>\n</li>\n<li><p>非必要</p>\n</li>\n<li><p>@param properties</p>\n</li>\n<li><p>/<br>@Override<br>public void setProperties(Properties properties) {</p>\n<p>}<br>}</p>\n<pre><code>\n\n\n</code></pre>\n</li>\n</ul>\n</li>\n</ul>\n<p><strong>c.DynamicDataSource类</strong></p>\n<p>继承AbstractRoutingDataSource，实现determineCurrentLookupKey方法，从池子中获取对应线程应该选择的数据源名称key，然后在targetDataSource中获取对应的数据源连接给线程（targetDataSource是个Map变量，在spring-dao.xml配置文件中配置）</p>\n<pre><code class=\"java\">package com.imooc.o2o.dao.split;\n\nimport org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;\n\n/**\n * 从池子中取key，然后从HashMap&lt;String,DataSource&gt;中用key找到对应的DataSource\n */\npublic class DynamicDataSource extends AbstractRoutingDataSource &#123;\n    @Override\n    protected Object determineCurrentLookupKey() &#123;\n        return DynamicDataSourceHolder.getDbType();\n    &#125;\n&#125;\n</code></pre>\n<h3 id=\"3-装配\"><a href=\"#3-装配\" class=\"headerlink\" title=\"3.装配\"></a><span style=\"color:orange;\">3.装配</span></h3><ol>\n<li>mybatis-config中装配拦截器</li>\n</ol>\n<pre><code class=\"xml\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;\n&lt;!DOCTYPE configuration\n        PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot;\n        &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;\n&lt;configuration&gt;\n    &lt;!-- 配置全局属性 --&gt;\n    &lt;settings&gt;\n        &lt;!-- 使用jdbc的getGeneratedKeys获取数据库自增主键值 --&gt;\n        &lt;setting name=&quot;useGeneratedKeys&quot; value=&quot;true&quot;/&gt;\n\n        &lt;!-- 使用列标签（数据库列名）替换列名（查询语句名字） 默认:true --&gt;\n        &lt;setting name=&quot;useColumnLabel&quot; value=&quot;true&quot;/&gt;\n\n        &lt;!-- 开启驼峰命名转换:Table&#123;create_time&#125; -&gt; Entity&#123;createTime&#125; --&gt;\n        &lt;setting name=&quot;mapUnderscoreToCamelCase&quot; value=&quot;true&quot;/&gt;\n    &lt;/settings&gt;\n\n    &lt;!--自定义读写分离拦截器--&gt;\n    &lt;plugins&gt;\n        &lt;plugin interceptor=&quot;com.imooc.o2o.dao.split.DynamicDataSourceInterceptor&quot;/&gt;\n    &lt;/plugins&gt;\n&lt;/configuration&gt;\n</code></pre>\n<ol start=\"2\">\n<li>spring-dao.xml配置路由数据源</li>\n</ol>\n<ul>\n<li>设置abstract为true的连接池，定义为abstract是为了后边继承通用的连接池属性</li>\n</ul>\n<ul>\n<li>定义好master和slave的数据源连接配置，指明parent为上面abstract的连接池</li>\n<li>将继承实现AbstractRoutingDataSourc    e的类，配置好Map变量targetDataSource</li>\n<li>定义为懒加载，因为只在SQL语句正式执行的时候才指定出来dataSource</li>\n</ul>\n<p>jdbc.properties文件：</p>\n<pre><code>jdbc.master.driver=com.mysql.cj.jdbc.Driver\njdbc.master.url=jdbc:mysql://localhost:10001/o2o?useUnicode=true&amp;characterEncoding=utf8\njdbc.master.username=root\njdbc.master.password=make1234\njdbc.slave.driver=com.mysql.cj.jdbc.Driver\njdbc.slave.url=jdbc:mysql://localhost:10002/o2o?useUnicode=true&amp;characterEncoding=utf8\njdbc.slave.username=root\njdbc.slave.password=make1234\n</code></pre>\n<p>spring-dao.xml文件：</p>\n<pre><code class=\"xml\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;\n       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;\n       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;\n       xmlns:p=&quot;http://www.springframework.org/schema/p&quot; xmlns:bean=&quot;http://www.springframework.org/schema/context&quot;\n       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans\n       http://www.springframework.org/schema/beans/spring-beans.xsd\n       http://www.springframework.org/schema/context\n       http://www.springframework.org/schema/context/spring-context.xsd&quot;&gt;\n\n    &lt;context:component-scan base-package=&quot;com.imooc.o2o.dao&quot;/&gt;\n\n    &lt;!--配置数据库properties的数据--&gt;\n    &lt;context:property-placeholder location=&quot;classpath:jdbc.properties&quot;/&gt;\n\n    &lt;!--1.数据库连接池，设置为abstract，便于后面继承属性配置主从库--&gt;\n    &lt;bean id=&quot;abstractDataSource&quot; class=&quot;com.mchange.v2.c3p0.ComboPooledDataSource&quot;\n        abstract=&quot;true&quot; destroy-method=&quot;close&quot;&gt;\n        &lt;!--c3p0连接池的私有属性--&gt;\n        &lt;property name=&quot;maxPoolSize&quot; value=&quot;30&quot;/&gt;\n        &lt;property name=&quot;minPoolSize&quot; value=&quot;10&quot;/&gt;\n        &lt;!--关闭连接后不自动commit--&gt;\n        &lt;property name=&quot;autoCommitOnClose&quot; value=&quot;false&quot;/&gt;\n        &lt;!--获取连接的超时时间--&gt;\n        &lt;property name=&quot;checkoutTimeout&quot; value=&quot;10000&quot;/&gt;\n        &lt;!--当获取连接失败重试次数--&gt;\n        &lt;property name=&quot;acquireRetryAttempts&quot; value=&quot;10&quot;/&gt;\n    &lt;/bean&gt;\n\n    &lt;!--2.主库配置--&gt;\n    &lt;bean id=&quot;master&quot; parent=&quot;abstractDataSource&quot;&gt;\n        &lt;!--配置连接池属性--&gt;\n        &lt;property name=&quot;driverClass&quot; value=&quot;$&#123;jdbc.master.driver&#125;&quot;/&gt;\n        &lt;property name=&quot;jdbcUrl&quot; value=&quot;$&#123;jdbc.master.url&#125;&quot;/&gt;\n        &lt;property name=&quot;user&quot; value=&quot;$&#123;jdbc.master.username&#125;&quot;/&gt;\n        &lt;property name=&quot;password&quot; value=&quot;$&#123;jdbc.master.password&#125;&quot;/&gt;\n    &lt;/bean&gt;\n\n    &lt;!--3.从库配置--&gt;\n    &lt;bean id=&quot;slave&quot; parent=&quot;abstractDataSource&quot;&gt;\n        &lt;!--配置连接池属性--&gt;\n        &lt;property name=&quot;driverClass&quot; value=&quot;$&#123;jdbc.slave.driver&#125;&quot;/&gt;\n        &lt;property name=&quot;jdbcUrl&quot; value=&quot;$&#123;jdbc.slave.url&#125;&quot;/&gt;\n        &lt;property name=&quot;user&quot; value=&quot;$&#123;jdbc.slave.username&#125;&quot;/&gt;\n        &lt;property name=&quot;password&quot; value=&quot;$&#123;jdbc.slave.password&#125;&quot;/&gt;\n    &lt;/bean&gt;\n\n    &lt;!--4.配置动态数据源，这儿的targetDataSource就是路由数据源所对应的名称--&gt;\n    &lt;bean id=&quot;dynamicDataSource&quot; class=&quot;com.imooc.o2o.dao.split.DynamicDataSource&quot;&gt;\n        &lt;!--将数据源放入到map中，这里的key要与com.imooc.o2o.dao.split.DynamicDataSourceHolder中的key相同--&gt;\n        &lt;property name=&quot;targetDataSources&quot;&gt;\n            &lt;map&gt;\n                &lt;entry value-ref=&quot;master&quot; key=&quot;master&quot;&gt;&lt;/entry&gt;\n                &lt;entry value-ref=&quot;slave&quot; key=&quot;slave&quot;&gt;&lt;/entry&gt;\n            &lt;/map&gt;\n        &lt;/property&gt;\n    &lt;/bean&gt;\n\n    &lt;!--5.懒加载，需要在SQL语句正式执行的时候才指定出来dataSource--&gt;\n    &lt;bean id=&quot;dataSource&quot; class=&quot;org.springframework.jdbc.datasource.LazyConnectionDataSourceProxy&quot;&gt;\n        &lt;property name=&quot;targetDataSource&quot;&gt;\n            &lt;ref bean=&quot;dynamicDataSource&quot;&gt;&lt;/ref&gt;\n        &lt;/property&gt;\n    &lt;/bean&gt;\n\n    &lt;!--配置SqlSessionFactory对象--&gt;\n    &lt;!--MyBatis全局配置文件--&gt;\n    &lt;!--扫描entity包，将取出结果包装成entity对象--&gt;\n    &lt;!--扫描Sql配置文件--&gt;\n    &lt;bean id=&quot;sqlSessionFactory&quot; class=&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;\n          p:dataSource-ref=&quot;dataSource&quot;\n          p:configLocation=&quot;classpath:mybatis-config.xml&quot;\n          p:typeAliasesPackage=&quot;com.imooc.o2o.entity&quot;\n          p:mapperLocations=&quot;classpath:mapper/*.xml&quot;/&gt;\n\n    &lt;!--配置扫描Dao接口包，动态实现Dao接口，注入到Spring容器中--&gt;\n    &lt;bean class=&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;&gt;\n        &lt;!--注入SqlSessionFactory--&gt;\n        &lt;property name=&quot;sqlSessionFactoryBeanName&quot; value=&quot;sqlSessionFactory&quot;/&gt;\n        &lt;!--给出需要扫描Dao接口包--&gt;\n        &lt;property name=&quot;basePackage&quot; value=&quot;com.imooc.o2o.dao&quot;/&gt;\n    &lt;/bean&gt;\n&lt;/beans&gt;\n</code></pre>\n","site":{"data":{"photography":[{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","title":"玉渊潭","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","title":"花儿","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","title":"白塔寺","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"}]}},"excerpt":"<p>上节介绍了利用Docker部署MYSQL集群，下面介绍如何利用部署好的master和slave实现Spring代码层的读写分离，保证发生读操作时访问slave结点，发生写操作时访问master结点。</p>\n<h3 id=\"1-实现基础\"><a href=\"#1-实现基础\" class=\"headerlink\" title=\"1. 实现基础\"></a><span style=\"color:orange;\">1. 实现基础</span></h3><p><strong>a.spring有关数据源路由的源码</strong></p>","more":"<pre><code class=\"java\">package org.springframework.jdbc.datasource.lookup;\n\nimport java.sql.Connection;\nimport java.sql.SQLException;\nimport java.util.HashMap;\nimport java.util.Iterator;\nimport java.util.Map;\nimport java.util.Map.Entry;\nimport javax.sql.DataSource;\nimport org.springframework.beans.factory.InitializingBean;\nimport org.springframework.jdbc.datasource.AbstractDataSource;\nimport org.springframework.util.Assert;\n\npublic abstract class AbstractRoutingDataSource extends AbstractDataSource implements InitializingBean &#123;\n    private Map&lt;Object, Object&gt; targetDataSources;\n    private Object defaultTargetDataSource;\n    private boolean lenientFallback = true;\n    private DataSourceLookup dataSourceLookup = new JndiDataSourceLookup();\n    private Map&lt;Object, DataSource&gt; resolvedDataSources;\n    private DataSource resolvedDefaultDataSource;\n    \n    protected DataSource determineTargetDataSource() &#123;\n        Assert.notNull(this.resolvedDataSources, &quot;DataSource router not initialized&quot;);\n        Object lookupKey = this.determineCurrentLookupKey();\n        DataSource dataSource = (DataSource)this.resolvedDataSources.get(lookupKey);\n        if (dataSource == null &amp;&amp; (this.lenientFallback || lookupKey == null)) &#123;\n            dataSource = this.resolvedDefaultDataSource;\n        &#125;\n\n        if (dataSource == null) &#123;\n            throw new IllegalStateException(&quot;Cannot determine target DataSource for lookup key [&quot; + lookupKey + &quot;]&quot;);\n        &#125; else &#123;\n            return dataSource;\n        &#125;\n    &#125;\n\n    protected abstract Object determineCurrentLookupKey();\n    \n    ...\n&#125;\n</code></pre>\n<p>首先看一下在<code>springframework.jdbc</code>包下的源码，类名<code>AbstractRoutingDataSource</code>（抽象路由数据源），这个虚拟类就是spring提供的提供路由导向的数据库类</p>\n<ul>\n<li>通过变量Map存储不同方法的数据源</li>\n<li><code>determineTargetDataSource</code>方法通过调用<code>determineCurrentLookupKey</code>来指明使用何种数据库，然后在Map中寻找相应的datasource</li>\n</ul>\n<p>我们可以通过实现上面<code>determineCurrentLookupKey</code>抽象方法，通过建立一个Map存储master和slave的数据源，通过SQL对应是update还是insert操作，来决定使用何种key，进而调用哪个数据源</p>\n<p><strong>b.Mybatis提供Interceptor</strong></p>\n<pre><code class=\"java\">package org.apache.ibatis.plugin;\n\nimport java.util.Properties;\n\npublic interface Interceptor &#123;\n    Object intercept(Invocation var1) throws Throwable;\n\n    Object plugin(Object var1);\n\n    void setProperties(Properties var1);\n&#125;\n</code></pre>\n<p><code>Interceptor</code>是mybatis提供一个接口，是拦截类，可以拦截mybatis中的操作</p>\n<ul>\n<li><code>plugin</code>方法：定义拦截何种类型的类，以决定是否织入代理</li>\n<li><code>intercept</code>方法：定义对拦截下来的类织入的逻辑</li>\n</ul>\n<p>通过自定义实现接口中的两个方法，我们可以使用plugin方法仅拦截属于Mybatis底层SQL执行器的类，<code>interceptor</code>方法可以编写对应拦截到执行器的执行SQL方法</p>\n<p><strong>c.如何将<code>Interceptor</code>方法和<code>determineCurrentLookupKey</code>方法以及具体不同数据库操作的线程统筹</strong></p>\n<p>这里用到了一个中间人——<strong>ThreadLocal</strong>，通过ThreadLocal来隔绝不同数据库线程的要选择的key。<br>具体而言为：Interceptor通过拦截执行器对应的数据库操作，查看是属于读还是写操作，来向ThreadLocal中放入对应线程选择数据源的名字（master or slave），然后通过实现AbstractRoutingDataSource中的determineCurrentLookupKey方法去从ThreadLocal中取对应线程放入的key，然后根据对应的key在Map型变量targetDataSources选择相应的数据源</p>\n<h3 id=\"2-实现方式\"><a href=\"#2-实现方式\" class=\"headerlink\" title=\"2.实现方式\"></a><span style=\"color:orange;\">2.实现方式</span></h3><p><strong>a.DynamicDataSourceHolder类</strong></p>\n<p>主要定义中间人池子ThreadLocal来隔离不同线程放入的key，其中可选择的key定义为静态变量”master”和”slave”</p>\n<pre><code class=\"java\">package com.imooc.o2o.dao.split;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\n/**\n * 池子，放入决定数据源key的池子，其中池子利用ThreadLocal设置为线程安全\n */\npublic class DynamicDataSourceHolder &#123;\n    private static Logger logger = LoggerFactory.getLogger(DynamicDataSourceHolder.class);\n    // 池子，利用ThreadLocal保证线程安全，线程安全是访问同一个变量时容器出现问题，特别多个线程对一个变量进行写入的时候\n    // ThreadLocal是除了加锁之外的另外一种保证多线程访问变量的线程安全方法，即每个线程对变量的访问都是基于线程自己的变量\n    // 也就是说中央变量只有一个，但是每个线程都有一个中央变量的独立拷贝，每个线程只访问修改自己独立拷贝的变量\n    private static ThreadLocal&lt;String&gt; contextHolder = new ThreadLocal&lt;String&gt;();\n    public static String DB_MASTER = &quot;master&quot;;\n    public static String DB_SLAVE = &quot;slave&quot;;\n\n    public static String getDbType()&#123;\n        String db = contextHolder.get();\n        if(db == null)&#123;\n            db = DB_MASTER;\n        &#125;\n        return db;\n    &#125;\n\n    /**\n     * 设置线程的dbType\n     * @param str\n     */\n    public static void setDbType(String str)&#123;\n        logger.debug(&quot;所使用的数据源为：&quot; + str);\n        contextHolder.set(str);\n    &#125;\n\n    /**\n     * 清理连接类型\n     */\n    public static void clearDbType()&#123;\n        contextHolder.remove();\n    &#125;\n&#125;\n</code></pre>\n<p><strong>b.DynamicDataSourceInterceptor类</strong></p>\n<p>通过实现Mybatis提供的Interceptor接口来拦截Mybatis执行器Executor，intercept方法定义织入的规则，通过invocation.getArgs()来获取对应线程执行的数据库操作是读操作还是写操作，然后向DynamicDataSourceHolder中的ThreadLocal放入对应线程选择的key，是选择master还是slave</p>\n<p><strong>读写分离逻辑</strong></p>\n<p>这里首先先判断是否为事务操作</p>\n<ul>\n<li>如果是事务操作，会包含一系列增删改查的操作，所以使用master数据库</li>\n</ul>\n<ul>\n<li>如果不是事务操作，然后再看对应增删改查是读取还是写入操作，从而实现读写分离的逻辑<pre><code class=\"java\">package com.imooc.o2o.dao.split;\n</code></pre>\n</li>\n</ul>\n<p>import org.apache.ibatis.executor.Executor;<br>import org.apache.ibatis.executor.keygen.SelectKeyGenerator;<br>import org.apache.ibatis.mapping.BoundSql;<br>import org.apache.ibatis.mapping.MappedStatement;<br>import org.apache.ibatis.mapping.SqlCommandType;<br>import org.apache.ibatis.plugin.*;<br>import org.apache.ibatis.session.ResultHandler;<br>import org.apache.ibatis.session.RowBounds;<br>import org.slf4j.Logger;<br>import org.slf4j.LoggerFactory;<br>import org.springframework.transaction.support.TransactionSynchronizationManager;</p>\n<p>import java.util.Locale;<br>import java.util.Properties;</p>\n<p>/**</p>\n<ul>\n<li><p>拦截器拦截mybatis传递进来的SQL信息，根据SQL信息来使用相应的读写分离的数据源</p>\n</li>\n<li><p>/<br>// mybatis会把增删改的方法封装在update这个method中<br>@Intercepts({@Signature(type=Executor.class, method=”update”, args={MappedStatement.class, Object.class}),<br>@Signature(type=Executor.class, method=”query”, args={MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class})})<br>public class DynamicDataSourceInterceptor implements Interceptor {<br>  private static Logger logger = LoggerFactory.getLogger(DynamicDataSourceInterceptor.class);<br>  private static final String REGEX = “.<em>insert\\u0020.</em>|.<em>update\\u0020.</em>|.<em>delete\\u0020.</em>“;</p>\n<p>  /**</p>\n<ul>\n<li><p>织入的规则</p>\n</li>\n<li><p>@param invocation</p>\n</li>\n<li><p>@return</p>\n</li>\n<li><p>@throws Throwable</p>\n</li>\n<li><p>/<br>@Override<br>public Object intercept(Invocation invocation) throws Throwable {<br>  // 利用spring提供的，判断当前是不是事务已表明是不是数据库操作<br>  boolean synchronizationActive = TransactionSynchronizationManager.isActualTransactionActive();<br>  Object[] objects = invocation.getArgs();<br>  MappedStatement ms = (MappedStatement)objects[0]; // 参数第一个是解释什么数据库操作<br>  String lookupKey = DynamicDataSourceHolder.DB_MASTER;<br>  if(synchronizationActive != true){</p>\n<pre><code>  // 读方法，\n  if(ms.getSqlCommandType().equals(SqlCommandType.SELECT))&#123;\n      // selectKey 为自增id查询主键（SELECT LAST_INSERT_ID())方法，使用主库，通常使用自增主键插入数据库操作\n      if(ms.getId().contains(SelectKeyGenerator.SELECT_KEY_SUFFIX))&#123;\n          lookupKey = DynamicDataSourceHolder.DB_MASTER;\n      &#125;else&#123;\n          BoundSql boundSql = ms.getSqlSource().getBoundSql(objects[1]);\n          String sql = boundSql.getSql().toLowerCase(Locale.CHINA).replaceAll(&quot;[\\\\t\\\\n\\\\r]&quot;, &quot;&quot;);\n          if(sql.matches(REGEX))&#123;\n              lookupKey = DynamicDataSourceHolder.DB_MASTER;\n          &#125;else&#123;\n              lookupKey = DynamicDataSourceHolder.DB_SLAVE;\n          &#125;\n      &#125;\n  &#125;\n</code></pre>\n<p>  }else{</p>\n<pre><code>  // 因为一般事务操作可能包含增删改查混合操作，所以用master\n  lookupKey = DynamicDataSourceHolder.DB_MASTER;\n</code></pre>\n<p>  }<br>  logger.debug(“设置方法[{}] use[{}] Strategy,SqlCommandType[{}]…”, ms.getId(), lookupKey, ms.getSqlCommandType().name());<br>  DynamicDataSourceHolder.setDbType(lookupKey);<br>  return invocation.proceed();<br>}</p>\n<p>/**</p>\n</li>\n<li><p>返回封装好的代理对象，决定返回的是本体还是编织好的代理</p>\n</li>\n<li><p>@param target</p>\n</li>\n<li><p>@return</p>\n</li>\n<li><p>/<br>@Override<br>public Object plugin(Object target) {<br>  // 这里的Executor是mybatis支持一系列增删改查操作的执行器<br>  if(target instanceof Executor){</p>\n<pre><code>  // 如果是mybatis的Executor类型，那么就把编入逻辑织入，不是返回本体\n  return Plugin.wrap(target, this);\n</code></pre>\n<p>  }<br>  return target;<br>}</p>\n<p>/**</p>\n</li>\n<li><p>非必要</p>\n</li>\n<li><p>@param properties</p>\n</li>\n<li><p>/<br>@Override<br>public void setProperties(Properties properties) {</p>\n<p>}<br>}</p>\n<pre><code>\n\n\n</code></pre>\n</li>\n</ul>\n</li>\n</ul>\n<p><strong>c.DynamicDataSource类</strong></p>\n<p>继承AbstractRoutingDataSource，实现determineCurrentLookupKey方法，从池子中获取对应线程应该选择的数据源名称key，然后在targetDataSource中获取对应的数据源连接给线程（targetDataSource是个Map变量，在spring-dao.xml配置文件中配置）</p>\n<pre><code class=\"java\">package com.imooc.o2o.dao.split;\n\nimport org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;\n\n/**\n * 从池子中取key，然后从HashMap&lt;String,DataSource&gt;中用key找到对应的DataSource\n */\npublic class DynamicDataSource extends AbstractRoutingDataSource &#123;\n    @Override\n    protected Object determineCurrentLookupKey() &#123;\n        return DynamicDataSourceHolder.getDbType();\n    &#125;\n&#125;\n</code></pre>\n<h3 id=\"3-装配\"><a href=\"#3-装配\" class=\"headerlink\" title=\"3.装配\"></a><span style=\"color:orange;\">3.装配</span></h3><ol>\n<li>mybatis-config中装配拦截器</li>\n</ol>\n<pre><code class=\"xml\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;\n&lt;!DOCTYPE configuration\n        PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot;\n        &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;\n&lt;configuration&gt;\n    &lt;!-- 配置全局属性 --&gt;\n    &lt;settings&gt;\n        &lt;!-- 使用jdbc的getGeneratedKeys获取数据库自增主键值 --&gt;\n        &lt;setting name=&quot;useGeneratedKeys&quot; value=&quot;true&quot;/&gt;\n\n        &lt;!-- 使用列标签（数据库列名）替换列名（查询语句名字） 默认:true --&gt;\n        &lt;setting name=&quot;useColumnLabel&quot; value=&quot;true&quot;/&gt;\n\n        &lt;!-- 开启驼峰命名转换:Table&#123;create_time&#125; -&gt; Entity&#123;createTime&#125; --&gt;\n        &lt;setting name=&quot;mapUnderscoreToCamelCase&quot; value=&quot;true&quot;/&gt;\n    &lt;/settings&gt;\n\n    &lt;!--自定义读写分离拦截器--&gt;\n    &lt;plugins&gt;\n        &lt;plugin interceptor=&quot;com.imooc.o2o.dao.split.DynamicDataSourceInterceptor&quot;/&gt;\n    &lt;/plugins&gt;\n&lt;/configuration&gt;\n</code></pre>\n<ol start=\"2\">\n<li>spring-dao.xml配置路由数据源</li>\n</ol>\n<ul>\n<li>设置abstract为true的连接池，定义为abstract是为了后边继承通用的连接池属性</li>\n</ul>\n<ul>\n<li>定义好master和slave的数据源连接配置，指明parent为上面abstract的连接池</li>\n<li>将继承实现AbstractRoutingDataSourc    e的类，配置好Map变量targetDataSource</li>\n<li>定义为懒加载，因为只在SQL语句正式执行的时候才指定出来dataSource</li>\n</ul>\n<p>jdbc.properties文件：</p>\n<pre><code>jdbc.master.driver=com.mysql.cj.jdbc.Driver\njdbc.master.url=jdbc:mysql://localhost:10001/o2o?useUnicode=true&amp;characterEncoding=utf8\njdbc.master.username=root\njdbc.master.password=make1234\njdbc.slave.driver=com.mysql.cj.jdbc.Driver\njdbc.slave.url=jdbc:mysql://localhost:10002/o2o?useUnicode=true&amp;characterEncoding=utf8\njdbc.slave.username=root\njdbc.slave.password=make1234\n</code></pre>\n<p>spring-dao.xml文件：</p>\n<pre><code class=\"xml\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;\n       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;\n       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;\n       xmlns:p=&quot;http://www.springframework.org/schema/p&quot; xmlns:bean=&quot;http://www.springframework.org/schema/context&quot;\n       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans\n       http://www.springframework.org/schema/beans/spring-beans.xsd\n       http://www.springframework.org/schema/context\n       http://www.springframework.org/schema/context/spring-context.xsd&quot;&gt;\n\n    &lt;context:component-scan base-package=&quot;com.imooc.o2o.dao&quot;/&gt;\n\n    &lt;!--配置数据库properties的数据--&gt;\n    &lt;context:property-placeholder location=&quot;classpath:jdbc.properties&quot;/&gt;\n\n    &lt;!--1.数据库连接池，设置为abstract，便于后面继承属性配置主从库--&gt;\n    &lt;bean id=&quot;abstractDataSource&quot; class=&quot;com.mchange.v2.c3p0.ComboPooledDataSource&quot;\n        abstract=&quot;true&quot; destroy-method=&quot;close&quot;&gt;\n        &lt;!--c3p0连接池的私有属性--&gt;\n        &lt;property name=&quot;maxPoolSize&quot; value=&quot;30&quot;/&gt;\n        &lt;property name=&quot;minPoolSize&quot; value=&quot;10&quot;/&gt;\n        &lt;!--关闭连接后不自动commit--&gt;\n        &lt;property name=&quot;autoCommitOnClose&quot; value=&quot;false&quot;/&gt;\n        &lt;!--获取连接的超时时间--&gt;\n        &lt;property name=&quot;checkoutTimeout&quot; value=&quot;10000&quot;/&gt;\n        &lt;!--当获取连接失败重试次数--&gt;\n        &lt;property name=&quot;acquireRetryAttempts&quot; value=&quot;10&quot;/&gt;\n    &lt;/bean&gt;\n\n    &lt;!--2.主库配置--&gt;\n    &lt;bean id=&quot;master&quot; parent=&quot;abstractDataSource&quot;&gt;\n        &lt;!--配置连接池属性--&gt;\n        &lt;property name=&quot;driverClass&quot; value=&quot;$&#123;jdbc.master.driver&#125;&quot;/&gt;\n        &lt;property name=&quot;jdbcUrl&quot; value=&quot;$&#123;jdbc.master.url&#125;&quot;/&gt;\n        &lt;property name=&quot;user&quot; value=&quot;$&#123;jdbc.master.username&#125;&quot;/&gt;\n        &lt;property name=&quot;password&quot; value=&quot;$&#123;jdbc.master.password&#125;&quot;/&gt;\n    &lt;/bean&gt;\n\n    &lt;!--3.从库配置--&gt;\n    &lt;bean id=&quot;slave&quot; parent=&quot;abstractDataSource&quot;&gt;\n        &lt;!--配置连接池属性--&gt;\n        &lt;property name=&quot;driverClass&quot; value=&quot;$&#123;jdbc.slave.driver&#125;&quot;/&gt;\n        &lt;property name=&quot;jdbcUrl&quot; value=&quot;$&#123;jdbc.slave.url&#125;&quot;/&gt;\n        &lt;property name=&quot;user&quot; value=&quot;$&#123;jdbc.slave.username&#125;&quot;/&gt;\n        &lt;property name=&quot;password&quot; value=&quot;$&#123;jdbc.slave.password&#125;&quot;/&gt;\n    &lt;/bean&gt;\n\n    &lt;!--4.配置动态数据源，这儿的targetDataSource就是路由数据源所对应的名称--&gt;\n    &lt;bean id=&quot;dynamicDataSource&quot; class=&quot;com.imooc.o2o.dao.split.DynamicDataSource&quot;&gt;\n        &lt;!--将数据源放入到map中，这里的key要与com.imooc.o2o.dao.split.DynamicDataSourceHolder中的key相同--&gt;\n        &lt;property name=&quot;targetDataSources&quot;&gt;\n            &lt;map&gt;\n                &lt;entry value-ref=&quot;master&quot; key=&quot;master&quot;&gt;&lt;/entry&gt;\n                &lt;entry value-ref=&quot;slave&quot; key=&quot;slave&quot;&gt;&lt;/entry&gt;\n            &lt;/map&gt;\n        &lt;/property&gt;\n    &lt;/bean&gt;\n\n    &lt;!--5.懒加载，需要在SQL语句正式执行的时候才指定出来dataSource--&gt;\n    &lt;bean id=&quot;dataSource&quot; class=&quot;org.springframework.jdbc.datasource.LazyConnectionDataSourceProxy&quot;&gt;\n        &lt;property name=&quot;targetDataSource&quot;&gt;\n            &lt;ref bean=&quot;dynamicDataSource&quot;&gt;&lt;/ref&gt;\n        &lt;/property&gt;\n    &lt;/bean&gt;\n\n    &lt;!--配置SqlSessionFactory对象--&gt;\n    &lt;!--MyBatis全局配置文件--&gt;\n    &lt;!--扫描entity包，将取出结果包装成entity对象--&gt;\n    &lt;!--扫描Sql配置文件--&gt;\n    &lt;bean id=&quot;sqlSessionFactory&quot; class=&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;\n          p:dataSource-ref=&quot;dataSource&quot;\n          p:configLocation=&quot;classpath:mybatis-config.xml&quot;\n          p:typeAliasesPackage=&quot;com.imooc.o2o.entity&quot;\n          p:mapperLocations=&quot;classpath:mapper/*.xml&quot;/&gt;\n\n    &lt;!--配置扫描Dao接口包，动态实现Dao接口，注入到Spring容器中--&gt;\n    &lt;bean class=&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;&gt;\n        &lt;!--注入SqlSessionFactory--&gt;\n        &lt;property name=&quot;sqlSessionFactoryBeanName&quot; value=&quot;sqlSessionFactory&quot;/&gt;\n        &lt;!--给出需要扫描Dao接口包--&gt;\n        &lt;property name=&quot;basePackage&quot; value=&quot;com.imooc.o2o.dao&quot;/&gt;\n    &lt;/bean&gt;\n&lt;/beans&gt;\n</code></pre>"},{"title":"Zxing二维码生成","date":"2021-02-22T16:00:00.000Z","toc":true,"_content":"\n> 二维码其实就是一个比特的矩阵，这个比特矩阵存储的是一个url，当二维码扫描时就会自动打开其中存储的url给服务器，这个url可能会通过GET方式给服务器传递一个扫码者的信息，服务器接收到请求后，将GET信息获取到进行处理就会返回一些页面给扫码者\n\n\n\n### 背景需求\n\n在项目中，店铺授权二维码为扫码者申请扫码权限，需要首先获取到扫码者的个人信息，才能进行授权，为了获取扫码者的个人信息，这里我们使用微信测试号回传用户信息的url，如下所示\n\n\n```http\nhttps://open.weixin.qq.com/connect/oauth2/authorize?appid=wx6d9e79f7e8844954&redirect_uri=http://81.70.249.115/o2o/shopadmin/addshopauthmap&role_type=1&response_type=code&scope=snsapi_userinfo&state=2#wechat_redirect\n```\n\n- appid字段：是申请微信测试号给予的appid开发者字段以及一个密匙secret（后面在获取用户信息会使用secret字段进行校验）\n- redirect_uri字段：就是我们web应用接收微信回传个人信息的url\n- state字段：可以自定义一些业务逻辑需要的一些信息，例如店铺授权需要知道往哪个店铺进行授权，需要知道店铺id，例如知晓二维码是否过期，封装createTime二维码的创建时间\n\n扫码者打开微信扫描二维码时，就会访问这个url，微信就会将扫码者的信息传回给指定的redirect_uri，这个uri就可以通过code、accessToken、openId来获取用户的信息（这其中会涉及到多次二次验证），我们通过获取openId与数据库中的表tb_wechat_auth中查找该openId是否已经注册过，如果未注册就抓取其信息进行注册。\n\n<!--more-->\n\n\n\n### 实践\n\n<font size=4 color='orange'>1. 申请微信测试号（[https://mp.weixin.qq.com/debug/cgi-bin/sandboxinfo?action=showinfo&t=sandbox/index](https://mp.weixin.qq.com/debug/cgi-bin/sandboxinfo?action=showinfo&t=sandbox/index)）</font>\n\n<div align='center'><img src=\"1613878321918-810b6f23-69ad-4817-a58a-16739f945cec.png\" alt=\"image-20210129220709957\" style=\"zoom:50%;\" /></div>\n\n为了使用微信回传到我们指定的域名，微信要求需要实现对我们的域名进行认证，具体方法就是在我们的应用编写一个controller层，将微信传给的验证信息进行排序再返回即可\n**这里回传排序好的信息给微信的url需要和图中的URL字段保持一致**\n\n```java\n /**\n * 微信用来验证网站是否和openId绑定的路由\n */\n@Controller\n@RequestMapping(value = \"/wechat\")\npublic class WechatController {\n    private static Logger logger = LoggerFactory.getLogger(WechatController.class);\t\n\t\n    @RequestMapping(method = RequestMethod.GET)\n    public void doGet(HttpServletRequest request, HttpServletResponse response) {\n        String signature = HttpServletRequestUtil.getString(request, \"signature\");\n        String timestamp = HttpServletRequestUtil.getString(request, \"timestamp\");\n        String nonce = HttpServletRequestUtil.getString(request, \"nonce\");\n        // 随机字符串\n        String echoStr = HttpServletRequestUtil.getString(request, \"echostr\");\n\n        //通过对signature进行校验，如果成功则原封不动输出echoStr，失败则什么都不输出\n        PrintWriter out = null;\n        try {\n            // 从response中接收到输出实例，是输出到响应流中的\n            out = response.getWriter();\n            if (SignUtil.checkSignature(signature, timestamp, nonce)) {\n                logger.debug(\"weixin get success...\");\n                out.println(echoStr);\n            }\n        } catch (IOException e) {\n            e.printStackTrace();\n        } finally {\n            if (out != null) {\n                out.close();\n            }\n        }\n    }\n}\n\npackage com.imooc.o2o.util.wechat;\n\nimport java.security.MessageDigest;\nimport java.security.NoSuchAlgorithmException;\nimport java.util.Arrays;\n\npublic class SignUtil {\n    // 与微信开发者中设置的token要一致\n    private static String token = \"o2o\";\n\n    /**\n     * 验证微信api发过来的签名，需要对三者进行排序，并拼接成一个字符串，然后进行sha1加密，然后与signature进行对比\n     *\n     * @param signature 微信加密签名\n     * @param timestamp 时间戳\n     * @param nonce     随机数\n     * @return\n     */\n    public static boolean checkSignature(String signature, String timestamp, String nonce) {\n        String[] arr = new String[]{token, timestamp, nonce};\n        Arrays.sort(arr);\n        StringBuilder stringBuilder = new StringBuilder();\n        for (int i = 0; i < arr.length; i++) {\n            stringBuilder.append(arr[i]);\n        }\n        MessageDigest md = null;\n        String tempStr = \"\";\n        try {\n            md = MessageDigest.getInstance(\"SHA-1\");\n            // 将三个字符串拼接成一个并进行SHA-1加密\n            byte[] digest = md.digest(stringBuilder.toString().getBytes());\n            tempStr = byteToStr(digest);\n        } catch (NoSuchAlgorithmException e) {\n            e.printStackTrace();\n        }\n\n        stringBuilder = null;\n        // 将sha1加密后的字符串与微信发送的签名进行比较，标识该请求来源于微信\n        return tempStr != null ? tempStr.equals(signature.toUpperCase()) : false;\n    }\n\n    /**\n     * 将字节组转换为十六进制字符串\n     *\n     * @param byteArray\n     * @return\n     */\n    private static String byteToStr(byte[] byteArray) {\n        String strDigest = \"\";\n        for (int i = 0; i < byteArray.length; i++) {\n            strDigest += byteToHexStr(byteArray[i]);\n        }\n        return strDigest;\n    }\n\n    /**\n     * 将字节转换为十六进制字符串\n     *\n     * @param mByte\n     * @return\n     */\n    private static String byteToHexStr(byte mByte) {\n        char[] Digit = {'0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A', 'B', 'C', 'D', 'E', 'F'};\n        char[] tempArr = new char[2];\n        tempArr[0] = Digit[(mByte >>> 4) & 0X0F];\n        tempArr[1] = Digit[mByte & 0X0F];\n\n        String s = new String(tempArr);\n        return s;\n    }\n\n\n}\n```\n\n<font size=4 color='orange'>2. 生成二维码</font>\n\n生成二维码首先需要引入Google的开发包zxing\n```java\n\t\t<!--二维码相关-->\n\t\t<!-- https://mvnrepository.com/artifact/com.google.zxing/javase -->\n\t\t<dependency>\n\t\t\t<groupId>com.google.zxing</groupId>\n\t\t\t<artifactId>javase</artifactId>\n\t\t\t<version>3.4.1</version>\n\t\t</dependency>\n```\n\n\n生成二维码的工具类代码，可以看出二维码是BitMatrix，二维码生成后以png输出到响应流response中\n```java\n    /**\n     * 生成二维码的图片流，其中content就是我们塞入二维码的内容\n     * @param content\n     * @param resp\n     * @return BitMatrix 是一个比特的矩阵\n     */\n    public static BitMatrix generateQRCodeStream(String content, HttpServletResponse resp){\n        // 给相应添加头部信息，主要告诉浏览器返回的是图片流\n        resp.setHeader(\"Cache-Control\", \"no-store\"); // 不设定缓存，因为二维码会过期\n        resp.setHeader(\"Pragma\", \"no-cache\");\n        resp.setDateHeader(\"Expires\", 0);\n        resp.setContentType(\"image/png\"); // 告诉浏览器是文件流\n\n        // 设置图片的文字编码和内边框距\n        Map<EncodeHintType, Object> hints = new HashMap<EncodeHintType, Object>();\n        hints.put(EncodeHintType.CHARACTER_SET, \"UTF-8\");\n        hints.put(EncodeHintType.MARGIN, 0);\n        BitMatrix bitMatrix;\n        try{\n            // 生成二维码，参数顺序分别为：编码内容（一般为url）、编码类型、生成图片宽度、生成图片宽度、设置参数\n            bitMatrix = new MultiFormatWriter().encode(content, BarcodeFormat.QR_CODE, 300, 300, hints);\n        }catch(WriterException e){\n            e.printStackTrace();\n            return null;\n        }\n        return bitMatrix;\n    }\n```\n\n\n\n<font size=4 color='orange'>3. 生成二维码的controller层</font>\n\ncontroller层将微信回传的url封到二维码中，其中url中的state字段可以为我们添加一些辅助信息（例如授权时需要知道往哪个店铺进行授权员工操作就需要知道店铺的id），当扫码者扫描时回传用户的信息到指定的redirect_url通过把事先定义好的state字段以get形式返回，以进行辅助操作。这里我们塞入了两个字段一个是shopId以及二维码的生成时间createTime，createTime字段可以帮助我们在回传信息时判断二维码是否超过我们指定的时间间隔\n\n```java\n    /**\n     * 将微信回传用户信息的url放入到二维码中，并通过Response返回个前台填充到<img src/>中的src属性中\n     * @param request\n     * @param response\n     */\n    @RequestMapping(value=\"/generateqrcodeshopauth\", method=RequestMethod.GET)\n    @ResponseBody\n    public void generateQRCodeShopAuth(HttpServletRequest request, HttpServletResponse response){\n        // 附加上必要的店铺信息到微信回传的state中，这样才知道回传用户信息往哪个店铺添加\n        Shop shop = (Shop)request.getSession().getAttribute(\"currentShop\");\n        if(shop != null && shop.getShopId() != null){\n            // 获取当前时间戳，以保证二维码的时间有效性，防止他人滥用，精确到毫秒\n            long timeStamp = System.currentTimeMillis();\n            // 加上aaa是为了方便剥离相应的信息\n            String content = \"{aaashopIdaaa:\" + shop.getShopId() + \",aaacreateTimeaaa:\" + timeStamp + \"}\";\n            try{\n                // 将content的信息先进行Base64编码，防止特殊字符对url进行干扰\n                String longUrl = urlPrefix + authUrl + urlMiddle + URLEncoder.encode(content, \"UTF-8\") + urlSuffix;\n                // 将目标url转为短的URL，防止微信扫码失效\n                String shortUrl = ShortNetAddressUtil.getShortURL(longUrl);\n                BitMatrix bitMatrix = CodeUtil.generateQRCodeStream(shortUrl, response);\n                // 将二维码图片流输出到响应流中\n                MatrixToImageWriter.writeToStream(bitMatrix, \"png\", response.getOutputStream());\n            }catch(Exception e){\n                e.printStackTrace();\n                logger.error(e.toString());\n            }\n        }\n    }\n```\n\n\n前台通过<img>标签中的src就可以请求响应的二维码图片流\n```html\n<img src=\"/o2o/shopadmin/generateqrcodeshopauth\" id=\"auth-img\"/\n```\n\n\n\n<font size=4 color='orange'>4. 微信回传信息处理controller层</font>\n\n扫码者扫码后回传信息处理的controller，这里需要和redirect_url保持一致，这样才能正确接收到微信回传的用户信息。\n\n- 获取微信回传用户信息，主要是通过code字段、appid以及secret字段（这些字段是通过微信测试号进行获取的，获取需要绑定指定的域名的controller层，这个controller层主要是微信辅助校验域名的有效性）获取到用户的token字段以及openId字段，然后再通过token字段和openId字段回传给微信获取用户的信息\n- 为了防止二维码泄漏，被反复操作，这里通过vaildQRCode来检测回传的state字段中的createTime检测二维码是否过期。\n- 为了防止二维码被反复扫描，恶意入库，这里通过checkOpenIdRegister检测回传用户信息的openId是否已经注册过，如果已经注册过就不在入库。\n```java\n/**\n     * 将二维码打开的url回传的微信用户信息进行授权\n     * @param request\n     * @return\n     */\n    // todo 调试\n    @RequestMapping(value=\"/addshopauthmap\")\n    public ModelAndView addShopAuthMap(HttpServletRequest request){\n        ModelAndView authFail = new ModelAndView(\"shop/shopauthfail\");\n        ModelAndView authSuccess = new ModelAndView(\"shop/shopauthsuccess\");\n        // 获取店铺信息\n        String state = HttpServletRequestUtil.getString(request, \"state\");\n        String jsonStr = state.replaceAll(\"aaa\", \"\\\"\");\n        ObjectMapper objectMapper = new ObjectMapper();\n        WechatInfo wechatInfo = null;\n        try{\n            wechatInfo = objectMapper.readValue(jsonStr, WechatInfo.class);\n        } catch (JsonMappingException e) {\n            e.printStackTrace();\n        } catch (JsonProcessingException e) {\n            e.printStackTrace();\n        }\n\n        // 获取微信回传得到的用户信息\n        String code = request.getParameter(\"code\");\n        PersonInfo personInfo = null;\n        try{\n           UserAccessToken userAccessToken =  WechatUtil.getUserAccessToken(code);\n           String openId = userAccessToken.getOpenId();\n           WechatUser wechatUser = WechatUtil.getUserInfo(userAccessToken.getAccessToken(), openId);\n           personInfo = WechatUtil.getPersonInfo(wechatUser);\n           personInfo.setUserType(4); // 设置为店家的管理员\n           // 如果openId对应用户未注册过则进行注册\n           if(!checkOpenIdRegister(openId)){\n               WechatAuth wechatAuth = new WechatAuth();\n               wechatAuth.setOpenId(openId);\n               wechatAuth.setPersonInfo(personInfo);\n               WechatExecution execution = wechatAuthService.register(wechatAuth);\n               if(execution.getState() != WechatAuthStateEnum.SUCCESS.getState()){\n                   logger.info(\"error\");\n                   return authFail;\n               }\n           }else{\n               // 如果注册过，则查询数据库以填充personInfo的userId，后面才可以进行店铺授权\n               WechatAuth temp = wechatAuthService.getWechatAuthById(openId);\n               personInfo = temp.getPersonInfo();\n           }\n        }catch (Exception e){\n            logger.error(e.toString());\n            return authFail;\n        }\n\n        // 检查是否重复授权或者二维码过期，如果符合就返回失败的视图页面\n        if(checkAlreadyAuth(wechatInfo.getShopId(), personInfo.getUserId()) || !vaildQRCode(wechatInfo)){\n            return authFail;\n        }\n\n        // 如果前面操作都通过即未进行过授权以及二维码未过期，进行店铺授权\n        if(wechatInfo != null && wechatInfo.getShopId() != null && personInfo != null && personInfo.getUserId() != null){\n            try{\n                ShopAuthMap shopAuthMap = new ShopAuthMap();\n                shopAuthMap.setTitle(\"员工\");\n                shopAuthMap.setTitleFlag(1);\n                Shop shop = new Shop();\n                shop.setShopId(wechatInfo.getShopId());\n                shopAuthMap.setShop(shop);\n                shopAuthMap.setEmployee(personInfo);\n                ShopAuthMapExecution shopAuthMapExecution = shopAuthMapService.addShopAuthMap(shopAuthMap);\n                if(shopAuthMapExecution.getState() == ShopAuthMapStateEnum.AUTH_SUCCESS.getState()){\n                    return authSuccess;\n                }else{\n                    logger.error(shopAuthMapExecution.getStateInfo());\n                    return authFail;\n                }\n            }catch (Exception e){\n                logger.error(e.toString());\n                return authFail;\n            }\n        }else{\n            return authFail;\n        }\n    }\n\n    /**\n     * 检查openId是否注册过\n     * @param openId\n     * @return\n     */\n    private Boolean checkOpenIdRegister(String openId){\n        WechatAuth wechatAuth = wechatAuthService.getWechatAuthById(openId);\n        if(wechatAuth != null && wechatAuth.getPersonInfo() != null){\n            return true;\n        }\n        return false;\n    }\n\n    /**\n     * 检查二维码是否过期\n     * @param wechatInfo\n     * @return\n     */\n    private Boolean vaildQRCode(WechatInfo wechatInfo) {\n        if (wechatInfo != null && wechatInfo.getCreateTime() != null && wechatInfo.getShopId() != null) {\n            Long expireTime = wechatInfo.getCreateTime();\n            Long currentTime = System.currentTimeMillis();\n            // 如果二维码创建时间和现在时间超过10分钟则失效\n            if (currentTime - expireTime > 600000) {\n                return false;\n            } else {\n                return true;\n            }\n        } else {\n            return false;\n        }\n    }\n\n    /**\n     * 检查是否已经授权过，避免重复授权数据库一致插入\n     * @param shopId\n     * @param employeeId\n     * @return\n     */\n    private Boolean checkAlreadyAuth(Long shopId, Long employeeId){\n        ShopAuthMapExecution shopAuthMapExecution = shopAuthMapService.listShopAuthMapByShopId(shopId, 0, 100);\n        List<ShopAuthMap> list = shopAuthMapExecution.getShopAuthMapList();\n        for(ShopAuthMap shopAuthMap : list){\n            if(shopAuthMap.getEmployee().getUserId() == employeeId){\n                return true;\n            }\n        }\n        return false;\n    }\n```\n","source":"_posts/zxing二维码的生成.md","raw":"---\ntitle: Zxing二维码生成\ndate: 2021-2-23\ntags:\n\t- Zxing\n\t- 短链\ncategories:\n\t- Spring\ntoc: true\n---\n\n> 二维码其实就是一个比特的矩阵，这个比特矩阵存储的是一个url，当二维码扫描时就会自动打开其中存储的url给服务器，这个url可能会通过GET方式给服务器传递一个扫码者的信息，服务器接收到请求后，将GET信息获取到进行处理就会返回一些页面给扫码者\n\n\n\n### 背景需求\n\n在项目中，店铺授权二维码为扫码者申请扫码权限，需要首先获取到扫码者的个人信息，才能进行授权，为了获取扫码者的个人信息，这里我们使用微信测试号回传用户信息的url，如下所示\n\n\n```http\nhttps://open.weixin.qq.com/connect/oauth2/authorize?appid=wx6d9e79f7e8844954&redirect_uri=http://81.70.249.115/o2o/shopadmin/addshopauthmap&role_type=1&response_type=code&scope=snsapi_userinfo&state=2#wechat_redirect\n```\n\n- appid字段：是申请微信测试号给予的appid开发者字段以及一个密匙secret（后面在获取用户信息会使用secret字段进行校验）\n- redirect_uri字段：就是我们web应用接收微信回传个人信息的url\n- state字段：可以自定义一些业务逻辑需要的一些信息，例如店铺授权需要知道往哪个店铺进行授权，需要知道店铺id，例如知晓二维码是否过期，封装createTime二维码的创建时间\n\n扫码者打开微信扫描二维码时，就会访问这个url，微信就会将扫码者的信息传回给指定的redirect_uri，这个uri就可以通过code、accessToken、openId来获取用户的信息（这其中会涉及到多次二次验证），我们通过获取openId与数据库中的表tb_wechat_auth中查找该openId是否已经注册过，如果未注册就抓取其信息进行注册。\n\n<!--more-->\n\n\n\n### 实践\n\n<font size=4 color='orange'>1. 申请微信测试号（[https://mp.weixin.qq.com/debug/cgi-bin/sandboxinfo?action=showinfo&t=sandbox/index](https://mp.weixin.qq.com/debug/cgi-bin/sandboxinfo?action=showinfo&t=sandbox/index)）</font>\n\n<div align='center'><img src=\"1613878321918-810b6f23-69ad-4817-a58a-16739f945cec.png\" alt=\"image-20210129220709957\" style=\"zoom:50%;\" /></div>\n\n为了使用微信回传到我们指定的域名，微信要求需要实现对我们的域名进行认证，具体方法就是在我们的应用编写一个controller层，将微信传给的验证信息进行排序再返回即可\n**这里回传排序好的信息给微信的url需要和图中的URL字段保持一致**\n\n```java\n /**\n * 微信用来验证网站是否和openId绑定的路由\n */\n@Controller\n@RequestMapping(value = \"/wechat\")\npublic class WechatController {\n    private static Logger logger = LoggerFactory.getLogger(WechatController.class);\t\n\t\n    @RequestMapping(method = RequestMethod.GET)\n    public void doGet(HttpServletRequest request, HttpServletResponse response) {\n        String signature = HttpServletRequestUtil.getString(request, \"signature\");\n        String timestamp = HttpServletRequestUtil.getString(request, \"timestamp\");\n        String nonce = HttpServletRequestUtil.getString(request, \"nonce\");\n        // 随机字符串\n        String echoStr = HttpServletRequestUtil.getString(request, \"echostr\");\n\n        //通过对signature进行校验，如果成功则原封不动输出echoStr，失败则什么都不输出\n        PrintWriter out = null;\n        try {\n            // 从response中接收到输出实例，是输出到响应流中的\n            out = response.getWriter();\n            if (SignUtil.checkSignature(signature, timestamp, nonce)) {\n                logger.debug(\"weixin get success...\");\n                out.println(echoStr);\n            }\n        } catch (IOException e) {\n            e.printStackTrace();\n        } finally {\n            if (out != null) {\n                out.close();\n            }\n        }\n    }\n}\n\npackage com.imooc.o2o.util.wechat;\n\nimport java.security.MessageDigest;\nimport java.security.NoSuchAlgorithmException;\nimport java.util.Arrays;\n\npublic class SignUtil {\n    // 与微信开发者中设置的token要一致\n    private static String token = \"o2o\";\n\n    /**\n     * 验证微信api发过来的签名，需要对三者进行排序，并拼接成一个字符串，然后进行sha1加密，然后与signature进行对比\n     *\n     * @param signature 微信加密签名\n     * @param timestamp 时间戳\n     * @param nonce     随机数\n     * @return\n     */\n    public static boolean checkSignature(String signature, String timestamp, String nonce) {\n        String[] arr = new String[]{token, timestamp, nonce};\n        Arrays.sort(arr);\n        StringBuilder stringBuilder = new StringBuilder();\n        for (int i = 0; i < arr.length; i++) {\n            stringBuilder.append(arr[i]);\n        }\n        MessageDigest md = null;\n        String tempStr = \"\";\n        try {\n            md = MessageDigest.getInstance(\"SHA-1\");\n            // 将三个字符串拼接成一个并进行SHA-1加密\n            byte[] digest = md.digest(stringBuilder.toString().getBytes());\n            tempStr = byteToStr(digest);\n        } catch (NoSuchAlgorithmException e) {\n            e.printStackTrace();\n        }\n\n        stringBuilder = null;\n        // 将sha1加密后的字符串与微信发送的签名进行比较，标识该请求来源于微信\n        return tempStr != null ? tempStr.equals(signature.toUpperCase()) : false;\n    }\n\n    /**\n     * 将字节组转换为十六进制字符串\n     *\n     * @param byteArray\n     * @return\n     */\n    private static String byteToStr(byte[] byteArray) {\n        String strDigest = \"\";\n        for (int i = 0; i < byteArray.length; i++) {\n            strDigest += byteToHexStr(byteArray[i]);\n        }\n        return strDigest;\n    }\n\n    /**\n     * 将字节转换为十六进制字符串\n     *\n     * @param mByte\n     * @return\n     */\n    private static String byteToHexStr(byte mByte) {\n        char[] Digit = {'0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A', 'B', 'C', 'D', 'E', 'F'};\n        char[] tempArr = new char[2];\n        tempArr[0] = Digit[(mByte >>> 4) & 0X0F];\n        tempArr[1] = Digit[mByte & 0X0F];\n\n        String s = new String(tempArr);\n        return s;\n    }\n\n\n}\n```\n\n<font size=4 color='orange'>2. 生成二维码</font>\n\n生成二维码首先需要引入Google的开发包zxing\n```java\n\t\t<!--二维码相关-->\n\t\t<!-- https://mvnrepository.com/artifact/com.google.zxing/javase -->\n\t\t<dependency>\n\t\t\t<groupId>com.google.zxing</groupId>\n\t\t\t<artifactId>javase</artifactId>\n\t\t\t<version>3.4.1</version>\n\t\t</dependency>\n```\n\n\n生成二维码的工具类代码，可以看出二维码是BitMatrix，二维码生成后以png输出到响应流response中\n```java\n    /**\n     * 生成二维码的图片流，其中content就是我们塞入二维码的内容\n     * @param content\n     * @param resp\n     * @return BitMatrix 是一个比特的矩阵\n     */\n    public static BitMatrix generateQRCodeStream(String content, HttpServletResponse resp){\n        // 给相应添加头部信息，主要告诉浏览器返回的是图片流\n        resp.setHeader(\"Cache-Control\", \"no-store\"); // 不设定缓存，因为二维码会过期\n        resp.setHeader(\"Pragma\", \"no-cache\");\n        resp.setDateHeader(\"Expires\", 0);\n        resp.setContentType(\"image/png\"); // 告诉浏览器是文件流\n\n        // 设置图片的文字编码和内边框距\n        Map<EncodeHintType, Object> hints = new HashMap<EncodeHintType, Object>();\n        hints.put(EncodeHintType.CHARACTER_SET, \"UTF-8\");\n        hints.put(EncodeHintType.MARGIN, 0);\n        BitMatrix bitMatrix;\n        try{\n            // 生成二维码，参数顺序分别为：编码内容（一般为url）、编码类型、生成图片宽度、生成图片宽度、设置参数\n            bitMatrix = new MultiFormatWriter().encode(content, BarcodeFormat.QR_CODE, 300, 300, hints);\n        }catch(WriterException e){\n            e.printStackTrace();\n            return null;\n        }\n        return bitMatrix;\n    }\n```\n\n\n\n<font size=4 color='orange'>3. 生成二维码的controller层</font>\n\ncontroller层将微信回传的url封到二维码中，其中url中的state字段可以为我们添加一些辅助信息（例如授权时需要知道往哪个店铺进行授权员工操作就需要知道店铺的id），当扫码者扫描时回传用户的信息到指定的redirect_url通过把事先定义好的state字段以get形式返回，以进行辅助操作。这里我们塞入了两个字段一个是shopId以及二维码的生成时间createTime，createTime字段可以帮助我们在回传信息时判断二维码是否超过我们指定的时间间隔\n\n```java\n    /**\n     * 将微信回传用户信息的url放入到二维码中，并通过Response返回个前台填充到<img src/>中的src属性中\n     * @param request\n     * @param response\n     */\n    @RequestMapping(value=\"/generateqrcodeshopauth\", method=RequestMethod.GET)\n    @ResponseBody\n    public void generateQRCodeShopAuth(HttpServletRequest request, HttpServletResponse response){\n        // 附加上必要的店铺信息到微信回传的state中，这样才知道回传用户信息往哪个店铺添加\n        Shop shop = (Shop)request.getSession().getAttribute(\"currentShop\");\n        if(shop != null && shop.getShopId() != null){\n            // 获取当前时间戳，以保证二维码的时间有效性，防止他人滥用，精确到毫秒\n            long timeStamp = System.currentTimeMillis();\n            // 加上aaa是为了方便剥离相应的信息\n            String content = \"{aaashopIdaaa:\" + shop.getShopId() + \",aaacreateTimeaaa:\" + timeStamp + \"}\";\n            try{\n                // 将content的信息先进行Base64编码，防止特殊字符对url进行干扰\n                String longUrl = urlPrefix + authUrl + urlMiddle + URLEncoder.encode(content, \"UTF-8\") + urlSuffix;\n                // 将目标url转为短的URL，防止微信扫码失效\n                String shortUrl = ShortNetAddressUtil.getShortURL(longUrl);\n                BitMatrix bitMatrix = CodeUtil.generateQRCodeStream(shortUrl, response);\n                // 将二维码图片流输出到响应流中\n                MatrixToImageWriter.writeToStream(bitMatrix, \"png\", response.getOutputStream());\n            }catch(Exception e){\n                e.printStackTrace();\n                logger.error(e.toString());\n            }\n        }\n    }\n```\n\n\n前台通过<img>标签中的src就可以请求响应的二维码图片流\n```html\n<img src=\"/o2o/shopadmin/generateqrcodeshopauth\" id=\"auth-img\"/\n```\n\n\n\n<font size=4 color='orange'>4. 微信回传信息处理controller层</font>\n\n扫码者扫码后回传信息处理的controller，这里需要和redirect_url保持一致，这样才能正确接收到微信回传的用户信息。\n\n- 获取微信回传用户信息，主要是通过code字段、appid以及secret字段（这些字段是通过微信测试号进行获取的，获取需要绑定指定的域名的controller层，这个controller层主要是微信辅助校验域名的有效性）获取到用户的token字段以及openId字段，然后再通过token字段和openId字段回传给微信获取用户的信息\n- 为了防止二维码泄漏，被反复操作，这里通过vaildQRCode来检测回传的state字段中的createTime检测二维码是否过期。\n- 为了防止二维码被反复扫描，恶意入库，这里通过checkOpenIdRegister检测回传用户信息的openId是否已经注册过，如果已经注册过就不在入库。\n```java\n/**\n     * 将二维码打开的url回传的微信用户信息进行授权\n     * @param request\n     * @return\n     */\n    // todo 调试\n    @RequestMapping(value=\"/addshopauthmap\")\n    public ModelAndView addShopAuthMap(HttpServletRequest request){\n        ModelAndView authFail = new ModelAndView(\"shop/shopauthfail\");\n        ModelAndView authSuccess = new ModelAndView(\"shop/shopauthsuccess\");\n        // 获取店铺信息\n        String state = HttpServletRequestUtil.getString(request, \"state\");\n        String jsonStr = state.replaceAll(\"aaa\", \"\\\"\");\n        ObjectMapper objectMapper = new ObjectMapper();\n        WechatInfo wechatInfo = null;\n        try{\n            wechatInfo = objectMapper.readValue(jsonStr, WechatInfo.class);\n        } catch (JsonMappingException e) {\n            e.printStackTrace();\n        } catch (JsonProcessingException e) {\n            e.printStackTrace();\n        }\n\n        // 获取微信回传得到的用户信息\n        String code = request.getParameter(\"code\");\n        PersonInfo personInfo = null;\n        try{\n           UserAccessToken userAccessToken =  WechatUtil.getUserAccessToken(code);\n           String openId = userAccessToken.getOpenId();\n           WechatUser wechatUser = WechatUtil.getUserInfo(userAccessToken.getAccessToken(), openId);\n           personInfo = WechatUtil.getPersonInfo(wechatUser);\n           personInfo.setUserType(4); // 设置为店家的管理员\n           // 如果openId对应用户未注册过则进行注册\n           if(!checkOpenIdRegister(openId)){\n               WechatAuth wechatAuth = new WechatAuth();\n               wechatAuth.setOpenId(openId);\n               wechatAuth.setPersonInfo(personInfo);\n               WechatExecution execution = wechatAuthService.register(wechatAuth);\n               if(execution.getState() != WechatAuthStateEnum.SUCCESS.getState()){\n                   logger.info(\"error\");\n                   return authFail;\n               }\n           }else{\n               // 如果注册过，则查询数据库以填充personInfo的userId，后面才可以进行店铺授权\n               WechatAuth temp = wechatAuthService.getWechatAuthById(openId);\n               personInfo = temp.getPersonInfo();\n           }\n        }catch (Exception e){\n            logger.error(e.toString());\n            return authFail;\n        }\n\n        // 检查是否重复授权或者二维码过期，如果符合就返回失败的视图页面\n        if(checkAlreadyAuth(wechatInfo.getShopId(), personInfo.getUserId()) || !vaildQRCode(wechatInfo)){\n            return authFail;\n        }\n\n        // 如果前面操作都通过即未进行过授权以及二维码未过期，进行店铺授权\n        if(wechatInfo != null && wechatInfo.getShopId() != null && personInfo != null && personInfo.getUserId() != null){\n            try{\n                ShopAuthMap shopAuthMap = new ShopAuthMap();\n                shopAuthMap.setTitle(\"员工\");\n                shopAuthMap.setTitleFlag(1);\n                Shop shop = new Shop();\n                shop.setShopId(wechatInfo.getShopId());\n                shopAuthMap.setShop(shop);\n                shopAuthMap.setEmployee(personInfo);\n                ShopAuthMapExecution shopAuthMapExecution = shopAuthMapService.addShopAuthMap(shopAuthMap);\n                if(shopAuthMapExecution.getState() == ShopAuthMapStateEnum.AUTH_SUCCESS.getState()){\n                    return authSuccess;\n                }else{\n                    logger.error(shopAuthMapExecution.getStateInfo());\n                    return authFail;\n                }\n            }catch (Exception e){\n                logger.error(e.toString());\n                return authFail;\n            }\n        }else{\n            return authFail;\n        }\n    }\n\n    /**\n     * 检查openId是否注册过\n     * @param openId\n     * @return\n     */\n    private Boolean checkOpenIdRegister(String openId){\n        WechatAuth wechatAuth = wechatAuthService.getWechatAuthById(openId);\n        if(wechatAuth != null && wechatAuth.getPersonInfo() != null){\n            return true;\n        }\n        return false;\n    }\n\n    /**\n     * 检查二维码是否过期\n     * @param wechatInfo\n     * @return\n     */\n    private Boolean vaildQRCode(WechatInfo wechatInfo) {\n        if (wechatInfo != null && wechatInfo.getCreateTime() != null && wechatInfo.getShopId() != null) {\n            Long expireTime = wechatInfo.getCreateTime();\n            Long currentTime = System.currentTimeMillis();\n            // 如果二维码创建时间和现在时间超过10分钟则失效\n            if (currentTime - expireTime > 600000) {\n                return false;\n            } else {\n                return true;\n            }\n        } else {\n            return false;\n        }\n    }\n\n    /**\n     * 检查是否已经授权过，避免重复授权数据库一致插入\n     * @param shopId\n     * @param employeeId\n     * @return\n     */\n    private Boolean checkAlreadyAuth(Long shopId, Long employeeId){\n        ShopAuthMapExecution shopAuthMapExecution = shopAuthMapService.listShopAuthMapByShopId(shopId, 0, 100);\n        List<ShopAuthMap> list = shopAuthMapExecution.getShopAuthMapList();\n        for(ShopAuthMap shopAuthMap : list){\n            if(shopAuthMap.getEmployee().getUserId() == employeeId){\n                return true;\n            }\n        }\n        return false;\n    }\n```\n","slug":"zxing二维码的生成","published":1,"updated":"2021-02-23T01:50:35.689Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl2enrqzv001by2lock5pcxn3","content":"<blockquote>\n<p>二维码其实就是一个比特的矩阵，这个比特矩阵存储的是一个url，当二维码扫描时就会自动打开其中存储的url给服务器，这个url可能会通过GET方式给服务器传递一个扫码者的信息，服务器接收到请求后，将GET信息获取到进行处理就会返回一些页面给扫码者</p>\n</blockquote>\n<h3 id=\"背景需求\"><a href=\"#背景需求\" class=\"headerlink\" title=\"背景需求\"></a>背景需求</h3><p>在项目中，店铺授权二维码为扫码者申请扫码权限，需要首先获取到扫码者的个人信息，才能进行授权，为了获取扫码者的个人信息，这里我们使用微信测试号回传用户信息的url，如下所示</p>\n<pre><code class=\"http\">https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx6d9e79f7e8844954&amp;redirect_uri=http://81.70.249.115/o2o/shopadmin/addshopauthmap&amp;role_type=1&amp;response_type=code&amp;scope=snsapi_userinfo&amp;state=2#wechat_redirect\n</code></pre>\n<ul>\n<li>appid字段：是申请微信测试号给予的appid开发者字段以及一个密匙secret（后面在获取用户信息会使用secret字段进行校验）</li>\n<li>redirect_uri字段：就是我们web应用接收微信回传个人信息的url</li>\n<li>state字段：可以自定义一些业务逻辑需要的一些信息，例如店铺授权需要知道往哪个店铺进行授权，需要知道店铺id，例如知晓二维码是否过期，封装createTime二维码的创建时间</li>\n</ul>\n<p>扫码者打开微信扫描二维码时，就会访问这个url，微信就会将扫码者的信息传回给指定的redirect_uri，这个uri就可以通过code、accessToken、openId来获取用户的信息（这其中会涉及到多次二次验证），我们通过获取openId与数据库中的表tb_wechat_auth中查找该openId是否已经注册过，如果未注册就抓取其信息进行注册。</p>\n<a id=\"more\"></a>\n\n\n\n<h3 id=\"实践\"><a href=\"#实践\" class=\"headerlink\" title=\"实践\"></a>实践</h3><p><font size=\"4\" color=\"orange\">1. 申请微信测试号（<a href=\"https://mp.weixin.qq.com/debug/cgi-bin/sandboxinfo?action=showinfo&t=sandbox/index\">https://mp.weixin.qq.com/debug/cgi-bin/sandboxinfo?action=showinfo&amp;t=sandbox/index</a>）</font></p>\n<div align=\"center\"><img src=\"/2021/Spring/zxing%E4%BA%8C%E7%BB%B4%E7%A0%81%E7%9A%84%E7%94%9F%E6%88%90/1613878321918-810b6f23-69ad-4817-a58a-16739f945cec.png\" alt=\"image-20210129220709957\" style=\"zoom:50%;\"></div>\n\n<p>为了使用微信回传到我们指定的域名，微信要求需要实现对我们的域名进行认证，具体方法就是在我们的应用编写一个controller层，将微信传给的验证信息进行排序再返回即可<br><strong>这里回传排序好的信息给微信的url需要和图中的URL字段保持一致</strong></p>\n<pre><code class=\"java\"> /**\n * 微信用来验证网站是否和openId绑定的路由\n */\n@Controller\n@RequestMapping(value = &quot;/wechat&quot;)\npublic class WechatController &#123;\n    private static Logger logger = LoggerFactory.getLogger(WechatController.class);    \n    \n    @RequestMapping(method = RequestMethod.GET)\n    public void doGet(HttpServletRequest request, HttpServletResponse response) &#123;\n        String signature = HttpServletRequestUtil.getString(request, &quot;signature&quot;);\n        String timestamp = HttpServletRequestUtil.getString(request, &quot;timestamp&quot;);\n        String nonce = HttpServletRequestUtil.getString(request, &quot;nonce&quot;);\n        // 随机字符串\n        String echoStr = HttpServletRequestUtil.getString(request, &quot;echostr&quot;);\n\n        //通过对signature进行校验，如果成功则原封不动输出echoStr，失败则什么都不输出\n        PrintWriter out = null;\n        try &#123;\n            // 从response中接收到输出实例，是输出到响应流中的\n            out = response.getWriter();\n            if (SignUtil.checkSignature(signature, timestamp, nonce)) &#123;\n                logger.debug(&quot;weixin get success...&quot;);\n                out.println(echoStr);\n            &#125;\n        &#125; catch (IOException e) &#123;\n            e.printStackTrace();\n        &#125; finally &#123;\n            if (out != null) &#123;\n                out.close();\n            &#125;\n        &#125;\n    &#125;\n&#125;\n\npackage com.imooc.o2o.util.wechat;\n\nimport java.security.MessageDigest;\nimport java.security.NoSuchAlgorithmException;\nimport java.util.Arrays;\n\npublic class SignUtil &#123;\n    // 与微信开发者中设置的token要一致\n    private static String token = &quot;o2o&quot;;\n\n    /**\n     * 验证微信api发过来的签名，需要对三者进行排序，并拼接成一个字符串，然后进行sha1加密，然后与signature进行对比\n     *\n     * @param signature 微信加密签名\n     * @param timestamp 时间戳\n     * @param nonce     随机数\n     * @return\n     */\n    public static boolean checkSignature(String signature, String timestamp, String nonce) &#123;\n        String[] arr = new String[]&#123;token, timestamp, nonce&#125;;\n        Arrays.sort(arr);\n        StringBuilder stringBuilder = new StringBuilder();\n        for (int i = 0; i &lt; arr.length; i++) &#123;\n            stringBuilder.append(arr[i]);\n        &#125;\n        MessageDigest md = null;\n        String tempStr = &quot;&quot;;\n        try &#123;\n            md = MessageDigest.getInstance(&quot;SHA-1&quot;);\n            // 将三个字符串拼接成一个并进行SHA-1加密\n            byte[] digest = md.digest(stringBuilder.toString().getBytes());\n            tempStr = byteToStr(digest);\n        &#125; catch (NoSuchAlgorithmException e) &#123;\n            e.printStackTrace();\n        &#125;\n\n        stringBuilder = null;\n        // 将sha1加密后的字符串与微信发送的签名进行比较，标识该请求来源于微信\n        return tempStr != null ? tempStr.equals(signature.toUpperCase()) : false;\n    &#125;\n\n    /**\n     * 将字节组转换为十六进制字符串\n     *\n     * @param byteArray\n     * @return\n     */\n    private static String byteToStr(byte[] byteArray) &#123;\n        String strDigest = &quot;&quot;;\n        for (int i = 0; i &lt; byteArray.length; i++) &#123;\n            strDigest += byteToHexStr(byteArray[i]);\n        &#125;\n        return strDigest;\n    &#125;\n\n    /**\n     * 将字节转换为十六进制字符串\n     *\n     * @param mByte\n     * @return\n     */\n    private static String byteToHexStr(byte mByte) &#123;\n        char[] Digit = &#123;&#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;, &#39;8&#39;, &#39;9&#39;, &#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;, &#39;E&#39;, &#39;F&#39;&#125;;\n        char[] tempArr = new char[2];\n        tempArr[0] = Digit[(mByte &gt;&gt;&gt; 4) &amp; 0X0F];\n        tempArr[1] = Digit[mByte &amp; 0X0F];\n\n        String s = new String(tempArr);\n        return s;\n    &#125;\n\n\n&#125;\n</code></pre>\n<p><font size=\"4\" color=\"orange\">2. 生成二维码</font></p>\n<p>生成二维码首先需要引入Google的开发包zxing</p>\n<pre><code class=\"java\">        &lt;!--二维码相关--&gt;\n        &lt;!-- https://mvnrepository.com/artifact/com.google.zxing/javase --&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;com.google.zxing&lt;/groupId&gt;\n            &lt;artifactId&gt;javase&lt;/artifactId&gt;\n            &lt;version&gt;3.4.1&lt;/version&gt;\n        &lt;/dependency&gt;\n</code></pre>\n<p>生成二维码的工具类代码，可以看出二维码是BitMatrix，二维码生成后以png输出到响应流response中</p>\n<pre><code class=\"java\">    /**\n     * 生成二维码的图片流，其中content就是我们塞入二维码的内容\n     * @param content\n     * @param resp\n     * @return BitMatrix 是一个比特的矩阵\n     */\n    public static BitMatrix generateQRCodeStream(String content, HttpServletResponse resp)&#123;\n        // 给相应添加头部信息，主要告诉浏览器返回的是图片流\n        resp.setHeader(&quot;Cache-Control&quot;, &quot;no-store&quot;); // 不设定缓存，因为二维码会过期\n        resp.setHeader(&quot;Pragma&quot;, &quot;no-cache&quot;);\n        resp.setDateHeader(&quot;Expires&quot;, 0);\n        resp.setContentType(&quot;image/png&quot;); // 告诉浏览器是文件流\n\n        // 设置图片的文字编码和内边框距\n        Map&lt;EncodeHintType, Object&gt; hints = new HashMap&lt;EncodeHintType, Object&gt;();\n        hints.put(EncodeHintType.CHARACTER_SET, &quot;UTF-8&quot;);\n        hints.put(EncodeHintType.MARGIN, 0);\n        BitMatrix bitMatrix;\n        try&#123;\n            // 生成二维码，参数顺序分别为：编码内容（一般为url）、编码类型、生成图片宽度、生成图片宽度、设置参数\n            bitMatrix = new MultiFormatWriter().encode(content, BarcodeFormat.QR_CODE, 300, 300, hints);\n        &#125;catch(WriterException e)&#123;\n            e.printStackTrace();\n            return null;\n        &#125;\n        return bitMatrix;\n    &#125;\n</code></pre>\n<p><font size=\"4\" color=\"orange\">3. 生成二维码的controller层</font></p>\n<p>controller层将微信回传的url封到二维码中，其中url中的state字段可以为我们添加一些辅助信息（例如授权时需要知道往哪个店铺进行授权员工操作就需要知道店铺的id），当扫码者扫描时回传用户的信息到指定的redirect_url通过把事先定义好的state字段以get形式返回，以进行辅助操作。这里我们塞入了两个字段一个是shopId以及二维码的生成时间createTime，createTime字段可以帮助我们在回传信息时判断二维码是否超过我们指定的时间间隔</p>\n<pre><code class=\"java\">    /**\n     * 将微信回传用户信息的url放入到二维码中，并通过Response返回个前台填充到&lt;img src/&gt;中的src属性中\n     * @param request\n     * @param response\n     */\n    @RequestMapping(value=&quot;/generateqrcodeshopauth&quot;, method=RequestMethod.GET)\n    @ResponseBody\n    public void generateQRCodeShopAuth(HttpServletRequest request, HttpServletResponse response)&#123;\n        // 附加上必要的店铺信息到微信回传的state中，这样才知道回传用户信息往哪个店铺添加\n        Shop shop = (Shop)request.getSession().getAttribute(&quot;currentShop&quot;);\n        if(shop != null &amp;&amp; shop.getShopId() != null)&#123;\n            // 获取当前时间戳，以保证二维码的时间有效性，防止他人滥用，精确到毫秒\n            long timeStamp = System.currentTimeMillis();\n            // 加上aaa是为了方便剥离相应的信息\n            String content = &quot;&#123;aaashopIdaaa:&quot; + shop.getShopId() + &quot;,aaacreateTimeaaa:&quot; + timeStamp + &quot;&#125;&quot;;\n            try&#123;\n                // 将content的信息先进行Base64编码，防止特殊字符对url进行干扰\n                String longUrl = urlPrefix + authUrl + urlMiddle + URLEncoder.encode(content, &quot;UTF-8&quot;) + urlSuffix;\n                // 将目标url转为短的URL，防止微信扫码失效\n                String shortUrl = ShortNetAddressUtil.getShortURL(longUrl);\n                BitMatrix bitMatrix = CodeUtil.generateQRCodeStream(shortUrl, response);\n                // 将二维码图片流输出到响应流中\n                MatrixToImageWriter.writeToStream(bitMatrix, &quot;png&quot;, response.getOutputStream());\n            &#125;catch(Exception e)&#123;\n                e.printStackTrace();\n                logger.error(e.toString());\n            &#125;\n        &#125;\n    &#125;\n</code></pre>\n<p>前台通过<img>标签中的src就可以请求响应的二维码图片流</p>\n<pre><code class=\"html\">&lt;img src=&quot;/o2o/shopadmin/generateqrcodeshopauth&quot; id=&quot;auth-img&quot;/\n</code></pre>\n<p><font size=\"4\" color=\"orange\">4. 微信回传信息处理controller层</font></p>\n<p>扫码者扫码后回传信息处理的controller，这里需要和redirect_url保持一致，这样才能正确接收到微信回传的用户信息。</p>\n<ul>\n<li><p>获取微信回传用户信息，主要是通过code字段、appid以及secret字段（这些字段是通过微信测试号进行获取的，获取需要绑定指定的域名的controller层，这个controller层主要是微信辅助校验域名的有效性）获取到用户的token字段以及openId字段，然后再通过token字段和openId字段回传给微信获取用户的信息</p>\n</li>\n<li><p>为了防止二维码泄漏，被反复操作，这里通过vaildQRCode来检测回传的state字段中的createTime检测二维码是否过期。</p>\n</li>\n<li><p>为了防止二维码被反复扫描，恶意入库，这里通过checkOpenIdRegister检测回传用户信息的openId是否已经注册过，如果已经注册过就不在入库。</p>\n<pre><code class=\"java\">/**\n   * 将二维码打开的url回传的微信用户信息进行授权\n   * @param request\n   * @return\n   */\n  // todo 调试\n  @RequestMapping(value=&quot;/addshopauthmap&quot;)\n  public ModelAndView addShopAuthMap(HttpServletRequest request)&#123;\n      ModelAndView authFail = new ModelAndView(&quot;shop/shopauthfail&quot;);\n      ModelAndView authSuccess = new ModelAndView(&quot;shop/shopauthsuccess&quot;);\n      // 获取店铺信息\n      String state = HttpServletRequestUtil.getString(request, &quot;state&quot;);\n      String jsonStr = state.replaceAll(&quot;aaa&quot;, &quot;\\&quot;&quot;);\n      ObjectMapper objectMapper = new ObjectMapper();\n      WechatInfo wechatInfo = null;\n      try&#123;\n          wechatInfo = objectMapper.readValue(jsonStr, WechatInfo.class);\n      &#125; catch (JsonMappingException e) &#123;\n          e.printStackTrace();\n      &#125; catch (JsonProcessingException e) &#123;\n          e.printStackTrace();\n      &#125;\n\n      // 获取微信回传得到的用户信息\n      String code = request.getParameter(&quot;code&quot;);\n      PersonInfo personInfo = null;\n      try&#123;\n         UserAccessToken userAccessToken =  WechatUtil.getUserAccessToken(code);\n         String openId = userAccessToken.getOpenId();\n         WechatUser wechatUser = WechatUtil.getUserInfo(userAccessToken.getAccessToken(), openId);\n         personInfo = WechatUtil.getPersonInfo(wechatUser);\n         personInfo.setUserType(4); // 设置为店家的管理员\n         // 如果openId对应用户未注册过则进行注册\n         if(!checkOpenIdRegister(openId))&#123;\n             WechatAuth wechatAuth = new WechatAuth();\n             wechatAuth.setOpenId(openId);\n             wechatAuth.setPersonInfo(personInfo);\n             WechatExecution execution = wechatAuthService.register(wechatAuth);\n             if(execution.getState() != WechatAuthStateEnum.SUCCESS.getState())&#123;\n                 logger.info(&quot;error&quot;);\n                 return authFail;\n             &#125;\n         &#125;else&#123;\n             // 如果注册过，则查询数据库以填充personInfo的userId，后面才可以进行店铺授权\n             WechatAuth temp = wechatAuthService.getWechatAuthById(openId);\n             personInfo = temp.getPersonInfo();\n         &#125;\n      &#125;catch (Exception e)&#123;\n          logger.error(e.toString());\n          return authFail;\n      &#125;\n\n      // 检查是否重复授权或者二维码过期，如果符合就返回失败的视图页面\n      if(checkAlreadyAuth(wechatInfo.getShopId(), personInfo.getUserId()) || !vaildQRCode(wechatInfo))&#123;\n          return authFail;\n      &#125;\n\n      // 如果前面操作都通过即未进行过授权以及二维码未过期，进行店铺授权\n      if(wechatInfo != null &amp;&amp; wechatInfo.getShopId() != null &amp;&amp; personInfo != null &amp;&amp; personInfo.getUserId() != null)&#123;\n          try&#123;\n              ShopAuthMap shopAuthMap = new ShopAuthMap();\n              shopAuthMap.setTitle(&quot;员工&quot;);\n              shopAuthMap.setTitleFlag(1);\n              Shop shop = new Shop();\n              shop.setShopId(wechatInfo.getShopId());\n              shopAuthMap.setShop(shop);\n              shopAuthMap.setEmployee(personInfo);\n              ShopAuthMapExecution shopAuthMapExecution = shopAuthMapService.addShopAuthMap(shopAuthMap);\n              if(shopAuthMapExecution.getState() == ShopAuthMapStateEnum.AUTH_SUCCESS.getState())&#123;\n                  return authSuccess;\n              &#125;else&#123;\n                  logger.error(shopAuthMapExecution.getStateInfo());\n                  return authFail;\n              &#125;\n          &#125;catch (Exception e)&#123;\n              logger.error(e.toString());\n              return authFail;\n          &#125;\n      &#125;else&#123;\n          return authFail;\n      &#125;\n  &#125;\n\n  /**\n   * 检查openId是否注册过\n   * @param openId\n   * @return\n   */\n  private Boolean checkOpenIdRegister(String openId)&#123;\n      WechatAuth wechatAuth = wechatAuthService.getWechatAuthById(openId);\n      if(wechatAuth != null &amp;&amp; wechatAuth.getPersonInfo() != null)&#123;\n          return true;\n      &#125;\n      return false;\n  &#125;\n\n  /**\n   * 检查二维码是否过期\n   * @param wechatInfo\n   * @return\n   */\n  private Boolean vaildQRCode(WechatInfo wechatInfo) &#123;\n      if (wechatInfo != null &amp;&amp; wechatInfo.getCreateTime() != null &amp;&amp; wechatInfo.getShopId() != null) &#123;\n          Long expireTime = wechatInfo.getCreateTime();\n          Long currentTime = System.currentTimeMillis();\n          // 如果二维码创建时间和现在时间超过10分钟则失效\n          if (currentTime - expireTime &gt; 600000) &#123;\n              return false;\n          &#125; else &#123;\n              return true;\n          &#125;\n      &#125; else &#123;\n          return false;\n      &#125;\n  &#125;\n\n  /**\n   * 检查是否已经授权过，避免重复授权数据库一致插入\n   * @param shopId\n   * @param employeeId\n   * @return\n   */\n  private Boolean checkAlreadyAuth(Long shopId, Long employeeId)&#123;\n      ShopAuthMapExecution shopAuthMapExecution = shopAuthMapService.listShopAuthMapByShopId(shopId, 0, 100);\n      List&lt;ShopAuthMap&gt; list = shopAuthMapExecution.getShopAuthMapList();\n      for(ShopAuthMap shopAuthMap : list)&#123;\n          if(shopAuthMap.getEmployee().getUserId() == employeeId)&#123;\n              return true;\n          &#125;\n      &#125;\n      return false;\n  &#125;\n</code></pre>\n</li>\n</ul>\n","site":{"data":{"photography":[{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","title":"玉渊潭","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","title":"花儿","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","title":"白塔寺","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"}]}},"excerpt":"<blockquote>\n<p>二维码其实就是一个比特的矩阵，这个比特矩阵存储的是一个url，当二维码扫描时就会自动打开其中存储的url给服务器，这个url可能会通过GET方式给服务器传递一个扫码者的信息，服务器接收到请求后，将GET信息获取到进行处理就会返回一些页面给扫码者</p>\n</blockquote>\n<h3 id=\"背景需求\"><a href=\"#背景需求\" class=\"headerlink\" title=\"背景需求\"></a>背景需求</h3><p>在项目中，店铺授权二维码为扫码者申请扫码权限，需要首先获取到扫码者的个人信息，才能进行授权，为了获取扫码者的个人信息，这里我们使用微信测试号回传用户信息的url，如下所示</p>\n<pre><code class=\"http\">https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx6d9e79f7e8844954&amp;redirect_uri=http://81.70.249.115/o2o/shopadmin/addshopauthmap&amp;role_type=1&amp;response_type=code&amp;scope=snsapi_userinfo&amp;state=2#wechat_redirect\n</code></pre>\n<ul>\n<li>appid字段：是申请微信测试号给予的appid开发者字段以及一个密匙secret（后面在获取用户信息会使用secret字段进行校验）</li>\n<li>redirect_uri字段：就是我们web应用接收微信回传个人信息的url</li>\n<li>state字段：可以自定义一些业务逻辑需要的一些信息，例如店铺授权需要知道往哪个店铺进行授权，需要知道店铺id，例如知晓二维码是否过期，封装createTime二维码的创建时间</li>\n</ul>\n<p>扫码者打开微信扫描二维码时，就会访问这个url，微信就会将扫码者的信息传回给指定的redirect_uri，这个uri就可以通过code、accessToken、openId来获取用户的信息（这其中会涉及到多次二次验证），我们通过获取openId与数据库中的表tb_wechat_auth中查找该openId是否已经注册过，如果未注册就抓取其信息进行注册。</p>","more":"<h3 id=\"实践\"><a href=\"#实践\" class=\"headerlink\" title=\"实践\"></a>实践</h3><p><font size=\"4\" color=\"orange\">1. 申请微信测试号（<a href=\"https://mp.weixin.qq.com/debug/cgi-bin/sandboxinfo?action=showinfo&t=sandbox/index\">https://mp.weixin.qq.com/debug/cgi-bin/sandboxinfo?action=showinfo&amp;t=sandbox/index</a>）</font></p>\n<div align=\"center\"><img src=\"/2021/Spring/zxing%E4%BA%8C%E7%BB%B4%E7%A0%81%E7%9A%84%E7%94%9F%E6%88%90/1613878321918-810b6f23-69ad-4817-a58a-16739f945cec.png\" alt=\"image-20210129220709957\" style=\"zoom:50%;\"></div>\n\n<p>为了使用微信回传到我们指定的域名，微信要求需要实现对我们的域名进行认证，具体方法就是在我们的应用编写一个controller层，将微信传给的验证信息进行排序再返回即可<br><strong>这里回传排序好的信息给微信的url需要和图中的URL字段保持一致</strong></p>\n<pre><code class=\"java\"> /**\n * 微信用来验证网站是否和openId绑定的路由\n */\n@Controller\n@RequestMapping(value = &quot;/wechat&quot;)\npublic class WechatController &#123;\n    private static Logger logger = LoggerFactory.getLogger(WechatController.class);    \n    \n    @RequestMapping(method = RequestMethod.GET)\n    public void doGet(HttpServletRequest request, HttpServletResponse response) &#123;\n        String signature = HttpServletRequestUtil.getString(request, &quot;signature&quot;);\n        String timestamp = HttpServletRequestUtil.getString(request, &quot;timestamp&quot;);\n        String nonce = HttpServletRequestUtil.getString(request, &quot;nonce&quot;);\n        // 随机字符串\n        String echoStr = HttpServletRequestUtil.getString(request, &quot;echostr&quot;);\n\n        //通过对signature进行校验，如果成功则原封不动输出echoStr，失败则什么都不输出\n        PrintWriter out = null;\n        try &#123;\n            // 从response中接收到输出实例，是输出到响应流中的\n            out = response.getWriter();\n            if (SignUtil.checkSignature(signature, timestamp, nonce)) &#123;\n                logger.debug(&quot;weixin get success...&quot;);\n                out.println(echoStr);\n            &#125;\n        &#125; catch (IOException e) &#123;\n            e.printStackTrace();\n        &#125; finally &#123;\n            if (out != null) &#123;\n                out.close();\n            &#125;\n        &#125;\n    &#125;\n&#125;\n\npackage com.imooc.o2o.util.wechat;\n\nimport java.security.MessageDigest;\nimport java.security.NoSuchAlgorithmException;\nimport java.util.Arrays;\n\npublic class SignUtil &#123;\n    // 与微信开发者中设置的token要一致\n    private static String token = &quot;o2o&quot;;\n\n    /**\n     * 验证微信api发过来的签名，需要对三者进行排序，并拼接成一个字符串，然后进行sha1加密，然后与signature进行对比\n     *\n     * @param signature 微信加密签名\n     * @param timestamp 时间戳\n     * @param nonce     随机数\n     * @return\n     */\n    public static boolean checkSignature(String signature, String timestamp, String nonce) &#123;\n        String[] arr = new String[]&#123;token, timestamp, nonce&#125;;\n        Arrays.sort(arr);\n        StringBuilder stringBuilder = new StringBuilder();\n        for (int i = 0; i &lt; arr.length; i++) &#123;\n            stringBuilder.append(arr[i]);\n        &#125;\n        MessageDigest md = null;\n        String tempStr = &quot;&quot;;\n        try &#123;\n            md = MessageDigest.getInstance(&quot;SHA-1&quot;);\n            // 将三个字符串拼接成一个并进行SHA-1加密\n            byte[] digest = md.digest(stringBuilder.toString().getBytes());\n            tempStr = byteToStr(digest);\n        &#125; catch (NoSuchAlgorithmException e) &#123;\n            e.printStackTrace();\n        &#125;\n\n        stringBuilder = null;\n        // 将sha1加密后的字符串与微信发送的签名进行比较，标识该请求来源于微信\n        return tempStr != null ? tempStr.equals(signature.toUpperCase()) : false;\n    &#125;\n\n    /**\n     * 将字节组转换为十六进制字符串\n     *\n     * @param byteArray\n     * @return\n     */\n    private static String byteToStr(byte[] byteArray) &#123;\n        String strDigest = &quot;&quot;;\n        for (int i = 0; i &lt; byteArray.length; i++) &#123;\n            strDigest += byteToHexStr(byteArray[i]);\n        &#125;\n        return strDigest;\n    &#125;\n\n    /**\n     * 将字节转换为十六进制字符串\n     *\n     * @param mByte\n     * @return\n     */\n    private static String byteToHexStr(byte mByte) &#123;\n        char[] Digit = &#123;&#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;, &#39;8&#39;, &#39;9&#39;, &#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;, &#39;E&#39;, &#39;F&#39;&#125;;\n        char[] tempArr = new char[2];\n        tempArr[0] = Digit[(mByte &gt;&gt;&gt; 4) &amp; 0X0F];\n        tempArr[1] = Digit[mByte &amp; 0X0F];\n\n        String s = new String(tempArr);\n        return s;\n    &#125;\n\n\n&#125;\n</code></pre>\n<p><font size=\"4\" color=\"orange\">2. 生成二维码</font></p>\n<p>生成二维码首先需要引入Google的开发包zxing</p>\n<pre><code class=\"java\">        &lt;!--二维码相关--&gt;\n        &lt;!-- https://mvnrepository.com/artifact/com.google.zxing/javase --&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;com.google.zxing&lt;/groupId&gt;\n            &lt;artifactId&gt;javase&lt;/artifactId&gt;\n            &lt;version&gt;3.4.1&lt;/version&gt;\n        &lt;/dependency&gt;\n</code></pre>\n<p>生成二维码的工具类代码，可以看出二维码是BitMatrix，二维码生成后以png输出到响应流response中</p>\n<pre><code class=\"java\">    /**\n     * 生成二维码的图片流，其中content就是我们塞入二维码的内容\n     * @param content\n     * @param resp\n     * @return BitMatrix 是一个比特的矩阵\n     */\n    public static BitMatrix generateQRCodeStream(String content, HttpServletResponse resp)&#123;\n        // 给相应添加头部信息，主要告诉浏览器返回的是图片流\n        resp.setHeader(&quot;Cache-Control&quot;, &quot;no-store&quot;); // 不设定缓存，因为二维码会过期\n        resp.setHeader(&quot;Pragma&quot;, &quot;no-cache&quot;);\n        resp.setDateHeader(&quot;Expires&quot;, 0);\n        resp.setContentType(&quot;image/png&quot;); // 告诉浏览器是文件流\n\n        // 设置图片的文字编码和内边框距\n        Map&lt;EncodeHintType, Object&gt; hints = new HashMap&lt;EncodeHintType, Object&gt;();\n        hints.put(EncodeHintType.CHARACTER_SET, &quot;UTF-8&quot;);\n        hints.put(EncodeHintType.MARGIN, 0);\n        BitMatrix bitMatrix;\n        try&#123;\n            // 生成二维码，参数顺序分别为：编码内容（一般为url）、编码类型、生成图片宽度、生成图片宽度、设置参数\n            bitMatrix = new MultiFormatWriter().encode(content, BarcodeFormat.QR_CODE, 300, 300, hints);\n        &#125;catch(WriterException e)&#123;\n            e.printStackTrace();\n            return null;\n        &#125;\n        return bitMatrix;\n    &#125;\n</code></pre>\n<p><font size=\"4\" color=\"orange\">3. 生成二维码的controller层</font></p>\n<p>controller层将微信回传的url封到二维码中，其中url中的state字段可以为我们添加一些辅助信息（例如授权时需要知道往哪个店铺进行授权员工操作就需要知道店铺的id），当扫码者扫描时回传用户的信息到指定的redirect_url通过把事先定义好的state字段以get形式返回，以进行辅助操作。这里我们塞入了两个字段一个是shopId以及二维码的生成时间createTime，createTime字段可以帮助我们在回传信息时判断二维码是否超过我们指定的时间间隔</p>\n<pre><code class=\"java\">    /**\n     * 将微信回传用户信息的url放入到二维码中，并通过Response返回个前台填充到&lt;img src/&gt;中的src属性中\n     * @param request\n     * @param response\n     */\n    @RequestMapping(value=&quot;/generateqrcodeshopauth&quot;, method=RequestMethod.GET)\n    @ResponseBody\n    public void generateQRCodeShopAuth(HttpServletRequest request, HttpServletResponse response)&#123;\n        // 附加上必要的店铺信息到微信回传的state中，这样才知道回传用户信息往哪个店铺添加\n        Shop shop = (Shop)request.getSession().getAttribute(&quot;currentShop&quot;);\n        if(shop != null &amp;&amp; shop.getShopId() != null)&#123;\n            // 获取当前时间戳，以保证二维码的时间有效性，防止他人滥用，精确到毫秒\n            long timeStamp = System.currentTimeMillis();\n            // 加上aaa是为了方便剥离相应的信息\n            String content = &quot;&#123;aaashopIdaaa:&quot; + shop.getShopId() + &quot;,aaacreateTimeaaa:&quot; + timeStamp + &quot;&#125;&quot;;\n            try&#123;\n                // 将content的信息先进行Base64编码，防止特殊字符对url进行干扰\n                String longUrl = urlPrefix + authUrl + urlMiddle + URLEncoder.encode(content, &quot;UTF-8&quot;) + urlSuffix;\n                // 将目标url转为短的URL，防止微信扫码失效\n                String shortUrl = ShortNetAddressUtil.getShortURL(longUrl);\n                BitMatrix bitMatrix = CodeUtil.generateQRCodeStream(shortUrl, response);\n                // 将二维码图片流输出到响应流中\n                MatrixToImageWriter.writeToStream(bitMatrix, &quot;png&quot;, response.getOutputStream());\n            &#125;catch(Exception e)&#123;\n                e.printStackTrace();\n                logger.error(e.toString());\n            &#125;\n        &#125;\n    &#125;\n</code></pre>\n<p>前台通过<img>标签中的src就可以请求响应的二维码图片流</p>\n<pre><code class=\"html\">&lt;img src=&quot;/o2o/shopadmin/generateqrcodeshopauth&quot; id=&quot;auth-img&quot;/\n</code></pre>\n<p><font size=\"4\" color=\"orange\">4. 微信回传信息处理controller层</font></p>\n<p>扫码者扫码后回传信息处理的controller，这里需要和redirect_url保持一致，这样才能正确接收到微信回传的用户信息。</p>\n<ul>\n<li><p>获取微信回传用户信息，主要是通过code字段、appid以及secret字段（这些字段是通过微信测试号进行获取的，获取需要绑定指定的域名的controller层，这个controller层主要是微信辅助校验域名的有效性）获取到用户的token字段以及openId字段，然后再通过token字段和openId字段回传给微信获取用户的信息</p>\n</li>\n<li><p>为了防止二维码泄漏，被反复操作，这里通过vaildQRCode来检测回传的state字段中的createTime检测二维码是否过期。</p>\n</li>\n<li><p>为了防止二维码被反复扫描，恶意入库，这里通过checkOpenIdRegister检测回传用户信息的openId是否已经注册过，如果已经注册过就不在入库。</p>\n<pre><code class=\"java\">/**\n   * 将二维码打开的url回传的微信用户信息进行授权\n   * @param request\n   * @return\n   */\n  // todo 调试\n  @RequestMapping(value=&quot;/addshopauthmap&quot;)\n  public ModelAndView addShopAuthMap(HttpServletRequest request)&#123;\n      ModelAndView authFail = new ModelAndView(&quot;shop/shopauthfail&quot;);\n      ModelAndView authSuccess = new ModelAndView(&quot;shop/shopauthsuccess&quot;);\n      // 获取店铺信息\n      String state = HttpServletRequestUtil.getString(request, &quot;state&quot;);\n      String jsonStr = state.replaceAll(&quot;aaa&quot;, &quot;\\&quot;&quot;);\n      ObjectMapper objectMapper = new ObjectMapper();\n      WechatInfo wechatInfo = null;\n      try&#123;\n          wechatInfo = objectMapper.readValue(jsonStr, WechatInfo.class);\n      &#125; catch (JsonMappingException e) &#123;\n          e.printStackTrace();\n      &#125; catch (JsonProcessingException e) &#123;\n          e.printStackTrace();\n      &#125;\n\n      // 获取微信回传得到的用户信息\n      String code = request.getParameter(&quot;code&quot;);\n      PersonInfo personInfo = null;\n      try&#123;\n         UserAccessToken userAccessToken =  WechatUtil.getUserAccessToken(code);\n         String openId = userAccessToken.getOpenId();\n         WechatUser wechatUser = WechatUtil.getUserInfo(userAccessToken.getAccessToken(), openId);\n         personInfo = WechatUtil.getPersonInfo(wechatUser);\n         personInfo.setUserType(4); // 设置为店家的管理员\n         // 如果openId对应用户未注册过则进行注册\n         if(!checkOpenIdRegister(openId))&#123;\n             WechatAuth wechatAuth = new WechatAuth();\n             wechatAuth.setOpenId(openId);\n             wechatAuth.setPersonInfo(personInfo);\n             WechatExecution execution = wechatAuthService.register(wechatAuth);\n             if(execution.getState() != WechatAuthStateEnum.SUCCESS.getState())&#123;\n                 logger.info(&quot;error&quot;);\n                 return authFail;\n             &#125;\n         &#125;else&#123;\n             // 如果注册过，则查询数据库以填充personInfo的userId，后面才可以进行店铺授权\n             WechatAuth temp = wechatAuthService.getWechatAuthById(openId);\n             personInfo = temp.getPersonInfo();\n         &#125;\n      &#125;catch (Exception e)&#123;\n          logger.error(e.toString());\n          return authFail;\n      &#125;\n\n      // 检查是否重复授权或者二维码过期，如果符合就返回失败的视图页面\n      if(checkAlreadyAuth(wechatInfo.getShopId(), personInfo.getUserId()) || !vaildQRCode(wechatInfo))&#123;\n          return authFail;\n      &#125;\n\n      // 如果前面操作都通过即未进行过授权以及二维码未过期，进行店铺授权\n      if(wechatInfo != null &amp;&amp; wechatInfo.getShopId() != null &amp;&amp; personInfo != null &amp;&amp; personInfo.getUserId() != null)&#123;\n          try&#123;\n              ShopAuthMap shopAuthMap = new ShopAuthMap();\n              shopAuthMap.setTitle(&quot;员工&quot;);\n              shopAuthMap.setTitleFlag(1);\n              Shop shop = new Shop();\n              shop.setShopId(wechatInfo.getShopId());\n              shopAuthMap.setShop(shop);\n              shopAuthMap.setEmployee(personInfo);\n              ShopAuthMapExecution shopAuthMapExecution = shopAuthMapService.addShopAuthMap(shopAuthMap);\n              if(shopAuthMapExecution.getState() == ShopAuthMapStateEnum.AUTH_SUCCESS.getState())&#123;\n                  return authSuccess;\n              &#125;else&#123;\n                  logger.error(shopAuthMapExecution.getStateInfo());\n                  return authFail;\n              &#125;\n          &#125;catch (Exception e)&#123;\n              logger.error(e.toString());\n              return authFail;\n          &#125;\n      &#125;else&#123;\n          return authFail;\n      &#125;\n  &#125;\n\n  /**\n   * 检查openId是否注册过\n   * @param openId\n   * @return\n   */\n  private Boolean checkOpenIdRegister(String openId)&#123;\n      WechatAuth wechatAuth = wechatAuthService.getWechatAuthById(openId);\n      if(wechatAuth != null &amp;&amp; wechatAuth.getPersonInfo() != null)&#123;\n          return true;\n      &#125;\n      return false;\n  &#125;\n\n  /**\n   * 检查二维码是否过期\n   * @param wechatInfo\n   * @return\n   */\n  private Boolean vaildQRCode(WechatInfo wechatInfo) &#123;\n      if (wechatInfo != null &amp;&amp; wechatInfo.getCreateTime() != null &amp;&amp; wechatInfo.getShopId() != null) &#123;\n          Long expireTime = wechatInfo.getCreateTime();\n          Long currentTime = System.currentTimeMillis();\n          // 如果二维码创建时间和现在时间超过10分钟则失效\n          if (currentTime - expireTime &gt; 600000) &#123;\n              return false;\n          &#125; else &#123;\n              return true;\n          &#125;\n      &#125; else &#123;\n          return false;\n      &#125;\n  &#125;\n\n  /**\n   * 检查是否已经授权过，避免重复授权数据库一致插入\n   * @param shopId\n   * @param employeeId\n   * @return\n   */\n  private Boolean checkAlreadyAuth(Long shopId, Long employeeId)&#123;\n      ShopAuthMapExecution shopAuthMapExecution = shopAuthMapService.listShopAuthMapByShopId(shopId, 0, 100);\n      List&lt;ShopAuthMap&gt; list = shopAuthMapExecution.getShopAuthMapList();\n      for(ShopAuthMap shopAuthMap : list)&#123;\n          if(shopAuthMap.getEmployee().getUserId() == employeeId)&#123;\n              return true;\n          &#125;\n      &#125;\n      return false;\n  &#125;\n</code></pre>\n</li>\n</ul>"},{"title":"Redis使用","date":"2021-02-24T16:00:00.000Z","toc":true,"_content":"\n> redis是一个key-value型存储系统，支持的value类型比较丰富，支持String、List、集合set（没有顺序，元素唯一）、有序集合Zset，都支持push、pop、add、remove、交并集等操作，这些操作都是原子性的，调用redis的操作不用考虑多进程之间的并发问题。在此基础上，redis支持各种方式的排序，为了保证效率，数据都是缓存在内存中的，区别在于：redis会周期性的把更新的数据写到磁盘或者修改操作追加的记录文件中，前者就是默认的RDD模式，就是把数据写到临时文件中，持久化结束后，把临时文件替换为上次持久化的文件，达到数据恢复的目的，优点在于：使用单独子进程进行持久化，主进程不会进行任何IO操作，保证了redis的高效性能，缺点在于RDD是间隔一段时间进行持久化，如果持久化间隔期间，redis发生故障，那么这个持久化就不会更新到磁盘中，就会发生数据的丢失。\n>\n> <!--more-->对于数据不那么严谨的应用，可以使用RDD模式。其存储机制默认设置为如果更改了一个key，则间隔900秒之后进行一次持久化存储，如果更改了十个key，则间隔300秒进行一次持久化存储，如果更改了一万个key，则1分钟之后进行持久化，持久化之后就会把最新的临时文件替换掉旧的RDD文件，使用RDD恢复数据，实际就是重启redis，redis会从rdd文件恢复数据；第二种就是AOF操作，就是把执行过的指令记录下来，恢复时就是把这些操作重新回放一遍，优点就是可以保持更高的数据完整性。如果追加file的时间是1s，一旦redis发生故障那么最多丢失数据的时间是1s，这一秒的数据丢失，且如果日志写入不完整，可以使用redis-check-aof对日志文件进行修复，aof文件没有被write之前，可以删除一些其中操作，缺点就是文件比RDD文件大，恢复的时间比较久，其实AOF和MYSQL中的binlog差不多，都是记录操作。\n\n使用意图：就是将一些不经常更改的数据写入到redis中，例如店铺类别、区域信息、头条信息等，这些数据都是读取比较多，写比较少。\n\n* 客户端读取数据：首先把请求发送给redis，如果redis有请求的数据那么就把数据直接返回给客户端，避免使用数据库，如果redis没有请求的数据，就把请求发给数据库，数据库获取到数据后，返回给客户端，同时把redis中的数据进行更新，保证redis始终返回的是新的数据。\n\n* 客户端写入/修改数据：当数据发生变化或者修改，要同步的更新redis中的数据，简单点的操作就是数据发生修改时，就将redis相应的key的数据清空，如果客户端请求最新数据，因为redis没有，所以请求发给了DB，DB返回数据给客户端，同时把最新数据插入到了redis，保证了redis是最新的数据。\n\n  <div align='center'><img src=\"1612949134565-6f08df50-431b-40ba-ba8e-eac9104e8f9d-20210225113349251.png\" alt=\"image-20210129220709957\" style=\"zoom:50%;\" /></div>\n\n### 业务逻辑\n\n首先先看一下业务逻辑读和写时如何加入Redis缓存，对于读多写少数据，使用Redis缓存时明智的例如滚动展示的头条。采用Redis缓存，需要先定义存放的key，对于不同条件查询对象配置不同的key\n\n当遇到请求，先检查Redis是否存在该key，否则从数据库取出然后放入到Redis中，注意不同的查询条件对应的数据key不可相同，否则就乱套了\n\n```java\npackage com.imooc.o2o.service.impl;\n\nimport com.fasterxml.jackson.core.JsonProcessingException;\nimport com.fasterxml.jackson.databind.JavaType;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.imooc.o2o.cache.JedisUtil;\nimport com.imooc.o2o.dao.ShopCategoryDao;\nimport com.imooc.o2o.entity.ShopCategory;\nimport com.imooc.o2o.exceptions.ShopOperationException;\nimport com.imooc.o2o.service.ShopCategoryService;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.stereotype.Service;\n\nimport java.io.IOException;\nimport java.util.ArrayList;\nimport java.util.List;\n\n@Service\npublic class ShopCategoryServiceImpl implements ShopCategoryService {\n    @Autowired\n    private ShopCategoryDao shopCategoryDao;\n    @Autowired\n    private JedisUtil.Keys keys;\n    @Autowired\n    private JedisUtil.Strings strings;\n\n    private Logger logger = LoggerFactory.getLogger(ShopCategoryServiceImpl.class);\n\n    @Override\n    public List<ShopCategory> queryShopCategory(ShopCategory shopCategoryCondition) {\n        String key = SHOP_CATEGORY_KEY;\n        List<ShopCategory> list = null;\n        ObjectMapper mapper = new ObjectMapper();\n        if(shopCategoryCondition == null){\n          // 查询一级店铺类别\n            key = SHOP_CATEGORY_KEY + \"_parent_null\"; \n        }else if(shopCategoryCondition.getParent() != null && shopCategoryCondition.getParent().getShopCategoryId() != null){\n          // 查询对应以及类别下的二级类别\n            key = SHOP_CATEGORY_KEY + \"_parent_\" + shopCategoryCondition.getParent().getShopCategoryId();\n        }else{\n          // 查询所有二级店铺类别\n            key = SHOP_CATEGORY_KEY + \"_parent_not_null_all\"; \n        }\n\n      \t// Reids不存在则从数据库取出，取出成功后放入到缓存中\n        if(!keys.exists(key)){\n            list = shopCategoryDao.queryShopCategory(shopCategoryCondition);\n            try {\n              \t// 因为是对象，所以这里采用转换为JSON字符串转入\n                String jsonString = mapper.writeValueAsString(list);\n                strings.set(key, jsonString);\n            } catch (JsonProcessingException e) {\n                logger.error(\"queryShopCategory error:\" + e.getMessage());\n                e.printStackTrace();\n                throw new ShopOperationException(\"queryShopCategory error:\" + e.getMessage());\n            }\n        }else{\n          \t// 从Redis缓存中读出字符串，经过JSON转换为对象\n             String jsonString = strings.get(key);\n             JavaType javaType = mapper.getTypeFactory().constructParametricType(ArrayList.class, ShopCategory.class);\n            try {\n                list = mapper.readValue(jsonString, javaType);\n            } catch (IOException e) {\n                logger.error(\"queryShopCategory error:\" + e.getMessage());\n                e.printStackTrace();\n                throw new ShopOperationException(\"queryShopCategory error:\" + e.getMessage());\n            }\n        }\n        return list;\n    }\n    \n    // 插入数据需要清除所有相关Redis缓存\n    public ShopCategoryExecution insertShopCategory(ShopCategory shopCategory){\n        try{\n            int effectNum = shopCategoryDao.insertShopCategory(shopCategory);\n            // 插入成功则需要清除Redis缓存\n            if(effectNum > 0){\n                // 将所有key为SHOP_CATEGORY_KEY打头的数据全部从Redis缓存中清除\n                cacheService.removeKeys(SHOP_CATEGORY_KEY);\n                return ShopCategoryExecution(ShopCategoryStateEnum.SCCESS);\n            }else{\n                return ShopCategoryExecution(ShopCategoryStateEnum.FAIL);\n            }\n        }catch(Exception e){\n            logger.error(\"插入失败：\" + e.toString());\n            throw new ShopCategoryException(e.toString());\n        }\n    }\n}\n```\n\n\n\n在添加数据时注意清除缓存，下次取就会直接去数据库进行取然后放入缓存中，保证缓存中始终是最新的数据\n\n```java\npackage com.imooc.o2o.service.impl;//package com.imooc.o2o.service.impl;\n\nimport com.imooc.o2o.cache.JedisUtil;\nimport com.imooc.o2o.service.CacheService;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.stereotype.Service;\n\nimport java.util.Set;\n\n@Service\npublic class CacheServiceImpl implements CacheService {\n    @Autowired\n    private JedisUtil.Keys keys;\n\n    @Override\n    public void removeKeys(String prefix) {\n        // 首先找到所有以prefix为前缀的key集合\n        Set<String> set = keys.keys(prefix + \"*\");\n        for(String key : set){\n            keys.del(key);\n        }\n    }\n}\n```\n\n\n\n### 实现Redis配置\n\n配置Redis，首先pom中引入Redis客户端，与远程Redis进行通信\n\n```xml\n        <!--redis客户端:Jedis，与redis服务器进行通信-->\n        <dependency>\n            <groupId>redis.clients</groupId>\n            <artifactId>jedis</artifactId>\n            <version>2.9.0</version>\n        </dependency>\n```\n\napplication.properties引入redis基础配置，这些配置后续会通过编码读入\n\n```properties\n# reids配置\nredis.hostname=127.0.0.1\nredis.port=6379\nredis.database=0\nredis.pool.maxActive=600\nredis.pool.maxIdle=300\nredis.pool.maxWait=3000\nredis.pool.testOnBorrow=true\n```\n\n**连接池JedisPool**\n\n读取Redis配置生成Redis连接池JedisPool\n\n```java\npackage com.imooc.o2o.cache;\n\nimport org.springframework.context.annotation.Bean;\nimport redis.clients.jedis.JedisPool;\nimport redis.clients.jedis.JedisPoolConfig;\n\n/**\n * 强指定redis的JedisPool接口构造函数，这样才能在centos中成功创建jedispool\n */\npublic class JedisPoolWriper {\n    private JedisPool jedisPool;\n\n    public JedisPoolWriper() {\n    }\n\n    public JedisPoolWriper(final JedisPoolConfig poolConfig, final String host, final int port) {\n        try {\n            jedisPool = new JedisPool(poolConfig, host, port);\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n    }\n\n    public JedisPool getJedisPool() {\n        return jedisPool;\n    }\n\n    public void setJedisPool(JedisPool jedisPool) {\n        this.jedisPool = jedisPool;\n    }\n}\n```\n\n\n\n**注入Redis配置到容器**\n\n包括Redis连接池配置JedisPoolConfig，JedisPool连接，Jedis基本数据常见API\n\n其中可以看到添加@Configuration注解，就是读取相应application.properties配置\n\nJedisPoolConfig、JedisPool都添加了@Bean注解，需要在项目启动时注入到容器中\n\n```java\npackage com.imooc.o2o.config.redis;\n\nimport com.imooc.o2o.cache.JedisPoolWriper;\nimport com.imooc.o2o.cache.JedisUtil;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport redis.clients.jedis.JedisPoolConfig;\n\n@Configuration\npublic class RedisConfiguration {\n    @Value(\"${redis.pool.maxActive}\")\n    private int maxActive;\n    @Value(\"${redis.hostname}\")\n    private String hostname;\n    @Value(\"${redis.port}\")\n    private int port;\n    @Value(\"${redis.pool.maxIdle}\")\n    private int maxIdle;\n    @Value(\"${redis.pool.maxWait}\")\n    private int maxWait;\n    @Value(\"${redis.pool.testOnBorrow}\")\n    private boolean testOnBorrow;\n\n    @Autowired\n    private JedisPoolConfig jedisPoolConfig;\n    @Autowired\n    private JedisPoolWriper jedisWritePool;\n    @Autowired\n    private JedisUtil jedisUtil;\n\n    /**\n     * redis连接池配置\n     * @return\n     */\n    @Bean(\"jedisPoolConfig\")\n    public JedisPoolConfig createJedisPoolConfig() {\n        JedisPoolConfig jedisPoolConfig = new JedisPoolConfig();\n        // 控制一个pool可以分配多少个jedis实例\n        jedisPoolConfig.setMaxTotal(maxActive);\n        // 连接池最多空闲多少个连接\n        // 表示解释没有数据库连接时依然保持的链接数目，而不被清除，随时处于待命状态\n        jedisPoolConfig.setMaxIdle(maxIdle);\n        // 最大等待时间：但没有可用连接时，连接池等待连接被归还的最大时间，超出时间则抛出异常\n        jedisPoolConfig.setMaxWaitMillis(maxWait);\n        // 在获取连接时检查有效性\n        jedisPoolConfig.setTestOnBorrow(testOnBorrow);\n        return jedisPoolConfig;\n    }\n\n    /**\n     * 创建Redis连接池，并做相关配置\n     * @return\n     */\n    @Bean(\"jedisWritePool\")\n    public JedisPoolWriper createJedisPoolWriper(){\n        JedisPoolWriper jedisPoolWriper = new JedisPoolWriper(jedisPoolConfig, hostname, port);\n        return jedisPoolWriper;\n    }\n\n    /**\n     * 创建Redis工具类，封装好redis的连接已进行相关操作\n     * @return\n     */\n    @Bean(\"jedisUtil\")\n    public JedisUtil createJedisUtil(){\n        JedisUtil jedisUtil = new JedisUtil();\n        jedisUtil.setJedisPool(jedisWritePool);\n        return jedisUtil;\n    }\n\n    /**\n     * jedis的key操作\n     * @return\n     */\n    @Bean(\"jedisKeys\")\n    public JedisUtil.Keys createKeys(){\n        // 注意内部类的new方式\n        JedisUtil.Keys keys = jedisUtil.new Keys();\n        return keys;\n    }\n\n    /**\n     * jedis的Strings操作\n     * @return\n     */\n    @Bean(\"jedisStrings\")\n    public JedisUtil.Strings createStrings(){\n        JedisUtil.Strings strings = jedisUtil.new Strings();\n        return strings;\n    }\n}\n```\n\n**编写Jedis工具类**\n\n将Jedis常用数据对象浅浅的封装一层，封装一层的目的在于：使用第三方组件时，浅浅封装一层避免直接调用API，可以在后续项目时随时更改，而项目其他地方不用更改，例如后续项目需要监控Redis取缓存时间，那么朱旭在封装前后，统计一下时间即可\n\n```java\n        /**\n         * 根据key获取记录\n         *\n         * @param key\n         * @return 值\n         */\n        public String get(String key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            String value = sjedis.get(key);\n            sjedis.close();\n            return value;\n        }\n```\n\n项目需要统计取key消耗时间\n\n```java\n        /**\n         * 根据key获取记录，统计操作时间\n         *\n         * @param key\n         * @return 值\n         */\n        public String get(String key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            long startTime = System.currentTimeMillis();\n            System.get\n            Jedis sjedis = getJedis();\n            String value = sjedis.get(key);\n                long endTime = System.currentTimeMillis();\n                logger.info(String.format(\"get Strings key:%d cost %d ms\"), key, endTime - startTime);\n            sjedis.close();\n            return value;\n        }\n```\n\n\n\n**JedisUtil工具类**\n\nJedisUtil浅浅封装一层Redis常见数据对象的方法\n\n```java\npackage com.imooc.o2o.cache;\n\nimport redis.clients.jedis.BinaryClient;\nimport redis.clients.jedis.Jedis;\nimport redis.clients.jedis.JedisPool;\nimport redis.clients.jedis.SortingParams;\nimport redis.clients.util.SafeEncoder;\n\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Set;\n\npublic class JedisUtil {\n    /**\n     * 缓存生存时间\n     */\n    private final int expire = 60000;\n    /**\n     * 操作Key的方法\n     */\n    public Keys KEYS;\n    /**\n     * 对存储结构为String类型的操作\n     */\n    public Strings STRINGS;\n    /**\n     * 对存储结构为List类型的操作\n     */\n    public Lists LISTS;\n    /**\n     * 对存储结构为Set类型的操作\n     */\n    public Sets SETS;\n    /**\n     * 对存储结构为HashMap类型的操作\n     */\n    public Hash HASH;\n\n    private JedisPool jedisPool;\n\n    public JedisPool getJedisPool() {\n        return jedisPool;\n    }\n\n    public void setJedisPool(JedisPoolWriper jedisPoolWriper) {\n        this.jedisPool = jedisPoolWriper.getJedisPool();\n    }\n\n    public JedisPool getPool() {\n        return jedisPool;\n    }\n\n    /**\n     * 从jedis连接池中获取获取jedis对象\n     *\n     * @return\n     */\n    public Jedis getJedis() {\n        return jedisPool.getResource();\n    }\n\n    /**\n     * 设置过期时间\n     *\n     * @param @param\n     * @author ruan 2013-4-11\n     */\n    public void expire(String key, int seconds) {\n        if (seconds <= 0) {\n            return;\n        }\n        Jedis jedis = getJedis();\n        jedis.expire(key, seconds);\n        jedis.close();\n    }\n\n    /**\n     * 设置默认过期时间\n     *\n     * @param\n     * @author ruan 2013-4-11\n     */\n    public void expire(String key) {\n        expire(key, expire);\n    }\n\n    // *******************************************Keys*******************************************//\n    public class Keys {\n\n        /**\n         * 清空所有key\n         */\n        public String flushAll() {\n            Jedis jedis = getJedis();\n            String stata = jedis.flushAll();\n            jedis.close();\n            return stata;\n        }\n\n        /**\n         * 更改key\n         *\n         * @param oldkey\n         * @param newkey\n         * @return 状态码\n         */\n        public String rename(String oldkey, String newkey) {\n            return rename(SafeEncoder.encode(oldkey),\n                    SafeEncoder.encode(newkey));\n        }\n\n        /**\n         * 更改key,仅当新key不存在时才执行\n         *\n         * @param oldkey\n         * @param newkey\n         * @return 状态码\n         */\n        public long renamenx(String oldkey, String newkey) {\n            Jedis jedis = getJedis();\n            long status = jedis.renamenx(oldkey, newkey);\n            jedis.close();\n            return status;\n        }\n\n        /**\n         * 更改key\n         *\n         * @param oldkey\n         * @param newkey\n         * @return 状态码\n         */\n        public String rename(byte[] oldkey, byte[] newkey) {\n            Jedis jedis = getJedis();\n            String status = jedis.rename(oldkey, newkey);\n            jedis.close();\n            return status;\n        }\n\n        /**\n         * 设置key的过期时间，以秒为单位\n         *\n         * @param key\n         * @param seconds 已秒为单位\n         * @return 影响的记录数\n         */\n        public long expired(String key, int seconds) {\n            Jedis jedis = getJedis();\n            long count = jedis.expire(key, seconds);\n            jedis.close();\n            return count;\n        }\n\n        /**\n         * 设置key的过期时间,它是距历元（即格林威治标准时间 1970 年 1 月 1 日的 00:00:00，格里高利历）的偏移量。\n         *\n         * @param key\n         * @param timestamp 已秒为单位\n         * @return 影响的记录数\n         */\n        public long expireAt(String key, long timestamp) {\n            Jedis jedis = getJedis();\n            long count = jedis.expireAt(key, timestamp);\n            jedis.close();\n            return count;\n        }\n\n        /**\n         * 查询key的过期时间\n         *\n         * @param key\n         * @return 以秒为单位的时间表示\n         */\n        public long ttl(String key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            long len = sjedis.ttl(key);\n            sjedis.close();\n            return len;\n        }\n\n        /**\n         * 取消对key过期时间的设置\n         *\n         * @param key\n         * @return 影响的记录数\n         */\n        public long persist(String key) {\n            Jedis jedis = getJedis();\n            long count = jedis.persist(key);\n            jedis.close();\n            return count;\n        }\n\n        /**\n         * 删除keys对应的记录,可以是多个key\n         *\n         * @param keys\n         * @return 删除的记录数\n         */\n        public long del(String... keys) {\n            Jedis jedis = getJedis();\n            long count = jedis.del(keys);\n            jedis.close();\n            return count;\n        }\n\n        /**\n         * 删除keys对应的记录,可以是多个key\n         *\n         * @param keys\n         * @return 删除的记录数\n         */\n        public long del(byte[]... keys) {\n            Jedis jedis = getJedis();\n            long count = jedis.del(keys);\n            jedis.close();\n            return count;\n        }\n\n        /**\n         * 判断key是否存在\n         *\n         * @param key\n         * @return boolean\n         */\n        public boolean exists(String key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            boolean exis = sjedis.exists(key);\n            sjedis.close();\n            return exis;\n        }\n\n        /**\n         * 对List,Set,SortSet进行排序,如果集合数据较大应避免使用这个方法\n         *\n         * @param key\n         * @return List<String> 集合的全部记录\n         **/\n        public List<String> sort(String key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            List<String> list = sjedis.sort(key);\n            sjedis.close();\n            return list;\n        }\n\n        /**\n         * 对List,Set,SortSet进行排序或limit\n         *\n         * @param key\n         * @param parame 定义排序类型或limit的起止位置.\n         * @return List<String> 全部或部分记录\n         **/\n        public List<String> sort(String key, SortingParams parame) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            List<String> list = sjedis.sort(key, parame);\n            sjedis.close();\n            return list;\n        }\n\n        /**\n         * 返回指定key存储的类型\n         *\n         * @param key\n         * @return String string|list|set|zset|hash\n         **/\n        public String type(String key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            String type = sjedis.type(key);\n            sjedis.close();\n            return type;\n        }\n\n        /**\n         * 查找所有匹配给定的模式的键\n         *\n         * @param pattern key的表达式,*表示多个，？表示一个\n         */\n        public Set<String> keys(String pattern) {\n            Jedis jedis = getJedis();\n            Set<String> set = jedis.keys(pattern);\n            jedis.close();\n            return set;\n        }\n    }\n\n    // *******************************************Sets*******************************************//\n    public class Sets {\n\n        /**\n         * 向Set添加一条记录，如果member已存在返回0,否则返回1\n         *\n         * @param key\n         * @param member\n         * @return 操作码, 0或1\n         */\n        public long sadd(String key, String member) {\n            Jedis jedis = getJedis();\n            long s = jedis.sadd(key, member);\n            jedis.close();\n            return s;\n        }\n\n        public long sadd(byte[] key, byte[] member) {\n            Jedis jedis = getJedis();\n            long s = jedis.sadd(key, member);\n            jedis.close();\n            return s;\n        }\n\n        /**\n         * 获取给定key中元素个数\n         *\n         * @param key\n         * @return 元素个数\n         */\n        public long scard(String key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            long len = sjedis.scard(key);\n            sjedis.close();\n            return len;\n        }\n\n        /**\n         * 返回从第一组和所有的给定集合之间的差异的成员\n         *\n         * @param keys\n         * @return 差异的成员集合\n         */\n        public Set<String> sdiff(String... keys) {\n            Jedis jedis = getJedis();\n            Set<String> set = jedis.sdiff(keys);\n            jedis.close();\n            return set;\n        }\n\n        /**\n         * 这个命令等于sdiff,但返回的不是结果集,而是将结果集存储在新的集合中，如果目标已存在，则覆盖。\n         *\n         * @param newkey 新结果集的key\n         * @param keys   比较的集合\n         * @return 新集合中的记录数\n         **/\n        public long sdiffstore(String newkey, String... keys) {\n            Jedis jedis = getJedis();\n            long s = jedis.sdiffstore(newkey, keys);\n            jedis.close();\n            return s;\n        }\n\n        /**\n         * 返回给定集合交集的成员,如果其中一个集合为不存在或为空，则返回空Set\n         *\n         * @param keys\n         * @return 交集成员的集合\n         **/\n        public Set<String> sinter(String... keys) {\n            Jedis jedis = getJedis();\n            Set<String> set = jedis.sinter(keys);\n            jedis.close();\n            return set;\n        }\n\n        /**\n         * 这个命令等于sinter,但返回的不是结果集,而是将结果集存储在新的集合中，如果目标已存在，则覆盖。\n         *\n         * @param newkey 新结果集的key\n         * @param keys   比较的集合\n         * @return 新集合中的记录数\n         **/\n        public long sinterstore(String newkey, String... keys) {\n            Jedis jedis = getJedis();\n            long s = jedis.sinterstore(newkey, keys);\n            jedis.close();\n            return s;\n        }\n\n        /**\n         * 确定一个给定的值是否存在\n         *\n         * @param key\n         * @param member 要判断的值\n         * @return 存在返回1，不存在返回0\n         **/\n        public boolean sismember(String key, String member) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            boolean s = sjedis.sismember(key, member);\n            sjedis.close();\n            return s;\n        }\n\n        /**\n         * 返回集合中的所有成员\n         *\n         * @param key\n         * @return 成员集合\n         */\n        public Set<String> smembers(String key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            Set<String> set = sjedis.smembers(key);\n            sjedis.close();\n            return set;\n        }\n\n        public Set<byte[]> smembers(byte[] key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            Set<byte[]> set = sjedis.smembers(key);\n            sjedis.close();\n            return set;\n        }\n\n        /**\n         * 将成员从源集合移出放入目标集合 <br/>\n         * 如果源集合不存在或不包哈指定成员，不进行任何操作，返回0<br/>\n         * 否则该成员从源集合上删除，并添加到目标集合，如果目标集合中成员已存在，则只在源集合进行删除\n         *\n         * @param srckey 源集合\n         * @param dstkey 目标集合\n         * @param member 源集合中的成员\n         * @return 状态码，1成功，0失败\n         */\n        public long smove(String srckey, String dstkey, String member) {\n            Jedis jedis = getJedis();\n            long s = jedis.smove(srckey, dstkey, member);\n            jedis.close();\n            return s;\n        }\n\n        /**\n         * 从集合中删除成员\n         *\n         * @param key\n         * @return 被删除的成员\n         */\n        public String spop(String key) {\n            Jedis jedis = getJedis();\n            String s = jedis.spop(key);\n            jedis.close();\n            return s;\n        }\n\n        /**\n         * 从集合中删除指定成员\n         *\n         * @param key\n         * @param member 要删除的成员\n         * @return 状态码，成功返回1，成员不存在返回0\n         */\n        public long srem(String key, String member) {\n            Jedis jedis = getJedis();\n            long s = jedis.srem(key, member);\n            jedis.close();\n            return s;\n        }\n\n        /**\n         * 合并多个集合并返回合并后的结果，合并后的结果集合并不保存<br/>\n         *\n         * @param keys\n         * @return 合并后的结果集合\n         */\n        public Set<String> sunion(String... keys) {\n            Jedis jedis = getJedis();\n            Set<String> set = jedis.sunion(keys);\n            jedis.close();\n            return set;\n        }\n\n        /**\n         * 合并多个集合并将合并后的结果集保存在指定的新集合中，如果新集合已经存在则覆盖\n         *\n         * @param newkey 新集合的key\n         * @param keys   要合并的集合\n         **/\n        public long sunionstore(String newkey, String... keys) {\n            Jedis jedis = getJedis();\n            long s = jedis.sunionstore(newkey, keys);\n            jedis.close();\n            return s;\n        }\n    }\n\n    // *******************************************Hash*******************************************//\n    public class Hash {\n\n        /**\n         * 从hash中删除指定的存储\n         *\n         * @param key\n         * @param fieid 存储的名字\n         * @return 状态码，1成功，0失败\n         */\n        public long hdel(String key, String fieid) {\n            Jedis jedis = getJedis();\n            long s = jedis.hdel(key, fieid);\n            jedis.close();\n            return s;\n        }\n\n        public long hdel(String key) {\n            Jedis jedis = getJedis();\n            long s = jedis.del(key);\n            jedis.close();\n            return s;\n        }\n\n        /**\n         * 测试hash中指定的存储是否存在\n         *\n         * @param key\n         * @param fieid 存储的名字\n         * @return 1存在，0不存在\n         */\n        public boolean hexists(String key, String fieid) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            boolean s = sjedis.hexists(key, fieid);\n            sjedis.close();\n            return s;\n        }\n\n        /**\n         * 返回hash中指定存储位置的值\n         *\n         * @param key\n         * @param fieid 存储的名字\n         * @return 存储对应的值\n         */\n        public String hget(String key, String fieid) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            String s = sjedis.hget(key, fieid);\n            sjedis.close();\n            return s;\n        }\n\n        public byte[] hget(byte[] key, byte[] fieid) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            byte[] s = sjedis.hget(key, fieid);\n            sjedis.close();\n            return s;\n        }\n\n        /**\n         * 以Map的形式返回hash中的存储和值\n         *\n         * @param key\n         * @return Map<Strinig, String>\n         */\n        public Map<String, String> hgetAll(String key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            Map<String, String> map = sjedis.hgetAll(key);\n            sjedis.close();\n            return map;\n        }\n\n        /**\n         * 添加一个对应关系\n         *\n         * @param key\n         * @param fieid\n         * @param value\n         * @return 状态码 1成功，0失败，fieid已存在将更新，也返回0\n         **/\n        public long hset(String key, String fieid, String value) {\n            Jedis jedis = getJedis();\n            long s = jedis.hset(key, fieid, value);\n            jedis.close();\n            return s;\n        }\n\n        public long hset(String key, String fieid, byte[] value) {\n            Jedis jedis = getJedis();\n            long s = jedis.hset(key.getBytes(), fieid.getBytes(), value);\n            jedis.close();\n            return s;\n        }\n\n        /**\n         * 添加对应关系，只有在fieid不存在时才执行\n         *\n         * @param key\n         * @param fieid\n         * @param value\n         * @return 状态码 1成功，0失败fieid已存\n         **/\n        public long hsetnx(String key, String fieid, String value) {\n            Jedis jedis = getJedis();\n            long s = jedis.hsetnx(key, fieid, value);\n            jedis.close();\n            return s;\n        }\n\n        /**\n         * 获取hash中value的集合\n         *\n         * @param key\n         * @return List<String>\n         */\n        public List<String> hvals(String key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            List<String> list = sjedis.hvals(key);\n            sjedis.close();\n            return list;\n        }\n\n        /**\n         * 在指定的存储位置加上指定的数字，存储位置的值必须可转为数字类型\n         *\n         * @param key\n         * @param fieid 存储位置\n         * @param value 要增加的值,可以是负数\n         * @return 增加指定数字后，存储位置的值\n         */\n        public long hincrby(String key, String fieid, long value) {\n            Jedis jedis = getJedis();\n            long s = jedis.hincrBy(key, fieid, value);\n            jedis.close();\n            return s;\n        }\n\n        /**\n         * 返回指定hash中的所有存储名字,类似Map中的keySet方法\n         *\n         * @param key\n         * @return Set<String> 存储名称的集合\n         */\n        public Set<String> hkeys(String key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            Set<String> set = sjedis.hkeys(key);\n            sjedis.close();\n            return set;\n        }\n\n        /**\n         * 获取hash中存储的个数，类似Map中size方法\n         *\n         * @param key\n         * @return long 存储的个数\n         */\n        public long hlen(String key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            long len = sjedis.hlen(key);\n            sjedis.close();\n            return len;\n        }\n\n        /**\n         * 根据多个key，获取对应的value，返回List,如果指定的key不存在,List对应位置为null\n         *\n         * @param key\n         * @param fieids 存储位置\n         * @return List<String>\n         */\n        public List<String> hmget(String key, String... fieids) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            List<String> list = sjedis.hmget(key, fieids);\n            sjedis.close();\n            return list;\n        }\n\n        public List<byte[]> hmget(byte[] key, byte[]... fieids) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            List<byte[]> list = sjedis.hmget(key, fieids);\n            sjedis.close();\n            return list;\n        }\n\n        /**\n         * 添加对应关系，如果对应关系已存在，则覆盖\n         *\n         * @param key\n         * @param map 对应关系\n         * @return 状态，成功返回OK\n         */\n        public String hmset(String key, Map<String, String> map) {\n            Jedis jedis = getJedis();\n            String s = jedis.hmset(key, map);\n            jedis.close();\n            return s;\n        }\n\n        /**\n         * 添加对应关系，如果对应关系已存在，则覆盖\n         *\n         * @param key\n         * @param map 对应关系\n         * @return 状态，成功返回OK\n         */\n        public String hmset(byte[] key, Map<byte[], byte[]> map) {\n            Jedis jedis = getJedis();\n            String s = jedis.hmset(key, map);\n            jedis.close();\n            return s;\n        }\n\n    }\n\n    // *******************************************Strings*******************************************//\n    public class Strings {\n\n        /**\n         * 根据key获取记录\n         *\n         * @param key\n         * @return 值\n         */\n        public String get(String key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            String value = sjedis.get(key);\n            sjedis.close();\n            return value;\n        }\n\n        /**\n         * 根据key获取记录\n         *\n         * @param key\n         * @return 值\n         */\n        public byte[] get(byte[] key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            byte[] value = sjedis.get(key);\n            sjedis.close();\n            return value;\n        }\n\n        /**\n         * 添加有过期时间的记录\n         *\n         * @param key\n         * @param seconds 过期时间，以秒为单位\n         * @param value\n         * @return String 操作状态\n         */\n        public String setEx(String key, int seconds, String value) {\n            Jedis jedis = getJedis();\n            String str = jedis.setex(key, seconds, value);\n            jedis.close();\n            return str;\n        }\n\n        /**\n         * 添加有过期时间的记录\n         *\n         * @param key\n         * @param seconds 过期时间，以秒为单位\n         * @param value\n         * @return String 操作状态\n         */\n        public String setEx(byte[] key, int seconds, byte[] value) {\n            Jedis jedis = getJedis();\n            String str = jedis.setex(key, seconds, value);\n            jedis.close();\n            return str;\n        }\n\n        /**\n         * 添加一条记录，仅当给定的key不存在时才插入\n         *\n         * @param key\n         * @param value\n         * @return long 状态码，1插入成功且key不存在，0未插入，key存在\n         */\n        public long setnx(String key, String value) {\n            Jedis jedis = getJedis();\n            long str = jedis.setnx(key, value);\n            jedis.close();\n            return str;\n        }\n\n        /**\n         * 添加记录,如果记录已存在将覆盖原有的value\n         *\n         * @param key\n         * @param value\n         * @return 状态码\n         */\n        public String set(String key, String value) {\n            return set(SafeEncoder.encode(key), SafeEncoder.encode(value));\n        }\n\n        /**\n         * 添加记录,如果记录已存在将覆盖原有的value\n         *\n         * @param key\n         * @param value\n         * @return 状态码\n         */\n        public String set(String key, byte[] value) {\n            return set(SafeEncoder.encode(key), value);\n        }\n\n        /**\n         * 添加记录,如果记录已存在将覆盖原有的value\n         *\n         * @param key\n         * @param value\n         * @return 状态码\n         */\n        public String set(byte[] key, byte[] value) {\n            Jedis jedis = getJedis();\n            String status = jedis.set(key, value);\n            jedis.close();\n            return status;\n        }\n\n        /**\n         * 从指定位置开始插入数据，插入的数据会覆盖指定位置以后的数据<br/>\n         * 例:String str1=\"123456789\";<br/>\n         * 对str1操作后setRange(key,4,0000)，str1=\"123400009\";\n         *\n         * @param key\n         * @param offset\n         * @param value\n         * @return long value的长度\n         */\n        public long setRange(String key, long offset, String value) {\n            Jedis jedis = getJedis();\n            long len = jedis.setrange(key, offset, value);\n            jedis.close();\n            return len;\n        }\n\n        /**\n         * 在指定的key中追加value\n         *\n         * @param key\n         * @param value\n         * @return long 追加后value的长度\n         **/\n        public long append(String key, String value) {\n            Jedis jedis = getJedis();\n            long len = jedis.append(key, value);\n            jedis.close();\n            return len;\n        }\n\n        /**\n         * 将key对应的value减去指定的值，只有value可以转为数字时该方法才可用\n         *\n         * @param key\n         * @param number 要减去的值\n         * @return long 减指定值后的值\n         */\n        public long decrBy(String key, long number) {\n            Jedis jedis = getJedis();\n            long len = jedis.decrBy(key, number);\n            jedis.close();\n            return len;\n        }\n\n        /**\n         * <b>可以作为获取唯一id的方法</b><br/>\n         * 将key对应的value加上指定的值，只有value可以转为数字时该方法才可用\n         *\n         * @param key\n         * @param number 要减去的值\n         * @return long 相加后的值\n         */\n        public long incrBy(String key, long number) {\n            Jedis jedis = getJedis();\n            long len = jedis.incrBy(key, number);\n            jedis.close();\n            return len;\n        }\n\n        /**\n         * 对指定key对应的value进行截取\n         *\n         * @param key\n         * @param startOffset 开始位置(包含)\n         * @param endOffset   结束位置(包含)\n         * @return String 截取的值\n         */\n        public String getrange(String key, long startOffset, long endOffset) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            String value = sjedis.getrange(key, startOffset, endOffset);\n            sjedis.close();\n            return value;\n        }\n\n        /**\n         * 获取并设置指定key对应的value<br/>\n         * 如果key存在返回之前的value,否则返回null\n         *\n         * @param key\n         * @param value\n         * @return String 原始value或null\n         */\n        public String getSet(String key, String value) {\n            Jedis jedis = getJedis();\n            String str = jedis.getSet(key, value);\n            jedis.close();\n            return str;\n        }\n\n        /**\n         * 批量获取记录,如果指定的key不存在返回List的对应位置将是null\n         *\n         * @param keys\n         * @return List<String> 值得集合\n         */\n        public List<String> mget(String... keys) {\n            Jedis jedis = getJedis();\n            List<String> str = jedis.mget(keys);\n            jedis.close();\n            return str;\n        }\n\n        /**\n         * 批量存储记录\n         *\n         * @param keysvalues 例:keysvalues=\"key1\",\"value1\",\"key2\",\"value2\";\n         * @return String 状态码\n         */\n        public String mset(String... keysvalues) {\n            Jedis jedis = getJedis();\n            String str = jedis.mset(keysvalues);\n            jedis.close();\n            return str;\n        }\n\n        /**\n         * 获取key对应的值的长度\n         *\n         * @param key\n         * @return value值得长度\n         */\n        public long strlen(String key) {\n            Jedis jedis = getJedis();\n            long len = jedis.strlen(key);\n            jedis.close();\n            return len;\n        }\n    }\n\n    // *******************************************Lists*******************************************//\n    public class Lists {\n\n        /**\n         * List长度\n         *\n         * @param key\n         * @return 长度\n         */\n        public long llen(String key) {\n            return llen(SafeEncoder.encode(key));\n        }\n\n        /**\n         * List长度\n         *\n         * @param key\n         * @return 长度\n         */\n        public long llen(byte[] key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            long count = sjedis.llen(key);\n            sjedis.close();\n            return count;\n        }\n\n        /**\n         * 覆盖操作,将覆盖List中指定位置的值\n         *\n         * @param key\n         * @param index 位置\n         * @param value 值\n         * @return 状态码\n         */\n        public String lset(byte[] key, int index, byte[] value) {\n            Jedis jedis = getJedis();\n            String status = jedis.lset(key, index, value);\n            jedis.close();\n            return status;\n        }\n\n        /**\n         * 覆盖操作,将覆盖List中指定位置的值\n         *\n         * @param @param index 位置\n         * @param value  值\n         * @return 状态码\n         */\n        public String lset(String key, int index, String value) {\n            return lset(SafeEncoder.encode(key), index,\n                    SafeEncoder.encode(value));\n        }\n\n        /**\n         * 在value的相对位置插入记录\n         *\n         * @param @param 前面插入或后面插入\n         * @param pivot  相对位置的内容\n         * @param value  插入的内容\n         * @return 记录总数\n         */\n        public long linsert(String key, BinaryClient.LIST_POSITION where, String pivot,\n                            String value) {\n            return linsert(SafeEncoder.encode(key), where,\n                    SafeEncoder.encode(pivot), SafeEncoder.encode(value));\n        }\n\n        /**\n         * 在指定位置插入记录\n         *\n         * @param key\n         * @param where 前面插入或后面插入\n         * @param pivot 相对位置的内容\n         * @param value 插入的内容\n         * @return 记录总数\n         */\n        public long linsert(byte[] key, BinaryClient.LIST_POSITION where, byte[] pivot,\n                            byte[] value) {\n            Jedis jedis = getJedis();\n            long count = jedis.linsert(key, where, pivot, value);\n            jedis.close();\n            return count;\n        }\n\n        /**\n         * 获取List中指定位置的值\n         *\n         * @param key\n         * @param index 位置\n         * @return 值\n         **/\n        public String lindex(String key, int index) {\n            return SafeEncoder.encode(lindex(SafeEncoder.encode(key), index));\n        }\n\n        /**\n         * 获取List中指定位置的值\n         *\n         * @param key\n         * @param index 位置\n         * @return 值\n         **/\n        public byte[] lindex(byte[] key, int index) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            byte[] value = sjedis.lindex(key, index);\n            sjedis.close();\n            return value;\n        }\n\n        /**\n         * 将List中的第一条记录移出List\n         *\n         * @param key\n         * @return 移出的记录\n         */\n        public String lpop(String key) {\n            return SafeEncoder.encode(lpop(SafeEncoder.encode(key)));\n        }\n\n        /**\n         * 将List中的第一条记录移出List\n         *\n         * @param key\n         * @return 移出的记录\n         */\n        public byte[] lpop(byte[] key) {\n            Jedis jedis = getJedis();\n            byte[] value = jedis.lpop(key);\n            jedis.close();\n            return value;\n        }\n\n        /**\n         * 将List中最后第一条记录移出List\n         *\n         * @param key\n         * @return 移出的记录\n         */\n        public String rpop(String key) {\n            Jedis jedis = getJedis();\n            String value = jedis.rpop(key);\n            jedis.close();\n            return value;\n        }\n\n        /**\n         * 向List尾部追加记录\n         *\n         * @param key\n         * @param value\n         * @return 记录总数\n         */\n        public long lpush(String key, String value) {\n            return lpush(SafeEncoder.encode(key), SafeEncoder.encode(value));\n        }\n\n        /**\n         * 向List头部追加记录\n         *\n         * @param key\n         * @param value\n         * @return 记录总数\n         */\n        public long rpush(String key, String value) {\n            Jedis jedis = getJedis();\n            long count = jedis.rpush(key, value);\n            jedis.close();\n            return count;\n        }\n\n        /**\n         * 向List头部追加记录\n         *\n         * @param key\n         * @param value\n         * @return 记录总数\n         */\n        public long rpush(byte[] key, byte[] value) {\n            Jedis jedis = getJedis();\n            long count = jedis.rpush(key, value);\n            jedis.close();\n            return count;\n        }\n\n        /**\n         * 向List中追加记录\n         *\n         * @param key\n         * @param value\n         * @return 记录总数\n         */\n        public long lpush(byte[] key, byte[] value) {\n            Jedis jedis = getJedis();\n            long count = jedis.lpush(key, value);\n            jedis.close();\n            return count;\n        }\n\n        /**\n         * 获取指定范围的记录，可以做为分页使用\n         *\n         * @param key\n         * @param start\n         * @param end\n         * @return List\n         */\n        public List<String> lrange(String key, long start, long end) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            List<String> list = sjedis.lrange(key, start, end);\n            sjedis.close();\n            return list;\n        }\n\n        /**\n         * 获取指定范围的记录，可以做为分页使用\n         *\n         * @param key\n         * @param start\n         * @param end   如果为负数，则尾部开始计算\n         * @return List\n         */\n        public List<byte[]> lrange(byte[] key, int start, int end) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            List<byte[]> list = sjedis.lrange(key, start, end);\n            sjedis.close();\n            return list;\n        }\n\n        /**\n         * 删除List中c条记录，被删除的记录值为value\n         *\n         * @param key\n         * @param c     要删除的数量，如果为负数则从List的尾部检查并删除符合的记录\n         * @param value 要匹配的值\n         * @return 删除后的List中的记录数\n         */\n        public long lrem(byte[] key, int c, byte[] value) {\n            Jedis jedis = getJedis();\n            long count = jedis.lrem(key, c, value);\n            jedis.close();\n            return count;\n        }\n\n        /**\n         * 删除List中c条记录，被删除的记录值为value\n         *\n         * @param key\n         * @param c     要删除的数量，如果为负数则从List的尾部检查并删除符合的记录\n         * @param value 要匹配的值\n         * @return 删除后的List中的记录数\n         */\n        public long lrem(String key, int c, String value) {\n            return lrem(SafeEncoder.encode(key), c, SafeEncoder.encode(value));\n        }\n\n        /**\n         * 算是删除吧，只保留start与end之间的记录\n         *\n         * @param key\n         * @param start 记录的开始位置(0表示第一条记录)\n         * @param end   记录的结束位置（如果为-1则表示最后一个，-2，-3以此类推）\n         * @return 执行状态码\n         */\n        public String ltrim(byte[] key, int start, int end) {\n            Jedis jedis = getJedis();\n            String str = jedis.ltrim(key, start, end);\n            jedis.close();\n            return str;\n        }\n\n        /**\n         * 算是删除吧，只保留start与end之间的记录\n         *\n         * @param key\n         * @param start 记录的开始位置(0表示第一条记录)\n         * @param end   记录的结束位置（如果为-1则表示最后一个，-2，-3以此类推）\n         * @return 执行状态码\n         */\n        public String ltrim(String key, int start, int end) {\n            return ltrim(SafeEncoder.encode(key), start, end);\n        }\n    }\n\n}\n```","source":"_posts/Redis使用.md","raw":"---\ntitle: Redis使用\ndate: 2021-2-25\ntags:\n\t- Redis\ncategories:\n\t- Spring\ntoc: true\n---\n\n> redis是一个key-value型存储系统，支持的value类型比较丰富，支持String、List、集合set（没有顺序，元素唯一）、有序集合Zset，都支持push、pop、add、remove、交并集等操作，这些操作都是原子性的，调用redis的操作不用考虑多进程之间的并发问题。在此基础上，redis支持各种方式的排序，为了保证效率，数据都是缓存在内存中的，区别在于：redis会周期性的把更新的数据写到磁盘或者修改操作追加的记录文件中，前者就是默认的RDD模式，就是把数据写到临时文件中，持久化结束后，把临时文件替换为上次持久化的文件，达到数据恢复的目的，优点在于：使用单独子进程进行持久化，主进程不会进行任何IO操作，保证了redis的高效性能，缺点在于RDD是间隔一段时间进行持久化，如果持久化间隔期间，redis发生故障，那么这个持久化就不会更新到磁盘中，就会发生数据的丢失。\n>\n> <!--more-->对于数据不那么严谨的应用，可以使用RDD模式。其存储机制默认设置为如果更改了一个key，则间隔900秒之后进行一次持久化存储，如果更改了十个key，则间隔300秒进行一次持久化存储，如果更改了一万个key，则1分钟之后进行持久化，持久化之后就会把最新的临时文件替换掉旧的RDD文件，使用RDD恢复数据，实际就是重启redis，redis会从rdd文件恢复数据；第二种就是AOF操作，就是把执行过的指令记录下来，恢复时就是把这些操作重新回放一遍，优点就是可以保持更高的数据完整性。如果追加file的时间是1s，一旦redis发生故障那么最多丢失数据的时间是1s，这一秒的数据丢失，且如果日志写入不完整，可以使用redis-check-aof对日志文件进行修复，aof文件没有被write之前，可以删除一些其中操作，缺点就是文件比RDD文件大，恢复的时间比较久，其实AOF和MYSQL中的binlog差不多，都是记录操作。\n\n使用意图：就是将一些不经常更改的数据写入到redis中，例如店铺类别、区域信息、头条信息等，这些数据都是读取比较多，写比较少。\n\n* 客户端读取数据：首先把请求发送给redis，如果redis有请求的数据那么就把数据直接返回给客户端，避免使用数据库，如果redis没有请求的数据，就把请求发给数据库，数据库获取到数据后，返回给客户端，同时把redis中的数据进行更新，保证redis始终返回的是新的数据。\n\n* 客户端写入/修改数据：当数据发生变化或者修改，要同步的更新redis中的数据，简单点的操作就是数据发生修改时，就将redis相应的key的数据清空，如果客户端请求最新数据，因为redis没有，所以请求发给了DB，DB返回数据给客户端，同时把最新数据插入到了redis，保证了redis是最新的数据。\n\n  <div align='center'><img src=\"1612949134565-6f08df50-431b-40ba-ba8e-eac9104e8f9d-20210225113349251.png\" alt=\"image-20210129220709957\" style=\"zoom:50%;\" /></div>\n\n### 业务逻辑\n\n首先先看一下业务逻辑读和写时如何加入Redis缓存，对于读多写少数据，使用Redis缓存时明智的例如滚动展示的头条。采用Redis缓存，需要先定义存放的key，对于不同条件查询对象配置不同的key\n\n当遇到请求，先检查Redis是否存在该key，否则从数据库取出然后放入到Redis中，注意不同的查询条件对应的数据key不可相同，否则就乱套了\n\n```java\npackage com.imooc.o2o.service.impl;\n\nimport com.fasterxml.jackson.core.JsonProcessingException;\nimport com.fasterxml.jackson.databind.JavaType;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.imooc.o2o.cache.JedisUtil;\nimport com.imooc.o2o.dao.ShopCategoryDao;\nimport com.imooc.o2o.entity.ShopCategory;\nimport com.imooc.o2o.exceptions.ShopOperationException;\nimport com.imooc.o2o.service.ShopCategoryService;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.stereotype.Service;\n\nimport java.io.IOException;\nimport java.util.ArrayList;\nimport java.util.List;\n\n@Service\npublic class ShopCategoryServiceImpl implements ShopCategoryService {\n    @Autowired\n    private ShopCategoryDao shopCategoryDao;\n    @Autowired\n    private JedisUtil.Keys keys;\n    @Autowired\n    private JedisUtil.Strings strings;\n\n    private Logger logger = LoggerFactory.getLogger(ShopCategoryServiceImpl.class);\n\n    @Override\n    public List<ShopCategory> queryShopCategory(ShopCategory shopCategoryCondition) {\n        String key = SHOP_CATEGORY_KEY;\n        List<ShopCategory> list = null;\n        ObjectMapper mapper = new ObjectMapper();\n        if(shopCategoryCondition == null){\n          // 查询一级店铺类别\n            key = SHOP_CATEGORY_KEY + \"_parent_null\"; \n        }else if(shopCategoryCondition.getParent() != null && shopCategoryCondition.getParent().getShopCategoryId() != null){\n          // 查询对应以及类别下的二级类别\n            key = SHOP_CATEGORY_KEY + \"_parent_\" + shopCategoryCondition.getParent().getShopCategoryId();\n        }else{\n          // 查询所有二级店铺类别\n            key = SHOP_CATEGORY_KEY + \"_parent_not_null_all\"; \n        }\n\n      \t// Reids不存在则从数据库取出，取出成功后放入到缓存中\n        if(!keys.exists(key)){\n            list = shopCategoryDao.queryShopCategory(shopCategoryCondition);\n            try {\n              \t// 因为是对象，所以这里采用转换为JSON字符串转入\n                String jsonString = mapper.writeValueAsString(list);\n                strings.set(key, jsonString);\n            } catch (JsonProcessingException e) {\n                logger.error(\"queryShopCategory error:\" + e.getMessage());\n                e.printStackTrace();\n                throw new ShopOperationException(\"queryShopCategory error:\" + e.getMessage());\n            }\n        }else{\n          \t// 从Redis缓存中读出字符串，经过JSON转换为对象\n             String jsonString = strings.get(key);\n             JavaType javaType = mapper.getTypeFactory().constructParametricType(ArrayList.class, ShopCategory.class);\n            try {\n                list = mapper.readValue(jsonString, javaType);\n            } catch (IOException e) {\n                logger.error(\"queryShopCategory error:\" + e.getMessage());\n                e.printStackTrace();\n                throw new ShopOperationException(\"queryShopCategory error:\" + e.getMessage());\n            }\n        }\n        return list;\n    }\n    \n    // 插入数据需要清除所有相关Redis缓存\n    public ShopCategoryExecution insertShopCategory(ShopCategory shopCategory){\n        try{\n            int effectNum = shopCategoryDao.insertShopCategory(shopCategory);\n            // 插入成功则需要清除Redis缓存\n            if(effectNum > 0){\n                // 将所有key为SHOP_CATEGORY_KEY打头的数据全部从Redis缓存中清除\n                cacheService.removeKeys(SHOP_CATEGORY_KEY);\n                return ShopCategoryExecution(ShopCategoryStateEnum.SCCESS);\n            }else{\n                return ShopCategoryExecution(ShopCategoryStateEnum.FAIL);\n            }\n        }catch(Exception e){\n            logger.error(\"插入失败：\" + e.toString());\n            throw new ShopCategoryException(e.toString());\n        }\n    }\n}\n```\n\n\n\n在添加数据时注意清除缓存，下次取就会直接去数据库进行取然后放入缓存中，保证缓存中始终是最新的数据\n\n```java\npackage com.imooc.o2o.service.impl;//package com.imooc.o2o.service.impl;\n\nimport com.imooc.o2o.cache.JedisUtil;\nimport com.imooc.o2o.service.CacheService;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.stereotype.Service;\n\nimport java.util.Set;\n\n@Service\npublic class CacheServiceImpl implements CacheService {\n    @Autowired\n    private JedisUtil.Keys keys;\n\n    @Override\n    public void removeKeys(String prefix) {\n        // 首先找到所有以prefix为前缀的key集合\n        Set<String> set = keys.keys(prefix + \"*\");\n        for(String key : set){\n            keys.del(key);\n        }\n    }\n}\n```\n\n\n\n### 实现Redis配置\n\n配置Redis，首先pom中引入Redis客户端，与远程Redis进行通信\n\n```xml\n        <!--redis客户端:Jedis，与redis服务器进行通信-->\n        <dependency>\n            <groupId>redis.clients</groupId>\n            <artifactId>jedis</artifactId>\n            <version>2.9.0</version>\n        </dependency>\n```\n\napplication.properties引入redis基础配置，这些配置后续会通过编码读入\n\n```properties\n# reids配置\nredis.hostname=127.0.0.1\nredis.port=6379\nredis.database=0\nredis.pool.maxActive=600\nredis.pool.maxIdle=300\nredis.pool.maxWait=3000\nredis.pool.testOnBorrow=true\n```\n\n**连接池JedisPool**\n\n读取Redis配置生成Redis连接池JedisPool\n\n```java\npackage com.imooc.o2o.cache;\n\nimport org.springframework.context.annotation.Bean;\nimport redis.clients.jedis.JedisPool;\nimport redis.clients.jedis.JedisPoolConfig;\n\n/**\n * 强指定redis的JedisPool接口构造函数，这样才能在centos中成功创建jedispool\n */\npublic class JedisPoolWriper {\n    private JedisPool jedisPool;\n\n    public JedisPoolWriper() {\n    }\n\n    public JedisPoolWriper(final JedisPoolConfig poolConfig, final String host, final int port) {\n        try {\n            jedisPool = new JedisPool(poolConfig, host, port);\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n    }\n\n    public JedisPool getJedisPool() {\n        return jedisPool;\n    }\n\n    public void setJedisPool(JedisPool jedisPool) {\n        this.jedisPool = jedisPool;\n    }\n}\n```\n\n\n\n**注入Redis配置到容器**\n\n包括Redis连接池配置JedisPoolConfig，JedisPool连接，Jedis基本数据常见API\n\n其中可以看到添加@Configuration注解，就是读取相应application.properties配置\n\nJedisPoolConfig、JedisPool都添加了@Bean注解，需要在项目启动时注入到容器中\n\n```java\npackage com.imooc.o2o.config.redis;\n\nimport com.imooc.o2o.cache.JedisPoolWriper;\nimport com.imooc.o2o.cache.JedisUtil;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport redis.clients.jedis.JedisPoolConfig;\n\n@Configuration\npublic class RedisConfiguration {\n    @Value(\"${redis.pool.maxActive}\")\n    private int maxActive;\n    @Value(\"${redis.hostname}\")\n    private String hostname;\n    @Value(\"${redis.port}\")\n    private int port;\n    @Value(\"${redis.pool.maxIdle}\")\n    private int maxIdle;\n    @Value(\"${redis.pool.maxWait}\")\n    private int maxWait;\n    @Value(\"${redis.pool.testOnBorrow}\")\n    private boolean testOnBorrow;\n\n    @Autowired\n    private JedisPoolConfig jedisPoolConfig;\n    @Autowired\n    private JedisPoolWriper jedisWritePool;\n    @Autowired\n    private JedisUtil jedisUtil;\n\n    /**\n     * redis连接池配置\n     * @return\n     */\n    @Bean(\"jedisPoolConfig\")\n    public JedisPoolConfig createJedisPoolConfig() {\n        JedisPoolConfig jedisPoolConfig = new JedisPoolConfig();\n        // 控制一个pool可以分配多少个jedis实例\n        jedisPoolConfig.setMaxTotal(maxActive);\n        // 连接池最多空闲多少个连接\n        // 表示解释没有数据库连接时依然保持的链接数目，而不被清除，随时处于待命状态\n        jedisPoolConfig.setMaxIdle(maxIdle);\n        // 最大等待时间：但没有可用连接时，连接池等待连接被归还的最大时间，超出时间则抛出异常\n        jedisPoolConfig.setMaxWaitMillis(maxWait);\n        // 在获取连接时检查有效性\n        jedisPoolConfig.setTestOnBorrow(testOnBorrow);\n        return jedisPoolConfig;\n    }\n\n    /**\n     * 创建Redis连接池，并做相关配置\n     * @return\n     */\n    @Bean(\"jedisWritePool\")\n    public JedisPoolWriper createJedisPoolWriper(){\n        JedisPoolWriper jedisPoolWriper = new JedisPoolWriper(jedisPoolConfig, hostname, port);\n        return jedisPoolWriper;\n    }\n\n    /**\n     * 创建Redis工具类，封装好redis的连接已进行相关操作\n     * @return\n     */\n    @Bean(\"jedisUtil\")\n    public JedisUtil createJedisUtil(){\n        JedisUtil jedisUtil = new JedisUtil();\n        jedisUtil.setJedisPool(jedisWritePool);\n        return jedisUtil;\n    }\n\n    /**\n     * jedis的key操作\n     * @return\n     */\n    @Bean(\"jedisKeys\")\n    public JedisUtil.Keys createKeys(){\n        // 注意内部类的new方式\n        JedisUtil.Keys keys = jedisUtil.new Keys();\n        return keys;\n    }\n\n    /**\n     * jedis的Strings操作\n     * @return\n     */\n    @Bean(\"jedisStrings\")\n    public JedisUtil.Strings createStrings(){\n        JedisUtil.Strings strings = jedisUtil.new Strings();\n        return strings;\n    }\n}\n```\n\n**编写Jedis工具类**\n\n将Jedis常用数据对象浅浅的封装一层，封装一层的目的在于：使用第三方组件时，浅浅封装一层避免直接调用API，可以在后续项目时随时更改，而项目其他地方不用更改，例如后续项目需要监控Redis取缓存时间，那么朱旭在封装前后，统计一下时间即可\n\n```java\n        /**\n         * 根据key获取记录\n         *\n         * @param key\n         * @return 值\n         */\n        public String get(String key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            String value = sjedis.get(key);\n            sjedis.close();\n            return value;\n        }\n```\n\n项目需要统计取key消耗时间\n\n```java\n        /**\n         * 根据key获取记录，统计操作时间\n         *\n         * @param key\n         * @return 值\n         */\n        public String get(String key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            long startTime = System.currentTimeMillis();\n            System.get\n            Jedis sjedis = getJedis();\n            String value = sjedis.get(key);\n                long endTime = System.currentTimeMillis();\n                logger.info(String.format(\"get Strings key:%d cost %d ms\"), key, endTime - startTime);\n            sjedis.close();\n            return value;\n        }\n```\n\n\n\n**JedisUtil工具类**\n\nJedisUtil浅浅封装一层Redis常见数据对象的方法\n\n```java\npackage com.imooc.o2o.cache;\n\nimport redis.clients.jedis.BinaryClient;\nimport redis.clients.jedis.Jedis;\nimport redis.clients.jedis.JedisPool;\nimport redis.clients.jedis.SortingParams;\nimport redis.clients.util.SafeEncoder;\n\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Set;\n\npublic class JedisUtil {\n    /**\n     * 缓存生存时间\n     */\n    private final int expire = 60000;\n    /**\n     * 操作Key的方法\n     */\n    public Keys KEYS;\n    /**\n     * 对存储结构为String类型的操作\n     */\n    public Strings STRINGS;\n    /**\n     * 对存储结构为List类型的操作\n     */\n    public Lists LISTS;\n    /**\n     * 对存储结构为Set类型的操作\n     */\n    public Sets SETS;\n    /**\n     * 对存储结构为HashMap类型的操作\n     */\n    public Hash HASH;\n\n    private JedisPool jedisPool;\n\n    public JedisPool getJedisPool() {\n        return jedisPool;\n    }\n\n    public void setJedisPool(JedisPoolWriper jedisPoolWriper) {\n        this.jedisPool = jedisPoolWriper.getJedisPool();\n    }\n\n    public JedisPool getPool() {\n        return jedisPool;\n    }\n\n    /**\n     * 从jedis连接池中获取获取jedis对象\n     *\n     * @return\n     */\n    public Jedis getJedis() {\n        return jedisPool.getResource();\n    }\n\n    /**\n     * 设置过期时间\n     *\n     * @param @param\n     * @author ruan 2013-4-11\n     */\n    public void expire(String key, int seconds) {\n        if (seconds <= 0) {\n            return;\n        }\n        Jedis jedis = getJedis();\n        jedis.expire(key, seconds);\n        jedis.close();\n    }\n\n    /**\n     * 设置默认过期时间\n     *\n     * @param\n     * @author ruan 2013-4-11\n     */\n    public void expire(String key) {\n        expire(key, expire);\n    }\n\n    // *******************************************Keys*******************************************//\n    public class Keys {\n\n        /**\n         * 清空所有key\n         */\n        public String flushAll() {\n            Jedis jedis = getJedis();\n            String stata = jedis.flushAll();\n            jedis.close();\n            return stata;\n        }\n\n        /**\n         * 更改key\n         *\n         * @param oldkey\n         * @param newkey\n         * @return 状态码\n         */\n        public String rename(String oldkey, String newkey) {\n            return rename(SafeEncoder.encode(oldkey),\n                    SafeEncoder.encode(newkey));\n        }\n\n        /**\n         * 更改key,仅当新key不存在时才执行\n         *\n         * @param oldkey\n         * @param newkey\n         * @return 状态码\n         */\n        public long renamenx(String oldkey, String newkey) {\n            Jedis jedis = getJedis();\n            long status = jedis.renamenx(oldkey, newkey);\n            jedis.close();\n            return status;\n        }\n\n        /**\n         * 更改key\n         *\n         * @param oldkey\n         * @param newkey\n         * @return 状态码\n         */\n        public String rename(byte[] oldkey, byte[] newkey) {\n            Jedis jedis = getJedis();\n            String status = jedis.rename(oldkey, newkey);\n            jedis.close();\n            return status;\n        }\n\n        /**\n         * 设置key的过期时间，以秒为单位\n         *\n         * @param key\n         * @param seconds 已秒为单位\n         * @return 影响的记录数\n         */\n        public long expired(String key, int seconds) {\n            Jedis jedis = getJedis();\n            long count = jedis.expire(key, seconds);\n            jedis.close();\n            return count;\n        }\n\n        /**\n         * 设置key的过期时间,它是距历元（即格林威治标准时间 1970 年 1 月 1 日的 00:00:00，格里高利历）的偏移量。\n         *\n         * @param key\n         * @param timestamp 已秒为单位\n         * @return 影响的记录数\n         */\n        public long expireAt(String key, long timestamp) {\n            Jedis jedis = getJedis();\n            long count = jedis.expireAt(key, timestamp);\n            jedis.close();\n            return count;\n        }\n\n        /**\n         * 查询key的过期时间\n         *\n         * @param key\n         * @return 以秒为单位的时间表示\n         */\n        public long ttl(String key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            long len = sjedis.ttl(key);\n            sjedis.close();\n            return len;\n        }\n\n        /**\n         * 取消对key过期时间的设置\n         *\n         * @param key\n         * @return 影响的记录数\n         */\n        public long persist(String key) {\n            Jedis jedis = getJedis();\n            long count = jedis.persist(key);\n            jedis.close();\n            return count;\n        }\n\n        /**\n         * 删除keys对应的记录,可以是多个key\n         *\n         * @param keys\n         * @return 删除的记录数\n         */\n        public long del(String... keys) {\n            Jedis jedis = getJedis();\n            long count = jedis.del(keys);\n            jedis.close();\n            return count;\n        }\n\n        /**\n         * 删除keys对应的记录,可以是多个key\n         *\n         * @param keys\n         * @return 删除的记录数\n         */\n        public long del(byte[]... keys) {\n            Jedis jedis = getJedis();\n            long count = jedis.del(keys);\n            jedis.close();\n            return count;\n        }\n\n        /**\n         * 判断key是否存在\n         *\n         * @param key\n         * @return boolean\n         */\n        public boolean exists(String key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            boolean exis = sjedis.exists(key);\n            sjedis.close();\n            return exis;\n        }\n\n        /**\n         * 对List,Set,SortSet进行排序,如果集合数据较大应避免使用这个方法\n         *\n         * @param key\n         * @return List<String> 集合的全部记录\n         **/\n        public List<String> sort(String key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            List<String> list = sjedis.sort(key);\n            sjedis.close();\n            return list;\n        }\n\n        /**\n         * 对List,Set,SortSet进行排序或limit\n         *\n         * @param key\n         * @param parame 定义排序类型或limit的起止位置.\n         * @return List<String> 全部或部分记录\n         **/\n        public List<String> sort(String key, SortingParams parame) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            List<String> list = sjedis.sort(key, parame);\n            sjedis.close();\n            return list;\n        }\n\n        /**\n         * 返回指定key存储的类型\n         *\n         * @param key\n         * @return String string|list|set|zset|hash\n         **/\n        public String type(String key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            String type = sjedis.type(key);\n            sjedis.close();\n            return type;\n        }\n\n        /**\n         * 查找所有匹配给定的模式的键\n         *\n         * @param pattern key的表达式,*表示多个，？表示一个\n         */\n        public Set<String> keys(String pattern) {\n            Jedis jedis = getJedis();\n            Set<String> set = jedis.keys(pattern);\n            jedis.close();\n            return set;\n        }\n    }\n\n    // *******************************************Sets*******************************************//\n    public class Sets {\n\n        /**\n         * 向Set添加一条记录，如果member已存在返回0,否则返回1\n         *\n         * @param key\n         * @param member\n         * @return 操作码, 0或1\n         */\n        public long sadd(String key, String member) {\n            Jedis jedis = getJedis();\n            long s = jedis.sadd(key, member);\n            jedis.close();\n            return s;\n        }\n\n        public long sadd(byte[] key, byte[] member) {\n            Jedis jedis = getJedis();\n            long s = jedis.sadd(key, member);\n            jedis.close();\n            return s;\n        }\n\n        /**\n         * 获取给定key中元素个数\n         *\n         * @param key\n         * @return 元素个数\n         */\n        public long scard(String key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            long len = sjedis.scard(key);\n            sjedis.close();\n            return len;\n        }\n\n        /**\n         * 返回从第一组和所有的给定集合之间的差异的成员\n         *\n         * @param keys\n         * @return 差异的成员集合\n         */\n        public Set<String> sdiff(String... keys) {\n            Jedis jedis = getJedis();\n            Set<String> set = jedis.sdiff(keys);\n            jedis.close();\n            return set;\n        }\n\n        /**\n         * 这个命令等于sdiff,但返回的不是结果集,而是将结果集存储在新的集合中，如果目标已存在，则覆盖。\n         *\n         * @param newkey 新结果集的key\n         * @param keys   比较的集合\n         * @return 新集合中的记录数\n         **/\n        public long sdiffstore(String newkey, String... keys) {\n            Jedis jedis = getJedis();\n            long s = jedis.sdiffstore(newkey, keys);\n            jedis.close();\n            return s;\n        }\n\n        /**\n         * 返回给定集合交集的成员,如果其中一个集合为不存在或为空，则返回空Set\n         *\n         * @param keys\n         * @return 交集成员的集合\n         **/\n        public Set<String> sinter(String... keys) {\n            Jedis jedis = getJedis();\n            Set<String> set = jedis.sinter(keys);\n            jedis.close();\n            return set;\n        }\n\n        /**\n         * 这个命令等于sinter,但返回的不是结果集,而是将结果集存储在新的集合中，如果目标已存在，则覆盖。\n         *\n         * @param newkey 新结果集的key\n         * @param keys   比较的集合\n         * @return 新集合中的记录数\n         **/\n        public long sinterstore(String newkey, String... keys) {\n            Jedis jedis = getJedis();\n            long s = jedis.sinterstore(newkey, keys);\n            jedis.close();\n            return s;\n        }\n\n        /**\n         * 确定一个给定的值是否存在\n         *\n         * @param key\n         * @param member 要判断的值\n         * @return 存在返回1，不存在返回0\n         **/\n        public boolean sismember(String key, String member) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            boolean s = sjedis.sismember(key, member);\n            sjedis.close();\n            return s;\n        }\n\n        /**\n         * 返回集合中的所有成员\n         *\n         * @param key\n         * @return 成员集合\n         */\n        public Set<String> smembers(String key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            Set<String> set = sjedis.smembers(key);\n            sjedis.close();\n            return set;\n        }\n\n        public Set<byte[]> smembers(byte[] key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            Set<byte[]> set = sjedis.smembers(key);\n            sjedis.close();\n            return set;\n        }\n\n        /**\n         * 将成员从源集合移出放入目标集合 <br/>\n         * 如果源集合不存在或不包哈指定成员，不进行任何操作，返回0<br/>\n         * 否则该成员从源集合上删除，并添加到目标集合，如果目标集合中成员已存在，则只在源集合进行删除\n         *\n         * @param srckey 源集合\n         * @param dstkey 目标集合\n         * @param member 源集合中的成员\n         * @return 状态码，1成功，0失败\n         */\n        public long smove(String srckey, String dstkey, String member) {\n            Jedis jedis = getJedis();\n            long s = jedis.smove(srckey, dstkey, member);\n            jedis.close();\n            return s;\n        }\n\n        /**\n         * 从集合中删除成员\n         *\n         * @param key\n         * @return 被删除的成员\n         */\n        public String spop(String key) {\n            Jedis jedis = getJedis();\n            String s = jedis.spop(key);\n            jedis.close();\n            return s;\n        }\n\n        /**\n         * 从集合中删除指定成员\n         *\n         * @param key\n         * @param member 要删除的成员\n         * @return 状态码，成功返回1，成员不存在返回0\n         */\n        public long srem(String key, String member) {\n            Jedis jedis = getJedis();\n            long s = jedis.srem(key, member);\n            jedis.close();\n            return s;\n        }\n\n        /**\n         * 合并多个集合并返回合并后的结果，合并后的结果集合并不保存<br/>\n         *\n         * @param keys\n         * @return 合并后的结果集合\n         */\n        public Set<String> sunion(String... keys) {\n            Jedis jedis = getJedis();\n            Set<String> set = jedis.sunion(keys);\n            jedis.close();\n            return set;\n        }\n\n        /**\n         * 合并多个集合并将合并后的结果集保存在指定的新集合中，如果新集合已经存在则覆盖\n         *\n         * @param newkey 新集合的key\n         * @param keys   要合并的集合\n         **/\n        public long sunionstore(String newkey, String... keys) {\n            Jedis jedis = getJedis();\n            long s = jedis.sunionstore(newkey, keys);\n            jedis.close();\n            return s;\n        }\n    }\n\n    // *******************************************Hash*******************************************//\n    public class Hash {\n\n        /**\n         * 从hash中删除指定的存储\n         *\n         * @param key\n         * @param fieid 存储的名字\n         * @return 状态码，1成功，0失败\n         */\n        public long hdel(String key, String fieid) {\n            Jedis jedis = getJedis();\n            long s = jedis.hdel(key, fieid);\n            jedis.close();\n            return s;\n        }\n\n        public long hdel(String key) {\n            Jedis jedis = getJedis();\n            long s = jedis.del(key);\n            jedis.close();\n            return s;\n        }\n\n        /**\n         * 测试hash中指定的存储是否存在\n         *\n         * @param key\n         * @param fieid 存储的名字\n         * @return 1存在，0不存在\n         */\n        public boolean hexists(String key, String fieid) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            boolean s = sjedis.hexists(key, fieid);\n            sjedis.close();\n            return s;\n        }\n\n        /**\n         * 返回hash中指定存储位置的值\n         *\n         * @param key\n         * @param fieid 存储的名字\n         * @return 存储对应的值\n         */\n        public String hget(String key, String fieid) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            String s = sjedis.hget(key, fieid);\n            sjedis.close();\n            return s;\n        }\n\n        public byte[] hget(byte[] key, byte[] fieid) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            byte[] s = sjedis.hget(key, fieid);\n            sjedis.close();\n            return s;\n        }\n\n        /**\n         * 以Map的形式返回hash中的存储和值\n         *\n         * @param key\n         * @return Map<Strinig, String>\n         */\n        public Map<String, String> hgetAll(String key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            Map<String, String> map = sjedis.hgetAll(key);\n            sjedis.close();\n            return map;\n        }\n\n        /**\n         * 添加一个对应关系\n         *\n         * @param key\n         * @param fieid\n         * @param value\n         * @return 状态码 1成功，0失败，fieid已存在将更新，也返回0\n         **/\n        public long hset(String key, String fieid, String value) {\n            Jedis jedis = getJedis();\n            long s = jedis.hset(key, fieid, value);\n            jedis.close();\n            return s;\n        }\n\n        public long hset(String key, String fieid, byte[] value) {\n            Jedis jedis = getJedis();\n            long s = jedis.hset(key.getBytes(), fieid.getBytes(), value);\n            jedis.close();\n            return s;\n        }\n\n        /**\n         * 添加对应关系，只有在fieid不存在时才执行\n         *\n         * @param key\n         * @param fieid\n         * @param value\n         * @return 状态码 1成功，0失败fieid已存\n         **/\n        public long hsetnx(String key, String fieid, String value) {\n            Jedis jedis = getJedis();\n            long s = jedis.hsetnx(key, fieid, value);\n            jedis.close();\n            return s;\n        }\n\n        /**\n         * 获取hash中value的集合\n         *\n         * @param key\n         * @return List<String>\n         */\n        public List<String> hvals(String key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            List<String> list = sjedis.hvals(key);\n            sjedis.close();\n            return list;\n        }\n\n        /**\n         * 在指定的存储位置加上指定的数字，存储位置的值必须可转为数字类型\n         *\n         * @param key\n         * @param fieid 存储位置\n         * @param value 要增加的值,可以是负数\n         * @return 增加指定数字后，存储位置的值\n         */\n        public long hincrby(String key, String fieid, long value) {\n            Jedis jedis = getJedis();\n            long s = jedis.hincrBy(key, fieid, value);\n            jedis.close();\n            return s;\n        }\n\n        /**\n         * 返回指定hash中的所有存储名字,类似Map中的keySet方法\n         *\n         * @param key\n         * @return Set<String> 存储名称的集合\n         */\n        public Set<String> hkeys(String key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            Set<String> set = sjedis.hkeys(key);\n            sjedis.close();\n            return set;\n        }\n\n        /**\n         * 获取hash中存储的个数，类似Map中size方法\n         *\n         * @param key\n         * @return long 存储的个数\n         */\n        public long hlen(String key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            long len = sjedis.hlen(key);\n            sjedis.close();\n            return len;\n        }\n\n        /**\n         * 根据多个key，获取对应的value，返回List,如果指定的key不存在,List对应位置为null\n         *\n         * @param key\n         * @param fieids 存储位置\n         * @return List<String>\n         */\n        public List<String> hmget(String key, String... fieids) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            List<String> list = sjedis.hmget(key, fieids);\n            sjedis.close();\n            return list;\n        }\n\n        public List<byte[]> hmget(byte[] key, byte[]... fieids) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            List<byte[]> list = sjedis.hmget(key, fieids);\n            sjedis.close();\n            return list;\n        }\n\n        /**\n         * 添加对应关系，如果对应关系已存在，则覆盖\n         *\n         * @param key\n         * @param map 对应关系\n         * @return 状态，成功返回OK\n         */\n        public String hmset(String key, Map<String, String> map) {\n            Jedis jedis = getJedis();\n            String s = jedis.hmset(key, map);\n            jedis.close();\n            return s;\n        }\n\n        /**\n         * 添加对应关系，如果对应关系已存在，则覆盖\n         *\n         * @param key\n         * @param map 对应关系\n         * @return 状态，成功返回OK\n         */\n        public String hmset(byte[] key, Map<byte[], byte[]> map) {\n            Jedis jedis = getJedis();\n            String s = jedis.hmset(key, map);\n            jedis.close();\n            return s;\n        }\n\n    }\n\n    // *******************************************Strings*******************************************//\n    public class Strings {\n\n        /**\n         * 根据key获取记录\n         *\n         * @param key\n         * @return 值\n         */\n        public String get(String key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            String value = sjedis.get(key);\n            sjedis.close();\n            return value;\n        }\n\n        /**\n         * 根据key获取记录\n         *\n         * @param key\n         * @return 值\n         */\n        public byte[] get(byte[] key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            byte[] value = sjedis.get(key);\n            sjedis.close();\n            return value;\n        }\n\n        /**\n         * 添加有过期时间的记录\n         *\n         * @param key\n         * @param seconds 过期时间，以秒为单位\n         * @param value\n         * @return String 操作状态\n         */\n        public String setEx(String key, int seconds, String value) {\n            Jedis jedis = getJedis();\n            String str = jedis.setex(key, seconds, value);\n            jedis.close();\n            return str;\n        }\n\n        /**\n         * 添加有过期时间的记录\n         *\n         * @param key\n         * @param seconds 过期时间，以秒为单位\n         * @param value\n         * @return String 操作状态\n         */\n        public String setEx(byte[] key, int seconds, byte[] value) {\n            Jedis jedis = getJedis();\n            String str = jedis.setex(key, seconds, value);\n            jedis.close();\n            return str;\n        }\n\n        /**\n         * 添加一条记录，仅当给定的key不存在时才插入\n         *\n         * @param key\n         * @param value\n         * @return long 状态码，1插入成功且key不存在，0未插入，key存在\n         */\n        public long setnx(String key, String value) {\n            Jedis jedis = getJedis();\n            long str = jedis.setnx(key, value);\n            jedis.close();\n            return str;\n        }\n\n        /**\n         * 添加记录,如果记录已存在将覆盖原有的value\n         *\n         * @param key\n         * @param value\n         * @return 状态码\n         */\n        public String set(String key, String value) {\n            return set(SafeEncoder.encode(key), SafeEncoder.encode(value));\n        }\n\n        /**\n         * 添加记录,如果记录已存在将覆盖原有的value\n         *\n         * @param key\n         * @param value\n         * @return 状态码\n         */\n        public String set(String key, byte[] value) {\n            return set(SafeEncoder.encode(key), value);\n        }\n\n        /**\n         * 添加记录,如果记录已存在将覆盖原有的value\n         *\n         * @param key\n         * @param value\n         * @return 状态码\n         */\n        public String set(byte[] key, byte[] value) {\n            Jedis jedis = getJedis();\n            String status = jedis.set(key, value);\n            jedis.close();\n            return status;\n        }\n\n        /**\n         * 从指定位置开始插入数据，插入的数据会覆盖指定位置以后的数据<br/>\n         * 例:String str1=\"123456789\";<br/>\n         * 对str1操作后setRange(key,4,0000)，str1=\"123400009\";\n         *\n         * @param key\n         * @param offset\n         * @param value\n         * @return long value的长度\n         */\n        public long setRange(String key, long offset, String value) {\n            Jedis jedis = getJedis();\n            long len = jedis.setrange(key, offset, value);\n            jedis.close();\n            return len;\n        }\n\n        /**\n         * 在指定的key中追加value\n         *\n         * @param key\n         * @param value\n         * @return long 追加后value的长度\n         **/\n        public long append(String key, String value) {\n            Jedis jedis = getJedis();\n            long len = jedis.append(key, value);\n            jedis.close();\n            return len;\n        }\n\n        /**\n         * 将key对应的value减去指定的值，只有value可以转为数字时该方法才可用\n         *\n         * @param key\n         * @param number 要减去的值\n         * @return long 减指定值后的值\n         */\n        public long decrBy(String key, long number) {\n            Jedis jedis = getJedis();\n            long len = jedis.decrBy(key, number);\n            jedis.close();\n            return len;\n        }\n\n        /**\n         * <b>可以作为获取唯一id的方法</b><br/>\n         * 将key对应的value加上指定的值，只有value可以转为数字时该方法才可用\n         *\n         * @param key\n         * @param number 要减去的值\n         * @return long 相加后的值\n         */\n        public long incrBy(String key, long number) {\n            Jedis jedis = getJedis();\n            long len = jedis.incrBy(key, number);\n            jedis.close();\n            return len;\n        }\n\n        /**\n         * 对指定key对应的value进行截取\n         *\n         * @param key\n         * @param startOffset 开始位置(包含)\n         * @param endOffset   结束位置(包含)\n         * @return String 截取的值\n         */\n        public String getrange(String key, long startOffset, long endOffset) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            String value = sjedis.getrange(key, startOffset, endOffset);\n            sjedis.close();\n            return value;\n        }\n\n        /**\n         * 获取并设置指定key对应的value<br/>\n         * 如果key存在返回之前的value,否则返回null\n         *\n         * @param key\n         * @param value\n         * @return String 原始value或null\n         */\n        public String getSet(String key, String value) {\n            Jedis jedis = getJedis();\n            String str = jedis.getSet(key, value);\n            jedis.close();\n            return str;\n        }\n\n        /**\n         * 批量获取记录,如果指定的key不存在返回List的对应位置将是null\n         *\n         * @param keys\n         * @return List<String> 值得集合\n         */\n        public List<String> mget(String... keys) {\n            Jedis jedis = getJedis();\n            List<String> str = jedis.mget(keys);\n            jedis.close();\n            return str;\n        }\n\n        /**\n         * 批量存储记录\n         *\n         * @param keysvalues 例:keysvalues=\"key1\",\"value1\",\"key2\",\"value2\";\n         * @return String 状态码\n         */\n        public String mset(String... keysvalues) {\n            Jedis jedis = getJedis();\n            String str = jedis.mset(keysvalues);\n            jedis.close();\n            return str;\n        }\n\n        /**\n         * 获取key对应的值的长度\n         *\n         * @param key\n         * @return value值得长度\n         */\n        public long strlen(String key) {\n            Jedis jedis = getJedis();\n            long len = jedis.strlen(key);\n            jedis.close();\n            return len;\n        }\n    }\n\n    // *******************************************Lists*******************************************//\n    public class Lists {\n\n        /**\n         * List长度\n         *\n         * @param key\n         * @return 长度\n         */\n        public long llen(String key) {\n            return llen(SafeEncoder.encode(key));\n        }\n\n        /**\n         * List长度\n         *\n         * @param key\n         * @return 长度\n         */\n        public long llen(byte[] key) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            long count = sjedis.llen(key);\n            sjedis.close();\n            return count;\n        }\n\n        /**\n         * 覆盖操作,将覆盖List中指定位置的值\n         *\n         * @param key\n         * @param index 位置\n         * @param value 值\n         * @return 状态码\n         */\n        public String lset(byte[] key, int index, byte[] value) {\n            Jedis jedis = getJedis();\n            String status = jedis.lset(key, index, value);\n            jedis.close();\n            return status;\n        }\n\n        /**\n         * 覆盖操作,将覆盖List中指定位置的值\n         *\n         * @param @param index 位置\n         * @param value  值\n         * @return 状态码\n         */\n        public String lset(String key, int index, String value) {\n            return lset(SafeEncoder.encode(key), index,\n                    SafeEncoder.encode(value));\n        }\n\n        /**\n         * 在value的相对位置插入记录\n         *\n         * @param @param 前面插入或后面插入\n         * @param pivot  相对位置的内容\n         * @param value  插入的内容\n         * @return 记录总数\n         */\n        public long linsert(String key, BinaryClient.LIST_POSITION where, String pivot,\n                            String value) {\n            return linsert(SafeEncoder.encode(key), where,\n                    SafeEncoder.encode(pivot), SafeEncoder.encode(value));\n        }\n\n        /**\n         * 在指定位置插入记录\n         *\n         * @param key\n         * @param where 前面插入或后面插入\n         * @param pivot 相对位置的内容\n         * @param value 插入的内容\n         * @return 记录总数\n         */\n        public long linsert(byte[] key, BinaryClient.LIST_POSITION where, byte[] pivot,\n                            byte[] value) {\n            Jedis jedis = getJedis();\n            long count = jedis.linsert(key, where, pivot, value);\n            jedis.close();\n            return count;\n        }\n\n        /**\n         * 获取List中指定位置的值\n         *\n         * @param key\n         * @param index 位置\n         * @return 值\n         **/\n        public String lindex(String key, int index) {\n            return SafeEncoder.encode(lindex(SafeEncoder.encode(key), index));\n        }\n\n        /**\n         * 获取List中指定位置的值\n         *\n         * @param key\n         * @param index 位置\n         * @return 值\n         **/\n        public byte[] lindex(byte[] key, int index) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            byte[] value = sjedis.lindex(key, index);\n            sjedis.close();\n            return value;\n        }\n\n        /**\n         * 将List中的第一条记录移出List\n         *\n         * @param key\n         * @return 移出的记录\n         */\n        public String lpop(String key) {\n            return SafeEncoder.encode(lpop(SafeEncoder.encode(key)));\n        }\n\n        /**\n         * 将List中的第一条记录移出List\n         *\n         * @param key\n         * @return 移出的记录\n         */\n        public byte[] lpop(byte[] key) {\n            Jedis jedis = getJedis();\n            byte[] value = jedis.lpop(key);\n            jedis.close();\n            return value;\n        }\n\n        /**\n         * 将List中最后第一条记录移出List\n         *\n         * @param key\n         * @return 移出的记录\n         */\n        public String rpop(String key) {\n            Jedis jedis = getJedis();\n            String value = jedis.rpop(key);\n            jedis.close();\n            return value;\n        }\n\n        /**\n         * 向List尾部追加记录\n         *\n         * @param key\n         * @param value\n         * @return 记录总数\n         */\n        public long lpush(String key, String value) {\n            return lpush(SafeEncoder.encode(key), SafeEncoder.encode(value));\n        }\n\n        /**\n         * 向List头部追加记录\n         *\n         * @param key\n         * @param value\n         * @return 记录总数\n         */\n        public long rpush(String key, String value) {\n            Jedis jedis = getJedis();\n            long count = jedis.rpush(key, value);\n            jedis.close();\n            return count;\n        }\n\n        /**\n         * 向List头部追加记录\n         *\n         * @param key\n         * @param value\n         * @return 记录总数\n         */\n        public long rpush(byte[] key, byte[] value) {\n            Jedis jedis = getJedis();\n            long count = jedis.rpush(key, value);\n            jedis.close();\n            return count;\n        }\n\n        /**\n         * 向List中追加记录\n         *\n         * @param key\n         * @param value\n         * @return 记录总数\n         */\n        public long lpush(byte[] key, byte[] value) {\n            Jedis jedis = getJedis();\n            long count = jedis.lpush(key, value);\n            jedis.close();\n            return count;\n        }\n\n        /**\n         * 获取指定范围的记录，可以做为分页使用\n         *\n         * @param key\n         * @param start\n         * @param end\n         * @return List\n         */\n        public List<String> lrange(String key, long start, long end) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            List<String> list = sjedis.lrange(key, start, end);\n            sjedis.close();\n            return list;\n        }\n\n        /**\n         * 获取指定范围的记录，可以做为分页使用\n         *\n         * @param key\n         * @param start\n         * @param end   如果为负数，则尾部开始计算\n         * @return List\n         */\n        public List<byte[]> lrange(byte[] key, int start, int end) {\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            List<byte[]> list = sjedis.lrange(key, start, end);\n            sjedis.close();\n            return list;\n        }\n\n        /**\n         * 删除List中c条记录，被删除的记录值为value\n         *\n         * @param key\n         * @param c     要删除的数量，如果为负数则从List的尾部检查并删除符合的记录\n         * @param value 要匹配的值\n         * @return 删除后的List中的记录数\n         */\n        public long lrem(byte[] key, int c, byte[] value) {\n            Jedis jedis = getJedis();\n            long count = jedis.lrem(key, c, value);\n            jedis.close();\n            return count;\n        }\n\n        /**\n         * 删除List中c条记录，被删除的记录值为value\n         *\n         * @param key\n         * @param c     要删除的数量，如果为负数则从List的尾部检查并删除符合的记录\n         * @param value 要匹配的值\n         * @return 删除后的List中的记录数\n         */\n        public long lrem(String key, int c, String value) {\n            return lrem(SafeEncoder.encode(key), c, SafeEncoder.encode(value));\n        }\n\n        /**\n         * 算是删除吧，只保留start与end之间的记录\n         *\n         * @param key\n         * @param start 记录的开始位置(0表示第一条记录)\n         * @param end   记录的结束位置（如果为-1则表示最后一个，-2，-3以此类推）\n         * @return 执行状态码\n         */\n        public String ltrim(byte[] key, int start, int end) {\n            Jedis jedis = getJedis();\n            String str = jedis.ltrim(key, start, end);\n            jedis.close();\n            return str;\n        }\n\n        /**\n         * 算是删除吧，只保留start与end之间的记录\n         *\n         * @param key\n         * @param start 记录的开始位置(0表示第一条记录)\n         * @param end   记录的结束位置（如果为-1则表示最后一个，-2，-3以此类推）\n         * @return 执行状态码\n         */\n        public String ltrim(String key, int start, int end) {\n            return ltrim(SafeEncoder.encode(key), start, end);\n        }\n    }\n\n}\n```","slug":"Redis使用","published":1,"updated":"2021-02-25T03:37:58.480Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl2enrqzz001ry2lofviv6r4z","content":"<blockquote>\n<p>redis是一个key-value型存储系统，支持的value类型比较丰富，支持String、List、集合set（没有顺序，元素唯一）、有序集合Zset，都支持push、pop、add、remove、交并集等操作，这些操作都是原子性的，调用redis的操作不用考虑多进程之间的并发问题。在此基础上，redis支持各种方式的排序，为了保证效率，数据都是缓存在内存中的，区别在于：redis会周期性的把更新的数据写到磁盘或者修改操作追加的记录文件中，前者就是默认的RDD模式，就是把数据写到临时文件中，持久化结束后，把临时文件替换为上次持久化的文件，达到数据恢复的目的，优点在于：使用单独子进程进行持久化，主进程不会进行任何IO操作，保证了redis的高效性能，缺点在于RDD是间隔一段时间进行持久化，如果持久化间隔期间，redis发生故障，那么这个持久化就不会更新到磁盘中，就会发生数据的丢失。</p>\n<a id=\"more\"></a>对于数据不那么严谨的应用，可以使用RDD模式。其存储机制默认设置为如果更改了一个key，则间隔900秒之后进行一次持久化存储，如果更改了十个key，则间隔300秒进行一次持久化存储，如果更改了一万个key，则1分钟之后进行持久化，持久化之后就会把最新的临时文件替换掉旧的RDD文件，使用RDD恢复数据，实际就是重启redis，redis会从rdd文件恢复数据；第二种就是AOF操作，就是把执行过的指令记录下来，恢复时就是把这些操作重新回放一遍，优点就是可以保持更高的数据完整性。如果追加file的时间是1s，一旦redis发生故障那么最多丢失数据的时间是1s，这一秒的数据丢失，且如果日志写入不完整，可以使用redis-check-aof对日志文件进行修复，aof文件没有被write之前，可以删除一些其中操作，缺点就是文件比RDD文件大，恢复的时间比较久，其实AOF和MYSQL中的binlog差不多，都是记录操作。\n</blockquote>\n<p>使用意图：就是将一些不经常更改的数据写入到redis中，例如店铺类别、区域信息、头条信息等，这些数据都是读取比较多，写比较少。</p>\n<ul>\n<li><p>客户端读取数据：首先把请求发送给redis，如果redis有请求的数据那么就把数据直接返回给客户端，避免使用数据库，如果redis没有请求的数据，就把请求发给数据库，数据库获取到数据后，返回给客户端，同时把redis中的数据进行更新，保证redis始终返回的是新的数据。</p>\n</li>\n<li><p>客户端写入/修改数据：当数据发生变化或者修改，要同步的更新redis中的数据，简单点的操作就是数据发生修改时，就将redis相应的key的数据清空，如果客户端请求最新数据，因为redis没有，所以请求发给了DB，DB返回数据给客户端，同时把最新数据插入到了redis，保证了redis是最新的数据。</p>\n<div align=\"center\"><img src=\"/2021/Spring/Redis%E4%BD%BF%E7%94%A8/1612949134565-6f08df50-431b-40ba-ba8e-eac9104e8f9d-20210225113349251.png\" alt=\"image-20210129220709957\" style=\"zoom:50%;\"></div>\n\n</li>\n</ul>\n<h3 id=\"业务逻辑\"><a href=\"#业务逻辑\" class=\"headerlink\" title=\"业务逻辑\"></a>业务逻辑</h3><p>首先先看一下业务逻辑读和写时如何加入Redis缓存，对于读多写少数据，使用Redis缓存时明智的例如滚动展示的头条。采用Redis缓存，需要先定义存放的key，对于不同条件查询对象配置不同的key</p>\n<p>当遇到请求，先检查Redis是否存在该key，否则从数据库取出然后放入到Redis中，注意不同的查询条件对应的数据key不可相同，否则就乱套了</p>\n<pre><code class=\"java\">package com.imooc.o2o.service.impl;\n\nimport com.fasterxml.jackson.core.JsonProcessingException;\nimport com.fasterxml.jackson.databind.JavaType;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.imooc.o2o.cache.JedisUtil;\nimport com.imooc.o2o.dao.ShopCategoryDao;\nimport com.imooc.o2o.entity.ShopCategory;\nimport com.imooc.o2o.exceptions.ShopOperationException;\nimport com.imooc.o2o.service.ShopCategoryService;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.stereotype.Service;\n\nimport java.io.IOException;\nimport java.util.ArrayList;\nimport java.util.List;\n\n@Service\npublic class ShopCategoryServiceImpl implements ShopCategoryService &#123;\n    @Autowired\n    private ShopCategoryDao shopCategoryDao;\n    @Autowired\n    private JedisUtil.Keys keys;\n    @Autowired\n    private JedisUtil.Strings strings;\n\n    private Logger logger = LoggerFactory.getLogger(ShopCategoryServiceImpl.class);\n\n    @Override\n    public List&lt;ShopCategory&gt; queryShopCategory(ShopCategory shopCategoryCondition) &#123;\n        String key = SHOP_CATEGORY_KEY;\n        List&lt;ShopCategory&gt; list = null;\n        ObjectMapper mapper = new ObjectMapper();\n        if(shopCategoryCondition == null)&#123;\n          // 查询一级店铺类别\n            key = SHOP_CATEGORY_KEY + &quot;_parent_null&quot;; \n        &#125;else if(shopCategoryCondition.getParent() != null &amp;&amp; shopCategoryCondition.getParent().getShopCategoryId() != null)&#123;\n          // 查询对应以及类别下的二级类别\n            key = SHOP_CATEGORY_KEY + &quot;_parent_&quot; + shopCategoryCondition.getParent().getShopCategoryId();\n        &#125;else&#123;\n          // 查询所有二级店铺类别\n            key = SHOP_CATEGORY_KEY + &quot;_parent_not_null_all&quot;; \n        &#125;\n\n          // Reids不存在则从数据库取出，取出成功后放入到缓存中\n        if(!keys.exists(key))&#123;\n            list = shopCategoryDao.queryShopCategory(shopCategoryCondition);\n            try &#123;\n                  // 因为是对象，所以这里采用转换为JSON字符串转入\n                String jsonString = mapper.writeValueAsString(list);\n                strings.set(key, jsonString);\n            &#125; catch (JsonProcessingException e) &#123;\n                logger.error(&quot;queryShopCategory error:&quot; + e.getMessage());\n                e.printStackTrace();\n                throw new ShopOperationException(&quot;queryShopCategory error:&quot; + e.getMessage());\n            &#125;\n        &#125;else&#123;\n              // 从Redis缓存中读出字符串，经过JSON转换为对象\n             String jsonString = strings.get(key);\n             JavaType javaType = mapper.getTypeFactory().constructParametricType(ArrayList.class, ShopCategory.class);\n            try &#123;\n                list = mapper.readValue(jsonString, javaType);\n            &#125; catch (IOException e) &#123;\n                logger.error(&quot;queryShopCategory error:&quot; + e.getMessage());\n                e.printStackTrace();\n                throw new ShopOperationException(&quot;queryShopCategory error:&quot; + e.getMessage());\n            &#125;\n        &#125;\n        return list;\n    &#125;\n    \n    // 插入数据需要清除所有相关Redis缓存\n    public ShopCategoryExecution insertShopCategory(ShopCategory shopCategory)&#123;\n        try&#123;\n            int effectNum = shopCategoryDao.insertShopCategory(shopCategory);\n            // 插入成功则需要清除Redis缓存\n            if(effectNum &gt; 0)&#123;\n                // 将所有key为SHOP_CATEGORY_KEY打头的数据全部从Redis缓存中清除\n                cacheService.removeKeys(SHOP_CATEGORY_KEY);\n                return ShopCategoryExecution(ShopCategoryStateEnum.SCCESS);\n            &#125;else&#123;\n                return ShopCategoryExecution(ShopCategoryStateEnum.FAIL);\n            &#125;\n        &#125;catch(Exception e)&#123;\n            logger.error(&quot;插入失败：&quot; + e.toString());\n            throw new ShopCategoryException(e.toString());\n        &#125;\n    &#125;\n&#125;\n</code></pre>\n<p>在添加数据时注意清除缓存，下次取就会直接去数据库进行取然后放入缓存中，保证缓存中始终是最新的数据</p>\n<pre><code class=\"java\">package com.imooc.o2o.service.impl;//package com.imooc.o2o.service.impl;\n\nimport com.imooc.o2o.cache.JedisUtil;\nimport com.imooc.o2o.service.CacheService;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.stereotype.Service;\n\nimport java.util.Set;\n\n@Service\npublic class CacheServiceImpl implements CacheService &#123;\n    @Autowired\n    private JedisUtil.Keys keys;\n\n    @Override\n    public void removeKeys(String prefix) &#123;\n        // 首先找到所有以prefix为前缀的key集合\n        Set&lt;String&gt; set = keys.keys(prefix + &quot;*&quot;);\n        for(String key : set)&#123;\n            keys.del(key);\n        &#125;\n    &#125;\n&#125;\n</code></pre>\n<h3 id=\"实现Redis配置\"><a href=\"#实现Redis配置\" class=\"headerlink\" title=\"实现Redis配置\"></a>实现Redis配置</h3><p>配置Redis，首先pom中引入Redis客户端，与远程Redis进行通信</p>\n<pre><code class=\"xml\">        &lt;!--redis客户端:Jedis，与redis服务器进行通信--&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;redis.clients&lt;/groupId&gt;\n            &lt;artifactId&gt;jedis&lt;/artifactId&gt;\n            &lt;version&gt;2.9.0&lt;/version&gt;\n        &lt;/dependency&gt;\n</code></pre>\n<p>application.properties引入redis基础配置，这些配置后续会通过编码读入</p>\n<pre><code class=\"properties\"># reids配置\nredis.hostname=127.0.0.1\nredis.port=6379\nredis.database=0\nredis.pool.maxActive=600\nredis.pool.maxIdle=300\nredis.pool.maxWait=3000\nredis.pool.testOnBorrow=true\n</code></pre>\n<p><strong>连接池JedisPool</strong></p>\n<p>读取Redis配置生成Redis连接池JedisPool</p>\n<pre><code class=\"java\">package com.imooc.o2o.cache;\n\nimport org.springframework.context.annotation.Bean;\nimport redis.clients.jedis.JedisPool;\nimport redis.clients.jedis.JedisPoolConfig;\n\n/**\n * 强指定redis的JedisPool接口构造函数，这样才能在centos中成功创建jedispool\n */\npublic class JedisPoolWriper &#123;\n    private JedisPool jedisPool;\n\n    public JedisPoolWriper() &#123;\n    &#125;\n\n    public JedisPoolWriper(final JedisPoolConfig poolConfig, final String host, final int port) &#123;\n        try &#123;\n            jedisPool = new JedisPool(poolConfig, host, port);\n        &#125; catch (Exception e) &#123;\n            e.printStackTrace();\n        &#125;\n    &#125;\n\n    public JedisPool getJedisPool() &#123;\n        return jedisPool;\n    &#125;\n\n    public void setJedisPool(JedisPool jedisPool) &#123;\n        this.jedisPool = jedisPool;\n    &#125;\n&#125;\n</code></pre>\n<p><strong>注入Redis配置到容器</strong></p>\n<p>包括Redis连接池配置JedisPoolConfig，JedisPool连接，Jedis基本数据常见API</p>\n<p>其中可以看到添加@Configuration注解，就是读取相应application.properties配置</p>\n<p>JedisPoolConfig、JedisPool都添加了@Bean注解，需要在项目启动时注入到容器中</p>\n<pre><code class=\"java\">package com.imooc.o2o.config.redis;\n\nimport com.imooc.o2o.cache.JedisPoolWriper;\nimport com.imooc.o2o.cache.JedisUtil;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport redis.clients.jedis.JedisPoolConfig;\n\n@Configuration\npublic class RedisConfiguration &#123;\n    @Value(&quot;$&#123;redis.pool.maxActive&#125;&quot;)\n    private int maxActive;\n    @Value(&quot;$&#123;redis.hostname&#125;&quot;)\n    private String hostname;\n    @Value(&quot;$&#123;redis.port&#125;&quot;)\n    private int port;\n    @Value(&quot;$&#123;redis.pool.maxIdle&#125;&quot;)\n    private int maxIdle;\n    @Value(&quot;$&#123;redis.pool.maxWait&#125;&quot;)\n    private int maxWait;\n    @Value(&quot;$&#123;redis.pool.testOnBorrow&#125;&quot;)\n    private boolean testOnBorrow;\n\n    @Autowired\n    private JedisPoolConfig jedisPoolConfig;\n    @Autowired\n    private JedisPoolWriper jedisWritePool;\n    @Autowired\n    private JedisUtil jedisUtil;\n\n    /**\n     * redis连接池配置\n     * @return\n     */\n    @Bean(&quot;jedisPoolConfig&quot;)\n    public JedisPoolConfig createJedisPoolConfig() &#123;\n        JedisPoolConfig jedisPoolConfig = new JedisPoolConfig();\n        // 控制一个pool可以分配多少个jedis实例\n        jedisPoolConfig.setMaxTotal(maxActive);\n        // 连接池最多空闲多少个连接\n        // 表示解释没有数据库连接时依然保持的链接数目，而不被清除，随时处于待命状态\n        jedisPoolConfig.setMaxIdle(maxIdle);\n        // 最大等待时间：但没有可用连接时，连接池等待连接被归还的最大时间，超出时间则抛出异常\n        jedisPoolConfig.setMaxWaitMillis(maxWait);\n        // 在获取连接时检查有效性\n        jedisPoolConfig.setTestOnBorrow(testOnBorrow);\n        return jedisPoolConfig;\n    &#125;\n\n    /**\n     * 创建Redis连接池，并做相关配置\n     * @return\n     */\n    @Bean(&quot;jedisWritePool&quot;)\n    public JedisPoolWriper createJedisPoolWriper()&#123;\n        JedisPoolWriper jedisPoolWriper = new JedisPoolWriper(jedisPoolConfig, hostname, port);\n        return jedisPoolWriper;\n    &#125;\n\n    /**\n     * 创建Redis工具类，封装好redis的连接已进行相关操作\n     * @return\n     */\n    @Bean(&quot;jedisUtil&quot;)\n    public JedisUtil createJedisUtil()&#123;\n        JedisUtil jedisUtil = new JedisUtil();\n        jedisUtil.setJedisPool(jedisWritePool);\n        return jedisUtil;\n    &#125;\n\n    /**\n     * jedis的key操作\n     * @return\n     */\n    @Bean(&quot;jedisKeys&quot;)\n    public JedisUtil.Keys createKeys()&#123;\n        // 注意内部类的new方式\n        JedisUtil.Keys keys = jedisUtil.new Keys();\n        return keys;\n    &#125;\n\n    /**\n     * jedis的Strings操作\n     * @return\n     */\n    @Bean(&quot;jedisStrings&quot;)\n    public JedisUtil.Strings createStrings()&#123;\n        JedisUtil.Strings strings = jedisUtil.new Strings();\n        return strings;\n    &#125;\n&#125;\n</code></pre>\n<p><strong>编写Jedis工具类</strong></p>\n<p>将Jedis常用数据对象浅浅的封装一层，封装一层的目的在于：使用第三方组件时，浅浅封装一层避免直接调用API，可以在后续项目时随时更改，而项目其他地方不用更改，例如后续项目需要监控Redis取缓存时间，那么朱旭在封装前后，统计一下时间即可</p>\n<pre><code class=\"java\">        /**\n         * 根据key获取记录\n         *\n         * @param key\n         * @return 值\n         */\n        public String get(String key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            String value = sjedis.get(key);\n            sjedis.close();\n            return value;\n        &#125;\n</code></pre>\n<p>项目需要统计取key消耗时间</p>\n<pre><code class=\"java\">        /**\n         * 根据key获取记录，统计操作时间\n         *\n         * @param key\n         * @return 值\n         */\n        public String get(String key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            long startTime = System.currentTimeMillis();\n            System.get\n            Jedis sjedis = getJedis();\n            String value = sjedis.get(key);\n                long endTime = System.currentTimeMillis();\n                logger.info(String.format(&quot;get Strings key:%d cost %d ms&quot;), key, endTime - startTime);\n            sjedis.close();\n            return value;\n        &#125;\n</code></pre>\n<p><strong>JedisUtil工具类</strong></p>\n<p>JedisUtil浅浅封装一层Redis常见数据对象的方法</p>\n<pre><code class=\"java\">package com.imooc.o2o.cache;\n\nimport redis.clients.jedis.BinaryClient;\nimport redis.clients.jedis.Jedis;\nimport redis.clients.jedis.JedisPool;\nimport redis.clients.jedis.SortingParams;\nimport redis.clients.util.SafeEncoder;\n\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Set;\n\npublic class JedisUtil &#123;\n    /**\n     * 缓存生存时间\n     */\n    private final int expire = 60000;\n    /**\n     * 操作Key的方法\n     */\n    public Keys KEYS;\n    /**\n     * 对存储结构为String类型的操作\n     */\n    public Strings STRINGS;\n    /**\n     * 对存储结构为List类型的操作\n     */\n    public Lists LISTS;\n    /**\n     * 对存储结构为Set类型的操作\n     */\n    public Sets SETS;\n    /**\n     * 对存储结构为HashMap类型的操作\n     */\n    public Hash HASH;\n\n    private JedisPool jedisPool;\n\n    public JedisPool getJedisPool() &#123;\n        return jedisPool;\n    &#125;\n\n    public void setJedisPool(JedisPoolWriper jedisPoolWriper) &#123;\n        this.jedisPool = jedisPoolWriper.getJedisPool();\n    &#125;\n\n    public JedisPool getPool() &#123;\n        return jedisPool;\n    &#125;\n\n    /**\n     * 从jedis连接池中获取获取jedis对象\n     *\n     * @return\n     */\n    public Jedis getJedis() &#123;\n        return jedisPool.getResource();\n    &#125;\n\n    /**\n     * 设置过期时间\n     *\n     * @param @param\n     * @author ruan 2013-4-11\n     */\n    public void expire(String key, int seconds) &#123;\n        if (seconds &lt;= 0) &#123;\n            return;\n        &#125;\n        Jedis jedis = getJedis();\n        jedis.expire(key, seconds);\n        jedis.close();\n    &#125;\n\n    /**\n     * 设置默认过期时间\n     *\n     * @param\n     * @author ruan 2013-4-11\n     */\n    public void expire(String key) &#123;\n        expire(key, expire);\n    &#125;\n\n    // *******************************************Keys*******************************************//\n    public class Keys &#123;\n\n        /**\n         * 清空所有key\n         */\n        public String flushAll() &#123;\n            Jedis jedis = getJedis();\n            String stata = jedis.flushAll();\n            jedis.close();\n            return stata;\n        &#125;\n\n        /**\n         * 更改key\n         *\n         * @param oldkey\n         * @param newkey\n         * @return 状态码\n         */\n        public String rename(String oldkey, String newkey) &#123;\n            return rename(SafeEncoder.encode(oldkey),\n                    SafeEncoder.encode(newkey));\n        &#125;\n\n        /**\n         * 更改key,仅当新key不存在时才执行\n         *\n         * @param oldkey\n         * @param newkey\n         * @return 状态码\n         */\n        public long renamenx(String oldkey, String newkey) &#123;\n            Jedis jedis = getJedis();\n            long status = jedis.renamenx(oldkey, newkey);\n            jedis.close();\n            return status;\n        &#125;\n\n        /**\n         * 更改key\n         *\n         * @param oldkey\n         * @param newkey\n         * @return 状态码\n         */\n        public String rename(byte[] oldkey, byte[] newkey) &#123;\n            Jedis jedis = getJedis();\n            String status = jedis.rename(oldkey, newkey);\n            jedis.close();\n            return status;\n        &#125;\n\n        /**\n         * 设置key的过期时间，以秒为单位\n         *\n         * @param key\n         * @param seconds 已秒为单位\n         * @return 影响的记录数\n         */\n        public long expired(String key, int seconds) &#123;\n            Jedis jedis = getJedis();\n            long count = jedis.expire(key, seconds);\n            jedis.close();\n            return count;\n        &#125;\n\n        /**\n         * 设置key的过期时间,它是距历元（即格林威治标准时间 1970 年 1 月 1 日的 00:00:00，格里高利历）的偏移量。\n         *\n         * @param key\n         * @param timestamp 已秒为单位\n         * @return 影响的记录数\n         */\n        public long expireAt(String key, long timestamp) &#123;\n            Jedis jedis = getJedis();\n            long count = jedis.expireAt(key, timestamp);\n            jedis.close();\n            return count;\n        &#125;\n\n        /**\n         * 查询key的过期时间\n         *\n         * @param key\n         * @return 以秒为单位的时间表示\n         */\n        public long ttl(String key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            long len = sjedis.ttl(key);\n            sjedis.close();\n            return len;\n        &#125;\n\n        /**\n         * 取消对key过期时间的设置\n         *\n         * @param key\n         * @return 影响的记录数\n         */\n        public long persist(String key) &#123;\n            Jedis jedis = getJedis();\n            long count = jedis.persist(key);\n            jedis.close();\n            return count;\n        &#125;\n\n        /**\n         * 删除keys对应的记录,可以是多个key\n         *\n         * @param keys\n         * @return 删除的记录数\n         */\n        public long del(String... keys) &#123;\n            Jedis jedis = getJedis();\n            long count = jedis.del(keys);\n            jedis.close();\n            return count;\n        &#125;\n\n        /**\n         * 删除keys对应的记录,可以是多个key\n         *\n         * @param keys\n         * @return 删除的记录数\n         */\n        public long del(byte[]... keys) &#123;\n            Jedis jedis = getJedis();\n            long count = jedis.del(keys);\n            jedis.close();\n            return count;\n        &#125;\n\n        /**\n         * 判断key是否存在\n         *\n         * @param key\n         * @return boolean\n         */\n        public boolean exists(String key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            boolean exis = sjedis.exists(key);\n            sjedis.close();\n            return exis;\n        &#125;\n\n        /**\n         * 对List,Set,SortSet进行排序,如果集合数据较大应避免使用这个方法\n         *\n         * @param key\n         * @return List&lt;String&gt; 集合的全部记录\n         **/\n        public List&lt;String&gt; sort(String key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            List&lt;String&gt; list = sjedis.sort(key);\n            sjedis.close();\n            return list;\n        &#125;\n\n        /**\n         * 对List,Set,SortSet进行排序或limit\n         *\n         * @param key\n         * @param parame 定义排序类型或limit的起止位置.\n         * @return List&lt;String&gt; 全部或部分记录\n         **/\n        public List&lt;String&gt; sort(String key, SortingParams parame) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            List&lt;String&gt; list = sjedis.sort(key, parame);\n            sjedis.close();\n            return list;\n        &#125;\n\n        /**\n         * 返回指定key存储的类型\n         *\n         * @param key\n         * @return String string|list|set|zset|hash\n         **/\n        public String type(String key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            String type = sjedis.type(key);\n            sjedis.close();\n            return type;\n        &#125;\n\n        /**\n         * 查找所有匹配给定的模式的键\n         *\n         * @param pattern key的表达式,*表示多个，？表示一个\n         */\n        public Set&lt;String&gt; keys(String pattern) &#123;\n            Jedis jedis = getJedis();\n            Set&lt;String&gt; set = jedis.keys(pattern);\n            jedis.close();\n            return set;\n        &#125;\n    &#125;\n\n    // *******************************************Sets*******************************************//\n    public class Sets &#123;\n\n        /**\n         * 向Set添加一条记录，如果member已存在返回0,否则返回1\n         *\n         * @param key\n         * @param member\n         * @return 操作码, 0或1\n         */\n        public long sadd(String key, String member) &#123;\n            Jedis jedis = getJedis();\n            long s = jedis.sadd(key, member);\n            jedis.close();\n            return s;\n        &#125;\n\n        public long sadd(byte[] key, byte[] member) &#123;\n            Jedis jedis = getJedis();\n            long s = jedis.sadd(key, member);\n            jedis.close();\n            return s;\n        &#125;\n\n        /**\n         * 获取给定key中元素个数\n         *\n         * @param key\n         * @return 元素个数\n         */\n        public long scard(String key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            long len = sjedis.scard(key);\n            sjedis.close();\n            return len;\n        &#125;\n\n        /**\n         * 返回从第一组和所有的给定集合之间的差异的成员\n         *\n         * @param keys\n         * @return 差异的成员集合\n         */\n        public Set&lt;String&gt; sdiff(String... keys) &#123;\n            Jedis jedis = getJedis();\n            Set&lt;String&gt; set = jedis.sdiff(keys);\n            jedis.close();\n            return set;\n        &#125;\n\n        /**\n         * 这个命令等于sdiff,但返回的不是结果集,而是将结果集存储在新的集合中，如果目标已存在，则覆盖。\n         *\n         * @param newkey 新结果集的key\n         * @param keys   比较的集合\n         * @return 新集合中的记录数\n         **/\n        public long sdiffstore(String newkey, String... keys) &#123;\n            Jedis jedis = getJedis();\n            long s = jedis.sdiffstore(newkey, keys);\n            jedis.close();\n            return s;\n        &#125;\n\n        /**\n         * 返回给定集合交集的成员,如果其中一个集合为不存在或为空，则返回空Set\n         *\n         * @param keys\n         * @return 交集成员的集合\n         **/\n        public Set&lt;String&gt; sinter(String... keys) &#123;\n            Jedis jedis = getJedis();\n            Set&lt;String&gt; set = jedis.sinter(keys);\n            jedis.close();\n            return set;\n        &#125;\n\n        /**\n         * 这个命令等于sinter,但返回的不是结果集,而是将结果集存储在新的集合中，如果目标已存在，则覆盖。\n         *\n         * @param newkey 新结果集的key\n         * @param keys   比较的集合\n         * @return 新集合中的记录数\n         **/\n        public long sinterstore(String newkey, String... keys) &#123;\n            Jedis jedis = getJedis();\n            long s = jedis.sinterstore(newkey, keys);\n            jedis.close();\n            return s;\n        &#125;\n\n        /**\n         * 确定一个给定的值是否存在\n         *\n         * @param key\n         * @param member 要判断的值\n         * @return 存在返回1，不存在返回0\n         **/\n        public boolean sismember(String key, String member) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            boolean s = sjedis.sismember(key, member);\n            sjedis.close();\n            return s;\n        &#125;\n\n        /**\n         * 返回集合中的所有成员\n         *\n         * @param key\n         * @return 成员集合\n         */\n        public Set&lt;String&gt; smembers(String key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            Set&lt;String&gt; set = sjedis.smembers(key);\n            sjedis.close();\n            return set;\n        &#125;\n\n        public Set&lt;byte[]&gt; smembers(byte[] key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            Set&lt;byte[]&gt; set = sjedis.smembers(key);\n            sjedis.close();\n            return set;\n        &#125;\n\n        /**\n         * 将成员从源集合移出放入目标集合 &lt;br/&gt;\n         * 如果源集合不存在或不包哈指定成员，不进行任何操作，返回0&lt;br/&gt;\n         * 否则该成员从源集合上删除，并添加到目标集合，如果目标集合中成员已存在，则只在源集合进行删除\n         *\n         * @param srckey 源集合\n         * @param dstkey 目标集合\n         * @param member 源集合中的成员\n         * @return 状态码，1成功，0失败\n         */\n        public long smove(String srckey, String dstkey, String member) &#123;\n            Jedis jedis = getJedis();\n            long s = jedis.smove(srckey, dstkey, member);\n            jedis.close();\n            return s;\n        &#125;\n\n        /**\n         * 从集合中删除成员\n         *\n         * @param key\n         * @return 被删除的成员\n         */\n        public String spop(String key) &#123;\n            Jedis jedis = getJedis();\n            String s = jedis.spop(key);\n            jedis.close();\n            return s;\n        &#125;\n\n        /**\n         * 从集合中删除指定成员\n         *\n         * @param key\n         * @param member 要删除的成员\n         * @return 状态码，成功返回1，成员不存在返回0\n         */\n        public long srem(String key, String member) &#123;\n            Jedis jedis = getJedis();\n            long s = jedis.srem(key, member);\n            jedis.close();\n            return s;\n        &#125;\n\n        /**\n         * 合并多个集合并返回合并后的结果，合并后的结果集合并不保存&lt;br/&gt;\n         *\n         * @param keys\n         * @return 合并后的结果集合\n         */\n        public Set&lt;String&gt; sunion(String... keys) &#123;\n            Jedis jedis = getJedis();\n            Set&lt;String&gt; set = jedis.sunion(keys);\n            jedis.close();\n            return set;\n        &#125;\n\n        /**\n         * 合并多个集合并将合并后的结果集保存在指定的新集合中，如果新集合已经存在则覆盖\n         *\n         * @param newkey 新集合的key\n         * @param keys   要合并的集合\n         **/\n        public long sunionstore(String newkey, String... keys) &#123;\n            Jedis jedis = getJedis();\n            long s = jedis.sunionstore(newkey, keys);\n            jedis.close();\n            return s;\n        &#125;\n    &#125;\n\n    // *******************************************Hash*******************************************//\n    public class Hash &#123;\n\n        /**\n         * 从hash中删除指定的存储\n         *\n         * @param key\n         * @param fieid 存储的名字\n         * @return 状态码，1成功，0失败\n         */\n        public long hdel(String key, String fieid) &#123;\n            Jedis jedis = getJedis();\n            long s = jedis.hdel(key, fieid);\n            jedis.close();\n            return s;\n        &#125;\n\n        public long hdel(String key) &#123;\n            Jedis jedis = getJedis();\n            long s = jedis.del(key);\n            jedis.close();\n            return s;\n        &#125;\n\n        /**\n         * 测试hash中指定的存储是否存在\n         *\n         * @param key\n         * @param fieid 存储的名字\n         * @return 1存在，0不存在\n         */\n        public boolean hexists(String key, String fieid) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            boolean s = sjedis.hexists(key, fieid);\n            sjedis.close();\n            return s;\n        &#125;\n\n        /**\n         * 返回hash中指定存储位置的值\n         *\n         * @param key\n         * @param fieid 存储的名字\n         * @return 存储对应的值\n         */\n        public String hget(String key, String fieid) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            String s = sjedis.hget(key, fieid);\n            sjedis.close();\n            return s;\n        &#125;\n\n        public byte[] hget(byte[] key, byte[] fieid) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            byte[] s = sjedis.hget(key, fieid);\n            sjedis.close();\n            return s;\n        &#125;\n\n        /**\n         * 以Map的形式返回hash中的存储和值\n         *\n         * @param key\n         * @return Map&lt;Strinig, String&gt;\n         */\n        public Map&lt;String, String&gt; hgetAll(String key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            Map&lt;String, String&gt; map = sjedis.hgetAll(key);\n            sjedis.close();\n            return map;\n        &#125;\n\n        /**\n         * 添加一个对应关系\n         *\n         * @param key\n         * @param fieid\n         * @param value\n         * @return 状态码 1成功，0失败，fieid已存在将更新，也返回0\n         **/\n        public long hset(String key, String fieid, String value) &#123;\n            Jedis jedis = getJedis();\n            long s = jedis.hset(key, fieid, value);\n            jedis.close();\n            return s;\n        &#125;\n\n        public long hset(String key, String fieid, byte[] value) &#123;\n            Jedis jedis = getJedis();\n            long s = jedis.hset(key.getBytes(), fieid.getBytes(), value);\n            jedis.close();\n            return s;\n        &#125;\n\n        /**\n         * 添加对应关系，只有在fieid不存在时才执行\n         *\n         * @param key\n         * @param fieid\n         * @param value\n         * @return 状态码 1成功，0失败fieid已存\n         **/\n        public long hsetnx(String key, String fieid, String value) &#123;\n            Jedis jedis = getJedis();\n            long s = jedis.hsetnx(key, fieid, value);\n            jedis.close();\n            return s;\n        &#125;\n\n        /**\n         * 获取hash中value的集合\n         *\n         * @param key\n         * @return List&lt;String&gt;\n         */\n        public List&lt;String&gt; hvals(String key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            List&lt;String&gt; list = sjedis.hvals(key);\n            sjedis.close();\n            return list;\n        &#125;\n\n        /**\n         * 在指定的存储位置加上指定的数字，存储位置的值必须可转为数字类型\n         *\n         * @param key\n         * @param fieid 存储位置\n         * @param value 要增加的值,可以是负数\n         * @return 增加指定数字后，存储位置的值\n         */\n        public long hincrby(String key, String fieid, long value) &#123;\n            Jedis jedis = getJedis();\n            long s = jedis.hincrBy(key, fieid, value);\n            jedis.close();\n            return s;\n        &#125;\n\n        /**\n         * 返回指定hash中的所有存储名字,类似Map中的keySet方法\n         *\n         * @param key\n         * @return Set&lt;String&gt; 存储名称的集合\n         */\n        public Set&lt;String&gt; hkeys(String key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            Set&lt;String&gt; set = sjedis.hkeys(key);\n            sjedis.close();\n            return set;\n        &#125;\n\n        /**\n         * 获取hash中存储的个数，类似Map中size方法\n         *\n         * @param key\n         * @return long 存储的个数\n         */\n        public long hlen(String key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            long len = sjedis.hlen(key);\n            sjedis.close();\n            return len;\n        &#125;\n\n        /**\n         * 根据多个key，获取对应的value，返回List,如果指定的key不存在,List对应位置为null\n         *\n         * @param key\n         * @param fieids 存储位置\n         * @return List&lt;String&gt;\n         */\n        public List&lt;String&gt; hmget(String key, String... fieids) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            List&lt;String&gt; list = sjedis.hmget(key, fieids);\n            sjedis.close();\n            return list;\n        &#125;\n\n        public List&lt;byte[]&gt; hmget(byte[] key, byte[]... fieids) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            List&lt;byte[]&gt; list = sjedis.hmget(key, fieids);\n            sjedis.close();\n            return list;\n        &#125;\n\n        /**\n         * 添加对应关系，如果对应关系已存在，则覆盖\n         *\n         * @param key\n         * @param map 对应关系\n         * @return 状态，成功返回OK\n         */\n        public String hmset(String key, Map&lt;String, String&gt; map) &#123;\n            Jedis jedis = getJedis();\n            String s = jedis.hmset(key, map);\n            jedis.close();\n            return s;\n        &#125;\n\n        /**\n         * 添加对应关系，如果对应关系已存在，则覆盖\n         *\n         * @param key\n         * @param map 对应关系\n         * @return 状态，成功返回OK\n         */\n        public String hmset(byte[] key, Map&lt;byte[], byte[]&gt; map) &#123;\n            Jedis jedis = getJedis();\n            String s = jedis.hmset(key, map);\n            jedis.close();\n            return s;\n        &#125;\n\n    &#125;\n\n    // *******************************************Strings*******************************************//\n    public class Strings &#123;\n\n        /**\n         * 根据key获取记录\n         *\n         * @param key\n         * @return 值\n         */\n        public String get(String key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            String value = sjedis.get(key);\n            sjedis.close();\n            return value;\n        &#125;\n\n        /**\n         * 根据key获取记录\n         *\n         * @param key\n         * @return 值\n         */\n        public byte[] get(byte[] key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            byte[] value = sjedis.get(key);\n            sjedis.close();\n            return value;\n        &#125;\n\n        /**\n         * 添加有过期时间的记录\n         *\n         * @param key\n         * @param seconds 过期时间，以秒为单位\n         * @param value\n         * @return String 操作状态\n         */\n        public String setEx(String key, int seconds, String value) &#123;\n            Jedis jedis = getJedis();\n            String str = jedis.setex(key, seconds, value);\n            jedis.close();\n            return str;\n        &#125;\n\n        /**\n         * 添加有过期时间的记录\n         *\n         * @param key\n         * @param seconds 过期时间，以秒为单位\n         * @param value\n         * @return String 操作状态\n         */\n        public String setEx(byte[] key, int seconds, byte[] value) &#123;\n            Jedis jedis = getJedis();\n            String str = jedis.setex(key, seconds, value);\n            jedis.close();\n            return str;\n        &#125;\n\n        /**\n         * 添加一条记录，仅当给定的key不存在时才插入\n         *\n         * @param key\n         * @param value\n         * @return long 状态码，1插入成功且key不存在，0未插入，key存在\n         */\n        public long setnx(String key, String value) &#123;\n            Jedis jedis = getJedis();\n            long str = jedis.setnx(key, value);\n            jedis.close();\n            return str;\n        &#125;\n\n        /**\n         * 添加记录,如果记录已存在将覆盖原有的value\n         *\n         * @param key\n         * @param value\n         * @return 状态码\n         */\n        public String set(String key, String value) &#123;\n            return set(SafeEncoder.encode(key), SafeEncoder.encode(value));\n        &#125;\n\n        /**\n         * 添加记录,如果记录已存在将覆盖原有的value\n         *\n         * @param key\n         * @param value\n         * @return 状态码\n         */\n        public String set(String key, byte[] value) &#123;\n            return set(SafeEncoder.encode(key), value);\n        &#125;\n\n        /**\n         * 添加记录,如果记录已存在将覆盖原有的value\n         *\n         * @param key\n         * @param value\n         * @return 状态码\n         */\n        public String set(byte[] key, byte[] value) &#123;\n            Jedis jedis = getJedis();\n            String status = jedis.set(key, value);\n            jedis.close();\n            return status;\n        &#125;\n\n        /**\n         * 从指定位置开始插入数据，插入的数据会覆盖指定位置以后的数据&lt;br/&gt;\n         * 例:String str1=&quot;123456789&quot;;&lt;br/&gt;\n         * 对str1操作后setRange(key,4,0000)，str1=&quot;123400009&quot;;\n         *\n         * @param key\n         * @param offset\n         * @param value\n         * @return long value的长度\n         */\n        public long setRange(String key, long offset, String value) &#123;\n            Jedis jedis = getJedis();\n            long len = jedis.setrange(key, offset, value);\n            jedis.close();\n            return len;\n        &#125;\n\n        /**\n         * 在指定的key中追加value\n         *\n         * @param key\n         * @param value\n         * @return long 追加后value的长度\n         **/\n        public long append(String key, String value) &#123;\n            Jedis jedis = getJedis();\n            long len = jedis.append(key, value);\n            jedis.close();\n            return len;\n        &#125;\n\n        /**\n         * 将key对应的value减去指定的值，只有value可以转为数字时该方法才可用\n         *\n         * @param key\n         * @param number 要减去的值\n         * @return long 减指定值后的值\n         */\n        public long decrBy(String key, long number) &#123;\n            Jedis jedis = getJedis();\n            long len = jedis.decrBy(key, number);\n            jedis.close();\n            return len;\n        &#125;\n\n        /**\n         * &lt;b&gt;可以作为获取唯一id的方法&lt;/b&gt;&lt;br/&gt;\n         * 将key对应的value加上指定的值，只有value可以转为数字时该方法才可用\n         *\n         * @param key\n         * @param number 要减去的值\n         * @return long 相加后的值\n         */\n        public long incrBy(String key, long number) &#123;\n            Jedis jedis = getJedis();\n            long len = jedis.incrBy(key, number);\n            jedis.close();\n            return len;\n        &#125;\n\n        /**\n         * 对指定key对应的value进行截取\n         *\n         * @param key\n         * @param startOffset 开始位置(包含)\n         * @param endOffset   结束位置(包含)\n         * @return String 截取的值\n         */\n        public String getrange(String key, long startOffset, long endOffset) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            String value = sjedis.getrange(key, startOffset, endOffset);\n            sjedis.close();\n            return value;\n        &#125;\n\n        /**\n         * 获取并设置指定key对应的value&lt;br/&gt;\n         * 如果key存在返回之前的value,否则返回null\n         *\n         * @param key\n         * @param value\n         * @return String 原始value或null\n         */\n        public String getSet(String key, String value) &#123;\n            Jedis jedis = getJedis();\n            String str = jedis.getSet(key, value);\n            jedis.close();\n            return str;\n        &#125;\n\n        /**\n         * 批量获取记录,如果指定的key不存在返回List的对应位置将是null\n         *\n         * @param keys\n         * @return List&lt;String&gt; 值得集合\n         */\n        public List&lt;String&gt; mget(String... keys) &#123;\n            Jedis jedis = getJedis();\n            List&lt;String&gt; str = jedis.mget(keys);\n            jedis.close();\n            return str;\n        &#125;\n\n        /**\n         * 批量存储记录\n         *\n         * @param keysvalues 例:keysvalues=&quot;key1&quot;,&quot;value1&quot;,&quot;key2&quot;,&quot;value2&quot;;\n         * @return String 状态码\n         */\n        public String mset(String... keysvalues) &#123;\n            Jedis jedis = getJedis();\n            String str = jedis.mset(keysvalues);\n            jedis.close();\n            return str;\n        &#125;\n\n        /**\n         * 获取key对应的值的长度\n         *\n         * @param key\n         * @return value值得长度\n         */\n        public long strlen(String key) &#123;\n            Jedis jedis = getJedis();\n            long len = jedis.strlen(key);\n            jedis.close();\n            return len;\n        &#125;\n    &#125;\n\n    // *******************************************Lists*******************************************//\n    public class Lists &#123;\n\n        /**\n         * List长度\n         *\n         * @param key\n         * @return 长度\n         */\n        public long llen(String key) &#123;\n            return llen(SafeEncoder.encode(key));\n        &#125;\n\n        /**\n         * List长度\n         *\n         * @param key\n         * @return 长度\n         */\n        public long llen(byte[] key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            long count = sjedis.llen(key);\n            sjedis.close();\n            return count;\n        &#125;\n\n        /**\n         * 覆盖操作,将覆盖List中指定位置的值\n         *\n         * @param key\n         * @param index 位置\n         * @param value 值\n         * @return 状态码\n         */\n        public String lset(byte[] key, int index, byte[] value) &#123;\n            Jedis jedis = getJedis();\n            String status = jedis.lset(key, index, value);\n            jedis.close();\n            return status;\n        &#125;\n\n        /**\n         * 覆盖操作,将覆盖List中指定位置的值\n         *\n         * @param @param index 位置\n         * @param value  值\n         * @return 状态码\n         */\n        public String lset(String key, int index, String value) &#123;\n            return lset(SafeEncoder.encode(key), index,\n                    SafeEncoder.encode(value));\n        &#125;\n\n        /**\n         * 在value的相对位置插入记录\n         *\n         * @param @param 前面插入或后面插入\n         * @param pivot  相对位置的内容\n         * @param value  插入的内容\n         * @return 记录总数\n         */\n        public long linsert(String key, BinaryClient.LIST_POSITION where, String pivot,\n                            String value) &#123;\n            return linsert(SafeEncoder.encode(key), where,\n                    SafeEncoder.encode(pivot), SafeEncoder.encode(value));\n        &#125;\n\n        /**\n         * 在指定位置插入记录\n         *\n         * @param key\n         * @param where 前面插入或后面插入\n         * @param pivot 相对位置的内容\n         * @param value 插入的内容\n         * @return 记录总数\n         */\n        public long linsert(byte[] key, BinaryClient.LIST_POSITION where, byte[] pivot,\n                            byte[] value) &#123;\n            Jedis jedis = getJedis();\n            long count = jedis.linsert(key, where, pivot, value);\n            jedis.close();\n            return count;\n        &#125;\n\n        /**\n         * 获取List中指定位置的值\n         *\n         * @param key\n         * @param index 位置\n         * @return 值\n         **/\n        public String lindex(String key, int index) &#123;\n            return SafeEncoder.encode(lindex(SafeEncoder.encode(key), index));\n        &#125;\n\n        /**\n         * 获取List中指定位置的值\n         *\n         * @param key\n         * @param index 位置\n         * @return 值\n         **/\n        public byte[] lindex(byte[] key, int index) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            byte[] value = sjedis.lindex(key, index);\n            sjedis.close();\n            return value;\n        &#125;\n\n        /**\n         * 将List中的第一条记录移出List\n         *\n         * @param key\n         * @return 移出的记录\n         */\n        public String lpop(String key) &#123;\n            return SafeEncoder.encode(lpop(SafeEncoder.encode(key)));\n        &#125;\n\n        /**\n         * 将List中的第一条记录移出List\n         *\n         * @param key\n         * @return 移出的记录\n         */\n        public byte[] lpop(byte[] key) &#123;\n            Jedis jedis = getJedis();\n            byte[] value = jedis.lpop(key);\n            jedis.close();\n            return value;\n        &#125;\n\n        /**\n         * 将List中最后第一条记录移出List\n         *\n         * @param key\n         * @return 移出的记录\n         */\n        public String rpop(String key) &#123;\n            Jedis jedis = getJedis();\n            String value = jedis.rpop(key);\n            jedis.close();\n            return value;\n        &#125;\n\n        /**\n         * 向List尾部追加记录\n         *\n         * @param key\n         * @param value\n         * @return 记录总数\n         */\n        public long lpush(String key, String value) &#123;\n            return lpush(SafeEncoder.encode(key), SafeEncoder.encode(value));\n        &#125;\n\n        /**\n         * 向List头部追加记录\n         *\n         * @param key\n         * @param value\n         * @return 记录总数\n         */\n        public long rpush(String key, String value) &#123;\n            Jedis jedis = getJedis();\n            long count = jedis.rpush(key, value);\n            jedis.close();\n            return count;\n        &#125;\n\n        /**\n         * 向List头部追加记录\n         *\n         * @param key\n         * @param value\n         * @return 记录总数\n         */\n        public long rpush(byte[] key, byte[] value) &#123;\n            Jedis jedis = getJedis();\n            long count = jedis.rpush(key, value);\n            jedis.close();\n            return count;\n        &#125;\n\n        /**\n         * 向List中追加记录\n         *\n         * @param key\n         * @param value\n         * @return 记录总数\n         */\n        public long lpush(byte[] key, byte[] value) &#123;\n            Jedis jedis = getJedis();\n            long count = jedis.lpush(key, value);\n            jedis.close();\n            return count;\n        &#125;\n\n        /**\n         * 获取指定范围的记录，可以做为分页使用\n         *\n         * @param key\n         * @param start\n         * @param end\n         * @return List\n         */\n        public List&lt;String&gt; lrange(String key, long start, long end) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            List&lt;String&gt; list = sjedis.lrange(key, start, end);\n            sjedis.close();\n            return list;\n        &#125;\n\n        /**\n         * 获取指定范围的记录，可以做为分页使用\n         *\n         * @param key\n         * @param start\n         * @param end   如果为负数，则尾部开始计算\n         * @return List\n         */\n        public List&lt;byte[]&gt; lrange(byte[] key, int start, int end) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            List&lt;byte[]&gt; list = sjedis.lrange(key, start, end);\n            sjedis.close();\n            return list;\n        &#125;\n\n        /**\n         * 删除List中c条记录，被删除的记录值为value\n         *\n         * @param key\n         * @param c     要删除的数量，如果为负数则从List的尾部检查并删除符合的记录\n         * @param value 要匹配的值\n         * @return 删除后的List中的记录数\n         */\n        public long lrem(byte[] key, int c, byte[] value) &#123;\n            Jedis jedis = getJedis();\n            long count = jedis.lrem(key, c, value);\n            jedis.close();\n            return count;\n        &#125;\n\n        /**\n         * 删除List中c条记录，被删除的记录值为value\n         *\n         * @param key\n         * @param c     要删除的数量，如果为负数则从List的尾部检查并删除符合的记录\n         * @param value 要匹配的值\n         * @return 删除后的List中的记录数\n         */\n        public long lrem(String key, int c, String value) &#123;\n            return lrem(SafeEncoder.encode(key), c, SafeEncoder.encode(value));\n        &#125;\n\n        /**\n         * 算是删除吧，只保留start与end之间的记录\n         *\n         * @param key\n         * @param start 记录的开始位置(0表示第一条记录)\n         * @param end   记录的结束位置（如果为-1则表示最后一个，-2，-3以此类推）\n         * @return 执行状态码\n         */\n        public String ltrim(byte[] key, int start, int end) &#123;\n            Jedis jedis = getJedis();\n            String str = jedis.ltrim(key, start, end);\n            jedis.close();\n            return str;\n        &#125;\n\n        /**\n         * 算是删除吧，只保留start与end之间的记录\n         *\n         * @param key\n         * @param start 记录的开始位置(0表示第一条记录)\n         * @param end   记录的结束位置（如果为-1则表示最后一个，-2，-3以此类推）\n         * @return 执行状态码\n         */\n        public String ltrim(String key, int start, int end) &#123;\n            return ltrim(SafeEncoder.encode(key), start, end);\n        &#125;\n    &#125;\n\n&#125;\n</code></pre>\n","site":{"data":{"photography":[{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5196.JPG","title":"玉渊潭","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/IMG_5186.JPG","title":"花儿","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"},{"thumbnail":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","photo":"https://doermail-product.oss-cn-beijing.aliyuncs.com/photography/FullSizeRender.jpg","title":"白塔寺","icon":{"name":"unsplash","type":"logo","url":"https://yizhichangyuan.github.io"},"place":"China"}]}},"excerpt":"<blockquote>\n<p>redis是一个key-value型存储系统，支持的value类型比较丰富，支持String、List、集合set（没有顺序，元素唯一）、有序集合Zset，都支持push、pop、add、remove、交并集等操作，这些操作都是原子性的，调用redis的操作不用考虑多进程之间的并发问题。在此基础上，redis支持各种方式的排序，为了保证效率，数据都是缓存在内存中的，区别在于：redis会周期性的把更新的数据写到磁盘或者修改操作追加的记录文件中，前者就是默认的RDD模式，就是把数据写到临时文件中，持久化结束后，把临时文件替换为上次持久化的文件，达到数据恢复的目的，优点在于：使用单独子进程进行持久化，主进程不会进行任何IO操作，保证了redis的高效性能，缺点在于RDD是间隔一段时间进行持久化，如果持久化间隔期间，redis发生故障，那么这个持久化就不会更新到磁盘中，就会发生数据的丢失。</p></blockquote>","more":"对于数据不那么严谨的应用，可以使用RDD模式。其存储机制默认设置为如果更改了一个key，则间隔900秒之后进行一次持久化存储，如果更改了十个key，则间隔300秒进行一次持久化存储，如果更改了一万个key，则1分钟之后进行持久化，持久化之后就会把最新的临时文件替换掉旧的RDD文件，使用RDD恢复数据，实际就是重启redis，redis会从rdd文件恢复数据；第二种就是AOF操作，就是把执行过的指令记录下来，恢复时就是把这些操作重新回放一遍，优点就是可以保持更高的数据完整性。如果追加file的时间是1s，一旦redis发生故障那么最多丢失数据的时间是1s，这一秒的数据丢失，且如果日志写入不完整，可以使用redis-check-aof对日志文件进行修复，aof文件没有被write之前，可以删除一些其中操作，缺点就是文件比RDD文件大，恢复的时间比较久，其实AOF和MYSQL中的binlog差不多，都是记录操作。\n\n<p>使用意图：就是将一些不经常更改的数据写入到redis中，例如店铺类别、区域信息、头条信息等，这些数据都是读取比较多，写比较少。</p>\n<ul>\n<li><p>客户端读取数据：首先把请求发送给redis，如果redis有请求的数据那么就把数据直接返回给客户端，避免使用数据库，如果redis没有请求的数据，就把请求发给数据库，数据库获取到数据后，返回给客户端，同时把redis中的数据进行更新，保证redis始终返回的是新的数据。</p>\n</li>\n<li><p>客户端写入/修改数据：当数据发生变化或者修改，要同步的更新redis中的数据，简单点的操作就是数据发生修改时，就将redis相应的key的数据清空，如果客户端请求最新数据，因为redis没有，所以请求发给了DB，DB返回数据给客户端，同时把最新数据插入到了redis，保证了redis是最新的数据。</p>\n<div align=\"center\"><img src=\"/2021/Spring/Redis%E4%BD%BF%E7%94%A8/1612949134565-6f08df50-431b-40ba-ba8e-eac9104e8f9d-20210225113349251.png\" alt=\"image-20210129220709957\" style=\"zoom:50%;\"></div>\n\n</li>\n</ul>\n<h3 id=\"业务逻辑\"><a href=\"#业务逻辑\" class=\"headerlink\" title=\"业务逻辑\"></a>业务逻辑</h3><p>首先先看一下业务逻辑读和写时如何加入Redis缓存，对于读多写少数据，使用Redis缓存时明智的例如滚动展示的头条。采用Redis缓存，需要先定义存放的key，对于不同条件查询对象配置不同的key</p>\n<p>当遇到请求，先检查Redis是否存在该key，否则从数据库取出然后放入到Redis中，注意不同的查询条件对应的数据key不可相同，否则就乱套了</p>\n<pre><code class=\"java\">package com.imooc.o2o.service.impl;\n\nimport com.fasterxml.jackson.core.JsonProcessingException;\nimport com.fasterxml.jackson.databind.JavaType;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.imooc.o2o.cache.JedisUtil;\nimport com.imooc.o2o.dao.ShopCategoryDao;\nimport com.imooc.o2o.entity.ShopCategory;\nimport com.imooc.o2o.exceptions.ShopOperationException;\nimport com.imooc.o2o.service.ShopCategoryService;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.stereotype.Service;\n\nimport java.io.IOException;\nimport java.util.ArrayList;\nimport java.util.List;\n\n@Service\npublic class ShopCategoryServiceImpl implements ShopCategoryService &#123;\n    @Autowired\n    private ShopCategoryDao shopCategoryDao;\n    @Autowired\n    private JedisUtil.Keys keys;\n    @Autowired\n    private JedisUtil.Strings strings;\n\n    private Logger logger = LoggerFactory.getLogger(ShopCategoryServiceImpl.class);\n\n    @Override\n    public List&lt;ShopCategory&gt; queryShopCategory(ShopCategory shopCategoryCondition) &#123;\n        String key = SHOP_CATEGORY_KEY;\n        List&lt;ShopCategory&gt; list = null;\n        ObjectMapper mapper = new ObjectMapper();\n        if(shopCategoryCondition == null)&#123;\n          // 查询一级店铺类别\n            key = SHOP_CATEGORY_KEY + &quot;_parent_null&quot;; \n        &#125;else if(shopCategoryCondition.getParent() != null &amp;&amp; shopCategoryCondition.getParent().getShopCategoryId() != null)&#123;\n          // 查询对应以及类别下的二级类别\n            key = SHOP_CATEGORY_KEY + &quot;_parent_&quot; + shopCategoryCondition.getParent().getShopCategoryId();\n        &#125;else&#123;\n          // 查询所有二级店铺类别\n            key = SHOP_CATEGORY_KEY + &quot;_parent_not_null_all&quot;; \n        &#125;\n\n          // Reids不存在则从数据库取出，取出成功后放入到缓存中\n        if(!keys.exists(key))&#123;\n            list = shopCategoryDao.queryShopCategory(shopCategoryCondition);\n            try &#123;\n                  // 因为是对象，所以这里采用转换为JSON字符串转入\n                String jsonString = mapper.writeValueAsString(list);\n                strings.set(key, jsonString);\n            &#125; catch (JsonProcessingException e) &#123;\n                logger.error(&quot;queryShopCategory error:&quot; + e.getMessage());\n                e.printStackTrace();\n                throw new ShopOperationException(&quot;queryShopCategory error:&quot; + e.getMessage());\n            &#125;\n        &#125;else&#123;\n              // 从Redis缓存中读出字符串，经过JSON转换为对象\n             String jsonString = strings.get(key);\n             JavaType javaType = mapper.getTypeFactory().constructParametricType(ArrayList.class, ShopCategory.class);\n            try &#123;\n                list = mapper.readValue(jsonString, javaType);\n            &#125; catch (IOException e) &#123;\n                logger.error(&quot;queryShopCategory error:&quot; + e.getMessage());\n                e.printStackTrace();\n                throw new ShopOperationException(&quot;queryShopCategory error:&quot; + e.getMessage());\n            &#125;\n        &#125;\n        return list;\n    &#125;\n    \n    // 插入数据需要清除所有相关Redis缓存\n    public ShopCategoryExecution insertShopCategory(ShopCategory shopCategory)&#123;\n        try&#123;\n            int effectNum = shopCategoryDao.insertShopCategory(shopCategory);\n            // 插入成功则需要清除Redis缓存\n            if(effectNum &gt; 0)&#123;\n                // 将所有key为SHOP_CATEGORY_KEY打头的数据全部从Redis缓存中清除\n                cacheService.removeKeys(SHOP_CATEGORY_KEY);\n                return ShopCategoryExecution(ShopCategoryStateEnum.SCCESS);\n            &#125;else&#123;\n                return ShopCategoryExecution(ShopCategoryStateEnum.FAIL);\n            &#125;\n        &#125;catch(Exception e)&#123;\n            logger.error(&quot;插入失败：&quot; + e.toString());\n            throw new ShopCategoryException(e.toString());\n        &#125;\n    &#125;\n&#125;\n</code></pre>\n<p>在添加数据时注意清除缓存，下次取就会直接去数据库进行取然后放入缓存中，保证缓存中始终是最新的数据</p>\n<pre><code class=\"java\">package com.imooc.o2o.service.impl;//package com.imooc.o2o.service.impl;\n\nimport com.imooc.o2o.cache.JedisUtil;\nimport com.imooc.o2o.service.CacheService;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.stereotype.Service;\n\nimport java.util.Set;\n\n@Service\npublic class CacheServiceImpl implements CacheService &#123;\n    @Autowired\n    private JedisUtil.Keys keys;\n\n    @Override\n    public void removeKeys(String prefix) &#123;\n        // 首先找到所有以prefix为前缀的key集合\n        Set&lt;String&gt; set = keys.keys(prefix + &quot;*&quot;);\n        for(String key : set)&#123;\n            keys.del(key);\n        &#125;\n    &#125;\n&#125;\n</code></pre>\n<h3 id=\"实现Redis配置\"><a href=\"#实现Redis配置\" class=\"headerlink\" title=\"实现Redis配置\"></a>实现Redis配置</h3><p>配置Redis，首先pom中引入Redis客户端，与远程Redis进行通信</p>\n<pre><code class=\"xml\">        &lt;!--redis客户端:Jedis，与redis服务器进行通信--&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;redis.clients&lt;/groupId&gt;\n            &lt;artifactId&gt;jedis&lt;/artifactId&gt;\n            &lt;version&gt;2.9.0&lt;/version&gt;\n        &lt;/dependency&gt;\n</code></pre>\n<p>application.properties引入redis基础配置，这些配置后续会通过编码读入</p>\n<pre><code class=\"properties\"># reids配置\nredis.hostname=127.0.0.1\nredis.port=6379\nredis.database=0\nredis.pool.maxActive=600\nredis.pool.maxIdle=300\nredis.pool.maxWait=3000\nredis.pool.testOnBorrow=true\n</code></pre>\n<p><strong>连接池JedisPool</strong></p>\n<p>读取Redis配置生成Redis连接池JedisPool</p>\n<pre><code class=\"java\">package com.imooc.o2o.cache;\n\nimport org.springframework.context.annotation.Bean;\nimport redis.clients.jedis.JedisPool;\nimport redis.clients.jedis.JedisPoolConfig;\n\n/**\n * 强指定redis的JedisPool接口构造函数，这样才能在centos中成功创建jedispool\n */\npublic class JedisPoolWriper &#123;\n    private JedisPool jedisPool;\n\n    public JedisPoolWriper() &#123;\n    &#125;\n\n    public JedisPoolWriper(final JedisPoolConfig poolConfig, final String host, final int port) &#123;\n        try &#123;\n            jedisPool = new JedisPool(poolConfig, host, port);\n        &#125; catch (Exception e) &#123;\n            e.printStackTrace();\n        &#125;\n    &#125;\n\n    public JedisPool getJedisPool() &#123;\n        return jedisPool;\n    &#125;\n\n    public void setJedisPool(JedisPool jedisPool) &#123;\n        this.jedisPool = jedisPool;\n    &#125;\n&#125;\n</code></pre>\n<p><strong>注入Redis配置到容器</strong></p>\n<p>包括Redis连接池配置JedisPoolConfig，JedisPool连接，Jedis基本数据常见API</p>\n<p>其中可以看到添加@Configuration注解，就是读取相应application.properties配置</p>\n<p>JedisPoolConfig、JedisPool都添加了@Bean注解，需要在项目启动时注入到容器中</p>\n<pre><code class=\"java\">package com.imooc.o2o.config.redis;\n\nimport com.imooc.o2o.cache.JedisPoolWriper;\nimport com.imooc.o2o.cache.JedisUtil;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport redis.clients.jedis.JedisPoolConfig;\n\n@Configuration\npublic class RedisConfiguration &#123;\n    @Value(&quot;$&#123;redis.pool.maxActive&#125;&quot;)\n    private int maxActive;\n    @Value(&quot;$&#123;redis.hostname&#125;&quot;)\n    private String hostname;\n    @Value(&quot;$&#123;redis.port&#125;&quot;)\n    private int port;\n    @Value(&quot;$&#123;redis.pool.maxIdle&#125;&quot;)\n    private int maxIdle;\n    @Value(&quot;$&#123;redis.pool.maxWait&#125;&quot;)\n    private int maxWait;\n    @Value(&quot;$&#123;redis.pool.testOnBorrow&#125;&quot;)\n    private boolean testOnBorrow;\n\n    @Autowired\n    private JedisPoolConfig jedisPoolConfig;\n    @Autowired\n    private JedisPoolWriper jedisWritePool;\n    @Autowired\n    private JedisUtil jedisUtil;\n\n    /**\n     * redis连接池配置\n     * @return\n     */\n    @Bean(&quot;jedisPoolConfig&quot;)\n    public JedisPoolConfig createJedisPoolConfig() &#123;\n        JedisPoolConfig jedisPoolConfig = new JedisPoolConfig();\n        // 控制一个pool可以分配多少个jedis实例\n        jedisPoolConfig.setMaxTotal(maxActive);\n        // 连接池最多空闲多少个连接\n        // 表示解释没有数据库连接时依然保持的链接数目，而不被清除，随时处于待命状态\n        jedisPoolConfig.setMaxIdle(maxIdle);\n        // 最大等待时间：但没有可用连接时，连接池等待连接被归还的最大时间，超出时间则抛出异常\n        jedisPoolConfig.setMaxWaitMillis(maxWait);\n        // 在获取连接时检查有效性\n        jedisPoolConfig.setTestOnBorrow(testOnBorrow);\n        return jedisPoolConfig;\n    &#125;\n\n    /**\n     * 创建Redis连接池，并做相关配置\n     * @return\n     */\n    @Bean(&quot;jedisWritePool&quot;)\n    public JedisPoolWriper createJedisPoolWriper()&#123;\n        JedisPoolWriper jedisPoolWriper = new JedisPoolWriper(jedisPoolConfig, hostname, port);\n        return jedisPoolWriper;\n    &#125;\n\n    /**\n     * 创建Redis工具类，封装好redis的连接已进行相关操作\n     * @return\n     */\n    @Bean(&quot;jedisUtil&quot;)\n    public JedisUtil createJedisUtil()&#123;\n        JedisUtil jedisUtil = new JedisUtil();\n        jedisUtil.setJedisPool(jedisWritePool);\n        return jedisUtil;\n    &#125;\n\n    /**\n     * jedis的key操作\n     * @return\n     */\n    @Bean(&quot;jedisKeys&quot;)\n    public JedisUtil.Keys createKeys()&#123;\n        // 注意内部类的new方式\n        JedisUtil.Keys keys = jedisUtil.new Keys();\n        return keys;\n    &#125;\n\n    /**\n     * jedis的Strings操作\n     * @return\n     */\n    @Bean(&quot;jedisStrings&quot;)\n    public JedisUtil.Strings createStrings()&#123;\n        JedisUtil.Strings strings = jedisUtil.new Strings();\n        return strings;\n    &#125;\n&#125;\n</code></pre>\n<p><strong>编写Jedis工具类</strong></p>\n<p>将Jedis常用数据对象浅浅的封装一层，封装一层的目的在于：使用第三方组件时，浅浅封装一层避免直接调用API，可以在后续项目时随时更改，而项目其他地方不用更改，例如后续项目需要监控Redis取缓存时间，那么朱旭在封装前后，统计一下时间即可</p>\n<pre><code class=\"java\">        /**\n         * 根据key获取记录\n         *\n         * @param key\n         * @return 值\n         */\n        public String get(String key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            String value = sjedis.get(key);\n            sjedis.close();\n            return value;\n        &#125;\n</code></pre>\n<p>项目需要统计取key消耗时间</p>\n<pre><code class=\"java\">        /**\n         * 根据key获取记录，统计操作时间\n         *\n         * @param key\n         * @return 值\n         */\n        public String get(String key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            long startTime = System.currentTimeMillis();\n            System.get\n            Jedis sjedis = getJedis();\n            String value = sjedis.get(key);\n                long endTime = System.currentTimeMillis();\n                logger.info(String.format(&quot;get Strings key:%d cost %d ms&quot;), key, endTime - startTime);\n            sjedis.close();\n            return value;\n        &#125;\n</code></pre>\n<p><strong>JedisUtil工具类</strong></p>\n<p>JedisUtil浅浅封装一层Redis常见数据对象的方法</p>\n<pre><code class=\"java\">package com.imooc.o2o.cache;\n\nimport redis.clients.jedis.BinaryClient;\nimport redis.clients.jedis.Jedis;\nimport redis.clients.jedis.JedisPool;\nimport redis.clients.jedis.SortingParams;\nimport redis.clients.util.SafeEncoder;\n\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Set;\n\npublic class JedisUtil &#123;\n    /**\n     * 缓存生存时间\n     */\n    private final int expire = 60000;\n    /**\n     * 操作Key的方法\n     */\n    public Keys KEYS;\n    /**\n     * 对存储结构为String类型的操作\n     */\n    public Strings STRINGS;\n    /**\n     * 对存储结构为List类型的操作\n     */\n    public Lists LISTS;\n    /**\n     * 对存储结构为Set类型的操作\n     */\n    public Sets SETS;\n    /**\n     * 对存储结构为HashMap类型的操作\n     */\n    public Hash HASH;\n\n    private JedisPool jedisPool;\n\n    public JedisPool getJedisPool() &#123;\n        return jedisPool;\n    &#125;\n\n    public void setJedisPool(JedisPoolWriper jedisPoolWriper) &#123;\n        this.jedisPool = jedisPoolWriper.getJedisPool();\n    &#125;\n\n    public JedisPool getPool() &#123;\n        return jedisPool;\n    &#125;\n\n    /**\n     * 从jedis连接池中获取获取jedis对象\n     *\n     * @return\n     */\n    public Jedis getJedis() &#123;\n        return jedisPool.getResource();\n    &#125;\n\n    /**\n     * 设置过期时间\n     *\n     * @param @param\n     * @author ruan 2013-4-11\n     */\n    public void expire(String key, int seconds) &#123;\n        if (seconds &lt;= 0) &#123;\n            return;\n        &#125;\n        Jedis jedis = getJedis();\n        jedis.expire(key, seconds);\n        jedis.close();\n    &#125;\n\n    /**\n     * 设置默认过期时间\n     *\n     * @param\n     * @author ruan 2013-4-11\n     */\n    public void expire(String key) &#123;\n        expire(key, expire);\n    &#125;\n\n    // *******************************************Keys*******************************************//\n    public class Keys &#123;\n\n        /**\n         * 清空所有key\n         */\n        public String flushAll() &#123;\n            Jedis jedis = getJedis();\n            String stata = jedis.flushAll();\n            jedis.close();\n            return stata;\n        &#125;\n\n        /**\n         * 更改key\n         *\n         * @param oldkey\n         * @param newkey\n         * @return 状态码\n         */\n        public String rename(String oldkey, String newkey) &#123;\n            return rename(SafeEncoder.encode(oldkey),\n                    SafeEncoder.encode(newkey));\n        &#125;\n\n        /**\n         * 更改key,仅当新key不存在时才执行\n         *\n         * @param oldkey\n         * @param newkey\n         * @return 状态码\n         */\n        public long renamenx(String oldkey, String newkey) &#123;\n            Jedis jedis = getJedis();\n            long status = jedis.renamenx(oldkey, newkey);\n            jedis.close();\n            return status;\n        &#125;\n\n        /**\n         * 更改key\n         *\n         * @param oldkey\n         * @param newkey\n         * @return 状态码\n         */\n        public String rename(byte[] oldkey, byte[] newkey) &#123;\n            Jedis jedis = getJedis();\n            String status = jedis.rename(oldkey, newkey);\n            jedis.close();\n            return status;\n        &#125;\n\n        /**\n         * 设置key的过期时间，以秒为单位\n         *\n         * @param key\n         * @param seconds 已秒为单位\n         * @return 影响的记录数\n         */\n        public long expired(String key, int seconds) &#123;\n            Jedis jedis = getJedis();\n            long count = jedis.expire(key, seconds);\n            jedis.close();\n            return count;\n        &#125;\n\n        /**\n         * 设置key的过期时间,它是距历元（即格林威治标准时间 1970 年 1 月 1 日的 00:00:00，格里高利历）的偏移量。\n         *\n         * @param key\n         * @param timestamp 已秒为单位\n         * @return 影响的记录数\n         */\n        public long expireAt(String key, long timestamp) &#123;\n            Jedis jedis = getJedis();\n            long count = jedis.expireAt(key, timestamp);\n            jedis.close();\n            return count;\n        &#125;\n\n        /**\n         * 查询key的过期时间\n         *\n         * @param key\n         * @return 以秒为单位的时间表示\n         */\n        public long ttl(String key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            long len = sjedis.ttl(key);\n            sjedis.close();\n            return len;\n        &#125;\n\n        /**\n         * 取消对key过期时间的设置\n         *\n         * @param key\n         * @return 影响的记录数\n         */\n        public long persist(String key) &#123;\n            Jedis jedis = getJedis();\n            long count = jedis.persist(key);\n            jedis.close();\n            return count;\n        &#125;\n\n        /**\n         * 删除keys对应的记录,可以是多个key\n         *\n         * @param keys\n         * @return 删除的记录数\n         */\n        public long del(String... keys) &#123;\n            Jedis jedis = getJedis();\n            long count = jedis.del(keys);\n            jedis.close();\n            return count;\n        &#125;\n\n        /**\n         * 删除keys对应的记录,可以是多个key\n         *\n         * @param keys\n         * @return 删除的记录数\n         */\n        public long del(byte[]... keys) &#123;\n            Jedis jedis = getJedis();\n            long count = jedis.del(keys);\n            jedis.close();\n            return count;\n        &#125;\n\n        /**\n         * 判断key是否存在\n         *\n         * @param key\n         * @return boolean\n         */\n        public boolean exists(String key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            boolean exis = sjedis.exists(key);\n            sjedis.close();\n            return exis;\n        &#125;\n\n        /**\n         * 对List,Set,SortSet进行排序,如果集合数据较大应避免使用这个方法\n         *\n         * @param key\n         * @return List&lt;String&gt; 集合的全部记录\n         **/\n        public List&lt;String&gt; sort(String key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            List&lt;String&gt; list = sjedis.sort(key);\n            sjedis.close();\n            return list;\n        &#125;\n\n        /**\n         * 对List,Set,SortSet进行排序或limit\n         *\n         * @param key\n         * @param parame 定义排序类型或limit的起止位置.\n         * @return List&lt;String&gt; 全部或部分记录\n         **/\n        public List&lt;String&gt; sort(String key, SortingParams parame) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            List&lt;String&gt; list = sjedis.sort(key, parame);\n            sjedis.close();\n            return list;\n        &#125;\n\n        /**\n         * 返回指定key存储的类型\n         *\n         * @param key\n         * @return String string|list|set|zset|hash\n         **/\n        public String type(String key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            String type = sjedis.type(key);\n            sjedis.close();\n            return type;\n        &#125;\n\n        /**\n         * 查找所有匹配给定的模式的键\n         *\n         * @param pattern key的表达式,*表示多个，？表示一个\n         */\n        public Set&lt;String&gt; keys(String pattern) &#123;\n            Jedis jedis = getJedis();\n            Set&lt;String&gt; set = jedis.keys(pattern);\n            jedis.close();\n            return set;\n        &#125;\n    &#125;\n\n    // *******************************************Sets*******************************************//\n    public class Sets &#123;\n\n        /**\n         * 向Set添加一条记录，如果member已存在返回0,否则返回1\n         *\n         * @param key\n         * @param member\n         * @return 操作码, 0或1\n         */\n        public long sadd(String key, String member) &#123;\n            Jedis jedis = getJedis();\n            long s = jedis.sadd(key, member);\n            jedis.close();\n            return s;\n        &#125;\n\n        public long sadd(byte[] key, byte[] member) &#123;\n            Jedis jedis = getJedis();\n            long s = jedis.sadd(key, member);\n            jedis.close();\n            return s;\n        &#125;\n\n        /**\n         * 获取给定key中元素个数\n         *\n         * @param key\n         * @return 元素个数\n         */\n        public long scard(String key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            long len = sjedis.scard(key);\n            sjedis.close();\n            return len;\n        &#125;\n\n        /**\n         * 返回从第一组和所有的给定集合之间的差异的成员\n         *\n         * @param keys\n         * @return 差异的成员集合\n         */\n        public Set&lt;String&gt; sdiff(String... keys) &#123;\n            Jedis jedis = getJedis();\n            Set&lt;String&gt; set = jedis.sdiff(keys);\n            jedis.close();\n            return set;\n        &#125;\n\n        /**\n         * 这个命令等于sdiff,但返回的不是结果集,而是将结果集存储在新的集合中，如果目标已存在，则覆盖。\n         *\n         * @param newkey 新结果集的key\n         * @param keys   比较的集合\n         * @return 新集合中的记录数\n         **/\n        public long sdiffstore(String newkey, String... keys) &#123;\n            Jedis jedis = getJedis();\n            long s = jedis.sdiffstore(newkey, keys);\n            jedis.close();\n            return s;\n        &#125;\n\n        /**\n         * 返回给定集合交集的成员,如果其中一个集合为不存在或为空，则返回空Set\n         *\n         * @param keys\n         * @return 交集成员的集合\n         **/\n        public Set&lt;String&gt; sinter(String... keys) &#123;\n            Jedis jedis = getJedis();\n            Set&lt;String&gt; set = jedis.sinter(keys);\n            jedis.close();\n            return set;\n        &#125;\n\n        /**\n         * 这个命令等于sinter,但返回的不是结果集,而是将结果集存储在新的集合中，如果目标已存在，则覆盖。\n         *\n         * @param newkey 新结果集的key\n         * @param keys   比较的集合\n         * @return 新集合中的记录数\n         **/\n        public long sinterstore(String newkey, String... keys) &#123;\n            Jedis jedis = getJedis();\n            long s = jedis.sinterstore(newkey, keys);\n            jedis.close();\n            return s;\n        &#125;\n\n        /**\n         * 确定一个给定的值是否存在\n         *\n         * @param key\n         * @param member 要判断的值\n         * @return 存在返回1，不存在返回0\n         **/\n        public boolean sismember(String key, String member) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            boolean s = sjedis.sismember(key, member);\n            sjedis.close();\n            return s;\n        &#125;\n\n        /**\n         * 返回集合中的所有成员\n         *\n         * @param key\n         * @return 成员集合\n         */\n        public Set&lt;String&gt; smembers(String key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            Set&lt;String&gt; set = sjedis.smembers(key);\n            sjedis.close();\n            return set;\n        &#125;\n\n        public Set&lt;byte[]&gt; smembers(byte[] key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            Set&lt;byte[]&gt; set = sjedis.smembers(key);\n            sjedis.close();\n            return set;\n        &#125;\n\n        /**\n         * 将成员从源集合移出放入目标集合 &lt;br/&gt;\n         * 如果源集合不存在或不包哈指定成员，不进行任何操作，返回0&lt;br/&gt;\n         * 否则该成员从源集合上删除，并添加到目标集合，如果目标集合中成员已存在，则只在源集合进行删除\n         *\n         * @param srckey 源集合\n         * @param dstkey 目标集合\n         * @param member 源集合中的成员\n         * @return 状态码，1成功，0失败\n         */\n        public long smove(String srckey, String dstkey, String member) &#123;\n            Jedis jedis = getJedis();\n            long s = jedis.smove(srckey, dstkey, member);\n            jedis.close();\n            return s;\n        &#125;\n\n        /**\n         * 从集合中删除成员\n         *\n         * @param key\n         * @return 被删除的成员\n         */\n        public String spop(String key) &#123;\n            Jedis jedis = getJedis();\n            String s = jedis.spop(key);\n            jedis.close();\n            return s;\n        &#125;\n\n        /**\n         * 从集合中删除指定成员\n         *\n         * @param key\n         * @param member 要删除的成员\n         * @return 状态码，成功返回1，成员不存在返回0\n         */\n        public long srem(String key, String member) &#123;\n            Jedis jedis = getJedis();\n            long s = jedis.srem(key, member);\n            jedis.close();\n            return s;\n        &#125;\n\n        /**\n         * 合并多个集合并返回合并后的结果，合并后的结果集合并不保存&lt;br/&gt;\n         *\n         * @param keys\n         * @return 合并后的结果集合\n         */\n        public Set&lt;String&gt; sunion(String... keys) &#123;\n            Jedis jedis = getJedis();\n            Set&lt;String&gt; set = jedis.sunion(keys);\n            jedis.close();\n            return set;\n        &#125;\n\n        /**\n         * 合并多个集合并将合并后的结果集保存在指定的新集合中，如果新集合已经存在则覆盖\n         *\n         * @param newkey 新集合的key\n         * @param keys   要合并的集合\n         **/\n        public long sunionstore(String newkey, String... keys) &#123;\n            Jedis jedis = getJedis();\n            long s = jedis.sunionstore(newkey, keys);\n            jedis.close();\n            return s;\n        &#125;\n    &#125;\n\n    // *******************************************Hash*******************************************//\n    public class Hash &#123;\n\n        /**\n         * 从hash中删除指定的存储\n         *\n         * @param key\n         * @param fieid 存储的名字\n         * @return 状态码，1成功，0失败\n         */\n        public long hdel(String key, String fieid) &#123;\n            Jedis jedis = getJedis();\n            long s = jedis.hdel(key, fieid);\n            jedis.close();\n            return s;\n        &#125;\n\n        public long hdel(String key) &#123;\n            Jedis jedis = getJedis();\n            long s = jedis.del(key);\n            jedis.close();\n            return s;\n        &#125;\n\n        /**\n         * 测试hash中指定的存储是否存在\n         *\n         * @param key\n         * @param fieid 存储的名字\n         * @return 1存在，0不存在\n         */\n        public boolean hexists(String key, String fieid) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            boolean s = sjedis.hexists(key, fieid);\n            sjedis.close();\n            return s;\n        &#125;\n\n        /**\n         * 返回hash中指定存储位置的值\n         *\n         * @param key\n         * @param fieid 存储的名字\n         * @return 存储对应的值\n         */\n        public String hget(String key, String fieid) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            String s = sjedis.hget(key, fieid);\n            sjedis.close();\n            return s;\n        &#125;\n\n        public byte[] hget(byte[] key, byte[] fieid) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            byte[] s = sjedis.hget(key, fieid);\n            sjedis.close();\n            return s;\n        &#125;\n\n        /**\n         * 以Map的形式返回hash中的存储和值\n         *\n         * @param key\n         * @return Map&lt;Strinig, String&gt;\n         */\n        public Map&lt;String, String&gt; hgetAll(String key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            Map&lt;String, String&gt; map = sjedis.hgetAll(key);\n            sjedis.close();\n            return map;\n        &#125;\n\n        /**\n         * 添加一个对应关系\n         *\n         * @param key\n         * @param fieid\n         * @param value\n         * @return 状态码 1成功，0失败，fieid已存在将更新，也返回0\n         **/\n        public long hset(String key, String fieid, String value) &#123;\n            Jedis jedis = getJedis();\n            long s = jedis.hset(key, fieid, value);\n            jedis.close();\n            return s;\n        &#125;\n\n        public long hset(String key, String fieid, byte[] value) &#123;\n            Jedis jedis = getJedis();\n            long s = jedis.hset(key.getBytes(), fieid.getBytes(), value);\n            jedis.close();\n            return s;\n        &#125;\n\n        /**\n         * 添加对应关系，只有在fieid不存在时才执行\n         *\n         * @param key\n         * @param fieid\n         * @param value\n         * @return 状态码 1成功，0失败fieid已存\n         **/\n        public long hsetnx(String key, String fieid, String value) &#123;\n            Jedis jedis = getJedis();\n            long s = jedis.hsetnx(key, fieid, value);\n            jedis.close();\n            return s;\n        &#125;\n\n        /**\n         * 获取hash中value的集合\n         *\n         * @param key\n         * @return List&lt;String&gt;\n         */\n        public List&lt;String&gt; hvals(String key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            List&lt;String&gt; list = sjedis.hvals(key);\n            sjedis.close();\n            return list;\n        &#125;\n\n        /**\n         * 在指定的存储位置加上指定的数字，存储位置的值必须可转为数字类型\n         *\n         * @param key\n         * @param fieid 存储位置\n         * @param value 要增加的值,可以是负数\n         * @return 增加指定数字后，存储位置的值\n         */\n        public long hincrby(String key, String fieid, long value) &#123;\n            Jedis jedis = getJedis();\n            long s = jedis.hincrBy(key, fieid, value);\n            jedis.close();\n            return s;\n        &#125;\n\n        /**\n         * 返回指定hash中的所有存储名字,类似Map中的keySet方法\n         *\n         * @param key\n         * @return Set&lt;String&gt; 存储名称的集合\n         */\n        public Set&lt;String&gt; hkeys(String key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            Set&lt;String&gt; set = sjedis.hkeys(key);\n            sjedis.close();\n            return set;\n        &#125;\n\n        /**\n         * 获取hash中存储的个数，类似Map中size方法\n         *\n         * @param key\n         * @return long 存储的个数\n         */\n        public long hlen(String key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            long len = sjedis.hlen(key);\n            sjedis.close();\n            return len;\n        &#125;\n\n        /**\n         * 根据多个key，获取对应的value，返回List,如果指定的key不存在,List对应位置为null\n         *\n         * @param key\n         * @param fieids 存储位置\n         * @return List&lt;String&gt;\n         */\n        public List&lt;String&gt; hmget(String key, String... fieids) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            List&lt;String&gt; list = sjedis.hmget(key, fieids);\n            sjedis.close();\n            return list;\n        &#125;\n\n        public List&lt;byte[]&gt; hmget(byte[] key, byte[]... fieids) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            List&lt;byte[]&gt; list = sjedis.hmget(key, fieids);\n            sjedis.close();\n            return list;\n        &#125;\n\n        /**\n         * 添加对应关系，如果对应关系已存在，则覆盖\n         *\n         * @param key\n         * @param map 对应关系\n         * @return 状态，成功返回OK\n         */\n        public String hmset(String key, Map&lt;String, String&gt; map) &#123;\n            Jedis jedis = getJedis();\n            String s = jedis.hmset(key, map);\n            jedis.close();\n            return s;\n        &#125;\n\n        /**\n         * 添加对应关系，如果对应关系已存在，则覆盖\n         *\n         * @param key\n         * @param map 对应关系\n         * @return 状态，成功返回OK\n         */\n        public String hmset(byte[] key, Map&lt;byte[], byte[]&gt; map) &#123;\n            Jedis jedis = getJedis();\n            String s = jedis.hmset(key, map);\n            jedis.close();\n            return s;\n        &#125;\n\n    &#125;\n\n    // *******************************************Strings*******************************************//\n    public class Strings &#123;\n\n        /**\n         * 根据key获取记录\n         *\n         * @param key\n         * @return 值\n         */\n        public String get(String key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            String value = sjedis.get(key);\n            sjedis.close();\n            return value;\n        &#125;\n\n        /**\n         * 根据key获取记录\n         *\n         * @param key\n         * @return 值\n         */\n        public byte[] get(byte[] key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            byte[] value = sjedis.get(key);\n            sjedis.close();\n            return value;\n        &#125;\n\n        /**\n         * 添加有过期时间的记录\n         *\n         * @param key\n         * @param seconds 过期时间，以秒为单位\n         * @param value\n         * @return String 操作状态\n         */\n        public String setEx(String key, int seconds, String value) &#123;\n            Jedis jedis = getJedis();\n            String str = jedis.setex(key, seconds, value);\n            jedis.close();\n            return str;\n        &#125;\n\n        /**\n         * 添加有过期时间的记录\n         *\n         * @param key\n         * @param seconds 过期时间，以秒为单位\n         * @param value\n         * @return String 操作状态\n         */\n        public String setEx(byte[] key, int seconds, byte[] value) &#123;\n            Jedis jedis = getJedis();\n            String str = jedis.setex(key, seconds, value);\n            jedis.close();\n            return str;\n        &#125;\n\n        /**\n         * 添加一条记录，仅当给定的key不存在时才插入\n         *\n         * @param key\n         * @param value\n         * @return long 状态码，1插入成功且key不存在，0未插入，key存在\n         */\n        public long setnx(String key, String value) &#123;\n            Jedis jedis = getJedis();\n            long str = jedis.setnx(key, value);\n            jedis.close();\n            return str;\n        &#125;\n\n        /**\n         * 添加记录,如果记录已存在将覆盖原有的value\n         *\n         * @param key\n         * @param value\n         * @return 状态码\n         */\n        public String set(String key, String value) &#123;\n            return set(SafeEncoder.encode(key), SafeEncoder.encode(value));\n        &#125;\n\n        /**\n         * 添加记录,如果记录已存在将覆盖原有的value\n         *\n         * @param key\n         * @param value\n         * @return 状态码\n         */\n        public String set(String key, byte[] value) &#123;\n            return set(SafeEncoder.encode(key), value);\n        &#125;\n\n        /**\n         * 添加记录,如果记录已存在将覆盖原有的value\n         *\n         * @param key\n         * @param value\n         * @return 状态码\n         */\n        public String set(byte[] key, byte[] value) &#123;\n            Jedis jedis = getJedis();\n            String status = jedis.set(key, value);\n            jedis.close();\n            return status;\n        &#125;\n\n        /**\n         * 从指定位置开始插入数据，插入的数据会覆盖指定位置以后的数据&lt;br/&gt;\n         * 例:String str1=&quot;123456789&quot;;&lt;br/&gt;\n         * 对str1操作后setRange(key,4,0000)，str1=&quot;123400009&quot;;\n         *\n         * @param key\n         * @param offset\n         * @param value\n         * @return long value的长度\n         */\n        public long setRange(String key, long offset, String value) &#123;\n            Jedis jedis = getJedis();\n            long len = jedis.setrange(key, offset, value);\n            jedis.close();\n            return len;\n        &#125;\n\n        /**\n         * 在指定的key中追加value\n         *\n         * @param key\n         * @param value\n         * @return long 追加后value的长度\n         **/\n        public long append(String key, String value) &#123;\n            Jedis jedis = getJedis();\n            long len = jedis.append(key, value);\n            jedis.close();\n            return len;\n        &#125;\n\n        /**\n         * 将key对应的value减去指定的值，只有value可以转为数字时该方法才可用\n         *\n         * @param key\n         * @param number 要减去的值\n         * @return long 减指定值后的值\n         */\n        public long decrBy(String key, long number) &#123;\n            Jedis jedis = getJedis();\n            long len = jedis.decrBy(key, number);\n            jedis.close();\n            return len;\n        &#125;\n\n        /**\n         * &lt;b&gt;可以作为获取唯一id的方法&lt;/b&gt;&lt;br/&gt;\n         * 将key对应的value加上指定的值，只有value可以转为数字时该方法才可用\n         *\n         * @param key\n         * @param number 要减去的值\n         * @return long 相加后的值\n         */\n        public long incrBy(String key, long number) &#123;\n            Jedis jedis = getJedis();\n            long len = jedis.incrBy(key, number);\n            jedis.close();\n            return len;\n        &#125;\n\n        /**\n         * 对指定key对应的value进行截取\n         *\n         * @param key\n         * @param startOffset 开始位置(包含)\n         * @param endOffset   结束位置(包含)\n         * @return String 截取的值\n         */\n        public String getrange(String key, long startOffset, long endOffset) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            String value = sjedis.getrange(key, startOffset, endOffset);\n            sjedis.close();\n            return value;\n        &#125;\n\n        /**\n         * 获取并设置指定key对应的value&lt;br/&gt;\n         * 如果key存在返回之前的value,否则返回null\n         *\n         * @param key\n         * @param value\n         * @return String 原始value或null\n         */\n        public String getSet(String key, String value) &#123;\n            Jedis jedis = getJedis();\n            String str = jedis.getSet(key, value);\n            jedis.close();\n            return str;\n        &#125;\n\n        /**\n         * 批量获取记录,如果指定的key不存在返回List的对应位置将是null\n         *\n         * @param keys\n         * @return List&lt;String&gt; 值得集合\n         */\n        public List&lt;String&gt; mget(String... keys) &#123;\n            Jedis jedis = getJedis();\n            List&lt;String&gt; str = jedis.mget(keys);\n            jedis.close();\n            return str;\n        &#125;\n\n        /**\n         * 批量存储记录\n         *\n         * @param keysvalues 例:keysvalues=&quot;key1&quot;,&quot;value1&quot;,&quot;key2&quot;,&quot;value2&quot;;\n         * @return String 状态码\n         */\n        public String mset(String... keysvalues) &#123;\n            Jedis jedis = getJedis();\n            String str = jedis.mset(keysvalues);\n            jedis.close();\n            return str;\n        &#125;\n\n        /**\n         * 获取key对应的值的长度\n         *\n         * @param key\n         * @return value值得长度\n         */\n        public long strlen(String key) &#123;\n            Jedis jedis = getJedis();\n            long len = jedis.strlen(key);\n            jedis.close();\n            return len;\n        &#125;\n    &#125;\n\n    // *******************************************Lists*******************************************//\n    public class Lists &#123;\n\n        /**\n         * List长度\n         *\n         * @param key\n         * @return 长度\n         */\n        public long llen(String key) &#123;\n            return llen(SafeEncoder.encode(key));\n        &#125;\n\n        /**\n         * List长度\n         *\n         * @param key\n         * @return 长度\n         */\n        public long llen(byte[] key) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            long count = sjedis.llen(key);\n            sjedis.close();\n            return count;\n        &#125;\n\n        /**\n         * 覆盖操作,将覆盖List中指定位置的值\n         *\n         * @param key\n         * @param index 位置\n         * @param value 值\n         * @return 状态码\n         */\n        public String lset(byte[] key, int index, byte[] value) &#123;\n            Jedis jedis = getJedis();\n            String status = jedis.lset(key, index, value);\n            jedis.close();\n            return status;\n        &#125;\n\n        /**\n         * 覆盖操作,将覆盖List中指定位置的值\n         *\n         * @param @param index 位置\n         * @param value  值\n         * @return 状态码\n         */\n        public String lset(String key, int index, String value) &#123;\n            return lset(SafeEncoder.encode(key), index,\n                    SafeEncoder.encode(value));\n        &#125;\n\n        /**\n         * 在value的相对位置插入记录\n         *\n         * @param @param 前面插入或后面插入\n         * @param pivot  相对位置的内容\n         * @param value  插入的内容\n         * @return 记录总数\n         */\n        public long linsert(String key, BinaryClient.LIST_POSITION where, String pivot,\n                            String value) &#123;\n            return linsert(SafeEncoder.encode(key), where,\n                    SafeEncoder.encode(pivot), SafeEncoder.encode(value));\n        &#125;\n\n        /**\n         * 在指定位置插入记录\n         *\n         * @param key\n         * @param where 前面插入或后面插入\n         * @param pivot 相对位置的内容\n         * @param value 插入的内容\n         * @return 记录总数\n         */\n        public long linsert(byte[] key, BinaryClient.LIST_POSITION where, byte[] pivot,\n                            byte[] value) &#123;\n            Jedis jedis = getJedis();\n            long count = jedis.linsert(key, where, pivot, value);\n            jedis.close();\n            return count;\n        &#125;\n\n        /**\n         * 获取List中指定位置的值\n         *\n         * @param key\n         * @param index 位置\n         * @return 值\n         **/\n        public String lindex(String key, int index) &#123;\n            return SafeEncoder.encode(lindex(SafeEncoder.encode(key), index));\n        &#125;\n\n        /**\n         * 获取List中指定位置的值\n         *\n         * @param key\n         * @param index 位置\n         * @return 值\n         **/\n        public byte[] lindex(byte[] key, int index) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            byte[] value = sjedis.lindex(key, index);\n            sjedis.close();\n            return value;\n        &#125;\n\n        /**\n         * 将List中的第一条记录移出List\n         *\n         * @param key\n         * @return 移出的记录\n         */\n        public String lpop(String key) &#123;\n            return SafeEncoder.encode(lpop(SafeEncoder.encode(key)));\n        &#125;\n\n        /**\n         * 将List中的第一条记录移出List\n         *\n         * @param key\n         * @return 移出的记录\n         */\n        public byte[] lpop(byte[] key) &#123;\n            Jedis jedis = getJedis();\n            byte[] value = jedis.lpop(key);\n            jedis.close();\n            return value;\n        &#125;\n\n        /**\n         * 将List中最后第一条记录移出List\n         *\n         * @param key\n         * @return 移出的记录\n         */\n        public String rpop(String key) &#123;\n            Jedis jedis = getJedis();\n            String value = jedis.rpop(key);\n            jedis.close();\n            return value;\n        &#125;\n\n        /**\n         * 向List尾部追加记录\n         *\n         * @param key\n         * @param value\n         * @return 记录总数\n         */\n        public long lpush(String key, String value) &#123;\n            return lpush(SafeEncoder.encode(key), SafeEncoder.encode(value));\n        &#125;\n\n        /**\n         * 向List头部追加记录\n         *\n         * @param key\n         * @param value\n         * @return 记录总数\n         */\n        public long rpush(String key, String value) &#123;\n            Jedis jedis = getJedis();\n            long count = jedis.rpush(key, value);\n            jedis.close();\n            return count;\n        &#125;\n\n        /**\n         * 向List头部追加记录\n         *\n         * @param key\n         * @param value\n         * @return 记录总数\n         */\n        public long rpush(byte[] key, byte[] value) &#123;\n            Jedis jedis = getJedis();\n            long count = jedis.rpush(key, value);\n            jedis.close();\n            return count;\n        &#125;\n\n        /**\n         * 向List中追加记录\n         *\n         * @param key\n         * @param value\n         * @return 记录总数\n         */\n        public long lpush(byte[] key, byte[] value) &#123;\n            Jedis jedis = getJedis();\n            long count = jedis.lpush(key, value);\n            jedis.close();\n            return count;\n        &#125;\n\n        /**\n         * 获取指定范围的记录，可以做为分页使用\n         *\n         * @param key\n         * @param start\n         * @param end\n         * @return List\n         */\n        public List&lt;String&gt; lrange(String key, long start, long end) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            List&lt;String&gt; list = sjedis.lrange(key, start, end);\n            sjedis.close();\n            return list;\n        &#125;\n\n        /**\n         * 获取指定范围的记录，可以做为分页使用\n         *\n         * @param key\n         * @param start\n         * @param end   如果为负数，则尾部开始计算\n         * @return List\n         */\n        public List&lt;byte[]&gt; lrange(byte[] key, int start, int end) &#123;\n            // ShardedJedis sjedis = getShardedJedis();\n            Jedis sjedis = getJedis();\n            List&lt;byte[]&gt; list = sjedis.lrange(key, start, end);\n            sjedis.close();\n            return list;\n        &#125;\n\n        /**\n         * 删除List中c条记录，被删除的记录值为value\n         *\n         * @param key\n         * @param c     要删除的数量，如果为负数则从List的尾部检查并删除符合的记录\n         * @param value 要匹配的值\n         * @return 删除后的List中的记录数\n         */\n        public long lrem(byte[] key, int c, byte[] value) &#123;\n            Jedis jedis = getJedis();\n            long count = jedis.lrem(key, c, value);\n            jedis.close();\n            return count;\n        &#125;\n\n        /**\n         * 删除List中c条记录，被删除的记录值为value\n         *\n         * @param key\n         * @param c     要删除的数量，如果为负数则从List的尾部检查并删除符合的记录\n         * @param value 要匹配的值\n         * @return 删除后的List中的记录数\n         */\n        public long lrem(String key, int c, String value) &#123;\n            return lrem(SafeEncoder.encode(key), c, SafeEncoder.encode(value));\n        &#125;\n\n        /**\n         * 算是删除吧，只保留start与end之间的记录\n         *\n         * @param key\n         * @param start 记录的开始位置(0表示第一条记录)\n         * @param end   记录的结束位置（如果为-1则表示最后一个，-2，-3以此类推）\n         * @return 执行状态码\n         */\n        public String ltrim(byte[] key, int start, int end) &#123;\n            Jedis jedis = getJedis();\n            String str = jedis.ltrim(key, start, end);\n            jedis.close();\n            return str;\n        &#125;\n\n        /**\n         * 算是删除吧，只保留start与end之间的记录\n         *\n         * @param key\n         * @param start 记录的开始位置(0表示第一条记录)\n         * @param end   记录的结束位置（如果为-1则表示最后一个，-2，-3以此类推）\n         * @return 执行状态码\n         */\n        public String ltrim(String key, int start, int end) &#123;\n            return ltrim(SafeEncoder.encode(key), start, end);\n        &#125;\n    &#125;\n\n&#125;\n</code></pre>"}],"PostAsset":[{"_id":"source/_posts/Java中ThreadLocal是如何保证线程安全的/threadlocal.png","slug":"threadlocal.png","post":"cl2enrqz80001y2lo9gc68jjg","modified":0,"renderable":0},{"_id":"source/_posts/Java中ThreadLocal是如何保证线程安全的/截屏2021-03-22 17.04.09.png","slug":"截屏2021-03-22 17.04.09.png","post":"cl2enrqz80001y2lo9gc68jjg","modified":0,"renderable":0},{"_id":"source/_posts/Nacos如何调用其他微服务(中）/1615645734755-1b3246df-3e91-474b-b901-bd58ac654797-20210318224006023.jpeg","slug":"1615645734755-1b3246df-3e91-474b-b901-bd58ac654797-20210318224006023.jpeg","post":"cl2enrqzb0003y2loeovbe9hg","modified":0,"renderable":0},{"_id":"source/_posts/Kaptcha验证码/image-20210129220709957.png","slug":"image-20210129220709957.png","post":"cl2enrqzf0007y2loaghzd8ga","modified":0,"renderable":0},{"_id":"source/_posts/Nacos：如果注册服务（上）/1615625705374-a7db4ed1-7021-4e98-9eee-058ae34afd4d.png","slug":"1615625705374-a7db4ed1-7021-4e98-9eee-058ae34afd4d.png","post":"cl2enrqzg0009y2lo9umv6jcz","modified":0,"renderable":0},{"_id":"source/_posts/Nacos：如果注册服务（上）/1615627294785-e203d13a-6656-44b9-b5e2-69f5a32017d1.png","slug":"1615627294785-e203d13a-6656-44b9-b5e2-69f5a32017d1.png","post":"cl2enrqzg0009y2lo9umv6jcz","modified":0,"renderable":0},{"_id":"source/_posts/Nacos：如果注册服务（上）/1615627330848-e62fcb72-d405-48f1-8e27-0053b1fcf750.png","slug":"1615627330848-e62fcb72-d405-48f1-8e27-0053b1fcf750.png","post":"cl2enrqzg0009y2lo9umv6jcz","modified":0,"renderable":0},{"_id":"source/_posts/docker配置MYSQL集群(上)/image.png","slug":"image.png","post":"cl2enrqzh000by2loaogoaeaz","modified":0,"renderable":0},{"_id":"source/_posts/docker配置MYSQL集群(上)/master配置信息.png","slug":"master配置信息.png","post":"cl2enrqzh000by2loaogoaeaz","modified":0,"renderable":0},{"_id":"source/_posts/docker配置MYSQL集群(上)/navicat.png","slug":"navicat.png","post":"cl2enrqzh000by2loaogoaeaz","modified":0,"renderable":0},{"_id":"source/_posts/docker配置MYSQL集群(上)/截屏2021-01-20 12.07.01.png","slug":"截屏2021-01-20 12.07.01.png","post":"cl2enrqzh000by2loaogoaeaz","modified":0,"renderable":0},{"_id":"source/_posts/docker配置MYSQL集群(上)/截屏2021-01-20 14.30.05.png","slug":"截屏2021-01-20 14.30.05.png","post":"cl2enrqzh000by2loaogoaeaz","modified":0,"renderable":0},{"_id":"source/_posts/docker配置MYSQL集群(上)/截屏2021-01-20 23.26.12.png","slug":"截屏2021-01-20 23.26.12.png","post":"cl2enrqzh000by2loaogoaeaz","modified":0,"renderable":0},{"_id":"source/_posts/docker配置MYSQL集群(上)/截屏2021-01-20 23.33.11.png","slug":"截屏2021-01-20 23.33.11.png","post":"cl2enrqzh000by2loaogoaeaz","modified":0,"renderable":0},{"_id":"source/_posts/docker配置MYSQL集群(上)/截屏2021-01-20 23.46.48.png","slug":"截屏2021-01-20 23.46.48.png","post":"cl2enrqzh000by2loaogoaeaz","modified":0,"renderable":0},{"_id":"source/_posts/docker配置MYSQL集群(上)/截屏2021-01-20 23.58.28.png","slug":"截屏2021-01-20 23.58.28.png","post":"cl2enrqzh000by2loaogoaeaz","modified":0,"renderable":0},{"_id":"source/_posts/docker配置MYSQL集群(上)/截屏2021-01-23 21.59.27.png","slug":"截屏2021-01-23 21.59.27.png","post":"cl2enrqzh000by2loaogoaeaz","modified":0,"renderable":0},{"_id":"source/_posts/docker配置MYSQL集群(上)/镜像.png","slug":"镜像.png","post":"cl2enrqzh000by2loaogoaeaz","modified":0,"renderable":0},{"_id":"source/_posts/docker配置MYSQL集群(上)/集群原理.png","slug":"集群原理.png","post":"cl2enrqzh000by2loaogoaeaz","modified":0,"renderable":0},{"_id":"source/_posts/复杂mapper映射出现Expected one result (or null) to be returned by selectOne(), but found_ 6/1612109243469-4d89a31b-0d9d-487e-bfed-faf3497e774e.png","slug":"1612109243469-4d89a31b-0d9d-487e-bfed-faf3497e774e.png","post":"cl2enrqzr0011y2lod9sidqmm","modified":0,"renderable":0},{"_id":"source/_posts/复杂mapper映射出现Expected one result (or null) to be returned by selectOne(), but found_ 6/1612149616517-3d3f353b-1319-4315-a12a-3592c873810c.png","slug":"1612149616517-3d3f353b-1319-4315-a12a-3592c873810c.png","post":"cl2enrqzr0011y2lod9sidqmm","modified":0,"renderable":0},{"_id":"source/_posts/复杂mapper映射出现Expected one result (or null) to be returned by selectOne(), but found_ 6/1612149739610-d371499a-4d5a-4ba7-9b0d-8f9b8bc133ec-20210201120526814.png","slug":"1612149739610-d371499a-4d5a-4ba7-9b0d-8f9b8bc133ec-20210201120526814.png","post":"cl2enrqzr0011y2lod9sidqmm","modified":0,"renderable":0},{"_id":"source/_posts/复杂mapper映射出现Expected one result (or null) to be returned by selectOne(), but found_ 6/1612149739610-d371499a-4d5a-4ba7-9b0d-8f9b8bc133ec.png","slug":"1612149739610-d371499a-4d5a-4ba7-9b0d-8f9b8bc133ec.png","post":"cl2enrqzr0011y2lod9sidqmm","modified":0,"renderable":0},{"_id":"source/_posts/复杂mapper映射出现Expected one result (or null) to be returned by selectOne(), but found_ 6/1612150436476-e7e658e8-81a4-4292-9b5b-9c00ab6b823f.png","slug":"1612150436476-e7e658e8-81a4-4292-9b5b-9c00ab6b823f.png","post":"cl2enrqzr0011y2lod9sidqmm","modified":0,"renderable":0},{"_id":"source/_posts/zxing二维码的生成/1613878321918-810b6f23-69ad-4817-a58a-16739f945cec.png","slug":"1613878321918-810b6f23-69ad-4817-a58a-16739f945cec.png","post":"cl2enrqzv001by2lock5pcxn3","modified":0,"renderable":0},{"_id":"source/_posts/Redis使用/1612949134565-6f08df50-431b-40ba-ba8e-eac9104e8f9d-20210225113349251.png","slug":"1612949134565-6f08df50-431b-40ba-ba8e-eac9104e8f9d-20210225113349251.png","post":"cl2enrqzz001ry2lofviv6r4z","modified":0,"renderable":0}],"PostCategory":[{"post_id":"cl2enrqz80001y2lo9gc68jjg","category_id":"cl2enrqzd0004y2lo0w0yf26s","_id":"cl2enrqzj000hy2lo6of75is9"},{"post_id":"cl2enrqzb0003y2loeovbe9hg","category_id":"cl2enrqzi000cy2lo3dj87qcd","_id":"cl2enrqzl000ly2lofqtih57u"},{"post_id":"cl2enrqzf0007y2loaghzd8ga","category_id":"cl2enrqzk000iy2lo6non0bn6","_id":"cl2enrqzn000ry2logqn901n1"},{"post_id":"cl2enrqzg0009y2lo9umv6jcz","category_id":"cl2enrqzi000cy2lo3dj87qcd","_id":"cl2enrqzo000uy2lo9fnz16jt"},{"post_id":"cl2enrqzh000by2loaogoaeaz","category_id":"cl2enrqzk000iy2lo6non0bn6","_id":"cl2enrqzp000xy2lo9o5o6jtq"},{"post_id":"cl2enrqzr0011y2lod9sidqmm","category_id":"cl2enrqzk000iy2lo6non0bn6","_id":"cl2enrqzv0019y2loeurkh28x"},{"post_id":"cl2enrqzt0016y2lo5tek78y4","category_id":"cl2enrqzi000cy2lo3dj87qcd","_id":"cl2enrqzw001ey2logudp7wi4"},{"post_id":"cl2enrqzu0018y2loe4jx2aju","category_id":"cl2enrqzk000iy2lo6non0bn6","_id":"cl2enrqzw001gy2logrvd0gxr"},{"post_id":"cl2enrqzv001by2lock5pcxn3","category_id":"cl2enrqzk000iy2lo6non0bn6","_id":"cl2enrqzw001jy2logl491rhy"},{"post_id":"cl2enrqzs0013y2lohof61ugx","category_id":"cl2enrqzu0017y2lo57dd205m","_id":"cl2enrqzw001ky2lognncar1f"},{"post_id":"cl2enrqzz001ry2lofviv6r4z","category_id":"cl2enrqzk000iy2lo6non0bn6","_id":"cl2enrr02001ty2lo9rfrf8gt"}],"PostTag":[{"post_id":"cl2enrqz80001y2lo9gc68jjg","tag_id":"cl2enrqze0005y2lo7erqcr1k","_id":"cl2enrqzi000ey2loe4w1bls1"},{"post_id":"cl2enrqzb0003y2loeovbe9hg","tag_id":"cl2enrqzi000dy2logr022awa","_id":"cl2enrqzn000oy2lo6qga6tmv"},{"post_id":"cl2enrqzb0003y2loeovbe9hg","tag_id":"cl2enrqzk000jy2lo5ige7dti","_id":"cl2enrqzn000py2lof2zg5mkq"},{"post_id":"cl2enrqzf0007y2loaghzd8ga","tag_id":"cl2enrqzl000ny2lo6e9o8hqd","_id":"cl2enrqzo000ty2lohfl40dbu"},{"post_id":"cl2enrqzg0009y2lo9umv6jcz","tag_id":"cl2enrqzi000dy2logr022awa","_id":"cl2enrqzp000wy2lo4e4g3bje"},{"post_id":"cl2enrqzh000by2loaogoaeaz","tag_id":"cl2enrqzo000vy2lo6d1bh6s4","_id":"cl2enrqzp000zy2lo327q7cr8"},{"post_id":"cl2enrqzh000by2loaogoaeaz","tag_id":"cl2enrqzp000yy2lodxud2tlb","_id":"cl2enrqzp0010y2lo9qxya5wv"},{"post_id":"cl2enrqzt0016y2lo5tek78y4","tag_id":"cl2enrqzk000jy2lo5ige7dti","_id":"cl2enrqzv001ay2lo9nc2egy7"},{"post_id":"cl2enrqzu0018y2loe4jx2aju","tag_id":"cl2enrqzo000vy2lo6d1bh6s4","_id":"cl2enrqzw001dy2lo6dqx7uxo"},{"post_id":"cl2enrqzu0018y2loe4jx2aju","tag_id":"cl2enrqzp000yy2lodxud2tlb","_id":"cl2enrqzw001fy2lo5rbs36ko"},{"post_id":"cl2enrqzr0011y2lod9sidqmm","tag_id":"cl2enrqzt0015y2lo3wi2gt2i","_id":"cl2enrqzw001iy2lo4gwf5ade"},{"post_id":"cl2enrqzs0013y2lohof61ugx","tag_id":"cl2enrqzv001cy2lobnp7c1r2","_id":"cl2enrqzx001my2locdlphnwz"},{"post_id":"cl2enrqzs0013y2lohof61ugx","tag_id":"cl2enrqzw001hy2logsdmapog","_id":"cl2enrqzx001ny2lo5tjm5r14"},{"post_id":"cl2enrqzv001by2lock5pcxn3","tag_id":"cl2enrqzx001ly2lodouigq4f","_id":"cl2enrqzx001py2lodtry2dt3"},{"post_id":"cl2enrqzv001by2lock5pcxn3","tag_id":"cl2enrqzx001oy2lofs7439s6","_id":"cl2enrqzx001qy2lo6iqt7s1o"},{"post_id":"cl2enrqzz001ry2lofviv6r4z","tag_id":"cl2enrr01001sy2lo85e9czzl","_id":"cl2enrr02001uy2locsuneaax"}],"Tag":[{"name":"线程","_id":"cl2enrqze0005y2lo7erqcr1k"},{"name":"Nacos","_id":"cl2enrqzi000dy2logr022awa"},{"name":"微服务","_id":"cl2enrqzk000jy2lo5ige7dti"},{"name":"Kaptcha","_id":"cl2enrqzl000ny2lo6e9o8hqd"},{"name":"Docker","_id":"cl2enrqzo000vy2lo6d1bh6s4"},{"name":"MYSQL集群","_id":"cl2enrqzp000yy2lodxud2tlb"},{"name":"Mybatis","_id":"cl2enrqzt0015y2lo3wi2gt2i"},{"name":"随笔","_id":"cl2enrqzv001cy2lobnp7c1r2"},{"name":"历史","_id":"cl2enrqzw001hy2logsdmapog"},{"name":"Zxing","_id":"cl2enrqzx001ly2lodouigq4f"},{"name":"短链","_id":"cl2enrqzx001oy2lofs7439s6"},{"name":"Redis","_id":"cl2enrr01001sy2lo85e9czzl"}]}}